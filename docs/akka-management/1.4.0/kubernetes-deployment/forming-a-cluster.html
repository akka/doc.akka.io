<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Forming an Akka Cluster &bull; Akka Management</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="Akka Management is a suite of tools for operating Akka Clusters."/>
<link rel="canonical" href="https://doc.akka.io/docs/akka-management/current/kubernetes-deployment/forming-a-cluster.html"/>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../lib/foundation/dist/js/foundation.min.js"></script>
<link rel="stylesheet" type="text/css" href="../lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="../lib/foundation/dist/css/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" type="text/css" href="../css/icons.css"/>
<link rel="stylesheet" type="text/css" href="../css/page-8.css"/>
<link rel="stylesheet" type="text/css" href="../css/banner-2.css"/>
<link rel="shortcut icon" href="../images/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="../images/apple-touch-icon.png"/>
<link rel="icon" type="image/png" sizes="32x32" href="../images/favicon-32x32.png"/>
<link rel="icon" type="image/png" sizes="16x16" href="../images/favicon-16x16.png"/>
<link rel="manifest" href="../images/manifest.json"/>
<meta name="msapplication-TileImage" content="../images/mstile-150x150.png"/>
<meta name="msapplication-TileColor" content="#15a9ce"/>
<meta name="theme-color" content="#15a9ce"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) start -->
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js"  type="text/javascript" charset="UTF-8" data-domain-script="28b912e7-09e9-43d5-91e4-3d1897044004" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) end -->
<!--Google Analytics-->
<script type="text/plain" class="optanon-category-2">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', '']);
_gaq.push(['_setDomainName', '']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})()
</script>
<!-- Google Tag Manager -->
<script type="text/plain" class="optanon-category-2">
(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KBJGH35');
</script>
<!--Marketo-->
<script type="text/plain" class="optanon-category-3">
(function() {
var didInit = false;
function initMunchkin() {
if(didInit === false) {
didInit = true;
Munchkin.init('558-NCX-702', { 'asyncOnly': true, 'disableClickDelay': true });
}
}
var s = document.createElement('script');
s.type = 'text/javascript';
s.async = true;
s.src = '//munchkin.marketo.net/munchkin.js';
s.onreadystatechange = function() {
if (this.readyState == 'complete' || this.readyState == 'loaded') {
initMunchkin();
}
};
s.onload = initMunchkin;
document.getElementsByTagName('head')[0].appendChild(s);
})();
</script>
</head>

<body id="underlay" data-toggler="nav-open">
<div id="lightbend-banner" class="lightbend-banner akka full-width" data-category="OSS Lightbend Banner Impression" data-label="Akka Banner Impression">
<div class="oss-wrapper">
<div class="oss-brand">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lightbend Logo - Akka Banner" href="https://www.lightbend.com">
<img class="lightbend-logo" src="../images/banner-logos/lightbend-reverse.svg" alt="Lightbend" title="Lightbend">
</a>
</div>
<div class="oss-ad no-drop-down">
<nav id="lightbendRotator" class="lightbend-rotator">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Promo Rotator - Lightbend Changed its Software Licensing Model for Akka Technology. [License FAQ] - Akka Banner" href="https://www.lightbend.com/akka/license-faq">
<strong>Lightbend</strong> Changed its Software Licensing Model for Akka Technology. <span class="akka-btn">License FAQ</span>
</a>
</nav>
</div>
</div>
</div>

<header class="site-header hide-for-large">
<div class="sticky-header clearfix">
<a href="https://akka.io"><img class="logo" src="../images/akka-logo-reverse.svg"/></a>

<button class="menu-icon float-right" type="button" data-toggle="underlay overlay"></button>
</div>
<div id="overlay" class="overlay-nav" data-toggler="nav-open">
<header class="nav-header">
<div class="nav-header-title">
<h1><a href="../index.html">Akka Management</a></h1>
</div>
<div class="nav-header-version">
Version 1.4.0
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="nav-toc">
<ul>
  <li><a href="../index.html#overview" class="header">Overview</a></li>
  <li><a href="../kubernetes-deployment/index.html" class="page">Deploying Akka Cluster to Kubernetes</a>
  <ul>
    <li><a href="../kubernetes-deployment/preparing-for-production.html" class="page">Preparing for production</a></li>
    <li><a href="../kubernetes-deployment/forming-a-cluster.html#forming-an-akka-cluster" class="active page">Forming an Akka Cluster</a>
    <ul>
      <li><a href="../kubernetes-deployment/forming-a-cluster.html#bootstrap-and-management-dependencies" class="header">Bootstrap and Management dependencies</a></li>
      <li><a href="../kubernetes-deployment/forming-a-cluster.html#configuring-cluster-bootstrap" class="header">Configuring Cluster Bootstrap</a></li>
      <li><a href="../kubernetes-deployment/forming-a-cluster.html#starting" class="header">Starting</a></li>
      <li><a href="../kubernetes-deployment/forming-a-cluster.html#role-based-access-control" class="header">Role-Based Access Control</a></li>
      <li><a href="../kubernetes-deployment/forming-a-cluster.html#health-checks" class="header">Health Checks</a></li>
      <li><a href="../kubernetes-deployment/forming-a-cluster.html#rolling-updates" class="header">Rolling Updates</a></li>
    </ul></li>
    <li><a href="../kubernetes-deployment/building.html" class="page">Building the application</a></li>
    <li><a href="../kubernetes-deployment/deploying.html" class="page">Deploying</a></li>
  </ul></li>
  <li><a href="../akka-management.html" class="page">Akka Management</a></li>
  <li><a href="../migration.html" class="page">Migration guide</a></li>
  <li><a href="../healthchecks.html" class="page">Health checks</a></li>
  <li><a href="../bootstrap/index.html" class="page">Akka Cluster Bootstrap</a></li>
  <li><a href="../discovery/index.html" class="page">Akka Discovery Methods</a></li>
  <li><a href="../rolling-updates.html" class="page">Rolling Updates</a></li>
  <li><a href="../cluster-http-management.html" class="page">Cluster HTTP Management</a></li>
  <li><a href="../cluster-jmx-management.html" class="page">Built-in JMX Management</a></li>
  <li><a href="../loglevels/index.html" class="page">Dynamic Log Levels</a></li>
  <li><a href="../kubernetes-lease.html" class="page">Kubernetes Lease</a></li>
</ul>
</nav>
</div>
</header>
<div class="site-content-wrapper">
<aside class="sticky-sidebar show-for-large">
<header class="nav-header sticky-sidebar-header">
<div class="nav-header-title">
<h1><a href="../index.html">Akka Management</a></h1>
</div>
<div class="nav-header-version">
Version 1.4.0
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="site-nav sticky-sidebar-contents">
<div class="nav-toc">
<ul>
  <li><a href="../index.html#overview" class="header">Overview</a></li>
  <li><a href="../kubernetes-deployment/index.html" class="page">Deploying Akka Cluster to Kubernetes</a>
  <ul>
    <li><a href="../kubernetes-deployment/preparing-for-production.html" class="page">Preparing for production</a></li>
    <li><a href="../kubernetes-deployment/forming-a-cluster.html#forming-an-akka-cluster" class="active page">Forming an Akka Cluster</a>
    <ul>
      <li><a href="../kubernetes-deployment/forming-a-cluster.html#bootstrap-and-management-dependencies" class="header">Bootstrap and Management dependencies</a></li>
      <li><a href="../kubernetes-deployment/forming-a-cluster.html#configuring-cluster-bootstrap" class="header">Configuring Cluster Bootstrap</a></li>
      <li><a href="../kubernetes-deployment/forming-a-cluster.html#starting" class="header">Starting</a></li>
      <li><a href="../kubernetes-deployment/forming-a-cluster.html#role-based-access-control" class="header">Role-Based Access Control</a></li>
      <li><a href="../kubernetes-deployment/forming-a-cluster.html#health-checks" class="header">Health Checks</a></li>
      <li><a href="../kubernetes-deployment/forming-a-cluster.html#rolling-updates" class="header">Rolling Updates</a></li>
    </ul></li>
    <li><a href="../kubernetes-deployment/building.html" class="page">Building the application</a></li>
    <li><a href="../kubernetes-deployment/deploying.html" class="page">Deploying</a></li>
  </ul></li>
  <li><a href="../akka-management.html" class="page">Akka Management</a></li>
  <li><a href="../migration.html" class="page">Migration guide</a></li>
  <li><a href="../healthchecks.html" class="page">Health checks</a></li>
  <li><a href="../bootstrap/index.html" class="page">Akka Cluster Bootstrap</a></li>
  <li><a href="../discovery/index.html" class="page">Akka Discovery Methods</a></li>
  <li><a href="../rolling-updates.html" class="page">Rolling Updates</a></li>
  <li><a href="../cluster-http-management.html" class="page">Cluster HTTP Management</a></li>
  <li><a href="../cluster-jmx-management.html" class="page">Built-in JMX Management</a></li>
  <li><a href="../loglevels/index.html" class="page">Dynamic Log Levels</a></li>
  <li><a href="../kubernetes-lease.html" class="page">Kubernetes Lease</a></li>
</ul>
</div>
</nav>
<footer class="nav-footer sticky-sidebar-footer">
<a href="https://akka.io"><img class="logo" src="../images/akka-logo-reverse.svg"/></a>

</footer>
</aside>
<main class="fixed-shift-for-large expanded row">
<section class="site-content small-12 column">
<article class="page-content row">
<div class="small-12 column" id="docs">
<h1><a href="#forming-an-akka-cluster" name="forming-an-akka-cluster" class="anchor"><span class="anchor-link"></span></a>Forming an Akka Cluster</h1>
<p>Services that use Akka Cluster have additional requirements over stateless applications. To form a cluster, each pod needs to know which other pods have been deployed as part of that service, so that they can connect to each other. Akka provides a Cluster Bootstrap library that allows Akka applications in Kubernetes to discover this automatically using the Kubernetes API. The process is roughly as follows:</p>
<ol>
  <li>When the application starts, the application polls the Kubernetes API to find what pods are deployed,  until a configured minimum number of pods have been discovered.</li>
  <li>It then attempts to connect to those pods, using Akka&rsquo;s HTTP management interface, and queries whether any of those pods have already formed a cluster.</li>
  <li>If a cluster has already been formed, then the application will join the cluster.</li>
  <li>If a cluster has not yet been formed on any of the pods, a deterministic function is used to decide which pod will initiate the cluster -  this function ensures that all pods that are currently going through this process will decide on the same pod.</li>
  <li>The pod that is decided to start the cluster forms a cluster with itself.</li>
  <li>The remaining pods poll that pod until it reports that it has formed a cluster, they then join it.</li>
</ol>
<p>For a much more detailed description of this process, see the <a href="https://developer.lightbend.com/docs/akka-management/current/bootstrap/details.html">Akka Cluster Bootstrap documentation</a>.</p>
<h2><a href="#bootstrap-and-management-dependencies" name="bootstrap-and-management-dependencies" class="anchor"><span class="anchor-link"></span></a>Bootstrap and Management dependencies</h2>
<p>Add the following dependencies to your application:</p>
<ul>
  <li>Akka Management Cluster HTTP: This provides HTTP management endpoints as well as a <a href="../cluster-http-management.html#health-checks">cluster health check</a></li>
  <li><a href="../discovery/kubernetes.html">Akka Discovery Kubernetes</a>: This provides a discovery mechanism that queries the Kubernetes API</li>
  <li><a href="../bootstrap/index.html">Akka Bootstrap</a>: This bootstraps the cluster from nodes discovered via the Kubernetes API</li>
</ul><dl class="dependency"><dt>sbt</dt><dd><pre class="prettyprint"><code class="language-scala">val AkkaManagementVersion = "1.4.0"
libraryDependencies ++= Seq(
  "com.lightbend.akka.management" %% "akka-management-cluster-http" % AkkaManagementVersion,
  "com.lightbend.akka.management" %% "akka-management-cluster-bootstrap" % AkkaManagementVersion,
  "com.lightbend.akka.discovery" %% "akka-discovery-kubernetes-api" % AkkaManagementVersion
)</code></pre></dd><dt>Gradle</dt><dd><pre class="prettyprint"><code class="language-gradle">def versions = [
  AkkaManagementVersion: "1.4.0",
  ScalaBinary: "2.13"
]
dependencies {
  implementation "com.lightbend.akka.management:akka-management-cluster-http_${versions.ScalaBinary}:${versions.AkkaManagementVersion}"
  implementation "com.lightbend.akka.management:akka-management-cluster-bootstrap_${versions.ScalaBinary}:${versions.AkkaManagementVersion}"
  implementation "com.lightbend.akka.discovery:akka-discovery-kubernetes-api_${versions.ScalaBinary}:${versions.AkkaManagementVersion}"
}</code></pre></dd><dt>Maven</dt><dd><pre class="prettyprint"><code class="language-xml">&lt;properties&gt;
  &lt;akka.management.version&gt;1.4.0&lt;/akka.management.version&gt;
  &lt;scala.binary.version&gt;2.13&lt;/scala.binary.version&gt;
&lt;/properties&gt;
&lt;dependencies&gt
  &lt;dependency&gt;
    &lt;groupId&gt;com.lightbend.akka.management&lt;/groupId&gt;
    &lt;artifactId&gt;akka-management-cluster-http_${scala.binary.version}&lt;/artifactId&gt;
    &lt;version&gt;${akka.management.version}&lt;/version&gt;
  &lt;/dependency&gt
  &lt;dependency&gt;
    &lt;groupId&gt;com.lightbend.akka.management&lt;/groupId&gt;
    &lt;artifactId&gt;akka-management-cluster-bootstrap_${scala.binary.version}&lt;/artifactId&gt;
    &lt;version&gt;${akka.management.version}&lt;/version&gt;
  &lt;/dependency&gt
  &lt;dependency&gt;
    &lt;groupId&gt;com.lightbend.akka.discovery&lt;/groupId&gt;
    &lt;artifactId&gt;akka-discovery-kubernetes-api_${scala.binary.version}&lt;/artifactId&gt;
    &lt;version&gt;${akka.management.version}&lt;/version&gt;
  &lt;/dependency&gt
&lt;/dependencies&gt;</code></pre></dd></dl>
<h2><a href="#configuring-cluster-bootstrap" name="configuring-cluster-bootstrap" class="anchor"><span class="anchor-link"></span></a>Configuring Cluster Bootstrap</h2>
<p>There are three components that need to be configured: Akka Cluster, Akka Management HTTP, and Akka Cluster Bootstrap.</p>
<h3><a href="#akka-cluster" name="akka-cluster" class="anchor"><span class="anchor-link"></span></a>Akka Cluster</h3>
<p>Set three things for Akka Cluster:</p>
<ul>
  <li>Set the actor provider to <code>cluster</code>.</li>
  <li>Shutdown if cluster formation doesn&rsquo;t work. This will cause Kubernetes to re-create the pod.</li>
  <li>Exit the JVM on ActorSystem termination to allow Kubernetes to re-create it.</li>
</ul>
<pre class="prettyprint"><code class="language-HOCON">akka {
    actor {
        provider = cluster
    }

    cluster {
        shutdown-after-unsuccessful-join-seed-nodes = 60s
    }
    coordinated-shutdown.exit-jvm = on
}
</code></pre>
<h3><a href="#akka-management-http" name="akka-management-http" class="anchor"><span class="anchor-link"></span></a>Akka Management HTTP</h3>
<p>The default configuration for Akka management HTTP is suitable for use in Kubernetes, it will bind to a default port of 8558 on the pods external IP address.</p>
<h3><a href="#akka-cluster-bootstrap" name="akka-cluster-bootstrap" class="anchor"><span class="anchor-link"></span></a>Akka Cluster Bootstrap</h3>
<p>To configure Cluster Bootstrap, we need to tell it which discovery method will be used to discover the other nodes in the cluster. This uses Akka Discovery to find nodes, however, the discovery method and configuration used in Cluster Bootstrap will often be different to the method used for looking up other services. The reason for this is that during Cluster Bootstrap, we are interested in discovering nodes even when they aren&rsquo;t ready to handle requests yet, for example, because they too are trying to form a cluster. If we were to use a method such as DNS to lookup other services, the Kubernetes DNS server, by default, will only return services that are ready to serve requests, indicated by their readiness check passing. Hence, when forming a new cluster, there is a chicken or egg problem, Kubernetes won&rsquo;t tell us which nodes are running that we can form a cluster with until those nodes are ready, and those nodes won&rsquo;t pass their readiness check until they&rsquo;ve formed a cluster.</p>
<p>Hence, we need to use a different discovery method for Cluster Bootstrap, and for Kubernetes, the simplest method is to use the Kubernetes API, which will return all nodes regardless of their readiness state. </p>
<pre><code>akka.management {
  cluster.bootstrap {
    contact-point-discovery {
      discovery-method = kubernetes-api
    }
  }
}
</code></pre>
<p>You can optionally specify a <code>service-name</code> otherwise the name of the AkkaSystem is used that matches your label in the deployment spec.</p>
<h2><a href="#starting" name="starting" class="anchor"><span class="anchor-link"></span></a>Starting</h2>
<p>To ensure that Cluster Bootstrap is started, both the Cluster Bootstrap and the Akka Management extensions must be started. This can be done by invoking the <code>start</code> method on both the <code>ClusterBoostrap</code> and <code>AkkaManagement</code> extensions when your application starts up.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-management/tree/v1.4.0/cluster-bootstrap/src/test/scala/doc/akka/management/cluster/bootstrap/ClusterBootstrapCompileOnly.scala#L16-L20" target="_blank" title="Go to snippet source">source</a><code class="language-scala">// Akka Management hosts the HTTP routes used by bootstrap
AkkaManagement(system).start()

// Starting the bootstrap process needs to be done explicitly
ClusterBootstrap(system).start()</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-management/tree/v1.4.0/cluster-bootstrap/src/test/java/jdoc/akka/management/cluster/bootstrap/ClusterBootstrapCompileOnly.java#L17-L21" target="_blank" title="Go to snippet source">source</a><code class="language-java">// Akka Management hosts the HTTP routes used by bootstrap
AkkaManagement.get(system).start();

// Starting the bootstrap process needs to be done explicitly
ClusterBootstrap.get(system).start();</code></pre></dd>
</dl>
<h2><a href="#role-based-access-control" name="role-based-access-control" class="anchor"><span class="anchor-link"></span></a>Role-Based Access Control</h2>
<p>By default, pods are unable to use the Kubernetes API because they are not authenticated to do so. In order to allow the applications pods to form an Akka Cluster using the Kubernetes API, we need to define some Role-Based Access Control (RBAC) roles and bindings.</p>
<p>RBAC allows the configuration of access control using two key concepts, roles, and role bindings. A role is a set of permissions to access something in the Kubernetes API. For example, a <code>pod-reader</code> role may have permission to perform the <code>list</code>, <code>get</code> and <code>watch</code> operations on the <code>pods</code> resource in a particular namespace, by default the same namespace that the role is configured in. In fact, that&rsquo;s exactly what we are going to configure, as this is the permission that our pods need. Here&rsquo;s the spec for the <code>pod-reader</code> role to be added in <code>kubernetes/akka-cluster.yaml</code>:</p>
<pre class="prettyprint"><code class="language-yaml">---
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: pod-reader
rules:
- apiGroups: [&quot;&quot;]
  resources: [&quot;pods&quot;]
  verbs: [&quot;get&quot;, &quot;watch&quot;, &quot;list&quot;]
</code></pre>
<p>Having configured a role, you can then bind that role to a subject. A subject is typically either a user or a group, and a user may be a human user, or it could be a service account. A service account is an account created by Kubernetes for Kubernetes resources, such as applications running in pods, to access the Kubernetes API. Each namespace has a default service account that is used by default by pods that don&rsquo;t explicitly declare a service account, otherwise, you can define your own service accounts. Kubernetes automatically injects the credentials of a pods service account into that pods filesystem, allowing the pod to use them to make authenticated requests on the Kubernetes API.</p>
<p>Since we are just using the default service account, we need to bind our role to the default service account so that our pod will be able to access the Kubernetes API as a <code>pod-reader</code>. In <code>kubernetes/akka-cluster.yaml</code>:</p>
<pre class="prettyprint"><code class="language-yaml">---
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: read-pods
subjects:
- kind: User
  name: system:serviceaccount:appka-1:default
roleRef:
  kind: Role
  name: pod-reader
  apiGroup: rbac.authorization.k8s.io
</code></pre>
<p>Note the service account name, <code>system:serviceaccount:appka-1:default</code>, contains the <code>appka-1</code> namespace in it. You&rsquo;ll need to update it accordingly.</p>
<h3><a href="#a-note-on-secrets-with-rbac" name="a-note-on-secrets-with-rbac" class="anchor"><span class="anchor-link"></span></a>A note on secrets with RBAC</h3>
<p>One thing to be aware of when using role based access control, the <code>pod-reader</code> role is going to grant access to read all pods in the <code>appka-1</code> namespace, not just the pods for your application. This includes the deployment specs, which includes the environment variables that are hard coded in the deployment specs. If you pass secrets through those environment variables, rather than using the Kubernetes secrets API, then your application, and every other app that uses the default service account, will be able to see these secrets. This is a good reason why you should never pass secrets directly in deployment specs, rather, you should pass them through the Kubernetes secrets API.</p>
<p>If this is a concern, one solution might be to create a separate namespace for each application you wish to deploy. You may find the configuration overhead of doing this very high though, it&rsquo;s not what Kubernetes namespaces are intended to be used for.</p>
<h2><a href="#health-checks" name="health-checks" class="anchor"><span class="anchor-link"></span></a>Health Checks</h2>
<p>Akka management HTTP includes <a href="../healthchecks.html">health check routes</a> that will expose liveness and readiness health checks on <code>/alive</code> and <code>/ready</code> respectively. </p>
<p>In Kubernetes, if an application is live, it means it is running - it hasn&rsquo;t crashed. But it may not necessarily be ready to serve requests, for example, it might not yet have managed to connect to a database, or, in our case, it may not have formed a cluster yet. </p>
<p>By separating <a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#container-probes">liveness and readiness</a>, Kubernetes can distinguish between fatal errors, like crashing, and transient errors, like not being able to contact other resources that the application depends on, allowing Kubernetes to make more intelligent decisions about whether an application needs to be restarted, or if it just needs to be given time to sort itself out.</p>
<p>These routes expose information which is the result of multiple internal checks. For example, by depending on <code>akka-management-cluster-http</code> the health checks will take cluster membership status into consideration and will be a check to ensure that a cluster has been formed.</p>
<p>Finally, we need to configure the health checks. As mentioned earlier, Akka Management HTTP provides health check endpoints for us, both for readiness and liveness. Kubernetes just needs to be told about this. The first thing we do is configure a name for the management port, while not strictly necessary, this allows us to refer to it by name in the probes, rather than repeating the port number each time. We&rsquo;ll configure some of the numbers around here, we&rsquo;re going to tell Kubernetes to wait 20 seconds before attempting to probe anything, this gives our cluster a chance to start before Kubernetes starts trying to ask us if it&rsquo;s ready, and since in some scenarios, particularly if you haven&rsquo;t assigned a lot of CPU to your pods, it can take a long time for the cluster to start, so we&rsquo;ll give it a high failure threshold of 10.</p>
<p>Health check probes can be adjusted in <code>kubernetes/akka-cluster.yaml</code>:</p>
<pre class="prettyprint"><code class="language-yaml">ports:
  - name: management
    containerPort: 8558
readinessProbe:
  httpGet:
    path: &quot;/ready&quot;
    port: management
  periodSeconds: 10
  failureThreshold: 10
  initialDelaySeconds: 20
livenessProbe:
  httpGet:
    path: &quot;/alive&quot;
    port: management
  periodSeconds: 10
  failureThreshold: 10
  initialDelaySeconds: 20
</code></pre>
<h2><a href="#rolling-updates" name="rolling-updates" class="anchor"><span class="anchor-link"></span></a>Rolling Updates</h2>
<p>Starting from Kubernetes v1.22, ReplicaSets are not scaled down with the youngest node first which can cause problems for the Akka cluster. A new Akka extension was developed to address this issue, and you can find the documentation under <a href="../rolling-updates.html#kubernetes-rolling-updates">Kubernetes Rolling Updates</a> section.</p>
</div>
</article>
<div class="row">
<div class="small-12 column">
<section class="nav-prev-next row">
<div class="nav-prev small-6 column">
<a href="../kubernetes-deployment/preparing-for-production.html"><i class="icon-prev"></i> <span class="link-prev">Preparing for production</span></a>
</div>
<div class="nav-next small-6 column clearfix">
<a class="float-right" href="../kubernetes-deployment/building.html">Building the application <i class="icon-next"></i></a>
</div>
</section>
</div>
</div>
<div class="source-github row">
Found an error in this documentation? The source code for this page can be found <a href="https://github.com/akka/akka-management/tree/v1.4.0/docs/src/main/paradox/kubernetes-deployment/forming-a-cluster.md">here</a>.
Please feel free to edit and contribute a pull request.
</div>

<footer class="page-footer row clearfix">
<img class="akka-icon float-left show-for-medium" src="../images/akka-icon.svg" />
<section class="copyright">
<div>Akka Management is available under the <a href="https://www.lightbend.com/akka/license" target="_blank">Business Source License 1.1</a>.</div>
<p class="legal">
&copy; 2011-2023 <a href="https://www.lightbend.com" target="_blank">Lightbend, Inc.</a> |
<a href="https://www.lightbend.com/legal/licenses" target="_blank">Licenses</a> |
<a href="https://www.lightbend.com/legal/terms" target="_blank">Terms</a> |
<a href="https://www.lightbend.com/legal/privacy" target="_blank">Privacy Policy</a> |
<a href="https://akka.io/cookie/" target="_blank">Cookie Listing</a> |
<a class="optanon-toggle-display">Cookie Settings</a>
</p>
</section>

</footer>
</section>
</main>
</div>

<script type="text/javascript" src="../js/scrollsneak.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../js/groups.js"></script>
<script type="text/javascript" src="../js/page.js"></script>
<script type="text/javascript" src="../js/snippets.js"></script>
<script type="text/javascript" src="../js/magellan.js"></script>
<script type="text/javascript" src="../js/metadata-toggle.js"></script>
<script type="text/javascript" src="../js/lbHeader.js"></script>

<style type="text/css">@import "../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(){window.prettyPrint && prettyPrint()});
//]]></script>
<script type="text/javascript" src="../assets/js/warnOldVersion.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(jq){initOldVersionWarnings(jq, '1.4.0', 'https://doc.akka.io/docs/akka-management/current/')});
//]]></script>


</body>
</html>
