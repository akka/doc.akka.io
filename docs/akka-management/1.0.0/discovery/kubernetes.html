<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Kubernetes API &bull; Akka Management</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="Akka Management is a suite of tools for operating Akka Clusters."/>
<link rel="canonical" href="https://doc.akka.io/docs/akka-management/current/discovery/kubernetes.html"/>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../lib/foundation/dist/js/foundation.min.js"></script>
<link rel="stylesheet" type="text/css" href="../lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="../lib/foundation/dist/css/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" type="text/css" href="../css/icons.css"/>
<link rel="stylesheet" type="text/css" href="../css/page.css"/>
<link rel="shortcut icon" href="../images/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="../images/apple-touch-icon.png"/>
<link rel="icon" type="image/png" sizes="32x32" href="../images/favicon-32x32.png"/>
<link rel="icon" type="image/png" sizes="16x16" href="../images/favicon-16x16.png"/>
<link rel="manifest" href="../images/manifest.json"/>
<meta name="msapplication-TileImage" content="../images/mstile-150x150.png"/>
<meta name="msapplication-TileColor" content="#15a9ce"/>
<meta name="theme-color" content="#15a9ce"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) start -->
<script src="https://optanon.blob.core.windows.net/consent/159bb13d-6748-4399-806e-ac28db879785.js" type="text/javascript" charset="UTF-8"></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) end -->
<!--Google Analytics-->
<script type="text/plain" class="optanon-category-2">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', '']);
_gaq.push(['_setDomainName', '']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})()
</script>
<script type="text/plain" class="optanon-category-2">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-23127719-1', 'lightbend.com', {'allowLinker': true, 'name': 'tsTracker'});
ga('tsTracker.require', 'linker');
ga('tsTracker.linker:autoLink', ['lightbend.com','playframework.com','scala-lang.org','scaladays.org','spray.io','akka.io','scala-sbt.org','scala-ide.org']);
ga('tsTracker.send', 'pageview');
</script>
<!--Marketo-->
<script type="text/plain" class="optanon-category-3">
(function() {
var didInit = false;
function initMunchkin() {
if(didInit === false) {
didInit = true;
Munchkin.init('558-NCX-702', { 'asyncOnly': true, 'disableClickDelay': true });
}
}
var s = document.createElement('script');
s.type = 'text/javascript';
s.async = true;
s.src = '//munchkin.marketo.net/munchkin.js';
s.onreadystatechange = function() {
if (this.readyState == 'complete' || this.readyState == 'loaded') {
initMunchkin();
}
};
s.onload = initMunchkin;
document.getElementsByTagName('head')[0].appendChild(s);
})();
</script>
</head>

<body id="underlay" data-toggler="nav-open">

<header class="site-header hide-for-large">
<div class="sticky-header clearfix">
<a href="https://akka.io"><img class="logo" src="../images/akka-logo-reverse.svg"/></a>

<button class="menu-icon float-right" type="button" data-toggle="underlay overlay"></button>
</div>
<div id="overlay" class="overlay-nav" data-toggler="nav-open">
<header class="nav-header">
<div class="nav-header-title">
<h1><a href="../index.html">Akka Management</a></h1>
</div>
<div class="nav-header-version">
Version 1.0.0
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="nav-toc">
<ul>
  <li><a href="../index.html#overview" class="header">Overview</a></li>
  <li><a href="../index.html#compatibility-support" class="header">Compatibility &amp; support</a></li>
  <li><a href="../akka-management.html" class="page">Akka Management</a></li>
  <li><a href="../migration.html" class="page">Migration guide</a></li>
  <li><a href="../healthchecks.html" class="page">Health checks</a></li>
  <li><a href="../bootstrap/index.html" class="page">Akka Cluster Bootstrap</a></li>
  <li><a href="../discovery/index.html" class="page">Akka Discovery Methods</a>
  <ul>
    <li><a href="../discovery/kubernetes.html#kubernetes-api" class="active page">Kubernetes API</a>
    <ul>
      <li><a href="../discovery/kubernetes.html#dependencies-and-usage" class="header">Dependencies and usage</a></li>
      <li><a href="../discovery/kubernetes.html#role-based-access-control" class="header">Role-Based Access Control</a></li>
    </ul></li>
    <li><a href="../discovery/consul.html" class="page">Consul</a></li>
    <li><a href="../discovery/marathon.html" class="page">Marathon API</a></li>
    <li><a href="../discovery/aws.html" class="page">AWS API</a></li>
  </ul></li>
  <li><a href="../cluster-http-management.html" class="page">Cluster Http Management</a></li>
  <li><a href="../cluster-jmx-management.html" class="page">Built-in JMX Management</a></li>
</ul>
</nav>
</div>
</header>

<aside class="show-for-large">
<header class="nav-header fixed-sidebar-header">
<div class="nav-header-title">
<h1><a href="../index.html">Akka Management</a></h1>
</div>
<div class="nav-header-version">
Version 1.0.0
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="site-nav fixed-sidebar-contents">
<div class="nav-toc">
<ul>
  <li><a href="../index.html#overview" class="header">Overview</a></li>
  <li><a href="../index.html#compatibility-support" class="header">Compatibility &amp; support</a></li>
  <li><a href="../akka-management.html" class="page">Akka Management</a></li>
  <li><a href="../migration.html" class="page">Migration guide</a></li>
  <li><a href="../healthchecks.html" class="page">Health checks</a></li>
  <li><a href="../bootstrap/index.html" class="page">Akka Cluster Bootstrap</a></li>
  <li><a href="../discovery/index.html" class="page">Akka Discovery Methods</a>
  <ul>
    <li><a href="../discovery/kubernetes.html#kubernetes-api" class="active page">Kubernetes API</a>
    <ul>
      <li><a href="../discovery/kubernetes.html#dependencies-and-usage" class="header">Dependencies and usage</a></li>
      <li><a href="../discovery/kubernetes.html#role-based-access-control" class="header">Role-Based Access Control</a></li>
    </ul></li>
    <li><a href="../discovery/consul.html" class="page">Consul</a></li>
    <li><a href="../discovery/marathon.html" class="page">Marathon API</a></li>
    <li><a href="../discovery/aws.html" class="page">AWS API</a></li>
  </ul></li>
  <li><a href="../cluster-http-management.html" class="page">Cluster Http Management</a></li>
  <li><a href="../cluster-jmx-management.html" class="page">Built-in JMX Management</a></li>
</ul>
</div>
</nav>
<footer class="nav-footer fixed-sidebar-footer">
<a href="https://akka.io"><img class="logo" src="../images/akka-logo-reverse.svg"/></a>

</footer>
</aside>

<main class="fixed-shift-for-large expanded row">
<section class="site-content small-12 column">

<article class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h2><a href="#kubernetes-api" name="kubernetes-api" class="anchor"><span class="anchor-link"></span></a>Kubernetes API</h2>
<p>The typical way to consume a service in Kubernetes is to discover it through DNS: this will take into account liveness/readiness checks, and depending on the configuration take care of load balancing (removing the need for client-side load balancing). For this reason, for general usage the <a href="https://doc.akka.io/docs/akka/current/discovery/index.html#discovery-method-dns"><code>akka-dns</code></a> implementation is usually a better fit for discovering services in Kubernetes. However, in some cases, such as for <a href="../bootstrap/index.html">Cluster Bootstrap</a>, it is desirable to connect to the pods directly, bypassing any liveness/readiness checks or load balancing. For such situations we provide a discovery implementation that uses the Kubernetes API.</p>
<h3><a href="#dependencies-and-usage" name="dependencies-and-usage" class="anchor"><span class="anchor-link"></span></a>Dependencies and usage</h3>
<p>First, add the dependency on the component:</p><dl class="dependency"><dt>sbt</dt><dd><pre class="prettyprint"><code class="language-scala">libraryDependencies += "com.lightbend.akka.discovery" %% "akka-discovery-kubernetes-api" % "1.0.0"</code></pre></dd><dt>Gradle</dt><dd><pre class="prettyprint"><code class="language-gradle">dependencies {
  compile group: 'com.lightbend.akka.discovery', name: 'akka-discovery-kubernetes-api_2.12', version: '1.0.0'
}</code></pre></dd><dt>Maven</dt><dd><pre class="prettyprint"><code class="language-xml">&lt;dependency&gt;
  &lt;groupId&gt;com.lightbend.akka.discovery&lt;/groupId&gt;
  &lt;artifactId&gt;akka-discovery-kubernetes-api_2.12&lt;/artifactId&gt;
  &lt;version&gt;1.0.0&lt;/version&gt;
&lt;/dependency&gt;</code></pre></dd></dl>
<p>As described above, it is uncommon to use the Kubernetes API discovery mechanism as your default discovery mechanism. When using it with Akka Cluster Bootstrap, it is sufficient to configure it as described <a href="../bootstrap/kubernetes-api.html">here</a>. Otherwise, to load it manually, use <code>loadServiceDiscovery</code> on the <code>Discovery</code> extension:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka-management/tree/v1.0.0/discovery-kubernetes-api/src/test/scala/akka/discovery/kubernetes/KubernetesApiServiceDiscoverySpec.scala#L52" target="_blank" title="Go to snippet source"></a><code class="language-scala">val discovery = Discovery(system).loadServiceDiscovery(&quot;kubernetes-api&quot;)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka-management/tree/v1.0.0/discovery-kubernetes-api/src/test/java/docs/KubernetesApiDiscoveryDocsTest.java#L15" target="_blank" title="Go to snippet source"></a><code class="language-java">ServiceDiscovery discovery = Discovery.get(system).loadServiceDiscovery(&quot;kubernetes-api&quot;);</code></pre></dd>
</dl>
<p>To find other pods, this method needs to know how they are labeled, what the name of the target port is, and what namespace they reside in. Below, you&rsquo;ll find the default configuration. It can be customized by changing these values in your <code>application.conf</code>.</p>
<pre><code>akka.discovery {
  kubernetes-api {
    pod-namespace = &quot;default&quot;

    # %s will be replaced with the configured effective name, which defaults to
    # the actor system name
    pod-label-selector = &quot;app=%s&quot;
  }
}
</code></pre>
<p>This configuration complements the following Deployment specification:</p>
<pre><code>apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  labels:
    app: example
  name: example
spec:
  replicas: 4
  selector:
    matchLabels:
      app: example
  template:
    metadata:
      labels:
        app: example
    spec:
      containers:
      - name: example
        image: example/image:1.0.0
        imagePullPolicy: IfNotPresent
        ports:
        # akka remoting
        - name: remoting
          containerPort: 2552
          protocol: TCP
        # When
        # akka.management.cluster.bootstrap.contact-point-discovery.port-name
        # is defined, it must correspond to this name:
        - name: management
          containerPort: 8558
          protocol: TCP
</code></pre>
<h3><a href="#role-based-access-control" name="role-based-access-control" class="anchor"><span class="anchor-link"></span></a>Role-Based Access Control</h3>
<p>If your Kubernetes cluster has <a href="https://kubernetes.io/docs/admin/authorization/rbac/">Role-Based Access Control (RBAC)</a> enabled, you&rsquo;ll also have to grant the Service Account that your pods run under access to list pods. The following configuration can be used as a starting point. It creates a <code>Role</code>, <code>pod-reader</code>, which grants access to query pod information. It then binds the default Service Account to the <code>Role</code> by creating a <code>RoleBinding</code>. Adjust as necessary.</p>
<blockquote>
  <p>Using Google Kubernetes Engine? Your user will need permission to grant roles. See <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/role-based-access-control#prerequisites_for_using_role-based_access_control">Google&rsquo;s Documentation</a> for more information.</p>
</blockquote>
<pre class="prettyprint"><code class="language-yaml">---
#
# Create a role, `pod-reader`, that can list pods and
# bind the default service account in the `default` namespace
# to that role.
#

kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: pod-reader
rules:
- apiGroups: [&quot;&quot;] # &quot;&quot; indicates the core API group
  resources: [&quot;pods&quot;]
  verbs: [&quot;get&quot;, &quot;watch&quot;, &quot;list&quot;]
---
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: read-pods
subjects:
# Note the `name` line below. The first default refers to the namespace. The second refers to the service account name.
# For instance, `name: system:serviceaccount:myns:default` would refer to the default service account in namespace `myns`
- kind: User
  name: system:serviceaccount:default:default
roleRef:
  kind: Role
  name: pod-reader
  apiGroup: rbac.authorization.k8s.io
</code></pre>
</div>
</article>

<div class="row">
<div class="small-12 large-9 column">
<section class="nav-prev-next row">
<div class="nav-prev small-6 column">
<a href="../discovery/index.html"><i class="icon-prev"></i> <span class="link-prev">Akka Discovery Methods</span></a>
</div>
<div class="nav-next small-6 column clearfix">
<a class="float-right" href="../discovery/consul.html">Consul <i class="icon-next"></i></a>
</div>
</section>
</div>
</div>

<div class="source-github row">
Found an error in this documentation? The source code for this page can be found <a href="https://github.com/akka/akka-management/tree/v1.0.0/docs/src/main/paradox/discovery/kubernetes.md">here</a>.
Please feel free to edit and contribute a pull request.
</div>


<footer class="page-footer row clearfix">
<img class="akka-icon float-left show-for-medium" src="../images/akka-icon.svg"/>
<section class="copyright">
<div>Akka Management is Open Source and available under the Apache 2 License.</div>
<p class="legal">
&copy; 2011-2019 <a href="https://www.lightbend.com" target="_blank">Lightbend, Inc.</a> | 
<a href="https://www.lightbend.com/legal/licenses" target="_blank">Licenses</a> | 
<a href="https://www.lightbend.com/legal/terms" target="_blank">Terms</a> | 
<a href="https://www.lightbend.com/legal/privacy" target="_blank">Privacy Policy</a> | 
<a href="https://akka.io/cookie/" target="_blank">Cookie Listing</a> | 
<a class="optanon-toggle-display">Cookie Settings</a>
</p>
</section>
</footer>

</section>
</main>

<script type="text/javascript" src="../js/scrollsneak.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../js/groups.js"></script>
<script type="text/javascript" src="../js/page.js"></script>
<script type="text/javascript" src="../js/magellan.js"></script>

<style type="text/css">@import "../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(){window.prettyPrint && prettyPrint()});
//]]></script>
<script type="text/javascript" src="../assets/js/warnOldVersion.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(jq){initOldVersionWarnings(jq, '1.0.0', 'https://doc.akka.io/docs/akka-management/current/')});
//]]></script>


</body>
</html>
