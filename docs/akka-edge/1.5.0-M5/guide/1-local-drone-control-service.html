<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Local Drone Control Service &bull; Akka Edge</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="Akka Projection."/>
<link rel="canonical" href="https://doc.akka.io/docs/akka-edge/current/guide/1-local-drone-control-service.html"/>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../lib/foundation/dist/js/foundation.min.js"></script>
<link rel="stylesheet" type="text/css" href="../lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="../lib/foundation/dist/css/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" type="text/css" href="../css/icons.css"/>
<link rel="stylesheet" type="text/css" href="../css/page-8.css"/>
<link rel="stylesheet" type="text/css" href="../css/banner-2.css"/>
<link rel="shortcut icon" href="../images/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="../images/apple-touch-icon.png"/>
<link rel="icon" type="image/png" sizes="32x32" href="../images/favicon-32x32.png"/>
<link rel="icon" type="image/png" sizes="16x16" href="../images/favicon-16x16.png"/>
<link rel="manifest" href="../images/manifest.json"/>
<meta name="msapplication-TileImage" content="../images/mstile-150x150.png"/>
<meta name="msapplication-TileColor" content="#15a9ce"/>
<meta name="theme-color" content="#15a9ce"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) start -->
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js"  type="text/javascript" charset="UTF-8" data-domain-script="28b912e7-09e9-43d5-91e4-3d1897044004" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) end -->
<!--Google Analytics NOTE this will stop processing data July 1st 2023. At which point this embed code can be removed-->
<script type="text/plain" class="optanon-category-2">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', '']);
_gaq.push(['_setDomainName', '']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})()
</script>

<!-- Google Tag Manager: Updated May 17th 2023 - Cookie Compliance checks have been moved into Google Tag Manager -->
<script type="text/javascript">
(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KBJGH35');
</script>

</head>

<body id="underlay" data-toggler="nav-open">
<div id="lightbend-banner" class="lightbend-banner akka full-width" data-category="OSS Lightbend Banner Impression" data-label="Akka Banner Impression">
<div class="oss-wrapper">
<div class="oss-brand">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lightbend Logo - Akka Banner" href="https://www.lightbend.com">
<img class="lightbend-logo" src="../images/banner-logos/lightbend-reverse.svg" alt="Lightbend" title="Lightbend">
</a>
</div>
<div class="oss-ad no-drop-down">
<nav id="lightbendRotator" class="lightbend-rotator">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Promo Rotator - Lightbend Changed its Software Licensing Model for Akka Technology. [License FAQ] - Akka Banner" href="https://www.lightbend.com/akka/license-faq">
<strong>Lightbend</strong> Changed its Software Licensing Model for Akka Technology. <span class="akka-btn">License FAQ</span>
</a>
</nav>
</div>
</div>
</div>

<header class="site-header hide-for-large">
<div class="sticky-header clearfix">
<a href="https://akka.io"><img class="logo" src="../images/akka-logo-reverse.svg"/></a>

<button class="menu-icon float-right" type="button" data-toggle="underlay overlay"></button>
</div>
<div id="overlay" class="overlay-nav" data-toggler="nav-open">
<header class="nav-header">
<div class="nav-header-title">
<h1><a href="../index.html">Akka Edge</a></h1>
</div>
<div class="nav-header-version">
Version 1.5.0-M5
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="nav-toc">
<ul>
  <li><a href="../overview.html" class="page">Architectural Overview</a></li>
  <li><a href="../use-cases.html" class="page">Example Use Cases</a></li>
  <li><a href="../feature-summary.html" class="page">Feature Summary</a></li>
  <li><a href="../guide.html" class="page">Guide</a>
  <ul>
    <li><a href="../guide/1-local-drone-control-service.html#local-drone-control-service" class="active page">Local Drone Control Service</a>
    <ul>
      <li><a href="../guide/1-local-drone-control-service.html#implementing-a-drone-digital-twin" class="header">Implementing a Drone digital twin</a></li>
      <li><a href="../guide/1-local-drone-control-service.html#grpc-service-api-for-the-drone-communication" class="header">gRPC Service API for the drone communication</a></li>
      <li><a href="../guide/1-local-drone-control-service.html#wiring-it-all-up" class="header">Wiring it all up</a></li>
      <li><a href="../guide/1-local-drone-control-service.html#running-the-sample" class="header">Running the sample</a></li>
      <li><a href="../guide/1-local-drone-control-service.html#whats-next-" class="header">What&rsquo;s next?</a></li>
    </ul></li>
    <li><a href="../guide/2-drone-location-to-cloud-service.html" class="page">Coarse Grained Location Replication</a></li>
    <li><a href="../guide/3-restaurant-deliveries-service.html" class="page">Restaurant deliveries</a></li>
    <li><a href="../guide/4-local-drone-delivery-selection.html" class="page">Local Drone Delivery Selection</a></li>
    <li><a href="../guide/5-deploying-the-services.html" class="page">Deploying the Restaurant Delivery Service</a></li>
  </ul></li>
</ul>
</nav>
</div>
</header>
<div class="site-content-wrapper">
<aside class="sticky-sidebar show-for-large">
<header class="nav-header sticky-sidebar-header">
<div class="nav-header-title">
<h1><a href="../index.html">Akka Edge</a></h1>
</div>
<div class="nav-header-version">
Version 1.5.0-M5
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="site-nav sticky-sidebar-contents">
<div class="nav-toc">
<ul>
  <li><a href="../overview.html" class="page">Architectural Overview</a></li>
  <li><a href="../use-cases.html" class="page">Example Use Cases</a></li>
  <li><a href="../feature-summary.html" class="page">Feature Summary</a></li>
  <li><a href="../guide.html" class="page">Guide</a>
  <ul>
    <li><a href="../guide/1-local-drone-control-service.html#local-drone-control-service" class="active page">Local Drone Control Service</a>
    <ul>
      <li><a href="../guide/1-local-drone-control-service.html#implementing-a-drone-digital-twin" class="header">Implementing a Drone digital twin</a></li>
      <li><a href="../guide/1-local-drone-control-service.html#grpc-service-api-for-the-drone-communication" class="header">gRPC Service API for the drone communication</a></li>
      <li><a href="../guide/1-local-drone-control-service.html#wiring-it-all-up" class="header">Wiring it all up</a></li>
      <li><a href="../guide/1-local-drone-control-service.html#running-the-sample" class="header">Running the sample</a></li>
      <li><a href="../guide/1-local-drone-control-service.html#whats-next-" class="header">What&rsquo;s next?</a></li>
    </ul></li>
    <li><a href="../guide/2-drone-location-to-cloud-service.html" class="page">Coarse Grained Location Replication</a></li>
    <li><a href="../guide/3-restaurant-deliveries-service.html" class="page">Restaurant deliveries</a></li>
    <li><a href="../guide/4-local-drone-delivery-selection.html" class="page">Local Drone Delivery Selection</a></li>
    <li><a href="../guide/5-deploying-the-services.html" class="page">Deploying the Restaurant Delivery Service</a></li>
  </ul></li>
</ul>
</div>
</nav>
<footer class="nav-footer sticky-sidebar-footer">
<a href="https://akka.io"><img class="logo" src="../images/akka-logo-reverse.svg"/></a>

</footer>
</aside>
<main class="fixed-shift-for-large expanded row">
<section class="site-content small-12 column">
<article class="page-content row">
<div class="small-12 column" id="docs">
<h1><a href="#local-drone-control-service" name="local-drone-control-service" class="anchor"><span class="anchor-link"></span></a>Local Drone Control Service</h1>
<p>As the other features of Akka Edge are build on top of Event Sourcing, let us start by implementing a digital twin for drones using the <a href="https://doc.akka.io/docs/akka/2.9/typed/persistence.html">Akka Event Sourced Behavior API</a>. </p>
<p><img src="../images/guide-section-1.svg" alt="Diagram showing 2 drone entities in a Local Drone Control Service" /></p>
<p>We will represent drone as an Event Sourced entity, if you are unfamiliar with Event Sourcing, refer to the <a href="https://developer.lightbend.com/docs/akka-guide/microservices-tutorial/">Event Sourcing section in the Akka guide</a> for an explanation. The <a href="https://akka.io/blog/news/2020/01/07/akka-event-sourcing-video">Event Sourcing with Akka video</a> is also a good starting point for learning Event Sourcing.</p>
<p>For drones to communicate their location to the digital twin we will create a gRPC API.</p>
<p>When this first step is completed, the drones will be able to report their location and users inspect the current location of a drone connected to the local control center PoP.</p>
<h2><a href="#implementing-a-drone-digital-twin" name="implementing-a-drone-digital-twin" class="anchor"><span class="anchor-link"></span></a>Implementing a Drone digital twin</h2>
<h3><a href="#commands-and-events" name="commands-and-events" class="anchor"><span class="anchor-link"></span></a>Commands and events</h3>
<p>Commands are the public API of an entity that other parts of the system use to interact with it. Entity state can only be changed by commands. The results of commands are emitted as events. A command can request state changes, and different events might be generated depending on the current state of the entity. A command can also be rejected if it has invalid input or can’t be handled by the current state of the entity.</p>
<p>The Drone only accepts two commands: <code>ReportLocation</code> and <code>GetLocation</code>. When the reported location changes it always persists a <code>PositionUpdated</code> event, but additionally, whenever the position means it changed place on a more coarse grained grid, it also emits a <code>CoarseGrainedLocationChanged</code> event. We will revisit the reason for the coarse grained event in the next step in this guide. </p>
<p>The definition of the commands and events look like this:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-scala/src/main/scala/local/drones/Drone.scala#L24-L47" target="_blank" title="Go to snippet source">source</a><code class="language-scala"><br/>/**
 * This interface defines all the commands (messages) that the Drone actor supports.
 */
sealed trait Command extends CborSerializable

/**
 * A command to report the current position (coordinates and altitude) of the drone.
 *
 * It replies with `Done`, which is sent back to the caller when
 * all the events emitted by this command are successfully persisted.
 */
final case class ReportPosition(position: Position, replyTo: ActorRef[Done])
    extends Command

/**
 * A command to query the current position (coordinates and altitude) of the drone.
 *
 * It replies with a `StatusReply[Position]`, which is sent back to the caller as a success if the
 * coordinates are known. If not an error is sent back.
 */
final case class GetCurrentPosition(replyTo: ActorRef[StatusReply[Position]])
    extends Command


/**
 * This interface defines all the events that the Drone supports.
 */
sealed trait Event extends CborSerializable
final case class PositionUpdated(position: Position) extends Event
final case class CoarseGrainedLocationChanged(
    coordinates: CoarseGrainedCoordinates)
    extends Event</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-java/src/main/java/local/drones/Drone.java#L33-L66" target="_blank" title="Go to snippet source">source</a><code class="language-java">/** This interface defines all the commands (messages) that the Drone actor supports. */
interface Command extends CborSerializable {}

/**
 * A command to report the current position (coordinates and altitude) of the drone.
 *
 * &lt;p&gt;It replies with `Done`, which is sent back to the caller when all the events emitted by this
 * command are successfully persisted.
 */
public static final class ReportPosition implements Command {
  public final Position position;
  public final ActorRef&lt;Done&gt; replyTo;

  public ReportPosition(Position position, ActorRef&lt;Done&gt; replyTo) {
    this.position = position;
    this.replyTo = replyTo;
  }
}

/**
 * A command to query the current position (coordinates and altitude) of the drone.
 *
 * &lt;p&gt;It replies with a `StatusReply&amp;lt;Position&gt;`, which is sent back to the caller as a success
 * if the coordinates are known. If not an error is sent back.
 */
public static final class GetCurrentPosition implements Command {
  public final ActorRef&lt;StatusReply&lt;Position&gt;&gt; replyTo;

  @JsonCreator
  public GetCurrentPosition(ActorRef&lt;StatusReply&lt;Position&gt;&gt; replyTo) {
    this.replyTo = replyTo;
  }
}

/** This interface defines all the events that the Drone supports. */
interface Event extends CborSerializable {}

public static final class PositionUpdated implements Event {
  public final Position position;

  @JsonCreator
  public PositionUpdated(Position position) {
    this.position = position;
  }
}

public static final class CoarseGrainedLocationChanged implements Event {
  public final CoarseGrainedCoordinates coordinates;

  @JsonCreator
  public CoarseGrainedLocationChanged(CoarseGrainedCoordinates coordinates) {
    this.coordinates = coordinates;
  }
}
</code></pre></dd>
</dl>
<h3><a href="#state" name="state" class="anchor"><span class="anchor-link"></span></a>State</h3>
<p>When the location is reported it is kept as a <code>currentState</code>, additionally the 100 previous reported locations are kept in a list. </p>
<p>The list of historical locations is not currently used for anything but is here to show that an entity could keep a time window of fine-grained information to make local decisions at a detail level that would be impractical and maybe not even interesting to report to a central cloud service.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-scala/src/main/scala/local/drones/Drone.scala#L63-L70" target="_blank" title="Go to snippet source">source</a><code class="language-scala">final case class State(
    currentPosition: Option[Position],
    historicalPositions: Vector[Position])
    extends CborSerializable {
  def coarseGrainedCoordinates: Option[CoarseGrainedCoordinates] =
    currentPosition.map(p =&gt;
      CoarseGrainedCoordinates.fromCoordinates(p.coordinates))
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-java/src/main/java/local/drones/Drone.java#L94-L107" target="_blank" title="Go to snippet source">source</a><code class="language-java">class State implements CborSerializable {
  Optional&lt;Position&gt; currentPosition;
  final List&lt;Position&gt; historicalPositions;

  State() {
    currentPosition = Optional.empty();
    historicalPositions = new ArrayList&lt;&gt;();
  }

  Optional&lt;CoarseGrainedCoordinates&gt; coarseGrainedCoordinates() {
    return currentPosition.map(p -&gt; CoarseGrainedCoordinates.fromCoordinates(p.coordinates));
  }
}
</code></pre></dd>
</dl>
<h3><a href="#command-handler" name="command-handler" class="anchor"><span class="anchor-link"></span></a>Command handler</h3>
<p>The Drone entity will receive commands that report when the Drone changes location. We will implement a command handler to process these commands and emit a reply.</p>
<p>The command handler for the Drone looks like this:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-scala/src/main/scala/local/drones/Drone.scala#L102-L137" target="_blank" title="Go to snippet source">source</a><code class="language-scala">private def handleCommand(
    state: State,
    command: Command): ReplyEffect[Event, State] = command match {
  case ReportPosition(position, replyTo) =&gt;
    if (state.currentPosition.contains(position))
      // already seen
      Effect.reply(replyTo)(Done)
    else {
      val newCoarseGrainedLocation =
        CoarseGrainedCoordinates.fromCoordinates(position.coordinates)
      if (state.coarseGrainedCoordinates.contains(newCoarseGrainedLocation)) {
        // same grid location as before
        Effect
          .persist(PositionUpdated(position))
          .thenReply(replyTo)(_ =&gt; Done)
      } else {
        // no previous location known or new grid location
        Effect
          .persist(
            PositionUpdated(position),
            CoarseGrainedLocationChanged(newCoarseGrainedLocation))
          .thenReply(replyTo)(_ =&gt; Done)
      }
    }

  case GetCurrentPosition(replyTo) =&gt;
    state.currentPosition match {
      case Some(position) =&gt;
        Effect.reply(replyTo)(StatusReply.Success(position))
      case None =&gt;
        Effect.reply(replyTo)(
          StatusReply.Error(&quot;Position of drone is unknown&quot;))
    }

}
</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-java/src/main/java/local/drones/Drone.java#L148-L217" target="_blank" title="Go to snippet source">source</a><code class="language-java">@Override
public CommandHandler&lt;Command, Event, State&gt; commandHandler() {
  return newCommandHandlerBuilder()
      .forAnyState()
      .onCommand(ReportPosition.class, this::onReportPosition)
      .onCommand(GetCurrentPosition.class, this::onGetCurrentPosition)
      .build();
}

private Effect&lt;Event, State&gt; onReportPosition(State state, ReportPosition command) {
  if (state.currentPosition.equals(Optional.of(command.position))) {
    // already seen
    return Effect().reply(command.replyTo, done());
  } else {
    var newCoarseGrainedLocation =
        CoarseGrainedCoordinates.fromCoordinates(command.position.coordinates);
    if (state.coarseGrainedCoordinates().equals(Optional.of(newCoarseGrainedLocation))) {
      // same grid location as before
      return Effect()
          .persist(new PositionUpdated(command.position))
          .thenReply(command.replyTo, newState -&gt; done());
    } else {
      // no previous location known or new grid location
      return Effect()
          .persist(
              Arrays.asList(
                  new PositionUpdated(command.position),
                  new CoarseGrainedLocationChanged(newCoarseGrainedLocation)))
          .thenReply(command.replyTo, newState -&gt; done());
    }
  }
}

private Effect&lt;Event, State&gt; onGetCurrentPosition(State state, GetCurrentPosition command) {
  return state
      .currentPosition
      .map(position -&gt; Effect().reply(command.replyTo, StatusReply.success(position)))
      .orElse(Effect().reply(command.replyTo, StatusReply.error(&quot;Position of drone is unknown&quot;)));
}</code></pre></dd>
</dl>
<p>Note how the handler de-duplicates reports of the same location, immediately replying with an acknowledgement without persisting any change.</p>
<p>In addition to storing the <code>PositionUpdated</code> event, the command handler also calculates a coarse grained location, and persists a <code>CoarseGrainedLocationChanged</code> event as well, if it did change from the previous coarse grained location.</p>
<h3><a href="#event-handler" name="event-handler" class="anchor"><span class="anchor-link"></span></a>Event handler</h3>
<p>From commands, the entity creates events that represent state changes. Aligning with the command handler above, the entity’s event handler reacts to events and updates the state. The events are continuously persisted to the Event Journal datastore, while the entity state is kept in memory. Other parts of the application may listen to the events. In case of a restart, the entity recovers its latest state by replaying the events from the Event Journal.</p>
<p>The event handler only reacts to the <code>PositionUpdated</code> event and ignores the <code>CoarseGrainedLocationChanged</code> as the coarse grained location can be calculated from the more fine-grained position coordinates: </p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-scala/src/main/scala/local/drones/Drone.scala#L141-L159" target="_blank" title="Go to snippet source">source</a><code class="language-scala">private def handleEvent(state: State, event: Event): State = event match {
  case PositionUpdated(newPosition) =&gt;
    val newHistoricalPositions = state.currentPosition match {
      case Some(position) =&gt;
        val withPreviousPosition = state.historicalPositions :+ position
        if (withPreviousPosition.size &gt; LocationHistoryLimit)
          withPreviousPosition.tail
        else withPreviousPosition
      case None =&gt; state.historicalPositions
    }
    state.copy(
      currentPosition = Some(newPosition),
      historicalPositions = newHistoricalPositions)
  case _: CoarseGrainedLocationChanged =&gt;
    // can be derived from position, so not really updating state,
    // persisted as events for aggregation
    state

}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-java/src/main/java/local/drones/Drone.java#L160-L184" target="_blank" title="Go to snippet source">source</a><code class="language-java">@Override
public EventHandler&lt;State, Event&gt; eventHandler() {
  return newEventHandlerBuilder()
      .forAnyState()
      .onEvent(
          PositionUpdated.class,
          (state, event) -&gt; {
            if (state.currentPosition.isPresent()) {
              state.historicalPositions.add(state.currentPosition.get());
              if (state.historicalPositions.size() &gt; LOCATION_HISTORY_LIMIT) {
                state.historicalPositions.remove(0);
              }
            }
            state.currentPosition = Optional.of(event.position);
            return state;
          })
      .onEvent(
          CoarseGrainedLocationChanged.class,
          (state, event) -&gt;
              // can be derived from position, so not really updating state,
              // persisted as events for aggregation
              state)
      .build();
}
</code></pre></dd>
</dl>
<h3><a href="#serialization" name="serialization" class="anchor"><span class="anchor-link"></span></a>Serialization</h3>
<p>The state and events of the entity must be serializable because they are written to the datastore, if the local drone control needs to scale out across several nodes to handle traffic, the commands would also be sent between nodes within the Akka cluster. The sample project includes built-in CBOR serialization using the <a href="https://doc.akka.io/docs/akka/2.9/serialization-jackson.html">Akka Serialization Jackson module</a>. This section describes how serialization is implemented. You do not need to do anything specific to take advantage of CBOR, but this section explains how it is included.</p>
<p>The state, commands and events are marked as <code>akka.serialization.jackson.CborSerializable</code> which is configured to use the built-in CBOR serialization.</p>
<h3><a href="#journal-storage" name="journal-storage" class="anchor"><span class="anchor-link"></span></a>Journal storage</h3>
<p>In this sample we use Akka Persistence R2DBC with the H2 in-process database, with a file backed storage. H2 requires no additional external database service so can be convenient for both development and production usage where only a single node interacts with the journal and overhead needs to be kept low. </p>
<p>It is of course also possible to instead use a separate standalone database such as for example PostgreSQL.</p>
<p>Config to use H2 looks like this:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-scala/src/main/resources/persistence-h2.conf" target="_blank" title="Go to snippet source">source</a><code class="language-conf">akka {
  persistence {
    journal {
      plugin = &quot;akka.persistence.r2dbc.journal&quot;
    }
    snapshot-store {
      plugin = &quot;akka.persistence.r2dbc.snapshot&quot;
    }
    state {
      plugin = &quot;akka.persistence.r2dbc.state&quot;
    }

    r2dbc {
      # Single projection instance, no need for many topics
      journal.publish-events-number-of-topics = 1

      connection-factory = ${akka.persistence.r2dbc.h2}
      connection-factory {
        additional-init = ${akka.projection.r2dbc.default-h2-schema}
        protocol = &quot;file&quot;
        # database name is full path to database
        # default for running from SBT but keeping state across runs
        database = &quot;./target/drone-db&quot;
        # inject a path to a persistent volume when running in a container
        database = ${?H2_DATABASE_PATH}
      }
    }
  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-java/src/main/resources/persistence-h2.conf" target="_blank" title="Go to snippet source">source</a><code class="language-conf">akka {
  persistence {
    journal {
      plugin = &quot;akka.persistence.r2dbc.journal&quot;
    }
    snapshot-store {
      plugin = &quot;akka.persistence.r2dbc.snapshot&quot;
    }
    state {
      plugin = &quot;akka.persistence.r2dbc.state&quot;
    }

    r2dbc {
      # Single projection instance, no need for many topics
      journal.publish-events-number-of-topics = 1

      connection-factory = ${akka.persistence.r2dbc.h2}
      connection-factory {
        additional-init = ${akka.projection.r2dbc.default-h2-schema}
        protocol = &quot;file&quot;
        # database name is full path to database
        # default for running from SBT but keeping state across runs
        database = &quot;./target/drone-db&quot;
        # inject a path to a persistent volume when running in a container
        database = ${?H2_DATABASE_PATH}
      }
    }
  }
}</code></pre></dd>
</dl>
<p>In addition to the configuration, the following additional dependencies are needed in the project build:</p><dl class="dependency"><dt>sbt</dt><dd><pre class="prettyprint"><code class="language-scala">libraryDependencies ++= Seq(
  "com.h2database" % "h2" % "2.1.210",
  "io.r2dbc" % "r2dbc-h2" % "1.0.0.RELEASE"
)</code></pre></dd><dt>Maven</dt><dd><pre class="prettyprint"><code class="language-xml">&lt;dependencies&gt
  &lt;dependency&gt;
    &lt;groupId&gt;com.h2database&lt;/groupId&gt;
    &lt;artifactId&gt;h2&lt;/artifactId&gt;
    &lt;version&gt;2.1.210&lt;/version&gt;
  &lt;/dependency&gt
  &lt;dependency&gt;
    &lt;groupId&gt;io.r2dbc&lt;/groupId&gt;
    &lt;artifactId&gt;r2dbc-h2&lt;/artifactId&gt;
    &lt;version&gt;1.0.0.RELEASE&lt;/version&gt;
  &lt;/dependency&gt
&lt;/dependencies&gt;</code></pre></dd><dt>Gradle</dt><dd><pre class="prettyprint"><code class="language-gradle">dependencies {
  implementation "com.h2database:h2:2.1.210"
  implementation "io.r2dbc:r2dbc-h2:1.0.0.RELEASE"
}</code></pre></dd></dl>
<h2><a href="#grpc-service-api-for-the-drone-communication" name="grpc-service-api-for-the-drone-communication" class="anchor"><span class="anchor-link"></span></a>gRPC Service API for the drone communication</h2>
<p>To allow drones to actually use the service we need a public API reachable over the network. For this we will use <a href="https://doc.akka.io/docs/akka-grpc/2.4/">Akka gRPC</a> giving us a type safe, efficient protocol that allows clients to be written in many languages.</p>
<p>The service descriptor for the API is defined in protobuf, it implements the report command that entity accepts but not one matching the get location command:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-scala/src/main/protobuf/local/drones/drone_api.proto" target="_blank" title="Go to snippet source">source</a><code class="language-proto">syntax = &quot;proto3&quot;;

option java_multiple_files = true;
option java_package = &quot;local.drones.proto&quot;;

import &quot;google/protobuf/empty.proto&quot;;
import &quot;common/coordinates.proto&quot;;

package local.drones;

// gRPC definition for DroneService, for drones to interact with

service DroneService {
    rpc ReportLocation (ReportLocationRequest) returns (google.protobuf.Empty) {}

    // deliveries
    rpc RequestNextDelivery (RequestNextDeliveryRequest) returns (RequestNextDeliveryResponse) {}
    rpc CompleteDelivery (CompleteDeliveryRequest) returns (google.protobuf.Empty) {}
}


message ReportLocationRequest {
    string drone_id = 1;
    common.Coordinates coordinates = 2;
    // altitude in meters
    double altitude = 4;
}

message RequestNextDeliveryRequest {
    string drone_id = 1;
}

message RequestNextDeliveryResponse {
    string delivery_id = 1;
    common.Coordinates from = 2;
    common.Coordinates to = 3;
}

message CompleteDeliveryRequest {
    string delivery_id = 1;
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-java/src/main/protobuf/local/drones/drone_api.proto" target="_blank" title="Go to snippet source">source</a><code class="language-proto">syntax = &quot;proto3&quot;;

option java_multiple_files = true;
option java_package = &quot;local.drones.proto&quot;;

import &quot;common/coordinates.proto&quot;;

package local.drones;

// gRPC definition for DroneService, for drones to interact with

service DroneService {
    rpc ReportLocation (ReportLocationRequest) returns (ReportLocationResponse) {}

    // deliveries
    rpc RequestNextDelivery (RequestNextDeliveryRequest) returns (RequestNextDeliveryResponse) {}
    rpc CompleteDelivery (CompleteDeliveryRequest) returns (CompleteDeliveryResponse) {}
}


message ReportLocationRequest {
    string drone_id = 1;
    common.Coordinates coordinates = 2;
    // altitude in meters
    double altitude = 4;
}

message ReportLocationResponse {
}

message RequestNextDeliveryRequest {
    string drone_id = 1;
}

message RequestNextDeliveryResponse {
    string delivery_id = 1;
    common.Coordinates from = 2;
    common.Coordinates to = 3;
}

message CompleteDeliveryRequest {
    string delivery_id = 1;
}

message CompleteDeliveryResponse {
}</code></pre></dd>
</dl>
<p>When compiling the project the Akka gRPC <span class="group-scala">sbt</span><span class="group-java">maven</span> plugin generates a service interface for us to implement. Our implementation of it interacts with the entity:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-scala/src/main/scala/local/drones/DroneServiceImpl.scala" target="_blank" title="Go to snippet source">source</a><code class="language-scala">package local.drones

import akka.Done
import akka.actor.typed.scaladsl.AskPattern._
import akka.actor.typed.{ ActorRef, ActorSystem }
import akka.cluster.sharding.typed.scaladsl.ClusterSharding
import akka.grpc.GrpcServiceException
import akka.util.Timeout
import com.google.protobuf.empty.Empty
import io.grpc.Status
import org.slf4j.LoggerFactory
import local.drones.proto

import scala.concurrent.Future
import scala.concurrent.TimeoutException

class DroneServiceImpl(
    deliveriesQueue: ActorRef[DeliveriesQueue.Command],
    settings: Settings)(implicit system: ActorSystem[_])
    extends proto.DroneService {

  import system.executionContext

  private val logger = LoggerFactory.getLogger(getClass)

  implicit private val timeout: Timeout = settings.askTimeout

  private val sharding = ClusterSharding(system)

  override def reportLocation(
      in: proto.ReportLocationRequest): Future[Empty] = {
    val coordinates = in.coordinates.getOrElse {
      throw new GrpcServiceException(
        Status.INVALID_ARGUMENT.withDescription(
          &quot;coordinates are required but missing&quot;))
    }
    logger.info(
      &quot;Report location ({},{},{}) for drone {}&quot;,
      coordinates.latitude,
      coordinates.longitude,
      in.altitude,
      in.droneId)
    val entityRef = sharding.entityRefFor(Drone.EntityKey, in.droneId)
    val reply: Future[Done] = entityRef.ask(
      Drone.ReportPosition(
        Position(Coordinates.fromProto(coordinates), in.altitude),
        _))
    val response = reply.map(_ =&gt; Empty.defaultInstance)
    convertError(response)
  }

  // #requestNextDelivery
  override def requestNextDelivery(in: proto.RequestNextDeliveryRequest)
      : Future[proto.RequestNextDeliveryResponse] = {
    logger.info(&quot;Drone {} requesting next delivery&quot;, in.droneId)

    // get location for drone
    val entityRef = sharding.entityRefFor(Drone.EntityKey, in.droneId)

    // ask for closest delivery
    val response = for {
      position &lt;- entityRef.askWithStatus[Position](Drone.GetCurrentPosition(_))
      chosenDelivery &lt;- deliveriesQueue
        .askWithStatus[DeliveriesQueue.WaitingDelivery](
          DeliveriesQueue.RequestDelivery(in.droneId, position.coordinates, _))
    } yield {
      proto.RequestNextDeliveryResponse(
        deliveryId = chosenDelivery.deliveryId,
        from = Some(chosenDelivery.from.toProto),
        to = Some(chosenDelivery.to.toProto))
    }

    convertError(response)
  }
  // #requestNextDelivery
  override def completeDelivery(
      in: proto.CompleteDeliveryRequest): Future[Empty] = {
    logger.info(&quot;Delivery {} completed&quot;, in.deliveryId)

    deliveriesQueue
      .askWithStatus[Done](DeliveriesQueue.CompleteDelivery(in.deliveryId, _))
      .map(_ =&gt; Empty.defaultInstance)
  }

  private def convertError[T](response: Future[T]): Future[T] = {
    response.recoverWith {
      case _: TimeoutException =&gt;
        Future.failed(
          new GrpcServiceException(
            Status.UNAVAILABLE.withDescription(&quot;Operation timed out&quot;)))
      case exc =&gt;
        Future.failed(
          new GrpcServiceException(
            Status.INTERNAL.withDescription(exc.getMessage)))
    }
  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-java/src/main/java/local/drones/DroneServiceImpl.java" target="_blank" title="Go to snippet source">source</a><code class="language-java">package local.drones;

import static akka.actor.typed.javadsl.AskPattern.*;

import akka.Done;
import akka.actor.typed.ActorRef;
import akka.actor.typed.ActorSystem;
import akka.cluster.sharding.typed.javadsl.ClusterSharding;
import akka.grpc.GrpcServiceException;
import akka.pattern.StatusReply;
import io.grpc.Status;
import java.util.concurrent.CompletionStage;
import java.util.concurrent.TimeoutException;
import local.drones.proto.*;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class DroneServiceImpl implements DroneService {

  private static final Logger logger = LoggerFactory.getLogger(DroneServiceImpl.class);

  private final ActorRef&lt;DeliveriesQueue.Command&gt; deliveriesQueue;
  private final Settings settings;
  private final ActorSystem&lt;?&gt; system;

  private final ClusterSharding sharding;

  public DroneServiceImpl(
      ActorSystem&lt;?&gt; system, ActorRef&lt;DeliveriesQueue.Command&gt; deliveriesQueue, Settings settings) {
    this.system = system;
    this.deliveriesQueue = deliveriesQueue;
    this.settings = settings;
    this.sharding = ClusterSharding.get(system);
  }

  @Override
  public CompletionStage&lt;ReportLocationResponse&gt; reportLocation(ReportLocationRequest in) {
    var coordinates = in.getCoordinates();
    if (coordinates == null) {
      throw new GrpcServiceException(
          Status.INVALID_ARGUMENT.withDescription(&quot;coordinates are required but missing&quot;));
    }
    logger.info(
        &quot;Report location ({},{},{}) for drone {}&quot;,
        coordinates.getLatitude(),
        coordinates.getLongitude(),
        in.getAltitude(),
        in.getDroneId());
    var entityRef = sharding.entityRefFor(Drone.ENTITY_KEY, in.getDroneId());
    CompletionStage&lt;Done&gt; reply =
        entityRef.ask(
            replyTo -&gt;
                new Drone.ReportPosition(
                    new Position(Coordinates.fromProto(coordinates), in.getAltitude()), replyTo),
            settings.askTimeout);
    var response = reply.thenApply(done -&gt; ReportLocationResponse.getDefaultInstance());
    return convertError(response);
  }

  // #requestNextDelivery
  @Override
  public CompletionStage&lt;RequestNextDeliveryResponse&gt; requestNextDelivery(
      RequestNextDeliveryRequest in) {
    logger.info(&quot;Drone {} requesting next delivery&quot;, in.getDroneId());

    // get location for drone
    var entityRef = sharding.entityRefFor(Drone.ENTITY_KEY, in.getDroneId());
    var positionReply =
        entityRef.askWithStatus(
            (ActorRef&lt;StatusReply&lt;Position&gt;&gt; replyTo) -&gt; new Drone.GetCurrentPosition(replyTo),
            settings.askTimeout);

    // ask for closest delivery
    CompletionStage&lt;DeliveriesQueue.WaitingDelivery&gt; chosenDeliveryReply =
        positionReply.thenCompose(
            position -&gt;
                askWithStatus(
                    deliveriesQueue,
                    replyTo -&gt;
                        new DeliveriesQueue.RequestDelivery(
                            in.getDroneId(), position.coordinates, replyTo),
                    settings.askTimeout,
                    system.scheduler()));

    var response =
        chosenDeliveryReply.thenApply(
            chosenDelivery -&gt;
                RequestNextDeliveryResponse.newBuilder()
                    .setDeliveryId(chosenDelivery.deliveryId)
                    .setFrom(chosenDelivery.from.toProto())
                    .setTo(chosenDelivery.to.toProto())
                    .build());

    return convertError(response);
  }

  // #requestNextDelivery
  @Override
  public CompletionStage&lt;CompleteDeliveryResponse&gt; completeDelivery(CompleteDeliveryRequest in) {
    logger.info(&quot;Delivery {} completed&quot;, in.getDeliveryId());

    CompletionStage&lt;Done&gt; completeReply =
        askWithStatus(
            deliveriesQueue,
            replyTo -&gt; new DeliveriesQueue.CompleteDelivery(in.getDeliveryId(), replyTo),
            settings.askTimeout,
            system.scheduler());

    var reply = completeReply.thenApply(done -&gt; CompleteDeliveryResponse.getDefaultInstance());

    return convertError(reply);
  }

  private &lt;T&gt; CompletionStage&lt;T&gt; convertError(CompletionStage&lt;T&gt; response) {
    return response.exceptionally(
        error -&gt; {
          if (error instanceof TimeoutException) {
            throw new GrpcServiceException(
                Status.UNAVAILABLE.withDescription(&quot;Operation timed out&quot;));
          } else {
            throw new GrpcServiceException(Status.INTERNAL.withDescription(error.getMessage()));
          }
        });
  }
}</code></pre></dd>
</dl>
<p>Finally, we need to start the gRPC server, making service implementation available for calls from drones:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-scala/src/main/scala/local/drones/LocalDroneControlServer.scala#L18-L53" target="_blank" title="Go to snippet source">source</a><code class="language-scala">def start(
    interface: String,
    port: Int,
    system: ActorSystem[_],
    droneService: proto.DroneService,
    deliveriesQueueService: proto.DeliveriesQueueService): Unit = {
  implicit val sys: ActorSystem[_] = system
  implicit val ec: ExecutionContext =
    system.executionContext

  val service: HttpRequest =&gt; Future[HttpResponse] =
    ServiceHandler.concatOrNotFound(
      proto.DroneServiceHandler.partial(droneService),
      proto.DeliveriesQueueServiceHandler.partial(deliveriesQueueService),
      // ServerReflection enabled to support grpcurl without import-path and proto parameters
      ServerReflection.partial(
        List(proto.DroneService, proto.DeliveriesQueueService)))

  val bound =
    Http()
      .newServerAt(interface, port)
      .bind(service)
      .map(_.addToCoordinatedShutdown(3.seconds))

  bound.onComplete {
    case Success(binding) =&gt;
      val address = binding.localAddress
      system.log.info(
        &quot;Drone control gRPC server started {}:{}&quot;,
        address.getHostString,
        address.getPort)
    case Failure(ex) =&gt;
      system.log.error(&quot;Failed to bind gRPC endpoint, terminating system&quot;, ex)
      system.terminate()
  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-java/src/main/java/local/drones/LocalDroneControlServer.java#L17-L50" target="_blank" title="Go to snippet source">source</a><code class="language-java">public static void start(
    String host,
    int port,
    ActorSystem&lt;?&gt; system,
    DroneService droneService,
    DeliveriesQueueService deliveriesQueueService) {
  var service =
      ServiceHandler.concatOrNotFound(
          DroneServiceHandlerFactory.create(droneService, system),
          DeliveriesQueueServiceHandlerFactory.create(deliveriesQueueService, system),
          // ServerReflection enabled to support grpcurl without import-path and proto parameters
          ServerReflection.create(
              Arrays.asList(DroneService.description, DeliveriesQueueService.description),
              system));

  var bound = Http.get(system).newServerAt(host, port).bind(service);

  bound.whenComplete(
      (binding, error) -&gt; {
        if (error == null) {
          binding.addToCoordinatedShutdown(Duration.ofSeconds(3), system);
          var address = binding.localAddress();
          system
              .log()
              .info(
                  &quot;Drone control gRPC server started {}:{}&quot;,
                  address.getHostString(),
                  address.getPort());
        } else {
          system.log().error(&quot;Failed to bind gRPC endpoint, terminating system&quot;, error);
          system.terminate();
        }
      });
}</code></pre></dd>
</dl>
<p>The Akka HTTP server must be running with HTTP/2 to serve gRPC, this is done through config:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-scala/src/main/resources/grpc.conf#L2" target="_blank" title="Go to snippet source">source</a><code class="language-conf">akka.http.server.enable-http2 = on</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-java/src/main/resources/grpc.conf#L2" target="_blank" title="Go to snippet source">source</a><code class="language-conf">akka.http.server.enable-http2 = on</code></pre></dd>
</dl>
<h2><a href="#wiring-it-all-up" name="wiring-it-all-up" class="anchor"><span class="anchor-link"></span></a>Wiring it all up</h2>
<p>The main of this service starts up an actor system with a root behavior which is responsible for bootstrapping all parts of the application. </p>
<p>Note that the bootstrap contains some parts not yet described, the <code>DroneEvents</code> and the <code>DeliveriesQueue</code>. They will be covered in the following sections of this guide and can be ignored for now. </p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-scala/src/main/scala/local/drones/Main.scala#L11-L57" target="_blank" title="Go to snippet source">source</a><code class="language-scala">def main(args: Array[String]): Unit = {
  ActorSystem[Nothing](rootBehavior(), &quot;local-drone-control&quot;)
}

private def rootBehavior(): Behavior[Nothing] = Behaviors.setup[Nothing] {
  context =&gt;
    val settings = Settings(context.system)

    context.log
      .info(&quot;Local Drone Control [{}] starting up&quot;, settings.locationId)

    // A single node, but still a cluster, to be able to run sharding for the entities
    val cluster = Cluster(context.system)
    cluster.manager ! Join(cluster.selfMember.address)

    // keep track of local drones, project aggregate info to the cloud
    Drone.init(context.system)
    context.spawn(
      DroneEvents.eventToCloudPushBehavior(settings)(context.system),
      &quot;DroneEventsProjection&quot;)

    // consume delivery events from the cloud service
    val deliveriesQueue = context.spawn(DeliveriesQueue(), &quot;DeliveriesQueue&quot;)
    context.spawn(
      DeliveryEvents.projectionBehavior(deliveriesQueue, settings)(
        context.system),
      &quot;DeliveriesProjection&quot;)
    val deliveriesQueueService =
      new DeliveriesQueueServiceImpl(settings, deliveriesQueue)(
        context.system)

    val grpcInterface =
      context.system.settings.config
        .getString(&quot;local-drone-control.grpc.interface&quot;)
    val grpcPort =
      context.system.settings.config.getInt(&quot;local-drone-control.grpc.port&quot;)
    val droneService =
      new DroneServiceImpl(deliveriesQueue, settings)(context.system)
    LocalDroneControlServer.start(
      grpcInterface,
      grpcPort,
      context.system,
      droneService,
      deliveriesQueueService)

    Behaviors.empty
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-java/src/main/java/local/drones/Main.java#L13-L57" target="_blank" title="Go to snippet source">source</a><code class="language-java">public static void main(String[] args) {
  ActorSystem.create(rootBehavior(), &quot;local-drone-control&quot;);
}

private static Behavior&lt;Void&gt; rootBehavior() {
  return Behaviors.setup(
      (ActorContext&lt;Void&gt; context) -&gt; {
        var settings = Settings.create(context.getSystem());

        context.getLog().info(&quot;Local Drone Control [{}] starting up&quot;, settings.locationId);

        // A single node, but still a cluster, to be able to run sharding for the entities
        var cluster = Cluster.get(context.getSystem());
        cluster.manager().tell(new Join(cluster.selfMember().address()));

        // keep track of local drones, project aggregate info to the cloud
        Drone.init(context.getSystem());
        context.spawn(
            DroneEvents.eventToCloudPushBehavior(context.getSystem(), settings),
            &quot;DroneEventsProjection&quot;);

        // consume delivery events from the cloud service
        var deliveriesQueue = context.spawn(DeliveriesQueue.create(), &quot;DeliveriesQueue&quot;);
        context.spawn(
            DeliveryEvents.projectionBehavior(context.getSystem(), deliveriesQueue, settings),
            &quot;DeliveriesProjection&quot;);
        var deliveriesQueueService =
            new DeliveriesQueueServiceImpl(context.getSystem(), settings, deliveriesQueue);
        var droneService = new DroneServiceImpl(context.getSystem(), deliveriesQueue, settings);

        var grpcInterface =
            context
                .getSystem()
                .settings()
                .config()
                .getString(&quot;local-drone-control.grpc.interface&quot;);
        var grpcPort =
            context.getSystem().settings().config().getInt(&quot;local-drone-control.grpc.port&quot;);

        LocalDroneControlServer.start(
            grpcInterface, grpcPort, context.getSystem(), droneService, deliveriesQueueService);

        return Behaviors.empty();
      });
}</code></pre></dd>
</dl>
<h2><a href="#running-the-sample" name="running-the-sample" class="anchor"><span class="anchor-link"></span></a>Running the sample</h2>
<p>The complete sample can be downloaded from GitHub, but note that it also includes the next steps of the guide:</p>
<ul>
  <li>Java: <a href="https://github.com/akka/akka-projection/tree/main/samples/grpc/local-drone-control-service-java">https://github.com/akka/akka-projection/tree/main/samples/grpc/local-drone-control-service-java</a></li>
  <li>Scala: <a href="https://github.com/akka/akka-projection/tree/main/samples/grpc/local-drone-control-service-scala">https://github.com/akka/akka-projection/tree/main/samples/grpc/local-drone-control-service-scala</a></li>
</ul><div class="group-scala">
<p>To start the sample:</p>
<pre class="prettyprint"><code class="language-shell">sbt run
</code></pre></div><div class="group-java">
<pre class="prettyprint"><code class="language-shell">mvn compile exec:exec
</code></pre></div>
<p>Try it with <a href="https://github.com/fullstorydev/grpcurl">grpcurl</a>:</p>
<pre class="prettyprint"><code class="language-shell ">grpgrpcurl -d &#39;{&quot;drone_id&quot;:&quot;drone1&quot;, &quot;coordinates&quot;: {&quot;longitude&quot;: 18.07125, &quot;latitude&quot;: 59.31834}, &quot;altitude&quot;: 5}&#39; -plaintext 127.0.0.1:8080 local.drones.DroneService.ReportLocation
</code></pre>
<h2><a href="#whats-next-" name="whats-next-" class="anchor"><span class="anchor-link"></span></a>What&rsquo;s next?</h2>
<ul>
  <li>Consuming the published coarse grained drone locations in a cloud service</li>
</ul>
</div>
</article>
<div class="row">
<div class="small-12 column">
<section class="nav-prev-next row">
<div class="nav-prev small-6 column">
<a href="../guide.html"><i class="icon-prev"></i> <span class="link-prev">Guide</span></a>
</div>
<div class="nav-next small-6 column clearfix">
<a class="float-right" href="../guide/2-drone-location-to-cloud-service.html">Coarse Grained Location Replication <i class="icon-next"></i></a>
</div>
</section>
</div>
</div>
<div class="source-github row">
Found an error in this documentation? The source code for this page can be found <a href="https://github.com/akka/akka-projection/tree/master/akka-edge-docs/src/main/paradox/guide/1-local-drone-control-service.md">here</a>.
Please feel free to edit and contribute a pull request.
</div>

<footer class="page-footer row clearfix">
<img class="akka-icon float-left show-for-medium" src="../images/akka-icon.svg" />
<section class="copyright">
<div>Akka Edge is available under the <a href="https://www.lightbend.com/akka/license" target="_blank">Business Source License 1.1</a>.</div>
<p class="legal">
&copy; 2011-2023 <a href="https://www.lightbend.com" target="_blank">Lightbend, Inc.</a> |
<a href="https://www.lightbend.com/legal/licenses" target="_blank">Licenses</a> |
<a href="https://www.lightbend.com/legal/terms" target="_blank">Terms</a> |
<a href="https://www.lightbend.com/legal/privacy" target="_blank">Privacy Policy</a> |
<a href="https://akka.io/cookie/" target="_blank">Cookie Listing</a> |
<a class="optanon-toggle-display">Cookie Settings</a>
</p>
</section>

</footer>
</section>
</main>
</div>

<script type="text/javascript" src="../js/scrollsneak.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../js/groups.js"></script>
<script type="text/javascript" src="../js/page.js"></script>
<script type="text/javascript" src="../js/snippets.js"></script>
<script type="text/javascript" src="../js/magellan.js"></script>
<script type="text/javascript" src="../js/metadata-toggle.js"></script>
<script type="text/javascript" src="../js/lbHeader.js"></script>

<style type="text/css">@import "../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(){window.prettyPrint && prettyPrint()});
//]]></script>
<!-- hook for including project specific javascript into the generated docs -->

</body>
</html>
