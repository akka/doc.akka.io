<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Consuming registration events &bull; Akka Edge</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="Akka Projection."/>
<link rel="canonical" href="https://doc.akka.io/docs/akka-edge/current/guide-rs/4-registration-projection.html"/>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../lib/foundation/dist/js/foundation.min.js"></script>
<link rel="stylesheet" type="text/css" href="../lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="../lib/foundation/dist/css/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" type="text/css" href="../css/icons.css"/>
<link rel="stylesheet" type="text/css" href="../css/page-8.css"/>
<link rel="stylesheet" type="text/css" href="../css/banner-2.css"/>
<link rel="shortcut icon" href="../images/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="../images/apple-touch-icon.png"/>
<link rel="icon" type="image/png" sizes="32x32" href="../images/favicon-32x32.png"/>
<link rel="icon" type="image/png" sizes="16x16" href="../images/favicon-16x16.png"/>
<link rel="manifest" href="../images/manifest.json"/>
<meta name="msapplication-TileImage" content="../images/mstile-150x150.png"/>
<meta name="msapplication-TileColor" content="#15a9ce"/>
<meta name="theme-color" content="#15a9ce"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) start -->
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js"  type="text/javascript" charset="UTF-8" data-domain-script="28b912e7-09e9-43d5-91e4-3d1897044004" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) end -->
<!-- Google Tag Manager now loads Google Analytics and any other tracking scripts. GTM also performs respects a users cookie choices-->
<script type="text/javascript">
(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KBJGH35');
</script>

</head>

<body id="underlay" data-toggler="nav-open">
<div id="lightbend-banner" class="lightbend-banner akka full-width" data-category="OSS Lightbend Banner Impression" data-label="Akka Banner Impression">
<div class="oss-wrapper">
<div class="oss-brand">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lightbend Logo - Akka Banner" href="https://www.lightbend.com">
<img class="lightbend-logo" src="../images/banner-logos/lightbend-reverse.svg" alt="Lightbend" title="Lightbend">
</a>
</div>
<div class="oss-ad no-drop-down">
<nav id="lightbendRotator" class="lightbend-rotator">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Promo Rotator - Introducing Akka Cloud to Edge Continuum. Build once for the Cloud. Seamlessly deploy to the Edge. [Learn more] - Akka Banner" href="https://www.lightbend.com/blog/akka-edge-unifying-the-cloud-and-edge">
Introducing Akka Cloud to Edge Continuum. Build once for the Cloud. Seamlessly deploy to the Edge. <span class="akka-btn">Learn more</span>
</a>
</nav>
</div>
</div>
</div>

<header class="site-header hide-for-large">
<div class="sticky-header clearfix">
<a href="https://akka.io"><img class="logo" src="../images/akka-logo-reverse.svg"/></a>

<button class="menu-icon float-right" type="button" data-toggle="underlay overlay"></button>
</div>
<div id="overlay" class="overlay-nav" data-toggler="nav-open">
<header class="nav-header">
<div class="nav-header-title">
<h1><a href="../index.html">Akka Edge</a></h1>
</div>
<div class="nav-header-version">
Version 1.5.2
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="nav-toc">
<ul>
  <li><a href="../overview.html" class="page">Architectural Overview</a></li>
  <li><a href="../use-cases.html" class="page">Example Use Cases</a></li>
  <li><a href="../feature-summary.html" class="page">Feature Summary</a></li>
  <li><a href="../guide.html" class="page">Guide - Java/Scala</a></li>
  <li><a href="../guide-rs.html" class="page">Guide - Rust</a>
  <ul>
    <li><a href="../guide-rs/1-setup.html" class="page">Getting started</a></li>
    <li><a href="../guide-rs/2-running.html" class="page">Running the sample</a></li>
    <li><a href="../guide-rs/3-temperature-entity.html" class="page">The temperature entity</a></li>
    <li><a href="../guide-rs/4-registration-projection.html#consuming-registration-events" class="active page">Consuming registration events</a>
    <ul>
      <li><a href="../guide-rs/4-registration-projection.html#the-offset-store" class="header">The offset store</a></li>
      <li><a href="../guide-rs/4-registration-projection.html#the-grpc-source-provider" class="header">The gRPC source provider</a></li>
      <li><a href="../guide-rs/4-registration-projection.html#the-handler" class="header">The handler</a></li>
      <li><a href="../guide-rs/4-registration-projection.html#run-the-projection" class="header">Run the projection</a></li>
      <li><a href="../guide-rs/4-registration-projection.html#putting-it-all-together" class="header">Putting it all together</a></li>
      <li><a href="../guide-rs/4-registration-projection.html#whats-next-" class="header">What&rsquo;s next?</a></li>
    </ul></li>
    <li><a href="../guide-rs/5-temperature-production.html" class="page">Producing temperature events</a></li>
    <li><a href="../guide-rs/6-temperature-production-http.html" class="page">HTTP temperature events</a></li>
    <li><a href="../guide-rs/7-udp-consumption.html" class="page">UDP observations</a></li>
    <li><a href="../guide-rs/8-main.html" class="page">The main function</a></li>
  </ul></li>
  <li><a href="../lightweight-deployments.html" class="page">Lightweight deployments</a></li>
</ul>
</nav>
</div>
</header>
<div class="site-content-wrapper">
<aside class="sticky-sidebar show-for-large">
<header class="nav-header sticky-sidebar-header">
<div class="nav-header-title">
<h1><a href="../index.html">Akka Edge</a></h1>
</div>
<div class="nav-header-version">
Version 1.5.2
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="site-nav sticky-sidebar-contents">
<div class="nav-toc">
<ul>
  <li><a href="../overview.html" class="page">Architectural Overview</a></li>
  <li><a href="../use-cases.html" class="page">Example Use Cases</a></li>
  <li><a href="../feature-summary.html" class="page">Feature Summary</a></li>
  <li><a href="../guide.html" class="page">Guide - Java/Scala</a></li>
  <li><a href="../guide-rs.html" class="page">Guide - Rust</a>
  <ul>
    <li><a href="../guide-rs/1-setup.html" class="page">Getting started</a></li>
    <li><a href="../guide-rs/2-running.html" class="page">Running the sample</a></li>
    <li><a href="../guide-rs/3-temperature-entity.html" class="page">The temperature entity</a></li>
    <li><a href="../guide-rs/4-registration-projection.html#consuming-registration-events" class="active page">Consuming registration events</a>
    <ul>
      <li><a href="../guide-rs/4-registration-projection.html#the-offset-store" class="header">The offset store</a></li>
      <li><a href="../guide-rs/4-registration-projection.html#the-grpc-source-provider" class="header">The gRPC source provider</a></li>
      <li><a href="../guide-rs/4-registration-projection.html#the-handler" class="header">The handler</a></li>
      <li><a href="../guide-rs/4-registration-projection.html#run-the-projection" class="header">Run the projection</a></li>
      <li><a href="../guide-rs/4-registration-projection.html#putting-it-all-together" class="header">Putting it all together</a></li>
      <li><a href="../guide-rs/4-registration-projection.html#whats-next-" class="header">What&rsquo;s next?</a></li>
    </ul></li>
    <li><a href="../guide-rs/5-temperature-production.html" class="page">Producing temperature events</a></li>
    <li><a href="../guide-rs/6-temperature-production-http.html" class="page">HTTP temperature events</a></li>
    <li><a href="../guide-rs/7-udp-consumption.html" class="page">UDP observations</a></li>
    <li><a href="../guide-rs/8-main.html" class="page">The main function</a></li>
  </ul></li>
  <li><a href="../lightweight-deployments.html" class="page">Lightweight deployments</a></li>
</ul>
</div>
</nav>
<footer class="nav-footer sticky-sidebar-footer">
<a href="https://akka.io"><img class="logo" src="../images/akka-logo-reverse.svg"/></a>

</footer>
</aside>
<main class="fixed-shift-for-large expanded row">
<section class="site-content small-12 column">
<article class="page-content row">
<div class="small-12 column" id="docs">
<h1><a href="#consuming-registration-events" name="consuming-registration-events" class="anchor"><span class="anchor-link"></span></a>Consuming registration events</h1>
<p>Before a temperature entity is able to be queried for its state, or observations can be posted to it, the fictitious temperature sensor must be registered as described previously in <a href="2-running.html">&ldquo;Running the sample&rdquo;</a>.</p>
<p>The following section describes connecting to a remote producer of registration events, and forwarding them as registration commands to our temperature entity. The offset of this consumer is saved so that our service may start near where it left off in the case of being restarted.</p><div class="callout note "><div class="callout-title">Note</div>
<p>We use the term &ldquo;near&rdquo; here deliberately as the guarantees are &ldquo;at least once&rdquo; and the last offset processed may not have been saved - although it mostly will have been.</p></div>
<h2><a href="#the-offset-store" name="the-offset-store" class="anchor"><span class="anchor-link"></span></a>The offset store</h2>
<p>When consuming events from a remote producer, we must keep track of the offset we have processed. This is so that we can resume near where we left off in the case of a restart. An offset store is used for this purpose, and we will also use one when consuming from the <code>GrpcSourceProvider</code>, discussed in the next section.</p>
<dl>
  <dt>Rust</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/iot-service-rs/backend/src/registration_projection.rs#L28-L32" target="_blank" title="Go to snippet source">source</a><code class="language-rs">let stream_id = StreamId::from(&quot;registration-events&quot;);

let offset_store_id = stream_id.clone();
let offset_store =
    offset_store::task(commit_log, EXPECTED_DISTINCT_REGISTRATIONS, offset_store_id);</code></pre></dd>
</dl>
<p>We also declare the commit log to use and the expected number of distinct device registrations. The number of device registrations is used to determine how many entity id offsets are held in memory at any one time. Each offset store must also have a distinct identity also, hence the <code>offset-store-id</code>.</p>
<h2><a href="#the-grpc-source-provider" name="the-grpc-source-provider" class="anchor"><span class="anchor-link"></span></a>The gRPC source provider</h2>
<p>We use a gRPC source provider to source events from a remote producer. The remote endpoint is declared as a function that establishes a gRPC connection. This function can be enhanced to establish the connection flexibly e.g. we can establish a TLS-based connection or even a Unix Domain Socket based connection if desired.</p>
<dl>
  <dt>Rust</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/iot-service-rs/backend/src/registration_projection.rs#L36-L42" target="_blank" title="Go to snippet source">source</a><code class="language-rs">let source_provider = GrpcSourceProvider::new(
    move || {
        let event_producer = Channel::builder(event_producer_addr.clone());
        async move { event_producer.connect().await }
    },
    stream_id,
);</code></pre></dd>
</dl>
<p>The gRPC source provider will manage the remote connection, including exponential backoff and retries in the case of failure.</p>
<h2><a href="#the-handler" name="the-handler" class="anchor"><span class="anchor-link"></span></a>The handler</h2>
<p>Receiving events from a remote producer means little if we don&rsquo;t do anything with them. To this end, we declare a handler to forward these events on to the temperature entity via its entity manager&rsquo;s message channel for commands.</p>
<dl>
  <dt>Rust</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/iot-service-rs/backend/src/registration_projection.rs#L46-L76" target="_blank" title="Go to snippet source">source</a><code class="language-rs">let handler = move |envelope: EventEnvelope&lt;registration::Registered&gt;| {
    let temperature = temperature.clone();
    async move {
        let (entity_id, secret) = {
            let secret = {
                let registration::Registered {
                    secret: Some(secret),
                    ..
                } = envelope.event
                else {
                    return Ok(());
                };
                secret.value.into()
            };
            (envelope.persistence_id.entity_id, secret)
        };

        temperature
            .send(Message::new(
                entity_id,
                temperature::Command::Register { secret },
            ))
            .await
            .map(|_| ())
            .map_err(|_| HandlerError)
    }
};</code></pre></dd>
</dl>
<p>Note that we are only interested in <code>Registered</code> events. If our remote producer was capable of producing other types of events then these would be filtered out.</p><div class="callout note "><div class="callout-title">Note</div>
<p>We can also declare a &ldquo;consumer filter&rdquo; on the <code>GrpcSourceProvider</code> so that the producer avoids transmitting events that we do not wish to consume. This is a great way to save on network bandwidth; an important concern when dealing with the edge, particularly with wireless communications.</p></div>
<h2><a href="#run-the-projection" name="run-the-projection" class="anchor"><span class="anchor-link"></span></a>Run the projection</h2>
<p>We are now in a position to start up a projection that will use the offset store to remember the offset consumed, and invoke the handler for each remote event received:</p>
<dl>
  <dt>Rust</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/iot-service-rs/backend/src/registration_projection.rs#L80-L82" target="_blank" title="Go to snippet source">source</a><code class="language-rs">let (consumer_task, consumer_kill_switch) =
    consumer::task(offset_store, source_provider, handler);
tokio::spawn(consumer_task);</code></pre></dd>
</dl>
<p>A kill switch is also provided so that its task may be terminated from elsewhere.</p>
<h2><a href="#putting-it-all-together" name="putting-it-all-together" class="anchor"><span class="anchor-link"></span></a>Putting it all together</h2>
<p>The following code represents putting all of the above together as a task that can be spawned:</p>
<dl>
  <dt>Rust</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/iot-service-rs/backend/src/registration_projection.rs#L17-L87" target="_blank" title="Go to snippet source">source</a><code class="language-rs"><br/>const EXPECTED_DISTINCT_REGISTRATIONS: usize = 1000;

// Apply sensor registrations to the temperature sensor entity.

pub fn spawn(
    commit_log: FileLog,
    event_producer_addr: Uri,
    temperature: mpsc::Sender&lt;Message&lt;temperature::Command&gt;&gt;,
) -&gt; oneshot::Sender&lt;()&gt; {
    let stream_id = StreamId::from(&quot;registration-events&quot;);

    let offset_store_id = stream_id.clone();
    let offset_store =
        offset_store::task(commit_log, EXPECTED_DISTINCT_REGISTRATIONS, offset_store_id);

    let source_provider = GrpcSourceProvider::new(
        move || {
            let event_producer = Channel::builder(event_producer_addr.clone());
            async move { event_producer.connect().await }
        },
        stream_id,
    );

    let handler = move |envelope: EventEnvelope&lt;registration::Registered&gt;| {
        let temperature = temperature.clone();
        async move {
            let (entity_id, secret) = {
                let secret = {
                    let registration::Registered {
                        secret: Some(secret),
                        ..
                    } = envelope.event
                    else {
                        return Ok(());
                    };
                    secret.value.into()
                };
                (envelope.persistence_id.entity_id, secret)
            };

            info!(&quot;Consuming {entity_id}&quot;);

            temperature
                .send(Message::new(
                    entity_id,
                    temperature::Command::Register { secret },
                ))
                .await
                .map(|_| ())
                .map_err(|_| HandlerError)
        }
    };

    let (consumer_task, consumer_kill_switch) =
        consumer::task(offset_store, source_provider, handler);
    tokio::spawn(consumer_task);

    consumer_kill_switch
}
</code></pre></dd>
</dl>
<h2><a href="#whats-next-" name="whats-next-" class="anchor"><span class="anchor-link"></span></a>What&rsquo;s next?</h2>
<ul>
  <li>Producing temperature events</li>
</ul>
</div>
</article>
<div class="row">
<div class="small-12 column">
<section class="nav-prev-next row">
<div class="nav-prev small-6 column">
<a href="../guide-rs/3-temperature-entity.html"><i class="icon-prev"></i> <span class="link-prev">The temperature entity</span></a>
</div>
<div class="nav-next small-6 column clearfix">
<a class="float-right" href="../guide-rs/5-temperature-production.html">Producing temperature events <i class="icon-next"></i></a>
</div>
</section>
</div>
</div>
<div class="source-github row">
Found an error in this documentation? The source code for this page can be found <a href="https://github.com/akka/akka-projection/tree/master/akka-edge-docs/src/main/paradox/guide-rs/4-registration-projection.md">here</a>.
Please feel free to edit and contribute a pull request.
</div>

<footer class="page-footer row clearfix">
<img class="akka-icon float-left show-for-medium" src="../images/akka-icon.svg" />
<section class="copyright">
<div>Akka Edge is available under the <a href="https://www.lightbend.com/akka/license" target="_blank">Business Source License 1.1</a>.</div>
<p class="legal">
&copy; 2011-2024 <a href="https://www.lightbend.com" target="_blank">Lightbend, Inc.</a> |
<a href="https://www.lightbend.com/legal/licenses" target="_blank">Licenses</a> |
<a href="https://www.lightbend.com/legal/terms" target="_blank">Terms</a> |
<a href="https://www.lightbend.com/legal/privacy" target="_blank">Privacy Policy</a> |
<a href="https://akka.io/cookie/" target="_blank">Cookie Listing</a> |
<a class="optanon-toggle-display">Cookie Settings</a>
</p>
</section>

</footer>
</section>
</main>
</div>

<script type="text/javascript" src="../js/scrollsneak.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../js/groups.js"></script>
<script type="text/javascript" src="../js/page.js"></script>
<script type="text/javascript" src="../js/snippets.js"></script>
<script type="text/javascript" src="../js/magellan.js"></script>
<script type="text/javascript" src="../js/metadata-toggle.js"></script>
<script type="text/javascript" src="../js/lbHeader.js"></script>

<style type="text/css">@import "../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(){window.prettyPrint && prettyPrint()});
//]]></script>
<!-- hook for including project specific javascript into the generated docs -->

</body>
</html>
