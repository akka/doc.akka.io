<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Producing temperature events &bull; Akka Edge</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="Akka Projection."/>
<link rel="canonical" href="https://doc.akka.io/docs/akka-edge/current/guide-rs/5-temperature-production.html"/>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../lib/foundation/dist/js/foundation.min.js"></script>
<link rel="stylesheet" type="text/css" href="../lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="../lib/foundation/dist/css/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" type="text/css" href="../css/icons.css"/>
<link rel="stylesheet" type="text/css" href="../css/page-8.css"/>
<link rel="stylesheet" type="text/css" href="../css/banner-2.css"/>
<link rel="shortcut icon" href="../images/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="../images/apple-touch-icon.png"/>
<link rel="icon" type="image/png" sizes="32x32" href="../images/favicon-32x32.png"/>
<link rel="icon" type="image/png" sizes="16x16" href="../images/favicon-16x16.png"/>
<link rel="manifest" href="../images/manifest.json"/>
<meta name="msapplication-TileImage" content="../images/mstile-150x150.png"/>
<meta name="msapplication-TileColor" content="#15a9ce"/>
<meta name="theme-color" content="#15a9ce"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) start -->
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js"  type="text/javascript" charset="UTF-8" data-domain-script="28b912e7-09e9-43d5-91e4-3d1897044004" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) end -->
<!-- Google Tag Manager now loads Google Analytics and any other tracking scripts. GTM also performs respects a users cookie choices-->
<script type="text/javascript">
(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KBJGH35');
</script>

</head>

<body id="underlay" data-toggler="nav-open">
<div id="lightbend-banner" class="lightbend-banner akka full-width" data-category="OSS Lightbend Banner Impression" data-label="Akka Banner Impression">
<div class="oss-wrapper">
<div class="oss-brand">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lightbend Logo - Akka Banner" href="https://www.lightbend.com">
<img class="lightbend-logo" src="../images/banner-logos/lightbend-reverse.svg" alt="Lightbend" title="Lightbend">
</a>
</div>
<div class="oss-ad no-drop-down">
<nav id="lightbendRotator" class="lightbend-rotator">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Promo Rotator - Introducing Akka Cloud to Edge Continuum. Build once for the Cloud. Seamlessly deploy to the Edge. [Learn more] - Akka Banner" href="https://www.lightbend.com/blog/akka-edge-unifying-the-cloud-and-edge">
Introducing Akka Cloud to Edge Continuum. Build once for the Cloud. Seamlessly deploy to the Edge. <span class="akka-btn">Learn more</span>
</a>
</nav>
</div>
</div>
</div>

<header class="site-header hide-for-large">
<div class="sticky-header clearfix">
<a href="https://akka.io"><img class="logo" src="../images/akka-logo-reverse.svg"/></a>

<button class="menu-icon float-right" type="button" data-toggle="underlay overlay"></button>
</div>
<div id="overlay" class="overlay-nav" data-toggler="nav-open">
<header class="nav-header">
<div class="nav-header-title">
<h1><a href="../index.html">Akka Edge</a></h1>
</div>
<div class="nav-header-version">
Version 1.5.2
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="nav-toc">
<ul>
  <li><a href="../overview.html" class="page">Architectural Overview</a></li>
  <li><a href="../use-cases.html" class="page">Example Use Cases</a></li>
  <li><a href="../feature-summary.html" class="page">Feature Summary</a></li>
  <li><a href="../guide.html" class="page">Guide - Java/Scala</a></li>
  <li><a href="../guide-rs.html" class="page">Guide - Rust</a>
  <ul>
    <li><a href="../guide-rs/1-setup.html" class="page">Getting started</a></li>
    <li><a href="../guide-rs/2-running.html" class="page">Running the sample</a></li>
    <li><a href="../guide-rs/3-temperature-entity.html" class="page">The temperature entity</a></li>
    <li><a href="../guide-rs/4-registration-projection.html" class="page">Consuming registration events</a></li>
    <li><a href="../guide-rs/5-temperature-production.html#producing-temperature-events" class="active page">Producing temperature events</a>
    <ul>
      <li><a href="../guide-rs/5-temperature-production.html#the-offset-store" class="header">The offset store</a></li>
      <li><a href="../guide-rs/5-temperature-production.html#the-source-provider" class="header">The source provider</a></li>
      <li><a href="../guide-rs/5-temperature-production.html#the-producer" class="header">The producer</a></li>
      <li><a href="../guide-rs/5-temperature-production.html#the-transformer-and-handler" class="header">The transformer and handler</a></li>
      <li><a href="../guide-rs/5-temperature-production.html#the-consumer" class="header">The consumer</a></li>
      <li><a href="../guide-rs/5-temperature-production.html#putting-it-all-together" class="header">Putting it all together</a></li>
      <li><a href="../guide-rs/5-temperature-production.html#whats-next-" class="header">What&rsquo;s next?</a></li>
    </ul></li>
    <li><a href="../guide-rs/6-temperature-production-http.html" class="page">HTTP temperature events</a></li>
    <li><a href="../guide-rs/7-udp-consumption.html" class="page">UDP observations</a></li>
    <li><a href="../guide-rs/8-main.html" class="page">The main function</a></li>
  </ul></li>
  <li><a href="../lightweight-deployments.html" class="page">Lightweight deployments</a></li>
</ul>
</nav>
</div>
</header>
<div class="site-content-wrapper">
<aside class="sticky-sidebar show-for-large">
<header class="nav-header sticky-sidebar-header">
<div class="nav-header-title">
<h1><a href="../index.html">Akka Edge</a></h1>
</div>
<div class="nav-header-version">
Version 1.5.2
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="site-nav sticky-sidebar-contents">
<div class="nav-toc">
<ul>
  <li><a href="../overview.html" class="page">Architectural Overview</a></li>
  <li><a href="../use-cases.html" class="page">Example Use Cases</a></li>
  <li><a href="../feature-summary.html" class="page">Feature Summary</a></li>
  <li><a href="../guide.html" class="page">Guide - Java/Scala</a></li>
  <li><a href="../guide-rs.html" class="page">Guide - Rust</a>
  <ul>
    <li><a href="../guide-rs/1-setup.html" class="page">Getting started</a></li>
    <li><a href="../guide-rs/2-running.html" class="page">Running the sample</a></li>
    <li><a href="../guide-rs/3-temperature-entity.html" class="page">The temperature entity</a></li>
    <li><a href="../guide-rs/4-registration-projection.html" class="page">Consuming registration events</a></li>
    <li><a href="../guide-rs/5-temperature-production.html#producing-temperature-events" class="active page">Producing temperature events</a>
    <ul>
      <li><a href="../guide-rs/5-temperature-production.html#the-offset-store" class="header">The offset store</a></li>
      <li><a href="../guide-rs/5-temperature-production.html#the-source-provider" class="header">The source provider</a></li>
      <li><a href="../guide-rs/5-temperature-production.html#the-producer" class="header">The producer</a></li>
      <li><a href="../guide-rs/5-temperature-production.html#the-transformer-and-handler" class="header">The transformer and handler</a></li>
      <li><a href="../guide-rs/5-temperature-production.html#the-consumer" class="header">The consumer</a></li>
      <li><a href="../guide-rs/5-temperature-production.html#putting-it-all-together" class="header">Putting it all together</a></li>
      <li><a href="../guide-rs/5-temperature-production.html#whats-next-" class="header">What&rsquo;s next?</a></li>
    </ul></li>
    <li><a href="../guide-rs/6-temperature-production-http.html" class="page">HTTP temperature events</a></li>
    <li><a href="../guide-rs/7-udp-consumption.html" class="page">UDP observations</a></li>
    <li><a href="../guide-rs/8-main.html" class="page">The main function</a></li>
  </ul></li>
  <li><a href="../lightweight-deployments.html" class="page">Lightweight deployments</a></li>
</ul>
</div>
</nav>
<footer class="nav-footer sticky-sidebar-footer">
<a href="https://akka.io"><img class="logo" src="../images/akka-logo-reverse.svg"/></a>

</footer>
</aside>
<main class="fixed-shift-for-large expanded row">
<section class="site-content small-12 column">
<article class="page-content row">
<div class="small-12 column" id="docs">
<h1><a href="#producing-temperature-events" name="producing-temperature-events" class="anchor"><span class="anchor-link"></span></a>Producing temperature events</h1>
<p>Once registered, the temperature entity can receive observations. These observations are then produced to a remote consumer, and this page describes how we produce events over gRPC. We can also produce events over HTTP and do so <a href="6-temperature-production-http.html">later in the guide</a>.</p>
<p>An interesting aspect of connectivity from the edge is that it typically connects to the cloud, and not the other way round. This is largely due to network traffic restrictions where the cloud cannot &ldquo;see in&rdquo; to the edge, but the edge can &ldquo;reach out&rdquo;. Akka provides a &ldquo;projection producer&rdquo; for the purposes of establishing a connection and then producing events.</p>
<h2><a href="#the-offset-store" name="the-offset-store" class="anchor"><span class="anchor-link"></span></a>The offset store</h2>
<p>We wish to avoid producing events that we have produced before. As with consuming registration events, we establish an offset store to keep track of events that we produced.</p>
<dl>
  <dt>Rust</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/iot-service-rs/backend/src/temperature_production.rs#L30-L37" target="_blank" title="Go to snippet source">source</a><code class="language-rs">let stream_id = StreamId::from(&quot;temperature-events&quot;);

let offset_store_id = stream_id.clone();
let offset_store = offset_store::task(
    commit_log.clone(),
    temperature::MAX_ENTITIES,
    offset_store_id,
);</code></pre></dd>
</dl>
<p>We also declare the commit log to use and the expected number of distinct entities for sizing memory usage. As with consuming registrations, the number of temperature productions is used to determine how many entity id offsets are held in memory at any one time. Each offset store must also have a distinct identity, hence the <code>offset-store-id</code>.</p>
<h2><a href="#the-source-provider" name="the-source-provider" class="anchor"><span class="anchor-link"></span></a>The source provider</h2>
<p>We establish our source of events as a commit log using a source provider with the same marshaller declared for running the entity manager <a href="3-temperature-entity.html#serialization-and-storage">earlier in the guide</a>:</p>
<dl>
  <dt>Rust</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/iot-service-rs/backend/src/temperature_production.rs#L41-L46" target="_blank" title="Go to snippet source">source</a><code class="language-rs">let source_provider = CommitLogSourceProvider::new(
    commit_log,
    temperature::marshaller(events_key_secret_path, secret_store),
    &quot;iot-service-projection&quot;,
    Topic::from(temperature::EVENTS_TOPIC),
);</code></pre></dd>
</dl>
<h2><a href="#the-producer" name="the-producer" class="anchor"><span class="anchor-link"></span></a>The producer</h2>
<p>A &ldquo;sink&rdquo; of envelopes is established that forward on to a remote consumer via a producer &ldquo;flow&rdquo;. The flow will be used to bridge between source of events and this sink.</p>
<p>A great deal of flexibility is provided in terms of expressing how the remote consumer&rsquo;s endpoint is established via the <code>consumer_connector</code>. Quite often, this will be the establishment of an HTTP TLS endpoint, but it can also be plaintext (as it is in the example), or even Unix Domain Sockets.</p>
<dl>
  <dt>Rust</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/iot-service-rs/backend/src/temperature_production.rs#L50-L61" target="_blank" title="Go to snippet source">source</a><code class="language-rs">let consumer_connector = move || {
    let consumer_endpoint = Channel::builder(event_consumer_addr.clone());
    async move { consumer_endpoint.connect().await }
};
let (producer_task, producer_flow, producer_kill_switch) = producer::task(
    consumer_connector,
    OriginId::from(&quot;edge-iot-service&quot;),
    stream_id,
    entity_type,
    MAX_IN_FLIGHT,
);
tokio::spawn(producer_task);</code></pre></dd>
</dl>
<p><code>MAX_IN_FLIGHT</code> represents the maximum number of publications of an event waiting for an acknowledgement that will buffer before back-pressuring the producer.</p>
<p>A producer is independent from the source of events in that it produces at a different rate to what is sourced. Consequently, the producer is spawned into its own task, and it can buffer the source of events across the flow.</p>
<h2><a href="#the-transformer-and-handler" name="the-transformer-and-handler" class="anchor"><span class="anchor-link"></span></a>The transformer and handler</h2>
<p>We must declare how our events are to be transformed into their gRPC form, and then obtain a handler from any required filtering.</p>
<dl>
  <dt>Rust</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/iot-service-rs/backend/src/temperature_production.rs#L65-L84" target="_blank" title="Go to snippet source">source</a><code class="language-rs">let transformer = |envelope: &amp;EventEnvelope&lt;temperature::Event&gt;| {
    let temperature::Event::TemperatureRead { temperature } = envelope.event else {
        return None;
    };

    let event = proto::TemperatureRead {
        temperature: temperature as i32,
    };

    Some(event)
};
let producer_filter = |_: &amp;EventEnvelope&lt;temperature::Event&gt;| true;
let handler = producer_flow.handler(producer_filter, transformer);</code></pre></dd>
</dl>
<h2><a href="#the-consumer" name="the-consumer" class="anchor"><span class="anchor-link"></span></a>The consumer</h2>
<p>At this stage, we have a means to produce events over a gRPC producer. The final step is to start up a projection that uses the flow to source events from the commit log. The projection is able to resume from where we left off given the offset store.</p>
<dl>
  <dt>Rust</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/iot-service-rs/backend/src/temperature_production.rs#L88-L90" target="_blank" title="Go to snippet source">source</a><code class="language-rs">let (consumer_task, consumer_kill_switch) =
    consumer::task(offset_store, source_provider, handler);
tokio::spawn(consumer_task);</code></pre></dd>
</dl>
<h2><a href="#putting-it-all-together" name="putting-it-all-together" class="anchor"><span class="anchor-link"></span></a>Putting it all together</h2>
<p>The following code puts all of the above together as a task that can be spawned:</p>
<dl>
  <dt>Rust</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/iot-service-rs/backend/src/temperature_production.rs#L18-L94" target="_blank" title="Go to snippet source">source</a><code class="language-rs">const MAX_IN_FLIGHT: usize = 10;

// Apply sensor observations to a remote consumer.
pub fn spawn(
    commit_log: FileLog,
    event_consumer_addr: Uri,
    secret_store: FileSecretStore,
    events_key_secret_path: String,
) -&gt; (oneshot::Sender&lt;()&gt;, oneshot::Sender&lt;()&gt;) {
    let entity_type = EntityType::from(temperature::ENTITY_TYPE);

    let stream_id = StreamId::from(&quot;temperature-events&quot;);

    let offset_store_id = stream_id.clone();
    let offset_store = offset_store::task(
        commit_log.clone(),
        temperature::MAX_ENTITIES,
        offset_store_id,
    );

    let source_provider = CommitLogSourceProvider::new(
        commit_log,
        temperature::marshaller(events_key_secret_path, secret_store),
        &quot;iot-service-projection&quot;,
        Topic::from(temperature::EVENTS_TOPIC),
    );

    let consumer_connector = move || {
        let consumer_endpoint = Channel::builder(event_consumer_addr.clone());
        async move { consumer_endpoint.connect().await }
    };
    let (producer_task, producer_flow, producer_kill_switch) = producer::task(
        consumer_connector,
        OriginId::from(&quot;edge-iot-service&quot;),
        stream_id,
        entity_type,
        MAX_IN_FLIGHT,
    );
    tokio::spawn(producer_task);

    let transformer = |envelope: &amp;EventEnvelope&lt;temperature::Event&gt;| {
        let temperature::Event::TemperatureRead { temperature } = envelope.event else {
            return None;
        };

        info!(
            &quot;Producing {} with temperature of {}&quot;,
            envelope.persistence_id, temperature
        );

        let event = proto::TemperatureRead {
            temperature: temperature as i32,
        };

        Some(event)
    };
    let producer_filter = |_: &amp;EventEnvelope&lt;temperature::Event&gt;| true;
    let handler = producer_flow.handler(producer_filter, transformer);

    let (consumer_task, consumer_kill_switch) =
        consumer::task(offset_store, source_provider, handler);
    tokio::spawn(consumer_task);

    (producer_kill_switch, consumer_kill_switch)
}</code></pre></dd>
</dl>
<h2><a href="#whats-next-" name="whats-next-" class="anchor"><span class="anchor-link"></span></a>What&rsquo;s next?</h2>
<ul>
  <li>HTTP temperature events</li>
</ul>
</div>
</article>
<div class="row">
<div class="small-12 column">
<section class="nav-prev-next row">
<div class="nav-prev small-6 column">
<a href="../guide-rs/4-registration-projection.html"><i class="icon-prev"></i> <span class="link-prev">Consuming registration events</span></a>
</div>
<div class="nav-next small-6 column clearfix">
<a class="float-right" href="../guide-rs/6-temperature-production-http.html">HTTP temperature events <i class="icon-next"></i></a>
</div>
</section>
</div>
</div>
<div class="source-github row">
Found an error in this documentation? The source code for this page can be found <a href="https://github.com/akka/akka-projection/tree/master/akka-edge-docs/src/main/paradox/guide-rs/5-temperature-production.md">here</a>.
Please feel free to edit and contribute a pull request.
</div>

<footer class="page-footer row clearfix">
<img class="akka-icon float-left show-for-medium" src="../images/akka-icon.svg" />
<section class="copyright">
<div>Akka Edge is available under the <a href="https://www.lightbend.com/akka/license" target="_blank">Business Source License 1.1</a>.</div>
<p class="legal">
&copy; 2011-2024 <a href="https://www.lightbend.com" target="_blank">Lightbend, Inc.</a> |
<a href="https://www.lightbend.com/legal/licenses" target="_blank">Licenses</a> |
<a href="https://www.lightbend.com/legal/terms" target="_blank">Terms</a> |
<a href="https://www.lightbend.com/legal/privacy" target="_blank">Privacy Policy</a> |
<a href="https://akka.io/cookie/" target="_blank">Cookie Listing</a> |
<a class="optanon-toggle-display">Cookie Settings</a>
</p>
</section>

</footer>
</section>
</main>
</div>

<script type="text/javascript" src="../js/scrollsneak.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../js/groups.js"></script>
<script type="text/javascript" src="../js/page.js"></script>
<script type="text/javascript" src="../js/snippets.js"></script>
<script type="text/javascript" src="../js/magellan.js"></script>
<script type="text/javascript" src="../js/metadata-toggle.js"></script>
<script type="text/javascript" src="../js/lbHeader.js"></script>

<style type="text/css">@import "../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(){window.prettyPrint && prettyPrint()});
//]]></script>
<!-- hook for including project specific javascript into the generated docs -->

</body>
</html>
