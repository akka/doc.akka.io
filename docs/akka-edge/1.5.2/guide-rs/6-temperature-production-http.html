<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>HTTP temperature events &bull; Akka Edge</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="Akka Projection."/>
<link rel="canonical" href="https://doc.akka.io/docs/akka-edge/current/guide-rs/6-temperature-production-http.html"/>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../lib/foundation/dist/js/foundation.min.js"></script>
<link rel="stylesheet" type="text/css" href="../lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="../lib/foundation/dist/css/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" type="text/css" href="../css/icons.css"/>
<link rel="stylesheet" type="text/css" href="../css/page-8.css"/>
<link rel="stylesheet" type="text/css" href="../css/banner-2.css"/>
<link rel="shortcut icon" href="../images/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="../images/apple-touch-icon.png"/>
<link rel="icon" type="image/png" sizes="32x32" href="../images/favicon-32x32.png"/>
<link rel="icon" type="image/png" sizes="16x16" href="../images/favicon-16x16.png"/>
<link rel="manifest" href="../images/manifest.json"/>
<meta name="msapplication-TileImage" content="../images/mstile-150x150.png"/>
<meta name="msapplication-TileColor" content="#15a9ce"/>
<meta name="theme-color" content="#15a9ce"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) start -->
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js"  type="text/javascript" charset="UTF-8" data-domain-script="28b912e7-09e9-43d5-91e4-3d1897044004" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) end -->
<!-- Google Tag Manager now loads Google Analytics and any other tracking scripts. GTM also performs respects a users cookie choices-->
<script type="text/javascript">
(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KBJGH35');
</script>

</head>

<body id="underlay" data-toggler="nav-open">
<div id="lightbend-banner" class="lightbend-banner akka full-width" data-category="OSS Lightbend Banner Impression" data-label="Akka Banner Impression">
<div class="oss-wrapper">
<div class="oss-brand">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lightbend Logo - Akka Banner" href="https://www.lightbend.com">
<img class="lightbend-logo" src="../images/banner-logos/lightbend-reverse.svg" alt="Lightbend" title="Lightbend">
</a>
</div>
<div class="oss-ad no-drop-down">
<nav id="lightbendRotator" class="lightbend-rotator">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Promo Rotator - Introducing Akka Cloud to Edge Continuum. Build once for the Cloud. Seamlessly deploy to the Edge. [Learn more] - Akka Banner" href="https://www.lightbend.com/blog/akka-edge-unifying-the-cloud-and-edge">
Introducing Akka Cloud to Edge Continuum. Build once for the Cloud. Seamlessly deploy to the Edge. <span class="akka-btn">Learn more</span>
</a>
</nav>
</div>
</div>
</div>

<header class="site-header hide-for-large">
<div class="sticky-header clearfix">
<a href="https://akka.io"><img class="logo" src="../images/akka-logo-reverse.svg"/></a>

<button class="menu-icon float-right" type="button" data-toggle="underlay overlay"></button>
</div>
<div id="overlay" class="overlay-nav" data-toggler="nav-open">
<header class="nav-header">
<div class="nav-header-title">
<h1><a href="../index.html">Akka Edge</a></h1>
</div>
<div class="nav-header-version">
Version 1.5.2
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="nav-toc">
<ul>
  <li><a href="../overview.html" class="page">Architectural Overview</a></li>
  <li><a href="../use-cases.html" class="page">Example Use Cases</a></li>
  <li><a href="../feature-summary.html" class="page">Feature Summary</a></li>
  <li><a href="../guide.html" class="page">Guide - Java/Scala</a></li>
  <li><a href="../guide-rs.html" class="page">Guide - Rust</a>
  <ul>
    <li><a href="../guide-rs/1-setup.html" class="page">Getting started</a></li>
    <li><a href="../guide-rs/2-running.html" class="page">Running the sample</a></li>
    <li><a href="../guide-rs/3-temperature-entity.html" class="page">The temperature entity</a></li>
    <li><a href="../guide-rs/4-registration-projection.html" class="page">Consuming registration events</a></li>
    <li><a href="../guide-rs/5-temperature-production.html" class="page">Producing temperature events</a></li>
    <li><a href="../guide-rs/6-temperature-production-http.html#http-temperature-events" class="active page">HTTP temperature events</a>
    <ul>
      <li><a href="../guide-rs/6-temperature-production-http.html#the-offset-store" class="header">The offset store</a></li>
      <li><a href="../guide-rs/6-temperature-production-http.html#the-source-provider" class="header">The source provider</a></li>
      <li><a href="../guide-rs/6-temperature-production-http.html#the-handler" class="header">The handler</a></li>
      <li><a href="../guide-rs/6-temperature-production-http.html#the-consumer" class="header">The consumer</a></li>
      <li><a href="../guide-rs/6-temperature-production-http.html#server-sent-events-sse-" class="header">Server Sent Events (SSE)</a></li>
      <li><a href="../guide-rs/6-temperature-production-http.html#putting-it-all-together" class="header">Putting it all together</a></li>
      <li><a href="../guide-rs/6-temperature-production-http.html#whats-next-" class="header">What&rsquo;s next?</a></li>
    </ul></li>
    <li><a href="../guide-rs/7-udp-consumption.html" class="page">UDP observations</a></li>
    <li><a href="../guide-rs/8-main.html" class="page">The main function</a></li>
  </ul></li>
  <li><a href="../lightweight-deployments.html" class="page">Lightweight deployments</a></li>
</ul>
</nav>
</div>
</header>
<div class="site-content-wrapper">
<aside class="sticky-sidebar show-for-large">
<header class="nav-header sticky-sidebar-header">
<div class="nav-header-title">
<h1><a href="../index.html">Akka Edge</a></h1>
</div>
<div class="nav-header-version">
Version 1.5.2
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="site-nav sticky-sidebar-contents">
<div class="nav-toc">
<ul>
  <li><a href="../overview.html" class="page">Architectural Overview</a></li>
  <li><a href="../use-cases.html" class="page">Example Use Cases</a></li>
  <li><a href="../feature-summary.html" class="page">Feature Summary</a></li>
  <li><a href="../guide.html" class="page">Guide - Java/Scala</a></li>
  <li><a href="../guide-rs.html" class="page">Guide - Rust</a>
  <ul>
    <li><a href="../guide-rs/1-setup.html" class="page">Getting started</a></li>
    <li><a href="../guide-rs/2-running.html" class="page">Running the sample</a></li>
    <li><a href="../guide-rs/3-temperature-entity.html" class="page">The temperature entity</a></li>
    <li><a href="../guide-rs/4-registration-projection.html" class="page">Consuming registration events</a></li>
    <li><a href="../guide-rs/5-temperature-production.html" class="page">Producing temperature events</a></li>
    <li><a href="../guide-rs/6-temperature-production-http.html#http-temperature-events" class="active page">HTTP temperature events</a>
    <ul>
      <li><a href="../guide-rs/6-temperature-production-http.html#the-offset-store" class="header">The offset store</a></li>
      <li><a href="../guide-rs/6-temperature-production-http.html#the-source-provider" class="header">The source provider</a></li>
      <li><a href="../guide-rs/6-temperature-production-http.html#the-handler" class="header">The handler</a></li>
      <li><a href="../guide-rs/6-temperature-production-http.html#the-consumer" class="header">The consumer</a></li>
      <li><a href="../guide-rs/6-temperature-production-http.html#server-sent-events-sse-" class="header">Server Sent Events (SSE)</a></li>
      <li><a href="../guide-rs/6-temperature-production-http.html#putting-it-all-together" class="header">Putting it all together</a></li>
      <li><a href="../guide-rs/6-temperature-production-http.html#whats-next-" class="header">What&rsquo;s next?</a></li>
    </ul></li>
    <li><a href="../guide-rs/7-udp-consumption.html" class="page">UDP observations</a></li>
    <li><a href="../guide-rs/8-main.html" class="page">The main function</a></li>
  </ul></li>
  <li><a href="../lightweight-deployments.html" class="page">Lightweight deployments</a></li>
</ul>
</div>
</nav>
<footer class="nav-footer sticky-sidebar-footer">
<a href="https://akka.io"><img class="logo" src="../images/akka-logo-reverse.svg"/></a>

</footer>
</aside>
<main class="fixed-shift-for-large expanded row">
<section class="site-content small-12 column">
<article class="page-content row">
<div class="small-12 column" id="docs">
<h1><a href="#http-temperature-events" name="http-temperature-events" class="anchor"><span class="anchor-link"></span></a>HTTP temperature events</h1>
<p>For the purposes of serving requests made by a user interface, we stream events to one in a similar fashion to how we produce events over gRPC; at least in terms of how we source the events. There are variety of technologies that can be used to push a stream of events to a user interface and we illustrate <a href="https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events/Using_server-sent_events">Server Sent Events</a> (SSE). SSE is attractive for browser-based user interfaces given its ease-of use, and because the browser takes care of maintaining a connection with a server.</p>
<p>For our example, we are using <a href="https://github.com/seanmonstar/warp">Warp</a> as the toolkit for serving HTTP. There are a number of HTTP toolkits available so you may decide on using another for other reasons. Our choice is here based simply on familiarity and the fact that Warp is authored by the same team that provides <a href="https://hyper.rs/">Hyper</a>, a very popular lower-level HTTP toolkit in the Rust community.</p>
<h2><a href="#the-offset-store" name="the-offset-store" class="anchor"><span class="anchor-link"></span></a>The offset store</h2>
<p>We have an offset store (again!). This time, things are slightly different. In our example, we assume that our clients are stateless and will not request events given a starting offset. We can get away with this given the use of <a href="https://lib.rs/crates/streambed-logged">Streambed Logged</a> as our storage medium, and its compaction function which keeps the number of events to something manageable. However, we still need an offset store though so we can correctly track offset sequence numbers. For this particular use-case, we use a <code>volatile_offset_store</code>:</p>
<dl>
  <dt>Rust</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/iot-service-rs/backend/src/http_server.rs#L42" target="_blank" title="Go to snippet source">source</a><code class="language-rs">let offset_store = volatile_offset_store::task(temperature::MAX_ENTITIES);</code></pre></dd>
</dl>
<p>We size the offset store with the number of entities held in memory at any one time. This ultimately results in the amount of memory reserved for the offset store, and it will grow dynamically beyond this size if required. However, it is good practice to size it with the maximum anticipated so that memory consumption is reasonably deterministic.</p><div class="callout note "><div class="callout-title">Note</div>
<p>In all applications, constraining the number of external requests at any one time is important so that a DDoS attack will not bring a process down. This can be best done with an application level proxy.</p></div>
<h2><a href="#the-source-provider" name="the-source-provider" class="anchor"><span class="anchor-link"></span></a>The source provider</h2>
<p>A source provider is established in the same way as when producing over gRPC, again using the same marshaller declared for running the entity manager <a href="3-temperature-entity.html#serialization-and-storage">earlier in the guide</a>:</p>
<dl>
  <dt>Rust</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/iot-service-rs/backend/src/http_server.rs#L46-L51" target="_blank" title="Go to snippet source">source</a><code class="language-rs">let source_provider = CommitLogSourceProvider::new(
    commit_log.clone(),
    temperature::marshaller(events_key_secret_path.clone(), secret_store.clone()),
    &quot;http-projection&quot;,
    Topic::from(temperature::EVENTS_TOPIC),
);</code></pre></dd>
</dl>
<h2><a href="#the-handler" name="the-handler" class="anchor"><span class="anchor-link"></span></a>The handler</h2>
<p>A handler function is provided to send envelopes from the commit log over a channel that we will subsequently stream via SSE.</p>
<dl>
  <dt>Rust</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/iot-service-rs/backend/src/http_server.rs#L55-L70" target="_blank" title="Go to snippet source">source</a><code class="language-rs">let (temperature_events, temperature_events_receiver) = mpsc::channel(1);
let handler = move |envelope: EventEnvelope&lt;temperature::Event&gt;| {
    let entity_id = entity_id.clone();
    let temperature_events = temperature_events.clone();
    async move {
        if envelope.persistence_id.entity_id == entity_id {
            temperature_events
                .send((entity_id, envelope.event))
                .await
                .map(|_| ())
                .map_err(|_| HandlerError)
        } else {
            Ok(())
        }
    }
};</code></pre></dd>
</dl>
<h2><a href="#the-consumer" name="the-consumer" class="anchor"><span class="anchor-link"></span></a>The consumer</h2>
<p>Set up the consumer task that will source events from using our in-memory offset store, source provider and handler.</p>
<dl>
  <dt>Rust</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/iot-service-rs/backend/src/http_server.rs#L74-L76" target="_blank" title="Go to snippet source">source</a><code class="language-rs">let (consumer_task, consumer_kill_switch) =
    consumer::task(offset_store, source_provider, handler);
tokio::spawn(consumer_task);</code></pre></dd>
</dl>
<h2><a href="#server-sent-events-sse-" name="server-sent-events-sse-" class="anchor"><span class="anchor-link"></span></a>Server Sent Events (SSE)</h2>
<p>The final step is to consume the events produced by the consumer&rsquo;s handler. We do this by wrapping the receiver end of the channel created earlier. Events are then serialized into JSON.</p>
<dl>
  <dt>Rust</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/iot-service-rs/backend/src/http_server.rs#L80-L98" target="_blank" title="Go to snippet source">source</a><code class="language-rs">let event_stream = ReceiverStream::new(temperature_events_receiver)
    .map(|(entity_id, event)| {
        let sse_event = sse::Event::default();
        let sse_event = if let temperature::Event::Registered { .. } = event {
            sse_event.id(entity_id)
        } else {
            sse_event
        };
        sse_event.json_data(event)
    })
    .take_until(async {
        let result =
            time::timeout(MAX_SSE_CONNECTION_TIME, future::pending::&lt;()&gt;()).await;
        drop(consumer_kill_switch);
        result
    });

let event_stream = sse::keep_alive().stream(event_stream);
sse::reply(event_stream)</code></pre></dd>
</dl>
<p>We use <code>MAX_SSE_CONNECTION_TIME</code> to limit the maximum amount of time that an SSE connection can be held. Any consumer of the SSE events will automatically re-connect if they are still able to. This circumvents keeping a TCP socket open for many minutes in the absence of there being a connection. While producing our SSE events should relatively efficient, we do not do it unless we really need to, and TCP is not always fast in detecting the loss of a network connection.</p>
<h2><a href="#putting-it-all-together" name="putting-it-all-together" class="anchor"><span class="anchor-link"></span></a>Putting it all together</h2>
<p>The following code puts all of the above together as a route that can be served:</p>
<dl>
  <dt>Rust</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/iot-service-rs/backend/src/http_server.rs#L19-L106" target="_blank" title="Go to snippet source">source</a><code class="language-rs">// We use this to limit the maximum amount of time that an SSE connection can be held.
// Any consumer of the SSE events will automatically re-connect if they are still able
// to. This circumvents keeping a TCP socket open for many minutes in the absence of
// there being a connection. While producing our SSE events should relatively efficient,
// we don&#39;t do it unless we really need to, and TCP isn&#39;t great about detecting the
// loss of a network
const MAX_SSE_CONNECTION_TIME: Duration = Duration::from_secs(60);

// Declares routes to serve our HTTP interface.
pub fn routes(
    commit_log: FileLog,
    secret_store: FileSecretStore,
    events_key_secret_path: String,
) -&gt; impl Filter&lt;Extract = (impl Reply,), Error = Rejection&gt; + Clone {
    let get_temperature_route = {
        warp::get()
            .and(warp::path(&quot;events&quot;))
            .and(warp::path::param())
            .and(warp::path::end())
            .map(move |entity_id: String| {
                let entity_id = EntityId::from(entity_id);

                let offset_store = volatile_offset_store::task(temperature::MAX_ENTITIES);

                let source_provider = CommitLogSourceProvider::new(
                    commit_log.clone(),
                    temperature::marshaller(events_key_secret_path.clone(), secret_store.clone()),
                    &quot;http-projection&quot;,
                    Topic::from(temperature::EVENTS_TOPIC),
                );

                let (temperature_events, temperature_events_receiver) = mpsc::channel(1);
                let handler = move |envelope: EventEnvelope&lt;temperature::Event&gt;| {
                    let entity_id = entity_id.clone();
                    let temperature_events = temperature_events.clone();
                    async move {
                        if envelope.persistence_id.entity_id == entity_id {
                            temperature_events
                                .send((entity_id, envelope.event))
                                .await
                                .map(|_| ())
                                .map_err(|_| HandlerError)
                        } else {
                            Ok(())
                        }
                    }
                };

                let (consumer_task, consumer_kill_switch) =
                    consumer::task(offset_store, source_provider, handler);
                tokio::spawn(consumer_task);

                let event_stream = ReceiverStream::new(temperature_events_receiver)
                    .map(|(entity_id, event)| {
                        let sse_event = sse::Event::default();
                        let sse_event = if let temperature::Event::Registered { .. } = event {
                            sse_event.id(entity_id)
                        } else {
                            sse_event
                        };
                        sse_event.json_data(event)
                    })
                    .take_until(async {
                        let result =
                            time::timeout(MAX_SSE_CONNECTION_TIME, future::pending::&lt;()&gt;()).await;
                        drop(consumer_kill_switch);
                        result
                    });

                let event_stream = sse::keep_alive().stream(event_stream);
                sse::reply(event_stream)
            })
    };

    let routes = get_temperature_route;

    warp::path(&quot;api&quot;).and(warp::path(&quot;temperature&quot;).and(routes))
}</code></pre></dd>
</dl>
<h2><a href="#whats-next-" name="whats-next-" class="anchor"><span class="anchor-link"></span></a>What&rsquo;s next?</h2>
<ul>
  <li>UDP observations</li>
</ul>
</div>
</article>
<div class="row">
<div class="small-12 column">
<section class="nav-prev-next row">
<div class="nav-prev small-6 column">
<a href="../guide-rs/5-temperature-production.html"><i class="icon-prev"></i> <span class="link-prev">Producing temperature events</span></a>
</div>
<div class="nav-next small-6 column clearfix">
<a class="float-right" href="../guide-rs/7-udp-consumption.html">UDP observations <i class="icon-next"></i></a>
</div>
</section>
</div>
</div>
<div class="source-github row">
Found an error in this documentation? The source code for this page can be found <a href="https://github.com/akka/akka-projection/tree/master/akka-edge-docs/src/main/paradox/guide-rs/6-temperature-production-http.md">here</a>.
Please feel free to edit and contribute a pull request.
</div>

<footer class="page-footer row clearfix">
<img class="akka-icon float-left show-for-medium" src="../images/akka-icon.svg" />
<section class="copyright">
<div>Akka Edge is available under the <a href="https://www.lightbend.com/akka/license" target="_blank">Business Source License 1.1</a>.</div>
<p class="legal">
&copy; 2011-2024 <a href="https://www.lightbend.com" target="_blank">Lightbend, Inc.</a> |
<a href="https://www.lightbend.com/legal/licenses" target="_blank">Licenses</a> |
<a href="https://www.lightbend.com/legal/terms" target="_blank">Terms</a> |
<a href="https://www.lightbend.com/legal/privacy" target="_blank">Privacy Policy</a> |
<a href="https://akka.io/cookie/" target="_blank">Cookie Listing</a> |
<a class="optanon-toggle-display">Cookie Settings</a>
</p>
</section>

</footer>
</section>
</main>
</div>

<script type="text/javascript" src="../js/scrollsneak.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../js/groups.js"></script>
<script type="text/javascript" src="../js/page.js"></script>
<script type="text/javascript" src="../js/snippets.js"></script>
<script type="text/javascript" src="../js/magellan.js"></script>
<script type="text/javascript" src="../js/metadata-toggle.js"></script>
<script type="text/javascript" src="../js/lbHeader.js"></script>

<style type="text/css">@import "../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(){window.prettyPrint && prettyPrint()});
//]]></script>
<!-- hook for including project specific javascript into the generated docs -->

</body>
</html>
