<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>The temperature entity &bull; Akka Edge</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="Akka Projection."/>
<link rel="canonical" href="https://doc.akka.io/docs/akka-edge/current/guide-rs/3-temperature-entity.html"/>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../lib/foundation/dist/js/foundation.min.js"></script>
<link rel="stylesheet" type="text/css" href="../lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="../lib/foundation/dist/css/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" type="text/css" href="../css/icons.css"/>
<link rel="stylesheet" type="text/css" href="../css/page-8.css"/>
<link rel="stylesheet" type="text/css" href="../css/banner-2.css"/>
<link rel="shortcut icon" href="../images/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="../images/apple-touch-icon.png"/>
<link rel="icon" type="image/png" sizes="32x32" href="../images/favicon-32x32.png"/>
<link rel="icon" type="image/png" sizes="16x16" href="../images/favicon-16x16.png"/>
<link rel="manifest" href="../images/manifest.json"/>
<meta name="msapplication-TileImage" content="../images/mstile-150x150.png"/>
<meta name="msapplication-TileColor" content="#15a9ce"/>
<meta name="theme-color" content="#15a9ce"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) start -->
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js"  type="text/javascript" charset="UTF-8" data-domain-script="28b912e7-09e9-43d5-91e4-3d1897044004" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) end -->
<!-- Google Tag Manager now loads Google Analytics and any other tracking scripts. GTM also performs respects a users cookie choices-->
<script type="text/javascript">
(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KBJGH35');
</script>

</head>

<body id="underlay" data-toggler="nav-open">
<div id="lightbend-banner" class="lightbend-banner akka full-width" data-category="OSS Lightbend Banner Impression" data-label="Akka Banner Impression">
<div class="oss-wrapper">
<div class="oss-brand">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lightbend Logo - Akka Banner" href="https://www.lightbend.com">
<img class="lightbend-logo" src="../images/banner-logos/lightbend-reverse.svg" alt="Lightbend" title="Lightbend">
</a>
</div>
<div class="oss-ad no-drop-down">
<nav id="lightbendRotator" class="lightbend-rotator">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Promo Rotator - Introducing Akka Cloud to Edge Continuum. Build once for the Cloud. Seamlessly deploy to the Edge. [Learn more] - Akka Banner" href="https://www.lightbend.com/blog/akka-edge-unifying-the-cloud-and-edge">
Introducing Akka Cloud to Edge Continuum. Build once for the Cloud. Seamlessly deploy to the Edge. <span class="akka-btn">Learn more</span>
</a>
</nav>
</div>
</div>
</div>

<header class="site-header hide-for-large">
<div class="sticky-header clearfix">
<a href="https://akka.io"><img class="logo" src="../images/akka-logo-reverse.svg"/></a>

<button class="menu-icon float-right" type="button" data-toggle="underlay overlay"></button>
</div>
<div id="overlay" class="overlay-nav" data-toggler="nav-open">
<header class="nav-header">
<div class="nav-header-title">
<h1><a href="../index.html">Akka Edge</a></h1>
</div>
<div class="nav-header-version">
Version 1.5.2
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="nav-toc">
<ul>
  <li><a href="../overview.html" class="page">Architectural Overview</a></li>
  <li><a href="../use-cases.html" class="page">Example Use Cases</a></li>
  <li><a href="../feature-summary.html" class="page">Feature Summary</a></li>
  <li><a href="../guide.html" class="page">Guide - Java/Scala</a></li>
  <li><a href="../guide-rs.html" class="page">Guide - Rust</a>
  <ul>
    <li><a href="../guide-rs/1-setup.html" class="page">Getting started</a></li>
    <li><a href="../guide-rs/2-running.html" class="page">Running the sample</a></li>
    <li><a href="../guide-rs/3-temperature-entity.html#the-temperature-entity" class="active page">The temperature entity</a>
    <ul>
      <li><a href="../guide-rs/3-temperature-entity.html#commands-and-events" class="header">Commands and events</a></li>
      <li><a href="../guide-rs/3-temperature-entity.html#state" class="header">State</a></li>
      <li><a href="../guide-rs/3-temperature-entity.html#behavior" class="header">Behavior</a></li>
      <li><a href="../guide-rs/3-temperature-entity.html#serialization-and-storage" class="header">Serialization and storage</a></li>
      <li><a href="../guide-rs/3-temperature-entity.html#compaction" class="header">Compaction</a></li>
      <li><a href="../guide-rs/3-temperature-entity.html#the-file-log-adapter" class="header">The file log adapter</a></li>
      <li><a href="../guide-rs/3-temperature-entity.html#running-the-entity-manager" class="header">Running the entity manager</a></li>
      <li><a href="../guide-rs/3-temperature-entity.html#putting-it-all-together" class="header">Putting it all together</a></li>
      <li><a href="../guide-rs/3-temperature-entity.html#whats-next-" class="header">What&rsquo;s next?</a></li>
    </ul></li>
    <li><a href="../guide-rs/4-registration-projection.html" class="page">Consuming registration events</a></li>
    <li><a href="../guide-rs/5-temperature-production.html" class="page">Producing temperature events</a></li>
    <li><a href="../guide-rs/6-temperature-production-http.html" class="page">HTTP temperature events</a></li>
    <li><a href="../guide-rs/7-udp-consumption.html" class="page">UDP observations</a></li>
    <li><a href="../guide-rs/8-main.html" class="page">The main function</a></li>
  </ul></li>
  <li><a href="../lightweight-deployments.html" class="page">Lightweight deployments</a></li>
</ul>
</nav>
</div>
</header>
<div class="site-content-wrapper">
<aside class="sticky-sidebar show-for-large">
<header class="nav-header sticky-sidebar-header">
<div class="nav-header-title">
<h1><a href="../index.html">Akka Edge</a></h1>
</div>
<div class="nav-header-version">
Version 1.5.2
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="site-nav sticky-sidebar-contents">
<div class="nav-toc">
<ul>
  <li><a href="../overview.html" class="page">Architectural Overview</a></li>
  <li><a href="../use-cases.html" class="page">Example Use Cases</a></li>
  <li><a href="../feature-summary.html" class="page">Feature Summary</a></li>
  <li><a href="../guide.html" class="page">Guide - Java/Scala</a></li>
  <li><a href="../guide-rs.html" class="page">Guide - Rust</a>
  <ul>
    <li><a href="../guide-rs/1-setup.html" class="page">Getting started</a></li>
    <li><a href="../guide-rs/2-running.html" class="page">Running the sample</a></li>
    <li><a href="../guide-rs/3-temperature-entity.html#the-temperature-entity" class="active page">The temperature entity</a>
    <ul>
      <li><a href="../guide-rs/3-temperature-entity.html#commands-and-events" class="header">Commands and events</a></li>
      <li><a href="../guide-rs/3-temperature-entity.html#state" class="header">State</a></li>
      <li><a href="../guide-rs/3-temperature-entity.html#behavior" class="header">Behavior</a></li>
      <li><a href="../guide-rs/3-temperature-entity.html#serialization-and-storage" class="header">Serialization and storage</a></li>
      <li><a href="../guide-rs/3-temperature-entity.html#compaction" class="header">Compaction</a></li>
      <li><a href="../guide-rs/3-temperature-entity.html#the-file-log-adapter" class="header">The file log adapter</a></li>
      <li><a href="../guide-rs/3-temperature-entity.html#running-the-entity-manager" class="header">Running the entity manager</a></li>
      <li><a href="../guide-rs/3-temperature-entity.html#putting-it-all-together" class="header">Putting it all together</a></li>
      <li><a href="../guide-rs/3-temperature-entity.html#whats-next-" class="header">What&rsquo;s next?</a></li>
    </ul></li>
    <li><a href="../guide-rs/4-registration-projection.html" class="page">Consuming registration events</a></li>
    <li><a href="../guide-rs/5-temperature-production.html" class="page">Producing temperature events</a></li>
    <li><a href="../guide-rs/6-temperature-production-http.html" class="page">HTTP temperature events</a></li>
    <li><a href="../guide-rs/7-udp-consumption.html" class="page">UDP observations</a></li>
    <li><a href="../guide-rs/8-main.html" class="page">The main function</a></li>
  </ul></li>
  <li><a href="../lightweight-deployments.html" class="page">Lightweight deployments</a></li>
</ul>
</div>
</nav>
<footer class="nav-footer sticky-sidebar-footer">
<a href="https://akka.io"><img class="logo" src="../images/akka-logo-reverse.svg"/></a>

</footer>
</aside>
<main class="fixed-shift-for-large expanded row">
<section class="site-content small-12 column">
<article class="page-content row">
<div class="small-12 column" id="docs">
<h1><a href="#the-temperature-entity" name="the-temperature-entity" class="anchor"><span class="anchor-link"></span></a>The temperature entity</h1>
<p>As the other features of Akka Edge are build on top of Event Sourcing, let us start by implementing a digital twin for temperature sensors using the same approach as the <a href="https://doc.akka.io/docs/akka/2.9/typed/persistence.html">Akka Event Sourced Behavior API</a>, but written using Akka Edge Rust. </p>
<p>We will represent a temperature sensor as an Event Sourced entity. If you are unfamiliar with Event Sourcing, refer to the <a href="https://developer.lightbend.com/docs/akka-guide/microservices-tutorial/">Event Sourcing section in the Akka guide</a> for an explanation. The <a href="https://akka.io/blog/news/2020/01/07/akka-event-sourcing-video">Event Sourcing with Akka video</a> is also a good starting point for learning about Event Sourcing.</p>
<h2><a href="#commands-and-events" name="commands-and-events" class="anchor"><span class="anchor-link"></span></a>Commands and events</h2>
<p>Commands are the public API of an entity that other parts of the system use to interact with it. Entity state can only be changed by an entity&rsquo;s events as a result of commands. A command can request state changes, and different events might be generated depending on the current state of the entity. A command can also be rejected if it has invalid input or cannot be handled due to the current state of the entity.</p>
<p>The Temperature sensor accepts three commands: <code>Post</code>, and <code>Register</code>, for retrieving the current state, posting a new temperature observation, and registering a sensor respectively. When posting a new observation, a <code>TemperatureRead</code> is emitted and then persisted in a local event journal. Any <code>Post</code> command where a sensor has not been registered will be ignored.</p>
<p>The definition of the commands looks like this:</p>
<dl>
  <dt>Rust</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/iot-service-rs/backend/src/temperature.rs#L27-L30" target="_blank" title="Go to snippet source">source</a><code class="language-rs">pub enum Command {
    Post { temperature: u32 },
    Register { secret: SecretDataValue },
}</code></pre></dd>
</dl>
<p>Temperature values in our sample are represented as integers, which is often the convention when receiving small packets of data from sensors. Quite often, sensors communicate over a very low bandwidth connection. The less bits to transmit, the more chance a sensor&rsquo;s data will reach its destination, particularly over Low-Powered-Wide-Area-Networks (<a href="https://en.wikipedia.org/wiki/Low-power_wide-area_network">LPWANs</a>).</p>
<p>The registration command conveys a <code>SecretDataValue</code> which, in our case, is a hexadecimal string that will be conveyed out-of-band, via Akka Edge JVM. These types of secrets are often used by sensors to produce a &ldquo;session key&rdquo; that both a sensor can encrypt with, and an edge service can decrypt with. For example, <a href="https://en.wikipedia.org/wiki/CCM_mode">AES-CCM 128 bit encryption</a> is often used to provide authentication and validation of the message. To keep things simple, our sample does nothing more with the secret than accepting temperature observations given the presence of it.</p>
<h3><a href="#a-shared-model" name="a-shared-model" class="anchor"><span class="anchor-link"></span></a>A shared model</h3>
<p>The definition of the events is in a separate module so that it they can be shared with a browser-based application, a &ldquo;frontend&rdquo;. Sharing the data structures improves code maintenance and the assurance that the frontend and backend will continue to be compatible with each other. The event declarations look like this: </a></p>
<dl>
  <dt>Rust</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/iot-service-rs/model/src/temperature.rs#L42-L46" target="_blank" title="Go to snippet source">source</a><code class="language-rs">#[derive(Clone, Deserialize, Serialize)]
pub enum Event {
    Registered { secret: SecretDataValue },
    TemperatureRead { temperature: u32 },
}</code></pre></dd>
</dl>
<p>As events are persisted in a local event journal, we use <a href="https://serde.rs/">Serde</a> declarations to generate code for serializing and deserializing the events to and from bytes. Events are also required to be cloneable so that they may be processed by various handlers e.g. when sending an event via gRPC.</p>
<h2><a href="#state" name="state" class="anchor"><span class="anchor-link"></span></a>State</h2>
<p>Up to 10 temperature observations are kept in memory. The amount of history to be retained in memory is an application-specific concern, and will depend on the amount of memory to be reserved also considering the number of entities held in memory at any one time.</p>
<p>Here is the declaration of the state structure, again in a separate module so that it can be shared between the frontend and the backend of the sample:</p>
<dl>
  <dt>Rust</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/iot-service-rs/model/src/temperature.rs#L12-L18" target="_blank" title="Go to snippet source">source</a><code class="language-rs">const MAX_HISTORY_EVENTS: usize = 10;

#[derive(Default)]
pub struct State {
    pub history: VecDeque&lt;u32&gt;,
    pub secret: SecretDataValue,
}</code></pre></dd>
</dl>
<p>We use a <a href="https://doc.rust-lang.org/std/collections/struct.VecDeque.html"><code>VecDeque</code></a> for history as we can add and remove observations from the queue in constant time. The implementation of <code>State</code> shows how this is put to effect with a method that updates it given an event: </p>
<dl>
  <dt>Rust</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/iot-service-rs/model/src/temperature.rs#L22-L36" target="_blank" title="Go to snippet source">source</a><code class="language-rs">impl State {
    pub fn on_event(&amp;mut self, _context: &amp;Context, event: Event) {
        match event {
            Event::Registered { secret } =&gt; {
                self.secret = secret;
            }
            Event::TemperatureRead { temperature } =&gt; {
                if self.history.len() == MAX_HISTORY_EVENTS {
                    self.history.pop_front();
                }
                self.history.push_back(temperature);
            }
        }
    }
}</code></pre></dd>
</dl>
<p>This method will be called by our backend&rsquo;s entity behavior declaration described in the next section. It is also used by the frontend to construct the state it requires to display to our user.</p>
<h2><a href="#behavior" name="behavior" class="anchor"><span class="anchor-link"></span></a>Behavior</h2>
<p>The temperature entity will receive commands and produce &ldquo;effects&rdquo; that an &ldquo;entity manager&rdquo; will apply. These effects can cause events to be emitted and then persisted to an event journal.</p>
<p>The structure for our temperature entity is as follows:</p>
<dl>
  <dt>Rust</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/iot-service-rs/backend/src/temperature.rs#L34" target="_blank" title="Go to snippet source">source</a><code class="language-rs">pub struct Behavior;</code></pre></dd>
</dl>
<p>An entity behavior declaration associates the types used for the state, commands, and events of an entity instances. The declaration also includes how the entity&rsquo;s commands are processed, and how events are applied to state. Note that it is impossible to update state from a command handler as it is immutable by design. Updating state only via the event handler enables entities to be sourced from their stored events without effects.</p>
<p>Here is the behavior declaration of our entity, noting that the event handler is calling upon <a href="#a-shared-model">a shared model declaration described earlier</a>:</p>
<dl>
  <dt>Rust</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/iot-service-rs/backend/src/temperature.rs#L38-L64" target="_blank" title="Go to snippet source">source</a><code class="language-rs">impl EventSourcedBehavior for Behavior {
    type State = State;

    type Command = Command;

    type Event = Event;

    fn for_command(
        _context: &amp;Context,
        state: &amp;Self::State,
        command: Self::Command,
    ) -&gt; Box&lt;dyn Effect&lt;Self&gt;&gt; {
        match command {
            Command::Post { temperature } if !state.secret.is_empty() =&gt; {
                persist_event(Event::TemperatureRead { temperature }).boxed()
            }

            Command::Register { secret } =&gt; persist_event(Event::Registered { secret }).boxed(),

            _ =&gt; unhandled(),
        }
    }

    fn on_event(context: &amp;Context, state: &amp;mut Self::State, event: Self::Event) {
        state.on_event(context, event);
    }
}</code></pre></dd>
</dl>
<p>Each command handler declares an effect to be performed. When posting an observation in our sample, the <code>TemperatureRead</code> event is persisted.</p>
<h2><a href="#serialization-and-storage" name="serialization-and-storage" class="anchor"><span class="anchor-link"></span></a>Serialization and storage</h2>
<p>The events of the entity must be serializable because they are written to an event journal. We are using the <a href="https://github.com/streambed/streambed-rs/tree/main/streambed-logged">Streambed Logged</a> commit log as an event journal. Streambed Logged has a particular emphasis on managing limited amounts of storage. The notion of &ldquo;compaction&rdquo; is important to Streambed Logged, and ensures that only so many records of a given event type for a given entity id are retained over time. Akka Edge Rust provides a crate to support Streambed Logged, but we must still describe how to marshal our events to and from it. The following code illustrates this: </p>
<dl>
  <dt>Rust</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/iot-service-rs/backend/src/temperature.rs#L68-L86" target="_blank" title="Go to snippet source">source</a><code class="language-rs">// A namespace for our entity&#39;s events when constructing persistence ids.
pub const ENTITY_TYPE: &amp;str = &quot;Sensor&quot;;

pub fn marshaller(
    events_key_secret_path: String,
    secret_store: FileSecretStore,
) -&gt; Marshaller&lt;Event, impl Fn(&amp;Event) -&gt; u32, FileSecretStore&gt; {
    let to_record_type = |event: &amp;Event| match event {
        Event::TemperatureRead { .. } =&gt; 0,
        Event::Registered { .. } =&gt; 1,
    };

    cbor::marshaller(
        EntityType::from(ENTITY_TYPE),
        events_key_secret_path,
        secret_store,
        to_record_type,
    )
}</code></pre></dd>
</dl>
<p>We provide the marshaller as a function so that we can re-use it when projecting events (later).</p>
<p>With the above, Akka Edge Rust provides out-of-the-box functionality to encrypt and decrypt the records of Streamed Logged, and use <a href="https://cbor.io/">CBOR</a> for serialization.</p>
<h2><a href="#compaction" name="compaction" class="anchor"><span class="anchor-link"></span></a>Compaction</h2>
<p>Streambed Logged compaction manages the amount of storage consumed by a commit log. Compaction is used to manage the space occupied by storage, which is important, particularly at the edge where resources are limited.</p>
<p>We size compaction to the typical number of devices we expect to have in the system. Note though that it will impact memory, so there is a trade-off. Let&rsquo;s suppose this was some LoRaWAN system and that our gateway cannot handle more than 1,000 devices being connected. We can work out that 1,000 is therefore a reasonable limit. The overhead is small, but should be calculated and measured for a production scenario.</p>
<dl>
  <dt>Rust</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/iot-service-rs/backend/src/temperature.rs#L91-L130" target="_blank" title="Go to snippet source">source</a><code class="language-rs">pub const EVENTS_TOPIC: &amp;str = &quot;temperature&quot;;

const MAX_HISTORY_EVENTS: usize = 10;

// This is the number of keys that &quot;compaction&quot; will produce in one pass. If there are more
// keys than that, then there will be another pass. You should size it to what you think
// is a reasonable number of entities for your application.
const MAX_TOPIC_COMPACTION_KEYS: usize = 1_000;

    let events_topic = Topic::from(EVENTS_TOPIC);

    let mut task_commit_log = commit_log.clone();
    let task_events_topic = events_topic.clone();
    tokio::spawn(async move {
        task_commit_log
            .register_compaction(
                task_events_topic,
                NthKeyBasedRetention::new(MAX_TOPIC_COMPACTION_KEYS, MAX_HISTORY_EVENTS),
            )
            .await
            .unwrap();
    });</code></pre></dd>
</dl>
<p>We register a compaction strategy for our topic such that when we use up 64KB of disk space (the default), we will run compaction in the background so that unwanted events are removed. In our scenario, unwanted events can be removed when the exceed <code>MAX_HISTORY_EVENTS</code> as we do not have a requirement to ever return more than that.</p>
<h2><a href="#the-file-log-adapter" name="the-file-log-adapter" class="anchor"><span class="anchor-link"></span></a>The file log adapter</h2>
<p>This adapter permits us to source events from the commit log and append them to it as they are emitted by an entity.</p>
<dl>
  <dt>Rust</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/iot-service-rs/backend/src/temperature.rs#L134-L139" target="_blank" title="Go to snippet source">source</a><code class="language-rs">let file_log_topic_adapter = CommitLogTopicAdapter::new(
    commit_log,
    marshaller(events_key_secret_path, secret_store),
    &quot;iot-service&quot;,
    events_topic,
);</code></pre></dd>
</dl>
<h2><a href="#running-the-entity-manager" name="running-the-entity-manager" class="anchor"><span class="anchor-link"></span></a>Running the entity manager</h2>
<p>We are now ready to run the entity manager. An entity manager task handles the lifecycle and routing of messages per type of entity.</p>
<dl>
  <dt>Rust</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/iot-service-rs/backend/src/temperature.rs#L143-L145" target="_blank" title="Go to snippet source">source</a><code class="language-rs">let (entity_manager_task, commands) =
    entity_manager::task(Behavior, file_log_topic_adapter, MAX_COMMANDS, MAX_ENTITIES);
let handle = tokio::spawn(entity_manager_task);</code></pre></dd>
</dl>
<p>The above runs the entity manager given a behavior, the commit log adapter, and a means to receive commands via a channel. We inform it of the <code>MAX_COMMANDS</code> that will be buffered before back-pressuring any senders. Similarly, we dimension the &ldquo;working set&rdquo; of entities that are cached in memory at any one time via <code>MAX_ENTITIES</code>. A channel is returned so that we can send commands to entities.</p>
<h2><a href="#putting-it-all-together" name="putting-it-all-together" class="anchor"><span class="anchor-link"></span></a>Putting it all together</h2>
<p>The following code represents putting all of the above together as a task that can be spawned:</p>
<dl>
  <dt>Rust</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/iot-service-rs/backend/src/temperature.rs#L91-L149" target="_blank" title="Go to snippet source">source</a><code class="language-rs">pub const EVENTS_TOPIC: &amp;str = &quot;temperature&quot;;

const MAX_HISTORY_EVENTS: usize = 10;

// This is the number of keys that &quot;compaction&quot; will produce in one pass. If there are more
// keys than that, then there will be another pass. You should size it to what you think
// is a reasonable number of entities for your application.
const MAX_TOPIC_COMPACTION_KEYS: usize = 1_000;

// The maximum number of temperature commands to retain in memory at any one time.
// Exceeding this number will back-pressure any senders of commands.
pub const MAX_COMMANDS: usize = 10;

// The maximum number of temperature entities to retain in memory at any one time.
// Exceeding this number will evict the last entity used and source any new one
// required.
pub const MAX_ENTITIES: usize = 10;

// A task that will be run to manage the temperature sensor.
pub async fn spawn(
    commit_log: FileLog,
    secret_store: FileSecretStore,
    events_key_secret_path: String,
) -&gt; (JoinHandle&lt;io::Result&lt;()&gt;&gt;, mpsc::Sender&lt;Message&lt;Command&gt;&gt;) {

    let events_topic = Topic::from(EVENTS_TOPIC);

    let mut task_commit_log = commit_log.clone();
    let task_events_topic = events_topic.clone();
    tokio::spawn(async move {
        task_commit_log
            .register_compaction(
                task_events_topic,
                NthKeyBasedRetention::new(MAX_TOPIC_COMPACTION_KEYS, MAX_HISTORY_EVENTS),
            )
            .await
            .unwrap();
    });

    let file_log_topic_adapter = CommitLogTopicAdapter::new(
        commit_log,
        marshaller(events_key_secret_path, secret_store),
        &quot;iot-service&quot;,
        events_topic,
    );

    let (entity_manager_task, commands) =
        entity_manager::task(Behavior, file_log_topic_adapter, MAX_COMMANDS, MAX_ENTITIES);
    let handle = tokio::spawn(entity_manager_task);

    (handle, commands)
}</code></pre></dd>
</dl>
<h2><a href="#whats-next-" name="whats-next-" class="anchor"><span class="anchor-link"></span></a>What&rsquo;s next?</h2>
<ul>
  <li>Consuming registration events</li>
</ul>
</div>
</article>
<div class="row">
<div class="small-12 column">
<section class="nav-prev-next row">
<div class="nav-prev small-6 column">
<a href="../guide-rs/2-running.html"><i class="icon-prev"></i> <span class="link-prev">Running the sample</span></a>
</div>
<div class="nav-next small-6 column clearfix">
<a class="float-right" href="../guide-rs/4-registration-projection.html">Consuming registration events <i class="icon-next"></i></a>
</div>
</section>
</div>
</div>
<div class="source-github row">
Found an error in this documentation? The source code for this page can be found <a href="https://github.com/akka/akka-projection/tree/master/akka-edge-docs/src/main/paradox/guide-rs/3-temperature-entity.md">here</a>.
Please feel free to edit and contribute a pull request.
</div>

<footer class="page-footer row clearfix">
<img class="akka-icon float-left show-for-medium" src="../images/akka-icon.svg" />
<section class="copyright">
<div>Akka Edge is available under the <a href="https://www.lightbend.com/akka/license" target="_blank">Business Source License 1.1</a>.</div>
<p class="legal">
&copy; 2011-2024 <a href="https://www.lightbend.com" target="_blank">Lightbend, Inc.</a> |
<a href="https://www.lightbend.com/legal/licenses" target="_blank">Licenses</a> |
<a href="https://www.lightbend.com/legal/terms" target="_blank">Terms</a> |
<a href="https://www.lightbend.com/legal/privacy" target="_blank">Privacy Policy</a> |
<a href="https://akka.io/cookie/" target="_blank">Cookie Listing</a> |
<a class="optanon-toggle-display">Cookie Settings</a>
</p>
</section>

</footer>
</section>
</main>
</div>

<script type="text/javascript" src="../js/scrollsneak.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../js/groups.js"></script>
<script type="text/javascript" src="../js/page.js"></script>
<script type="text/javascript" src="../js/snippets.js"></script>
<script type="text/javascript" src="../js/magellan.js"></script>
<script type="text/javascript" src="../js/metadata-toggle.js"></script>
<script type="text/javascript" src="../js/lbHeader.js"></script>

<style type="text/css">@import "../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(){window.prettyPrint && prettyPrint()});
//]]></script>
<!-- hook for including project specific javascript into the generated docs -->

</body>
</html>
