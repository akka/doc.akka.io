<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Local Drone Delivery Selection &bull; Akka Edge</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="Akka Projection."/>
<link rel="canonical" href="https://doc.akka.io/docs/akka-edge/current/guide/4-local-drone-delivery-selection.html"/>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../lib/foundation/dist/js/foundation.min.js"></script>
<link rel="stylesheet" type="text/css" href="../lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="../lib/foundation/dist/css/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" type="text/css" href="../css/icons.css"/>
<link rel="stylesheet" type="text/css" href="../css/page-8.css"/>
<link rel="stylesheet" type="text/css" href="../css/banner-2.css"/>
<link rel="shortcut icon" href="../images/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="../images/apple-touch-icon.png"/>
<link rel="icon" type="image/png" sizes="32x32" href="../images/favicon-32x32.png"/>
<link rel="icon" type="image/png" sizes="16x16" href="../images/favicon-16x16.png"/>
<link rel="manifest" href="../images/manifest.json"/>
<meta name="msapplication-TileImage" content="../images/mstile-150x150.png"/>
<meta name="msapplication-TileColor" content="#15a9ce"/>
<meta name="theme-color" content="#15a9ce"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) start -->
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js"  type="text/javascript" charset="UTF-8" data-domain-script="28b912e7-09e9-43d5-91e4-3d1897044004" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) end -->
<!-- Google Tag Manager now loads Google Analytics and any other tracking scripts. GTM also performs respects a users cookie choices-->
<script type="text/javascript">
(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KBJGH35');
</script>

</head>

<body id="underlay" data-toggler="nav-open">
<div id="lightbend-banner" class="lightbend-banner akka full-width" data-category="OSS Lightbend Banner Impression" data-label="Akka Banner Impression">
<div class="oss-wrapper">
<div class="oss-brand">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lightbend Logo - Akka Banner" href="https://www.lightbend.com">
<img class="lightbend-logo" src="../images/banner-logos/lightbend-reverse.svg" alt="Lightbend" title="Lightbend">
</a>
</div>
<div class="oss-ad no-drop-down">
<nav id="lightbendRotator" class="lightbend-rotator">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Promo Rotator - Introducing Akka Cloud to Edge Continuum. Build once for the Cloud. Seamlessly deploy to the Edge. [Learn more] - Akka Banner" href="https://www.lightbend.com/blog/akka-edge-unifying-the-cloud-and-edge">
Introducing Akka Cloud to Edge Continuum. Build once for the Cloud. Seamlessly deploy to the Edge. <span class="akka-btn">Learn more</span>
</a>
</nav>
</div>
</div>
</div>

<header class="site-header hide-for-large">
<div class="sticky-header clearfix">
<a href="https://akka.io"><img class="logo" src="../images/akka-logo-reverse.svg"/></a>

<button class="menu-icon float-right" type="button" data-toggle="underlay overlay"></button>
</div>
<div id="overlay" class="overlay-nav" data-toggler="nav-open">
<header class="nav-header">
<div class="nav-header-title">
<h1><a href="../index.html">Akka Edge</a></h1>
</div>
<div class="nav-header-version">
Version 1.5.2
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="nav-toc">
<ul>
  <li><a href="../overview.html" class="page">Architectural Overview</a></li>
  <li><a href="../use-cases.html" class="page">Example Use Cases</a></li>
  <li><a href="../feature-summary.html" class="page">Feature Summary</a></li>
  <li><a href="../guide.html" class="page">Guide - Java/Scala</a>
  <ul>
    <li><a href="../guide/1-local-drone-control-service.html" class="page">Local Drone Control Service</a></li>
    <li><a href="../guide/2-drone-location-to-cloud-service.html" class="page">Coarse Grained Location Replication</a></li>
    <li><a href="../guide/3-restaurant-deliveries-service.html" class="page">Restaurant deliveries</a></li>
    <li><a href="../guide/4-local-drone-delivery-selection.html#local-drone-delivery-selection" class="active page">Local Drone Delivery Selection</a>
    <ul>
      <li><a href="../guide/4-local-drone-delivery-selection.html#replication-of-the-delivery-events" class="header">Replication of the delivery events</a></li>
      <li><a href="../guide/4-local-drone-delivery-selection.html#delivery-queue-actor" class="header">Delivery queue actor</a></li>
      <li><a href="../guide/4-local-drone-delivery-selection.html#consuming-the-delivery-events" class="header">Consuming the delivery events</a></li>
      <li><a href="../guide/4-local-drone-delivery-selection.html#grpc-services" class="header">gRPC services</a></li>
      <li><a href="../guide/4-local-drone-delivery-selection.html#running-the-sample" class="header">Running the sample</a></li>
      <li><a href="../guide/4-local-drone-delivery-selection.html#whats-next-" class="header">What&rsquo;s next?</a></li>
    </ul></li>
    <li><a href="../guide/5-charging-station.html" class="page">Drone Charging Station</a></li>
    <li><a href="../guide/6-deploying-the-services.html" class="page">Deploying the Restaurant Delivery Service</a></li>
  </ul></li>
  <li><a href="../guide-rs.html" class="page">Guide - Rust</a></li>
  <li><a href="../lightweight-deployments.html" class="page">Lightweight deployments</a></li>
</ul>
</nav>
</div>
</header>
<div class="site-content-wrapper">
<aside class="sticky-sidebar show-for-large">
<header class="nav-header sticky-sidebar-header">
<div class="nav-header-title">
<h1><a href="../index.html">Akka Edge</a></h1>
</div>
<div class="nav-header-version">
Version 1.5.2
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="site-nav sticky-sidebar-contents">
<div class="nav-toc">
<ul>
  <li><a href="../overview.html" class="page">Architectural Overview</a></li>
  <li><a href="../use-cases.html" class="page">Example Use Cases</a></li>
  <li><a href="../feature-summary.html" class="page">Feature Summary</a></li>
  <li><a href="../guide.html" class="page">Guide - Java/Scala</a>
  <ul>
    <li><a href="../guide/1-local-drone-control-service.html" class="page">Local Drone Control Service</a></li>
    <li><a href="../guide/2-drone-location-to-cloud-service.html" class="page">Coarse Grained Location Replication</a></li>
    <li><a href="../guide/3-restaurant-deliveries-service.html" class="page">Restaurant deliveries</a></li>
    <li><a href="../guide/4-local-drone-delivery-selection.html#local-drone-delivery-selection" class="active page">Local Drone Delivery Selection</a>
    <ul>
      <li><a href="../guide/4-local-drone-delivery-selection.html#replication-of-the-delivery-events" class="header">Replication of the delivery events</a></li>
      <li><a href="../guide/4-local-drone-delivery-selection.html#delivery-queue-actor" class="header">Delivery queue actor</a></li>
      <li><a href="../guide/4-local-drone-delivery-selection.html#consuming-the-delivery-events" class="header">Consuming the delivery events</a></li>
      <li><a href="../guide/4-local-drone-delivery-selection.html#grpc-services" class="header">gRPC services</a></li>
      <li><a href="../guide/4-local-drone-delivery-selection.html#running-the-sample" class="header">Running the sample</a></li>
      <li><a href="../guide/4-local-drone-delivery-selection.html#whats-next-" class="header">What&rsquo;s next?</a></li>
    </ul></li>
    <li><a href="../guide/5-charging-station.html" class="page">Drone Charging Station</a></li>
    <li><a href="../guide/6-deploying-the-services.html" class="page">Deploying the Restaurant Delivery Service</a></li>
  </ul></li>
  <li><a href="../guide-rs.html" class="page">Guide - Rust</a></li>
  <li><a href="../lightweight-deployments.html" class="page">Lightweight deployments</a></li>
</ul>
</div>
</nav>
<footer class="nav-footer sticky-sidebar-footer">
<a href="https://akka.io"><img class="logo" src="../images/akka-logo-reverse.svg"/></a>

</footer>
</aside>
<main class="fixed-shift-for-large expanded row">
<section class="site-content small-12 column">
<article class="page-content row">
<div class="small-12 column" id="docs">
<h1><a href="#local-drone-delivery-selection" name="local-drone-delivery-selection" class="anchor"><span class="anchor-link"></span></a>Local Drone Delivery Selection</h1>
<p>In the previous step of the guide we implemented the means for the cloud service to keep track of restaurant and the queue of registered deliveries for each.</p>
<p><img src="../images/guide-section-4.svg" alt="Diagram showing delivery replication to the local drone control services" /></p>
<p>We want to replicate the registered events to each local-drone-control PoP so that the drones close to it can pick up orders and perform the deliveries.</p>
<p>Again we will use <a href="https://doc.akka.io/docs/akka-projection/1.5/grpc.html">Akka Projection gRPC</a> to do service-to-service events passing without requiring a message broker in between services. </p>
<p>We will then implement a service allowing the drones to ask the local-drone-control to assign them the closest waiting delivery.</p>
<h2><a href="#replication-of-the-delivery-events" name="replication-of-the-delivery-events" class="anchor"><span class="anchor-link"></span></a>Replication of the delivery events</h2>
<p>First we must set up replication of the events from the restaurant-drone-deliveries-service. </p>
<p>The regular <a href="https://doc.akka.io/docs/akka-projection/1.5/grpc.html">Akka Projection gRPC</a> behavior is that the consumer connects to the producer, in this case the local-drone-control being the consumer connecting to the cloud.</p>
<p>To implement this we define an <code>EventProducerSource</code> and create a gRPC request handler for it. We use a protobuf message that we transform the internal domain event <code>DeliveryRegistered</code> using a <code>Transformation</code>. Any other message type is filtered out and not replicated to the consumers using the <code>orElseMapper</code>:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/restaurant-drone-deliveries-service-scala/src/main/scala/central/deliveries/DeliveryEvents.scala" target="_blank" title="Go to snippet source">source</a><code class="language-scala">package central.deliveries

import akka.actor.typed.ActorSystem
import akka.persistence.query.typed.EventEnvelope
import akka.projection.grpc.producer.EventProducerSettings
import akka.projection.grpc.producer.scaladsl.EventProducer
import akka.projection.grpc.producer.scaladsl.EventProducer.Transformation

import scala.concurrent.Future

object DeliveryEvents {

  def eventProducerSource(
      system: ActorSystem[_]): EventProducer.EventProducerSource = {
    val transformation = Transformation.empty
      .registerAsyncEnvelopeMapper[
        RestaurantDeliveries.DeliveryRegistered,
        proto.DeliveryRegistered](envelope =&gt;
        Future.successful(Some(transformDeliveryRegistration(envelope))))
      // filter all other types of events for the RestaurantDeliveries
      .registerOrElseMapper(_ =&gt; None)

    val eventProducerSource = EventProducer.EventProducerSource(
      RestaurantDeliveries.EntityKey.name,
      // Note: stream id used in consumer to consume this specific stream
      &quot;delivery-events&quot;,
      transformation,
      EventProducerSettings(system))

    eventProducerSource
  }

  private def transformDeliveryRegistration(
      envelope: EventEnvelope[RestaurantDeliveries.DeliveryRegistered])
      : proto.DeliveryRegistered = {
    val delivery = envelope.event.delivery
    proto.DeliveryRegistered(
      deliveryId = delivery.deliveryId,
      origin = Some(delivery.origin.toProto),
      destination = Some(delivery.destination.toProto))
  }

}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/restaurant-drone-deliveries-service-java/src/main/java/central/deliveries/DeliveryEvents.java" target="_blank" title="Go to snippet source">source</a><code class="language-java">package central.deliveries;

import akka.actor.typed.ActorSystem;
import akka.persistence.query.typed.EventEnvelope;
import akka.projection.grpc.producer.EventProducerSettings;
import akka.projection.grpc.producer.javadsl.EventProducerSource;
import akka.projection.grpc.producer.javadsl.Transformation;
import central.deliveries.proto.DeliveryRegistered;
import java.util.Optional;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.CompletionStage;

public final class DeliveryEvents {

  // Note: stream id used in consumer to consume this specific stream
  public static final String STREAM_ID = &quot;delivery-events&quot;;

  public static EventProducerSource eventProducerSource(ActorSystem&lt;?&gt; system) {
    var transformation =
        Transformation.empty()
            .registerAsyncEnvelopeMapper(
                RestaurantDeliveries.DeliveryRegistered.class,
                DeliveryEvents::transformDeliveryRegistration)
            // exclude all other types of events for the RestaurantDeliveries
            .registerOrElseMapper(envelope -&gt; Optional.empty());

    return new EventProducerSource(
        RestaurantDeliveries.ENTITY_KEY.name(),
        STREAM_ID,
        transformation,
        EventProducerSettings.create(system));
  }

  private static CompletionStage&lt;Optional&lt;DeliveryRegistered&gt;&gt; transformDeliveryRegistration(
      EventEnvelope&lt;RestaurantDeliveries.DeliveryRegistered&gt; envelope) {
    var delivery = envelope.event().delivery;
    return CompletableFuture.completedFuture(
        Optional.of(
            central.deliveries.proto.DeliveryRegistered.newBuilder()
                .setDeliveryId(delivery.deliveryId)
                .setOrigin(delivery.origin.toProto())
                .setDestination(delivery.destination.toProto())
                .build()));
  }
}</code></pre></dd>
</dl>
<p>The gRPC request handler is composed with the other gRPC handlers of the service into a single bound server:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/restaurant-drone-deliveries-service-scala/src/main/scala/central/DroneDeliveriesServer.scala#L35-L47" target="_blank" title="Go to snippet source">source</a><code class="language-scala">val service = ServiceHandler.concatOrNotFound(
  DroneOverviewServiceHandler.partial(droneOverviewService),
  RestaurantDeliveriesServiceHandler.partial(restaurantDeliveriesService),
  ChargingStationServiceHandler.partial(chargingStationService),
  eventPullHandler,
  eventPushHandler,
  ServerReflection.partial(
    List(
      DroneOverviewService,
      RestaurantDeliveriesService,
      ChargingStationService)))

val bound = Http(system).newServerAt(interface, port).bind(service)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/restaurant-drone-deliveries-service-java/src/main/java/central/DroneDeliveriesServer.java#L37-L52" target="_blank" title="Go to snippet source">source</a><code class="language-java">@SuppressWarnings(&quot;unchecked&quot;)
var service =
    ServiceHandler.concatOrNotFound(
        DroneOverviewServiceHandlerFactory.create(droneOverviewService, system),
        RestaurantDeliveriesServiceHandlerFactory.create(restaurantDeliveriesService, system),
        ChargingStationServiceHandlerFactory.create(chargingStationService, system),
        eventPullHandler,
        eventPushHandler,
        ServerReflection.create(
            List.of(
                DroneOverviewService.description,
                RestaurantDeliveriesService.description,
                ChargingStationService.description),
            system));

var bound = Http.get(system).newServerAt(host, port).bind(service);</code></pre></dd>
</dl>
<p>Since we expect a high number of local-drone-control edge systems connecting to the restaurant-drone-deliveries-service to consume the restaurant orders we configure the <a href="https://doc.akka.io/docs/akka/2.9/persistence-query.html#eventsbyslice-and-currenteventsbyslice">events-by-slice-firehose</a> for the projection. The firehose tries to share the stream of events across consumers connected to the same node, instead of each consumer executing its queries in parallel, so that less load is applied to the database.</p>
<p>The firehose is enabled through the following configuration selecting it as query-plugin-id for the <code>akka.projection.grpcproducer</code> and then configuring the actual underlying <code>akka.persistence.r2dbc.query</code> as query plugin for the firehose:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/restaurant-drone-deliveries-service-scala/src/main/resources/persistence.conf#L40-L50" target="_blank" title="Go to snippet source">source</a><code class="language-conf">akka.projection.grpc {
  producer {
    # use the firehose for order events so that the local-drone-control consumers
    # shares the same firehose instead of each lead to load on the database
    query-plugin-id = &quot;akka.persistence.query.events-by-slice-firehose&quot;
  }
}

akka.persistence.query.events-by-slice-firehose {
  delegate-query-plugin-id = &quot;akka.persistence.r2dbc.query&quot;
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/restaurant-drone-deliveries-service-java/src/main/resources/persistence.conf#L40-L50" target="_blank" title="Go to snippet source">source</a><code class="language-conf">akka.projection.grpc {
  producer {
    # use the firehose for order events so that the local-drone-control consumers
    # shares the same firehose instead of each lead to load on the database
    query-plugin-id = &quot;akka.persistence.query.events-by-slice-firehose&quot;
  }
}

akka.persistence.query.events-by-slice-firehose {
  delegate-query-plugin-id = &quot;akka.persistence.r2dbc.query&quot;
}</code></pre></dd>
</dl>
<h2><a href="#delivery-queue-actor" name="delivery-queue-actor" class="anchor"><span class="anchor-link"></span></a>Delivery queue actor</h2>
<p>The queue of all deliveries for one local-drone-control service is managed by a single durable state actor to keep things simple. </p>
<p>For a high throughput of deliveries, a single actor might become a congestion point and a more clever scheme, for example partitioning the deliveries into multiple queues based on the coarse grained coordinate of the restaurant, could make sense.</p>
<h3><a href="#commands-and-events" name="commands-and-events" class="anchor"><span class="anchor-link"></span></a>Commands and events</h3>
<p>The actor accepts the command <code>AddDelivery</code> to enqueue a delivery, the commands <code>RequestDelivery</code> and <code>CompleteDelivery</code> for drones to pick up and complete deliveries and <code>GetCurrentState</code> for us to be able to inspect the current state of the queue:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-scala/src/main/scala/local/drones/DeliveriesQueue.scala#L19-L38" target="_blank" title="Go to snippet source">source</a><code class="language-scala">sealed trait Command extends CborSerializable

final case class AddDelivery(
    waitingDelivery: WaitingDelivery,
    replyTo: ActorRef[Done])
    extends Command

final case class RequestDelivery(
    droneId: String,
    droneCoordinates: Coordinates,
    replyTo: ActorRef[StatusReply[WaitingDelivery]])
    extends Command

final case class CompleteDelivery(
    deliveryId: String,
    replyTo: ActorRef[StatusReply[Done]])
    extends Command

final case class GetCurrentState(replyTo: ActorRef[State]) extends Command
</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-java/src/main/java/local/drones/DeliveriesQueue.java#L27-L72" target="_blank" title="Go to snippet source">source</a><code class="language-java">public interface Command extends CborSerializable {}

public static final class AddDelivery implements Command {
  public final WaitingDelivery delivery;
  public final ActorRef&lt;Done&gt; replyTo;

  public AddDelivery(WaitingDelivery delivery, ActorRef&lt;Done&gt; replyTo) {
    this.delivery = delivery;
    this.replyTo = replyTo;
  }
}

public static final class RequestDelivery implements Command {
  public final String droneId;
  public final Coordinates droneCoordinates;
  public final ActorRef&lt;StatusReply&lt;WaitingDelivery&gt;&gt; replyTo;

  public RequestDelivery(
      String droneId,
      Coordinates droneCoordinates,
      ActorRef&lt;StatusReply&lt;WaitingDelivery&gt;&gt; replyTo) {
    this.droneId = droneId;
    this.droneCoordinates = droneCoordinates;
    this.replyTo = replyTo;
  }
}

public static final class CompleteDelivery implements Command {
  public final String deliveryId;
  public final ActorRef&lt;StatusReply&lt;Done&gt;&gt; replyTo;

  public CompleteDelivery(String deliveryId, ActorRef&lt;StatusReply&lt;Done&gt;&gt; replyTo) {
    this.deliveryId = deliveryId;
    this.replyTo = replyTo;
  }
}

public static final class GetCurrentState implements Command {
  public final ActorRef&lt;State&gt; replyTo;

  @JsonCreator
  public GetCurrentState(ActorRef&lt;State&gt; replyTo) {
    this.replyTo = replyTo;
  }
}
</code></pre></dd>
</dl>
<h3><a href="#state" name="state" class="anchor"><span class="anchor-link"></span></a>State</h3>
<p>In the state of the actor, we keep two lists, one is the waiting queue of deliveries, and one is the currently picked up deliveries, waiting for the drone to report back once the delivery completed:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-scala/src/main/scala/local/drones/DeliveriesQueue.scala#L42-L56" target="_blank" title="Go to snippet source">source</a><code class="language-scala">final case class WaitingDelivery(
    deliveryId: String,
    from: Coordinates,
    to: Coordinates)
    extends CborSerializable

final case class DeliveryInProgress(
    deliveryId: String,
    droneId: String,
    pickupTime: Instant)

final case class State(
    waitingDeliveries: Vector[WaitingDelivery],
    deliveriesInProgress: Vector[DeliveryInProgress])
    extends CborSerializable</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-java/src/main/java/local/drones/DeliveriesQueue.java#L76-L148" target="_blank" title="Go to snippet source">source</a><code class="language-java">public static final class State implements CborSerializable {
  public final List&lt;WaitingDelivery&gt; waitingDeliveries;
  public final List&lt;DeliveryInProgress&gt; deliveriesInProgress;

  public State() {
    waitingDeliveries = new ArrayList&lt;&gt;();
    deliveriesInProgress = new ArrayList&lt;&gt;();
  }

  public State(
      List&lt;WaitingDelivery&gt; waitingDeliveries, List&lt;DeliveryInProgress&gt; deliveriesInProgress) {
    this.waitingDeliveries = waitingDeliveries;
    this.deliveriesInProgress = deliveriesInProgress;
  }
}

public static final class WaitingDelivery implements CborSerializable {
  public final String deliveryId;
  public final Coordinates from;
  public final Coordinates to;

  public WaitingDelivery(String deliveryId, Coordinates from, Coordinates to) {
    this.deliveryId = deliveryId;
    this.from = from;
    this.to = to;
  }

  @Override
  public boolean equals(Object o) {
    if (this == o) return true;
    if (o == null || getClass() != o.getClass()) return false;

    WaitingDelivery that = (WaitingDelivery) o;

    if (!deliveryId.equals(that.deliveryId)) return false;
    if (!from.equals(that.from)) return false;
    return to.equals(that.to);
  }

  @Override
  public int hashCode() {
    int result = deliveryId.hashCode();
    result = 31 * result + from.hashCode();
    result = 31 * result + to.hashCode();
    return result;
  }

  @Override
  public String toString() {
    return &quot;WaitingDelivery{&quot;
        + &quot;deliveryId=&#39;&quot;
        + deliveryId
        + &#39;\&#39;&#39;
        + &quot;, from=&quot;
        + from
        + &quot;, to=&quot;
        + to
        + &#39;}&#39;;
  }
}

public static final class DeliveryInProgress {
  public final String deliveryId;
  public final String droneId;
  public final Instant pickupTime;

  public DeliveryInProgress(String deliveryId, String droneId, Instant pickupTime) {
    this.deliveryId = deliveryId;
    this.droneId = droneId;
    this.pickupTime = pickupTime;
  }
}
</code></pre></dd>
</dl>
<h3><a href="#command-handler" name="command-handler" class="anchor"><span class="anchor-link"></span></a>Command handler</h3>
<p>The command handler de-duplicates orders by id for <code>AddDelivery</code> to avoid duplicates.</p>
<p>When a <code>RequestDelivery</code> comes in, we first check that there are deliveries waiting, and if there are we find the one where the restaurant is closest to the current location of the drone. We then move the delivery from the <code>waitingDeliveries</code> queue to the <code>deliveriesInProgress</code> list, so that it is not selected again for another drone, and persist the state.</p>
<p>For the <code>CompleteDelivery</code> command, the delivery is removed from the state and then the updated state is persisted.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-scala/src/main/scala/local/drones/DeliveriesQueue.scala#L77-L130" target="_blank" title="Go to snippet source">source</a><code class="language-scala">private def onCommand(context: ActorContext[Command])(
    state: State,
    command: Command): Effect[State] =
  command match {
    case AddDelivery(delivery, replyTo) =&gt;
      context.log.info(&quot;Adding delivery [{}] to queue&quot;, delivery.deliveryId)
      if (state.waitingDeliveries.contains(
          delivery) || state.deliveriesInProgress.exists(
          _.deliveryId == delivery.deliveryId))
        Effect.reply(replyTo)(Done)
      else
        Effect
          .persist(
            state.copy(waitingDeliveries =
              state.waitingDeliveries :+ delivery))
          .thenReply(replyTo)(_ =&gt; Done)

    case RequestDelivery(droneId, droneCoordinates, replyTo) =&gt;
      if (state.waitingDeliveries.isEmpty)
        Effect.reply(replyTo)(StatusReply.Error(&quot;No waiting orders&quot;))
      else {
        val closestPickupForDrone = state.waitingDeliveries.minBy(delivery =&gt;
          droneCoordinates.distanceTo(delivery.from))
        context.log.info(
          &quot;Selected next delivery [{}] for drone [{}]&quot;,
          closestPickupForDrone.deliveryId,
          droneId)
        // Note: A real application would have to care more about retries/lost data here
        Effect
          .persist(
            state.copy(
              waitingDeliveries =
                state.waitingDeliveries.filterNot(_ == closestPickupForDrone),
              state.deliveriesInProgress :+ DeliveryInProgress(
                closestPickupForDrone.deliveryId,
                droneId,
                Instant.now())))
          .thenReply(replyTo)(_ =&gt; StatusReply.Success(closestPickupForDrone))
      }

    case CompleteDelivery(deliveryId, replyTo) =&gt;
      if (!state.deliveriesInProgress.exists(_.deliveryId == deliveryId)) {
        Effect.reply(replyTo)(
          StatusReply.Error(s&quot;Unknown delivery id: ${deliveryId}&quot;))
      } else {
        Effect
          .persist(state.copy(deliveriesInProgress =
            state.deliveriesInProgress.filterNot(_.deliveryId == deliveryId)))
          .thenReply(replyTo)(_ =&gt; StatusReply.Success(Done))
      }

    case GetCurrentState(replyTo) =&gt;
      Effect.reply(replyTo)(state)
  }</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-java/src/main/java/local/drones/DeliveriesQueue.java#L179-L254" target="_blank" title="Go to snippet source">source</a><code class="language-java">@Override
public CommandHandler&lt;Command, State&gt; commandHandler() {
  return newCommandHandlerBuilder()
      .forAnyState()
      .onCommand(AddDelivery.class, this::onAddDelivery)
      .onCommand(RequestDelivery.class, this::onRequestDelivery)
      .onCommand(CompleteDelivery.class, this::onCompleteDelivery)
      .onCommand(GetCurrentState.class, this::onGetCurrentState)
      .build();
}

private Effect&lt;State&gt; onAddDelivery(State state, AddDelivery command) {
  context.getLog().info(&quot;Adding delivery [{}] to queue&quot;, command.delivery.deliveryId);
  if (state.waitingDeliveries.contains(command.delivery)
      || state.deliveriesInProgress.stream()
          .anyMatch(
              deliveryInProgress -&gt;
                  deliveryInProgress.deliveryId.equals(command.delivery.deliveryId)))
    return Effect().reply(command.replyTo, done());
  else {
    state.waitingDeliveries.add(command.delivery);
    return Effect().persist(state).thenReply(command.replyTo, updatedState -&gt; done());
  }
}

private Effect&lt;State&gt; onRequestDelivery(State state, RequestDelivery command) {
  if (state.waitingDeliveries.isEmpty()) {
    return Effect().reply(command.replyTo, StatusReply.error(&quot;No waiting orders&quot;));
  } else {
    var closestPickupForDrone =
        state.waitingDeliveries.stream()
            .min(
                Comparator.comparingLong(
                    delivery -&gt; command.droneCoordinates.distanceTo(delivery.from)))
            .get();
    context
        .getLog()
        .info(
            &quot;Selected next delivery [{}] for drone [{}]&quot;,
            closestPickupForDrone.deliveryId,
            command.droneId);
    // Note: A real application would have to care more about retries/lost data here
    state.waitingDeliveries.remove(closestPickupForDrone);
    state.deliveriesInProgress.add(
        new DeliveryInProgress(closestPickupForDrone.deliveryId, command.droneId, Instant.now()));
    return Effect()
        .persist(state)
        .thenReply(command.replyTo, updatedState -&gt; StatusReply.success(closestPickupForDrone));
  }
}

private Effect&lt;State&gt; onCompleteDelivery(State state, CompleteDelivery command) {
  var maybeExisting =
      state.deliveriesInProgress.stream()
          .filter(delivery -&gt; delivery.deliveryId.equals(command.deliveryId))
          .findFirst();
  if (maybeExisting.isEmpty()) {
    return Effect()
        .reply(command.replyTo, StatusReply.error(&quot;Unknown delivery id: &quot; + command.deliveryId));
  } else {
    var existing = maybeExisting.get();
    state.deliveriesInProgress.remove(existing);

    return Effect()
        .persist(state)
        .thenReply(command.replyTo, updatedState -&gt; StatusReply.success(done()));
  }
}

private Effect&lt;State&gt; onGetCurrentState(State state, GetCurrentState command) {
  // defensive copy since state is mutable (individual values in the lists are immutable)
  var stateToShare =
      new State(
          new ArrayList&lt;&gt;(state.waitingDeliveries), new ArrayList&lt;&gt;(state.deliveriesInProgress));
  return Effect().reply(command.replyTo, stateToShare);
}</code></pre></dd>
</dl>
<h2><a href="#consuming-the-delivery-events" name="consuming-the-delivery-events" class="anchor"><span class="anchor-link"></span></a>Consuming the delivery events</h2>
<p>To consume the stream of delivery events from the central cloud we need to set up a projection. We only want to consume the events for the location id of the particular local-drone-control service, this is done through a consumer filter first excluding all events and then selecting only the events for the configured location id:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-scala/src/main/scala/local/drones/DeliveryEvents.scala" target="_blank" title="Go to snippet source">source</a><code class="language-scala">package local.drones

import akka.actor.typed.{ ActorRef, ActorSystem, Behavior }
import akka.grpc.GrpcClientSettings
import akka.persistence.Persistence
import akka.persistence.query.typed.EventEnvelope
import akka.projection.eventsourced.scaladsl.EventSourcedProvider
import akka.projection.grpc.consumer.{ ConsumerFilter, GrpcQuerySettings }
import akka.projection.grpc.consumer.scaladsl.GrpcReadJournal
import akka.projection.r2dbc.scaladsl.R2dbcProjection
import akka.projection.scaladsl.Handler
import akka.projection.{ ProjectionBehavior, ProjectionId }
import akka.util.Timeout

/**
 * Consume delivery events from the cloud and pass to the delivery queue actor
 */
object DeliveryEvents {

  def projectionBehavior(
      queueActor: ActorRef[DeliveriesQueue.Command],
      settings: Settings)(
      implicit system: ActorSystem[_]): Behavior[ProjectionBehavior.Command] = {
    val projectionName: String = &quot;delivery-events&quot;

    implicit val timeout: Timeout = settings.askTimeout

    val eventsBySlicesQuery =
      GrpcReadJournal(
        GrpcQuerySettings(system).withInitialConsumerFilter(
          // location id already is in the format of a topic filter expression
          Vector(
            ConsumerFilter.excludeAll,
            ConsumerFilter.IncludeTopics(Set(settings.locationId)))),
        GrpcClientSettings.fromConfig(
          system.settings.config
            .getConfig(&quot;akka.projection.grpc.consumer.client&quot;)),
        List(central.deliveries.proto.DeliveryEventsProto.javaDescriptor))

    // single projection handling all slices
    val sliceRanges =
      Persistence(system).sliceRanges(1)
    val sliceRange = sliceRanges(0)
    val projectionKey =
      s&quot;${eventsBySlicesQuery.streamId}-${sliceRange.min}-${sliceRange.max}&quot;
    val projectionId = ProjectionId.of(projectionName, projectionKey)

    val sourceProvider = EventSourcedProvider
      .eventsBySlices[central.deliveries.proto.DeliveryRegistered](
        system,
        eventsBySlicesQuery,
        eventsBySlicesQuery.streamId,
        sliceRange.min,
        sliceRange.max)

    import akka.actor.typed.scaladsl.AskPattern._
    val handler: Handler[
      EventEnvelope[central.deliveries.proto.DeliveryRegistered]] = {
      envelope =&gt;
        queueActor.ask(
          DeliveriesQueue.AddDelivery(
            DeliveriesQueue.WaitingDelivery(
              deliveryId = envelope.event.deliveryId,
              from = Coordinates.fromProto(envelope.event.origin.get),
              to = Coordinates.fromProto(envelope.event.destination.get)),
            _))
    }

    ProjectionBehavior(
      R2dbcProjection
        .atLeastOnceAsync(projectionId, None, sourceProvider, () =&gt; handler))

  }

}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-java/src/main/java/local/drones/DeliveryEvents.java" target="_blank" title="Go to snippet source">source</a><code class="language-java">package local.drones;

import static akka.actor.typed.javadsl.AskPattern.*;

import akka.Done;
import akka.actor.typed.ActorRef;
import akka.actor.typed.ActorSystem;
import akka.actor.typed.Behavior;
import akka.grpc.GrpcClientSettings;
import akka.persistence.Persistence;
import akka.persistence.query.typed.EventEnvelope;
import akka.projection.ProjectionBehavior;
import akka.projection.ProjectionId;
import akka.projection.eventsourced.javadsl.EventSourcedProvider;
import akka.projection.grpc.consumer.ConsumerFilter;
import akka.projection.grpc.consumer.GrpcQuerySettings;
import akka.projection.grpc.consumer.javadsl.GrpcReadJournal;
import akka.projection.javadsl.Handler;
import akka.projection.r2dbc.javadsl.R2dbcProjection;
import central.deliveries.proto.DeliveryRegistered;
import java.util.Arrays;
import java.util.Collections;
import java.util.Optional;

/** Consume delivery events from the cloud and pass to the delivery queue actor */
public class DeliveryEvents {

  public static Behavior&lt;ProjectionBehavior.Command&gt; projectionBehavior(
      ActorSystem&lt;?&gt; system, ActorRef&lt;DeliveriesQueue.Command&gt; queueActor, Settings settings) {
    var projectionName = &quot;delivery-events&quot;;

    var eventsBySlicesQuery =
        GrpcReadJournal.create(
            system,
            GrpcQuerySettings.create(system)
                .withInitialConsumerFilter(
                    // location id already is in the format of a topic filter expression
                    Arrays.asList(
                        ConsumerFilter.excludeAll(),
                        new ConsumerFilter.IncludeTopics(
                            Collections.singleton(settings.locationId)))),
            GrpcClientSettings.fromConfig(
                system.settings().config().getConfig(&quot;akka.projection.grpc.consumer.client&quot;),
                system),
            Arrays.asList(central.deliveries.proto.DeliveryEvents.getDescriptor()));

    // single projection handling all slices
    var sliceRanges = Persistence.get(system).getSliceRanges(1);
    var sliceRange = sliceRanges.get(0);
    var projectionKey =
        eventsBySlicesQuery.streamId() + &quot;-&quot; + sliceRange.first() + &quot;-&quot; + sliceRange.second();

    var projectionId = ProjectionId.of(projectionName, projectionKey);

    var sourceProvider =
        EventSourcedProvider.&lt;central.deliveries.proto.DeliveryRegistered&gt;eventsBySlices(
            system,
            eventsBySlicesQuery,
            eventsBySlicesQuery.streamId(),
            sliceRange.first(),
            sliceRange.second());

    var handler =
        Handler.fromFunction(
            (EventEnvelope&lt;DeliveryRegistered&gt; envelope) -&gt;
                ask(
                    queueActor,
                    (ActorRef&lt;Done&gt; replyTo) -&gt;
                        new DeliveriesQueue.AddDelivery(
                            new DeliveriesQueue.WaitingDelivery(
                                envelope.event().getDeliveryId(),
                                Coordinates.fromProto(envelope.event().getOrigin()),
                                Coordinates.fromProto(envelope.event().getDestination())),
                            replyTo),
                    settings.askTimeout,
                    system.scheduler()));

    return ProjectionBehavior.create(
        R2dbcProjection.atLeastOnceAsync(
            projectionId, Optional.empty(), sourceProvider, () -&gt; handler, system));
  }
}</code></pre></dd>
</dl>
<h2><a href="#grpc-services" name="grpc-services" class="anchor"><span class="anchor-link"></span></a>gRPC services</h2>
<h3><a href="#drone-deliveries" name="drone-deliveries" class="anchor"><span class="anchor-link"></span></a>Drone deliveries</h3>
<p>The method for drones to select the next delivery, and to complete it are added to the existing drone service:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-scala/src/main/protobuf/local/drones/drone_api.proto" target="_blank" title="Go to snippet source">source</a><code class="language-proto">syntax = &quot;proto3&quot;;

option java_multiple_files = true;
option java_package = &quot;local.drones.proto&quot;;

import &quot;google/protobuf/empty.proto&quot;;
import &quot;google/protobuf/timestamp.proto&quot;;
import &quot;common/coordinates.proto&quot;;

package local.drones;

// gRPC definition for DroneService, for drones to interact with

service DroneService {
    rpc ReportLocation (ReportLocationRequest) returns (google.protobuf.Empty) {}

    // deliveries
    rpc RequestNextDelivery (RequestNextDeliveryRequest) returns (RequestNextDeliveryResponse) {}
    rpc CompleteDelivery (CompleteDeliveryRequest) returns (google.protobuf.Empty) {}

    // charging
    rpc GoCharge (GoChargeRequest) returns (ChargingResponse) {}
    rpc CompleteCharge (CompleteChargeRequest) returns (CompleteChargingResponse) {}
}


message ReportLocationRequest {
    string drone_id = 1;
    common.Coordinates coordinates = 2;
    // altitude in meters
    double altitude = 4;
}

message RequestNextDeliveryRequest {
    string drone_id = 1;
}

message RequestNextDeliveryResponse {
    string delivery_id = 1;
    common.Coordinates from = 2;
    common.Coordinates to = 3;
}

message CompleteDeliveryRequest {
    string delivery_id = 1;
}

message GoChargeRequest {
    string drone_id = 1;
    string charging_station_id = 2;
}

message ChargingResponse {
    oneof response {
        ChargingStarted started = 1;
        ComeBackLater come_back_later = 2;
    };
}

message ChargingStarted {
    google.protobuf.Timestamp expected_complete = 1;
}

message ComeBackLater {
    google.protobuf.Timestamp first_slot_free_at = 1;
}

message CompleteChargeRequest {
    string charging_station_id = 1;
    string drone_id = 2;
}

message CompleteChargingResponse {
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-java/src/main/protobuf/local/drones/drone_api.proto" target="_blank" title="Go to snippet source">source</a><code class="language-proto">syntax = &quot;proto3&quot;;

option java_multiple_files = true;
option java_package = &quot;local.drones.proto&quot;;

import &quot;common/coordinates.proto&quot;;
import &quot;google/protobuf/timestamp.proto&quot;;

package local.drones;

// gRPC definition for DroneService, for drones to interact with

service DroneService {
    rpc ReportLocation (ReportLocationRequest) returns (ReportLocationResponse) {}

    // deliveries
    rpc RequestNextDelivery (RequestNextDeliveryRequest) returns (RequestNextDeliveryResponse) {}
    rpc CompleteDelivery (CompleteDeliveryRequest) returns (CompleteDeliveryResponse) {}

    // charging
    rpc GoCharge (GoChargeRequest) returns (ChargingResponse) {}
    rpc CompleteCharge (CompleteChargeRequest) returns (CompleteChargingResponse) {}
}


message ReportLocationRequest {
    string drone_id = 1;
    common.Coordinates coordinates = 2;
    // altitude in meters
    double altitude = 4;
}

message ReportLocationResponse {
}

message RequestNextDeliveryRequest {
    string drone_id = 1;
}

message RequestNextDeliveryResponse {
    string delivery_id = 1;
    common.Coordinates from = 2;
    common.Coordinates to = 3;
}

message CompleteDeliveryRequest {
    string delivery_id = 1;
}

message CompleteDeliveryResponse {
}

message GoChargeRequest {
    string drone_id = 1;
    string charging_station_id = 2;
}

message ChargingResponse {
    oneof response {
        ChargingStarted started = 1;
        ComeBackLater come_back_later = 2;
    };
}

message ChargingStarted {
    google.protobuf.Timestamp expected_complete = 1;
}

message ComeBackLater {
    google.protobuf.Timestamp first_slot_free_at = 1;
}

message CompleteChargeRequest {
    string charging_station_id = 1;
    string drone_id = 2;
}

message CompleteChargingResponse {
}</code></pre></dd>
</dl>
<p>Implementation of the generated service interface:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-scala/src/main/scala/local/drones/DroneServiceImpl.scala" target="_blank" title="Go to snippet source">source</a><code class="language-scala">package local.drones

import akka.Done
import akka.actor.typed.scaladsl.AskPattern._
import akka.actor.typed.{ ActorRef, ActorSystem }
import akka.cluster.sharding.typed.scaladsl.ClusterSharding
import akka.cluster.sharding.typed.scaladsl.EntityRef
import akka.grpc.GrpcServiceException
import akka.util.Timeout
import charging.ChargingStation
import com.google.protobuf.empty.Empty
import com.google.protobuf.timestamp.Timestamp
import io.grpc.Status
import org.slf4j.LoggerFactory
import local.drones.proto

import scala.concurrent.Future
import scala.concurrent.TimeoutException

class DroneServiceImpl(
    deliveriesQueue: ActorRef[DeliveriesQueue.Command],
    chargingStationEntityRefFactory: String =&gt; EntityRef[
      ChargingStation.Command],
    settings: Settings)(implicit system: ActorSystem[_])
    extends proto.DroneService {

  import system.executionContext

  private val logger = LoggerFactory.getLogger(getClass)

  implicit private val timeout: Timeout = settings.askTimeout

  private val sharding = ClusterSharding(system)

  override def reportLocation(
      in: proto.ReportLocationRequest): Future[Empty] = {
    val coordinates = in.coordinates.getOrElse {
      throw new GrpcServiceException(
        Status.INVALID_ARGUMENT.withDescription(
          &quot;coordinates are required but missing&quot;))
    }
    logger.info(
      &quot;Report location ({},{},{}) for drone {}&quot;,
      coordinates.latitude,
      coordinates.longitude,
      in.altitude,
      in.droneId)
    val entityRef = sharding.entityRefFor(Drone.EntityKey, in.droneId)
    val reply: Future[Done] = entityRef.ask(
      Drone.ReportPosition(
        Position(Coordinates.fromProto(coordinates), in.altitude),
        _))
    val response = reply.map(_ =&gt; Empty.defaultInstance)
    convertError(response)
  }

  // #requestNextDelivery
  override def requestNextDelivery(in: proto.RequestNextDeliveryRequest)
      : Future[proto.RequestNextDeliveryResponse] = {
    logger.info(&quot;Drone {} requesting next delivery&quot;, in.droneId)

    // get location for drone
    val entityRef = sharding.entityRefFor(Drone.EntityKey, in.droneId)

    // ask for closest delivery
    val response = for {
      position &lt;- entityRef.askWithStatus[Position](Drone.GetCurrentPosition(_))
      chosenDelivery &lt;- deliveriesQueue
        .askWithStatus[DeliveriesQueue.WaitingDelivery](
          DeliveriesQueue.RequestDelivery(in.droneId, position.coordinates, _))
    } yield {
      proto.RequestNextDeliveryResponse(
        deliveryId = chosenDelivery.deliveryId,
        from = Some(chosenDelivery.from.toProto),
        to = Some(chosenDelivery.to.toProto))
    }

    convertError(response)
  }
  // #requestNextDelivery
  override def completeDelivery(
      in: proto.CompleteDeliveryRequest): Future[Empty] = {
    logger.info(&quot;Delivery {} completed&quot;, in.deliveryId)

    deliveriesQueue
      .askWithStatus[Done](DeliveriesQueue.CompleteDelivery(in.deliveryId, _))
      .map(_ =&gt; Empty.defaultInstance)
  }

  // #charging
  override def goCharge(
      in: proto.GoChargeRequest): Future[proto.ChargingResponse] = {
    logger.info(
      &quot;Requesting charge of {} from {}&quot;,
      in.droneId,
      in.chargingStationId)
    val entityRef = chargingStationEntityRefFactory(in.chargingStationId)
    val response = entityRef
      .askWithStatus[ChargingStation.StartChargingResponse](
        ChargingStation.StartCharging(in.droneId, _))
      .map {
        case ChargingStation.ChargingStarted(_, expectedComplete) =&gt;
          proto.ChargingResponse(
            proto.ChargingResponse.Response.Started(
              proto.ChargingStarted(Some(Timestamp(expectedComplete)))))
        case ChargingStation.AllSlotsBusy(comeBackAt) =&gt;
          proto.ChargingResponse(
            proto.ChargingResponse.Response
              .ComeBackLater(proto.ComeBackLater(Some(Timestamp(comeBackAt)))))
      }
    convertError(response)
  }

  override def completeCharge(in: proto.CompleteChargeRequest)
      : Future[proto.CompleteChargingResponse] = {
    logger.info(
      &quot;Requesting complete charging of {} from {}&quot;,
      in.droneId,
      in.chargingStationId)

    val entityRef = chargingStationEntityRefFactory(in.chargingStationId)
    val response = entityRef
      .askWithStatus(ChargingStation.CompleteCharging(in.droneId, _))
      .map(_ =&gt; proto.CompleteChargingResponse.defaultInstance)

    convertError(response)
  }
  // #charging

  private def convertError[T](response: Future[T]): Future[T] = {
    response.recoverWith {
      case _: TimeoutException =&gt;
        Future.failed(
          new GrpcServiceException(
            Status.UNAVAILABLE.withDescription(&quot;Operation timed out&quot;)))
      case exc =&gt;
        Future.failed(
          new GrpcServiceException(
            Status.INTERNAL.withDescription(exc.getMessage)))
    }
  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-java/src/main/java/local/drones/DroneServiceImpl.java" target="_blank" title="Go to snippet source">source</a><code class="language-java">package local.drones;

import static akka.actor.typed.javadsl.AskPattern.*;

import akka.Done;
import akka.actor.typed.ActorRef;
import akka.actor.typed.ActorSystem;
import akka.cluster.sharding.typed.javadsl.ClusterSharding;
import akka.cluster.sharding.typed.javadsl.EntityRef;
import akka.grpc.GrpcServiceException;
import akka.pattern.StatusReply;
import charging.ChargingStation;
import com.google.protobuf.Timestamp;
import io.grpc.Status;
import java.time.Instant;
import java.util.concurrent.CompletionStage;
import java.util.concurrent.TimeoutException;
import java.util.function.Function;
import local.drones.proto.*;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class DroneServiceImpl implements DroneService {

  private static final Logger logger = LoggerFactory.getLogger(DroneServiceImpl.class);

  private final ActorRef&lt;DeliveriesQueue.Command&gt; deliveriesQueue;
  private final Function&lt;String, EntityRef&lt;ChargingStation.Command&gt;&gt;
      chargingStationEntityRefFactory;
  private final Settings settings;
  private final ActorSystem&lt;?&gt; system;

  private final ClusterSharding sharding;

  public DroneServiceImpl(
      ActorSystem&lt;?&gt; system,
      ActorRef&lt;DeliveriesQueue.Command&gt; deliveriesQueue,
      Function&lt;String, EntityRef&lt;ChargingStation.Command&gt;&gt; chargingStationEntityRefFactory,
      Settings settings) {
    this.system = system;
    this.deliveriesQueue = deliveriesQueue;
    this.chargingStationEntityRefFactory = chargingStationEntityRefFactory;
    this.settings = settings;
    this.sharding = ClusterSharding.get(system);
  }

  @Override
  public CompletionStage&lt;ReportLocationResponse&gt; reportLocation(ReportLocationRequest in) {
    var coordinates = in.getCoordinates();
    if (coordinates == null) {
      throw new GrpcServiceException(
          Status.INVALID_ARGUMENT.withDescription(&quot;coordinates are required but missing&quot;));
    }
    logger.info(
        &quot;Report location ({},{},{}) for drone {}&quot;,
        coordinates.getLatitude(),
        coordinates.getLongitude(),
        in.getAltitude(),
        in.getDroneId());
    var entityRef = sharding.entityRefFor(Drone.ENTITY_KEY, in.getDroneId());
    CompletionStage&lt;Done&gt; reply =
        entityRef.ask(
            replyTo -&gt;
                new Drone.ReportPosition(
                    new Position(Coordinates.fromProto(coordinates), in.getAltitude()), replyTo),
            settings.askTimeout);
    var response = reply.thenApply(done -&gt; ReportLocationResponse.getDefaultInstance());
    return convertError(response);
  }

  // #requestNextDelivery
  @Override
  public CompletionStage&lt;RequestNextDeliveryResponse&gt; requestNextDelivery(
      RequestNextDeliveryRequest in) {
    logger.info(&quot;Drone {} requesting next delivery&quot;, in.getDroneId());

    // get location for drone
    var entityRef = sharding.entityRefFor(Drone.ENTITY_KEY, in.getDroneId());
    var positionReply =
        entityRef.askWithStatus(
            (ActorRef&lt;StatusReply&lt;Position&gt;&gt; replyTo) -&gt; new Drone.GetCurrentPosition(replyTo),
            settings.askTimeout);

    // ask for closest delivery
    CompletionStage&lt;DeliveriesQueue.WaitingDelivery&gt; chosenDeliveryReply =
        positionReply.thenCompose(
            position -&gt;
                askWithStatus(
                    deliveriesQueue,
                    replyTo -&gt;
                        new DeliveriesQueue.RequestDelivery(
                            in.getDroneId(), position.coordinates, replyTo),
                    settings.askTimeout,
                    system.scheduler()));

    var response =
        chosenDeliveryReply.thenApply(
            chosenDelivery -&gt;
                RequestNextDeliveryResponse.newBuilder()
                    .setDeliveryId(chosenDelivery.deliveryId)
                    .setFrom(chosenDelivery.from.toProto())
                    .setTo(chosenDelivery.to.toProto())
                    .build());

    return convertError(response);
  }

  // #requestNextDelivery
  @Override
  public CompletionStage&lt;CompleteDeliveryResponse&gt; completeDelivery(CompleteDeliveryRequest in) {
    logger.info(&quot;Delivery {} completed&quot;, in.getDeliveryId());

    CompletionStage&lt;Done&gt; completeReply =
        askWithStatus(
            deliveriesQueue,
            replyTo -&gt; new DeliveriesQueue.CompleteDelivery(in.getDeliveryId(), replyTo),
            settings.askTimeout,
            system.scheduler());

    var reply = completeReply.thenApply(done -&gt; CompleteDeliveryResponse.getDefaultInstance());

    return convertError(reply);
  }

  // #charging
  @Override
  public CompletionStage&lt;ChargingResponse&gt; goCharge(GoChargeRequest in) {
    logger.info(&quot;Requesting charge of {} from {}&quot;, in.getDroneId(), in.getChargingStationId());
    var entityRef = chargingStationEntityRefFactory.apply(in.getChargingStationId());

    CompletionStage&lt;ChargingStation.StartChargingResponse&gt; chargingStationResponse =
        entityRef.askWithStatus(
            replyTo -&gt; new ChargingStation.StartCharging(in.getDroneId(), replyTo),
            settings.askTimeout);

    var response =
        chargingStationResponse.thenApply(
            message -&gt; {
              if (message instanceof ChargingStation.ChargingStarted) {
                var expectedComplete = ((ChargingStation.ChargingStarted) message).expectedComplete;
                return ChargingResponse.newBuilder()
                    .setStarted(
                        ChargingStarted.newBuilder()
                            .setExpectedComplete(instantToProtoTimestamp(expectedComplete))
                            .build())
                    .build();
              } else if (message instanceof ChargingStation.AllSlotsBusy) {
                var firstSlotFreeAt = ((ChargingStation.AllSlotsBusy) message).firstSlotFreeAt;
                return ChargingResponse.newBuilder()
                    .setComeBackLater(
                        ComeBackLater.newBuilder()
                            .setFirstSlotFreeAt(instantToProtoTimestamp(firstSlotFreeAt))
                            .build())
                    .build();
              } else {
                throw new IllegalArgumentException(
                    &quot;Unexpected response type &quot; + message.getClass());
              }
            });

    return convertError(response);
  }

  @Override
  public CompletionStage&lt;CompleteChargingResponse&gt; completeCharge(CompleteChargeRequest in) {
    logger.info(
        &quot;Requesting complete charging of {} from {}&quot;, in.getDroneId(), in.getChargingStationId());
    var entityRef = chargingStationEntityRefFactory.apply(in.getChargingStationId());

    CompletionStage&lt;Done&gt; chargingStationResponse =
        entityRef.askWithStatus(
            replyTo -&gt; new ChargingStation.CompleteCharging(in.getDroneId(), replyTo),
            settings.askTimeout);

    var response =
        chargingStationResponse.thenApply(done -&gt; CompleteChargingResponse.getDefaultInstance());

    return convertError(response);
  }
  // #charging
  private static Timestamp instantToProtoTimestamp(Instant instant) {
    return Timestamp.newBuilder()
        .setSeconds(instant.getEpochSecond())
        .setNanos(instant.getNano())
        .build();
  }

  private &lt;T&gt; CompletionStage&lt;T&gt; convertError(CompletionStage&lt;T&gt; response) {
    return response.exceptionally(
        error -&gt; {
          if (error instanceof TimeoutException) {
            throw new GrpcServiceException(
                Status.UNAVAILABLE.withDescription(&quot;Operation timed out&quot;));
          } else {
            throw new GrpcServiceException(Status.INTERNAL.withDescription(error.getMessage()));
          }
        });
  }
}</code></pre></dd>
</dl>
<h3><a href="#inspecting-the-queue" name="inspecting-the-queue" class="anchor"><span class="anchor-link"></span></a>Inspecting the queue</h3>
<p>We add a new gRPC service for inspecting the current state of the queue: </p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-scala/src/main/protobuf/local/drones/deliveries_queue_api.proto" target="_blank" title="Go to snippet source">source</a><code class="language-proto">syntax = &quot;proto3&quot;;

option java_multiple_files = true;
option java_package = &quot;local.drones.proto&quot;;

import &quot;google/protobuf/empty.proto&quot;;
import &quot;common/coordinates.proto&quot;;

package local.drones;

// gRPC definition for DroneService, for drones to interact with

service DeliveriesQueueService {
  rpc GetCurrentQueue (google.protobuf.Empty) returns (GetCurrentQueueResponse) {}
}

message GetCurrentQueueResponse {
  repeated WaitingDelivery waitingDeliveries = 1;
  repeated DeliveryInProgress deliveriesInProgress = 2;
}

message WaitingDelivery {
  string delivery_id = 1;
  common.Coordinates from = 2;
  common.Coordinates to = 3;
}

message DeliveryInProgress {
  string delivery_id = 1;
  string drone_id = 2;
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-java/src/main/protobuf/local/drones/deliveries_queue_api.proto" target="_blank" title="Go to snippet source">source</a><code class="language-proto">syntax = &quot;proto3&quot;;

option java_multiple_files = true;
option java_package = &quot;local.drones.proto&quot;;

import &quot;common/coordinates.proto&quot;;

package local.drones;

// gRPC definition for DroneService, for drones to interact with

service DeliveriesQueueService {
  rpc GetCurrentQueue (GetCurrentQueueRequest) returns (GetCurrentQueueResponse) {}
}

message GetCurrentQueueRequest {
}

message GetCurrentQueueResponse {
  repeated WaitingDelivery waitingDeliveries = 1;
  repeated DeliveryInProgress deliveriesInProgress = 2;
}

message WaitingDelivery {
  string delivery_id = 1;
  common.Coordinates from = 2;
  common.Coordinates to = 3;
}

message DeliveryInProgress {
  string delivery_id = 1;
  string drone_id = 2;
}</code></pre></dd>
</dl>
<p>Implementation of the generated service interface:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-scala/src/main/scala/local/drones/DeliveriesQueueServiceImpl.scala" target="_blank" title="Go to snippet source">source</a><code class="language-scala">package local.drones

import akka.actor.typed.scaladsl.AskPattern._
import akka.actor.typed.{ ActorRef, ActorSystem }
import akka.util.Timeout
import com.google.protobuf.empty.Empty
import local.drones.proto.DeliveriesQueueService

import scala.concurrent.Future

class DeliveriesQueueServiceImpl(
    settings: Settings,
    deliveriesQueue: ActorRef[DeliveriesQueue.Command])(
    implicit system: ActorSystem[_])
    extends DeliveriesQueueService {

  import system.executionContext
  private implicit val timeout: Timeout = settings.askTimeout

  override def getCurrentQueue(
      in: Empty): Future[proto.GetCurrentQueueResponse] = {
    val reply = deliveriesQueue.ask(DeliveriesQueue.GetCurrentState(_))

    reply.map { state =&gt;
      proto.GetCurrentQueueResponse(
        waitingDeliveries = state.waitingDeliveries.map(waiting =&gt;
          proto.WaitingDelivery(
            deliveryId = waiting.deliveryId,
            from = Some(waiting.from.toProto),
            to = Some(waiting.to.toProto))),
        deliveriesInProgress = state.deliveriesInProgress.map(inProgress =&gt;
          proto.DeliveryInProgress(
            deliveryId = inProgress.deliveryId,
            droneId = inProgress.droneId)))
    }

  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-java/src/main/java/local/drones/DeliveriesQueueServiceImpl.java" target="_blank" title="Go to snippet source">source</a><code class="language-java">package local.drones;

import static akka.actor.typed.javadsl.AskPattern.*;

import akka.actor.typed.ActorRef;
import akka.actor.typed.ActorSystem;
import java.util.concurrent.CompletionStage;
import java.util.stream.Collectors;
import local.drones.proto.*;

public class DeliveriesQueueServiceImpl implements DeliveriesQueueService {

  private final ActorSystem&lt;?&gt; system;
  private final Settings settings;
  private final ActorRef&lt;DeliveriesQueue.Command&gt; deliveriesQueue;

  public DeliveriesQueueServiceImpl(
      ActorSystem&lt;?&gt; system, Settings settings, ActorRef&lt;DeliveriesQueue.Command&gt; deliveriesQueue) {
    this.system = system;
    this.settings = settings;
    this.deliveriesQueue = deliveriesQueue;
  }

  @Override
  public CompletionStage&lt;GetCurrentQueueResponse&gt; getCurrentQueue(GetCurrentQueueRequest in) {
    var reply =
        ask(
            deliveriesQueue,
            DeliveriesQueue.GetCurrentState::new,
            settings.askTimeout,
            system.scheduler());

    return reply.thenApply(this::toProto);
  }

  private GetCurrentQueueResponse toProto(DeliveriesQueue.State state) {
    return GetCurrentQueueResponse.newBuilder()
        .addAllWaitingDeliveries(
            state.waitingDeliveries.stream().map(this::waitingToProto).collect(Collectors.toList()))
        .addAllDeliveriesInProgress(
            state.deliveriesInProgress.stream()
                .map(this::deliveryInProgressToProto)
                .collect(Collectors.toList()))
        .build();
  }

  private WaitingDelivery waitingToProto(DeliveriesQueue.WaitingDelivery waiting) {
    return WaitingDelivery.newBuilder()
        .setDeliveryId(waiting.deliveryId)
        .setFrom(waiting.from.toProto())
        .setTo(waiting.to.toProto())
        .build();
  }

  private DeliveryInProgress deliveryInProgressToProto(
      DeliveriesQueue.DeliveryInProgress inProgress) {
    return DeliveryInProgress.newBuilder()
        .setDeliveryId(inProgress.deliveryId)
        .setDroneId(inProgress.droneId)
        .build();
  }
}</code></pre></dd>
</dl>
<p>Finally, we need to start the gRPC server with the two services:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/restaurant-drone-deliveries-service-scala/src/main/scala/central/DroneDeliveriesServer.scala#L35-L47" target="_blank" title="Go to snippet source">source</a><code class="language-scala">val service = ServiceHandler.concatOrNotFound(
  DroneOverviewServiceHandler.partial(droneOverviewService),
  RestaurantDeliveriesServiceHandler.partial(restaurantDeliveriesService),
  ChargingStationServiceHandler.partial(chargingStationService),
  eventPullHandler,
  eventPushHandler,
  ServerReflection.partial(
    List(
      DroneOverviewService,
      RestaurantDeliveriesService,
      ChargingStationService)))

val bound = Http(system).newServerAt(interface, port).bind(service)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/restaurant-drone-deliveries-service-java/src/main/java/central/DroneDeliveriesServer.java#L37-L52" target="_blank" title="Go to snippet source">source</a><code class="language-java">@SuppressWarnings(&quot;unchecked&quot;)
var service =
    ServiceHandler.concatOrNotFound(
        DroneOverviewServiceHandlerFactory.create(droneOverviewService, system),
        RestaurantDeliveriesServiceHandlerFactory.create(restaurantDeliveriesService, system),
        ChargingStationServiceHandlerFactory.create(chargingStationService, system),
        eventPullHandler,
        eventPushHandler,
        ServerReflection.create(
            List.of(
                DroneOverviewService.description,
                RestaurantDeliveriesService.description,
                ChargingStationService.description),
            system));

var bound = Http.get(system).newServerAt(host, port).bind(service);</code></pre></dd>
</dl>
<h2><a href="#running-the-sample" name="running-the-sample" class="anchor"><span class="anchor-link"></span></a>Running the sample</h2>
<p>The complete sample can be downloaded from GitHub, but note that it also includes the next steps of the guide:</p>
<ul>
  <li>Scala <a href="../attachments/drone-scala.zip">drone-scala.zip</a></li>
  <li>Java <a href="../attachments/drone-java.zip">drone-java.zip</a></li>
</ul>
<p>As this service consumes events from the service built in the previous step, start the local-drone-control service first:</p><div class="group-scala">
<p>To start the local-drone-control-service:</p>
<pre class="prettyprint"><code class="language-shell">sbt run
</code></pre></div><div class="group-java">
<pre class="prettyprint"><code class="language-shell">mvn compile exec:exec
</code></pre></div>
<p>Then start the drone-restaurant-deliveries-service.</p>
<p>As the service needs a PostgreSQL instance running, start that up in a docker container and create the database schema if you did not do that in a previous step of the guide:</p>
<pre class="prettyprint"><code class="language-shell">docker compose up --wait
docker exec -i postgres_db psql -U postgres -t &lt; ddl-scripts/create_tables.sql
</code></pre>
<p>Then start the service:</p><div class="group-scala">
<pre class="prettyprint"><code class="language-shell">sbt -Dconfig.resource=local1.conf run
</code></pre>
<p>And optionally one or two more Akka cluster nodes, but note that the local drone controls are statically configured to the gRPC port of the first and will only publish events to that node.</p>
<pre class="prettyprint"><code class="language-shell">sbt -Dconfig.resource=local2.conf run
sbt -Dconfig.resource=local3.conf run
</code></pre></div><div class="group-java">
<pre class="prettyprint"><code class="language-shell">mvn compile exec:exec -DAPP_CONFIG=local1.conf
</code></pre>
<p>And optionally one or two more Akka cluster nodes, but note that the local drone controls are statically configured to the gRPC port of the first and will only publish events to that node.</p>
<pre class="prettyprint"><code class="language-shell">mvn compile exec:exec -DAPP_CONFIG=local2.conf
mvn compile exec:exec -DAPP_CONFIG=local3.conf
</code></pre></div>
<p>Create a restaurant with <a href="https://github.com/fullstorydev/grpcurl">grpcurl</a>:</p>
<pre class="prettyprint"><code class="language-shell">grpcurl -d &#39;{&quot;restaurant_id&quot;:&quot;restaurant1&quot;,&quot;coordinates&quot;:{&quot;latitude&quot;: 59.330324, &quot;longitude&quot;: 18.039568}, &quot;local_control_location_id&quot;: &quot;sweden/stockholm/kungsholmen&quot; }&#39; -plaintext localhost:8101 central.deliveries.RestaurantDeliveriesService.SetUpRestaurant
</code></pre>
<p>Set up another restaurant, closest to a different local drone control</p>
<pre class="prettyprint"><code class="language-shell">grpcurl -d &#39;{&quot;restaurant_id&quot;:&quot;restaurant2&quot;,&quot;coordinates&quot;:{&quot;latitude&quot;: 59.342046, &quot;longitude&quot;: 18.059095}, &quot;local_control_location_id&quot;: &quot;sweden/stockholm/norrmalm&quot; }&#39; -plaintext localhost:8101 central.deliveries.RestaurantDeliveriesService.SetUpRestaurant
</code></pre>
<p>Register a delivery for the first restaurant</p>
<pre class="prettyprint"><code class="language-shell">grpcurl -d &#39;{&quot;restaurant_id&quot;:&quot;restaurant1&quot;,&quot;delivery_id&quot;: &quot;order1&quot;,&quot;coordinates&quot;:{&quot;latitude&quot;: 59.330841, &quot;longitude&quot;: 18.038885}}&#39; -plaintext localhost:8101 central.deliveries.RestaurantDeliveriesService.RegisterDelivery
</code></pre>
<p>Register a delivery for the second restaurant</p>
<pre class="prettyprint"><code class="language-shell">grpcurl -d &#39;{&quot;restaurant_id&quot;:&quot;restaurant2&quot;,&quot;delivery_id&quot;: &quot;order2&quot;,&quot;coordinates&quot;:{&quot;latitude&quot;: 59.340128, &quot;longitude&quot;: 18.056303}}&#39; -plaintext localhost:8101 central.deliveries.RestaurantDeliveriesService.RegisterDelivery
</code></pre>
<p>Now update one or more drones a few times with <a href="https://github.com/fullstorydev/grpcurl">grpcurl</a> against the local-drone-control:</p>
<pre class="prettyprint"><code class="language-shell ">grpcurl -d &#39;{&quot;drone_id&quot;:&quot;drone1&quot;, &quot;coordinates&quot;: {&quot;longitude&quot;: 18.07125, &quot;latitude&quot;: 59.31834}, &quot;altitude&quot;: 5}&#39; -plaintext 127.0.0.1:8080 local.drones.DroneService.ReportLocation
 
grpcurl -d &#39;{&quot;drone_id&quot;:&quot;drone1&quot;, &quot;coordinates&quot;: {&quot;longitude&quot;: 18.08125, &quot;latitude&quot;: 59.41834}, &quot;altitude&quot;: 10}&#39; -plaintext 127.0.0.1:8080 local.drones.DroneService.ReportLocation

grpcurl -d &#39;{&quot;drone_id&quot;:&quot;drone2&quot;, &quot;coordinates&quot;: {&quot;longitude&quot;: 18.08114, &quot;latitude&quot;: 59.42122}, &quot;altitude&quot;: 8 }&#39; -plaintext 127.0.0.1:8080 local.drones.DroneService.ReportLocation
</code></pre>
<p>Request a delivery for drone1</p>
<pre class="prettyprint"><code class="language-shell">grpcurl -d &#39;{&quot;drone_id&quot;:&quot;drone1&quot;}&#39; -plaintext 127.0.0.1:8080 local.drones.DroneService.RequestNextDelivery
</code></pre>
<p>Mark the delivery as completed</p>
<pre class="prettyprint"><code class="language-shell">grpcurl -d &#39;{&quot;delivery_id&quot;:&quot;order1&quot;}&#39; -plaintext 127.0.0.1:8080 local.drones.DroneService.CompleteDelivery
</code></pre>
<p>Inspect the current state of the local delivery queue</p>
<pre class="prettyprint"><code class="language-shell">grpcurl -plaintext 127.0.0.1:8080 local.drones.DeliveriesQueueService.GetCurrentQueue
</code></pre>
<h2><a href="#whats-next-" name="whats-next-" class="anchor"><span class="anchor-link"></span></a>What&rsquo;s next?</h2>
<ul>
  <li>Packaging up the two services for deployment</li>
</ul>
</div>
</article>
<div class="row">
<div class="small-12 column">
<section class="nav-prev-next row">
<div class="nav-prev small-6 column">
<a href="../guide/3-restaurant-deliveries-service.html"><i class="icon-prev"></i> <span class="link-prev">Restaurant deliveries</span></a>
</div>
<div class="nav-next small-6 column clearfix">
<a class="float-right" href="../guide/5-charging-station.html">Drone Charging Station <i class="icon-next"></i></a>
</div>
</section>
</div>
</div>
<div class="source-github row">
Found an error in this documentation? The source code for this page can be found <a href="https://github.com/akka/akka-projection/tree/master/akka-edge-docs/src/main/paradox/guide/4-local-drone-delivery-selection.md">here</a>.
Please feel free to edit and contribute a pull request.
</div>

<footer class="page-footer row clearfix">
<img class="akka-icon float-left show-for-medium" src="../images/akka-icon.svg" />
<section class="copyright">
<div>Akka Edge is available under the <a href="https://www.lightbend.com/akka/license" target="_blank">Business Source License 1.1</a>.</div>
<p class="legal">
&copy; 2011-2024 <a href="https://www.lightbend.com" target="_blank">Lightbend, Inc.</a> |
<a href="https://www.lightbend.com/legal/licenses" target="_blank">Licenses</a> |
<a href="https://www.lightbend.com/legal/terms" target="_blank">Terms</a> |
<a href="https://www.lightbend.com/legal/privacy" target="_blank">Privacy Policy</a> |
<a href="https://akka.io/cookie/" target="_blank">Cookie Listing</a> |
<a class="optanon-toggle-display">Cookie Settings</a>
</p>
</section>

</footer>
</section>
</main>
</div>

<script type="text/javascript" src="../js/scrollsneak.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../js/groups.js"></script>
<script type="text/javascript" src="../js/page.js"></script>
<script type="text/javascript" src="../js/snippets.js"></script>
<script type="text/javascript" src="../js/magellan.js"></script>
<script type="text/javascript" src="../js/metadata-toggle.js"></script>
<script type="text/javascript" src="../js/lbHeader.js"></script>

<style type="text/css">@import "../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(){window.prettyPrint && prettyPrint()});
//]]></script>
<!-- hook for including project specific javascript into the generated docs -->

</body>
</html>
