<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Drone Charging Station &bull; Akka Edge</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="Akka Projection."/>
<link rel="canonical" href="https://doc.akka.io/docs/akka-edge/current/guide/5-charging-station.html"/>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../lib/foundation/dist/js/foundation.min.js"></script>
<link rel="stylesheet" type="text/css" href="../lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="../lib/foundation/dist/css/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" type="text/css" href="../css/icons.css"/>
<link rel="stylesheet" type="text/css" href="../css/page-8.css"/>
<link rel="stylesheet" type="text/css" href="../css/banner-2.css"/>
<link rel="shortcut icon" href="../images/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="../images/apple-touch-icon.png"/>
<link rel="icon" type="image/png" sizes="32x32" href="../images/favicon-32x32.png"/>
<link rel="icon" type="image/png" sizes="16x16" href="../images/favicon-16x16.png"/>
<link rel="manifest" href="../images/manifest.json"/>
<meta name="msapplication-TileImage" content="../images/mstile-150x150.png"/>
<meta name="msapplication-TileColor" content="#15a9ce"/>
<meta name="theme-color" content="#15a9ce"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) start -->
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js"  type="text/javascript" charset="UTF-8" data-domain-script="28b912e7-09e9-43d5-91e4-3d1897044004" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) end -->
<!-- Google Tag Manager now loads Google Analytics and any other tracking scripts. GTM also performs respects a users cookie choices-->
<script type="text/javascript">
(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KBJGH35');
</script>

</head>

<body id="underlay" data-toggler="nav-open">
<div id="lightbend-banner" class="lightbend-banner akka full-width" data-category="OSS Lightbend Banner Impression" data-label="Akka Banner Impression">
<div class="oss-wrapper">
<div class="oss-brand">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lightbend Logo - Akka Banner" href="https://www.lightbend.com">
<img class="lightbend-logo" src="../images/banner-logos/lightbend-reverse.svg" alt="Lightbend" title="Lightbend">
</a>
</div>
<div class="oss-ad no-drop-down">
<nav id="lightbendRotator" class="lightbend-rotator">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Promo Rotator - Introducing Akka Cloud to Edge Continuum. Build once for the Cloud. Seamlessly deploy to the Edge. [Learn more] - Akka Banner" href="https://www.lightbend.com/blog/akka-edge-unifying-the-cloud-and-edge">
Introducing Akka Cloud to Edge Continuum. Build once for the Cloud. Seamlessly deploy to the Edge. <span class="akka-btn">Learn more</span>
</a>
</nav>
</div>
</div>
</div>

<header class="site-header hide-for-large">
<div class="sticky-header clearfix">
<a href="https://akka.io"><img class="logo" src="../images/akka-logo-reverse.svg"/></a>

<button class="menu-icon float-right" type="button" data-toggle="underlay overlay"></button>
</div>
<div id="overlay" class="overlay-nav" data-toggler="nav-open">
<header class="nav-header">
<div class="nav-header-title">
<h1><a href="../index.html">Akka Edge</a></h1>
</div>
<div class="nav-header-version">
Version 1.5.2
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="nav-toc">
<ul>
  <li><a href="../overview.html" class="page">Architectural Overview</a></li>
  <li><a href="../use-cases.html" class="page">Example Use Cases</a></li>
  <li><a href="../feature-summary.html" class="page">Feature Summary</a></li>
  <li><a href="../guide.html" class="page">Guide - Java/Scala</a>
  <ul>
    <li><a href="../guide/1-local-drone-control-service.html" class="page">Local Drone Control Service</a></li>
    <li><a href="../guide/2-drone-location-to-cloud-service.html" class="page">Coarse Grained Location Replication</a></li>
    <li><a href="../guide/3-restaurant-deliveries-service.html" class="page">Restaurant deliveries</a></li>
    <li><a href="../guide/4-local-drone-delivery-selection.html" class="page">Local Drone Delivery Selection</a></li>
    <li><a href="../guide/5-charging-station.html#drone-charging-station" class="active page">Drone Charging Station</a>
    <ul>
      <li><a href="../guide/5-charging-station.html#implementing-the-charging-station-entity" class="header">Implementing the charging station entity</a></li>
      <li><a href="../guide/5-charging-station.html#service-for-interacting-with-the-charging-station" class="header">Service for interacting with the charging station</a></li>
      <li><a href="../guide/5-charging-station.html#interacting-with-the-charging-station-at-the-edge" class="header">Interacting with the charging station at the edge</a></li>
      <li><a href="../guide/5-charging-station.html#running" class="header">Running</a></li>
    </ul></li>
    <li><a href="../guide/6-deploying-the-services.html" class="page">Deploying the Restaurant Delivery Service</a></li>
  </ul></li>
  <li><a href="../guide-rs.html" class="page">Guide - Rust</a></li>
  <li><a href="../lightweight-deployments.html" class="page">Lightweight deployments</a></li>
</ul>
</nav>
</div>
</header>
<div class="site-content-wrapper">
<aside class="sticky-sidebar show-for-large">
<header class="nav-header sticky-sidebar-header">
<div class="nav-header-title">
<h1><a href="../index.html">Akka Edge</a></h1>
</div>
<div class="nav-header-version">
Version 1.5.2
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="site-nav sticky-sidebar-contents">
<div class="nav-toc">
<ul>
  <li><a href="../overview.html" class="page">Architectural Overview</a></li>
  <li><a href="../use-cases.html" class="page">Example Use Cases</a></li>
  <li><a href="../feature-summary.html" class="page">Feature Summary</a></li>
  <li><a href="../guide.html" class="page">Guide - Java/Scala</a>
  <ul>
    <li><a href="../guide/1-local-drone-control-service.html" class="page">Local Drone Control Service</a></li>
    <li><a href="../guide/2-drone-location-to-cloud-service.html" class="page">Coarse Grained Location Replication</a></li>
    <li><a href="../guide/3-restaurant-deliveries-service.html" class="page">Restaurant deliveries</a></li>
    <li><a href="../guide/4-local-drone-delivery-selection.html" class="page">Local Drone Delivery Selection</a></li>
    <li><a href="../guide/5-charging-station.html#drone-charging-station" class="active page">Drone Charging Station</a>
    <ul>
      <li><a href="../guide/5-charging-station.html#implementing-the-charging-station-entity" class="header">Implementing the charging station entity</a></li>
      <li><a href="../guide/5-charging-station.html#service-for-interacting-with-the-charging-station" class="header">Service for interacting with the charging station</a></li>
      <li><a href="../guide/5-charging-station.html#interacting-with-the-charging-station-at-the-edge" class="header">Interacting with the charging station at the edge</a></li>
      <li><a href="../guide/5-charging-station.html#running" class="header">Running</a></li>
    </ul></li>
    <li><a href="../guide/6-deploying-the-services.html" class="page">Deploying the Restaurant Delivery Service</a></li>
  </ul></li>
  <li><a href="../guide-rs.html" class="page">Guide - Rust</a></li>
  <li><a href="../lightweight-deployments.html" class="page">Lightweight deployments</a></li>
</ul>
</div>
</nav>
<footer class="nav-footer sticky-sidebar-footer">
<a href="https://akka.io"><img class="logo" src="../images/akka-logo-reverse.svg"/></a>

</footer>
</aside>
<main class="fixed-shift-for-large expanded row">
<section class="site-content small-12 column">
<article class="page-content row">
<div class="small-12 column" id="docs">
<h1><a href="#drone-charging-station" name="drone-charging-station" class="anchor"><span class="anchor-link"></span></a>Drone Charging Station</h1>
<p>To showcase active-active replication between edge and cloud we&rsquo;ll now add a <a href="https://doc.akka.io/docs/akka-projection/1.5/grpc-replicated-event-sourcing-transport.html">Replicated Event Sourced Entity</a> in the form of a charging station. The charging stations are created with a location id placing them in one of the local-drone-control edge services where the entity is replicated. Drones in that location can request to charge in the charging station, and be charged if there is a free charging slot.</p>
<h2><a href="#implementing-the-charging-station-entity" name="implementing-the-charging-station-entity" class="anchor"><span class="anchor-link"></span></a>Implementing the charging station entity</h2>
<h3><a href="#commands-and-events" name="commands-and-events" class="anchor"><span class="anchor-link"></span></a>Commands and events</h3>
<p>The charging station accepts three different commands from the outside <code>Create</code> to initialize a charging station, <code>StartCharging</code> to start a charging session for a drone if possible and <code>GetState</code> to query the station for its current state. There is also a private <code>CompleteCharging</code> command that only the entity can create.</p>
<p>The <code>Create</code> command leads to a <code>Created</code> event which is persisted and initialized the charging station.</p>
<p>When a slot is free and a drone requests charging a <code>ChargingStarted</code> event is persisted and once charging a drone has completed a <code>ChargingCompleted</code> event is persisted:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-scala/src/main/scala/charging/ChargingStation.scala#L31-L51" target="_blank" title="Go to snippet source">source</a><code class="language-scala">sealed trait Command extends CborSerializable
case class Create(
    locationId: String,
    chargingSlots: Int,
    replyTo: ActorRef[StatusReply[Done]])
    extends Command
case class StartCharging(
    droneId: String,
    replyTo: ActorRef[StatusReply[StartChargingResponse]])
    extends Command
sealed trait StartChargingResponse extends CborSerializable
case class AllSlotsBusy(firstSlotFreeAt: Instant)
    extends StartChargingResponse

case class GetState(replyTo: ActorRef[StatusReply[ChargingStation.State]])
    extends Command

case class CompleteCharging(
    droneId: String,
    reply: ActorRef[StatusReply[Done]])
    extends Command
sealed trait Event extends CborSerializable
case class Created(locationId: String, chargingSlots: Int) extends Event
case class ChargingStarted(droneId: String, expectedComplete: Instant)
    extends Event
    with StartChargingResponse

case class ChargingCompleted(droneId: String) extends Event</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-java/src/main/java/charging/ChargingStation.java#L30-L83" target="_blank" title="Go to snippet source">source</a><code class="language-java">public interface Command extends CborSerializable {}

public static final class Create implements Command {
  public final String locationId;
  public final int chargingSlots;
  public final ActorRef&lt;StatusReply&lt;Done&gt;&gt; replyTo;

  public Create(String locationId, int chargingSlots, ActorRef&lt;StatusReply&lt;Done&gt;&gt; replyTo) {
    this.locationId = locationId;
    this.chargingSlots = chargingSlots;
    this.replyTo = replyTo;
  }
}

public static final class StartCharging implements Command {
  public final String droneId;
  public final ActorRef&lt;StatusReply&lt;StartChargingResponse&gt;&gt; replyTo;

  public StartCharging(String droneId, ActorRef&lt;StatusReply&lt;StartChargingResponse&gt;&gt; replyTo) {
    this.droneId = droneId;
    this.replyTo = replyTo;
  }
}

public interface StartChargingResponse extends CborSerializable {}

public static final class AllSlotsBusy implements StartChargingResponse {
  public final Instant firstSlotFreeAt;

  @JsonCreator
  public AllSlotsBusy(Instant firstSlotFreeAt) {
    this.firstSlotFreeAt = firstSlotFreeAt;
  }
}

public static final class GetState implements Command {
  public final ActorRef&lt;StatusReply&lt;State&gt;&gt; replyTo;

  @JsonCreator
  public GetState(ActorRef&lt;StatusReply&lt;State&gt;&gt; replyTo) {
    this.replyTo = replyTo;
  }
}

public static final class CompleteCharging implements Command {
  final String droneId;

  final ActorRef&lt;StatusReply&lt;Done&gt;&gt; replyTo;

  public CompleteCharging(String droneId, ActorRef&lt;StatusReply&lt;Done&gt;&gt; replyTo) {
    this.droneId = droneId;
    this.replyTo = replyTo;
  }
}
public interface Event extends CborSerializable {}

public static final class Created implements Event {
  public final String locationId;
  public final int chargingSlots;

  public Created(String locationId, int chargingSlots) {
    this.locationId = locationId;
    this.chargingSlots = chargingSlots;
  }
}

public static final class ChargingStarted implements Event, StartChargingResponse {
  public final String droneId;
  public final Instant expectedComplete;

  public ChargingStarted(String droneId, Instant expectedComplete) {
    this.droneId = droneId;
    this.expectedComplete = expectedComplete;
  }
}

public static final class ChargingCompleted implements Event {
  public final String droneId;

  @JsonCreator
  public ChargingCompleted(String droneId) {
    this.droneId = droneId;
  }
}

public static final class ChargingDrone {
  public final String droneId;
  public final Instant expectedComplete;
  public final String replicaId;

  public ChargingDrone(String droneId, Instant expectedComplete, String replicaId) {
    this.droneId = droneId;
    this.expectedComplete = expectedComplete;
    this.replicaId = replicaId;
  }
}</code></pre></dd>
</dl>
<h3><a href="#state" name="state" class="anchor"><span class="anchor-link"></span></a>State</h3>
<p>The state of the charging station starts as <span class="group-java"><code>null</code></span><span class="group-scala"><code>None</code></span> and requires a <code>Create</code> message for the station to be initialized with a <span class="group-java"><code>State</code></span><span class="group-scala"><code>Some(State)</code></span>.</p>
<p>The <code>State</code> contains the number of charging slots that can concurrently charge drones and a set of currently charging drones.</p>
<p>The state also contains a location id identifying where it is, matching the location id structure of the local-drone-control service. This is needed so that the station can be replicated only to the edge location where it is located.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-scala/src/main/scala/charging/ChargingStation.scala#L65-L73" target="_blank" title="Go to snippet source">source</a><code class="language-scala">case class ChargingDrone(
    droneId: String,
    expectedComplete: Instant,
    replicaId: String)
case class State(
    chargingSlots: Int,
    dronesCharging: Set[ChargingDrone],
    stationLocationId: String)
    extends CborSerializable</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-java/src/main/java/charging/ChargingStation.java#L132-L142" target="_blank" title="Go to snippet source">source</a><code class="language-java">public static final class State implements CborSerializable {
  public final int chargingSlots;
  public final Set&lt;ChargingDrone&gt; dronesCharging;
  public final String stationLocationId;

  public State(int chargingSlots, Set&lt;ChargingDrone&gt; dronesCharging, String stationLocationId) {
    this.chargingSlots = chargingSlots;
    this.dronesCharging = dronesCharging;
    this.stationLocationId = stationLocationId;
  }
}</code></pre></dd>
</dl>
<h3><a href="#command-handler" name="command-handler" class="anchor"><span class="anchor-link"></span></a>Command handler</h3>
<p>The command handler is in fact two separate handlers, one for when the entity is not yet initialized, only accepting the <code>Create</code> command, and one that is used to handle commands once the station has been initialized.</p>
<p>The <code>StartCharging</code> command is the only one that requires more complicated logic: if a slot is free, persist a <code>ChargingStarted</code> event and tell the drone when charging will be done. If all charging slots are busy the reply will instead be when the first slot will be free again and the drone can come back and try charge again.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-scala/src/main/scala/charging/ChargingStation.scala#L146-L229" target="_blank" title="Go to snippet source">source</a><code class="language-scala">private def handleCommand(
    state: Option[State],
    command: Command): Effect[Event, Option[State]] =
  state match {
    case None        =&gt; handleCommandNoState(command)
    case Some(state) =&gt; handleCommandInitialized(state, command)
  }

private def handleCommandNoState(
    command: Command): Effect[Event, Option[State]] =
  command match {
    case Create(locationId, chargingSlots, replyTo) =&gt;
      Effect
        .persist(Created(locationId, chargingSlots))
        .thenReply(replyTo)(_ =&gt; StatusReply.Ack)
    case StartCharging(_, replyTo) =&gt;
      Effect.reply(replyTo)(
        StatusReply.Error(
          s&quot;Charging station ${replicationContext.entityId} not initialized&quot;))
    case GetState(replyTo) =&gt;
      Effect.reply(replyTo)(
        StatusReply.Error(
          s&quot;Charging station ${replicationContext.entityId} not initialized&quot;))
    case unexpected =&gt;
      context.log.warn(
        &quot;Got an unexpected command {} but charging station with id {} not initialized&quot;,
        unexpected.getClass,
        replicationContext.entityId)
      Effect.none
  }

private def handleCommandInitialized(
    state: ChargingStation.State,
    command: ChargingStation.Command): Effect[Event, Option[State]] = {
  command match {
    case Create(_, _, replyTo) =&gt;
      Effect.reply(replyTo)(StatusReply.Error(
        s&quot;Got a create command, but station id ${replicationContext.entityId} was already created&quot;))

    case StartCharging(droneId, replyTo) =&gt;
      if (state.dronesCharging.exists(_.droneId == droneId)) {
        context.log.warn(
          &quot;Drone {} requested charging but is already charging. Ignoring.&quot;,
          droneId)
        Effect.none
      } else if (state.dronesCharging.size &gt;= state.chargingSlots) {
        val earliestFreeSlot =
          state.dronesCharging.map(_.expectedComplete).min
        context.log.info(
          &quot;Drone {} requested charging but all stations busy, earliest free slot {}&quot;,
          droneId,
          earliestFreeSlot)
        Effect.reply(replyTo)(
          StatusReply.Success(AllSlotsBusy(earliestFreeSlot)))
      } else {
        // charge
        val expectedComplete =
          Instant.now().plusSeconds(FullChargeTime.toSeconds)
        context.log.info(
          &quot;Drone {} requested charging, expected to complete charging at {}&quot;,
          droneId,
          expectedComplete)
        val event = ChargingStarted(droneId, expectedComplete)
        Effect
          .persist(event)
          .thenReply(replyTo)(_ =&gt; StatusReply.Success(event))
      }

    case CompleteCharging(droneId, replyTo) =&gt;
      if (state.dronesCharging.exists(_.droneId == droneId)) {
        context.log.info(&quot;Drone {} completed charging&quot;, droneId)
        Effect
          .persist(ChargingCompleted(droneId))
          .thenReply(replyTo)(_ =&gt; StatusReply.Ack)
      } else {
        Effect.reply(replyTo)(
          StatusReply.error(s&quot;Drone $droneId is not currently charging&quot;))
      }

    case GetState(replyTo) =&gt;
      Effect.reply(replyTo)(StatusReply.Success(state))

  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-java/src/main/java/charging/ChargingStation.java#L205-L318" target="_blank" title="Go to snippet source">source</a><code class="language-java">@Override
public CommandHandler&lt;Command, Event, State&gt; commandHandler() {
  var noStateHandler =
      newCommandHandlerBuilder()
          .forNullState()
          .onCommand(
              Create.class,
              (state, create) -&gt;
                  Effect()
                      .persist(new Created(create.locationId, create.chargingSlots))
                      .thenReply(create.replyTo, stateAfter -&gt; StatusReply.ack()))
          .onCommand(
              StartCharging.class,
              startCharging -&gt;
                  Effect()
                      .reply(
                          startCharging.replyTo,
                          StatusReply.error(
                              &quot;Charging station &quot;
                                  + getReplicationContext().entityId()
                                  + &quot; not initialized&quot;)))
          .onCommand(
              GetState.class,
              getState -&gt;
                  Effect()
                      .reply(
                          getState.replyTo,
                          StatusReply.error(
                              &quot;Charging station &quot;
                                  + getReplicationContext().entityId()
                                  + &quot; not initialized&quot;)))
          .onCommand(
              command -&gt; true,
              unexpected -&gt; {
                context
                    .getLog()
                    .warn(
                        &quot;Got an unexpected command {} but charging station with id {} not initialized&quot;,
                        unexpected.getClass(),
                        getReplicationContext().entityId());
                return Effect().none();
              });

  var initializedHandler =
      newCommandHandlerBuilder()
          .forNonNullState()
          .onCommand(
              Create.class,
              create -&gt;
                  Effect()
                      .reply(
                          create.replyTo,
                          StatusReply.error(
                              &quot;Got a create command, but station id &quot;
                                  + getReplicationContext().entityId()
                                  + &quot; was already created&quot;)))
          .onCommand(StartCharging.class, this::handleStartCharging)
          .onCommand(CompleteCharging.class, this::handleCompleteCharging)
          .onCommand(
              GetState.class,
              (state, getState) -&gt; Effect().reply(getState.replyTo, StatusReply.success(state)));

  return noStateHandler.orElse(initializedHandler).build();
}

private Effect&lt;Event, State&gt; handleStartCharging(State state, StartCharging startCharging) {
  if (state.dronesCharging.stream()
      .anyMatch(charging -&gt; charging.droneId.equals(startCharging.droneId))) {
    return Effect().reply(startCharging.replyTo, StatusReply.error(&quot;Drone already charging&quot;));
  } else if (state.dronesCharging.size() &gt;= state.chargingSlots) {
    var earliestFreeSlot =
        state.dronesCharging.stream()
            .min(Comparator.comparing(chargingDrone -&gt; chargingDrone.expectedComplete))
            .get()
            .expectedComplete;
    context
        .getLog()
        .info(
            &quot;Drone {} requested charging but all stations busy, earliest free slot {}&quot;,
            startCharging.droneId,
            earliestFreeSlot);
    return Effect()
        .reply(startCharging.replyTo, StatusReply.success(new AllSlotsBusy(earliestFreeSlot)));
  } else {
    // charge
    var expectedComplete = Instant.now().plus(FULL_CHARGE_TIME);
    context
        .getLog()
        .info(
            &quot;Drone {} requested charging, will complete charging at {}&quot;,
            startCharging.droneId,
            expectedComplete);
    var event = new ChargingStarted(startCharging.droneId, expectedComplete);
    return Effect()
        .persist(event)
        .thenReply(startCharging.replyTo, newState -&gt; StatusReply.success(event));
  }
}

private Effect&lt;Event, State&gt; handleCompleteCharging(
    State state, CompleteCharging completeCharging) {
  context.getLog().info(&quot;Drone {} completed charging&quot;, completeCharging.droneId);
  if (state.dronesCharging.stream()
      .anyMatch(chargingDrone -&gt; chargingDrone.droneId.equals(completeCharging.droneId)))
    return Effect()
        .persist(new ChargingCompleted(completeCharging.droneId))
        .thenReply(completeCharging.replyTo, newState -&gt; StatusReply.ack());
  else
    return Effect()
        .reply(
            completeCharging.replyTo,
            StatusReply.error(
                &quot;Drone &quot; + completeCharging.droneId + &quot; is not currently charging.&quot;));
}</code></pre></dd>
</dl>
<h3><a href="#event-handler" name="event-handler" class="anchor"><span class="anchor-link"></span></a>Event handler</h3>
<p>Just like the command handler the event handler is different depending on if there is state or not. If there is no state only the <code>Created</code> event is accepted.</p>
<p>Once initialized the charging station expects <code>ChargingStarted</code> and <code>ChargingCompleted</code> events, additional <code>Created</code> events are ignored.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-scala/src/main/scala/charging/ChargingStation.scala#L233-L262" target="_blank" title="Go to snippet source">source</a><code class="language-scala">private def handleEvent(state: Option[State], event: Event): Option[State] = {
  state match {
    case None =&gt;
      event match {
        case Created(locationId, chargingSlots) =&gt;
          Some(State(chargingSlots, Set.empty, locationId))
        case unexpected =&gt;
          throw new IllegalArgumentException(
            s&quot;Got unexpected event ${unexpected} for uninitialized state&quot;)
      }

    case Some(state) =&gt;
      event match {
        case Created(_, _) =&gt;
          context.log.warn(&quot;Saw a second created event, ignoring&quot;)
          Some(state)
        case ChargingStarted(droneId, expectedComplete) =&gt;
          Some(
            state.copy(dronesCharging = state.dronesCharging + ChargingDrone(
              droneId,
              expectedComplete,
              replicationContext.origin.id)))
        case ChargingCompleted(droneId) =&gt;
          Some(
            state.copy(dronesCharging =
              state.dronesCharging.filterNot(_.droneId == droneId)))
      }

  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-java/src/main/java/charging/ChargingStation.java#L322-L369" target="_blank" title="Go to snippet source">source</a><code class="language-java">@Override
public EventHandler&lt;State, Event&gt; eventHandler() {
  var noStateHandler =
      newEventHandlerBuilder()
          .forNullState()
          .onEvent(
              Created.class,
              created -&gt;
                  new State(created.chargingSlots, Collections.emptySet(), created.locationId));

  var initializedStateHandler =
      newEventHandlerBuilder()
          .forNonNullState()
          .onEvent(
              Created.class,
              (state, event) -&gt; {
                context.getLog().warn(&quot;Saw a second created event, ignoring&quot;);
                return state;
              })
          .onEvent(
              ChargingStarted.class,
              (state, event) -&gt; {
                var newSet = new HashSet&lt;&gt;(state.dronesCharging);
                newSet.add(
                    new ChargingDrone(
                        event.droneId,
                        event.expectedComplete,
                        getReplicationContext().origin().id()));
                return new State(
                    state.chargingSlots,
                    Collections.unmodifiableSet(newSet),
                    state.stationLocationId);
              })
          .onEvent(
              ChargingCompleted.class,
              (state, event) -&gt; {
                var newSet =
                    state.dronesCharging.stream()
                        .filter(charging -&gt; !charging.droneId.equals(event.droneId))
                        .collect(Collectors.toSet());
                return new State(
                    state.chargingSlots,
                    Collections.unmodifiableSet(newSet),
                    state.stationLocationId);
              });

  return noStateHandler.orElse(initializedStateHandler).build();
}</code></pre></dd>
</dl><div class="callout note "><div class="callout-title">Note</div>
<p>The charging station is a very limited replicated entity example to keep the guide simple. It doesn&rsquo;t expect any possible conflicts, stations are created, once, in the central cloud and replicated to the edge, updates related to drones currently charging in the station happen at the edge and are replicated to the cloud. Akka replicated event sourcing provides APIs for both CRDTs where conflicts are automatically handled by the data structure and business domain level conflict resolution. For more details about see the <a href="https://doc.akka.io/docs/akka/2.9/replicated-eventsourcing.html">Akka documentation</a>.</p></div>
<h3><a href="#tagging-based-on-location" name="tagging-based-on-location" class="anchor"><span class="anchor-link"></span></a>Tagging based on location</h3>
<p>To be able to control where the charging station is replicated we tag the events using the location id from the state as a topic:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-scala/src/main/scala/charging/ChargingStation.scala#L139-L142" target="_blank" title="Go to snippet source">source</a><code class="language-scala">.withTaggerForState {
  case (None, _)        =&gt; Set.empty
  case (Some(state), _) =&gt; Set(&quot;t:&quot; + state.stationLocationId)
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-java/src/main/java/charging/ChargingStation.java#L373-L377" target="_blank" title="Go to snippet source">source</a><code class="language-java">@Override
public Set&lt;String&gt; tagsFor(State state, Event event) {
  if (state == null) return Set.of();
  else return Set.of(&quot;t:&quot; + state.stationLocationId);
}</code></pre></dd>
</dl>
<h3><a href="#setting-up-replication-for-the-charging-station" name="setting-up-replication-for-the-charging-station" class="anchor"><span class="anchor-link"></span></a>Setting up replication for the charging station</h3>
<p>Setup for the cloud replica and the edge node differs slightly. </p>
<p>For the restaurant-drone-deliveries service running in the cloud we set up a <code>ReplicationSettings</code> with edge replication enabled:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-scala/src/main/scala/charging/ChargingStation.scala#L103-L108" target="_blank" title="Go to snippet source">source</a><code class="language-scala">def init(implicit system: ActorSystem[_]): Replication[Command] = {
  val replicationSettings =
    ReplicationSettings[Command](EntityType, R2dbcReplication())
      .withEdgeReplication(true)
  Replication.grpcReplication(replicationSettings)(ChargingStation.apply)
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-java/src/main/java/charging/ChargingStation.java#L170-L176" target="_blank" title="Go to snippet source">source</a><code class="language-java">public static Replication&lt;Command&gt; init(ActorSystem&lt;?&gt; system) {
  var replicationSettings =
      ReplicationSettings.create(
              Command.class, ENTITY_TYPE, R2dbcReplication.create(system), system)
          .withEdgeReplication(true);
  return Replication.grpcReplication(replicationSettings, ChargingStation::create, system);
}</code></pre></dd>
</dl>
<p>Since we have other events going over akka-projection-grpc producer push replication already in the restaurant-drone-deliveries service we need to combine all such sources and destinations into single gRPC services:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/restaurant-drone-deliveries-service-scala/src/main/scala/central/Main.scala#L59-L74" target="_blank" title="Go to snippet source">source</a><code class="language-scala">val chargingStationService = new ChargingStationServiceImpl(
  chargingStationReplication.entityRefFactory)

// delivery events and charging station replication both are Akka Projection gRPC event
// producers (pulled by the local drone control) and needs to be combined into a single gRPC service handling both:
val eventPullHandler = EventProducer.grpcServiceHandler(
  Set(
    deliveryEventsProducerSource,
    chargingStationReplication.eventProducerSource))

// the drone events from edge and the charging station replicated entity are both Akka Projection gRPC
// event push destinations (pushed by local drone control) and needs to be combined into a single gRPC service handling both:
val eventPushHandler = EventProducerPushDestination.grpcServiceHandler(
  Set(
    pushedEventsDestination,
    chargingStationReplication.eventProducerPushDestination.get))(system)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/restaurant-drone-deliveries-service-java/src/main/java/central/Main.java#L55-L78" target="_blank" title="Go to snippet source">source</a><code class="language-java">var chargingStationService =
    new ChargingStationServiceImpl(
        settings,
        // FIXME java function type
        id -&gt; chargingStationReplication.entityRefFactory().apply(id));

// delivery events and charging station replication both are Akka Projection gRPC event
// producers (pulled by the local drone control) and needs to be combined into a single gRPC
// service handling both:
var eventPullHandler =
    EventProducer.grpcServiceHandler(
        system,
        Set.of(deliveryEventsProducerSource, chargingStationReplication.eventProducerSource()));

// the drone events from edge and the charging station replicated entity are both Akka
// Projection gRPC
// event push destinations (pushed by local drone control) and needs to be combined into a
// single gRPC service handling both:
var eventPushHandler =
    EventProducerPushDestination.grpcServiceHandler(
        Set.of(
            pushedEventsDestination,
            chargingStationReplication.eventProducerPushDestination().get()),
        system);</code></pre></dd>
</dl>
<p>For the local-drone-control service we also create <code>ReplicationSettings</code> but pass them to a separate initialization method <code>Replication.grpcEdgeReplication</code>. Since the edge node will be responsible for creating connections, no gRPC services needs to be bound: </p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-scala/src/main/scala/charging/ChargingStation.scala#L85-L96" target="_blank" title="Go to snippet source">source</a><code class="language-scala">def initEdge(locationId: String)(
    implicit system: ActorSystem[_]): EdgeReplication[Command] = {
  val replicationSettings =
    ReplicationSettings[Command](EntityType, R2dbcReplication())
      .withSelfReplicaId(ReplicaId(locationId))
      .withInitialConsumerFilter(
        // only replicate charging stations local to the edge system
        Seq(
          ConsumerFilter.excludeAll,
          ConsumerFilter.IncludeTopics(Set(locationId))))
  Replication.grpcEdgeReplication(replicationSettings)(ChargingStation.apply)
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-java/src/main/java/charging/ChargingStation.java#L154-L165" target="_blank" title="Go to snippet source">source</a><code class="language-java">public static EdgeReplication&lt;Command&gt; initEdge(ActorSystem&lt;?&gt; system, String locationId) {
  var replicationSettings =
      ReplicationSettings.create(
              Command.class, ENTITY_TYPE, R2dbcReplication.create(system), system)
          .withSelfReplicaId(new ReplicaId(locationId))
          .withInitialConsumerFilter(
              List.of(
                  // only replicate charging stations local to the edge system
                  ConsumerFilter.excludeAll(),
                  new ConsumerFilter.IncludeTopics(Set.of(locationId))));
  return Replication.grpcEdgeReplication(replicationSettings, ChargingStation::create, system);
}</code></pre></dd>
</dl>
<p>The returned <code>EdgeReplication</code> instance gives us access to a <code>entityRefFactory</code> for sending messages to the charging stations.</p>
<h2><a href="#service-for-interacting-with-the-charging-station" name="service-for-interacting-with-the-charging-station" class="anchor"><span class="anchor-link"></span></a>Service for interacting with the charging station</h2>
<p>In the restaurant-drone-deliveries service we introduce a separate gRPC endpoint for creating and looking at charging station state:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/restaurant-drone-deliveries-service-java/src/main/protobuf/charging/charging_station_api.proto" target="_blank" title="Go to snippet source">source</a><code class="language-proto">syntax = &quot;proto3&quot;;

option java_multiple_files = true;
option java_package = &quot;charging.proto&quot;;

import &quot;google/protobuf/timestamp.proto&quot;;

package charging;

service ChargingStationService {
  rpc CreateChargingStation(CreateChargingStationRequest) returns (CreateChargingStationResponse) {}
  rpc GetChargingStationState(GetChargingStationStateRequest) returns (GetChargingStationStateResponse) {}
}

message CreateChargingStationRequest {
  // unique identifier for the charging station
  string charging_station_id = 1;
  // location of the station
  string location_id = 2;
  // number of parallel charging slots for drones
  uint32 charging_slots = 3;
}

message CreateChargingStationResponse {
}

message GetChargingStationStateRequest {
  string charging_station_id = 1;
}

message GetChargingStationStateResponse {
  // location of the station
  string location_id = 1;
  // number of parallel charging slots for drones
  uint32 charging_slots = 2;
  // drones currently at the station charging
  repeated ChargingDrone currently_charging_drones = 3;
}

message ChargingDrone {
  string drone_id = 1;
  // timestamp when charging is estimated to complete
  google.protobuf.Timestamp expected_complete = 2;
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/restaurant-drone-deliveries-service-scala/src/main/protobuf/charging/charging_station_api.proto" target="_blank" title="Go to snippet source">source</a><code class="language-proto">syntax = &quot;proto3&quot;;

option java_multiple_files = true;
option java_package = &quot;charging.proto&quot;;

import &quot;google/protobuf/timestamp.proto&quot;;

package charging;

service ChargingStationService {
  rpc CreateChargingStation(CreateChargingStationRequest) returns (CreateChargingStationResponse) {}
  rpc GetChargingStationState(GetChargingStationStateRequest) returns (GetChargingStationStateResponse) {}
}

message CreateChargingStationRequest {
  // unique identifier for the charging station
  string charging_station_id = 1;
  // location of the station
  string location_id = 2;
  // number of parallel charging slots for drones
  uint32 charging_slots = 3;
}

message CreateChargingStationResponse {
}

message GetChargingStationStateRequest {
  string charging_station_id = 1;
}

message GetChargingStationStateResponse {
  // location of the station
  string location_id = 1;
  // number of parallel charging slots for drones
  uint32 charging_slots = 2;
  // drones currently at the station charging
  repeated ChargingDrone currently_charging_drones = 3;
}

message ChargingDrone {
  string drone_id = 1;
  // timestamp when charging is estimated to complete
  google.protobuf.Timestamp expected_complete = 2;
}</code></pre></dd>
</dl>
<p>The service implementation takes the <code>entityRefFactory</code> as a constructor parameter and uses that to create <code>EntityRef</code> instances for specific charging stations to interact with them:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/restaurant-drone-deliveries-service-scala/src/main/scala/charging/ChargingStationServiceImpl.scala" target="_blank" title="Go to snippet source">source</a><code class="language-scala">package charging

import akka.actor.typed.ActorSystem
import akka.cluster.sharding.typed.scaladsl.EntityRef
import akka.util.Timeout
import charging.proto
import com.google.protobuf.timestamp.Timestamp
import org.slf4j.LoggerFactory

import scala.concurrent.Future
import scala.concurrent.duration.DurationInt

class ChargingStationServiceImpl(
    entityRefFactory: String =&gt; EntityRef[ChargingStation.Command])(
    implicit val system: ActorSystem[_])
    extends proto.ChargingStationService {
  private final val log = LoggerFactory.getLogger(getClass)
  import system.executionContext
  // FIXME separate setting
  implicit val askTimeout: Timeout = 3.seconds

  override def createChargingStation(in: proto.CreateChargingStationRequest)
      : Future[proto.CreateChargingStationResponse] = {
    log.info(
      &quot;Creating charging station {} with {} charging slots, in location {}&quot;,
      in.chargingStationId,
      in.chargingSlots,
      in.locationId)

    val entityRef = entityRefFactory(in.chargingStationId)
    entityRef
      .ask(ChargingStation.Create(in.locationId, in.chargingSlots, _))
      .map(_ =&gt; proto.CreateChargingStationResponse.defaultInstance)

  }

  override def getChargingStationState(in: proto.GetChargingStationStateRequest)
      : Future[proto.GetChargingStationStateResponse] = {
    log.info(&quot;Get charging station {} state&quot;, in.chargingStationId)
    val entityRef = entityRefFactory(in.chargingStationId)
    entityRef
      .askWithStatus(ChargingStation.GetState.apply)
      .map(state =&gt;
        proto.GetChargingStationStateResponse(
          locationId = state.stationLocationId,
          chargingSlots = state.chargingSlots,
          currentlyChargingDrones = state.dronesCharging
            .map(d =&gt;
              proto.ChargingDrone(
                droneId = d.droneId,
                expectedComplete = Some(Timestamp(d.expectedComplete))))
            .toSeq))
  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/restaurant-drone-deliveries-service-java/src/main/java/charging/ChargingStationServiceImpl.java" target="_blank" title="Go to snippet source">source</a><code class="language-java">package charging;

import akka.Done;
import akka.cluster.sharding.typed.javadsl.EntityRef;
import akka.grpc.GrpcServiceException;
import central.DeliveriesSettings;
import charging.proto.*;
import com.google.protobuf.Timestamp;
import io.grpc.Status;
import java.time.Duration;
import java.time.Instant;
import java.util.concurrent.CompletionStage;
import java.util.concurrent.TimeoutException;
import java.util.function.Function;
import java.util.stream.Collectors;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class ChargingStationServiceImpl implements ChargingStationService {

  private static final Logger logger = LoggerFactory.getLogger(ChargingStationServiceImpl.class);

  private final Function&lt;String, EntityRef&lt;ChargingStation.Command&gt;&gt; entityRefFactory;
  private final Duration askTimeout;

  public ChargingStationServiceImpl(
      DeliveriesSettings settings,
      Function&lt;String, EntityRef&lt;ChargingStation.Command&gt;&gt; entityRefFactory) {
    this.entityRefFactory = entityRefFactory;
    // FIXME separate setting
    this.askTimeout = settings.droneAskTimeout;
  }

  @Override
  public CompletionStage&lt;CreateChargingStationResponse&gt; createChargingStation(
      CreateChargingStationRequest in) {
    logger.info(
        &quot;Creating charging station {} with {} charging slots, in location {}&quot;,
        in.getChargingStationId(),
        in.getChargingSlots(),
        in.getLocationId());

    var entityRef = entityRefFactory.apply(in.getChargingStationId());

    CompletionStage&lt;Done&gt; chargingStationReply =
        entityRef.askWithStatus(
            replyTo -&gt;
                new ChargingStation.Create(in.getLocationId(), in.getChargingSlots(), replyTo),
            askTimeout);

    var response =
        chargingStationReply.thenApply(done -&gt; CreateChargingStationResponse.getDefaultInstance());

    return convertError(response);
  }

  @Override
  public CompletionStage&lt;GetChargingStationStateResponse&gt; getChargingStationState(
      GetChargingStationStateRequest in) {
    logger.info(&quot;Get charging station {} state&quot;, in.getChargingStationId());
    var entityRef = entityRefFactory.apply(in.getChargingStationId());
    return entityRef
        .askWithStatus(ChargingStation.GetState::new, askTimeout)
        .thenApply(
            state -&gt;
                GetChargingStationStateResponse.newBuilder()
                    .setLocationId(state.stationLocationId)
                    .setChargingSlots(state.chargingSlots)
                    .addAllCurrentlyChargingDrones(
                        state.dronesCharging.stream()
                            .map(
                                d -&gt;
                                    ChargingDrone.newBuilder()
                                        .setDroneId(d.droneId)
                                        .setExpectedComplete(
                                            instantToProtoTimestamp(d.expectedComplete))
                                        .build())
                            .collect(Collectors.toList()))
                    .build());
  }

  private static Timestamp instantToProtoTimestamp(Instant instant) {
    return Timestamp.newBuilder()
        .setSeconds(instant.getEpochSecond())
        .setNanos(instant.getNano())
        .build();
  }

  private &lt;T&gt; CompletionStage&lt;T&gt; convertError(CompletionStage&lt;T&gt; response) {
    return response.exceptionally(
        error -&gt; {
          if (error instanceof TimeoutException) {
            throw new GrpcServiceException(
                Status.UNAVAILABLE.withDescription(&quot;Operation timed out&quot;));
          } else {
            throw new GrpcServiceException(Status.INTERNAL.withDescription(error.getMessage()));
          }
        });
  }
}</code></pre></dd>
</dl>
<h2><a href="#interacting-with-the-charging-station-at-the-edge" name="interacting-with-the-charging-station-at-the-edge" class="anchor"><span class="anchor-link"></span></a>Interacting with the charging station at the edge</h2>
<p>The local-drone-control service does not contain the full gRPC API for creating and inspecting charging stations but instead two methods in the drone gRPC service <code>goCharge</code> to initiate charging of a drone if possible and <code>completeCharge</code> to complete a charging session for a given drone:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-scala/src/main/scala/local/drones/DroneServiceImpl.scala#L91-L127" target="_blank" title="Go to snippet source">source</a><code class="language-scala">override def goCharge(
    in: proto.GoChargeRequest): Future[proto.ChargingResponse] = {
  logger.info(
    &quot;Requesting charge of {} from {}&quot;,
    in.droneId,
    in.chargingStationId)
  val entityRef = chargingStationEntityRefFactory(in.chargingStationId)
  val response = entityRef
    .askWithStatus[ChargingStation.StartChargingResponse](
      ChargingStation.StartCharging(in.droneId, _))
    .map {
      case ChargingStation.ChargingStarted(_, expectedComplete) =&gt;
        proto.ChargingResponse(
          proto.ChargingResponse.Response.Started(
            proto.ChargingStarted(Some(Timestamp(expectedComplete)))))
      case ChargingStation.AllSlotsBusy(comeBackAt) =&gt;
        proto.ChargingResponse(
          proto.ChargingResponse.Response
            .ComeBackLater(proto.ComeBackLater(Some(Timestamp(comeBackAt)))))
    }
  convertError(response)
}

override def completeCharge(in: proto.CompleteChargeRequest)
    : Future[proto.CompleteChargingResponse] = {
  logger.info(
    &quot;Requesting complete charging of {} from {}&quot;,
    in.droneId,
    in.chargingStationId)

  val entityRef = chargingStationEntityRefFactory(in.chargingStationId)
  val response = entityRef
    .askWithStatus(ChargingStation.CompleteCharging(in.droneId, _))
    .map(_ =&gt; proto.CompleteChargingResponse.defaultInstance)

  convertError(response)
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/grpc/local-drone-control-java/src/main/java/local/drones/DroneServiceImpl.java#L126-L179" target="_blank" title="Go to snippet source">source</a><code class="language-java">@Override
public CompletionStage&lt;ChargingResponse&gt; goCharge(GoChargeRequest in) {
  logger.info(&quot;Requesting charge of {} from {}&quot;, in.getDroneId(), in.getChargingStationId());
  var entityRef = chargingStationEntityRefFactory.apply(in.getChargingStationId());

  CompletionStage&lt;ChargingStation.StartChargingResponse&gt; chargingStationResponse =
      entityRef.askWithStatus(
          replyTo -&gt; new ChargingStation.StartCharging(in.getDroneId(), replyTo),
          settings.askTimeout);

  var response =
      chargingStationResponse.thenApply(
          message -&gt; {
            if (message instanceof ChargingStation.ChargingStarted) {
              var expectedComplete = ((ChargingStation.ChargingStarted) message).expectedComplete;
              return ChargingResponse.newBuilder()
                  .setStarted(
                      ChargingStarted.newBuilder()
                          .setExpectedComplete(instantToProtoTimestamp(expectedComplete))
                          .build())
                  .build();
            } else if (message instanceof ChargingStation.AllSlotsBusy) {
              var firstSlotFreeAt = ((ChargingStation.AllSlotsBusy) message).firstSlotFreeAt;
              return ChargingResponse.newBuilder()
                  .setComeBackLater(
                      ComeBackLater.newBuilder()
                          .setFirstSlotFreeAt(instantToProtoTimestamp(firstSlotFreeAt))
                          .build())
                  .build();
            } else {
              throw new IllegalArgumentException(
                  &quot;Unexpected response type &quot; + message.getClass());
            }
          });

  return convertError(response);
}

@Override
public CompletionStage&lt;CompleteChargingResponse&gt; completeCharge(CompleteChargeRequest in) {
  logger.info(
      &quot;Requesting complete charging of {} from {}&quot;, in.getDroneId(), in.getChargingStationId());
  var entityRef = chargingStationEntityRefFactory.apply(in.getChargingStationId());

  CompletionStage&lt;Done&gt; chargingStationResponse =
      entityRef.askWithStatus(
          replyTo -&gt; new ChargingStation.CompleteCharging(in.getDroneId(), replyTo),
          settings.askTimeout);

  var response =
      chargingStationResponse.thenApply(done -&gt; CompleteChargingResponse.getDefaultInstance());

  return convertError(response);
}</code></pre></dd>
</dl>
<h2><a href="#running" name="running" class="anchor"><span class="anchor-link"></span></a>Running</h2>
<p>The complete sample can be downloaded from GitHub, but note that it also includes the next steps of the guide:</p>
<ul>
  <li>Scala <a href="../attachments/drone-scala.zip">drone-scala.zip</a></li>
  <li>Java <a href="../attachments/drone-java.zip">drone-java.zip</a></li>
</ul>
<p>As this service consumes events from the service built in the previous step, start the local-drone-control service first:</p><div class="group-scala">
<p>To start the local-drone-control-service:</p>
<pre class="prettyprint"><code class="language-shell">sbt run
</code></pre></div><div class="group-java">
<pre class="prettyprint"><code class="language-shell">mvn compile exec:exec
</code></pre></div>
<p>Then start the drone-restaurant-deliveries-service.</p>
<p>As the service needs a PostgreSQL instance running, start that up in a docker container and create the database schema if you did not do that in a previous step of the guide:</p>
<pre class="prettyprint"><code class="language-shell">docker compose up --wait
docker exec -i postgres_db psql -U postgres -t &lt; ddl-scripts/create_tables.sql
</code></pre>
<p>Then start the service:</p><div class="group-scala">
<pre class="prettyprint"><code class="language-shell">sbt -Dconfig.resource=local1.conf run
</code></pre>
<p>And optionally one or two more Akka cluster nodes, but note that the local drone controls are statically configured to the gRPC port of the first and will only publish events to that node.</p>
<pre class="prettyprint"><code class="language-shell">sbt -Dconfig.resource=local2.conf run
sbt -Dconfig.resource=local3.conf run
</code></pre></div><div class="group-java">
<pre class="prettyprint"><code class="language-shell">mvn compile exec:exec -DAPP_CONFIG=local1.conf
</code></pre>
<p>And optionally one or two more Akka cluster nodes, but note that the local drone controls are statically configured to the gRPC port of the first and will only publish events to that node.</p>
<pre class="prettyprint"><code class="language-shell">mvn compile exec:exec -DAPP_CONFIG=local2.conf
mvn compile exec:exec -DAPP_CONFIG=local3.conf
</code></pre></div>
<p>Set up a replicated charging station in the cloud service using <a href="https://github.com/fullstorydev/grpcurl">grpcurl</a>:</p>
<pre class="prettyprint"><code class="language-shell">grpcurl -d &#39;{&quot;charging_station_id&quot;:&quot;station1&quot;,&quot;location_id&quot;: &quot;sweden/stockholm/kungsholmen&quot;, &quot;charging_slots&quot;: 4}&#39; -plaintext localhost:8101 charging.ChargingStationService.CreateChargingStation
</code></pre>
<p>Ask to charge the drone with id <code>drone1</code> at the charging station in the edge service:</p>
<pre class="prettyprint"><code class="language-shell">grpcurl -d &#39;{&quot;drone_id&quot;:&quot;drone1&quot;,&quot;charging_station_id&quot;:&quot;station1&quot;}&#39; -plaintext 127.0.0.1:8080 local.drones.DroneService.GoCharge
</code></pre>
<p>Inspect the state of the charging station in the cloud service to see the charging drone replicated there:</p>
<pre class="prettyprint"><code class="language-shell">grpcurl -d &#39;{&quot;charging_station_id&quot;:&quot;station1&quot;}&#39; -plaintext localhost:8101 charging.ChargingStationService.GetChargingStationState
</code></pre>
<p>Inform the station that the drone completed charging:</p>
<pre class="prettyprint"><code class="language-shell">grpcurl -d &#39;{&quot;drone_id&quot;:&quot;drone1&quot;,&quot;charging_station_id&quot;:&quot;station1&quot;}&#39; -plaintext 127.0.0.1:8080 local.drones.DroneService.CompleteCharge
</code></pre>
<p>Again query the restaurant-drone-deliveries charge station inspection command to see the set of charging drones changing again:</p>
<pre class="prettyprint"><code class="language-shell">grpcurl -d &#39;{&quot;charging_station_id&quot;:&quot;station1&quot;}&#39; -plaintext localhost:8101 charging.ChargingStationService.GetChargingStationState
</code></pre>
</div>
</article>
<div class="row">
<div class="small-12 column">
<section class="nav-prev-next row">
<div class="nav-prev small-6 column">
<a href="../guide/4-local-drone-delivery-selection.html"><i class="icon-prev"></i> <span class="link-prev">Local Drone Delivery Selection</span></a>
</div>
<div class="nav-next small-6 column clearfix">
<a class="float-right" href="../guide/6-deploying-the-services.html">Deploying the Restaurant Delivery Service <i class="icon-next"></i></a>
</div>
</section>
</div>
</div>
<div class="source-github row">
Found an error in this documentation? The source code for this page can be found <a href="https://github.com/akka/akka-projection/tree/master/akka-edge-docs/src/main/paradox/guide/5-charging-station.md">here</a>.
Please feel free to edit and contribute a pull request.
</div>

<footer class="page-footer row clearfix">
<img class="akka-icon float-left show-for-medium" src="../images/akka-icon.svg" />
<section class="copyright">
<div>Akka Edge is available under the <a href="https://www.lightbend.com/akka/license" target="_blank">Business Source License 1.1</a>.</div>
<p class="legal">
&copy; 2011-2024 <a href="https://www.lightbend.com" target="_blank">Lightbend, Inc.</a> |
<a href="https://www.lightbend.com/legal/licenses" target="_blank">Licenses</a> |
<a href="https://www.lightbend.com/legal/terms" target="_blank">Terms</a> |
<a href="https://www.lightbend.com/legal/privacy" target="_blank">Privacy Policy</a> |
<a href="https://akka.io/cookie/" target="_blank">Cookie Listing</a> |
<a class="optanon-toggle-display">Cookie Settings</a>
</p>
</section>

</footer>
</section>
</main>
</div>

<script type="text/javascript" src="../js/scrollsneak.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../js/groups.js"></script>
<script type="text/javascript" src="../js/page.js"></script>
<script type="text/javascript" src="../js/snippets.js"></script>
<script type="text/javascript" src="../js/magellan.js"></script>
<script type="text/javascript" src="../js/metadata-toggle.js"></script>
<script type="text/javascript" src="../js/lbHeader.js"></script>

<style type="text/css">@import "../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(){window.prettyPrint && prettyPrint()});
//]]></script>
<!-- hook for including project specific javascript into the generated docs -->

</body>
</html>
