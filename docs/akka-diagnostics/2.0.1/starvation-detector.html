<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Akka Thread Starvation Detector &bull; Akka Diagnostics</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="Akka diagnostics tools and utilities"/>
<link rel="canonical" href="https://doc.akka.io/docs/akka-diagnostics/current/starvation-detector.html"/>
<script type="text/javascript" src="lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="lib/foundation/dist/js/foundation.min.js"></script>
<link rel="stylesheet" type="text/css" href="lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="lib/foundation/dist/css/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" type="text/css" href="css/icons.css"/>
<link rel="stylesheet" type="text/css" href="css/page-8.css"/>
<link rel="stylesheet" type="text/css" href="css/banner-2.css"/>
<link rel="shortcut icon" href="images/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png"/>
<link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png"/>
<link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png"/>
<link rel="manifest" href="images/manifest.json"/>
<meta name="msapplication-TileImage" content="images/mstile-150x150.png"/>
<meta name="msapplication-TileColor" content="#15a9ce"/>
<meta name="theme-color" content="#15a9ce"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) start -->
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js"  type="text/javascript" charset="UTF-8" data-domain-script="28b912e7-09e9-43d5-91e4-3d1897044004" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) end -->
<!--Google Analytics NOTE this will stop processing data July 1st 2023. At which point this embed code can be removed-->
<script type="text/plain" class="optanon-category-2">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', '']);
_gaq.push(['_setDomainName', '']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})()
</script>

<!-- Google Tag Manager: Updated May 17th 2023 - Cookie Compliance checks have been moved into Google Tag Manager -->
<script type="text/javascript">
(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KBJGH35');
</script>

</head>

<body id="underlay" data-toggler="nav-open">
<div id="lightbend-banner" class="lightbend-banner akka full-width" data-category="OSS Lightbend Banner Impression" data-label="Akka Banner Impression">
<div class="oss-wrapper">
<div class="oss-brand">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lightbend Logo - Akka Banner" href="https://www.lightbend.com">
<img class="lightbend-logo" src="images/banner-logos/lightbend-reverse.svg" alt="Lightbend" title="Lightbend">
</a>
</div>
<div class="oss-ad no-drop-down">
<nav id="lightbendRotator" class="lightbend-rotator">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Promo Rotator - Lightbend Changed its Software Licensing Model for Akka Technology. [License FAQ] - Akka Banner" href="https://www.lightbend.com/akka/license-faq">
<strong>Lightbend</strong> Changed its Software Licensing Model for Akka Technology. <span class="akka-btn">License FAQ</span>
</a>
</nav>
</div>
</div>
</div>

<header class="site-header hide-for-large">
<div class="sticky-header clearfix">
<a href="https://akka.io"><img class="logo" src="images/akka-logo-reverse.svg"/></a>

<button class="menu-icon float-right" type="button" data-toggle="underlay overlay"></button>
</div>
<div id="overlay" class="overlay-nav" data-toggler="nav-open">
<header class="nav-header">
<div class="nav-header-title">
<h1><a href="index.html">Akka Diagnostics</a></h1>
</div>
<div class="nav-header-version">
Version 2.0.1
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Languages"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="nav-toc">
<ul>
  <li><a href="starvation-detector.html#akka-thread-starvation-detector" class="active page">Akka Thread Starvation Detector</a>
  <ul>
    <li><a href="starvation-detector.html#project-info" class="header">Project Info</a></li>
    <li><a href="starvation-detector.html#using-the-starvation-detector" class="header">Using the Starvation Detector</a></li>
    <li><a href="starvation-detector.html#configuration" class="header">Configuration</a></li>
    <li><a href="starvation-detector.html#understanding-the-log-output" class="header">Understanding The Log Output</a></li>
    <li><a href="starvation-detector.html#solving-thread-starvation-issues" class="header">Solving Thread Starvation Issues</a></li>
  </ul></li>
  <li><a href="config-checker.html" class="page">Akka Config Checker</a></li>
</ul>
</nav>
</div>
</header>
<div class="site-content-wrapper">
<aside class="sticky-sidebar show-for-large">
<header class="nav-header sticky-sidebar-header">
<div class="nav-header-title">
<h1><a href="index.html">Akka Diagnostics</a></h1>
</div>
<div class="nav-header-version">
Version 2.0.1
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Languages"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="site-nav sticky-sidebar-contents">
<div class="nav-toc">
<ul>
  <li><a href="starvation-detector.html#akka-thread-starvation-detector" class="active page">Akka Thread Starvation Detector</a>
  <ul>
    <li><a href="starvation-detector.html#project-info" class="header">Project Info</a></li>
    <li><a href="starvation-detector.html#using-the-starvation-detector" class="header">Using the Starvation Detector</a></li>
    <li><a href="starvation-detector.html#configuration" class="header">Configuration</a></li>
    <li><a href="starvation-detector.html#understanding-the-log-output" class="header">Understanding The Log Output</a></li>
    <li><a href="starvation-detector.html#solving-thread-starvation-issues" class="header">Solving Thread Starvation Issues</a></li>
  </ul></li>
  <li><a href="config-checker.html" class="page">Akka Config Checker</a></li>
</ul>
</div>
</nav>
<footer class="nav-footer sticky-sidebar-footer">
<a href="https://akka.io"><img class="logo" src="images/akka-logo-reverse.svg"/></a>

</footer>
</aside>
<main class="fixed-shift-for-large expanded row">
<section class="site-content small-12 column">
<article class="page-content row">
<div class="small-12 column" id="docs">
<h1><a href="#akka-thread-starvation-detector" name="akka-thread-starvation-detector" class="anchor"><span class="anchor-link"></span></a>Akka Thread Starvation Detector</h1>
<p>The Akka Thread Starvation Detector is a diagnostic tool that monitors the dispatcher of an <code>ActorSystem</code> and will log a warning if the dispatcher becomes unresponsive.</p>
<p>The most common reason for an <code>ActorSystem</code> to become unresponsive is that blocking tasks are run on the dispatcher and other tasks cannot be executed in a timely fashion any more. This will lead to all kinds of problems because tasks (like handling an Actor&rsquo;s mailbox or executing a Future callback) are usually expected to finish in very short time on a healthy <code>ActorSystem</code>. When thread starvation occurs, all threads of the dispatcher&rsquo;s thread pool are blocking e.g. doing IO, delaying other work for indefinite periods of time. The symptoms of thread starvation are usually increased latency (despite low CPU usage), timeouts, or failing Akka Remote connections.</p>
<p>The Starvation Detector will periodically schedule a simple task to measure the scheduling and execution time of the dispatcher. If a threshold is exceeded, a warning is logged with stack traces that show what threads of the dispatcher are busy with.</p>
<h2><a href="#project-info" name="project-info" class="anchor"><span class="anchor-link"></span></a>Project Info</h2>
<table class="project-info">
<tr><th colspan="2">Project Info: Akka Diagnostics</th></tr>
  <tr><th>Artifact</th><td><div>com.lightbend.akka</div>
  <div>akka-diagnostics</div>
  <div>2.0.1</div></td></tr>
  <tr><th>JDK versions</th><td><div>OpenJDK 8</div><div>OpenJDK 11</div><div>OpenJDK 17</div></td></tr>
  <tr><th>Scala versions</th><td>2.13.10, 2.12.17, 3.1.3</td></tr>
  <tr><th>JPMS module name</th><td>akka.diagnostics</td></tr>
  <tr><th>License</th><td><div><a href="https://raw.githubusercontent.com/akka/akka-diagnostics/v2.0.1/LICENSE" target="_blank" rel="noopener noreferrer">BUSL-1.1</a></div>
  </td></tr>
  <tr><th>Readiness level</th><td><div class="readiness-level"><a href="https://developer.lightbend.com/docs/introduction/getting-help/support-terminology.html#incubating" target="_blank" rel="noopener">Incubating</a></div>
  <div>Since 2.0.0-M1, 2022-11-28</div>
  </td></tr>
  <tr><th>Home page</th><td><a href="https://doc.akka.io/docs/akka-diagnostics/current">https://doc.akka.io/docs/akka-diagnostics/current</a></td></tr>
  <tr><th>Forums</th><td>
  <div><a href="https://discuss.lightbend.com/c/akka/" target="_blank" rel="noopener noreferrer">Lightbend Discuss</a></div>
  <div><a href="https://gitter.im/akka/akka" target="_blank" rel="noopener noreferrer">akka/akka Gitter channel</a></div>
  </td></tr>
  <tr><th>Release notes</th><td><a href="https://github.com/akka/akka-diagnostics/releases" target="_blank" rel="noopener noreferrer">Github releases</a></td></tr>
  <tr><th>Issues</th><td><a href="https://github.com/akka/akka-diagnostics/issues" target="_blank" rel="noopener noreferrer">Github issues</a></td></tr>
  <tr><th>Sources</th><td><a href="https://github.com/akka/akka-diagnostics" target="_blank" rel="noopener noreferrer">https://github.com/akka/akka-diagnostics</a></td></tr>
</table>

<h2><a href="#using-the-starvation-detector" name="using-the-starvation-detector" class="anchor"><span class="anchor-link"></span></a>Using the Starvation Detector</h2>

<p>To use the Starvation Detector feature a dependency on the <em>akka-diagnostics</em> artifact must be added.</p>

<p>The Akka dependencies are available from Akka&rsquo;s library repository. To access them there, you need to configure the URL for this repository.</p>
<dl class="repository"><dt>Maven</dt><dd><pre class="prettyprint"><code class="language-xml">&lt;project&gt
  ...
  &lt;repositories&gt;
    &lt;repository&gt;
      &lt;id&gt;akka-repository&lt;/id&gt;
      &lt;name>Akka library repository&lt;/name&gt;
      &lt;url>https://repo.akka.io/maven&lt;/url&gt;
    &lt;/repository&gt;
  &lt;/repositories&gt
&lt;/project&gt;
</code></pre></dd><dt>sbt</dt><dd><pre class="prettyprint"><code class="language-scala">resolvers += "Akka library repository".at("https://repo.akka.io/maven")
</code></pre></dd><dt>Gradle</dt><dd><pre class="prettyprint"><code class="language-gradle">repositories {
    mavenCentral()
    maven {
        url "https://repo.akka.io/maven"
    }
}
</code></pre></dd></dl>
<p>Additionally, add the dependency as below.</p><dl class="dependency"><dt>Maven</dt><dd><pre class="prettyprint"><code class="language-xml">&lt;properties&gt;
  &lt;scala.binary.version&gt;2.13&lt;/scala.binary.version&gt;
&lt;/properties&gt;
&lt;dependencies&gt
  &lt;dependency&gt;
    &lt;groupId&gt;com.lightbend.akka&lt;/groupId&gt;
    &lt;artifactId&gt;akka-diagnostics_${scala.binary.version}&lt;/artifactId&gt;
    &lt;version&gt;2.0.1&lt;/version&gt;
  &lt;/dependency&gt
&lt;/dependencies&gt;</code></pre></dd><dt>sbt</dt><dd><pre class="prettyprint"><code class="language-scala">libraryDependencies += "com.lightbend.akka" %% "akka-diagnostics" % "2.0.1"</code></pre></dd><dt>Gradle</dt><dd><pre class="prettyprint"><code class="language-gradle">def versions = [
  ScalaBinary: "2.13"
]
dependencies {
  implementation "com.lightbend.akka:akka-diagnostics_${versions.ScalaBinary}:2.0.1"
}</code></pre></dd></dl>
<p>This plugin depends on Akka 2.7.0 or later, and note that it is important that all <code>akka-*</code> dependencies are in the same version, so it is recommended to depend on them explicitly to avoid problems with transient dependencies causing an unlucky mix of versions.</p>
<p>When this dependency is included the Starvation Detector is automatically run when the <em>ActorSystem</em> is started.</p>
<p>You can create starvation detectors for other execution contexts than the main Akka ActorSystem one as well.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><code class="language-scala">import akka.diagnostics.StarvationDetector

StarvationDetector.checkDispatcher(system, dispatcherConfigPath = &quot;my-dispatcher&quot;)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><code class="language-java">import akka.diagnostics.StarvationDetector;

String dispatcherConfigPath = &quot;my-dispatcher&quot;;
StarvationDetector.checkDispatcher(system, dispatcherConfigPath);</code></pre></dd>
</dl>
<p>You can use <code>com.lightbend.akka.diagnostics.StarvationDetector.checkExecutionContext</code> to create a starvation detector for any <code>ExecutionContext</code> (though, it will not include stack trace information if the <code>ExecutionContext</code> is not an Akka Dispatcher).</p>
<h2><a href="#configuration" name="configuration" class="anchor"><span class="anchor-link"></span></a>Configuration</h2>
<p>You can customize settings of the starvation detector to prevent spurious logging depending on your application logic.</p>
<pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><code class="language-conf"># The starvation detector is a dedicated thread that schedules a task on the system&#39;s
# main dispatcher and checks if the execution time is less than the threshold. Exceeding the
# threshold is an indication for thread starvation. The starvation detector will log a warning
# in that case with statistics and stack traces of the dispatcher&#39;s threads.
akka.diagnostics.starvation-detector {
  # The interval to check task execution time on the dispatcher.
  #
  # Set to 0 or &quot;off&quot; to disable checking.
  check-interval = 1s

  # The starvation detector only runs after the initial delay. The idea is that during startup,
  # initial tasks like class loading, warming up JIT and similar environment issues can decrease
  # the overall throughput. As this is usually a transient condition, checking will only run after
  # the configured time.
  #
  # Set to 0 or &quot;off&quot; to run checking right from the start.
  initial-delay = 10s

  # The maximum time during which the dispatcher is expected to execute the starvation detection task.
  # If the dispatcher takes longer to execute the task, the dispatcher (and CPU or other infrastructure
  # that is needed to run tasks) is considered busy and a warning is logged.
  #
  # The default value was chosen to be high enough to decrease the likelihood of false positives while
  # still being likely to show severe problems early.
  #
  # For many applications (and also for internal Akka messaging) much smaller delays can already become
  # a problem. To detect smaller dispatcher related delays, decrease the value, but keep in mind the
  # higher chance of false positives.
  max-delay-warning-threshold = 100 ms

  # The minimum time between consecutive warnings.
  #
  # When thread starvation is detected it is likely that it will last for a longer period of time.
  # This setting can be used to prevent that warnings from the starvation detector flood the logs.
  warning-interval = 10 seconds

  # When the starvation detector triggers, it will show aggregated information about the state of threads in a pool.
  # Threads are aggregated by traces and, by default, the top 5 stack traces (by number of threads having the same trace)
  # are shown.
  #
  # Use &quot;infinite&quot; to show aggregated numbers for all threads.
  thread-traces-limit = 5
}</code></pre>
<p>By default, the starvation detector runs seldom enough not to cause any performance hit itself. Thread starvation issues usually affect systems for longer time spans, so the starvation detector is still likely to experience and warn even when it runs only infrequently.</p><div class="callout note "><div class="callout-title">Java 17</div>
<p>When using the Starvation Detector with Java 17 or higher you have to add JVM flag <code>--add-opens=java.base/java.util.concurrent=ALL-UNNAMED</code>.</p></div>
<h2><a href="#understanding-the-log-output" name="understanding-the-log-output" class="anchor"><span class="anchor-link"></span></a>Understanding The Log Output</h2>
<p>Here&rsquo;s an example warning (taken from our tests that simulate blocking calls using <code>Thread.sleep</code>):</p>
<pre><code>[WARN] [04/24/2017 15:38:35.661] [Thread-217] [StarvationDetector(akka://StarvationDetectorSpec)] Exceedingly long scheduling
time on ExecutionContext Dispatcher[akka.actor.default-dispatcher]. Starvation detector task was only executed after 714 ms which is
longer than the warning threshold of 100 milliseconds. This might be a sign of thread, CPU, or dispatcher starvation.
This can be caused by blocking calls, CPU overload, GC, or overlong work units. See the below information for hints
about what could be the cause. Next warning will be shown in 10000 milliseconds.

Thread states (total 2 thread):   2 TIMED_WAITING
Top stacks:
  2 java.lang.Thread.sleep(Native Method)
    StarvationDetectorSpec$$[...]runOne$1$1.apply$mcV$sp(StarvationDetectorSpec.scala:17)
    [...]
</code></pre>
<p>The logging message gives this information:</p>
<ul>
  <li>Scheduling time for the starvation detector task (714 milliseconds)</li>
  <li>Some general hints what could be the reason for the delay</li>
  <li>Thread state statistics (<code>TIMED_WAITING</code> which is the state <code>Thread.sleep</code> puts a thread in)</li>
  <li>A histogram of stack traces for all threads of this dispatcher ordered by the most frequent stack trace first  (in this case all of the 2 threads of the dispatcher were blocking in <code>Thread.sleep</code> with the same strack trace).  The shown stack traces show the state of threads when the threshold was exceeded and are only a single sample of  the state of the application when the condition occurred. The information should therefore be taken only as an  indication of what could be wrong not as the final answer.</li>
</ul><div class="callout note "><div class="callout-title">Note</div>
<p>Many blocking IO tasks will block in native code which means that from the view of the JVM, the thread is in <code>RUNNABLE</code> state. Therefore, the thread state statistics will only give a hint at what is going on but the stack traces will usually give more useful information.</p></div>
<h2><a href="#solving-thread-starvation-issues" name="solving-thread-starvation-issues" class="anchor"><span class="anchor-link"></span></a>Solving Thread Starvation Issues</h2>
<p>See <a href="https://doc.akka.io/docs/akka/2.7/dispatchers.html#blocking-needs-careful-management">Blocking Needs Careful Management</a> in the Akka reference documentation. The Akka-Http documentation also has a page on <a href="https://doc.akka.io/docs/akka-http/10.4.0/handling-blocking-operations-in-akka-http-routes.html">&ldquo;Handling blocking operations&rdquo;</a> that applies generally to all Akka applications.</p>
</div>
</article>
<div class="row">
<div class="small-12 column">
<section class="nav-prev-next row">
<div class="nav-prev small-6 column">
<a href="index.html"><i class="icon-prev"></i> <span class="link-prev">Akka Diagnostics</span></a>
</div>
<div class="nav-next small-6 column clearfix">
<a class="float-right" href="config-checker.html">Akka Config Checker <i class="icon-next"></i></a>
</div>
</section>
</div>
</div>
<div class="source-github row">
Found an error in this documentation? The source code for this page can be found <a href="https://github.com/akka/akka-diagnostics/tree/v2.0.1/docs/src/main/paradox/starvation-detector.md">here</a>.
Please feel free to edit and contribute a pull request.
</div>

<footer class="page-footer row clearfix">
<img class="akka-icon float-left show-for-medium" src="images/akka-icon.svg" />
<section class="copyright">
<div>Akka Diagnostics is available under the <a href="https://www.lightbend.com/akka/license" target="_blank">Business Source License 1.1</a>.</div>
<p class="legal">
&copy; 2011-2023 <a href="https://www.lightbend.com" target="_blank">Lightbend, Inc.</a> |
<a href="https://www.lightbend.com/legal/licenses" target="_blank">Licenses</a> |
<a href="https://www.lightbend.com/legal/terms" target="_blank">Terms</a> |
<a href="https://www.lightbend.com/legal/privacy" target="_blank">Privacy Policy</a> |
<a href="https://akka.io/cookie/" target="_blank">Cookie Listing</a> |
<a class="optanon-toggle-display">Cookie Settings</a>
</p>
</section>

</footer>
</section>
</main>
</div>

<script type="text/javascript" src="js/scrollsneak.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="js/groups.js"></script>
<script type="text/javascript" src="js/page.js"></script>
<script type="text/javascript" src="js/snippets.js"></script>
<script type="text/javascript" src="js/magellan.js"></script>
<script type="text/javascript" src="js/metadata-toggle.js"></script>
<script type="text/javascript" src="js/lbHeader.js"></script>

<style type="text/css">@import "lib/prettify/prettify.css";</style>
<script type="text/javascript" src="lib/prettify/prettify.js"></script>
<script type="text/javascript" src="lib/prettify/lang-scala.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(){window.prettyPrint && prettyPrint()});
//]]></script>
<script type="text/javascript" src="assets/js/warnOldVersion.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(jq){initOldVersionWarnings(jq, '2.0.1', 'https://doc.akka.io/docs/akka-diagnostics/current/')});
//]]></script>

</body>
</html>
