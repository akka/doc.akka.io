<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Snapshots &bull; Akka Persistence Cassandra</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="A Cassandra plugin for Akka Persistence."/>
<link rel="canonical" href="https://doc.akka.io/docs/akka-persistence-cassandra/current/snapshots.html"/>
<script type="text/javascript" src="lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="lib/foundation/dist/js/foundation.min.js"></script>
<link rel="stylesheet" type="text/css" href="lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="lib/foundation/dist/css/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" type="text/css" href="css/icons.css"/>
<link rel="stylesheet" type="text/css" href="css/page-8.css"/>
<link rel="stylesheet" type="text/css" href="css/banner-2.css"/>
<link rel="shortcut icon" href="images/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png"/>
<link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png"/>
<link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png"/>
<link rel="manifest" href="images/manifest.json"/>
<meta name="msapplication-TileImage" content="images/mstile-150x150.png"/>
<meta name="msapplication-TileColor" content="#15a9ce"/>
<meta name="theme-color" content="#15a9ce"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) start -->
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js"  type="text/javascript" charset="UTF-8" data-domain-script="28b912e7-09e9-43d5-91e4-3d1897044004" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) end -->
<!--Google Analytics NOTE this will stop processing data July 1st 2023. At which point this embed code can be removed-->
<script type="text/plain" class="optanon-category-2">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', '']);
_gaq.push(['_setDomainName', '']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})()
</script>

<!-- Google Tag Manager: Updated May 17th 2023 - Cookie Compliance checks have been moved into Google Tag Manager -->
<script type="text/javascript">
(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KBJGH35');
</script>

</head>

<body id="underlay" data-toggler="nav-open">
<div id="lightbend-banner" class="lightbend-banner akka full-width" data-category="OSS Lightbend Banner Impression" data-label="Akka Banner Impression">
<div class="oss-wrapper">
<div class="oss-brand">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lightbend Logo - Akka Banner" href="https://www.lightbend.com">
<img class="lightbend-logo" src="images/banner-logos/lightbend-reverse.svg" alt="Lightbend" title="Lightbend">
</a>
</div>
<div class="oss-ad no-drop-down">
<nav id="lightbendRotator" class="lightbend-rotator">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Promo Rotator - Lightbend Changed its Software Licensing Model for Akka Technology. [License FAQ] - Akka Banner" href="https://www.lightbend.com/akka/license-faq">
<strong>Lightbend</strong> Changed its Software Licensing Model for Akka Technology. <span class="akka-btn">License FAQ</span>
</a>
</nav>
</div>
</div>
</div>

<header class="site-header hide-for-large">
<div class="sticky-header clearfix">
<a href="https://akka.io"><img class="logo" src="images/akka-logo-reverse.svg"/></a>

<button class="menu-icon float-right" type="button" data-toggle="underlay overlay"></button>
</div>
<div id="overlay" class="overlay-nav" data-toggler="nav-open">
<header class="nav-header">
<div class="nav-header-title">
<h1><a href="index.html">Akka Persistence Cassandra</a></h1>
</div>
<div class="nav-header-version">
Version 1.2.0-M1
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="nav-toc">
<ul>
  <li><a href="overview.html" class="page">Overview</a></li>
  <li><a href="journal.html" class="page">Journal</a></li>
  <li><a href="read-journal.html" class="page">Query Plugin</a></li>
  <li><a href="events-by-tag.html" class="page">Events by tag</a></li>
  <li><a href="snapshots.html#snapshots" class="active page">Snapshots</a>
  <ul>
    <li><a href="snapshots.html#features" class="header">Features</a></li>
    <li><a href="snapshots.html#schema" class="header">Schema</a></li>
    <li><a href="snapshots.html#configuration" class="header">Configuration</a></li>
    <li><a href="snapshots.html#limitations" class="header">Limitations</a></li>
    <li><a href="snapshots.html#delete-all-snapshots" class="header">Delete all snapshots</a></li>
  </ul></li>
  <li><a href="serialization.html" class="page">Serialization</a></li>
  <li><a href="testing.html" class="page">Testing</a></li>
  <li><a href="cqrs.html" class="page">Event sourcing and CQRS</a></li>
  <li><a href="healthcheck.html" class="page">Health check</a></li>
  <li><a href="configuration.html" class="page">Configuration</a></li>
  <li><a href="server.html" class="page">Cassandra server support</a></li>
  <li><a href="migrations.html" class="page">Migration</a></li>
  <li><a href="cleanup.html" class="page">Database Cleanup</a></li>
</ul>
</nav>
</div>
</header>
<div class="site-content-wrapper">
<aside class="sticky-sidebar show-for-large">
<header class="nav-header sticky-sidebar-header">
<div class="nav-header-title">
<h1><a href="index.html">Akka Persistence Cassandra</a></h1>
</div>
<div class="nav-header-version">
Version 1.2.0-M1
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="site-nav sticky-sidebar-contents">
<div class="nav-toc">
<ul>
  <li><a href="overview.html" class="page">Overview</a></li>
  <li><a href="journal.html" class="page">Journal</a></li>
  <li><a href="read-journal.html" class="page">Query Plugin</a></li>
  <li><a href="events-by-tag.html" class="page">Events by tag</a></li>
  <li><a href="snapshots.html#snapshots" class="active page">Snapshots</a>
  <ul>
    <li><a href="snapshots.html#features" class="header">Features</a></li>
    <li><a href="snapshots.html#schema" class="header">Schema</a></li>
    <li><a href="snapshots.html#configuration" class="header">Configuration</a></li>
    <li><a href="snapshots.html#limitations" class="header">Limitations</a></li>
    <li><a href="snapshots.html#delete-all-snapshots" class="header">Delete all snapshots</a></li>
  </ul></li>
  <li><a href="serialization.html" class="page">Serialization</a></li>
  <li><a href="testing.html" class="page">Testing</a></li>
  <li><a href="cqrs.html" class="page">Event sourcing and CQRS</a></li>
  <li><a href="healthcheck.html" class="page">Health check</a></li>
  <li><a href="configuration.html" class="page">Configuration</a></li>
  <li><a href="server.html" class="page">Cassandra server support</a></li>
  <li><a href="migrations.html" class="page">Migration</a></li>
  <li><a href="cleanup.html" class="page">Database Cleanup</a></li>
</ul>
</div>
</nav>
<footer class="nav-footer sticky-sidebar-footer">
<a href="https://akka.io"><img class="logo" src="images/akka-logo-reverse.svg"/></a>

</footer>
</aside>
<main class="fixed-shift-for-large expanded row">
<section class="site-content small-12 column">
<article class="page-content row">
<div class="small-12 column" id="docs">
<h1><a href="#snapshots" name="snapshots" class="anchor"><span class="anchor-link"></span></a>Snapshots</h1>
<h2><a href="#features" name="features" class="anchor"><span class="anchor-link"></span></a>Features</h2>
<ul>
  <li>Implements the Akka Persistence <a href="https://doc.akka.io/docs/akka/2.9/persistence-journals.html#snapshot-store-plugin-api">snapshot store plugin API</a>.</li>
</ul>
<h2><a href="#schema" name="schema" class="anchor"><span class="anchor-link"></span></a>Schema</h2>
<p>The keyspace and tables needs to be created before using the plugin. </p><div class="callout warning "><div class="callout-title">Warning</div>
<p>Auto creation of the keyspace and tables is included as a development convenience and should never be used in production. Cassandra does not handle concurrent schema migrations well and if every Akka node tries to create the schema at the same time you&rsquo;ll get column id mismatch errors in Cassandra.</p></div>
<p>The default keyspace used by the plugin is <code>akka_snapshot</code>, it should be created with the NetworkTopology replication strategy with a replication factor of at least 3:</p>
<pre><code>CREATE KEYSPACE IF NOT EXISTS akka_snapshot WITH replication = {&#39;class&#39;: &#39;NetworkTopologyStrategy&#39;, &#39;&lt;your_dc_name&gt;&#39; : 3 }; 
</code></pre>
<p>For local testing, and the default if you enable <code>akka.persistence.cassandra.snapshot.keyspace-autocreate</code> you can use the following:</p>
<pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-persistence-cassandra/tree/v1.2.0-M1/target/snapshot-keyspace.txt#L2-L3" target="_blank" title="Go to snippet source">source</a><code class="language-txt">CREATE KEYSPACE IF NOT EXISTS akka_snapshot
 WITH REPLICATION = { &#39;class&#39; : &#39;SimpleStrategy&#39;,&#39;replication_factor&#39;:1 };</code></pre>
<p>A single table is required. This needs to be created before starting your application. For local testing you can enable <code>akka.persistence.cassandra.snapshot.tables-autocreate</code>. The default table definitions look like this:</p>
<pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-persistence-cassandra/tree/v1.2.0-M1/target/snapshot-tables.txt#L2-L26" target="_blank" title="Go to snippet source">source</a><code class="language-txt">CREATE TABLE IF NOT EXISTS akka_snapshot.snapshots (
  persistence_id text,
  sequence_nr bigint,
  timestamp bigint,
  ser_id int,
  ser_manifest text,
  snapshot_data blob,
  snapshot blob,
  meta_ser_id int,
  meta_ser_manifest text,
  meta blob,
  PRIMARY KEY (persistence_id, sequence_nr))
  WITH CLUSTERING ORDER BY (sequence_nr DESC) AND gc_grace_seconds =864000
  AND compaction = {
    &#39;class&#39; : &#39;SizeTieredCompactionStrategy&#39;,
    &#39;enabled&#39; : true,
    &#39;tombstone_compaction_interval&#39; : 86400,
    &#39;tombstone_threshold&#39; : 0.2,
    &#39;unchecked_tombstone_compaction&#39; : false,
    &#39;bucket_high&#39; : 1.5,
    &#39;bucket_low&#39; : 0.5,
    &#39;max_threshold&#39; : 32,
    &#39;min_threshold&#39; : 4,
    &#39;min_sstable_size&#39; : 50
    };</code></pre>
<h3><a href="#consistency" name="consistency" class="anchor"><span class="anchor-link"></span></a>Consistency</h3>
<p>By default, the snapshot store uses <code>ONE</code> for all reads and writes, since snapshots should only be used as an optimization to reduce number of replayed events. If a recovery doesn&rsquo;t see the latest snapshot it will just start from an older snapshot and replay events from there. Be careful to not delete events too eagerly after storing snapshots since the deletes may be visible before the snapshot is visible. Keep a few snapshots and corresponding events before deleting older events and snapshots.</p>
<p>The consistency level for snapshots can be changed with:</p>
<pre><code>datastax-java-driver.profiles {
  akka-persistence-cassandra-snapshot-profile {
    basic.request.consistency = QUORUM
  }
}
</code></pre>
<h2><a href="#configuration" name="configuration" class="anchor"><span class="anchor-link"></span></a>Configuration</h2>
<p>To activate the snapshot-store plugin, add the following line to your Akka <code>application.conf</code>:</p>
<pre><code>akka.persistence.snapshot-store.plugin = &quot;akka.persistence.cassandra.snapshot&quot;
</code></pre>
<p>This will run the snapshot store with its default settings. The default settings can be changed with the configuration properties defined in <a href="configuration.html#default-configuration">reference.conf</a>. Journal configuration is under <code>akka.persistence.cassandra.snapshot</code>.</p>
<h2><a href="#limitations" name="limitations" class="anchor"><span class="anchor-link"></span></a>Limitations</h2>
<p>The snapshot is stored in a single row so the maximum size of a serialized snapshot is the Cassandra configured <a href="https://cassandra.apache.org/doc/latest/faq/index.html#can-large-blob"><code>max_mutation_size_in_kb</code></a> which is 16MB by default.</p>
<h2><a href="#delete-all-snapshots" name="delete-all-snapshots" class="anchor"><span class="anchor-link"></span></a>Delete all snapshots</h2>
<p>The <span class="group-scala"><a href="/api/akka-persistence-cassandra/1.2.0-M1/akka/persistence/cassandra/cleanup/Cleanup.html" title="akka.persistence.cassandra.cleanup.Cleanup"><code>Cleanup</code></a></span><span class="group-java"><a href="/api/akka-persistence-cassandra/1.2.0-M1/akka/persistence/cassandra/cleanup/Cleanup.html" title="akka.persistence.cassandra.cleanup.Cleanup"><code>Cleanup</code></a></span> tool can be used for deleting all events and/or snapshots given list of <code>persistenceIds</code> without using persistent actors. It&rsquo;s important that the actors with corresponding <code>persistenceId</code> are not running at the same time as using the tool. See <a href="cleanup.html">Database Cleanup</a> for more details.</p>
</div>
</article>
<div class="row">
<div class="small-12 column">
<section class="nav-prev-next row">
<div class="nav-prev small-6 column">
<a href="events-by-tag.html"><i class="icon-prev"></i> <span class="link-prev">Events by tag</span></a>
</div>
<div class="nav-next small-6 column clearfix">
<a class="float-right" href="serialization.html">Serialization <i class="icon-next"></i></a>
</div>
</section>
</div>
</div>
<div class="source-github row">
Found an error in this documentation? The source code for this page can be found <a href="https://github.com/akka/akka-persistence-cassandra/tree/v1.2.0-M1/docs/src/main/paradox/snapshots.md">here</a>.
Please feel free to edit and contribute a pull request.
</div>

<footer class="page-footer row clearfix">
<img class="akka-icon float-left show-for-medium" src="images/akka-icon.svg" />
<section class="copyright">
<div>Akka Persistence Cassandra is available under the <a href="https://www.lightbend.com/akka/license" target="_blank">Business Source License 1.1</a>.</div>
<p class="legal">
&copy; 2011-2023 <a href="https://www.lightbend.com" target="_blank">Lightbend, Inc.</a> |
<a href="https://www.lightbend.com/legal/licenses" target="_blank">Licenses</a> |
<a href="https://www.lightbend.com/legal/terms" target="_blank">Terms</a> |
<a href="https://www.lightbend.com/legal/privacy" target="_blank">Privacy Policy</a> |
<a href="https://akka.io/cookie/" target="_blank">Cookie Listing</a> |
<a class="optanon-toggle-display">Cookie Settings</a>
</p>
</section>

</footer>
</section>
</main>
</div>

<script type="text/javascript" src="js/scrollsneak.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="js/groups.js"></script>
<script type="text/javascript" src="js/page.js"></script>
<script type="text/javascript" src="js/snippets.js"></script>
<script type="text/javascript" src="js/magellan.js"></script>
<script type="text/javascript" src="js/metadata-toggle.js"></script>
<script type="text/javascript" src="js/lbHeader.js"></script>

<style type="text/css">@import "lib/prettify/prettify.css";</style>
<script type="text/javascript" src="lib/prettify/prettify.js"></script>
<script type="text/javascript" src="lib/prettify/lang-scala.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(){window.prettyPrint && prettyPrint()});
//]]></script>
<script type="text/javascript" src="assets/js/warnOldVersion.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(jq){initOldVersionWarnings(jq, '1.2.0-M1', 'https://doc.akka.io/docs/akka-persistence-cassandra/current/')});
//]]></script>


</body>
</html>
