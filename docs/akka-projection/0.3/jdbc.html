<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Offset in a relational DB with JDBC &bull; Akka Projection</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="Akka Projection."/>
<link rel="canonical" href="https://doc.akka.io/docs/akka-projection/current/jdbc.html"/>
<script type="text/javascript" src="lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="lib/foundation/dist/js/foundation.min.js"></script>
<link rel="stylesheet" type="text/css" href="lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="lib/foundation/dist/css/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" type="text/css" href="css/icons.css"/>
<link rel="stylesheet" type="text/css" href="css/page-7.css"/>
<link rel="stylesheet" type="text/css" href="css/banner-1.css"/>
<link rel="shortcut icon" href="images/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png"/>
<link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png"/>
<link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png"/>
<link rel="manifest" href="images/manifest.json"/>
<meta name="msapplication-TileImage" content="images/mstile-150x150.png"/>
<meta name="msapplication-TileColor" content="#15a9ce"/>
<meta name="theme-color" content="#15a9ce"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) start -->
<script src="https://optanon.blob.core.windows.net/consent/159bb13d-6748-4399-806e-ac28db879785.js" type="text/javascript" charset="UTF-8"></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) end -->
<!--Google Analytics-->
<script type="text/plain" class="optanon-category-2">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', '']);
_gaq.push(['_setDomainName', '']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})()
</script>
<!-- Google Tag Manager -->
<script type="text/plain" class="optanon-category-2">
(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KBJGH35');
</script>
<!--Marketo-->
<script type="text/plain" class="optanon-category-3">
(function() {
var didInit = false;
function initMunchkin() {
if(didInit === false) {
didInit = true;
Munchkin.init('558-NCX-702', { 'asyncOnly': true, 'disableClickDelay': true });
}
}
var s = document.createElement('script');
s.type = 'text/javascript';
s.async = true;
s.src = '//munchkin.marketo.net/munchkin.js';
s.onreadystatechange = function() {
if (this.readyState == 'complete' || this.readyState == 'loaded') {
initMunchkin();
}
};
s.onload = initMunchkin;
document.getElementsByTagName('head')[0].appendChild(s);
})();
</script>
</head>

<body id="underlay" data-toggler="nav-open">
<div id="lightbend-banner" class="lightbend-banner akka full-width" data-category="OSS Lightbend Banner Impression" data-label="Akka Banner Impression">
<div class="wrapper">
<div class="brand">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lightbend Logo - Akka Banner" href="https://www.lightbend.com?r=oss-banner-akka" target="_blank">
<img class="lightbend-logo" src="images/banner-logos/lightbend-reverse.svg" alt="Lightbend" title="Lightbend">
</a>
</div>
<div class="nav">
<a class="banner-btn oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Enhance your Akka systems with Akka Platform [Button] - Akka Banner" href="https://www.lightbend.com/akka-core-of-lightbend?r=oss-banner-akka" target="_blank">
<span>Enhance your Akka systems with</span>
<img class="akka-platform-reverse-logo" src="images/banner-logos/akka-platform-reverse.svg" alt="Akka Platform" title="Akka Platform">
</a>
<div class="drop-down">
<svg class="svg-chevon-circle-down" version="1.1" id="Chevron_circled_down" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve">
<path fill="#ffffff" d="M12.505,8.698L10,11L7.494,8.698c-0.198-0.196-0.518-0.196-0.718,0c-0.197,0.196-0.197,0.515,0,0.71l2.864,2.807
c0.199,0.196,0.52,0.196,0.717,0l2.864-2.807c0.199-0.195,0.198-0.514,0-0.71C13.024,8.502,12.704,8.502,12.505,8.698z M10,0.4
c-5.302,0-9.6,4.298-9.6,9.6c0,5.303,4.298,9.6,9.6,9.6s9.6-4.297,9.6-9.6C19.6,4.698,15.302,0.4,10,0.4z M10,18.354
c-4.615,0-8.354-3.74-8.354-8.354c0-4.614,3.739-8.354,8.354-8.354c4.613,0,8.354,3.74,8.354,8.354
C18.354,14.614,14.613,18.354,10,18.354z" />
</svg>
<div class="drop-down-content">
<div class="lightbend-family">
<a href="https://cloudflow.io" class="cloudflow oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Cloudflow - Logo Tag Line - Akka Banner">
<img class="cloudflow-full-color-logo" src="images/banner-logos/cloudflow-full-color.svg" alt="Cloudflow by Lightbend" title="Cloudflow by Lightbend">
</a>
<a href="https://cloudstate.io" class="cloudstate oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Cloudstate - Logo Tag Line - Akka Banner">
<img class="cloudstate-full-color-logo" src="images/banner-logos/cloudstate-full-color.svg" alt="Cloudstate by Lightbend" title="Cloudstate by Lightbend">
</a>
<a href="https://www.lagomframework.com" class="lagom oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lagom - Logo Tag Line - Akka Banner">
<img class="lagom-full-color-logo" src="images/banner-logos/lagom-full-color.svg" alt="Lagom Framework by Lightbend" title="Lagom Framework by Lightbend">
</a>
<a href="https://www.playframework.com" class="play oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Play - Logo Tag Line - Akka Banner">
<img class="play-full-color-logo" src="images/banner-logos/play-full-color.svg" alt="Play Framework by Lightbend" title="Play Framework by Lightbend">
</a>
<a href="https://www.scala-lang.org" class="scala oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Scala - Logo Tag Line - Akka Banner">
<img class="scala-full-color-logo" src="images/banner-logos/scala-full-color.svg" alt="Scala by Lightbend" title="Scala by Lightbend">
</a>
<div class="akka current">
<img class="akka-full-color-logo" src="images/banner-logos/akka-full-color.svg" alt="Akka by Lightbend" title="Akka by Lightbend">
<span>From the creators of <strong>Akka</strong>, get technology enhancements, monitoring, and expert support with Akka Platform from Lightbend.</span>
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Learn More [Button] - Akka Banner" href="https://www.lightbend.com/akka-core-of-lightbend?r=oss-banner-akka" target="_blank">Learn More</a>
</div>
</div>
<div class="title">The Lightbend Family</div>
</div>      
</div>
</div>
</div>
</div>
<header class="site-header hide-for-large">
<div class="sticky-header clearfix">
<a href="https://akka.io"><img class="logo" src="images/akka-logo-reverse.svg"/></a>

<button class="menu-icon float-right" type="button" data-toggle="underlay overlay"></button>
</div>
<div id="overlay" class="overlay-nav" data-toggler="nav-open">
<header class="nav-header">
<div class="nav-header-title">
<h1><a href="index.html">Akka Projection</a></h1>
</div>
<div class="nav-header-version">
Version 0.3
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="nav-toc">
<ul>
  <li><a href="overview.html" class="page">Overview</a></li>
  <li><a href="use-cases.html" class="page">Use Cases</a></li>
  <li><a href="eventsourced.html" class="page">Events from Akka Persistence</a></li>
  <li><a href="kafka.html" class="page">Messages from and to Kafka</a></li>
  <li><a href="cassandra.html" class="page">Offset in Cassandra</a></li>
  <li><a href="jdbc.html#offset-in-a-relational-db-with-jdbc" class="active page">Offset in a relational DB with JDBC</a>
  <ul>
    <li><a href="jdbc.html#dependencies" class="header">Dependencies</a></li>
    <li><a href="jdbc.html#required-configuration-settings" class="header">Required configuration settings</a></li>
    <li><a href="jdbc.html#defining-a-jdbcsession" class="header">Defining a JdbcSession</a></li>
    <li><a href="jdbc.html#blocking-jdbc-dispatcher" class="header">Blocking JDBC Dispatcher</a></li>
    <li><a href="jdbc.html#exactly-once" class="header">exactly-once</a></li>
    <li><a href="jdbc.html#at-least-once" class="header">at-least-once</a></li>
    <li><a href="jdbc.html#groupedwithin" class="header">groupedWithin</a></li>
    <li><a href="jdbc.html#handler" class="header">Handler</a></li>
    <li><a href="jdbc.html#schema" class="header">Schema</a></li>
    <li><a href="jdbc.html#offset-types" class="header">Offset types</a></li>
    <li><a href="jdbc.html#configuration" class="header">Configuration</a></li>
  </ul></li>
  <li><a href="slick.html" class="page">Offset in a relational DB with Slick</a></li>
  <li><a href="running.html" class="page">Running a Projection</a></li>
  <li><a href="actor.html" class="page">Processing with Actor</a></li>
  <li><a href="flow.html" class="page">Processing with Akka Streams</a></li>
  <li><a href="error.html" class="page">Error handling</a></li>
  <li><a href="projection-settings.html" class="page">Projection Settings</a></li>
  <li><a href="management.html" class="page">Management of a Projection</a></li>
  <li><a href="testing.html" class="page">Testing</a></li>
</ul>
</nav>
</div>
</header>
<div class="site-content-wrapper">
<aside class="sticky-sidebar show-for-large">
<header class="nav-header sticky-sidebar-header">
<div class="nav-header-title">
<h1><a href="index.html">Akka Projection</a></h1>
</div>
<div class="nav-header-version">
Version 0.3
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="site-nav sticky-sidebar-contents">
<div class="nav-toc">
<ul>
  <li><a href="overview.html" class="page">Overview</a></li>
  <li><a href="use-cases.html" class="page">Use Cases</a></li>
  <li><a href="eventsourced.html" class="page">Events from Akka Persistence</a></li>
  <li><a href="kafka.html" class="page">Messages from and to Kafka</a></li>
  <li><a href="cassandra.html" class="page">Offset in Cassandra</a></li>
  <li><a href="jdbc.html#offset-in-a-relational-db-with-jdbc" class="active page">Offset in a relational DB with JDBC</a>
  <ul>
    <li><a href="jdbc.html#dependencies" class="header">Dependencies</a></li>
    <li><a href="jdbc.html#required-configuration-settings" class="header">Required configuration settings</a></li>
    <li><a href="jdbc.html#defining-a-jdbcsession" class="header">Defining a JdbcSession</a></li>
    <li><a href="jdbc.html#blocking-jdbc-dispatcher" class="header">Blocking JDBC Dispatcher</a></li>
    <li><a href="jdbc.html#exactly-once" class="header">exactly-once</a></li>
    <li><a href="jdbc.html#at-least-once" class="header">at-least-once</a></li>
    <li><a href="jdbc.html#groupedwithin" class="header">groupedWithin</a></li>
    <li><a href="jdbc.html#handler" class="header">Handler</a></li>
    <li><a href="jdbc.html#schema" class="header">Schema</a></li>
    <li><a href="jdbc.html#offset-types" class="header">Offset types</a></li>
    <li><a href="jdbc.html#configuration" class="header">Configuration</a></li>
  </ul></li>
  <li><a href="slick.html" class="page">Offset in a relational DB with Slick</a></li>
  <li><a href="running.html" class="page">Running a Projection</a></li>
  <li><a href="actor.html" class="page">Processing with Actor</a></li>
  <li><a href="flow.html" class="page">Processing with Akka Streams</a></li>
  <li><a href="error.html" class="page">Error handling</a></li>
  <li><a href="projection-settings.html" class="page">Projection Settings</a></li>
  <li><a href="management.html" class="page">Management of a Projection</a></li>
  <li><a href="testing.html" class="page">Testing</a></li>
</ul>
</div>
</nav>
<footer class="nav-footer sticky-sidebar-footer">
<a href="https://akka.io"><img class="logo" src="images/akka-logo-reverse.svg"/></a>

</footer>
</aside>
<main class="fixed-shift-for-large expanded row">
<section class="site-content small-12 column">
<article class="page-content row">
<div class="small-12 column" id="docs">
<h1><a href="#offset-in-a-relational-db-with-jdbc" name="offset-in-a-relational-db-with-jdbc" class="anchor"><span class="anchor-link"></span></a>Offset in a relational DB with JDBC</h1>
<p>The <span class="group-java"><a href="/api/akka-projection/0.3/akka/projection/jdbc/javadsl/JdbcProjection.html" title="akka.projection.jdbc.javadsl.JdbcProjection"><code>JdbcProjection</code></a></span><span class="group-scala"><a href="/api/akka-projection/0.3/akka/projection/jdbc/scaladsl/JdbcProjection.html" title="akka.projection.jdbc.scaladsl.JdbcProjection"><code>JdbcProjection</code></a></span> has support for storing the offset in a relational database using JDBC.</p>
<p>The source of the envelopes can be <a href="eventsourced.html">events from Akka Persistence</a> or any other <code>SourceProvider</code> with supported <a href="jdbc.html#offset-types">offset types</a>.</p>
<p>A <span class="group-java"><a href="/api/akka-projection/0.3/akka/projection/jdbc/javadsl/JdbcHandler.html" title="akka.projection.jdbc.javadsl.JdbcHandler"><code>JdbcHandler</code></a></span><span class="group-scala"><a href="/api/akka-projection/0.3/akka/projection/jdbc/scaladsl/JdbcHandler.html" title="akka.projection.jdbc.scaladsl.JdbcHandler"><code>JdbcHandler</code></a></span> receives a <span class="group-scala"><a href="/api/akka-projection/0.3/akka/projection/jdbc/JdbcSession.html" title="akka.projection.jdbc.JdbcSession"><code>JdbcSession</code></a></span><span class="group-java"><a href="/api/akka-projection/0.3/akka/projection/jdbc/JdbcSession.html" title="akka.projection.jdbc.JdbcSession"><code>JdbcSession</code></a></span> instance and an envelope. The <code>JdbcSession</code> provides the means to access an open JDBC connection that can be used to process the envelope. The target database operations can be run in the same transaction as the storage of the offset, which means that <a href="jdbc.html#exactly-once">exactly-once</a> processing semantics is supported. It also offers <a href="jdbc.html#at-least-once">at-least-once</a> semantics.</p>
<h2><a href="#dependencies" name="dependencies" class="anchor"><span class="anchor-link"></span></a>Dependencies</h2>
<p>To use the JDBC module of Akka Projections add the following dependency in your project:</p><dl class="dependency"><dt>sbt</dt><dd><pre class="prettyprint"><code class="language-scala">libraryDependencies += "com.lightbend.akka" %% "akka-projection-jdbc" % "0.3"</code></pre></dd><dt>Maven</dt><dd><pre class="prettyprint"><code class="language-xml">&lt;dependency&gt;
  &lt;groupId&gt;com.lightbend.akka&lt;/groupId&gt;
  &lt;artifactId&gt;akka-projection-jdbc_2.12&lt;/artifactId&gt;
  &lt;version&gt;0.3&lt;/version&gt;
&lt;/dependency&gt;</code></pre></dd><dt>Gradle</dt><dd><pre class="prettyprint"><code class="language-gradle">dependencies {
  compile group: 'com.lightbend.akka', name: 'akka-projection-jdbc_2.12', version: '0.3'
}</code></pre></dd></dl>
<p>Akka Projections require Akka 2.6.6 or later, see <a href="overview.html#akka-version">Akka version</a>.</p>
<table class="project-info">
<tr><th colspan="2">Project Info: Akka Projection JDBC</th></tr>
  <tr><th>Artifact</th><td><div>com.lightbend.akka</div>
  <div>akka-projection-jdbc</div>
  <div>0.3</div></td></tr>
  <tr><th>JDK versions</th><td><div>AdoptOpenJDK 8</div><div>AdoptOpenJDK 11</div></td></tr>
  <tr><th>Scala versions</th><td>2.12.11, 2.13.3</td></tr>
  <tr><th>JPMS module name</th><td>akka.projection.jdbc</td></tr>
  <tr><th>License</th><td><div><a href="https://www.apache.org/licenses/LICENSE-2.0" target="_blank" rel="noopener noreferrer">Apache-2.0</a></div>
  </td></tr>
  <tr><th>Readiness level</th><td><div class="readiness-level"><a href="https://developer.lightbend.com/docs/lightbend-platform/introduction/getting-help/support-terminology.html#community-driven" target="_blank" rel="noopener">Community-driven</a></div>
  <div>Since 0.0, 2020-04-01</div>
  </td></tr>
  <tr><th>Home page</th><td><a href="https://akka.io">https://akka.io</a></td></tr>
  <tr><th>API documentation</th><td>
  <div><a href="https://doc.akka.io/api/akka-projection/0.3/akka/projection/" target="_blank" rel="noopener noreferrer">API (Scaladoc)</a></div>
  </td></tr>
  <tr><th>Forums</th><td>
  <div><a href="https://discuss.lightbend.com/c/akka/" target="_blank" rel="noopener noreferrer">Lightbend Discuss</a></div>
  <div><a href="https://gitter.im/akka/akka" target="_blank" rel="noopener noreferrer">akka/akka Gitter channel</a></div>
  </td></tr>
  <tr><th>Release notes</th><td><a href="https://github.com/akka/akka-projection/releases" target="_blank" rel="noopener noreferrer">GitHub releases</a></td></tr>
  <tr><th>Issues</th><td><a href="https://github.com/akka/akka-projection/issues" target="_blank" rel="noopener noreferrer">GitHub issues</a></td></tr>
  <tr><th>Sources</th><td><a href="https://github.com/akka/akka-projection" target="_blank" rel="noopener noreferrer">https://github.com/akka/akka-projection</a></td></tr>
</table>

<h3><a href="#transitive-dependencies" name="transitive-dependencies" class="anchor"><span class="anchor-link"></span></a>Transitive dependencies</h3>

<p>The table below shows <code>akka-projection-jdbc</code>&rsquo;s direct dependencies, and the second tab shows all libraries it depends on transitively.</p>

<dl class="dependencies"><dt>Direct dependencies</dt><dd><table>
  <thead><tr><th>Organization</th><th>Artifact</th><th>Version</th></thead>
  <tbody>
    <tr><td>com.lightbend.akka</td><td>akka-projection-core_2.12</td><td><a href="https://mvnrepository.com/artifact/com.lightbend.akka/akka-projection-core_2.12/0.3" target="_blank">0.3</a></td></tr>
    <tr><td>com.typesafe.akka</td><td>akka-persistence-query_2.12</td><td><a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-persistence-query_2.12/2.6.6" target="_blank">2.6.6</a></td></tr>
    <tr><td>org.scala-lang</td><td>scala-library</td><td><a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.12.11" target="_blank">2.12.11</a></td></tr>
  </tbody>
</table></dd>
<dt>Dependency tree</dt><dd><pre>
com.lightbend.akka    akka-projection-core_2.12    <a href="https://mvnrepository.com/artifact/com.lightbend.akka/akka-projection-core_2.12/0.3" target="_blank">0.3</a>
    com.typesafe.akka    akka-actor-typed_2.12    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-actor-typed_2.12/2.6.6" target="_blank">2.6.6</a>
        com.typesafe.akka    akka-actor_2.12    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-actor_2.12/2.6.6" target="_blank">2.6.6</a>
            com.typesafe    config    <a href="https://mvnrepository.com/artifact/com.typesafe/config/1.4.0" target="_blank">1.4.0</a>
            org.scala-lang.modules    scala-java8-compat_2.12    <a href="https://mvnrepository.com/artifact/org.scala-lang.modules/scala-java8-compat_2.12/0.8.0" target="_blank">0.8.0</a>
        com.typesafe.akka    akka-slf4j_2.12    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-slf4j_2.12/2.6.6" target="_blank">2.6.6</a>
            com.typesafe.akka    akka-actor_2.12    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-actor_2.12/2.6.6" target="_blank">2.6.6</a>
                com.typesafe    config    <a href="https://mvnrepository.com/artifact/com.typesafe/config/1.4.0" target="_blank">1.4.0</a>
                org.scala-lang.modules    scala-java8-compat_2.12    <a href="https://mvnrepository.com/artifact/org.scala-lang.modules/scala-java8-compat_2.12/0.8.0" target="_blank">0.8.0</a>
            org.slf4j    slf4j-api    <a href="https://mvnrepository.com/artifact/org.slf4j/slf4j-api/1.7.30" target="_blank">1.7.30</a>
        org.slf4j    slf4j-api    <a href="https://mvnrepository.com/artifact/org.slf4j/slf4j-api/1.7.30" target="_blank">1.7.30</a>
    com.typesafe.akka    akka-protobuf-v3_2.12    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-protobuf-v3_2.12/2.6.6" target="_blank">2.6.6</a>
    com.typesafe.akka    akka-stream_2.12    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-stream_2.12/2.6.6" target="_blank">2.6.6</a>
        com.typesafe.akka    akka-actor_2.12    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-actor_2.12/2.6.6" target="_blank">2.6.6</a>
            com.typesafe    config    <a href="https://mvnrepository.com/artifact/com.typesafe/config/1.4.0" target="_blank">1.4.0</a>
            org.scala-lang.modules    scala-java8-compat_2.12    <a href="https://mvnrepository.com/artifact/org.scala-lang.modules/scala-java8-compat_2.12/0.8.0" target="_blank">0.8.0</a>
        com.typesafe.akka    akka-protobuf-v3_2.12    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-protobuf-v3_2.12/2.6.6" target="_blank">2.6.6</a>
        com.typesafe    ssl-config-core_2.12    <a href="https://mvnrepository.com/artifact/com.typesafe/ssl-config-core_2.12/0.4.1" target="_blank">0.4.1</a>
            com.typesafe    config    <a href="https://mvnrepository.com/artifact/com.typesafe/config/1.4.0" target="_blank">1.4.0</a>
            org.scala-lang.modules    scala-parser-combinators_2.12    <a href="https://mvnrepository.com/artifact/org.scala-lang.modules/scala-parser-combinators_2.12/1.1.2" target="_blank">1.1.2</a>
        org.reactivestreams    reactive-streams    <a href="https://mvnrepository.com/artifact/org.reactivestreams/reactive-streams/1.0.3" target="_blank">1.0.3</a>
com.typesafe.akka    akka-persistence-query_2.12    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-persistence-query_2.12/2.6.6" target="_blank">2.6.6</a>
    com.typesafe.akka    akka-persistence_2.12    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-persistence_2.12/2.6.6" target="_blank">2.6.6</a>
        com.typesafe.akka    akka-actor_2.12    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-actor_2.12/2.6.6" target="_blank">2.6.6</a>
            com.typesafe    config    <a href="https://mvnrepository.com/artifact/com.typesafe/config/1.4.0" target="_blank">1.4.0</a>
            org.scala-lang.modules    scala-java8-compat_2.12    <a href="https://mvnrepository.com/artifact/org.scala-lang.modules/scala-java8-compat_2.12/0.8.0" target="_blank">0.8.0</a>
        com.typesafe.akka    akka-stream_2.12    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-stream_2.12/2.6.6" target="_blank">2.6.6</a>
            com.typesafe.akka    akka-actor_2.12    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-actor_2.12/2.6.6" target="_blank">2.6.6</a>
                com.typesafe    config    <a href="https://mvnrepository.com/artifact/com.typesafe/config/1.4.0" target="_blank">1.4.0</a>
                org.scala-lang.modules    scala-java8-compat_2.12    <a href="https://mvnrepository.com/artifact/org.scala-lang.modules/scala-java8-compat_2.12/0.8.0" target="_blank">0.8.0</a>
            com.typesafe.akka    akka-protobuf-v3_2.12    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-protobuf-v3_2.12/2.6.6" target="_blank">2.6.6</a>
            com.typesafe    ssl-config-core_2.12    <a href="https://mvnrepository.com/artifact/com.typesafe/ssl-config-core_2.12/0.4.1" target="_blank">0.4.1</a>
                com.typesafe    config    <a href="https://mvnrepository.com/artifact/com.typesafe/config/1.4.0" target="_blank">1.4.0</a>
                org.scala-lang.modules    scala-parser-combinators_2.12    <a href="https://mvnrepository.com/artifact/org.scala-lang.modules/scala-parser-combinators_2.12/1.1.2" target="_blank">1.1.2</a>
            org.reactivestreams    reactive-streams    <a href="https://mvnrepository.com/artifact/org.reactivestreams/reactive-streams/1.0.3" target="_blank">1.0.3</a>
    com.typesafe.akka    akka-stream_2.12    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-stream_2.12/2.6.6" target="_blank">2.6.6</a>
        com.typesafe.akka    akka-actor_2.12    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-actor_2.12/2.6.6" target="_blank">2.6.6</a>
            com.typesafe    config    <a href="https://mvnrepository.com/artifact/com.typesafe/config/1.4.0" target="_blank">1.4.0</a>
            org.scala-lang.modules    scala-java8-compat_2.12    <a href="https://mvnrepository.com/artifact/org.scala-lang.modules/scala-java8-compat_2.12/0.8.0" target="_blank">0.8.0</a>
        com.typesafe.akka    akka-protobuf-v3_2.12    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-protobuf-v3_2.12/2.6.6" target="_blank">2.6.6</a>
        com.typesafe    ssl-config-core_2.12    <a href="https://mvnrepository.com/artifact/com.typesafe/ssl-config-core_2.12/0.4.1" target="_blank">0.4.1</a>
            com.typesafe    config    <a href="https://mvnrepository.com/artifact/com.typesafe/config/1.4.0" target="_blank">1.4.0</a>
            org.scala-lang.modules    scala-parser-combinators_2.12    <a href="https://mvnrepository.com/artifact/org.scala-lang.modules/scala-parser-combinators_2.12/1.1.2" target="_blank">1.1.2</a>
        org.reactivestreams    reactive-streams    <a href="https://mvnrepository.com/artifact/org.reactivestreams/reactive-streams/1.0.3" target="_blank">1.0.3</a>
org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.12.11" target="_blank">2.12.11</a></pre></dd>
</dl>

<h2><a href="#required-configuration-settings" name="required-configuration-settings" class="anchor"><span class="anchor-link"></span></a>Required configuration settings</h2>

<p>There are two settings that need to be set beforehand in your <code>application.conf</code> file.</p>

<ul>
  <li><code>akka.projection.jdbc.dialect</code> - The dialect type indicating your database of choice. Supported dialects are: <code>mysql-dialect</code>, <code>postgres-dialect</code>, <code>mssql-dialect</code> or <code>h2-dialect</code> (testing).</li>
  <li><code>akka.projection.jdbc.blocking-jdbc-dispatcher.thread-pool-executor.fixed-pool-size</code> indicating the size of the blocking JDBC dispatcher. See also <a href="jdbc.html#blocking-jdbc-dispatcher">Blocking JDBC Dispatcher</a>.</li>
</ul>
<h2><a href="#defining-a-jdbcsession" name="defining-a-jdbcsession" class="anchor"><span class="anchor-link"></span></a>Defining a JdbcSession</h2>
<p>Before using Akka Projection JDBC you must implement a <code>JdbcSession</code> <span class="group-scala">trait</span><span class="group-java">interface</span>. <code>JdbcSession</code> is used to open a connection and start a transaction. A new <code>JdbcSession</code> will be created for each call to the handler. At the end of the processing, the transaction will be committed (or rolled back). </p>
<p>When using <code>JdbcProjection.exactlyOnce</code>, the <code>JdbcSession</code> that is passed to the handler will be used to save the offset behind the scenes. Therefore, it&rsquo;s extremely important to disable auto-commit (eg: <code>setAutoCommit(false)</code>), otherwise the two operations won&rsquo;t participate on the same transaction. </p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka-projection/tree/v0.3/examples/src/test/scala/docs/jdbc/JdbcProjectionDocExample.scala#L30-L33" target="_blank" title="Go to snippet source"></a><code class="language-scala">import java.sql.Connection
import java.sql.DriverManager
import akka.projection.jdbc.JdbcSession

class PlainJdbcSession extends JdbcSession {

  lazy val conn = {
    Class.forName(&quot;org.h2.Driver&quot;)
    val c = DriverManager.getConnection(&quot;jdbc:h2:mem:test;DB_CLOSE_DELAY=-1&quot;)
    c.setAutoCommit(false)
    c
  }
  override def withConnection[Result](func: function.Function[Connection, Result]): Result =
    func(conn)
  override def commit(): Unit = conn.commit()
  override def rollback(): Unit = conn.rollback()
  override def close(): Unit = conn.close()
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka-projection/tree/v0.3/examples/src/test/java/jdocs/jdbc/JdbcProjectionDocExample.java#L29-L33" target="_blank" title="Go to snippet source"></a><code class="language-java">import akka.projection.jdbc.JdbcSession;
import java.sql.DriverManager;
import java.sql.SQLException;
import java.sql.Connection;

class PlainJdbcSession implements JdbcSession {

  private final Connection connection;

  public PlainJdbcSession() {
    try {
      Class.forName(&quot;org.h2.Driver&quot;);
      this.connection = DriverManager.getConnection(&quot;jdbc:h2:mem:test;DB_CLOSE_DELAY=-1&quot;);
      connection.setAutoCommit(false);
    } catch (ClassNotFoundException | SQLException e) {
      throw new RuntimeException(e);
    }
  }

  @Override
  public &lt;Result&gt; Result withConnection(Function&lt;Connection, Result&gt; func) throws Exception {
    return func.apply(connection);
  }

  @Override
  public void commit() throws SQLException {
    connection.commit();
  }

  @Override
  public void rollback() throws SQLException {
    connection.rollback();
  }

  @Override
  public void close() throws SQLException {
    connection.close();
  }
}</code></pre></dd>
</dl><div class="callout note "><div class="callout-title">Note</div>
<p>It&rsquo;s highly recommended configuring it with a connection pool, for example <a href="https://github.com/brettwooldridge/HikariCP">HikariCP</a>.</p></div>
<p>When declaring a <code>JdbcProjection</code> you must provide a factory for the <code>JdbcSession</code>. The factory will be used to create new instances whenever needed.</p>
<p>An alternative Hibernate based implementation would look like this:</p>
<dl>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka-projection/tree/v0.3/examples/src/test/java/jdocs/jdbc/HibernateJdbcSession.java#L10-L16" target="_blank" title="Go to snippet source"></a><code class="language-java">import org.hibernate.Session;
import org.hibernate.jdbc.ReturningWork;
import javax.persistence.EntityManager;
import javax.persistence.EntityTransaction;
import java.sql.Connection;
import java.sql.SQLException;

public class HibernateJdbcSession implements JdbcSession {

  final EntityManager entityManager;
  private final EntityTransaction transaction;

  public HibernateJdbcSession(EntityManager entityManager) {
    this.entityManager = entityManager;
    this.transaction = this.entityManager.getTransaction();
    this.transaction.begin();
  }

  @Override
  public &lt;Result&gt; Result withConnection(Function&lt;Connection, Result&gt; func) {
    Session hibernateSession = ((Session) entityManager.getDelegate());
    return hibernateSession.doReturningWork(
        new ReturningWork&lt;Result&gt;() {
          @Override
          public Result execute(Connection connection) throws SQLException {
            try {
              return func.apply(connection);
            } catch (SQLException e) {
              throw e;
            } catch (Exception e) {
              throw new SQLException(e);
            }
          }
        });
  }

  @Override
  public void commit() {
    transaction.commit();
  }

  @Override
  public void rollback() {
    // propagates rollback call if transaction is active
    if (transaction.isActive()) transaction.rollback();
  }

  @Override
  public void close() {
    this.entityManager.close();
  }
}</code></pre></dd>
</dl>
<p>And a special factory that initializes the <code>EntityManagerFactory</code> and builds the <code>JdbcSession</code> instance:</p>
<dl>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka-projection/tree/v0.3/examples/src/test/java/jdocs/jdbc/HibernateSessionFactory.java#L8-L10" target="_blank" title="Go to snippet source"></a><code class="language-java">import javax.persistence.EntityManagerFactory;
import javax.persistence.Persistence;

public class HibernateSessionFactory {
  private final EntityManagerFactory entityManagerFactory;

  public HibernateSessionFactory() {
    this.entityManagerFactory = Persistence.createEntityManagerFactory(&quot;akka-projection-hibernate&quot;);
  }

  public HibernateJdbcSession newInstance() {
    return new HibernateJdbcSession(entityManagerFactory.createEntityManager());
  }
}</code></pre></dd>
</dl>
<h2><a href="#blocking-jdbc-dispatcher" name="blocking-jdbc-dispatcher" class="anchor"><span class="anchor-link"></span></a>Blocking JDBC Dispatcher</h2>
<p>JDBC APIs are blocking by design, therefore Akka Projection JDBC will use a dedicated dispatcher to run all JDBC calls. It&rsquo;s important to configure the dispatcher to have the same size as the connection pool. </p>
<p>Each time the projection handler is called one thread and one database connection will be used. If your connection pool is smaller than the number of threads, the thread can potentially block while waiting for the connection pool to provide a connection. </p>
<p>The dispatcher pool size can be configured through the <code>akka.projection.jdbc.blocking-jdbc-dispatcher.thread-pool-executor.fixed-pool-size</code> settings. See <a href="jdbc.html#configuration">Configuration</a> section below.</p><div class="callout note "><div class="callout-title">Note</div>
<p>Most applications will use database connections to read data, for instance to read a projected model upon user request. This means that other parts of the application will be competing for a connection. It&rsquo;s recommend to configure a connection pool dedicated to the projections and use a different one in other parts of the application. </p></div>
<h2><a href="#exactly-once" name="exactly-once" class="anchor"><span class="anchor-link"></span></a>exactly-once</h2>
<p>The offset is stored in the same transaction used for the user defined <code>handler</code>, which means exactly-once processing semantics if the projection is restarted from previously stored offset.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka-projection/tree/v0.3/examples/src/test/scala/docs/jdbc/JdbcProjectionDocExample.scala#L21-L23" target="_blank" title="Go to snippet source"></a><code class="language-scala">import akka.projection.ProjectionId
import akka.projection.jdbc.scaladsl.JdbcProjection

implicit val ec = system.executionContext

val projection =
  JdbcProjection
    .exactlyOnce(
      projectionId = ProjectionId(&quot;ShoppingCarts&quot;, &quot;carts-1&quot;),
      sourceProvider,
      () =&gt; new PlainJdbcSession, // JdbcSession Factory
      handler = () =&gt; new ShoppingCartHandler(orderRepository))</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka-projection/tree/v0.3/examples/src/test/java/jdocs/jdbc/JdbcProjectionDocExample.java#L167-L175" target="_blank" title="Go to snippet source"></a><code class="language-java">final HibernateSessionFactory sessionProvider = new HibernateSessionFactory();

Projection&lt;EventEnvelope&lt;ShoppingCart.Event&gt;&gt; projection =
    JdbcProjection.exactlyOnce(
        ProjectionId.of(&quot;shopping-carts&quot;, &quot;carts-1&quot;),
        sourceProvider,
        () -&gt; sessionProvider.newInstance(),
        () -&gt; new ShoppingCartHandler(),
        system);</code></pre></dd>
</dl>
<p>The <a href="jdbc.html#handler"><code>ShoppingCartHandler</code> is shown below</a>.</p>
<h2><a href="#at-least-once" name="at-least-once" class="anchor"><span class="anchor-link"></span></a>at-least-once</h2>
<p>The offset is stored after the envelope has been processed and giving at-least-once processing semantics. This means that if the projection is restarted from a previously stored offset some elements may be processed more than once.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka-projection/tree/v0.3/examples/src/test/scala/docs/jdbc/JdbcProjectionDocExample.scala#L21-L23" target="_blank" title="Go to snippet source"></a><code class="language-scala">import akka.projection.ProjectionId
import akka.projection.jdbc.scaladsl.JdbcProjection

implicit val ec = system.executionContext

val projection =
  JdbcProjection
    .atLeastOnce(
      projectionId = ProjectionId(&quot;ShoppingCarts&quot;, &quot;carts-1&quot;),
      sourceProvider,
      () =&gt; new PlainJdbcSession, // JdbcSession Factory
      handler = () =&gt; new ShoppingCartHandler(orderRepository))
    .withSaveOffset(afterEnvelopes = 100, afterDuration = 500.millis)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka-projection/tree/v0.3/examples/src/test/java/jdocs/jdbc/JdbcProjectionDocExample.java#L181-L192" target="_blank" title="Go to snippet source"></a><code class="language-java">final HibernateSessionFactory sessionProvider = new HibernateSessionFactory();
int saveOffsetAfterEnvelopes = 100;
Duration saveOffsetAfterDuration = Duration.ofMillis(500);

Projection&lt;EventEnvelope&lt;ShoppingCart.Event&gt;&gt; projection =
    JdbcProjection.atLeastOnce(
            ProjectionId.of(&quot;shopping-carts&quot;, &quot;carts-1&quot;),
            sourceProvider,
            () -&gt; sessionProvider.newInstance(),
            () -&gt; new ShoppingCartHandler(),
            system)
        .withSaveOffset(saveOffsetAfterEnvelopes, saveOffsetAfterDuration);</code></pre></dd>
</dl>
<p>The offset is stored after a time window, or limited by a number of envelopes, whatever happens first. This window can be defined with <code>withSaveOffset</code> of the returned <code>AtLeastOnceProjection</code>. The default settings for the window is defined in configuration section <code>akka.projection.at-least-once</code>. There is a performance benefit of not storing the offset too often, but the drawback is that there can be more duplicates when the projection that will be processed again when the projection is restarted.</p>
<p>The <a href="jdbc.html#handler"><code>ShoppingCartHandler</code> is shown below</a>.</p>
<h2><a href="#groupedwithin" name="groupedwithin" class="anchor"><span class="anchor-link"></span></a>groupedWithin</h2>
<p>The envelopes can be grouped before processing, which can be useful for batch updates.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka-projection/tree/v0.3/examples/src/test/scala/docs/jdbc/JdbcProjectionDocExample.scala#L21-L23" target="_blank" title="Go to snippet source"></a><code class="language-scala">import akka.projection.ProjectionId
import akka.projection.jdbc.scaladsl.JdbcProjection

implicit val ec = system.executionContext

val projection =
  JdbcProjection
    .groupedWithin(
      projectionId = ProjectionId(&quot;ShoppingCarts&quot;, &quot;carts-1&quot;),
      sourceProvider,
      () =&gt; new PlainJdbcSession, // JdbcSession Factory
      handler = () =&gt; new GroupedShoppingCartHandler(orderRepository))
    .withGroup(groupAfterEnvelopes = 20, groupAfterDuration = 500.millis)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka-projection/tree/v0.3/examples/src/test/java/jdocs/jdbc/JdbcProjectionDocExample.java#L198-L209" target="_blank" title="Go to snippet source"></a><code class="language-java">final HibernateSessionFactory sessionProvider = new HibernateSessionFactory();
int saveOffsetAfterEnvelopes = 100;
Duration saveOffsetAfterDuration = Duration.ofMillis(500);

Projection&lt;EventEnvelope&lt;ShoppingCart.Event&gt;&gt; projection =
    JdbcProjection.groupedWithin(
            ProjectionId.of(&quot;shopping-carts&quot;, &quot;carts-1&quot;),
            sourceProvider,
            () -&gt; sessionProvider.newInstance(),
            () -&gt; new GroupedShoppingCartHandler(),
            system)
        .withGroup(saveOffsetAfterEnvelopes, saveOffsetAfterDuration);</code></pre></dd>
</dl>
<p>The envelopes are grouped within a time window, or limited by a number of envelopes, whatever happens first. This window can be defined with <code>withGroup</code> of the returned <code>GroupedProjection</code>. The default settings for the window is defined in configuration section <code>akka.projection.grouped</code>.</p>
<p>When using <code>groupedWithin</code> the handler is a <span class="group-scala"><code>JdbcHandler[immutable.Seq[EventEnvelope[ShoppingCart.Event]]]</code></span><span class="group-java"><code>JdbcHandler&lt;List&lt;EventEnvelope&lt;ShoppingCart.Event&gt;&gt;&gt;</code></span>. The <a href="jdbc.html#grouped-handler"><code>GroupedShoppingCartHandler</code> is shown below</a>.</p>
<p>The offset is stored in the same transaction used for the user defined <code>handler</code>, which means exactly-once processing semantics if the projection is restarted from previously stored offset.</p>
<h2><a href="#handler" name="handler" class="anchor"><span class="anchor-link"></span></a>Handler</h2>
<p>It&rsquo;s in the <span class="group-java"><a href="/api/akka-projection/0.3/akka/projection/jdbc/javadsl/JdbcHandler.html" title="akka.projection.jdbc.javadsl.JdbcHandler"><code>JdbcHandler</code></a></span><span class="group-scala"><a href="/api/akka-projection/0.3/akka/projection/jdbc/scaladsl/JdbcHandler.html" title="akka.projection.jdbc.scaladsl.JdbcHandler"><code>JdbcHandler</code></a></span> that you implement the processing of each envelope. It&rsquo;s essentially a consumer function from <code>(JdbcSession, Envelope)</code> to <span class="group-scala"><code>Unit</code></span><span class="group-java"><code>void</code></span>. </p>
<p>A handler that is consuming <code>ShoppingCart.Event</code> from <code>eventsByTag</code> can look like this:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka-projection/tree/v0.3/examples/src/test/scala/docs/jdbc/JdbcProjectionDocExample.scala#L16-L17" target="_blank" title="Go to snippet source"></a><code class="language-scala">import akka.projection.jdbc.scaladsl.JdbcHandler

class ShoppingCartHandler(repository: OrderRepository)
    extends JdbcHandler[EventEnvelope[ShoppingCart.Event], PlainJdbcSession] {
  private val logger = LoggerFactory.getLogger(getClass)

  override def process(session: PlainJdbcSession, envelope: EventEnvelope[ShoppingCart.Event]): Unit = {
    envelope.event match {
      case ShoppingCart.CheckedOut(cartId, time) =&gt;
        logger.info(s&quot;Shopping cart $cartId was checked out at $time&quot;)
        session.withConnection { conn =&gt;
          repository.save(conn, Order(cartId, time))
        }

      case otherEvent =&gt;
        logger.debug(s&quot;Shopping cart ${otherEvent.cartId} changed by $otherEvent&quot;)
    }
  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka-projection/tree/v0.3/examples/src/test/java/jdocs/jdbc/JdbcProjectionDocExample.java#L105-L126" target="_blank" title="Go to snippet source"></a><code class="language-java">public class ShoppingCartHandler
    extends JdbcHandler&lt;EventEnvelope&lt;ShoppingCart.Event&gt;, HibernateJdbcSession&gt; {
  private Logger logger = LoggerFactory.getLogger(getClass());

  @Override
  public void process(HibernateJdbcSession session, EventEnvelope&lt;ShoppingCart.Event&gt; envelope)
      throws Exception {
    ShoppingCart.Event event = envelope.event();
    if (event instanceof ShoppingCart.CheckedOut) {
      ShoppingCart.CheckedOut checkedOut = (ShoppingCart.CheckedOut) event;
      logger.info(
          &quot;Shopping cart {} was checked out at {}&quot;, checkedOut.cartId, checkedOut.eventTime);

      // pass the EntityManager created by the projection
      // to the repository in order to use the same transaction
      orderRepository.save(
          session.entityManager, new Order(checkedOut.cartId, checkedOut.eventTime));
    } else {
      logger.debug(&quot;Shopping cart {} changed by {}&quot;, event.getCartId(), event);
    }
  }
}</code></pre></dd>
</dl><div class="callout note "><div class="callout-title">Hint</div>
<p>Such simple handlers can also be defined as plain functions via the helper <span class="group-scala"><code>JdbcHandler.apply</code></span><span class="group-java"><code>JdbcHandler.fromFunction</code></span> factory method.</p></div>
<p>where the <code>OrderRepository</code> is an implementation of:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka-projection/tree/v0.3/examples/src/test/scala/docs/jdbc/JdbcProjectionDocExample.scala#L42-L45" target="_blank" title="Go to snippet source"></a><code class="language-scala">case class Order(id: String, time: Instant)
trait OrderRepository {
  def save(connection: Connection, order: Order): Unit
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka-projection/tree/v0.3/examples/src/test/java/jdocs/jdbc/JdbcProjectionDocExample.java#L46-L58" target="_blank" title="Go to snippet source"></a><code class="language-java">class Order {
  public final String id;
  public final Instant time;

  public Order(String id, Instant time) {
    this.id = id;
    this.time = time;
  }
}

interface OrderRepository {
  void save(EntityManager entityManager, Order order);
}</code></pre></dd>
</dl>
<h3><a href="#grouped-handler" name="grouped-handler" class="anchor"><span class="anchor-link"></span></a>Grouped handler</h3>
<p>When using <a href="jdbc.html#groupedwithin"><code>JdbcProjection.groupedWithin</code></a> the handler is processing a <span class="group-scala"><code>Seq</code></span><span class="group-java"><code>List</code></span> of envelopes.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka-projection/tree/v0.3/examples/src/test/scala/docs/jdbc/JdbcProjectionDocExample.scala#L16-L17" target="_blank" title="Go to snippet source"></a><code class="language-scala">import akka.projection.jdbc.scaladsl.JdbcHandler

import scala.collection.immutable

class GroupedShoppingCartHandler(repository: OrderRepository)
    extends JdbcHandler[immutable.Seq[EventEnvelope[ShoppingCart.Event]], PlainJdbcSession] {
  private val logger = LoggerFactory.getLogger(getClass)

  override def process(
      session: PlainJdbcSession,
      envelopes: immutable.Seq[EventEnvelope[ShoppingCart.Event]]): Unit = {

    // save all events in DB
    envelopes.map(_.event).foreach {
      case ShoppingCart.CheckedOut(cartId, time) =&gt;
        logger.info(s&quot;Shopping cart $cartId was checked out at $time&quot;)
        session.withConnection { conn =&gt;
          repository.save(conn, Order(cartId, time))
        }

      case otherEvent =&gt;
        logger.debug(s&quot;Shopping cart ${otherEvent.cartId} changed by $otherEvent&quot;)
    }
  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka-projection/tree/v0.3/examples/src/test/java/jdocs/jdbc/JdbcProjectionDocExample.java#L130-L155" target="_blank" title="Go to snippet source"></a><code class="language-java">public class GroupedShoppingCartHandler
    extends JdbcHandler&lt;List&lt;EventEnvelope&lt;ShoppingCart.Event&gt;&gt;, HibernateJdbcSession&gt; {
  private Logger logger = LoggerFactory.getLogger(getClass());

  @Override
  public void process(
      HibernateJdbcSession session, List&lt;EventEnvelope&lt;ShoppingCart.Event&gt;&gt; envelopes)
      throws Exception {
    for (EventEnvelope&lt;ShoppingCart.Event&gt; envelope : envelopes) {
      ShoppingCart.Event event = envelope.event();
      if (event instanceof ShoppingCart.CheckedOut) {
        ShoppingCart.CheckedOut checkedOut = (ShoppingCart.CheckedOut) event;
        logger.info(
            &quot;Shopping cart {} was checked out at {}&quot;, checkedOut.cartId, checkedOut.eventTime);

        // pass the EntityManager created by the projection
        // to the repository in order to use the same transaction
        orderRepository.save(
            session.entityManager, new Order(checkedOut.cartId, checkedOut.eventTime));

      } else {
        logger.debug(&quot;Shopping cart {} changed by {}&quot;, event.getCartId(), event);
      }
    }
  }
}</code></pre></dd>
</dl>
<h3><a href="#stateful-handler" name="stateful-handler" class="anchor"><span class="anchor-link"></span></a>Stateful handler</h3>
<p>The <code>JdbcHandler</code> can be stateful, with variables and mutable data structures. It is invoked by the <code>Projection</code> machinery one envelope at a time and visibility guarantees between the invocations are handled automatically, i.e. no volatile or other concurrency primitives are needed for managing the state as long as it&rsquo;s not accessed by other threads than the one that called <code>process</code>.</p><div class="callout note "><div class="callout-title">Note</div>
<p>It is important that the <code>Handler</code> instance is not shared between several <code>Projection</code> instances, because then it would be invoked concurrently, which is not how it is intended to be used. Each <code>Projection</code> instance should use a new <code>Handler</code> instance. </p></div>
<h3><a href="#async-handler" name="async-handler" class="anchor"><span class="anchor-link"></span></a>Async handler</h3>
<p>The <span class="group-java"><a href="/api/akka-projection/0.3/akka/projection/javadsl/Handler.html" title="akka.projection.javadsl.Handler"><code>Handler</code></a></span><span class="group-scala"><a href="/api/akka-projection/0.3/akka/projection/scaladsl/Handler.html" title="akka.projection.scaladsl.Handler"><code>Handler</code></a></span> can be used with <code>JdbcProjection.atLeastOnceAsync</code> and <code>JdbcProjection.groupedWithinAsync</code> if the handler is not storing the projection result in the database. The handler could <a href="kafka.html#sending-to-kafka">send to a Kafka topic</a> or integrate with something else.</p>
<p>There are several examples of such <code>Handler</code> in the <a href="cassandra.html#handler">documentation for Cassandra Projections</a>. Same type of handlers can be used with <code>JdbcProjection</code> instead of <code>CassandraProjection</code>.</p>
<h3><a href="#actor-handler" name="actor-handler" class="anchor"><span class="anchor-link"></span></a>Actor handler</h3>
<p>A good alternative for advanced state management is to implement the handler as an <a href="https://doc.akka.io/docs/akka/current/typed/actors.html">actor</a>, which is described in <a href="actor.html">Processing with Actor</a>.</p>
<h3><a href="#flow-handler" name="flow-handler" class="anchor"><span class="anchor-link"></span></a>Flow handler</h3>
<p>An Akka Streams <code>FlowWithContext</code> can be used instead of a handler for processing the envelopes, which is described in <a href="flow.html">Processing with Akka Streams</a>.</p>
<h3><a href="#handler-lifecycle" name="handler-lifecycle" class="anchor"><span class="anchor-link"></span></a>Handler lifecycle</h3>
<p>You can override the <code>start</code> and <code>stop</code> methods of the <span class="group-java"><a href="/api/akka-projection/0.3/akka/projection/jdbc/javadsl/JdbcHandler.html" title="akka.projection.jdbc.javadsl.JdbcHandler"><code>JdbcHandler</code></a></span><span class="group-scala"><a href="/api/akka-projection/0.3/akka/projection/jdbc/scaladsl/JdbcHandler.html" title="akka.projection.jdbc.scaladsl.JdbcHandler"><code>JdbcHandler</code></a></span> to implement initialization before first envelope is processed and resource cleanup when the projection is stopped. Those methods are also called when the <code>Projection</code> is restarted after failure.</p>
<p>See also <a href="error.html">error handling</a>.</p>
<h2><a href="#schema" name="schema" class="anchor"><span class="anchor-link"></span></a>Schema</h2>
<p>The database schema for the offset storage table:</p>
<dl>
  <dt>Postgres</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka-projection/tree/v0.3/examples/src/test/resources/create-tables.sql#L3-L15" target="_blank" title="Go to snippet source"></a><code class="language-sql">create table if not exists &quot;AKKA_PROJECTION_OFFSET_STORE&quot; (
  &quot;PROJECTION_NAME&quot; VARCHAR(255) NOT NULL,
  &quot;PROJECTION_KEY&quot; VARCHAR(255) NOT NULL,
  &quot;OFFSET&quot; VARCHAR(255) NOT NULL,
  &quot;MANIFEST&quot; VARCHAR(4) NOT NULL,
  &quot;MERGEABLE&quot; BOOLEAN NOT NULL,
  &quot;LAST_UPDATED&quot; TIMESTAMP(9) WITH TIME ZONE NOT NULL
);

create index &quot;PROJECTION_NAME_INDEX&quot; on &quot;AKKA_PROJECTION_OFFSET_STORE&quot; (&quot;PROJECTION_NAME&quot;);

alter table &quot;AKKA_PROJECTION_OFFSET_STORE&quot;
  add constraint &quot;PK_PROJECTION_ID&quot; primary key(&quot;PROJECTION_NAME&quot;,&quot;PROJECTION_KEY&quot;);</code></pre></dd>
  <dt>MySQL</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka-projection/tree/v0.3/examples/src/test/resources/create-tables.sql#L19-L31" target="_blank" title="Go to snippet source"></a><code class="language-sql">create table if not exists AKKA_PROJECTION_OFFSET_STORE (
  PROJECTION_NAME VARCHAR(255) NOT NULL,
  PROJECTION_KEY VARCHAR(255) NOT NULL,
  OFFSET VARCHAR(255) NOT NULL,
  MANIFEST VARCHAR(4) NOT NULL,
  MERGEABLE BOOLEAN NOT NULL,
  LAST_UPDATED TEXT NOT NULL
);

create index PROJECTION_NAME_INDEX on AKKA_PROJECTION_OFFSET_STORE (PROJECTION_NAME);

alter table AKKA_PROJECTION_OFFSET_STORE
  add constraint PK_PROJECTION_ID primary key(PROJECTION_NAME,PROJECTION_KEY);</code></pre></dd>
  <dt>MS SQL Server</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka-projection/tree/v0.3/examples/src/test/resources/create-tables.sql#L35-L49" target="_blank" title="Go to snippet source"></a><code class="language-sql">IF  NOT EXISTS (SELECT 1 FROM sys.objects WHERE object_id = OBJECT_ID(N&#39;AKKA_PROJECTION_OFFSET_STORE&#39;) AND type in (N&#39;U&#39;))
begin
create table &quot;AKKA_PROJECTION_OFFSET_STORE&quot; (
  &quot;PROJECTION_NAME&quot; VARCHAR(255) NOT NULL,
  &quot;PROJECTION_KEY&quot; VARCHAR(255) NOT NULL,
  &quot;OFFSET&quot; VARCHAR(255) NOT NULL,
  &quot;MANIFEST&quot; VARCHAR(4) NOT NULL,
  &quot;MERGEABLE&quot; BIT NOT NULL,
  &quot;LAST_UPDATED&quot; DATETIME2 NOT NULL
)

alter table &quot;AKKA_PROJECTION_OFFSET_STORE&quot; add constraint &quot;PK_PROJECTION_ID&quot; primary key(&quot;PROJECTION_NAME&quot;,&quot;PROJECTION_KEY&quot;)

create index &quot;PROJECTION_NAME_INDEX&quot; on &quot;AKKA_PROJECTION_OFFSET_STORE&quot; (&quot;PROJECTION_NAME&quot;)
end</code></pre></dd>
  <dt>H2</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka-projection/tree/v0.3/examples/src/test/resources/create-tables.sql#L3-L15" target="_blank" title="Go to snippet source"></a><code class="language-sql">create table if not exists &quot;AKKA_PROJECTION_OFFSET_STORE&quot; (
  &quot;PROJECTION_NAME&quot; VARCHAR(255) NOT NULL,
  &quot;PROJECTION_KEY&quot; VARCHAR(255) NOT NULL,
  &quot;OFFSET&quot; VARCHAR(255) NOT NULL,
  &quot;MANIFEST&quot; VARCHAR(4) NOT NULL,
  &quot;MERGEABLE&quot; BOOLEAN NOT NULL,
  &quot;LAST_UPDATED&quot; TIMESTAMP(9) WITH TIME ZONE NOT NULL
);

create index &quot;PROJECTION_NAME_INDEX&quot; on &quot;AKKA_PROJECTION_OFFSET_STORE&quot; (&quot;PROJECTION_NAME&quot;);

alter table &quot;AKKA_PROJECTION_OFFSET_STORE&quot;
  add constraint &quot;PK_PROJECTION_ID&quot; primary key(&quot;PROJECTION_NAME&quot;,&quot;PROJECTION_KEY&quot;);</code></pre></dd>
</dl>
<h2><a href="#offset-types" name="offset-types" class="anchor"><span class="anchor-link"></span></a>Offset types</h2>
<p>The supported offset types of the <code>JdbcProjection</code> are:</p>
<ul>
  <li><code>akka.persistence.query.Offset</code> types from <a href="eventsourced.html">events from Akka Persistence</a></li>
  <li><code>MergeableOffset</code> that is used for <a href="kafka.html">messages from Kafka</a></li>
  <li><code>String</code></li>
  <li><code>Int</code></li>
  <li><code>Long</code></li>
  <li>Any other type that has a configured Akka Serializer is stored with base64 encoding of the serialized bytes.  For example the <a href="https://doc.akka.io/docs/akka-persistence-spanner/current/">Akka Persistence Spanner</a> offset  is supported in this way.</li>
</ul>
<h2><a href="#configuration" name="configuration" class="anchor"><span class="anchor-link"></span></a>Configuration</h2>
<p>Make your edits/overrides in your application.conf.</p>
<p>The reference configuration file with the default values:</p>
<pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka-projection/tree/v0.3/akka-projection-jdbc/src/main/resources/reference.conf#L5-L25" target="_blank" title="Go to snippet source"></a><code class="language-conf">akka.projection.jdbc = {
  # choose one of: mysql-dialect, postgres-dialect, mssql-dialect or h2-dialect (testing)
  dialect = &quot;&quot;

  blocking-jdbc-dispatcher {
    type = Dispatcher
    executor = &quot;thread-pool-executor&quot;
    thread-pool-executor {
      # Use same number of threads as connections in the JDBC connection pool.
      fixed-pool-size = &quot;&quot;
    }
    throughput = 1
  }

  offset-store {
    # set this to your database schema if applicable, empty by default
    schema = &quot;&quot;
    # the database table name for the offset store
    table = &quot;AKKA_PROJECTION_OFFSET_STORE&quot;
  }
}</code></pre><div class="callout note "><div class="callout-title">Note</div>
<p>Settings <code>akka.projection.jdbc.dialect</code> and <code>akka.projection.jdbc.blocking-jdbc-dispatcher.thread-pool-executor.fixed-pool-size</code> do not have a valid default value. You must configured them in your <code>application.conf</code> file. </p>
<p>See <a href="jdbc.html#required-configuration-settings">Required Configuration Settings</a> and <a href="jdbc.html#blocking-jdbc-dispatcher">Blocking JDBC Dispatcher</a> sections for details. </p></div>
</div>
</article>
<div class="row">
<div class="small-12 column">
<section class="nav-prev-next row">
<div class="nav-prev small-6 column">
<a href="cassandra.html"><i class="icon-prev"></i> <span class="link-prev">Offset in Cassandra</span></a>
</div>
<div class="nav-next small-6 column clearfix">
<a class="float-right" href="slick.html">Offset in a relational DB with Slick <i class="icon-next"></i></a>
</div>
</section>
</div>
</div>
<div class="source-github row">
Found an error in this documentation? The source code for this page can be found <a href="https://github.com/akka/akka-projection/tree/v0.3/docs/src/main/paradox/jdbc.md">here</a>.
Please feel free to edit and contribute a pull request.
</div>

<footer class="page-footer row clearfix">
<img class="akka-icon float-left show-for-medium" src="images/akka-icon.svg" />
<section class="copyright">
<div>Akka Projection is Open Source and available under the Apache 2 License.</div>
<p class="legal">
&copy; 2011-2020 <a href="https://www.lightbend.com" target="_blank">Lightbend, Inc.</a> |
<a href="https://www.lightbend.com/legal/licenses" target="_blank">Licenses</a> |
<a href="https://www.lightbend.com/legal/terms" target="_blank">Terms</a> |
<a href="https://www.lightbend.com/legal/privacy" target="_blank">Privacy Policy</a> |
<a href="https://akka.io/cookie/" target="_blank">Cookie Listing</a> |
<a class="optanon-toggle-display">Cookie Settings</a>
</p>
</section>

</footer>
</section>
</main>
</div>

<script type="text/javascript" src="js/scrollsneak.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="js/groups.js"></script>
<script type="text/javascript" src="js/page.js"></script>
<script type="text/javascript" src="js/magellan.js"></script>
<script type="text/javascript" src="js/metadata-toggle.js"></script>

<style type="text/css">@import "lib/prettify/prettify.css";</style>
<script type="text/javascript" src="lib/prettify/prettify.js"></script>
<script type="text/javascript" src="lib/prettify/lang-scala.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(){window.prettyPrint && prettyPrint()});
//]]></script>
<script type="text/javascript" src="assets/js/warnOldVersion.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(jq){initOldVersionWarnings(jq, '0.3', 'https://doc.akka.io/docs/akka-projection/current/')});
//]]></script>


</body>
</html>
