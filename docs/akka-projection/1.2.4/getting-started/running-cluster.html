<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Running the Projection in Akka Cluster &bull; Akka Projection</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="Akka Projection."/>
<link rel="canonical" href="https://doc.akka.io/docs/akka-projection/current/getting-started/running-cluster.html"/>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../lib/foundation/dist/js/foundation.min.js"></script>
<link rel="stylesheet" type="text/css" href="../lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="../lib/foundation/dist/css/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" type="text/css" href="../css/icons.css"/>
<link rel="stylesheet" type="text/css" href="../css/page-8.css"/>
<link rel="stylesheet" type="text/css" href="../css/banner-2.css"/>
<link rel="shortcut icon" href="../images/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="../images/apple-touch-icon.png"/>
<link rel="icon" type="image/png" sizes="32x32" href="../images/favicon-32x32.png"/>
<link rel="icon" type="image/png" sizes="16x16" href="../images/favicon-16x16.png"/>
<link rel="manifest" href="../images/manifest.json"/>
<meta name="msapplication-TileImage" content="../images/mstile-150x150.png"/>
<meta name="msapplication-TileColor" content="#15a9ce"/>
<meta name="theme-color" content="#15a9ce"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) start -->
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js"  type="text/javascript" charset="UTF-8" data-domain-script="28b912e7-09e9-43d5-91e4-3d1897044004" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) end -->
<!--Google Analytics-->
<script type="text/plain" class="optanon-category-2">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', '']);
_gaq.push(['_setDomainName', '']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})()
</script>
<!-- Google Tag Manager -->
<script type="text/plain" class="optanon-category-2">
(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KBJGH35');
</script>
<!--Marketo-->
<script type="text/plain" class="optanon-category-3">
(function() {
var didInit = false;
function initMunchkin() {
if(didInit === false) {
didInit = true;
Munchkin.init('558-NCX-702', { 'asyncOnly': true, 'disableClickDelay': true });
}
}
var s = document.createElement('script');
s.type = 'text/javascript';
s.async = true;
s.src = '//munchkin.marketo.net/munchkin.js';
s.onreadystatechange = function() {
if (this.readyState == 'complete' || this.readyState == 'loaded') {
initMunchkin();
}
};
s.onload = initMunchkin;
document.getElementsByTagName('head')[0].appendChild(s);
})();
</script>
</head>

<body id="underlay" data-toggler="nav-open">
<div id="lightbend-banner" class="lightbend-banner akka full-width" data-category="OSS Lightbend Banner Impression" data-label="Akka Banner Impression">
<div class="oss-wrapper">
<div class="oss-brand">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lightbend Logo - Akka Banner" href="https://www.lightbend.com">
<img class="lightbend-logo" src="../images/banner-logos/lightbend-reverse.svg" alt="Lightbend" title="Lightbend">
</a>
</div>
<div class="oss-ad no-drop-down">
<nav id="lightbendRotator" class="lightbend-rotator">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Promo Rotator - Kalix - High-performance microservices and APIs with no operations required. - Akka Banner" href="https://www.kalix.io/">
<strong>Kalix</strong> - High-performance microservices and APIs with no operations required. <span class="akka-btn">Learn More</span>
</a>
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Promo Rotator - Meet Akka Insights! A stand alone telemetry & observability offering. [Learn More] - Akka Banner" href="https://www.lightbend.com/akka-insights">
<strong>Meet Akka Insights!</strong>&nbsp;&nbsp;A stand alone telemetry & observability offering. <span class="akka-btn">Learn More</span>
</a>
</nav>
</div>
</div>
</div>

<header class="site-header hide-for-large">
<div class="sticky-header clearfix">
<a href="https://akka.io"><img class="logo" src="../images/akka-logo-reverse.svg"/></a>

<button class="menu-icon float-right" type="button" data-toggle="underlay overlay"></button>
</div>
<div id="overlay" class="overlay-nav" data-toggler="nav-open">
<header class="nav-header">
<div class="nav-header-title">
<h1><a href="../index.html">Akka Projection</a></h1>
</div>
<div class="nav-header-version">
Version 1.2.4
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="nav-toc">
<ul>
  <li><a href="../overview.html" class="page">Overview</a></li>
  <li><a href="../use-cases.html" class="page">Use Cases</a></li>
  <li><a href="../getting-started/index.html" class="page">Getting Started Guide</a>
  <ul>
    <li><a href="../getting-started/index.html#video-introduction" class="header">Video Introduction</a></li>
    <li><a href="../getting-started/setup-your-app.html" class="page">Setup your application</a></li>
    <li><a href="../getting-started/source-provider.html" class="page">Choosing a Source Provider</a></li>
    <li><a href="../getting-started/projection-handler.html" class="page">Build a Projection handler</a></li>
    <li><a href="../getting-started/testing.html" class="page">Writing tests for a Projection</a></li>
    <li><a href="../getting-started/running.html" class="page">Running the Projection</a></li>
    <li><a href="../getting-started/running-cluster.html#running-the-projection-in-akka-cluster" class="active page">Running the Projection in Akka Cluster</a></li>
  </ul></li>
  <li><a href="../eventsourced.html" class="page">Events from Akka Persistence</a></li>
  <li><a href="../durable-state.html" class="page">Changes from Durable State</a></li>
  <li><a href="../kafka.html" class="page">Messages from and to Kafka</a></li>
  <li><a href="../cassandra.html" class="page">Offset in Cassandra</a></li>
  <li><a href="../jdbc.html" class="page">Offset in a relational DB with JDBC</a></li>
  <li><a href="../slick.html" class="page">Offset in a relational DB with Slick</a></li>
  <li><a href="../running.html" class="page">Running a Projection</a></li>
  <li><a href="../actor.html" class="page">Processing with Actor</a></li>
  <li><a href="../flow.html" class="page">Processing with Akka Streams</a></li>
  <li><a href="../error.html" class="page">Error handling</a></li>
  <li><a href="../projection-settings.html" class="page">Projection Settings</a></li>
  <li><a href="../management.html" class="page">Management of a Projection</a></li>
  <li><a href="../testing.html" class="page">Testing</a></li>
  <li><a href="../classic.html" class="page">Akka Classic</a></li>
  <li><a href="../snapshots.html" class="page">Snapshots</a></li>
</ul>
</nav>
</div>
</header>
<div class="site-content-wrapper">
<aside class="sticky-sidebar show-for-large">
<header class="nav-header sticky-sidebar-header">
<div class="nav-header-title">
<h1><a href="../index.html">Akka Projection</a></h1>
</div>
<div class="nav-header-version">
Version 1.2.4
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="site-nav sticky-sidebar-contents">
<div class="nav-toc">
<ul>
  <li><a href="../overview.html" class="page">Overview</a></li>
  <li><a href="../use-cases.html" class="page">Use Cases</a></li>
  <li><a href="../getting-started/index.html" class="page">Getting Started Guide</a>
  <ul>
    <li><a href="../getting-started/index.html#video-introduction" class="header">Video Introduction</a></li>
    <li><a href="../getting-started/setup-your-app.html" class="page">Setup your application</a></li>
    <li><a href="../getting-started/source-provider.html" class="page">Choosing a Source Provider</a></li>
    <li><a href="../getting-started/projection-handler.html" class="page">Build a Projection handler</a></li>
    <li><a href="../getting-started/testing.html" class="page">Writing tests for a Projection</a></li>
    <li><a href="../getting-started/running.html" class="page">Running the Projection</a></li>
    <li><a href="../getting-started/running-cluster.html#running-the-projection-in-akka-cluster" class="active page">Running the Projection in Akka Cluster</a></li>
  </ul></li>
  <li><a href="../eventsourced.html" class="page">Events from Akka Persistence</a></li>
  <li><a href="../durable-state.html" class="page">Changes from Durable State</a></li>
  <li><a href="../kafka.html" class="page">Messages from and to Kafka</a></li>
  <li><a href="../cassandra.html" class="page">Offset in Cassandra</a></li>
  <li><a href="../jdbc.html" class="page">Offset in a relational DB with JDBC</a></li>
  <li><a href="../slick.html" class="page">Offset in a relational DB with Slick</a></li>
  <li><a href="../running.html" class="page">Running a Projection</a></li>
  <li><a href="../actor.html" class="page">Processing with Actor</a></li>
  <li><a href="../flow.html" class="page">Processing with Akka Streams</a></li>
  <li><a href="../error.html" class="page">Error handling</a></li>
  <li><a href="../projection-settings.html" class="page">Projection Settings</a></li>
  <li><a href="../management.html" class="page">Management of a Projection</a></li>
  <li><a href="../testing.html" class="page">Testing</a></li>
  <li><a href="../classic.html" class="page">Akka Classic</a></li>
  <li><a href="../snapshots.html" class="page">Snapshots</a></li>
</ul>
</div>
</nav>
<footer class="nav-footer sticky-sidebar-footer">
<a href="https://akka.io"><img class="logo" src="../images/akka-logo-reverse.svg"/></a>

</footer>
</aside>
<main class="fixed-shift-for-large expanded row">
<section class="site-content small-12 column">
<article class="page-content row">
<div class="small-12 column" id="docs">
<h1><a href="#running-the-projection-in-akka-cluster" name="running-the-projection-in-akka-cluster" class="anchor"><span class="anchor-link"></span></a>Running the Projection in Akka Cluster</h1>
<p>Running the Projection with <a href="https://doc.akka.io/docs/akka/current/typed/cluster.html">Akka Cluster</a> allows us to add two important aspects to our system: availability and scalability. A Projection running as a single Actor creates a single point of failure (availability), when the app shuts down for any reason, the projection is no longer running until it&rsquo;s started again. A Projection running as a single Actor creates a processing bottleneck (scalability), all messages from the <span class="group-java"><a href="/api/akka-projection/1.2.4/akka/projection/javadsl/SourceProvider.html" title="akka.projection.javadsl.SourceProvider"><code>SourceProvider</code></a></span><span class="group-scala"><a href="/api/akka-projection/1.2.4/akka/projection/scaladsl/SourceProvider.html" title="akka.projection.scaladsl.SourceProvider"><code>SourceProvider</code></a></span> are processed by a single Actor on a single machine. By using a <a href="https://doc.akka.io/docs/akka/current/typed/cluster-sharded-daemon-process.html#sharded-daemon-process">Sharded Daemon Process</a> with Akka Cluster and <a href="https://doc.akka.io/docs/akka/current/typed/cluster-sharding.html">Akka Cluster Sharding</a> we can scale up the Projection and make it more available by running at least as many instances of the same Projection as we have cluster members. As Akka cluster members join and leave the cluster the Sharded Daemon Process will automatically scale and rebalance Sharded Daemon Processes (Projection instances) accordingly.</p>
<p>Running the Projection as a Sharded Daemon Process requires no changes to our projection handler and repository, we only need to change the way in which the actor that runs the Projection is initialized. In the cluster version of this app we use a different configuration that configures Akka cluster. The main difference in the app itself is that we use <span class="group-java"><a href="https://doc.akka.io/japi/akka/2.6.16/akka/cluster/sharding/typed/javadsl/ShardedDaemonProcess.html" title="akka.cluster.sharding.typed.javadsl.ShardedDaemonProcess"><code>ShardedDaemonProcess</code></a></span><span class="group-scala"><a href="https://doc.akka.io/api/akka/2.6.16/akka/cluster/sharding/typed/scaladsl/ShardedDaemonProcess.html" title="akka.cluster.sharding.typed.scaladsl.ShardedDaemonProcess"><code>ShardedDaemonProcess</code></a></span> to initialize the Projection actor on our behalf. Instead of creating single instances of our repository and projection handler we create factory methods that encapsulate their instantiation along with the sharded daemon actors (1 per tag) assigned to this cluster member.</p>
<p>Add a new configuration file <code>guide-shopping-cart-cluster-app.conf</code> to your <code>src/main/resources/</code> directory. This configuration is largely the same as before, but includes extra configuration to enable cluster connectivity and sharding:</p>
<pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/resources/guide-shopping-cart-cluster-app.conf#L2-L70" target="_blank" title="Go to snippet source">source</a><code class="language-conf">datastax-java-driver {
  # basic.contact-points = [&quot;127.0.0.1:9042&quot;]
  # basic.load-balancing-policy.local-datacenter = &quot;datacenter1&quot;
  advanced {
    # reconnect to c* if down when app is started
    reconnect-on-init = true
  }
}

akka {
  loglevel = DEBUG
  actor {
    provider = &quot;cluster&quot;
    serialization-bindings {
      &quot;docs.guide.CborSerializable&quot; = jackson-cbor
      &quot;jdocs.guide.CborSerializable&quot; = jackson-cbor
    }
  }

  # For the sample, just bind to loopback and do not allow access from the network
  # the port is overridden by the logic in main class
  remote.artery {
    canonical.port = 0
    canonical.hostname = 127.0.0.1
  }

  cluster {
    seed-nodes = [
      &quot;akka://ShoppingCartClusterApp@127.0.0.1:2551&quot;,
      &quot;akka://ShoppingCartClusterApp@127.0.0.1:2552&quot;
    ]

    downing-provider-class = &quot;akka.cluster.sbr.SplitBrainResolverProvider&quot;
  }

  persistence.journal {
    plugin = &quot;akka.persistence.cassandra.journal&quot;
    auto-start-journals = [&quot;akka.persistence.cassandra.journal&quot;]
  }

  persistence.snapshot-store.plugin = &quot;akka.persistence.cassandra.snapshot&quot;

  persistence {
    cassandra {
      journal {
        # to create the schema
        keyspace-autocreate = true
        tables-autocreate = true
      }

      snapshot {
        # to create the schema
        keyspace-autocreate = true
        tables-autocreate = true
      }

      query {
        refresh-interval = 2s
      }

      events-by-tag {
        # for lower latency
        eventual-consistency-delay = 25ms
        flush-interval = 25ms
        pubsub-notification = on
      }
    }
  }
}</code></pre>
<p>Add the <code>ShoppingCartClusterApp</code> to your project:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/scala/docs/guide/ShoppingCartClusterApp.scala#L6-L62" target="_blank" title="Go to snippet source">source</a><code class="language-scala">package docs.guide

import akka.actor.typed.ActorSystem
import akka.actor.typed.scaladsl.Behaviors
import akka.cluster.sharding.typed.scaladsl.ShardedDaemonProcess
import akka.persistence.cassandra.query.scaladsl.CassandraReadJournal
import akka.persistence.query.Offset
import akka.projection.ProjectionBehavior
import akka.projection.ProjectionId
import akka.projection.cassandra.scaladsl.CassandraProjection
import akka.projection.eventsourced.EventEnvelope
import akka.projection.eventsourced.scaladsl.EventSourcedProvider
import akka.projection.scaladsl.SourceProvider
import akka.stream.alpakka.cassandra.scaladsl.CassandraSessionRegistry
import com.typesafe.config.ConfigFactory

object ShoppingCartClusterApp extends App {
  val port = args.headOption match {
    case Some(portString) if portString.matches(&quot;&quot;&quot;\d+&quot;&quot;&quot;) =&gt; portString.toInt
    case _                                                 =&gt; throw new IllegalArgumentException(&quot;An akka cluster port argument is required&quot;)
  }

  val config = ConfigFactory
    .parseString(s&quot;akka.remote.artery.canonical.port = $port&quot;)
    .withFallback(ConfigFactory.load(&quot;guide-shopping-cart-cluster-app.conf&quot;))

  ActorSystem(
    Behaviors.setup[String] { context =&gt;
      val system = context.system
      implicit val ec = system.executionContext
      val session = CassandraSessionRegistry(system).sessionFor(&quot;akka.projection.cassandra.session-config&quot;)
      val repo = new ItemPopularityProjectionRepositoryImpl(session)

      def sourceProvider(tag: String): SourceProvider[Offset, EventEnvelope[ShoppingCartEvents.Event]] =
        EventSourcedProvider
          .eventsByTag[ShoppingCartEvents.Event](
            system,
            readJournalPluginId = CassandraReadJournal.Identifier,
            tag = tag)

      def projection(tag: String) =
        CassandraProjection.atLeastOnce(
          projectionId = ProjectionId(&quot;shopping-carts&quot;, tag),
          sourceProvider(tag),
          handler = () =&gt; new ItemPopularityProjectionHandler(tag, system, repo))

      ShardedDaemonProcess(system).init[ProjectionBehavior.Command](
        name = &quot;shopping-carts&quot;,
        numberOfInstances = ShoppingCartTags.Tags.size,
        behaviorFactory = (i: Int) =&gt; ProjectionBehavior(projection(ShoppingCartTags.Tags(i))),
        stopMessage = ProjectionBehavior.Stop)

      Behaviors.empty
    },
    &quot;ShoppingCartClusterApp&quot;,
    config)
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/java/jdocs/guide/ShoppingCartClusterApp.java#L6-L77" target="_blank" title="Go to snippet source">source</a><code class="language-java">package jdocs.guide;

import akka.actor.typed.ActorSystem;
import akka.actor.typed.javadsl.Behaviors;
import akka.cluster.sharding.typed.javadsl.ShardedDaemonProcess;
import akka.projection.ProjectionBehavior;
import akka.projection.eventsourced.EventEnvelope;
import com.typesafe.config.Config;
import com.typesafe.config.ConfigFactory;
import akka.persistence.cassandra.query.javadsl.CassandraReadJournal;
import akka.persistence.query.Offset;
import akka.projection.eventsourced.javadsl.EventSourcedProvider;
import akka.projection.javadsl.SourceProvider;
import akka.projection.ProjectionId;
import akka.projection.cassandra.javadsl.CassandraProjection;
import akka.projection.javadsl.AtLeastOnceProjection;
import akka.stream.alpakka.cassandra.javadsl.CassandraSession;
import akka.stream.alpakka.cassandra.javadsl.CassandraSessionRegistry;

public class ShoppingCartClusterApp {
  public static void main(String[] args) throws Exception {
    if (args.length == 0) {
      throw new IllegalArgumentException(&quot;An akka cluster port argument is required&quot;);
    }

    String portString = args[0];
    int port = Integer.parseInt(portString);

    Config config =
        ConfigFactory.parseString(&quot;akka.remote.artery.canonical.port = &quot; + port)
            .withFallback(ConfigFactory.load(&quot;guide-shopping-cart-cluster-app.conf&quot;));

    ActorSystem.create(
        Behaviors.setup(
            context -&gt; {
              ActorSystem&lt;Void&gt; system = context.getSystem();

              CassandraSession session =
                  CassandraSessionRegistry.get(system)
                      .sessionFor(&quot;akka.projection.cassandra.session-config&quot;);
              ItemPopularityProjectionRepositoryImpl repo =
                  new ItemPopularityProjectionRepositoryImpl(session);

              ShardedDaemonProcess.get(system)
                  .init(
                      ProjectionBehavior.Command.class,
                      &quot;shopping-carts&quot;,
                      ShoppingCartTags.TAGS.length,
                      n -&gt;
                          ProjectionBehavior.create(
                              projection(system, repo, ShoppingCartTags.TAGS[n])),
                      ProjectionBehavior.stopMessage());

              return Behaviors.empty();
            }),
        &quot;ShoppingCartClusterApp&quot;,
        config);
  }

  static SourceProvider&lt;Offset, EventEnvelope&lt;ShoppingCartEvents.Event&gt;&gt; sourceProvider(
      ActorSystem&lt;?&gt; system, String tag) {
    return EventSourcedProvider.eventsByTag(system, CassandraReadJournal.Identifier(), tag);
  }

  static AtLeastOnceProjection&lt;Offset, EventEnvelope&lt;ShoppingCartEvents.Event&gt;&gt; projection(
      ActorSystem&lt;?&gt; system, ItemPopularityProjectionRepository repo, String tag) {
    return CassandraProjection.atLeastOnce(
        ProjectionId.of(&quot;shopping-carts&quot;, tag),
        sourceProvider(system, tag),
        () -&gt; new ItemPopularityProjectionHandler(tag, system, repo));
  }
}</code></pre></dd>
</dl>
<p>Before running the app we must first run the <code>EventGeneratorApp</code> in <code>cluster</code> mode in order to generate new shopping cart events for multiple tags, instead of just one. Shopping cart events are tagged in a similar way to the sharded entities themselves. Given a sequence of tags from <code>0..n</code> a hash is generated using the sharding entity key, the shopping cart id. The hash is modded <code>%</code> by the number of tags in the sequence to choose a tag from the sequence. See the <a href="../running.html#tagging-events-in-eventsourcedbehavior">Tagging Events in EventSourcedBehavior</a> section of the documentation for an example of how events can be tagged with Akka Persistence.</p>
<p>The same <code>EventGeneratorApp</code> from the previous <a href="running.html">Running the Projection</a> section can be used to generate events for this app with an additional argument <code>cluster</code>. Run the app:</p>
<!-- run from repo:
sbt "examples/test:runMain docs.guide.EventGeneratorApp cluster"
sbt "examples/test:runMain jdocs.guide.EventGeneratorApp cluster"
-->
<dl>
  <dt>sbt</dt>
  <dd>
  <pre><code>sbt &quot;runMain docs.guide.EventGeneratorApp cluster&quot;
</code></pre></dd>
  <dt>Maven</dt>
  <dd>
  <pre><code>mvn compile exec:java -Dexec.mainClass=&quot;jdocs.guide.EventGeneratorApp&quot; -Dexec.args=&quot;cluster&quot;
</code></pre></dd>
</dl>
<p>When the app is running you will observe that the logs show events written to different tags (<code>carts-0</code>, <code>carts-1</code>, etc.), instead of just one (<code>shopping-cart</code>).</p>
<pre><code>[2020-08-13 15:18:58,383] [INFO] [docs.guide.EventGeneratorApp$] [] [EventGenerator-akka.actor.default-dispatcher-19] - id [6059e] tag [carts-1] event: ItemQuantityAdjusted(6059e,cat t-shirt,1,2) MDC: {persistencePhase=persist-evt, akkaAddress=akka://EventGenerator@127.0.1.1:25520, akkaSource=akka://EventGenerator/system/sharding/shopping-cart-event/903/6059e, sourceActorSystem=EventGenerator, persistenceId=6059e}
</code></pre>
<p>Run the first member of your new Akka cluster:</p>
<!-- run from repo:
sbt "examples/test:runMain docs.guide.ShoppingCartClusterApp 2551"
sbt "examples/test:runMain jdocs.guide.ShoppingCartClusterApp 2551"
-->
<dl>
  <dt>sbt</dt>
  <dd>
  <pre><code>sbt &quot;runMain docs.guide.ShoppingCartClusterApp 2551
</code></pre></dd>
  <dt>Maven</dt>
  <dd>
  <pre><code>mvn compile exec:java -Dexec.mainClass=&quot;jdocs.guide.ShoppingCartClusterApp&quot; -Dexec.args=&quot;2551&quot;
</code></pre></dd>
</dl>
<p>When the app is running you will observe that it will process all the shopping cart event tags, because it&rsquo;s the only member of the cluster.</p>
<pre><code>[2020-08-13 15:03:39,809] [INFO] [docs.guide.ItemPopularityProjectionHandler] [] [ShoppingCartClusterApp-akka.actor.default-dispatcher-43] - ItemPopularityProjectionHandler(carts-1) item popularity for &#39;akka t-shirt&#39;: [1080] MDC: {}   
[2020-08-13 15:03:39,810] [INFO] [docs.guide.ItemPopularityProjectionHandler] [] [ShoppingCartClusterApp-akka.actor.default-dispatcher-40] - ItemPopularityProjectionHandler(carts-2) item popularity for &#39;bowling shoes&#39;: [1241] MDC: {}  
[2020-08-13 15:03:39,812] [INFO] [docs.guide.ItemPopularityProjectionHandler] [] [ShoppingCartClusterApp-akka.actor.default-dispatcher-43] - ItemPopularityProjectionHandler(carts-0) item popularity for &#39;akka t-shirt&#39;: [1080] MDC: {}
...
</code></pre>
<p>Run a second member to expand the Akka cluster member count to 2.</p>
<!-- run from repo:
sbt "examples/test:runMain docs.guide.ShoppingCartClusterApp 2552"
sbt "examples/test:runMain jdocs.guide.ShoppingCartClusterApp 2552"
-->
<dl>
  <dt>sbt</dt>
  <dd>
  <pre><code>sbt &quot;runMain docs.guide.ShoppingCartClusterApp 2552
</code></pre></dd>
  <dt>Maven</dt>
  <dd>
  <pre><code>mvn compile exec:java -Dexec.mainClass=&quot;jdocs.guide.ShoppingCartClusterApp&quot; -Dexec.args=&quot;2552&quot;
</code></pre></dd>
</dl>
<p>When the second app is running you will observe a sharding rebalance complete and then see a distinct set of tagged events processed on each cluster member.</p>
<p>A rebalance occurs and tag <code>carts-0</code> is assigned to the new cluster member. Only tags <code>carts-1</code> and <code>carts-2</code> are processed by the first member.</p>
<pre><code>[2020-08-13 15:03:59,019] [INFO] [akka.cluster.sharding.DDataShardCoordinator] [] [ShoppingCartClusterApp-akka.actor.default-dispatcher-41] - Starting rebalance for shards [0]. Current shards rebalancing: [] MDC: {akkaAddress=akka://ShoppingCa
rtClusterApp@127.0.0.1:2551, sourceThread=ShoppingCartClusterApp-akka.actor.default-dispatcher-44, akkaSource=akka://ShoppingCartClusterApp@127.0.0.1:2551/system/sharding/sharded-daemon-process-shopping-cartsCoordinator/singleton/coordinator, 
sourceActorSystem=ShoppingCartClusterApp, akkaTimestamp=19:03:59.019UTC}                                                                                                                                                                           
[2020-08-13 15:04:35,261] [INFO] [docs.guide.ItemPopularityProjectionHandler] [] [ShoppingCartClusterApp-akka.actor.default-dispatcher-43] - ItemPopularityProjectionHandler(carts-1) item popularity for &#39;skis&#39;: [1244] MDC: {}           
[2020-08-13 15:04:36,802] [INFO] [docs.guide.ItemPopularityProjectionHandler] [] [ShoppingCartClusterApp-akka.actor.default-dispatcher-40] - ItemPopularityProjectionHandler(carts-2) item popularity for &#39;skis&#39;: [1246] MDC: {}           
[2020-08-13 15:04:36,805] [INFO] [docs.guide.ItemPopularityProjectionHandler] [] [ShoppingCartClusterApp-akka.actor.default-dispatcher-40] - ItemPopularityProjectionHandler(carts-2) item popularity for &#39;akka t-shirt&#39;: [1136] MDC: {}   
[2020-08-13 15:04:36,807] [INFO] [docs.guide.ItemPopularityProjectionHandler] [] [ShoppingCartClusterApp-akka.actor.default-dispatcher-43] - ItemPopularityProjectionHandler(carts-2) item popularity for &#39;skis&#39;: [1249] MDC: {}           
[2020-08-13 15:04:39,262] [INFO] [docs.guide.ItemPopularityProjectionHandler] [] [ShoppingCartClusterApp-akka.actor.default-dispatcher-41] - ItemPopularityProjectionHandler(carts-1) item popularity for &#39;cat t-shirt&#39;: [1239] MDC: {}                  
...
</code></pre>
<p>When the second member joins the cluster it is assigned tag <code>carts-0</code> and begins processing events beginning from the last successfully processed offset.</p>
<pre><code>[2020-08-13 15:04:02,692] [INFO] [docs.guide.ItemPopularityProjectionHandler] [] [ShoppingCartClusterApp-akka.actor.default-dispatcher-5] - ItemPopularityProjectionHandler(carts-0) item popularity for &#39;bowling shoes&#39;: [1275] MDC: {}   
[2020-08-13 15:04:02,695] [INFO] [docs.guide.ItemPopularityProjectionHandler] [] [ShoppingCartClusterApp-akka.actor.default-dispatcher-40] - ItemPopularityProjectionHandler(carts-0) item popularity for &#39;akka t-shirt&#39;: [1110] MDC: {}   
[2020-08-13 15:04:02,699] [INFO] [docs.guide.ItemPopularityProjectionHandler] [] [ShoppingCartClusterApp-akka.actor.default-dispatcher-40] - ItemPopularityProjectionHandler(carts-0) item popularity for &#39;cat t-shirt&#39;: [1203] MDC: {}
...
</code></pre>
</div>
</article>
<div class="row">
<div class="small-12 column">
<section class="nav-prev-next row">
<div class="nav-prev small-6 column">
<a href="../getting-started/running.html"><i class="icon-prev"></i> <span class="link-prev">Running the Projection</span></a>
</div>
<div class="nav-next small-6 column clearfix">
<a class="float-right" href="../eventsourced.html">Events from Akka Persistence <i class="icon-next"></i></a>
</div>
</section>
</div>
</div>
<div class="source-github row">
Found an error in this documentation? The source code for this page can be found <a href="https://github.com/akka/akka-projection/tree/master/docs/src/main/paradox/getting-started/running-cluster.md">here</a>.
Please feel free to edit and contribute a pull request.
</div>

<footer class="page-footer row clearfix">
<img class="akka-icon float-left show-for-medium" src="../images/akka-icon.svg" />
<section class="copyright">
<div>Akka Projections is Open Source and available under the Apache 2 License.</div>
<p class="legal">
&copy; 2011-2022 <a href="https://www.lightbend.com" target="_blank">Lightbend, Inc.</a> |
<a href="https://www.lightbend.com/legal/licenses" target="_blank">Licenses</a> |
<a href="https://www.lightbend.com/legal/terms" target="_blank">Terms</a> |
<a href="https://www.lightbend.com/legal/privacy" target="_blank">Privacy Policy</a> |
<a href="https://akka.io/cookie/" target="_blank">Cookie Listing</a> |
<a class="optanon-toggle-display">Cookie Settings</a>
</p>
</section>

</footer>
</section>
</main>
</div>

<script type="text/javascript" src="../js/scrollsneak.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../js/groups.js"></script>
<script type="text/javascript" src="../js/page.js"></script>
<script type="text/javascript" src="../js/snippets.js"></script>
<script type="text/javascript" src="../js/magellan.js"></script>
<script type="text/javascript" src="../js/metadata-toggle.js"></script>
<script type="text/javascript" src="../js/lbHeader.js"></script>

<style type="text/css">@import "../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(){window.prettyPrint && prettyPrint()});
//]]></script>
<script type="text/javascript" src="../assets/js/warnOldVersion.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(jq){initOldVersionWarnings(jq, '1.2.4', 'https://doc.akka.io/docs/akka-projection/current/')});
//]]></script>


</body>
</html>
