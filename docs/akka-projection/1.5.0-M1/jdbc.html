<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Offset in a relational DB with JDBC &bull; Akka Projection</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="Akka Projection."/>
<link rel="canonical" href="https://doc.akka.io/docs/akka-projection/current/jdbc.html"/>
<script type="text/javascript" src="lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="lib/foundation/dist/js/foundation.min.js"></script>
<link rel="stylesheet" type="text/css" href="lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="lib/foundation/dist/css/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" type="text/css" href="css/icons.css"/>
<link rel="stylesheet" type="text/css" href="css/page-8.css"/>
<link rel="stylesheet" type="text/css" href="css/banner-2.css"/>
<link rel="shortcut icon" href="images/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png"/>
<link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png"/>
<link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png"/>
<link rel="manifest" href="images/manifest.json"/>
<meta name="msapplication-TileImage" content="images/mstile-150x150.png"/>
<meta name="msapplication-TileColor" content="#15a9ce"/>
<meta name="theme-color" content="#15a9ce"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) start -->
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js"  type="text/javascript" charset="UTF-8" data-domain-script="28b912e7-09e9-43d5-91e4-3d1897044004" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) end -->
<!--Google Analytics NOTE this will stop processing data July 1st 2023. At which point this embed code can be removed-->
<script type="text/plain" class="optanon-category-2">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', '']);
_gaq.push(['_setDomainName', '']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})()
</script>

<!-- Google Tag Manager: Updated May 17th 2023 - Cookie Compliance checks have been moved into Google Tag Manager -->
<script type="text/javascript">
(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KBJGH35');
</script>

</head>

<body id="underlay" data-toggler="nav-open">
<div id="lightbend-banner" class="lightbend-banner akka full-width" data-category="OSS Lightbend Banner Impression" data-label="Akka Banner Impression">
<div class="oss-wrapper">
<div class="oss-brand">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lightbend Logo - Akka Banner" href="https://www.lightbend.com">
<img class="lightbend-logo" src="images/banner-logos/lightbend-reverse.svg" alt="Lightbend" title="Lightbend">
</a>
</div>
<div class="oss-ad no-drop-down">
<nav id="lightbendRotator" class="lightbend-rotator">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Promo Rotator - Lightbend Changed its Software Licensing Model for Akka Technology. [License FAQ] - Akka Banner" href="https://www.lightbend.com/akka/license-faq">
<strong>Lightbend</strong> Changed its Software Licensing Model for Akka Technology. <span class="akka-btn">License FAQ</span>
</a>
</nav>
</div>
</div>
</div>

<header class="site-header hide-for-large">
<div class="sticky-header clearfix">
<a href="https://akka.io"><img class="logo" src="images/akka-logo-reverse.svg"/></a>

<button class="menu-icon float-right" type="button" data-toggle="underlay overlay"></button>
</div>
<div id="overlay" class="overlay-nav" data-toggler="nav-open">
<header class="nav-header">
<div class="nav-header-title">
<h1><a href="index.html">Akka Projection</a></h1>
</div>
<div class="nav-header-version">
Version 1.5.0-M1
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="nav-toc">
<ul>
  <li><a href="overview.html" class="page">Overview</a></li>
  <li><a href="use-cases.html" class="page">Use Cases</a></li>
  <li><a href="getting-started/index.html" class="page">Getting Started Guide</a></li>
  <li><a href="eventsourced.html" class="page">Events from Akka Persistence</a></li>
  <li><a href="durable-state.html" class="page">Changes from Durable State</a></li>
  <li><a href="kafka.html" class="page">Messages from and to Kafka</a></li>
  <li><a href="r2dbc.html" class="page">Offset in a relational DB with R2DBC</a></li>
  <li><a href="cassandra.html" class="page">Offset in Cassandra</a></li>
  <li><a href="jdbc.html#offset-in-a-relational-db-with-jdbc" class="active page">Offset in a relational DB with JDBC</a>
  <ul>
    <li><a href="jdbc.html#dependencies" class="header">Dependencies</a></li>
    <li><a href="jdbc.html#required-configuration-settings" class="header">Required configuration settings</a></li>
    <li><a href="jdbc.html#defining-a-jdbcsession" class="header">Defining a JdbcSession</a></li>
    <li><a href="jdbc.html#blocking-jdbc-dispatcher" class="header">Blocking JDBC Dispatcher</a></li>
    <li><a href="jdbc.html#exactly-once" class="header">exactly-once</a></li>
    <li><a href="jdbc.html#at-least-once" class="header">at-least-once</a></li>
    <li><a href="jdbc.html#groupedwithin" class="header">groupedWithin</a></li>
    <li><a href="jdbc.html#handler" class="header">Handler</a></li>
    <li><a href="jdbc.html#schema" class="header">Schema</a></li>
    <li><a href="jdbc.html#offset-types" class="header">Offset types</a></li>
    <li><a href="jdbc.html#configuration" class="header">Configuration</a></li>
  </ul></li>
  <li><a href="slick.html" class="page">Offset in a relational DB with Slick</a></li>
  <li><a href="running.html" class="page">Running a Projection</a></li>
  <li><a href="actor.html" class="page">Processing with Actor</a></li>
  <li><a href="flow.html" class="page">Processing with Akka Streams</a></li>
  <li><a href="error.html" class="page">Error handling</a></li>
  <li><a href="projection-settings.html" class="page">Projection Settings</a></li>
  <li><a href="grpc.html" class="page">Akka Projection gRPC</a></li>
  <li><a href="grpc-replicated-event-sourcing-transport.html" class="page">Akka Replicated Event Sourcing over gRPC</a></li>
  <li><a href="management.html" class="page">Management of a Projection</a></li>
  <li><a href="testing.html" class="page">Testing</a></li>
  <li><a href="classic.html" class="page">Akka Classic</a></li>
  <li><a href="snapshots.html" class="page">Snapshots</a></li>
</ul>
</nav>
</div>
</header>
<div class="site-content-wrapper">
<aside class="sticky-sidebar show-for-large">
<header class="nav-header sticky-sidebar-header">
<div class="nav-header-title">
<h1><a href="index.html">Akka Projection</a></h1>
</div>
<div class="nav-header-version">
Version 1.5.0-M1
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="site-nav sticky-sidebar-contents">
<div class="nav-toc">
<ul>
  <li><a href="overview.html" class="page">Overview</a></li>
  <li><a href="use-cases.html" class="page">Use Cases</a></li>
  <li><a href="getting-started/index.html" class="page">Getting Started Guide</a></li>
  <li><a href="eventsourced.html" class="page">Events from Akka Persistence</a></li>
  <li><a href="durable-state.html" class="page">Changes from Durable State</a></li>
  <li><a href="kafka.html" class="page">Messages from and to Kafka</a></li>
  <li><a href="r2dbc.html" class="page">Offset in a relational DB with R2DBC</a></li>
  <li><a href="cassandra.html" class="page">Offset in Cassandra</a></li>
  <li><a href="jdbc.html#offset-in-a-relational-db-with-jdbc" class="active page">Offset in a relational DB with JDBC</a>
  <ul>
    <li><a href="jdbc.html#dependencies" class="header">Dependencies</a></li>
    <li><a href="jdbc.html#required-configuration-settings" class="header">Required configuration settings</a></li>
    <li><a href="jdbc.html#defining-a-jdbcsession" class="header">Defining a JdbcSession</a></li>
    <li><a href="jdbc.html#blocking-jdbc-dispatcher" class="header">Blocking JDBC Dispatcher</a></li>
    <li><a href="jdbc.html#exactly-once" class="header">exactly-once</a></li>
    <li><a href="jdbc.html#at-least-once" class="header">at-least-once</a></li>
    <li><a href="jdbc.html#groupedwithin" class="header">groupedWithin</a></li>
    <li><a href="jdbc.html#handler" class="header">Handler</a></li>
    <li><a href="jdbc.html#schema" class="header">Schema</a></li>
    <li><a href="jdbc.html#offset-types" class="header">Offset types</a></li>
    <li><a href="jdbc.html#configuration" class="header">Configuration</a></li>
  </ul></li>
  <li><a href="slick.html" class="page">Offset in a relational DB with Slick</a></li>
  <li><a href="running.html" class="page">Running a Projection</a></li>
  <li><a href="actor.html" class="page">Processing with Actor</a></li>
  <li><a href="flow.html" class="page">Processing with Akka Streams</a></li>
  <li><a href="error.html" class="page">Error handling</a></li>
  <li><a href="projection-settings.html" class="page">Projection Settings</a></li>
  <li><a href="grpc.html" class="page">Akka Projection gRPC</a></li>
  <li><a href="grpc-replicated-event-sourcing-transport.html" class="page">Akka Replicated Event Sourcing over gRPC</a></li>
  <li><a href="management.html" class="page">Management of a Projection</a></li>
  <li><a href="testing.html" class="page">Testing</a></li>
  <li><a href="classic.html" class="page">Akka Classic</a></li>
  <li><a href="snapshots.html" class="page">Snapshots</a></li>
</ul>
</div>
</nav>
<footer class="nav-footer sticky-sidebar-footer">
<a href="https://akka.io"><img class="logo" src="images/akka-logo-reverse.svg"/></a>

</footer>
</aside>
<main class="fixed-shift-for-large expanded row">
<section class="site-content small-12 column">
<article class="page-content row">
<div class="small-12 column" id="docs">
<h1><a href="#offset-in-a-relational-db-with-jdbc" name="offset-in-a-relational-db-with-jdbc" class="anchor"><span class="anchor-link"></span></a>Offset in a relational DB with JDBC</h1>
<p>The <span class="group-java"><a href="/api/akka-projection/1.5.0-M1/akka/projection/jdbc/javadsl/JdbcProjection$.html" title="akka.projection.jdbc.javadsl.JdbcProjection"><code>JdbcProjection</code></a></span><span class="group-scala"><a href="/api/akka-projection/1.5.0-M1/akka/projection/jdbc/scaladsl/JdbcProjection$.html" title="akka.projection.jdbc.scaladsl.JdbcProjection"><code>JdbcProjection</code></a></span> has support for storing the offset in a relational database using JDBC.</p>
<p>The source of the envelopes can be <a href="eventsourced.html">events from Akka Persistence</a> or any other <code>SourceProvider</code> with supported <a href="jdbc.html#offset-types">offset types</a>.</p>
<p>A <span class="group-java"><a href="/api/akka-projection/1.5.0-M1/akka/projection/jdbc/javadsl/JdbcHandler.html" title="akka.projection.jdbc.javadsl.JdbcHandler"><code>JdbcHandler</code></a></span><span class="group-scala"><a href="/api/akka-projection/1.5.0-M1/akka/projection/jdbc/scaladsl/JdbcHandler.html" title="akka.projection.jdbc.scaladsl.JdbcHandler"><code>JdbcHandler</code></a></span> receives a <span class="group-scala"><a href="/api/akka-projection/1.5.0-M1/akka/projection/jdbc/JdbcSession.html" title="akka.projection.jdbc.JdbcSession"><code>JdbcSession</code></a></span><span class="group-java"><a href="/api/akka-projection/1.5.0-M1/akka/projection/jdbc/JdbcSession.html" title="akka.projection.jdbc.JdbcSession"><code>JdbcSession</code></a></span> instance and an envelope. The <code>JdbcSession</code> provides the means to access an open JDBC connection that can be used to process the envelope. The target database operations can be run in the same transaction as the storage of the offset, which means that <a href="jdbc.html#exactly-once">exactly-once</a> processing semantics is supported. It also offers <a href="jdbc.html#at-least-once">at-least-once</a> semantics.</p>
<h2><a href="#dependencies" name="dependencies" class="anchor"><span class="anchor-link"></span></a>Dependencies</h2>
<p>To use the JDBC module of Akka Projections add the following dependency in your project:</p><dl class="dependency"><dt>sbt</dt><dd><pre class="prettyprint"><code class="language-scala">libraryDependencies += "com.lightbend.akka" %% "akka-projection-jdbc" % "1.5.0-M1"</code></pre></dd><dt>Maven</dt><dd><pre class="prettyprint"><code class="language-xml">&lt;properties&gt;
  &lt;scala.binary.version&gt;2.13&lt;/scala.binary.version&gt;
&lt;/properties&gt;
&lt;dependencies&gt
  &lt;dependency&gt;
    &lt;groupId&gt;com.lightbend.akka&lt;/groupId&gt;
    &lt;artifactId&gt;akka-projection-jdbc_${scala.binary.version}&lt;/artifactId&gt;
    &lt;version&gt;1.5.0-M1&lt;/version&gt;
  &lt;/dependency&gt
&lt;/dependencies&gt;</code></pre></dd><dt>Gradle</dt><dd><pre class="prettyprint"><code class="language-gradle">def versions = [
  ScalaBinary: "2.13"
]
dependencies {
  implementation "com.lightbend.akka:akka-projection-jdbc_${versions.ScalaBinary}:1.5.0-M1"
}</code></pre></dd></dl>
<p>Akka Projections require Akka 2.8.3 or later, see <a href="overview.html#akka-version">Akka version</a>.</p>
<table class="project-info">
<tr><th colspan="2">Project Info: Akka Projections JDBC</th></tr>
  <tr><th>Artifact</th><td><div>com.lightbend.akka</div>
  <div>akka-projection-jdbc</div>
  <div>1.5.0-M1</div>
  <div><a href="snapshots.html">Snapshots are available</a></div>
  </td></tr>
  <tr><th>JDK versions</th><td><div>AdoptOpenJDK 8</div><div>AdoptOpenJDK 11</div></td></tr>
  <tr><th>Scala versions</th><td>2.13.11, 2.12.18, 3.2.2</td></tr>
  <tr><th>JPMS module name</th><td>akka.projection.jdbc</td></tr>
  <tr><th>License</th><td><div><a href="https://raw.githubusercontent.com/akka/akka-projection/main/LICENSE" target="_blank" rel="noopener noreferrer">BUSL-1.1</a></div>
  </td></tr>
  <tr><th>Readiness level</th><td><div class="readiness-level"><a href="https://developer.lightbend.com/docs/introduction/getting-help/support-terminology.html#supported" target="_blank" rel="noopener">Supported</a>, <a href="https://www.lightbend.com/lightbend-subscription" target="_blank" rel="noopener">Lightbend Subscription</a> provides support</div>
  <div>Since 1.0.0, 2020-09-10</div>
  </td></tr>
  <tr><th>Home page</th><td><a href="https://akka.io">https://akka.io</a></td></tr>
  <tr><th>API documentation</th><td>
  <div><a href="https://doc.akka.io/api/akka-projection/1.5.0-M1/akka/projection/" target="_blank" rel="noopener noreferrer">API (Scaladoc)</a></div>
  </td></tr>
  <tr><th>Forums</th><td>
  <div><a href="https://discuss.lightbend.com/c/akka/" target="_blank" rel="noopener noreferrer">Lightbend Discuss</a></div>
  <div><a href="https://gitter.im/akka/akka" target="_blank" rel="noopener noreferrer">akka/akka Gitter channel</a></div>
  </td></tr>
  <tr><th>Release notes</th><td><a href="https://github.com/akka/akka-projection/releases" target="_blank" rel="noopener noreferrer">GitHub releases</a></td></tr>
  <tr><th>Issues</th><td><a href="https://github.com/akka/akka-projection/issues" target="_blank" rel="noopener noreferrer">GitHub issues</a></td></tr>
  <tr><th>Sources</th><td><a href="https://github.com/akka/akka-projection" target="_blank" rel="noopener noreferrer">https://github.com/akka/akka-projection</a></td></tr>
</table>

<h3><a href="#transitive-dependencies" name="transitive-dependencies" class="anchor"><span class="anchor-link"></span></a>Transitive dependencies</h3>

<p>The table below shows <code>akka-projection-jdbc</code>&rsquo;s direct dependencies, and the second tab shows all libraries it depends on transitively.</p>

<dl class="dependencies"><dt>Direct dependencies</dt><dd><table>
  <thead><tr><th>Organization</th><th>Artifact</th><th>Version</th></thead>
  <tbody>
    <tr><td>com.lightbend.akka</td><td>akka-projection-core_2.13</td><td><a href="https://mvnrepository.com/artifact/com.lightbend.akka/akka-projection-core_2.13/1.5.0-M1" target="_blank">1.5.0-M1</a></td></tr>
    <tr><td>com.typesafe.akka</td><td>akka-persistence-query_2.13</td><td><a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-persistence-query_2.13/2.8.3" target="_blank">2.8.3</a></td></tr>
    <tr><td>org.scala-lang</td><td>scala-library</td><td><a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.11" target="_blank">2.13.11</a></td></tr>
  </tbody>
</table></dd>
<dt>Dependency tree</dt><dd><pre>
com.lightbend.akka    akka-projection-core_2.13    <a href="https://mvnrepository.com/artifact/com.lightbend.akka/akka-projection-core_2.13/1.5.0-M1" target="_blank">1.5.0-M1</a>
    com.typesafe.akka    akka-actor-typed_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-actor-typed_2.13/2.8.3" target="_blank">2.8.3</a>    BUSL-1.1
        com.typesafe.akka    akka-actor_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-actor_2.13/2.8.3" target="_blank">2.8.3</a>    BUSL-1.1
            com.typesafe    config    <a href="https://mvnrepository.com/artifact/com.typesafe/config/1.4.2" target="_blank">1.4.2</a>    Apache-2.0
            org.scala-lang.modules    scala-java8-compat_2.13    <a href="https://mvnrepository.com/artifact/org.scala-lang.modules/scala-java8-compat_2.13/1.0.0" target="_blank">1.0.0</a>    Apache-2.0
                org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.11" target="_blank">2.13.11</a>    Apache-2.0
            org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.11" target="_blank">2.13.11</a>    Apache-2.0
        com.typesafe.akka    akka-slf4j_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-slf4j_2.13/2.8.3" target="_blank">2.8.3</a>    BUSL-1.1
            com.typesafe.akka    akka-actor_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-actor_2.13/2.8.3" target="_blank">2.8.3</a>    BUSL-1.1
                com.typesafe    config    <a href="https://mvnrepository.com/artifact/com.typesafe/config/1.4.2" target="_blank">1.4.2</a>    Apache-2.0
                org.scala-lang.modules    scala-java8-compat_2.13    <a href="https://mvnrepository.com/artifact/org.scala-lang.modules/scala-java8-compat_2.13/1.0.0" target="_blank">1.0.0</a>    Apache-2.0
                    org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.11" target="_blank">2.13.11</a>    Apache-2.0
                org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.11" target="_blank">2.13.11</a>    Apache-2.0
            org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.11" target="_blank">2.13.11</a>    Apache-2.0
            org.slf4j    slf4j-api    <a href="https://mvnrepository.com/artifact/org.slf4j/slf4j-api/1.7.36" target="_blank">1.7.36</a>
        org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.11" target="_blank">2.13.11</a>    Apache-2.0
        org.slf4j    slf4j-api    <a href="https://mvnrepository.com/artifact/org.slf4j/slf4j-api/1.7.36" target="_blank">1.7.36</a>
    com.typesafe.akka    akka-persistence-query_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-persistence-query_2.13/2.8.3" target="_blank">2.8.3</a>    BUSL-1.1
        com.typesafe.akka    akka-persistence_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-persistence_2.13/2.8.3" target="_blank">2.8.3</a>    BUSL-1.1
            com.typesafe.akka    akka-actor_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-actor_2.13/2.8.3" target="_blank">2.8.3</a>    BUSL-1.1
                com.typesafe    config    <a href="https://mvnrepository.com/artifact/com.typesafe/config/1.4.2" target="_blank">1.4.2</a>    Apache-2.0
                org.scala-lang.modules    scala-java8-compat_2.13    <a href="https://mvnrepository.com/artifact/org.scala-lang.modules/scala-java8-compat_2.13/1.0.0" target="_blank">1.0.0</a>    Apache-2.0
                    org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.11" target="_blank">2.13.11</a>    Apache-2.0
                org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.11" target="_blank">2.13.11</a>    Apache-2.0
            com.typesafe.akka    akka-stream_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-stream_2.13/2.8.3" target="_blank">2.8.3</a>    BUSL-1.1
                com.typesafe.akka    akka-actor_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-actor_2.13/2.8.3" target="_blank">2.8.3</a>    BUSL-1.1
                    com.typesafe    config    <a href="https://mvnrepository.com/artifact/com.typesafe/config/1.4.2" target="_blank">1.4.2</a>    Apache-2.0
                    org.scala-lang.modules    scala-java8-compat_2.13    <a href="https://mvnrepository.com/artifact/org.scala-lang.modules/scala-java8-compat_2.13/1.0.0" target="_blank">1.0.0</a>    Apache-2.0
                        org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.11" target="_blank">2.13.11</a>    Apache-2.0
                    org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.11" target="_blank">2.13.11</a>    Apache-2.0
                com.typesafe.akka    akka-protobuf-v3_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-protobuf-v3_2.13/2.8.3" target="_blank">2.8.3</a>    BUSL-1.1
                com.typesafe    ssl-config-core_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe/ssl-config-core_2.13/0.6.1" target="_blank">0.6.1</a>    Apache-2.0
                    com.typesafe    config    <a href="https://mvnrepository.com/artifact/com.typesafe/config/1.4.2" target="_blank">1.4.2</a>    Apache-2.0
                    org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.11" target="_blank">2.13.11</a>    Apache-2.0
                org.reactivestreams    reactive-streams    <a href="https://mvnrepository.com/artifact/org.reactivestreams/reactive-streams/1.0.4" target="_blank">1.0.4</a>    MIT-0
                org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.11" target="_blank">2.13.11</a>    Apache-2.0
            org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.11" target="_blank">2.13.11</a>    Apache-2.0
        com.typesafe.akka    akka-protobuf-v3_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-protobuf-v3_2.13/2.8.3" target="_blank">2.8.3</a>    BUSL-1.1
        com.typesafe.akka    akka-stream_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-stream_2.13/2.8.3" target="_blank">2.8.3</a>    BUSL-1.1
            com.typesafe.akka    akka-actor_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-actor_2.13/2.8.3" target="_blank">2.8.3</a>    BUSL-1.1
                com.typesafe    config    <a href="https://mvnrepository.com/artifact/com.typesafe/config/1.4.2" target="_blank">1.4.2</a>    Apache-2.0
                org.scala-lang.modules    scala-java8-compat_2.13    <a href="https://mvnrepository.com/artifact/org.scala-lang.modules/scala-java8-compat_2.13/1.0.0" target="_blank">1.0.0</a>    Apache-2.0
                    org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.11" target="_blank">2.13.11</a>    Apache-2.0
                org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.11" target="_blank">2.13.11</a>    Apache-2.0
            com.typesafe.akka    akka-protobuf-v3_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-protobuf-v3_2.13/2.8.3" target="_blank">2.8.3</a>    BUSL-1.1
            com.typesafe    ssl-config-core_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe/ssl-config-core_2.13/0.6.1" target="_blank">0.6.1</a>    Apache-2.0
                com.typesafe    config    <a href="https://mvnrepository.com/artifact/com.typesafe/config/1.4.2" target="_blank">1.4.2</a>    Apache-2.0
                org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.11" target="_blank">2.13.11</a>    Apache-2.0
            org.reactivestreams    reactive-streams    <a href="https://mvnrepository.com/artifact/org.reactivestreams/reactive-streams/1.0.4" target="_blank">1.0.4</a>    MIT-0
            org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.11" target="_blank">2.13.11</a>    Apache-2.0
        org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.11" target="_blank">2.13.11</a>    Apache-2.0
    com.typesafe.akka    akka-protobuf-v3_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-protobuf-v3_2.13/2.8.3" target="_blank">2.8.3</a>    BUSL-1.1
    com.typesafe.akka    akka-stream_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-stream_2.13/2.8.3" target="_blank">2.8.3</a>    BUSL-1.1
        com.typesafe.akka    akka-actor_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-actor_2.13/2.8.3" target="_blank">2.8.3</a>    BUSL-1.1
            com.typesafe    config    <a href="https://mvnrepository.com/artifact/com.typesafe/config/1.4.2" target="_blank">1.4.2</a>    Apache-2.0
            org.scala-lang.modules    scala-java8-compat_2.13    <a href="https://mvnrepository.com/artifact/org.scala-lang.modules/scala-java8-compat_2.13/1.0.0" target="_blank">1.0.0</a>    Apache-2.0
                org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.11" target="_blank">2.13.11</a>    Apache-2.0
            org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.11" target="_blank">2.13.11</a>    Apache-2.0
        com.typesafe.akka    akka-protobuf-v3_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-protobuf-v3_2.13/2.8.3" target="_blank">2.8.3</a>    BUSL-1.1
        com.typesafe    ssl-config-core_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe/ssl-config-core_2.13/0.6.1" target="_blank">0.6.1</a>    Apache-2.0
            com.typesafe    config    <a href="https://mvnrepository.com/artifact/com.typesafe/config/1.4.2" target="_blank">1.4.2</a>    Apache-2.0
            org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.11" target="_blank">2.13.11</a>    Apache-2.0
        org.reactivestreams    reactive-streams    <a href="https://mvnrepository.com/artifact/org.reactivestreams/reactive-streams/1.0.4" target="_blank">1.0.4</a>    MIT-0
        org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.11" target="_blank">2.13.11</a>    Apache-2.0
    org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.11" target="_blank">2.13.11</a>    Apache-2.0
com.typesafe.akka    akka-persistence-query_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-persistence-query_2.13/2.8.3" target="_blank">2.8.3</a>    BUSL-1.1
    com.typesafe.akka    akka-persistence_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-persistence_2.13/2.8.3" target="_blank">2.8.3</a>    BUSL-1.1
        com.typesafe.akka    akka-actor_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-actor_2.13/2.8.3" target="_blank">2.8.3</a>    BUSL-1.1
            com.typesafe    config    <a href="https://mvnrepository.com/artifact/com.typesafe/config/1.4.2" target="_blank">1.4.2</a>    Apache-2.0
            org.scala-lang.modules    scala-java8-compat_2.13    <a href="https://mvnrepository.com/artifact/org.scala-lang.modules/scala-java8-compat_2.13/1.0.0" target="_blank">1.0.0</a>    Apache-2.0
                org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.11" target="_blank">2.13.11</a>    Apache-2.0
            org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.11" target="_blank">2.13.11</a>    Apache-2.0
        com.typesafe.akka    akka-stream_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-stream_2.13/2.8.3" target="_blank">2.8.3</a>    BUSL-1.1
            com.typesafe.akka    akka-actor_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-actor_2.13/2.8.3" target="_blank">2.8.3</a>    BUSL-1.1
                com.typesafe    config    <a href="https://mvnrepository.com/artifact/com.typesafe/config/1.4.2" target="_blank">1.4.2</a>    Apache-2.0
                org.scala-lang.modules    scala-java8-compat_2.13    <a href="https://mvnrepository.com/artifact/org.scala-lang.modules/scala-java8-compat_2.13/1.0.0" target="_blank">1.0.0</a>    Apache-2.0
                    org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.11" target="_blank">2.13.11</a>    Apache-2.0
                org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.11" target="_blank">2.13.11</a>    Apache-2.0
            com.typesafe.akka    akka-protobuf-v3_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-protobuf-v3_2.13/2.8.3" target="_blank">2.8.3</a>    BUSL-1.1
            com.typesafe    ssl-config-core_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe/ssl-config-core_2.13/0.6.1" target="_blank">0.6.1</a>    Apache-2.0
                com.typesafe    config    <a href="https://mvnrepository.com/artifact/com.typesafe/config/1.4.2" target="_blank">1.4.2</a>    Apache-2.0
                org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.11" target="_blank">2.13.11</a>    Apache-2.0
            org.reactivestreams    reactive-streams    <a href="https://mvnrepository.com/artifact/org.reactivestreams/reactive-streams/1.0.4" target="_blank">1.0.4</a>    MIT-0
            org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.11" target="_blank">2.13.11</a>    Apache-2.0
        org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.11" target="_blank">2.13.11</a>    Apache-2.0
    com.typesafe.akka    akka-protobuf-v3_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-protobuf-v3_2.13/2.8.3" target="_blank">2.8.3</a>    BUSL-1.1
    com.typesafe.akka    akka-stream_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-stream_2.13/2.8.3" target="_blank">2.8.3</a>    BUSL-1.1
        com.typesafe.akka    akka-actor_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-actor_2.13/2.8.3" target="_blank">2.8.3</a>    BUSL-1.1
            com.typesafe    config    <a href="https://mvnrepository.com/artifact/com.typesafe/config/1.4.2" target="_blank">1.4.2</a>    Apache-2.0
            org.scala-lang.modules    scala-java8-compat_2.13    <a href="https://mvnrepository.com/artifact/org.scala-lang.modules/scala-java8-compat_2.13/1.0.0" target="_blank">1.0.0</a>    Apache-2.0
                org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.11" target="_blank">2.13.11</a>    Apache-2.0
            org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.11" target="_blank">2.13.11</a>    Apache-2.0
        com.typesafe.akka    akka-protobuf-v3_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-protobuf-v3_2.13/2.8.3" target="_blank">2.8.3</a>    BUSL-1.1
        com.typesafe    ssl-config-core_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe/ssl-config-core_2.13/0.6.1" target="_blank">0.6.1</a>    Apache-2.0
            com.typesafe    config    <a href="https://mvnrepository.com/artifact/com.typesafe/config/1.4.2" target="_blank">1.4.2</a>    Apache-2.0
            org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.11" target="_blank">2.13.11</a>    Apache-2.0
        org.reactivestreams    reactive-streams    <a href="https://mvnrepository.com/artifact/org.reactivestreams/reactive-streams/1.0.4" target="_blank">1.0.4</a>    MIT-0
        org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.11" target="_blank">2.13.11</a>    Apache-2.0
    org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.11" target="_blank">2.13.11</a>    Apache-2.0
org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.11" target="_blank">2.13.11</a>    Apache-2.0</pre></dd>
</dl>

<h2><a href="#required-configuration-settings" name="required-configuration-settings" class="anchor"><span class="anchor-link"></span></a>Required configuration settings</h2>

<p>There are two settings that need to be set beforehand in your <code>application.conf</code> file.</p>

<ul>
  <li><code>akka.projection.jdbc.dialect</code> - The dialect type indicating your database of choice. Supported dialects are: <code>mysql-dialect</code>, <code>postgres-dialect</code>, <code>mssql-dialect</code>, <code>oracle-dialect</code> or <code>h2-dialect</code> (testing).</li>
  <li><code>akka.projection.jdbc.blocking-jdbc-dispatcher.thread-pool-executor.fixed-pool-size</code> indicating the size of the blocking JDBC dispatcher. See also <a href="jdbc.html#blocking-jdbc-dispatcher">Blocking JDBC Dispatcher</a>.</li>
</ul>
<h2><a href="#defining-a-jdbcsession" name="defining-a-jdbcsession" class="anchor"><span class="anchor-link"></span></a>Defining a JdbcSession</h2>
<p>Before using Akka Projections JDBC you must implement a <code>JdbcSession</code> <span class="group-scala">trait</span><span class="group-java">interface</span>. <code>JdbcSession</code> is used to open a connection and start a transaction. A new <code>JdbcSession</code> will be created for each call to the handler. At the end of the processing, the transaction will be committed (or rolled back). </p>
<p>When using <code>JdbcProjection.exactlyOnce</code>, the <code>JdbcSession</code> that is passed to the handler will be used to save the offset behind the scenes. Therefore, it&rsquo;s extremely important to disable auto-commit (eg: <code>setAutoCommit(false)</code>), otherwise the two operations won&rsquo;t participate on the same transaction. </p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/scala/docs/jdbc/JdbcProjectionDocExample.scala#L30-L33" target="_blank" title="Go to snippet source">source</a><code class="language-scala">import java.sql.Connection
import java.sql.DriverManager
import akka.projection.jdbc.JdbcSession

class PlainJdbcSession extends JdbcSession {

  lazy val conn = {
    Class.forName(&quot;org.h2.Driver&quot;)
    val c = DriverManager.getConnection(&quot;jdbc:h2:mem:test;DB_CLOSE_DELAY=-1&quot;)
    c.setAutoCommit(false)
    c
  }
  override def withConnection[Result](func: function.Function[Connection, Result]): Result =
    func(conn)
  override def commit(): Unit = conn.commit()
  override def rollback(): Unit = conn.rollback()
  override def close(): Unit = conn.close()
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/java/jdocs/jdbc/JdbcProjectionDocExample.java#L27-L31" target="_blank" title="Go to snippet source">source</a><code class="language-java">import akka.projection.jdbc.JdbcSession;
import java.sql.DriverManager;
import java.sql.SQLException;
import java.sql.Connection;

class PlainJdbcSession implements JdbcSession {

  private final Connection connection;

  public PlainJdbcSession() {
    try {
      Class.forName(&quot;org.h2.Driver&quot;);
      this.connection = DriverManager.getConnection(&quot;jdbc:h2:mem:test;DB_CLOSE_DELAY=-1&quot;);
      connection.setAutoCommit(false);
    } catch (ClassNotFoundException | SQLException e) {
      throw new RuntimeException(e);
    }
  }

  @Override
  public &lt;Result&gt; Result withConnection(Function&lt;Connection, Result&gt; func) throws Exception {
    return func.apply(connection);
  }

  @Override
  public void commit() throws SQLException {
    connection.commit();
  }

  @Override
  public void rollback() throws SQLException {
    connection.rollback();
  }

  @Override
  public void close() throws SQLException {
    connection.close();
  }
}</code></pre></dd>
</dl><div class="callout note "><div class="callout-title">Note</div>
<p>It&rsquo;s highly recommended configuring it with a connection pool, for example <a href="https://github.com/brettwooldridge/HikariCP">HikariCP</a>.</p></div>
<p>When declaring a <code>JdbcProjection</code> you must provide a factory for the <code>JdbcSession</code>. The factory will be used to create new instances whenever needed.</p>
<p>An alternative Hibernate based implementation would look like this:</p>
<dl>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/java/jdocs/jdbc/HibernateJdbcSession.java#L10-L15" target="_blank" title="Go to snippet source">source</a><code class="language-java">import org.hibernate.Session;
import javax.persistence.EntityManager;
import javax.persistence.EntityTransaction;
import java.sql.Connection;
import java.sql.SQLException;

public class HibernateJdbcSession implements JdbcSession {

  public final EntityManager entityManager;
  private final EntityTransaction transaction;

  public HibernateJdbcSession(EntityManager entityManager) {
    this.entityManager = entityManager;
    this.transaction = this.entityManager.getTransaction();
    this.transaction.begin();
  }

  @Override
  public &lt;Result&gt; Result withConnection(Function&lt;Connection, Result&gt; func) {
    Session hibernateSession = entityManager.unwrap(Session.class);
    return hibernateSession.doReturningWork(
        connection -&gt; {
          try {
            return func.apply(connection);
          } catch (SQLException e) {
            throw e;
          } catch (Exception e) {
            throw new SQLException(e);
          }
        });
  }

  @Override
  public void commit() {
    transaction.commit();
  }

  @Override
  public void rollback() {
    // propagates rollback call if transaction is active
    if (transaction.isActive()) transaction.rollback();
  }

  @Override
  public void close() {
    this.entityManager.close();
  }
}</code></pre></dd>
</dl>
<p>And a special factory that initializes the <code>EntityManagerFactory</code> and builds the <code>JdbcSession</code> instance:</p>
<dl>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/java/jdocs/jdbc/HibernateSessionFactory.java#L8-L10" target="_blank" title="Go to snippet source">source</a><code class="language-java">import javax.persistence.EntityManagerFactory;
import javax.persistence.Persistence;

public class HibernateSessionFactory {
  private final EntityManagerFactory entityManagerFactory;

  public HibernateSessionFactory() {
    this.entityManagerFactory = Persistence.createEntityManagerFactory(&quot;akka-projection-hibernate&quot;);
  }

  public HibernateJdbcSession newInstance() {
    return new HibernateJdbcSession(entityManagerFactory.createEntityManager());
  }
}</code></pre></dd>
</dl>
<h2><a href="#blocking-jdbc-dispatcher" name="blocking-jdbc-dispatcher" class="anchor"><span class="anchor-link"></span></a>Blocking JDBC Dispatcher</h2>
<p>JDBC APIs are blocking by design, therefore Akka Projections JDBC will use a dedicated dispatcher to run all JDBC calls. It&rsquo;s important to configure the dispatcher to have the same size as the connection pool. </p>
<p>Each time the projection handler is called one thread and one database connection will be used. If your connection pool is smaller than the number of threads, the thread can potentially block while waiting for the connection pool to provide a connection. </p>
<p>The dispatcher pool size can be configured through the <code>akka.projection.jdbc.blocking-jdbc-dispatcher.thread-pool-executor.fixed-pool-size</code> settings. See <a href="jdbc.html#configuration">Configuration</a> section below.</p><div class="callout note "><div class="callout-title">Note</div>
<p>Most applications will use database connections to read data, for instance to read a projected model upon user request. This means that other parts of the application will be competing for a connection. It&rsquo;s recommend to configure a connection pool dedicated to the projections and use a different one in other parts of the application. </p></div>
<h2><a href="#exactly-once" name="exactly-once" class="anchor"><span class="anchor-link"></span></a>exactly-once</h2>
<p>The offset is stored in the same transaction used for the user defined <code>handler</code>, which means exactly-once processing semantics if the projection is restarted from previously stored offset.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/scala/docs/jdbc/JdbcProjectionDocExample.scala#L21-L23" target="_blank" title="Go to snippet source">source</a><code class="language-scala">import akka.projection.ProjectionId
import akka.projection.jdbc.scaladsl.JdbcProjection

val projection =
  JdbcProjection
    .exactlyOnce(
      projectionId = ProjectionId(&quot;ShoppingCarts&quot;, &quot;carts-1&quot;),
      sourceProvider,
      () =&gt; new PlainJdbcSession, // JdbcSession Factory
      handler = () =&gt; new ShoppingCartHandler(orderRepository))</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/java/jdocs/jdbc/JdbcProjectionDocExample.java#L167-L175" target="_blank" title="Go to snippet source">source</a><code class="language-java">final HibernateSessionFactory sessionProvider = new HibernateSessionFactory();

Projection&lt;EventEnvelope&lt;ShoppingCart.Event&gt;&gt; projection =
    JdbcProjection.exactlyOnce(
        ProjectionId.of(&quot;shopping-carts&quot;, &quot;carts-1&quot;),
        sourceProvider,
        sessionProvider::newInstance,
        ShoppingCartHandler::new,
        system);</code></pre></dd>
</dl>
<p>The <a href="jdbc.html#handler"><code>ShoppingCartHandler</code> is shown below</a>.</p>
<h2><a href="#at-least-once" name="at-least-once" class="anchor"><span class="anchor-link"></span></a>at-least-once</h2>
<p>The offset is stored after the envelope has been processed and giving at-least-once processing semantics. This means that if the projection is restarted from a previously stored offset some elements may be processed more than once. Therefore, the <a href="jdbc.html#handler">Handler</a> code must be idempotent.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/scala/docs/jdbc/JdbcProjectionDocExample.scala#L21-L23" target="_blank" title="Go to snippet source">source</a><code class="language-scala">import akka.projection.ProjectionId
import akka.projection.jdbc.scaladsl.JdbcProjection

val projection =
  JdbcProjection
    .atLeastOnce(
      projectionId = ProjectionId(&quot;ShoppingCarts&quot;, &quot;carts-1&quot;),
      sourceProvider,
      () =&gt; new PlainJdbcSession, // JdbcSession Factory
      handler = () =&gt; new ShoppingCartHandler(orderRepository))
    .withSaveOffset(afterEnvelopes = 100, afterDuration = 500.millis)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/java/jdocs/jdbc/JdbcProjectionDocExample.java#L181-L192" target="_blank" title="Go to snippet source">source</a><code class="language-java">final HibernateSessionFactory sessionProvider = new HibernateSessionFactory();
int saveOffsetAfterEnvelopes = 100;
Duration saveOffsetAfterDuration = Duration.ofMillis(500);

Projection&lt;EventEnvelope&lt;ShoppingCart.Event&gt;&gt; projection =
    JdbcProjection.atLeastOnce(
            ProjectionId.of(&quot;shopping-carts&quot;, &quot;carts-1&quot;),
            sourceProvider,
            sessionProvider::newInstance,
            ShoppingCartHandler::new,
            system)
        .withSaveOffset(saveOffsetAfterEnvelopes, saveOffsetAfterDuration);</code></pre></dd>
</dl>
<p>The offset is stored after a time window, or limited by a number of envelopes, whatever happens first. This window can be defined with <code>withSaveOffset</code> of the returned <code>AtLeastOnceProjection</code>. The default settings for the window is defined in configuration section <code>akka.projection.at-least-once</code>. There is a performance benefit of not storing the offset too often, but the drawback is that there can be more duplicates when the projection that will be processed again when the projection is restarted.</p>
<p>The <a href="jdbc.html#handler"><code>ShoppingCartHandler</code> is shown below</a>.</p>
<h2><a href="#groupedwithin" name="groupedwithin" class="anchor"><span class="anchor-link"></span></a>groupedWithin</h2>
<p>The envelopes can be grouped before processing, which can be useful for batch updates.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/scala/docs/jdbc/JdbcProjectionDocExample.scala#L21-L23" target="_blank" title="Go to snippet source">source</a><code class="language-scala">import akka.projection.ProjectionId
import akka.projection.jdbc.scaladsl.JdbcProjection

val projection =
  JdbcProjection
    .groupedWithin(
      projectionId = ProjectionId(&quot;ShoppingCarts&quot;, &quot;carts-1&quot;),
      sourceProvider,
      () =&gt; new PlainJdbcSession, // JdbcSession Factory
      handler = () =&gt; new GroupedShoppingCartHandler(orderRepository))
    .withGroup(groupAfterEnvelopes = 20, groupAfterDuration = 500.millis)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/java/jdocs/jdbc/JdbcProjectionDocExample.java#L198-L209" target="_blank" title="Go to snippet source">source</a><code class="language-java">final HibernateSessionFactory sessionProvider = new HibernateSessionFactory();
int saveOffsetAfterEnvelopes = 100;
Duration saveOffsetAfterDuration = Duration.ofMillis(500);

Projection&lt;EventEnvelope&lt;ShoppingCart.Event&gt;&gt; projection =
    JdbcProjection.groupedWithin(
            ProjectionId.of(&quot;shopping-carts&quot;, &quot;carts-1&quot;),
            sourceProvider,
            sessionProvider::newInstance,
            GroupedShoppingCartHandler::new,
            system)
        .withGroup(saveOffsetAfterEnvelopes, saveOffsetAfterDuration);</code></pre></dd>
</dl>
<p>The envelopes are grouped within a time window, or limited by a number of envelopes, whatever happens first. This window can be defined with <code>withGroup</code> of the returned <code>GroupedProjection</code>. The default settings for the window is defined in configuration section <code>akka.projection.grouped</code>.</p>
<p>When using <code>groupedWithin</code> the handler is a <span class="group-scala"><code>JdbcHandler[immutable.Seq[EventEnvelope[ShoppingCart.Event]]]</code></span><span class="group-java"><code>JdbcHandler&lt;List&lt;EventEnvelope&lt;ShoppingCart.Event&gt;&gt;&gt;</code></span>. The <a href="jdbc.html#grouped-handler"><code>GroupedShoppingCartHandler</code> is shown below</a>.</p>
<p>The offset is stored in the same transaction used for the user defined <code>handler</code>, which means exactly-once processing semantics if the projection is restarted from previously stored offset.</p>
<h2><a href="#handler" name="handler" class="anchor"><span class="anchor-link"></span></a>Handler</h2>
<p>It&rsquo;s in the <span class="group-java"><a href="/api/akka-projection/1.5.0-M1/akka/projection/jdbc/javadsl/JdbcHandler.html" title="akka.projection.jdbc.javadsl.JdbcHandler"><code>JdbcHandler</code></a></span><span class="group-scala"><a href="/api/akka-projection/1.5.0-M1/akka/projection/jdbc/scaladsl/JdbcHandler.html" title="akka.projection.jdbc.scaladsl.JdbcHandler"><code>JdbcHandler</code></a></span> that you implement the processing of each envelope. It&rsquo;s essentially a consumer function from <code>(JdbcSession, Envelope)</code> to <span class="group-scala"><code>Unit</code></span><span class="group-java"><code>void</code></span>. </p>
<p>A handler that is consuming <code>ShoppingCart.Event</code> from <code>eventsByTag</code> can look like this:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/scala/docs/jdbc/JdbcProjectionDocExample.scala#L16-L17" target="_blank" title="Go to snippet source">source</a><code class="language-scala">import akka.projection.jdbc.scaladsl.JdbcHandler

class ShoppingCartHandler(repository: OrderRepository)
    extends JdbcHandler[EventEnvelope[ShoppingCart.Event], PlainJdbcSession] {
  private val logger = LoggerFactory.getLogger(getClass)

  override def process(session: PlainJdbcSession, envelope: EventEnvelope[ShoppingCart.Event]): Unit = {
    envelope.event match {
      case ShoppingCart.CheckedOut(cartId, time) =&gt;
        logger.info(s&quot;Shopping cart $cartId was checked out at $time&quot;)
        session.withConnection { conn =&gt;
          repository.save(conn, Order(cartId, time))
        }

      case otherEvent =&gt;
        logger.debug(s&quot;Shopping cart ${otherEvent.cartId} changed by $otherEvent&quot;)
    }
  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/java/jdocs/jdbc/JdbcProjectionDocExample.java#L105-L126" target="_blank" title="Go to snippet source">source</a><code class="language-java">public class ShoppingCartHandler
    extends JdbcHandler&lt;EventEnvelope&lt;ShoppingCart.Event&gt;, HibernateJdbcSession&gt; {
  private final Logger logger = LoggerFactory.getLogger(getClass());

  @Override
  public void process(HibernateJdbcSession session, EventEnvelope&lt;ShoppingCart.Event&gt; envelope)
      throws Exception {
    ShoppingCart.Event event = envelope.event();
    if (event instanceof ShoppingCart.CheckedOut) {
      ShoppingCart.CheckedOut checkedOut = (ShoppingCart.CheckedOut) event;
      logger.info(
          &quot;Shopping cart {} was checked out at {}&quot;, checkedOut.cartId, checkedOut.eventTime);

      // pass the EntityManager created by the projection
      // to the repository in order to use the same transaction
      orderRepository.save(
          session.entityManager, new Order(checkedOut.cartId, checkedOut.eventTime));
    } else {
      logger.debug(&quot;Shopping cart {} changed by {}&quot;, event.getCartId(), event);
    }
  }
}</code></pre></dd>
</dl><div class="callout note "><div class="callout-title">Hint</div>
<p>Such simple handlers can also be defined as plain functions via the helper <span class="group-scala"><code>JdbcHandler.apply</code></span><span class="group-java"><code>JdbcHandler.fromFunction</code></span> factory method.</p></div>
<p>where the <code>OrderRepository</code> is an implementation of:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/scala/docs/jdbc/JdbcProjectionDocExample.scala#L42-L45" target="_blank" title="Go to snippet source">source</a><code class="language-scala">case class Order(id: String, time: Instant)
trait OrderRepository {
  def save(connection: Connection, order: Order): Unit
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/java/jdocs/jdbc/JdbcProjectionDocExample.java#L45-L57" target="_blank" title="Go to snippet source">source</a><code class="language-java">class Order {
  public final String id;
  public final Instant time;

  public Order(String id, Instant time) {
    this.id = id;
    this.time = time;
  }
}

interface OrderRepository {
  void save(EntityManager entityManager, Order order);
}</code></pre></dd>
</dl>
<h3><a href="#grouped-handler" name="grouped-handler" class="anchor"><span class="anchor-link"></span></a>Grouped handler</h3>
<p>When using <a href="jdbc.html#groupedwithin"><code>JdbcProjection.groupedWithin</code></a> the handler is processing a <span class="group-scala"><code>Seq</code></span><span class="group-java"><code>List</code></span> of envelopes.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/scala/docs/jdbc/JdbcProjectionDocExample.scala#L16-L17" target="_blank" title="Go to snippet source">source</a><code class="language-scala">import akka.projection.jdbc.scaladsl.JdbcHandler

import scala.collection.immutable

class GroupedShoppingCartHandler(repository: OrderRepository)
    extends JdbcHandler[immutable.Seq[EventEnvelope[ShoppingCart.Event]], PlainJdbcSession] {
  private val logger = LoggerFactory.getLogger(getClass)

  override def process(
      session: PlainJdbcSession,
      envelopes: immutable.Seq[EventEnvelope[ShoppingCart.Event]]): Unit = {

    // save all events in DB
    envelopes.map(_.event).foreach {
      case ShoppingCart.CheckedOut(cartId, time) =&gt;
        logger.info(s&quot;Shopping cart $cartId was checked out at $time&quot;)
        session.withConnection { conn =&gt;
          repository.save(conn, Order(cartId, time))
        }

      case otherEvent =&gt;
        logger.debug(s&quot;Shopping cart ${otherEvent.cartId} changed by $otherEvent&quot;)
    }
  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/java/jdocs/jdbc/JdbcProjectionDocExample.java#L130-L155" target="_blank" title="Go to snippet source">source</a><code class="language-java">public class GroupedShoppingCartHandler
    extends JdbcHandler&lt;List&lt;EventEnvelope&lt;ShoppingCart.Event&gt;&gt;, HibernateJdbcSession&gt; {
  private final Logger logger = LoggerFactory.getLogger(getClass());

  @Override
  public void process(
      HibernateJdbcSession session, List&lt;EventEnvelope&lt;ShoppingCart.Event&gt;&gt; envelopes)
      throws Exception {
    for (EventEnvelope&lt;ShoppingCart.Event&gt; envelope : envelopes) {
      ShoppingCart.Event event = envelope.event();
      if (event instanceof ShoppingCart.CheckedOut) {
        ShoppingCart.CheckedOut checkedOut = (ShoppingCart.CheckedOut) event;
        logger.info(
            &quot;Shopping cart {} was checked out at {}&quot;, checkedOut.cartId, checkedOut.eventTime);

        // pass the EntityManager created by the projection
        // to the repository in order to use the same transaction
        orderRepository.save(
            session.entityManager, new Order(checkedOut.cartId, checkedOut.eventTime));

      } else {
        logger.debug(&quot;Shopping cart {} changed by {}&quot;, event.getCartId(), event);
      }
    }
  }
}</code></pre></dd>
</dl>
<h3><a href="#stateful-handler" name="stateful-handler" class="anchor"><span class="anchor-link"></span></a>Stateful handler</h3>
<p>The <code>JdbcHandler</code> can be stateful, with variables and mutable data structures. It is invoked by the <code>Projection</code> machinery one envelope at a time and visibility guarantees between the invocations are handled automatically, i.e. no volatile or other concurrency primitives are needed for managing the state as long as it&rsquo;s not accessed by other threads than the one that called <code>process</code>.</p><div class="callout note "><div class="callout-title">Note</div>
<p>It is important that the <code>Handler</code> instance is not shared between several <code>Projection</code> instances, because then it would be invoked concurrently, which is not how it is intended to be used. Each <code>Projection</code> instance should use a new <code>Handler</code> instance. </p></div>
<h3><a href="#async-handler" name="async-handler" class="anchor"><span class="anchor-link"></span></a>Async handler</h3>
<p>The <span class="group-java"><a href="/api/akka-projection/1.5.0-M1/akka/projection/javadsl/Handler.html" title="akka.projection.javadsl.Handler"><code>Handler</code></a></span><span class="group-scala"><a href="/api/akka-projection/1.5.0-M1/akka/projection/scaladsl/Handler.html" title="akka.projection.scaladsl.Handler"><code>Handler</code></a></span> can be used with <code>JdbcProjection.atLeastOnceAsync</code> and <code>JdbcProjection.groupedWithinAsync</code> if the handler is not storing the projection result in the database. The handler could <a href="kafka.html#sending-to-kafka">send to a Kafka topic</a> or integrate with something else.</p>
<p>There are several examples of such <code>Handler</code> in the <a href="cassandra.html#handler">documentation for Cassandra Projections</a>. Same type of handlers can be used with <code>JdbcProjection</code> instead of <code>CassandraProjection</code>.</p>
<h3><a href="#actor-handler" name="actor-handler" class="anchor"><span class="anchor-link"></span></a>Actor handler</h3>
<p>A good alternative for advanced state management is to implement the handler as an <a href="https://doc.akka.io/docs/akka/current/typed/actors.html">actor</a>, which is described in <a href="actor.html">Processing with Actor</a>.</p>
<h3><a href="#flow-handler" name="flow-handler" class="anchor"><span class="anchor-link"></span></a>Flow handler</h3>
<p>An Akka Streams <code>FlowWithContext</code> can be used instead of a handler for processing the envelopes, which is described in <a href="flow.html">Processing with Akka Streams</a>.</p>
<h3><a href="#handler-lifecycle" name="handler-lifecycle" class="anchor"><span class="anchor-link"></span></a>Handler lifecycle</h3>
<p>You can override the <code>start</code> and <code>stop</code> methods of the <span class="group-java"><a href="/api/akka-projection/1.5.0-M1/akka/projection/jdbc/javadsl/JdbcHandler.html" title="akka.projection.jdbc.javadsl.JdbcHandler"><code>JdbcHandler</code></a></span><span class="group-scala"><a href="/api/akka-projection/1.5.0-M1/akka/projection/jdbc/scaladsl/JdbcHandler.html" title="akka.projection.jdbc.scaladsl.JdbcHandler"><code>JdbcHandler</code></a></span> to implement initialization before first envelope is processed and resource cleanup when the projection is stopped. Those methods are also called when the <code>Projection</code> is restarted after failure.</p>
<p>See also <a href="error.html">error handling</a>.</p>
<h2><a href="#schema" name="schema" class="anchor"><span class="anchor-link"></span></a>Schema</h2>
<p>The database schema for the offset storage table:</p>
<dl>
  <dt>PostgreSQL</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/resources/create-table-postgres.sql#L4-L22" target="_blank" title="Go to snippet source">source</a><code class="language-sql">CREATE TABLE IF NOT EXISTS akka_projection_offset_store (
  projection_name VARCHAR(255) NOT NULL,
  projection_key VARCHAR(255) NOT NULL,
  current_offset VARCHAR(255) NOT NULL,
  manifest VARCHAR(4) NOT NULL,
  mergeable BOOLEAN NOT NULL,
  last_updated BIGINT NOT NULL,
  PRIMARY KEY(projection_name, projection_key)
);

CREATE INDEX IF NOT EXISTS akka_projection_name_index ON akka_projection_offset_store (projection_name);

CREATE TABLE IF NOT EXISTS akka_projection_management (
  projection_name VARCHAR(255) NOT NULL,
  projection_key VARCHAR(255) NOT NULL,
  paused BOOLEAN NOT NULL,
  last_updated BIGINT NOT NULL,
  PRIMARY KEY(projection_name, projection_key)
);</code></pre></dd>
  <dt>MySQL</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/resources/create-table-mysql.sql#L3-L21" target="_blank" title="Go to snippet source">source</a><code class="language-sql">CREATE TABLE IF NOT EXISTS akka_projection_offset_store (
  projection_name VARCHAR(255) NOT NULL,
  projection_key VARCHAR(255) NOT NULL,
  current_offset VARCHAR(255) NOT NULL,
  manifest VARCHAR(4) NOT NULL,
  mergeable BOOLEAN NOT NULL,
  last_updated BIGINT NOT NULL,
  PRIMARY KEY(projection_name, projection_key)
);

CREATE INDEX akka_projection_name_index ON akka_projection_offset_store (projection_name);

CREATE TABLE IF NOT EXISTS akka_projection_management (
  projection_name VARCHAR(255) NOT NULL,
  projection_key VARCHAR(255) NOT NULL,
  paused BOOLEAN NOT NULL,
  last_updated BIGINT NOT NULL,
  PRIMARY KEY(projection_name, projection_key)
);</code></pre></dd>
  <dt>Microsoft SQL Server</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/resources/create-table-mssql.sql#L3-L29" target="_blank" title="Go to snippet source">source</a><code class="language-sql">IF NOT EXISTS (SELECT 1 FROM SYS.OBJECTS WHERE OBJECT_ID = OBJECT_ID(N&#39;akka_projection_offset_store&#39;) AND TYPE IN (N&#39;U&#39;))
BEGIN
CREATE TABLE akka_projection_offset_store (
  projection_name VARCHAR(255) NOT NULL,
  projection_key VARCHAR(255) NOT NULL,
  current_offset VARCHAR(255) NOT NULL,
  manifest VARCHAR(4) NOT NULL,
  mergeable BIT NOT NULL,
  last_updated BIGINT NOT NULL
)

ALTER TABLE akka_projection_offset_store ADD CONSTRAINT pk_projection_id PRIMARY KEY(projection_name, projection_key)

CREATE INDEX akka_projection_name_index ON akka_projection_offset_store (projection_name)
END

IF NOT EXISTS (SELECT 1 FROM SYS.OBJECTS WHERE OBJECT_ID = OBJECT_ID(N&#39;akka_projection_management&#39;) AND TYPE IN (N&#39;U&#39;))
BEGIN
CREATE TABLE akka_projection_management (
  projection_name VARCHAR(255) NOT NULL,
  projection_key VARCHAR(255) NOT NULL,
  paused BIT NOT NULL,
  last_updated BIGINT NOT NULL
)

ALTER TABLE akka_projection_management ADD CONSTRAINT pk_projection_management_id PRIMARY KEY(projection_name, projection_key)
END</code></pre></dd>
  <dt>Oracle</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/resources/create-table-oracle.sql#L3-L26" target="_blank" title="Go to snippet source">source</a><code class="language-sql">BEGIN
execute immediate &#39;create table &quot;AKKA_PROJECTION_OFFSET_STORE&quot; (&quot;PROJECTION_NAME&quot; VARCHAR2(255) NOT NULL,&quot;PROJECTION_KEY&quot; VARCHAR2(255) NOT NULL,&quot;CURRENT_OFFSET&quot; VARCHAR2(255) NOT NULL,&quot;MANIFEST&quot; VARCHAR2(4) NOT NULL,&quot;MERGEABLE&quot; CHAR(1) NOT NULL check (&quot;MERGEABLE&quot; in (0, 1)),&quot;LAST_UPDATED&quot; NUMBER(19) NOT NULL) &#39;;
execute immediate &#39;alter table &quot;AKKA_PROJECTION_OFFSET_STORE&quot; add constraint &quot;PK_PROJECTION_ID&quot; primary key(&quot;PROJECTION_NAME&quot;,&quot;PROJECTION_KEY&quot;) &#39;;
execute immediate &#39;create index &quot;AKKA_PROJECTION_NAME_INDEX&quot; on &quot;AKKA_PROJECTION_OFFSET_STORE&quot; (&quot;PROJECTION_NAME&quot;) &#39;;
EXCEPTION
    WHEN OTHERS THEN
      IF SQLCODE = -955 THEN
        NULL; -- suppresses ORA-00955 exception
      ELSE
         RAISE;
      END IF;
END;

BEGIN
execute immediate &#39;create table &quot;AKKA_PROJECTION_MANAGEMENT&quot; (&quot;PROJECTION_NAME&quot; VARCHAR2(255) NOT NULL,&quot;PROJECTION_KEY&quot; VARCHAR2(255) NOT NULL,&quot;PAUSED&quot; CHAR(1) NOT NULL check (&quot;PAUSED&quot; in (0, 1)),&quot;LAST_UPDATED&quot; NUMBER(19) NOT NULL) &#39;;
execute immediate &#39;alter table &quot;AKKA_PROJECTION_MANAGEMENT&quot; add constraint &quot;PK_PROJECTION_MANAGEMENT_ID&quot; primary key(&quot;PROJECTION_NAME&quot;,&quot;PROJECTION_KEY&quot;) &#39;;
EXCEPTION
    WHEN OTHERS THEN
      IF SQLCODE = -955 THEN
        NULL; -- suppresses ORA-00955 exception
      ELSE
         RAISE;
      END IF;
END;</code></pre></dd>
  <dt>H2</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/resources/create-table-h2.sql#L3-L21" target="_blank" title="Go to snippet source">source</a><code class="language-sql">CREATE TABLE IF NOT EXISTS &quot;akka_projection_offset_store&quot; (
  &quot;projection_name&quot; VARCHAR(255) NOT NULL,
  &quot;projection_key&quot; VARCHAR(255) NOT NULL,
  &quot;current_offset&quot; VARCHAR(255) NOT NULL,
  &quot;manifest&quot; VARCHAR(4) NOT NULL,
  &quot;mergeable&quot; BOOLEAN NOT NULL,
  &quot;last_updated&quot; BIGINT NOT NULL,
  PRIMARY KEY(&quot;projection_name&quot;, &quot;projection_key&quot;)
);

CREATE INDEX IF NOT EXISTS &quot;akka_projection_name_index&quot; ON &quot;akka_projection_offset_store&quot; (&quot;projection_name&quot;);

CREATE TABLE IF NOT EXISTS &quot;akka_projection_management&quot; (
  &quot;projection_name&quot; VARCHAR(255) NOT NULL,
  &quot;projection_key&quot; VARCHAR(255) NOT NULL,
  &quot;paused&quot; BOOLEAN NOT NULL,
  &quot;last_updated&quot; BIGINT NOT NULL,
  PRIMARY KEY(&quot;projection_name&quot;, &quot;projection_key&quot;)
);</code></pre></dd>
</dl>
<p>The schema can be created and dropped using the methods <code>JdbcProjection.createTablesIfNotExists</code> and <code>JdbcProjection.dropTablesIfExists</code>. This is particularly useful when writting tests. For production enviornments, we recommend creating the schema before deploying the application.</p><div class="callout warning "><div class="callout-title">Important</div>
<p>As of version 1.2.2, the index name <code>PROJECTION_NAME_INDEX</code> has been changed to <code>AKKA_PROJECTION_NAME_INDEX</code> If you have a schema in production, we recommend applying an ALTER index script to change it accordingly.</p>
<p>@@@ warning { title=Important } As of version 1.1.0, the schema for PostgreSQL and H2 databases has changed. It now defaults to lowercase table and column names. If you have a schema in production, we recommend applying an ALTER table script to change it accordingly.</p>
<p>Alternatively, you can fallback to the uppercase format. You will also need to set <code>akka.projection.jdbc.offset-store.table</code> as an uppercase value, as this setting is now defaulting to lowercase.</p>
<pre class="prettyprint"><code class="language-hocon">akka.projection.jdbc.offset-store {
  table = &quot;AKKA_PROJECTION_OFFSET_STORE&quot;
  use-lowercase-schema = false
}
</code></pre></div>
<h2><a href="#offset-types" name="offset-types" class="anchor"><span class="anchor-link"></span></a>Offset types</h2>
<p>The supported offset types of the <code>JdbcProjection</code> are:</p>
<ul>
  <li><span class="group-scala"><a href="https://doc.akka.io/api/akka/2.8/akka/persistence/query/Offset.html" title="akka.persistence.query.Offset"><code>Offset</code></a></span><span class="group-java"><a href="https://doc.akka.io/japi/akka/2.8/akka/persistence/query/Offset.html" title="akka.persistence.query.Offset"><code>Offset</code></a></span> types from <a href="eventsourced.html">events from Akka Persistence</a></li>
  <li><span class="group-scala"><a href="/api/akka-projection/1.5.0-M1/akka/projection/MergeableOffset.html" title="akka.projection.MergeableOffset"><code>MergeableOffset</code></a></span><span class="group-java"><a href="/api/akka-projection/1.5.0-M1/akka/projection/MergeableOffset.html" title="akka.projection.MergeableOffset"><code>MergeableOffset</code></a></span> that is used for <a href="kafka.html#mergeable-offset">messages from Kafka</a></li>
  <li><code>String</code></li>
  <li><code>Int</code></li>
  <li><code>Long</code></li>
  <li>Any other type that has a configured Akka Serializer is stored with base64 encoding of the serialized bytes.</li>
</ul>
<h2><a href="#configuration" name="configuration" class="anchor"><span class="anchor-link"></span></a>Configuration</h2>
<p>Make your edits/overrides in your application.conf.</p>
<p>The reference configuration file with the default values:</p>
<pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/akka-projection-jdbc/src/main/resources/reference.conf#L5-L35" target="_blank" title="Go to snippet source">source</a><code class="language-conf">akka.projection.jdbc {
  # choose one of: mysql-dialect, postgres-dialect, mssql-dialect, oracle-dialect or h2-dialect (testing)
  dialect = &quot;&quot;
  use-dispatcher = &quot;akka.projection.jdbc.blocking-jdbc-dispatcher&quot;
  blocking-jdbc-dispatcher {
    type = Dispatcher
    executor = &quot;thread-pool-executor&quot;
    thread-pool-executor {
      # Use same number of threads as connections in the JDBC connection pool.
      fixed-pool-size = &quot;&quot;
    }
    throughput = 1
  }

  offset-store {
    # set this to your database schema if applicable, empty by default
    schema = &quot;&quot;
    # the database table name for the offset store
    table = &quot;akka_projection_offset_store&quot;

    # the database table name for the projection manangement data
    management-table = &quot;akka_projection_management&quot;

    # Use lowercase table and column names. 
    # This is mostly useful for H2 and Postgres databases. MySQL and SQL Server are case insensitive. 
    # Oracle schema is case sensitive and is defined with uppercase, this property is therefore ignore when using Oracle
    use-lowercase-schema = true
  }

  debug.verbose-offset-store-logging = false
}</code></pre><div class="callout note "><div class="callout-title">Note</div>
<p>Settings <code>akka.projection.jdbc.dialect</code> and <code>akka.projection.jdbc.blocking-jdbc-dispatcher.thread-pool-executor.fixed-pool-size</code> do not have a valid default value. You must configured them in your <code>application.conf</code> file. </p>
<p>See <a href="jdbc.html#required-configuration-settings">Required Configuration Settings</a> and <a href="jdbc.html#blocking-jdbc-dispatcher">Blocking JDBC Dispatcher</a> sections for details. </p></div>
</div>
</article>
<div class="row">
<div class="small-12 column">
<section class="nav-prev-next row">
<div class="nav-prev small-6 column">
<a href="cassandra.html"><i class="icon-prev"></i> <span class="link-prev">Offset in Cassandra</span></a>
</div>
<div class="nav-next small-6 column clearfix">
<a class="float-right" href="slick.html">Offset in a relational DB with Slick <i class="icon-next"></i></a>
</div>
</section>
</div>
</div>
<div class="source-github row">
Found an error in this documentation? The source code for this page can be found <a href="https://github.com/akka/akka-projection/tree/master/docs/src/main/paradox/jdbc.md">here</a>.
Please feel free to edit and contribute a pull request.
</div>

<footer class="page-footer row clearfix">
<img class="akka-icon float-left show-for-medium" src="images/akka-icon.svg" />
<section class="copyright">
<div>Akka Projections is available under the <a href="https://www.lightbend.com/akka/license" target="_blank">Business Source License 1.1</a>.</div>
<p class="legal">
&copy; 2011-2023 <a href="https://www.lightbend.com" target="_blank">Lightbend, Inc.</a> |
<a href="https://www.lightbend.com/legal/licenses" target="_blank">Licenses</a> |
<a href="https://www.lightbend.com/legal/terms" target="_blank">Terms</a> |
<a href="https://www.lightbend.com/legal/privacy" target="_blank">Privacy Policy</a> |
<a href="https://akka.io/cookie/" target="_blank">Cookie Listing</a> |
<a class="optanon-toggle-display">Cookie Settings</a>
</p>
</section>

</footer>
</section>
</main>
</div>

<script type="text/javascript" src="js/scrollsneak.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="js/groups.js"></script>
<script type="text/javascript" src="js/page.js"></script>
<script type="text/javascript" src="js/snippets.js"></script>
<script type="text/javascript" src="js/magellan.js"></script>
<script type="text/javascript" src="js/metadata-toggle.js"></script>
<script type="text/javascript" src="js/lbHeader.js"></script>

<style type="text/css">@import "lib/prettify/prettify.css";</style>
<script type="text/javascript" src="lib/prettify/prettify.js"></script>
<script type="text/javascript" src="lib/prettify/lang-scala.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(){window.prettyPrint && prettyPrint()});
//]]></script>
<script type="text/javascript" src="assets/js/warnOldVersion.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(jq){initOldVersionWarnings(jq, '1.5.0-M1', 'https://doc.akka.io/docs/akka-projection/current/')});
//]]></script>


</body>
</html>
