<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Messages from and to Kafka &bull; Akka Projection</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="Akka Projection."/>
<link rel="canonical" href="https://doc.akka.io/docs/akka-projection/current/kafka.html"/>
<script type="text/javascript" src="lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="lib/foundation/dist/js/foundation.min.js"></script>
<link rel="stylesheet" type="text/css" href="lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="lib/foundation/dist/css/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" type="text/css" href="css/icons.css"/>
<link rel="stylesheet" type="text/css" href="css/page-8.css"/>
<link rel="stylesheet" type="text/css" href="css/banner-2.css"/>
<link rel="shortcut icon" href="images/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png"/>
<link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png"/>
<link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png"/>
<link rel="manifest" href="images/manifest.json"/>
<meta name="msapplication-TileImage" content="images/mstile-150x150.png"/>
<meta name="msapplication-TileColor" content="#15a9ce"/>
<meta name="theme-color" content="#15a9ce"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) start -->
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js"  type="text/javascript" charset="UTF-8" data-domain-script="28b912e7-09e9-43d5-91e4-3d1897044004" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) end -->
<!--Google Analytics-->
<script type="text/plain" class="optanon-category-2">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', '']);
_gaq.push(['_setDomainName', '']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})()
</script>
<!-- Google Tag Manager -->
<script type="text/plain" class="optanon-category-2">
(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KBJGH35');
</script>
<!--Marketo-->
<script type="text/plain" class="optanon-category-3">
(function() {
var didInit = false;
function initMunchkin() {
if(didInit === false) {
didInit = true;
Munchkin.init('558-NCX-702', { 'asyncOnly': true, 'disableClickDelay': true });
}
}
var s = document.createElement('script');
s.type = 'text/javascript';
s.async = true;
s.src = '//munchkin.marketo.net/munchkin.js';
s.onreadystatechange = function() {
if (this.readyState == 'complete' || this.readyState == 'loaded') {
initMunchkin();
}
};
s.onload = initMunchkin;
document.getElementsByTagName('head')[0].appendChild(s);
})();
</script>
</head>

<body id="underlay" data-toggler="nav-open">
<div id="lightbend-banner" class="lightbend-banner akka full-width" data-category="OSS Lightbend Banner Impression" data-label="Akka Banner Impression">
<div class="oss-wrapper">
<div class="oss-brand">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lightbend Logo - Akka Banner" href="https://www.lightbend.com">
<img class="lightbend-logo" src="images/banner-logos/lightbend-reverse.svg" alt="Lightbend" title="Lightbend">
</a>
</div>
<div class="oss-ad no-drop-down">
<nav id="lightbendRotator" class="lightbend-rotator">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Promo Rotator - Lightbend is Changing its Software Licensing Model for Akka Technology. [License FAQ] - Akka Banner" href="https://www.lightbend.com/akka/license-faq">
<strong>Lightbend</strong> is Changing its Software Licensing Model for Akka Technology. <span class="akka-btn">License FAQ</span>
</a>
</nav>
</div>
</div>
</div>

<header class="site-header hide-for-large">
<div class="sticky-header clearfix">
<a href="https://akka.io"><img class="logo" src="images/akka-logo-reverse.svg"/></a>

<button class="menu-icon float-right" type="button" data-toggle="underlay overlay"></button>
</div>
<div id="overlay" class="overlay-nav" data-toggler="nav-open">
<header class="nav-header">
<div class="nav-header-title">
<h1><a href="index.html">Akka Projection</a></h1>
</div>
<div class="nav-header-version">
Version 1.3.0
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="nav-toc">
<ul>
  <li><a href="overview.html" class="page">Overview</a></li>
  <li><a href="use-cases.html" class="page">Use Cases</a></li>
  <li><a href="getting-started/index.html" class="page">Getting Started Guide</a></li>
  <li><a href="eventsourced.html" class="page">Events from Akka Persistence</a></li>
  <li><a href="durable-state.html" class="page">Changes from Durable State</a></li>
  <li><a href="kafka.html#messages-from-and-to-kafka" class="active page">Messages from and to Kafka</a>
  <ul>
    <li><a href="kafka.html#dependencies" class="header">Dependencies</a></li>
    <li><a href="kafka.html#kafkasourceprovider" class="header">KafkaSourceProvider</a></li>
    <li><a href="kafka.html#committing-offset-outside-kafka" class="header">Committing offset outside Kafka</a></li>
    <li><a href="kafka.html#committing-offset-in-kafka" class="header">Committing offset in Kafka</a></li>
    <li><a href="kafka.html#sending-to-kafka" class="header">Sending to Kafka</a></li>
    <li><a href="kafka.html#mergeable-offset" class="header">Mergeable Offset</a></li>
    <li><a href="kafka.html#configuration" class="header">Configuration</a></li>
  </ul></li>
  <li><a href="cassandra.html" class="page">Offset in Cassandra</a></li>
  <li><a href="jdbc.html" class="page">Offset in a relational DB with JDBC</a></li>
  <li><a href="slick.html" class="page">Offset in a relational DB with Slick</a></li>
  <li><a href="running.html" class="page">Running a Projection</a></li>
  <li><a href="actor.html" class="page">Processing with Actor</a></li>
  <li><a href="flow.html" class="page">Processing with Akka Streams</a></li>
  <li><a href="error.html" class="page">Error handling</a></li>
  <li><a href="projection-settings.html" class="page">Projection Settings</a></li>
  <li><a href="grpc.html" class="page">Akka Projection gRPC</a></li>
  <li><a href="management.html" class="page">Management of a Projection</a></li>
  <li><a href="testing.html" class="page">Testing</a></li>
  <li><a href="classic.html" class="page">Akka Classic</a></li>
  <li><a href="snapshots.html" class="page">Snapshots</a></li>
</ul>
</nav>
</div>
</header>
<div class="site-content-wrapper">
<aside class="sticky-sidebar show-for-large">
<header class="nav-header sticky-sidebar-header">
<div class="nav-header-title">
<h1><a href="index.html">Akka Projection</a></h1>
</div>
<div class="nav-header-version">
Version 1.3.0
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="site-nav sticky-sidebar-contents">
<div class="nav-toc">
<ul>
  <li><a href="overview.html" class="page">Overview</a></li>
  <li><a href="use-cases.html" class="page">Use Cases</a></li>
  <li><a href="getting-started/index.html" class="page">Getting Started Guide</a></li>
  <li><a href="eventsourced.html" class="page">Events from Akka Persistence</a></li>
  <li><a href="durable-state.html" class="page">Changes from Durable State</a></li>
  <li><a href="kafka.html#messages-from-and-to-kafka" class="active page">Messages from and to Kafka</a>
  <ul>
    <li><a href="kafka.html#dependencies" class="header">Dependencies</a></li>
    <li><a href="kafka.html#kafkasourceprovider" class="header">KafkaSourceProvider</a></li>
    <li><a href="kafka.html#committing-offset-outside-kafka" class="header">Committing offset outside Kafka</a></li>
    <li><a href="kafka.html#committing-offset-in-kafka" class="header">Committing offset in Kafka</a></li>
    <li><a href="kafka.html#sending-to-kafka" class="header">Sending to Kafka</a></li>
    <li><a href="kafka.html#mergeable-offset" class="header">Mergeable Offset</a></li>
    <li><a href="kafka.html#configuration" class="header">Configuration</a></li>
  </ul></li>
  <li><a href="cassandra.html" class="page">Offset in Cassandra</a></li>
  <li><a href="jdbc.html" class="page">Offset in a relational DB with JDBC</a></li>
  <li><a href="slick.html" class="page">Offset in a relational DB with Slick</a></li>
  <li><a href="running.html" class="page">Running a Projection</a></li>
  <li><a href="actor.html" class="page">Processing with Actor</a></li>
  <li><a href="flow.html" class="page">Processing with Akka Streams</a></li>
  <li><a href="error.html" class="page">Error handling</a></li>
  <li><a href="projection-settings.html" class="page">Projection Settings</a></li>
  <li><a href="grpc.html" class="page">Akka Projection gRPC</a></li>
  <li><a href="management.html" class="page">Management of a Projection</a></li>
  <li><a href="testing.html" class="page">Testing</a></li>
  <li><a href="classic.html" class="page">Akka Classic</a></li>
  <li><a href="snapshots.html" class="page">Snapshots</a></li>
</ul>
</div>
</nav>
<footer class="nav-footer sticky-sidebar-footer">
<a href="https://akka.io"><img class="logo" src="images/akka-logo-reverse.svg"/></a>

</footer>
</aside>
<main class="fixed-shift-for-large expanded row">
<section class="site-content small-12 column">
<article class="page-content row">
<div class="small-12 column" id="docs">
<h1><a href="#messages-from-and-to-kafka" name="messages-from-and-to-kafka" class="anchor"><span class="anchor-link"></span></a>Messages from and to Kafka</h1>
<p>A typical source for Projections is messages from Kafka. Akka Projections supports integration with Kafka using <a href="https://doc.akka.io/docs/alpakka-kafka/current/">Alpakka Kafka</a>.</p>
<p>The <span class="group-java"><a href="/api/akka-projection/1.3.0/akka/projection/kafka/javadsl/KafkaSourceProvider$.html" title="akka.projection.kafka.javadsl.KafkaSourceProvider"><code>KafkaSourceProvider</code></a></span><span class="group-scala"><a href="/api/akka-projection/1.3.0/akka/projection/kafka/scaladsl/KafkaSourceProvider$.html" title="akka.projection.kafka.scaladsl.KafkaSourceProvider"><code>KafkaSourceProvider</code></a></span> uses consumer group assignments from Kafka and can resume from offsets stored in a database.</p>
<p>Akka Projections can store the offsets from Kafka in a <a href="jdbc.html">relational DB with JDBC</a> or in <a href="slick.html">relational DB with Slick</a>.</p>
<p>The <code>JdbcProjection</code> <span class="group-scala">or <code>SlickProjection</code></span> envelope handler will be run by the projection. This means that the target database operations can be run in the same transaction as the storage of the offset, which means when used with <a href="jdbc.html#exactly-once">exactly-once</a> the offsets will be persisted on the same transaction as the projected model (see <a href="kafka.html#committing-offset-outside-kafka">Committing offset outside Kafka</a>). It also offers <a href="jdbc.html#at-least-once">at-least-once</a> semantics.</p><div class="callout note "><div class="callout-title">Note</div>
<p>Offset storage of Kafka offsets are not implemented for Cassandra yet, see <a href="https://github.com/akka/akka-projection/issues/97">issue #97</a>.</p></div>
<p>A <code>Projection</code> can also <a href="kafka.html#sending-to-kafka">send messages to Kafka</a>.</p>
<h2><a href="#dependencies" name="dependencies" class="anchor"><span class="anchor-link"></span></a>Dependencies</h2>
<p>To use the Kafka module of Akka Projections add the following dependency in your project:</p><dl class="dependency"><dt>sbt</dt><dd><pre class="prettyprint"><code class="language-scala">libraryDependencies += "com.lightbend.akka" %% "akka-projection-kafka" % "1.3.0"</code></pre></dd><dt>Maven</dt><dd><pre class="prettyprint"><code class="language-xml">&lt;properties&gt;
  &lt;scala.binary.version&gt;2.13&lt;/scala.binary.version&gt;
&lt;/properties&gt;
&lt;dependencies&gt
  &lt;dependency&gt;
    &lt;groupId&gt;com.lightbend.akka&lt;/groupId&gt;
    &lt;artifactId&gt;akka-projection-kafka_${scala.binary.version}&lt;/artifactId&gt;
    &lt;version&gt;1.3.0&lt;/version&gt;
  &lt;/dependency&gt
&lt;/dependencies&gt;</code></pre></dd><dt>Gradle</dt><dd><pre class="prettyprint"><code class="language-gradle">def versions = [
  ScalaBinary: "2.13"
]
dependencies {
  implementation "com.lightbend.akka:akka-projection-kafka_${versions.ScalaBinary}:1.3.0"
}</code></pre></dd></dl>
<p>Akka Projections require Akka 2.7.0 or later, see <a href="overview.html#akka-version">Akka version</a>.</p>
<table class="project-info">
<tr><th colspan="2">Project Info: Akka Projections Kafka</th></tr>
  <tr><th>Artifact</th><td><div>com.lightbend.akka</div>
  <div>akka-projection-kafka</div>
  <div>1.3.0</div>
  <div><a href="snapshots.html">Snapshots are available</a></div>
  </td></tr>
  <tr><th>JDK versions</th><td><div>AdoptOpenJDK 8</div><div>AdoptOpenJDK 11</div></td></tr>
  <tr><th>Scala versions</th><td>2.13.10, 2.12.17</td></tr>
  <tr><th>JPMS module name</th><td>akka.projection.kafka</td></tr>
  <tr><th>License</th><td><div><a href="https://raw.githubusercontent.com/akka/akka-projection/main/LICENSE" target="_blank" rel="noopener noreferrer">BUSL-1.1</a></div>
  </td></tr>
  <tr><th>Readiness level</th><td><div class="readiness-level"><a href="https://developer.lightbend.com/docs/introduction/getting-help/support-terminology.html#supported" target="_blank" rel="noopener">Supported</a>, <a href="https://www.lightbend.com/lightbend-subscription" target="_blank" rel="noopener">Lightbend Subscription</a> provides support</div>
  <div>Since 1.0.0, 2020-09-10</div>
  </td></tr>
  <tr><th>Home page</th><td><a href="https://akka.io">https://akka.io</a></td></tr>
  <tr><th>API documentation</th><td>
  <div><a href="https://doc.akka.io/api/akka-projection/1.3.0/akka/projection/" target="_blank" rel="noopener noreferrer">API (Scaladoc)</a></div>
  </td></tr>
  <tr><th>Forums</th><td>
  <div><a href="https://discuss.lightbend.com/c/akka/" target="_blank" rel="noopener noreferrer">Lightbend Discuss</a></div>
  <div><a href="https://gitter.im/akka/akka" target="_blank" rel="noopener noreferrer">akka/akka Gitter channel</a></div>
  </td></tr>
  <tr><th>Release notes</th><td><a href="https://github.com/akka/akka-projection/releases" target="_blank" rel="noopener noreferrer">GitHub releases</a></td></tr>
  <tr><th>Issues</th><td><a href="https://github.com/akka/akka-projection/issues" target="_blank" rel="noopener noreferrer">GitHub issues</a></td></tr>
  <tr><th>Sources</th><td><a href="https://github.com/akka/akka-projection" target="_blank" rel="noopener noreferrer">https://github.com/akka/akka-projection</a></td></tr>
</table>

<h3><a href="#transitive-dependencies" name="transitive-dependencies" class="anchor"><span class="anchor-link"></span></a>Transitive dependencies</h3>

<p>The table below shows <code>akka-projection-kafka</code>&rsquo;s direct dependencies and the second tab shows all libraries it depends on transitively.</p>

<dl class="dependencies"><dt>Direct dependencies</dt><dd><table>
  <thead><tr><th>Organization</th><th>Artifact</th><th>Version</th></thead>
  <tbody>
    <tr><td>com.fasterxml.jackson.core</td><td>jackson-databind</td><td><a href="https://mvnrepository.com/artifact/com.fasterxml.jackson.core/jackson-databind/2.13.4.2" target="_blank">2.13.4.2</a></td></tr>
    <tr><td>com.lightbend.akka</td><td>akka-projection-core_2.13</td><td><a href="https://mvnrepository.com/artifact/com.lightbend.akka/akka-projection-core_2.13/1.3.0" target="_blank">1.3.0</a></td></tr>
    <tr><td>com.typesafe.akka</td><td>akka-stream-kafka_2.13</td><td><a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-stream-kafka_2.13/4.0.0" target="_blank">4.0.0</a></td></tr>
    <tr><td>org.scala-lang</td><td>scala-library</td><td><a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.10" target="_blank">2.13.10</a></td></tr>
  </tbody>
</table></dd>
<dt>Dependency tree</dt><dd><pre>
com.fasterxml.jackson.core    jackson-databind    <a href="https://mvnrepository.com/artifact/com.fasterxml.jackson.core/jackson-databind/2.13.4.2" target="_blank">2.13.4.2</a>    The Apache Software License, Version 2.0
    com.fasterxml.jackson.core    jackson-annotations    <a href="https://mvnrepository.com/artifact/com.fasterxml.jackson.core/jackson-annotations/2.13.4" target="_blank">2.13.4</a>    The Apache Software License, Version 2.0
    com.fasterxml.jackson.core    jackson-core    <a href="https://mvnrepository.com/artifact/com.fasterxml.jackson.core/jackson-core/2.13.4" target="_blank">2.13.4</a>    The Apache Software License, Version 2.0
com.lightbend.akka    akka-projection-core_2.13    <a href="https://mvnrepository.com/artifact/com.lightbend.akka/akka-projection-core_2.13/1.3.0" target="_blank">1.3.0</a>
    com.typesafe.akka    akka-actor-typed_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-actor-typed_2.13/2.7.0" target="_blank">2.7.0</a>    BUSL-1.1
        com.typesafe.akka    akka-actor_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-actor_2.13/2.7.0" target="_blank">2.7.0</a>    BUSL-1.1
            com.typesafe    config    <a href="https://mvnrepository.com/artifact/com.typesafe/config/1.4.2" target="_blank">1.4.2</a>    Apache-2.0
            org.scala-lang.modules    scala-java8-compat_2.13    <a href="https://mvnrepository.com/artifact/org.scala-lang.modules/scala-java8-compat_2.13/1.0.0" target="_blank">1.0.0</a>    Apache-2.0
                org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.10" target="_blank">2.13.10</a>    Apache-2.0
            org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.10" target="_blank">2.13.10</a>    Apache-2.0
        com.typesafe.akka    akka-slf4j_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-slf4j_2.13/2.7.0" target="_blank">2.7.0</a>    BUSL-1.1
            com.typesafe.akka    akka-actor_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-actor_2.13/2.7.0" target="_blank">2.7.0</a>    BUSL-1.1
                com.typesafe    config    <a href="https://mvnrepository.com/artifact/com.typesafe/config/1.4.2" target="_blank">1.4.2</a>    Apache-2.0
                org.scala-lang.modules    scala-java8-compat_2.13    <a href="https://mvnrepository.com/artifact/org.scala-lang.modules/scala-java8-compat_2.13/1.0.0" target="_blank">1.0.0</a>    Apache-2.0
                    org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.10" target="_blank">2.13.10</a>    Apache-2.0
                org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.10" target="_blank">2.13.10</a>    Apache-2.0
            org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.10" target="_blank">2.13.10</a>    Apache-2.0
            org.slf4j    slf4j-api    <a href="https://mvnrepository.com/artifact/org.slf4j/slf4j-api/1.7.36" target="_blank">1.7.36</a>
        org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.10" target="_blank">2.13.10</a>    Apache-2.0
        org.slf4j    slf4j-api    <a href="https://mvnrepository.com/artifact/org.slf4j/slf4j-api/1.7.36" target="_blank">1.7.36</a>
    com.typesafe.akka    akka-persistence-query_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-persistence-query_2.13/2.7.0" target="_blank">2.7.0</a>    BUSL-1.1
        com.typesafe.akka    akka-persistence_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-persistence_2.13/2.7.0" target="_blank">2.7.0</a>    BUSL-1.1
            com.typesafe.akka    akka-actor_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-actor_2.13/2.7.0" target="_blank">2.7.0</a>    BUSL-1.1
                com.typesafe    config    <a href="https://mvnrepository.com/artifact/com.typesafe/config/1.4.2" target="_blank">1.4.2</a>    Apache-2.0
                org.scala-lang.modules    scala-java8-compat_2.13    <a href="https://mvnrepository.com/artifact/org.scala-lang.modules/scala-java8-compat_2.13/1.0.0" target="_blank">1.0.0</a>    Apache-2.0
                    org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.10" target="_blank">2.13.10</a>    Apache-2.0
                org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.10" target="_blank">2.13.10</a>    Apache-2.0
            com.typesafe.akka    akka-stream_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-stream_2.13/2.7.0" target="_blank">2.7.0</a>    BUSL-1.1
                com.typesafe.akka    akka-actor_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-actor_2.13/2.7.0" target="_blank">2.7.0</a>    BUSL-1.1
                    com.typesafe    config    <a href="https://mvnrepository.com/artifact/com.typesafe/config/1.4.2" target="_blank">1.4.2</a>    Apache-2.0
                    org.scala-lang.modules    scala-java8-compat_2.13    <a href="https://mvnrepository.com/artifact/org.scala-lang.modules/scala-java8-compat_2.13/1.0.0" target="_blank">1.0.0</a>    Apache-2.0
                        org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.10" target="_blank">2.13.10</a>    Apache-2.0
                    org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.10" target="_blank">2.13.10</a>    Apache-2.0
                com.typesafe.akka    akka-protobuf-v3_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-protobuf-v3_2.13/2.7.0" target="_blank">2.7.0</a>    BUSL-1.1
                com.typesafe    ssl-config-core_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe/ssl-config-core_2.13/0.4.3" target="_blank">0.4.3</a>    Apache-2.0
                    com.typesafe    config    <a href="https://mvnrepository.com/artifact/com.typesafe/config/1.4.2" target="_blank">1.4.2</a>    Apache-2.0
                    org.scala-lang.modules    scala-parser-combinators_2.13    <a href="https://mvnrepository.com/artifact/org.scala-lang.modules/scala-parser-combinators_2.13/1.1.2" target="_blank">1.1.2</a>    Apache-2.0
                        org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.10" target="_blank">2.13.10</a>    Apache-2.0
                    org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.10" target="_blank">2.13.10</a>    Apache-2.0
                org.reactivestreams    reactive-streams    <a href="https://mvnrepository.com/artifact/org.reactivestreams/reactive-streams/1.0.4" target="_blank">1.0.4</a>    MIT-0
                org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.10" target="_blank">2.13.10</a>    Apache-2.0
            org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.10" target="_blank">2.13.10</a>    Apache-2.0
        com.typesafe.akka    akka-protobuf-v3_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-protobuf-v3_2.13/2.7.0" target="_blank">2.7.0</a>    BUSL-1.1
        com.typesafe.akka    akka-stream_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-stream_2.13/2.7.0" target="_blank">2.7.0</a>    BUSL-1.1
            com.typesafe.akka    akka-actor_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-actor_2.13/2.7.0" target="_blank">2.7.0</a>    BUSL-1.1
                com.typesafe    config    <a href="https://mvnrepository.com/artifact/com.typesafe/config/1.4.2" target="_blank">1.4.2</a>    Apache-2.0
                org.scala-lang.modules    scala-java8-compat_2.13    <a href="https://mvnrepository.com/artifact/org.scala-lang.modules/scala-java8-compat_2.13/1.0.0" target="_blank">1.0.0</a>    Apache-2.0
                    org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.10" target="_blank">2.13.10</a>    Apache-2.0
                org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.10" target="_blank">2.13.10</a>    Apache-2.0
            com.typesafe.akka    akka-protobuf-v3_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-protobuf-v3_2.13/2.7.0" target="_blank">2.7.0</a>    BUSL-1.1
            com.typesafe    ssl-config-core_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe/ssl-config-core_2.13/0.4.3" target="_blank">0.4.3</a>    Apache-2.0
                com.typesafe    config    <a href="https://mvnrepository.com/artifact/com.typesafe/config/1.4.2" target="_blank">1.4.2</a>    Apache-2.0
                org.scala-lang.modules    scala-parser-combinators_2.13    <a href="https://mvnrepository.com/artifact/org.scala-lang.modules/scala-parser-combinators_2.13/1.1.2" target="_blank">1.1.2</a>    Apache-2.0
                    org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.10" target="_blank">2.13.10</a>    Apache-2.0
                org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.10" target="_blank">2.13.10</a>    Apache-2.0
            org.reactivestreams    reactive-streams    <a href="https://mvnrepository.com/artifact/org.reactivestreams/reactive-streams/1.0.4" target="_blank">1.0.4</a>    MIT-0
            org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.10" target="_blank">2.13.10</a>    Apache-2.0
        org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.10" target="_blank">2.13.10</a>    Apache-2.0
    com.typesafe.akka    akka-protobuf-v3_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-protobuf-v3_2.13/2.7.0" target="_blank">2.7.0</a>    BUSL-1.1
    com.typesafe.akka    akka-stream_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-stream_2.13/2.7.0" target="_blank">2.7.0</a>    BUSL-1.1
        com.typesafe.akka    akka-actor_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-actor_2.13/2.7.0" target="_blank">2.7.0</a>    BUSL-1.1
            com.typesafe    config    <a href="https://mvnrepository.com/artifact/com.typesafe/config/1.4.2" target="_blank">1.4.2</a>    Apache-2.0
            org.scala-lang.modules    scala-java8-compat_2.13    <a href="https://mvnrepository.com/artifact/org.scala-lang.modules/scala-java8-compat_2.13/1.0.0" target="_blank">1.0.0</a>    Apache-2.0
                org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.10" target="_blank">2.13.10</a>    Apache-2.0
            org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.10" target="_blank">2.13.10</a>    Apache-2.0
        com.typesafe.akka    akka-protobuf-v3_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-protobuf-v3_2.13/2.7.0" target="_blank">2.7.0</a>    BUSL-1.1
        com.typesafe    ssl-config-core_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe/ssl-config-core_2.13/0.4.3" target="_blank">0.4.3</a>    Apache-2.0
            com.typesafe    config    <a href="https://mvnrepository.com/artifact/com.typesafe/config/1.4.2" target="_blank">1.4.2</a>    Apache-2.0
            org.scala-lang.modules    scala-parser-combinators_2.13    <a href="https://mvnrepository.com/artifact/org.scala-lang.modules/scala-parser-combinators_2.13/1.1.2" target="_blank">1.1.2</a>    Apache-2.0
                org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.10" target="_blank">2.13.10</a>    Apache-2.0
            org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.10" target="_blank">2.13.10</a>    Apache-2.0
        org.reactivestreams    reactive-streams    <a href="https://mvnrepository.com/artifact/org.reactivestreams/reactive-streams/1.0.4" target="_blank">1.0.4</a>    MIT-0
        org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.10" target="_blank">2.13.10</a>    Apache-2.0
    org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.10" target="_blank">2.13.10</a>    Apache-2.0
com.typesafe.akka    akka-stream-kafka_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-stream-kafka_2.13/4.0.0" target="_blank">4.0.0</a>    BUSL-1.1
    com.typesafe.akka    akka-stream_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-stream_2.13/2.7.0" target="_blank">2.7.0</a>    BUSL-1.1
        com.typesafe.akka    akka-actor_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-actor_2.13/2.7.0" target="_blank">2.7.0</a>    BUSL-1.1
            com.typesafe    config    <a href="https://mvnrepository.com/artifact/com.typesafe/config/1.4.2" target="_blank">1.4.2</a>    Apache-2.0
            org.scala-lang.modules    scala-java8-compat_2.13    <a href="https://mvnrepository.com/artifact/org.scala-lang.modules/scala-java8-compat_2.13/1.0.0" target="_blank">1.0.0</a>    Apache-2.0
                org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.10" target="_blank">2.13.10</a>    Apache-2.0
            org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.10" target="_blank">2.13.10</a>    Apache-2.0
        com.typesafe.akka    akka-protobuf-v3_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-protobuf-v3_2.13/2.7.0" target="_blank">2.7.0</a>    BUSL-1.1
        com.typesafe    ssl-config-core_2.13    <a href="https://mvnrepository.com/artifact/com.typesafe/ssl-config-core_2.13/0.4.3" target="_blank">0.4.3</a>    Apache-2.0
            com.typesafe    config    <a href="https://mvnrepository.com/artifact/com.typesafe/config/1.4.2" target="_blank">1.4.2</a>    Apache-2.0
            org.scala-lang.modules    scala-parser-combinators_2.13    <a href="https://mvnrepository.com/artifact/org.scala-lang.modules/scala-parser-combinators_2.13/1.1.2" target="_blank">1.1.2</a>    Apache-2.0
                org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.10" target="_blank">2.13.10</a>    Apache-2.0
            org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.10" target="_blank">2.13.10</a>    Apache-2.0
        org.reactivestreams    reactive-streams    <a href="https://mvnrepository.com/artifact/org.reactivestreams/reactive-streams/1.0.4" target="_blank">1.0.4</a>    MIT-0
        org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.10" target="_blank">2.13.10</a>    Apache-2.0
    org.apache.kafka    kafka-clients    <a href="https://mvnrepository.com/artifact/org.apache.kafka/kafka-clients/3.3.1" target="_blank">3.3.1</a>    The Apache License, Version 2.0
        com.github.luben    zstd-jni    <a href="https://mvnrepository.com/artifact/com.github.luben/zstd-jni/1.5.2-1" target="_blank">1.5.2-1</a>    BSD 2-Clause License
        org.lz4    lz4-java    <a href="https://mvnrepository.com/artifact/org.lz4/lz4-java/1.8.0" target="_blank">1.8.0</a>    The Apache Software License, Version 2.0
        org.slf4j    slf4j-api    <a href="https://mvnrepository.com/artifact/org.slf4j/slf4j-api/1.7.36" target="_blank">1.7.36</a>
        org.xerial.snappy    snappy-java    <a href="https://mvnrepository.com/artifact/org.xerial.snappy/snappy-java/1.1.8.4" target="_blank">1.1.8.4</a>    Apache-2.0
    org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.10" target="_blank">2.13.10</a>    Apache-2.0
org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.13.10" target="_blank">2.13.10</a>    Apache-2.0</pre></dd>
</dl>

<h2><a href="#kafkasourceprovider" name="kafkasourceprovider" class="anchor"><span class="anchor-link"></span></a>KafkaSourceProvider</h2>

<p>A <span class="group-java"><a href="/api/akka-projection/1.3.0/akka/projection/javadsl/SourceProvider.html" title="akka.projection.javadsl.SourceProvider"><code>SourceProvider</code></a></span><span class="group-scala"><a href="/api/akka-projection/1.3.0/akka/projection/scaladsl/SourceProvider.html" title="akka.projection.scaladsl.SourceProvider"><code>SourceProvider</code></a></span> defines the source of the envelopes that the <code>Projection</code> will process. A <code>SourceProvider</code> for messages from Kafka can be defined with the <span class="group-java"><a href="/api/akka-projection/1.3.0/akka/projection/kafka/javadsl/KafkaSourceProvider$.html" title="akka.projection.kafka.javadsl.KafkaSourceProvider"><code>KafkaSourceProvider</code></a></span><span class="group-scala"><a href="/api/akka-projection/1.3.0/akka/projection/kafka/scaladsl/KafkaSourceProvider$.html" title="akka.projection.kafka.scaladsl.KafkaSourceProvider"><code>KafkaSourceProvider</code></a></span> like this:</p>

<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/scala/docs/kafka/KafkaDocExample.scala#L42-L45" target="_blank" title="Go to snippet source">source</a><code class="language-scala">import akka.kafka.ConsumerSettings
import org.apache.kafka.clients.consumer.ConsumerConfig
import org.apache.kafka.clients.consumer.ConsumerRecord
import org.apache.kafka.common.serialization.StringDeserializer
val bootstrapServers = &quot;localhost:9092&quot;
val groupId = &quot;group-wordcount&quot;
val topicName = &quot;words&quot;
val consumerSettings =
  ConsumerSettings(system, new StringDeserializer, new StringDeserializer)
    .withBootstrapServers(bootstrapServers)
    .withGroupId(groupId)
    .withProperty(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, &quot;earliest&quot;)

val sourceProvider: SourceProvider[MergeableOffset[JLong], ConsumerRecord[String, String]] =
  KafkaSourceProvider(system, consumerSettings, Set(topicName))</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/java/jdocs/kafka/KafkaDocExample.java#L37-L41" target="_blank" title="Go to snippet source">source</a><code class="language-java">import akka.kafka.ConsumerSettings;
import org.apache.kafka.clients.consumer.ConsumerConfig;
import org.apache.kafka.clients.consumer.ConsumerRecord;
import org.apache.kafka.common.serialization.StringDeserializer;

String bootstrapServers = &quot;localhost:9092&quot;;
String groupId = &quot;group-wordcount&quot;;
String topicName = &quot;words&quot;;
ConsumerSettings&lt;String, String&gt; consumerSettings =
    ConsumerSettings.create(system, new StringDeserializer(), new StringDeserializer())
        .withBootstrapServers(bootstrapServers)
        .withGroupId(groupId)
        .withProperty(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, &quot;earliest&quot;);

SourceProvider&lt;MergeableOffset&lt;Long&gt;, ConsumerRecord&lt;String, String&gt;&gt; sourceProvider =
    KafkaSourceProvider.create(system, consumerSettings, Collections.singleton(topicName));</code></pre></dd>
</dl>
<p>Please consult the <a href="https://doc.akka.io/docs/alpakka-kafka/current/consumer.html">Alpakka Kafka documentation</a> for specifics around the <code>ConsumerSettings</code>. The <code>KafkaSourceProvider</code> is using <code>Consumer.plainPartitionedManualOffsetSource</code>.</p>
<p>The <code>Projection</code> can then be defined as:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/scala/docs/kafka/KafkaDocExample.scala#L175-L183" target="_blank" title="Go to snippet source">source</a><code class="language-scala">val sessionProvider = new HibernateSessionFactory

val projectionId = ProjectionId(&quot;WordCount&quot;, &quot;wordcount-1&quot;)
val projection =
  JdbcProjection.exactlyOnce(
    projectionId,
    sourceProvider,
    () =&gt; sessionProvider.newInstance(),
    handler = () =&gt; new WordCountJdbcHandler(wordRepository))</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/java/jdocs/kafka/KafkaDocExample.java#L211-L220" target="_blank" title="Go to snippet source">source</a><code class="language-java">final HibernateSessionFactory sessionProvider = new HibernateSessionFactory();

ProjectionId projectionId = ProjectionId.of(&quot;WordCount&quot;, &quot;wordcount-1&quot;);
ExactlyOnceProjection&lt;MergeableOffset&lt;Long&gt;, ConsumerRecord&lt;String, String&gt;&gt; projection =
    JdbcProjection.exactlyOnce(
        projectionId,
        sourceProvider,
        sessionProvider::newInstance,
        () -&gt; new WordCountJdbcHandler(wordRepository),
        system);</code></pre></dd>
</dl>
<p>and the <code>WordCountJdbcHandler</code>:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/scala/docs/kafka/KafkaDocExample.scala#L187-L196" target="_blank" title="Go to snippet source">source</a><code class="language-scala">class WordCountJdbcHandler(val wordRepository: WordRepository)
    extends JdbcHandler[ConsumerRecord[String, String], HibernateJdbcSession] {

  @throws[Exception]
  override def process(session: HibernateJdbcSession, envelope: ConsumerRecord[String, String]): Unit = {
    val word = envelope.value
    wordRepository.increment(session.entityManager, word)
  }
}
</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/java/jdocs/kafka/KafkaDocExample.java#L225-L240" target="_blank" title="Go to snippet source">source</a><code class="language-java">public class WordCountJdbcHandler
    extends JdbcHandler&lt;ConsumerRecord&lt;String, String&gt;, HibernateJdbcSession&gt; {
  private Logger logger = LoggerFactory.getLogger(getClass());
  private WordRepository wordRepository;

  public WordCountJdbcHandler(WordRepository wordRepository) {
    this.wordRepository = wordRepository;
  }

  @Override
  public void process(HibernateJdbcSession session, ConsumerRecord&lt;String, String&gt; envelope)
      throws Exception {
    String word = envelope.value();
    wordRepository.increment(session.entityManager, word);
  }
}</code></pre></dd>
</dl>
<p>Where the <code>WordRepository</code> is an implementation of:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/scala/docs/kafka/KafkaDocExample.scala#L200-L202" target="_blank" title="Go to snippet source">source</a><code class="language-scala">trait WordRepository {
  def increment(entityManager: EntityManager, word: String): Unit
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/java/jdocs/kafka/KafkaDocExample.java#L244-L246" target="_blank" title="Go to snippet source">source</a><code class="language-java">interface WordRepository {
  void increment(EntityManager entityManager, String word);
}</code></pre></dd>
</dl>
<h2><a href="#committing-offset-outside-kafka" name="committing-offset-outside-kafka" class="anchor"><span class="anchor-link"></span></a>Committing offset outside Kafka</h2>
<p>The <code>KafkaSourceProvider</code> described above stores the Kafka offsets in a database. The main advantage of storing the offsets in a database is that exactly-once processing semantics can be achieved if the target database operations of the projection can be run in the same transaction as the storage of the offset.</p>
<p>However, there is a caveat when chosing for <code>exactly-once</code>. When the Kafka Consumer Group rebalance occurs it&rsquo;s possible that some messages from a revoked partitions are still in-flight and have not yet been committed to the offset store. Projections will attempt to filter out such messages, but it&rsquo;s not possible to guarantee it all the time.</p>
<p>To mitigate that risk, you can increase the value of <code>akka.projection.kafka.read-offset-delay</code> (defaults to 500ms). This delay adds a buffer of time between when the Kafka Source Provider starts up, or when it&rsquo;s assigned a new partition, to retrieve the map of partitions to offsets to give any projections running in parallel a chance to drain in-flight messages.</p>
<h2><a href="#committing-offset-in-kafka" name="committing-offset-in-kafka" class="anchor"><span class="anchor-link"></span></a>Committing offset in Kafka</h2>
<p>When using the approach of committing the offsets back to Kafka the <a href="https://doc.akka.io/docs/alpakka-kafka/current/consumer.html">Alpakka Kafka comittableSource</a> can be used, and Akka Projections is not needed for that usage.</p>
<h2><a href="#sending-to-kafka" name="sending-to-kafka" class="anchor"><span class="anchor-link"></span></a>Sending to Kafka</h2>
<p>To send events to Kafka one can use <span class="group-java"><a href="https://doc.akka.io/api/alpakka-kafka/3.1/akka/kafka/javadsl/SendProducer.html" title="akka.kafka.javadsl.SendProducer"><code>SendProducer</code></a></span><span class="group-scala"><a href="https://doc.akka.io/api/alpakka-kafka/3.1/akka/kafka/scaladsl/SendProducer.html" title="akka.kafka.scaladsl.SendProducer"><code>SendProducer</code></a></span> or <span class="group-java"><a href="https://doc.akka.io/api/alpakka-kafka/3.1/akka/kafka/javadsl/Producer$.html" title="akka.kafka.javadsl.Producer"><code>Producer.flowWithContext</code></a></span><span class="group-scala"><a href="https://doc.akka.io/api/alpakka-kafka/3.1/akka/kafka/scaladsl/Producer$.html" title="akka.kafka.scaladsl.Producer"><code>Producer.flowWithContext</code></a></span> method in Alpakka Kafka.</p>
<h3><a href="#sending-to-kafka-using-the-sendproducer" name="sending-to-kafka-using-the-sendproducer" class="anchor"><span class="anchor-link"></span></a>Sending to Kafka using the SendProducer</h3>
<p>An async <code>Handler</code> that is sending to Kafka may look like this:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/scala/docs/kafka/KafkaDocExample.scala#L111-L127" target="_blank" title="Go to snippet source">source</a><code class="language-scala">class WordPublisher(topic: String, sendProducer: SendProducer[String, String])(implicit ec: ExecutionContext)
    extends Handler[WordEnvelope] {
  private val logger = LoggerFactory.getLogger(getClass)

  override def process(envelope: WordEnvelope): Future[Done] = {
    val word = envelope.word
    // using the word as the key and `DefaultPartitioner` will select partition based on the key
    // so that same word always ends up in same partition
    val key = word
    val producerRecord = new ProducerRecord(topic, key, word)
    val result = sendProducer.send(producerRecord).map { recordMetadata =&gt;
      logger.infoN(&quot;Published word [{}] to topic/partition {}/{}&quot;, word, topic, recordMetadata.partition)
      Done
    }
    result
  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/java/jdocs/kafka/KafkaDocExample.java#L150-L180" target="_blank" title="Go to snippet source">source</a><code class="language-java">class WordPublisher extends Handler&lt;WordEnvelope&gt; {
  private final Logger logger = LoggerFactory.getLogger(getClass());
  private final String topic;
  private final SendProducer&lt;String, String&gt; sendProducer;

  public WordPublisher(String topic, SendProducer&lt;String, String&gt; sendProducer) {
    this.topic = topic;
    this.sendProducer = sendProducer;
  }

  @Override
  public CompletionStage&lt;Done&gt; process(WordEnvelope envelope) {
    String word = envelope.word;
    // using the word as the key and `DefaultPartitioner` will select partition based on the key
    // so that same word always ends up in same partition
    String key = word;
    ProducerRecord&lt;String, String&gt; producerRecord = new ProducerRecord&lt;&gt;(topic, key, word);
    CompletionStage&lt;RecordMetadata&gt; result = sendProducer.send(producerRecord);
    CompletionStage&lt;Done&gt; done =
        result.thenApply(
            recordMetadata -&gt; {
              logger.info(
                  &quot;Published word [{}] to topic/partition {}/{}&quot;,
                  word,
                  topic,
                  recordMetadata.partition());
              return Done.getInstance();
            });
    return done;
  }
}</code></pre></dd>
</dl>
<p>The <code>SendProducer</code> is constructed with:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/scala/docs/kafka/KafkaDocExample.scala#L37-L38" target="_blank" title="Go to snippet source">source</a><code class="language-scala">import org.apache.kafka.common.serialization.StringSerializer
import akka.kafka.ProducerSettings
import akka.kafka.scaladsl.SendProducer
val bootstrapServers = &quot;localhost:9092&quot;
val topicName = &quot;words&quot;
private val producerSettings =
  ProducerSettings(system, new StringSerializer, new StringSerializer)
    .withBootstrapServers(bootstrapServers)
import akka.actor.typed.scaladsl.adapter._ // FIXME might not be needed in later Alpakka Kafka version?
private val sendProducer = SendProducer(producerSettings)(system.toClassic)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/java/jdocs/kafka/KafkaDocExample.java#L45-L46" target="_blank" title="Go to snippet source">source</a><code class="language-java">import org.apache.kafka.common.serialization.StringSerializer;
import akka.kafka.ProducerSettings;
import akka.kafka.javadsl.SendProducer;

String bootstrapServers = &quot;localhost:9092&quot;;
String topicName = &quot;words&quot;;
ProducerSettings&lt;String, String&gt; producerSettings =
    ProducerSettings.create(system, new StringSerializer(), new StringSerializer())
        .withBootstrapServers(bootstrapServers);
SendProducer&lt;String, String&gt; sendProducer = new SendProducer&lt;&gt;(producerSettings, system);</code></pre></dd>
</dl>
<p>Please consult the <a href="https://doc.akka.io/docs/alpakka-kafka/current/producer.html">Alpakka Kafka documentation</a> for specifics around the <code>ProducerSettings</code> and <code>SendProducer</code>.</p>
<p>The <code>Projection</code> is defined as:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/scala/docs/kafka/KafkaDocExample.scala#L222-L233" target="_blank" title="Go to snippet source">source</a><code class="language-scala">val sourceProvider = new WordSource
val sessionProvider = new HibernateSessionFactory

val projectionId = ProjectionId(&quot;PublishWords&quot;, &quot;words&quot;)
val projection =
  JdbcProjection
    .atLeastOnceAsync(
      projectionId,
      sourceProvider,
      () =&gt; sessionProvider.newInstance(),
      handler = () =&gt; new WordPublisher(topicName, sendProducer))
</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/java/jdocs/kafka/KafkaDocExample.java#L262-L272" target="_blank" title="Go to snippet source">source</a><code class="language-java">WordSource sourceProvider = new WordSource();
HibernateSessionFactory sessionProvider = new HibernateSessionFactory();

ProjectionId projectionId = ProjectionId.of(&quot;PublishWords&quot;, &quot;words&quot;);
Projection&lt;WordEnvelope&gt; projection =
    JdbcProjection.atLeastOnceAsync(
        projectionId,
        sourceProvider,
        sessionProvider::newInstance,
        () -&gt; new WordPublisher(topicName, sendProducer),
        system);</code></pre></dd>
</dl>
<p>where the <code>SourceProvider</code> in this example is:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/scala/docs/kafka/KafkaDocExample.scala#L64-L107" target="_blank" title="Go to snippet source">source</a><code class="language-scala">type Word = String
type Count = Int
final case class WordEnvelope(offset: Long, word: Word)

class WordSource(implicit ec: ExecutionContext) extends SourceProvider[Long, WordEnvelope] {

  private val src = Source(
    List(WordEnvelope(1L, &quot;abc&quot;), WordEnvelope(2L, &quot;def&quot;), WordEnvelope(3L, &quot;ghi&quot;), WordEnvelope(4L, &quot;abc&quot;)))

  override def source(offset: () =&gt; Future[Option[Long]]): Future[Source[WordEnvelope, NotUsed]] = {
    offset()
      .map {
        case Some(o) =&gt; src.dropWhile(_.offset &lt;= o)
        case _       =&gt; src
      }
      .map(_.throttle(1, 1.second))
  }

  override def extractOffset(env: WordEnvelope): Long = env.offset

  override def extractCreationTime(env: WordEnvelope): Long = 0L
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/java/jdocs/kafka/KafkaDocExample.java#L103-L146" target="_blank" title="Go to snippet source">source</a><code class="language-java">public class WordEnvelope {
  public final Long offset;
  public final String word;

  public WordEnvelope(Long offset, String word) {
    this.offset = offset;
    this.word = word;
  }
}

class WordSource extends SourceProvider&lt;Long, WordEnvelope&gt; {

  private final Source&lt;WordEnvelope, NotUsed&gt; src =
      Source.from(
          Arrays.asList(
              new WordEnvelope(1L, &quot;abc&quot;),
              new WordEnvelope(2L, &quot;def&quot;),
              new WordEnvelope(3L, &quot;ghi&quot;),
              new WordEnvelope(4L, &quot;abc&quot;)));

  @Override
  public CompletionStage&lt;Source&lt;WordEnvelope, NotUsed&gt;&gt; source(
      Supplier&lt;CompletionStage&lt;Optional&lt;Long&gt;&gt;&gt; offset) {
    return offset
        .get()
        .thenApply(
            o -&gt; {
              if (o.isPresent())
                return src.dropWhile(envelope -&gt; envelope.offset &lt;= o.get())
                    .throttle(1, Duration.ofSeconds(1));
              else return src.throttle(1, Duration.ofSeconds(1));
            });
  }

  @Override
  public Long extractOffset(WordEnvelope envelope) {
    return envelope.offset;
  }

  @Override
  public long extractCreationTime(WordEnvelope envelope) {
    return 0L;
  }
}</code></pre></dd>
</dl>
<h3><a href="#sending-to-kafka-using-a-producer-flow" name="sending-to-kafka-using-a-producer-flow" class="anchor"><span class="anchor-link"></span></a>Sending to Kafka using a Producer Flow</h3>
<p>Alternatively, we can define the same projection using <span class="group-java"><a href="https://doc.akka.io/api/alpakka-kafka/3.1/akka/kafka/javadsl/Producer$.html" title="akka.kafka.javadsl.Producer"><code>Producer.flowWithContext</code></a></span><span class="group-scala"><a href="https://doc.akka.io/api/alpakka-kafka/3.1/akka/kafka/scaladsl/Producer$.html" title="akka.kafka.scaladsl.Producer"><code>Producer.flowWithContext</code></a></span> in combination with <code>atLeastOnceFlow</code>.</p>
<p>The <code>WordSource</code> emits <code>WordEnvelope</code>s, therefore we will build a flow that takes every single emitted <code>WordEnvelope</code> and map it into an Alpakka Kafka <span class="group-scala"><a href="https://doc.akka.io/api/alpakka-kafka/3.1/akka/kafka/ProducerMessage$.html" title="akka.kafka.ProducerMessage"><code>ProducerMessage</code></a></span><span class="group-java"><a href="https://doc.akka.io/api/alpakka-kafka/3.1/akka/kafka/ProducerMessage$.html" title="akka.kafka.ProducerMessage"><code>ProducerMessage</code></a></span>. The <code>ProducerMessage</code> factory methods can be used to produce a single message, multiple messages, or pass through a message (skip a message from being produced). The <span class="group-scala"><a href="https://doc.akka.io/api/alpakka-kafka/3.1/akka/kafka/ProducerMessage$.html" title="akka.kafka.ProducerMessage"><code>ProducerMessage</code></a></span><span class="group-java"><a href="https://doc.akka.io/api/alpakka-kafka/3.1/akka/kafka/ProducerMessage$.html" title="akka.kafka.ProducerMessage"><code>ProducerMessage</code></a></span> will pass through <span class="group-java"><a href="https://doc.akka.io/api/alpakka-kafka/3.1/akka/kafka/javadsl/Producer$.html" title="akka.kafka.javadsl.Producer"><code>Producer.flowWithContext</code></a></span><span class="group-scala"><a href="https://doc.akka.io/api/alpakka-kafka/3.1/akka/kafka/scaladsl/Producer$.html" title="akka.kafka.scaladsl.Producer"><code>Producer.flowWithContext</code></a></span> that will publish it to the Kafka Topic and finally we map the result to <code>Done</code>.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/scala/docs/kafka/KafkaDocExample.scala#L37-L38" target="_blank" title="Go to snippet source">source</a><code class="language-scala">import org.apache.kafka.common.serialization.StringSerializer
import akka.kafka.ProducerSettings
import org.apache.kafka.clients.producer.ProducerRecord
import akka.kafka.ProducerMessage
import akka.kafka.scaladsl.Producer
import akka.stream.scaladsl.FlowWithContext
import akka.projection.ProjectionContext

val bootstrapServers = &quot;localhost:9092&quot;
val topicName = &quot;words&quot;

private val producerSettings =
  ProducerSettings(system, new StringSerializer, new StringSerializer)
    .withBootstrapServers(bootstrapServers)

val producerFlow =
  FlowWithContext[WordEnvelope, ProjectionContext]
    .map(wordEnv =&gt; ProducerMessage.single(new ProducerRecord(topicName, wordEnv.word, wordEnv.word)))
    .via(Producer.flowWithContext(producerSettings))
    .map(_ =&gt; Done)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/java/jdocs/kafka/KafkaDocExample.java#L45-L46" target="_blank" title="Go to snippet source">source</a><code class="language-java">import org.apache.kafka.common.serialization.StringSerializer;
import akka.kafka.ProducerSettings;
import org.apache.kafka.clients.producer.ProducerRecord;
import akka.kafka.ProducerMessage;
import akka.kafka.javadsl.Producer;
import akka.stream.javadsl.FlowWithContext;
import akka.projection.ProjectionContext;

String bootstrapServers = &quot;localhost:9092&quot;;
String topicName = &quot;words&quot;;

ProducerSettings&lt;String, String&gt; producerSettings =
    ProducerSettings.create(system, new StringSerializer(), new StringSerializer())
        .withBootstrapServers(bootstrapServers);

FlowWithContext&lt;WordEnvelope, ProjectionContext, Done, ProjectionContext, NotUsed&gt;
    producerFlow =
        FlowWithContext.&lt;WordEnvelope, ProjectionContext&gt;create()
            .map(
                wordEnv -&gt;
                    ProducerMessage.single(
                        new ProducerRecord&lt;String, String&gt;(
                            topicName, wordEnv.word, wordEnv.word)))
            .via(Producer.flowWithContext(producerSettings))
            .map(__ -&gt; Done.getInstance());
</code></pre></dd>
</dl>
<p>The resulting flow is then used in the <code>atLeastOnceFlow</code> factory method to build the Projection.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/scala/docs/kafka/KafkaDocExample.scala#L258-L264" target="_blank" title="Go to snippet source">source</a><code class="language-scala">val sourceProvider = new WordSource
val sessionProvider = new HibernateSessionFactory

val projectionId = ProjectionId(&quot;PublishWords&quot;, &quot;words&quot;)
val projection =
  JdbcProjection
    .atLeastOnceFlow(projectionId, sourceProvider, () =&gt; sessionProvider.newInstance(), producerFlow)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/java/jdocs/kafka/KafkaDocExample.java#L301-L307" target="_blank" title="Go to snippet source">source</a><code class="language-java">WordSource sourceProvider = new WordSource();
HibernateSessionFactory sessionProvider = new HibernateSessionFactory();

ProjectionId projectionId = ProjectionId.of(&quot;PublishWords&quot;, &quot;words&quot;);
Projection&lt;WordEnvelope&gt; projection =
    JdbcProjection.atLeastOnceFlow(
        projectionId, sourceProvider, sessionProvider::newInstance, producerFlow, system);</code></pre></dd>
</dl>
<h2><a href="#mergeable-offset" name="mergeable-offset" class="anchor"><span class="anchor-link"></span></a>Mergeable Offset</h2>
<p>The offset type for a projection is determined by the <span class="group-java"><a href="/api/akka-projection/1.3.0/akka/projection/javadsl/SourceProvider.html" title="akka.projection.javadsl.SourceProvider"><code>SourceProvider</code></a></span><span class="group-scala"><a href="/api/akka-projection/1.3.0/akka/projection/scaladsl/SourceProvider.html" title="akka.projection.scaladsl.SourceProvider"><code>SourceProvider</code></a></span> that&rsquo;s used. Akka Projections supports a variety of offset types. In most cases an event is associated with a single offset row in the projection implementation&rsquo;s offset store, but the <span class="group-java"><a href="/api/akka-projection/1.3.0/akka/projection/kafka/javadsl/KafkaSourceProvider$.html" title="akka.projection.kafka.javadsl.KafkaSourceProvider"><code>KafkaSourceProvider</code></a></span><span class="group-scala"><a href="/api/akka-projection/1.3.0/akka/projection/kafka/scaladsl/KafkaSourceProvider$.html" title="akka.projection.kafka.scaladsl.KafkaSourceProvider"><code>KafkaSourceProvider</code></a></span> uses a special type of offset called a <span class="group-scala"><a href="/api/akka-projection/1.3.0/akka/projection/MergeableOffset.html" title="akka.projection.MergeableOffset"><code>MergeableOffset</code></a></span><span class="group-java"><a href="/api/akka-projection/1.3.0/akka/projection/MergeableOffset.html" title="akka.projection.MergeableOffset"><code>MergeableOffset</code></a></span>.</p>
<p><span class="group-scala"><a href="/api/akka-projection/1.3.0/akka/projection/MergeableOffset.html" title="akka.projection.MergeableOffset"><code>MergeableOffset</code></a></span><span class="group-java"><a href="/api/akka-projection/1.3.0/akka/projection/MergeableOffset.html" title="akka.projection.MergeableOffset"><code>MergeableOffset</code></a></span> allows us to read and write a map of offsets to the projection offset store. This is required because a subscription to consume from Kafka normally spans more than 1 Kafka Partition (see the <a href="https://kafka.apache.org/documentation/#intro_topics">Apache Kafka documentation</a> for more information on Kafka&rsquo;s partitioning model). To begin consuming from Kafka using offsets stored in a projection&rsquo;s offset store we must provide the Kafka Consumer with a map of topic partitions to offset map (a <span class="group-scala"><code>java.util.Map[org.apache.kafka.common.TopicPartition, java.lang.Long]</code></span><span class="group-java"><code>java.util.Map&lt;org.apache.kafka.common.TopicPartition, java.lang.Long&gt;</code></span>). The Kafka offset map is modelled as multiple rows in the projection offset table, where each row includes the projection name, a surrogate projection key that represents the Kafka topic partition, and the offset as a <code>java.lang.Long</code>. When a projection with <span class="group-java"><a href="/api/akka-projection/1.3.0/akka/projection/kafka/javadsl/KafkaSourceProvider$.html" title="akka.projection.kafka.javadsl.KafkaSourceProvider"><code>KafkaSourceProvider</code></a></span><span class="group-scala"><a href="/api/akka-projection/1.3.0/akka/projection/kafka/scaladsl/KafkaSourceProvider$.html" title="akka.projection.kafka.scaladsl.KafkaSourceProvider"><code>KafkaSourceProvider</code></a></span> is started, or when a Kafka consumer group rebalance occurs, we read all the rows from the offset table for a projection name. When an offset is committed we persist one or more rows of the Kafka offset map back to the projection offset table.</p>
<h2><a href="#configuration" name="configuration" class="anchor"><span class="anchor-link"></span></a>Configuration</h2>
<p>Make your edits/overrides in your application.conf.</p>
<p>The reference configuration file with the default values:</p>
<pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/akka-projection-kafka/src/main/resources/reference.conf#L3-L12" target="_blank" title="Go to snippet source">source</a><code class="language-conf">akka.projection.kafka {
  # The time to wait before retrieving the last saved offsets. Due to the asynchronous nature of Akka Streams, 
  # when a Kafka Consumer Group rebalance occurs it&#39;s possible that some messages from a revoked partitions 
  # are still in-flight and have not yet been committed to the offset store. Projections will attempt to 
  # filter out such messages, but it&#39;s not possible to guarantee it all the time. This delay adds a small 
  # buffer of time between when the Kafka Source Provider starts up, or when it&#39;s assigned a new partition, 
  # to retrieve the map of partitions to offsets to give any projections running in parallel a chance 
  # to drain in-flight messages.
  read-offset-delay = 500 ms
}</code></pre>
</div>
</article>
<div class="row">
<div class="small-12 column">
<section class="nav-prev-next row">
<div class="nav-prev small-6 column">
<a href="durable-state.html"><i class="icon-prev"></i> <span class="link-prev">Changes from Durable State</span></a>
</div>
<div class="nav-next small-6 column clearfix">
<a class="float-right" href="cassandra.html">Offset in Cassandra <i class="icon-next"></i></a>
</div>
</section>
</div>
</div>
<div class="source-github row">
Found an error in this documentation? The source code for this page can be found <a href="https://github.com/akka/akka-projection/tree/master/docs/src/main/paradox/kafka.md">here</a>.
Please feel free to edit and contribute a pull request.
</div>

<footer class="page-footer row clearfix">
<img class="akka-icon float-left show-for-medium" src="images/akka-icon.svg" />
<section class="copyright">
<div>Akka Projections is available under the <a href="https://www.lightbend.com/akka/license" target="_blank">Business Source License 1.1</a>.</div>
<p class="legal">
&copy; 2011-2022 <a href="https://www.lightbend.com" target="_blank">Lightbend, Inc.</a> |
<a href="https://www.lightbend.com/legal/licenses" target="_blank">Licenses</a> |
<a href="https://www.lightbend.com/legal/terms" target="_blank">Terms</a> |
<a href="https://www.lightbend.com/legal/privacy" target="_blank">Privacy Policy</a> |
<a href="https://akka.io/cookie/" target="_blank">Cookie Listing</a> |
<a class="optanon-toggle-display">Cookie Settings</a>
</p>
</section>

</footer>
</section>
</main>
</div>

<script type="text/javascript" src="js/scrollsneak.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="js/groups.js"></script>
<script type="text/javascript" src="js/page.js"></script>
<script type="text/javascript" src="js/snippets.js"></script>
<script type="text/javascript" src="js/magellan.js"></script>
<script type="text/javascript" src="js/metadata-toggle.js"></script>
<script type="text/javascript" src="js/lbHeader.js"></script>

<style type="text/css">@import "lib/prettify/prettify.css";</style>
<script type="text/javascript" src="lib/prettify/prettify.js"></script>
<script type="text/javascript" src="lib/prettify/lang-scala.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(){window.prettyPrint && prettyPrint()});
//]]></script>
<script type="text/javascript" src="assets/js/warnOldVersion.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(jq){initOldVersionWarnings(jq, '1.3.0', 'https://doc.akka.io/docs/akka-projection/current/')});
//]]></script>


</body>
</html>
