<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Running a Projection &bull; Akka Projection</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="Akka Projection."/>
<link rel="canonical" href="https://doc.akka.io/docs/akka-projection/current/running.html"/>
<script type="text/javascript" src="lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="lib/foundation/dist/js/foundation.min.js"></script>
<link rel="stylesheet" type="text/css" href="lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="lib/foundation/dist/css/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" type="text/css" href="css/icons.css"/>
<link rel="stylesheet" type="text/css" href="css/page-8.css"/>
<link rel="stylesheet" type="text/css" href="css/banner-2.css"/>
<link rel="shortcut icon" href="images/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png"/>
<link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png"/>
<link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png"/>
<link rel="manifest" href="images/manifest.json"/>
<meta name="msapplication-TileImage" content="images/mstile-150x150.png"/>
<meta name="msapplication-TileColor" content="#15a9ce"/>
<meta name="theme-color" content="#15a9ce"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) start -->
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js"  type="text/javascript" charset="UTF-8" data-domain-script="28b912e7-09e9-43d5-91e4-3d1897044004" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) end -->
<!--Google Analytics-->
<script type="text/plain" class="optanon-category-2">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', '']);
_gaq.push(['_setDomainName', '']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})()
</script>
<!-- Google Tag Manager -->
<script type="text/plain" class="optanon-category-2">
(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KBJGH35');
</script>
<!--Marketo-->
<script type="text/plain" class="optanon-category-3">
(function() {
var didInit = false;
function initMunchkin() {
if(didInit === false) {
didInit = true;
Munchkin.init('558-NCX-702', { 'asyncOnly': true, 'disableClickDelay': true });
}
}
var s = document.createElement('script');
s.type = 'text/javascript';
s.async = true;
s.src = '//munchkin.marketo.net/munchkin.js';
s.onreadystatechange = function() {
if (this.readyState == 'complete' || this.readyState == 'loaded') {
initMunchkin();
}
};
s.onload = initMunchkin;
document.getElementsByTagName('head')[0].appendChild(s);
})();
</script>
</head>

<body id="underlay" data-toggler="nav-open">
<div id="lightbend-banner" class="lightbend-banner akka full-width" data-category="OSS Lightbend Banner Impression" data-label="Akka Banner Impression">
<div class="oss-wrapper">
<div class="oss-brand">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lightbend Logo - Akka Banner" href="https://www.lightbend.com">
<img class="lightbend-logo" src="images/banner-logos/lightbend-reverse.svg" alt="Lightbend" title="Lightbend">
</a>
</div>
<div class="oss-ad no-drop-down">
<nav id="lightbendRotator" class="lightbend-rotator">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Promo Rotator - Lightbend Changed its Software Licensing Model for Akka Technology. [License FAQ] - Akka Banner" href="https://www.lightbend.com/akka/license-faq">
<strong>Lightbend</strong> Changed its Software Licensing Model for Akka Technology. <span class="akka-btn">License FAQ</span>
</a>
</nav>
</div>
</div>
</div>

<header class="site-header hide-for-large">
<div class="sticky-header clearfix">
<a href="https://akka.io"><img class="logo" src="images/akka-logo-reverse.svg"/></a>

<button class="menu-icon float-right" type="button" data-toggle="underlay overlay"></button>
</div>
<div id="overlay" class="overlay-nav" data-toggler="nav-open">
<header class="nav-header">
<div class="nav-header-title">
<h1><a href="index.html">Akka Projection</a></h1>
</div>
<div class="nav-header-version">
Version 1.4.1
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="nav-toc">
<ul>
  <li><a href="overview.html" class="page">Overview</a></li>
  <li><a href="use-cases.html" class="page">Use Cases</a></li>
  <li><a href="getting-started/index.html" class="page">Getting Started Guide</a></li>
  <li><a href="eventsourced.html" class="page">Events from Akka Persistence</a></li>
  <li><a href="durable-state.html" class="page">Changes from Durable State</a></li>
  <li><a href="kafka.html" class="page">Messages from and to Kafka</a></li>
  <li><a href="r2dbc.html" class="page">Offset in a relational DB with R2DBC</a></li>
  <li><a href="cassandra.html" class="page">Offset in Cassandra</a></li>
  <li><a href="jdbc.html" class="page">Offset in a relational DB with JDBC</a></li>
  <li><a href="slick.html" class="page">Offset in a relational DB with Slick</a></li>
  <li><a href="running.html#running-a-projection" class="active page">Running a Projection</a>
  <ul>
    <li><a href="running.html#dependencies" class="header">Dependencies</a></li>
    <li><a href="running.html#running-with-sharded-daemon-process" class="header">Running with Sharded Daemon Process</a></li>
    <li><a href="running.html#running-with-local-actor" class="header">Running with local Actor</a></li>
    <li><a href="running.html#running-in-cluster-singleton" class="header">Running in Cluster Singleton</a></li>
  </ul></li>
  <li><a href="actor.html" class="page">Processing with Actor</a></li>
  <li><a href="flow.html" class="page">Processing with Akka Streams</a></li>
  <li><a href="error.html" class="page">Error handling</a></li>
  <li><a href="projection-settings.html" class="page">Projection Settings</a></li>
  <li><a href="grpc.html" class="page">Akka Projection gRPC</a></li>
  <li><a href="grpc-replicated-event-sourcing-transport.html" class="page">Akka Replicated Event Sourcing over gRPC</a></li>
  <li><a href="management.html" class="page">Management of a Projection</a></li>
  <li><a href="testing.html" class="page">Testing</a></li>
  <li><a href="classic.html" class="page">Akka Classic</a></li>
  <li><a href="snapshots.html" class="page">Snapshots</a></li>
</ul>
</nav>
</div>
</header>
<div class="site-content-wrapper">
<aside class="sticky-sidebar show-for-large">
<header class="nav-header sticky-sidebar-header">
<div class="nav-header-title">
<h1><a href="index.html">Akka Projection</a></h1>
</div>
<div class="nav-header-version">
Version 1.4.1
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="site-nav sticky-sidebar-contents">
<div class="nav-toc">
<ul>
  <li><a href="overview.html" class="page">Overview</a></li>
  <li><a href="use-cases.html" class="page">Use Cases</a></li>
  <li><a href="getting-started/index.html" class="page">Getting Started Guide</a></li>
  <li><a href="eventsourced.html" class="page">Events from Akka Persistence</a></li>
  <li><a href="durable-state.html" class="page">Changes from Durable State</a></li>
  <li><a href="kafka.html" class="page">Messages from and to Kafka</a></li>
  <li><a href="r2dbc.html" class="page">Offset in a relational DB with R2DBC</a></li>
  <li><a href="cassandra.html" class="page">Offset in Cassandra</a></li>
  <li><a href="jdbc.html" class="page">Offset in a relational DB with JDBC</a></li>
  <li><a href="slick.html" class="page">Offset in a relational DB with Slick</a></li>
  <li><a href="running.html#running-a-projection" class="active page">Running a Projection</a>
  <ul>
    <li><a href="running.html#dependencies" class="header">Dependencies</a></li>
    <li><a href="running.html#running-with-sharded-daemon-process" class="header">Running with Sharded Daemon Process</a></li>
    <li><a href="running.html#running-with-local-actor" class="header">Running with local Actor</a></li>
    <li><a href="running.html#running-in-cluster-singleton" class="header">Running in Cluster Singleton</a></li>
  </ul></li>
  <li><a href="actor.html" class="page">Processing with Actor</a></li>
  <li><a href="flow.html" class="page">Processing with Akka Streams</a></li>
  <li><a href="error.html" class="page">Error handling</a></li>
  <li><a href="projection-settings.html" class="page">Projection Settings</a></li>
  <li><a href="grpc.html" class="page">Akka Projection gRPC</a></li>
  <li><a href="grpc-replicated-event-sourcing-transport.html" class="page">Akka Replicated Event Sourcing over gRPC</a></li>
  <li><a href="management.html" class="page">Management of a Projection</a></li>
  <li><a href="testing.html" class="page">Testing</a></li>
  <li><a href="classic.html" class="page">Akka Classic</a></li>
  <li><a href="snapshots.html" class="page">Snapshots</a></li>
</ul>
</div>
</nav>
<footer class="nav-footer sticky-sidebar-footer">
<a href="https://akka.io"><img class="logo" src="images/akka-logo-reverse.svg"/></a>

</footer>
</aside>
<main class="fixed-shift-for-large expanded row">
<section class="site-content small-12 column">
<article class="page-content row">
<div class="small-12 column" id="docs">
<h1><a href="#running-a-projection" name="running-a-projection" class="anchor"><span class="anchor-link"></span></a>Running a Projection</h1>
<p>Once you have decided how you want to build your projection, the next step is to run it. Typically, you run it in a distributed fashion in order to spread the load over the different nodes in an Akka Cluster. However, it&rsquo;s also possible to run it as a single instance (when not clustered) or as single instance in a Cluster Singleton.</p>
<h2><a href="#dependencies" name="dependencies" class="anchor"><span class="anchor-link"></span></a>Dependencies</h2>
<p>To distribute the projection over the cluster we recommend the use of <a href="https://doc.akka.io/docs/akka/current/typed/cluster-sharded-daemon-process.html">ShardedDaemonProcess</a>. Add the following dependency in your project if not yet using Akka Cluster Sharding:</p><dl class="dependency"><dt>sbt</dt><dd><pre class="prettyprint"><code class="language-scala">libraryDependencies += "com.typesafe.akka" %% "akka-cluster-sharding-typed" % "2.8.1"</code></pre></dd><dt>Maven</dt><dd><pre class="prettyprint"><code class="language-xml">&lt;properties&gt;
  &lt;scala.binary.version&gt;2.13&lt;/scala.binary.version&gt;
&lt;/properties&gt;
&lt;dependencies&gt
  &lt;dependency&gt;
    &lt;groupId&gt;com.typesafe.akka&lt;/groupId&gt;
    &lt;artifactId&gt;akka-cluster-sharding-typed_${scala.binary.version}&lt;/artifactId&gt;
    &lt;version&gt;2.8.1&lt;/version&gt;
  &lt;/dependency&gt
&lt;/dependencies&gt;</code></pre></dd><dt>Gradle</dt><dd><pre class="prettyprint"><code class="language-gradle">def versions = [
  ScalaBinary: "2.13"
]
dependencies {
  implementation "com.typesafe.akka:akka-cluster-sharding-typed_${versions.ScalaBinary}:2.8.1"
}</code></pre></dd></dl>
<p>Akka Projections require Akka 2.8.1 or later, see <a href="overview.html#akka-version">Akka version</a>.</p>
<p>For more information on using Akka Cluster consult Akka&rsquo;s reference documentation on <a href="https://doc.akka.io/docs/akka/current/typed/index-cluster.html">Akka Cluster</a> and <a href="https://doc.akka.io/docs/akka/current/typed/cluster-sharding.html">Akka Cluster Sharding</a>.</p>
<h2><a href="#running-with-sharded-daemon-process" name="running-with-sharded-daemon-process" class="anchor"><span class="anchor-link"></span></a>Running with Sharded Daemon Process</h2>
<p>The Sharded Daemon Process can be used to distribute <code>n</code> instances of a given Projection across the cluster. Therefore, it&rsquo;s important that each Projection instance consumes a subset of the stream of envelopes.</p>
<p>How the subset is created depends on the kind of source we consume. If it&rsquo;s an Alpakka Kafka source, this is done by Kafka consumer groups. When consuming from Akka Persistence Journal, the events must be partitioned by tagging them as demonstrated in the example below, or by the built-in slices in <a href="r2dbc.html#slices">Projections R2DBC</a>.</p>
<h3><a href="#tagging-events-in-eventsourcedbehavior" name="tagging-events-in-eventsourcedbehavior" class="anchor"><span class="anchor-link"></span></a>Tagging Events in EventSourcedBehavior</h3>
<p>Before we can consume the events, the <code>EventSourcedBehavior</code> must tag the events with a slice number.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/scala/docs/eventsourced/ShoppingCart.scala#L21-L25" target="_blank" title="Go to snippet source">source</a><code class="language-scala">import akka.actor.typed.ActorSystem
import akka.cluster.sharding.typed.scaladsl.ClusterSharding
import akka.cluster.sharding.typed.scaladsl.Entity
import akka.cluster.sharding.typed.scaladsl.EntityTypeKey

val tags = Vector.tabulate(5)(i =&gt; s&quot;carts-$i&quot;)
val EntityKey: EntityTypeKey[Command] = EntityTypeKey[Command](&quot;ShoppingCart&quot;)

def init(system: ActorSystem[_]): Unit = {
  ClusterSharding(system).init(Entity(EntityKey) { entityContext =&gt;
    val i = math.abs(entityContext.entityId.hashCode % tags.size)
    val selectedTag = tags(i)
    ShoppingCart(entityContext.entityId, selectedTag)
  }.withRole(&quot;write-model&quot;))
}

def apply(cartId: String, projectionTag: String): Behavior[Command] = {
  EventSourcedBehavior
    .withEnforcedReplies[Command, Event, State](
      PersistenceId(EntityKey.name, cartId),
      State.empty,
      (state, command) =&gt;
        //The shopping cart behavior changes if it&#39;s checked out or not.
        // The commands are handled differently for each case.
        if (state.isCheckedOut) checkedOutShoppingCart(cartId, state, command)
        else openShoppingCart(cartId, state, command),
      (state, event) =&gt; handleEvent(state, event))
    .withTagger(_ =&gt; Set(projectionTag))
    .withRetention(RetentionCriteria.snapshotEvery(numberOfEvents = 100))
    .onPersistFailure(SupervisorStrategy.restartWithBackoff(200.millis, 5.seconds, 0.1))
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/java/jdocs/eventsourced/ShoppingCart.java#L308-L310" target="_blank" title="Go to snippet source">source</a><code class="language-java">public static final List&lt;String&gt; tags =
    Collections.unmodifiableList(
        Arrays.asList(&quot;carts-0&quot;, &quot;carts-1&quot;, &quot;carts-2&quot;, &quot;carts-3&quot;, &quot;carts-4&quot;));
@Override
public Set&lt;String&gt; tagsFor(Event event) {
  int n = Math.abs(cartId.hashCode() % tags.size());
  String selectedTag = tags.get(n);
  return Collections.singleton(selectedTag);
}</code></pre></dd>
</dl>
<p>In the above example, we created a <span class="group-scala"><code>Vector[String]</code></span><span class="group-java"><code>List&lt;String&gt;</code></span> of tags from <em>carts-0</em> to <em>carts-4</em>. Each entity instance will tag its events using one of those tags. The tag is selected based on the modulo of the entity id&rsquo;s hash code (stable identifier) and the total number of tags. As a matter of fact, this will create a journal sliced with different tags (ie: from <em>carts-0</em> to <em>carts-4</em>). <span class="group-scala">Note the <code>.withTagger</code> in the initialization of the <code>EventSourcedBehavior</code>.</span></p>
<p>The number of tags should be more than the number of nodes that you want to distribute the load over. It&rsquo;s not easy to change this afterwards without system downtime. Fewer tags than the number of nodes will result in not hosting a Projection instance on some nodes. More tags than the number of nodes means that each node is hosting more than one Projection instance, which is fine. It&rsquo;s good to start with more tags than nodes to have some room for scaling out to more nodes later if needed. As a rule of thumb, the number of tags should be a factor of ten greater than the planned maximum number of cluster nodes. It doesn&rsquo;t have to be exact.</p><div class="callout note "><div class="callout-title">Note</div>
<p>When using slices with <a href="r2dbc.html#slices">Projections R2DBC</a> it is possible to dynamically change the number of projection instances at runtime.</p></div>
<p>We will use those tags to query the journal and create as many Projections instances, and distribute them in the cluster.</p><div class="callout warning "><div class="callout-title">Warning</div>
<p>When using <a href="https://doc.akka.io/docs/akka-persistence-cassandra/current/">Akka Persistence Cassandra plugin</a> you should not use too many tags for each event. Each tag will result in a copy of the event in a separate table and that can impact write performance. Typically, you would use 1 tag per event as illustrated here. Additional filtering of events can be done in the Projection handler if it doesn&rsquo;t have to act on certain events. The <a href="https://doc.akka.io/docs/akka-persistence-jdbc/current/">JDBC plugin</a> don&rsquo;t have this constraint.</p></div>
<p>See also the <a href="https://doc.akka.io/docs/akka/current/typed/persistence.html#tagging">Akka reference documentation for tagging</a>.</p>
<h3><a href="#event-sourced-provider-per-tag" name="event-sourced-provider-per-tag" class="anchor"><span class="anchor-link"></span></a>Event Sourced Provider per tag</h3>
<p>We can use the <a href="eventsourced.html">EventSourcedProvider</a> to consume the <code>ShoppingCart</code> events.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/it/scala/docs/cassandra/CassandraProjectionDocExample.scala#L20-L23" target="_blank" title="Go to snippet source">source</a><code class="language-scala">import akka.persistence.cassandra.query.scaladsl.CassandraReadJournal
import akka.projection.eventsourced.scaladsl.EventSourcedProvider
import docs.eventsourced.ShoppingCart

def sourceProvider(tag: String) =
  EventSourcedProvider
    .eventsByTag[ShoppingCart.Event](
      system = system,
      readJournalPluginId = CassandraReadJournal.Identifier,
      tag = tag)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/it/java/jdocs/cassandra/CassandraProjectionDocExample.java#L32-L37" target="_blank" title="Go to snippet source">source</a><code class="language-java">import akka.persistence.cassandra.query.javadsl.CassandraReadJournal;
import akka.persistence.query.Offset;
import akka.projection.javadsl.SourceProvider;
import akka.projection.eventsourced.javadsl.EventSourcedProvider;
import akka.projection.eventsourced.EventEnvelope;

SourceProvider&lt;Offset, EventEnvelope&lt;ShoppingCart.Event&gt;&gt; sourceProvider(String tag) {
  return EventSourcedProvider.eventsByTag(system, CassandraReadJournal.Identifier(), tag);
}</code></pre></dd>
</dl>
<p>Note that we define a method that builds a new <code>SourceProvider</code> for each passed <code>tag</code>.</p>
<h3><a href="#building-the-projection-instances" name="building-the-projection-instances" class="anchor"><span class="anchor-link"></span></a>Building the Projection instances</h3>
<p>Next we create a method to return Projection instances. Again, we pass a tag that is used to initialize the <code>SourceProvider</code> and as the key in <code>ProjectionId</code>.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/it/scala/docs/cassandra/CassandraProjectionDocExample.scala#L27-L29" target="_blank" title="Go to snippet source">source</a><code class="language-scala">import akka.projection.ProjectionId
import akka.projection.cassandra.scaladsl.CassandraProjection

def projection(tag: String) =
  CassandraProjection
    .atLeastOnce(
      projectionId = ProjectionId(&quot;shopping-carts&quot;, tag),
      sourceProvider(tag),
      handler = () =&gt; new ShoppingCartHandler)
    .withSaveOffset(100, 500.millis)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/it/java/jdocs/cassandra/CassandraProjectionDocExample.java#L41-L44" target="_blank" title="Go to snippet source">source</a><code class="language-java">import akka.projection.cassandra.javadsl.CassandraProjection;
import akka.projection.Projection;
import akka.projection.ProjectionId;

int saveOffsetAfterEnvelopes = 100;
Duration saveOffsetAfterDuration = Duration.ofMillis(500);

Projection&lt;EventEnvelope&lt;ShoppingCart.Event&gt;&gt; projection(String tag) {
  return CassandraProjection.atLeastOnce(
          ProjectionId.of(&quot;shopping-carts&quot;, tag), sourceProvider(tag), ShoppingCartHandler::new)
      .withSaveOffset(saveOffsetAfterEnvelopes, saveOffsetAfterDuration);
}</code></pre></dd>
</dl>
<h3><a href="#initializing-the-sharded-daemon" name="initializing-the-sharded-daemon" class="anchor"><span class="anchor-link"></span></a>Initializing the Sharded Daemon</h3>
<p>Once we have the tags, the <code>SourceProvider</code> and the <code>Projection</code> of our choice, we can glue all the pieces together using the Sharded Daemon Process and let it be distributed across the cluster.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/it/scala/docs/cassandra/CassandraProjectionDocExample.scala#L14-L16" target="_blank" title="Go to snippet source">source</a><code class="language-scala">import akka.cluster.sharding.typed.scaladsl.ShardedDaemonProcess
import akka.projection.ProjectionBehavior

ShardedDaemonProcess(system).init[ProjectionBehavior.Command](
  name = &quot;shopping-carts&quot;,
  numberOfInstances = ShoppingCart.tags.size,
  behaviorFactory = (i: Int) =&gt; ProjectionBehavior(projection(ShoppingCart.tags(i))),
  stopMessage = ProjectionBehavior.Stop)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/it/java/jdocs/cassandra/CassandraProjectionDocExample.java#L20-L22" target="_blank" title="Go to snippet source">source</a><code class="language-java">import akka.cluster.sharding.typed.javadsl.ShardedDaemonProcess;
import akka.projection.ProjectionBehavior;

ShardedDaemonProcess.get(system)
    .init(
        ProjectionBehavior.Command.class,
        &quot;shopping-carts&quot;,
        ShoppingCart.tags.size(),
        id -&gt; ProjectionBehavior.create(projection(ShoppingCart.tags.get((Integer) id))),
        ProjectionBehavior.stopMessage());</code></pre></dd>
</dl>
<p>For this example, we configure as many <code>ShardedDaemonProcess</code> as tags and we define the behavior factory to return <code>ProjectionBehavior</code> wrapping each time a different <code>Projection</code> instance. Finally, the <code>ShardedDaemon</code> is configured to use the <code>ProjectionBehavior.Stop</code> as its control stop message.</p>
<p>For graceful stop it is recommended to use <span class="group-scala"><code>ProjectionBehavior.Stop</code></span><span class="group-java"><code>ProjectionBehavior.stop()</code></span> message.</p>
<h3><a href="#projection-behavior" name="projection-behavior" class="anchor"><span class="anchor-link"></span></a>Projection Behavior</h3>
<p>The <code>ProjectionBehavior</code> is an Actor <code>Behavior</code> that knows how to manage the Projection lifecyle. The Projection starts to consume the events as soon as the actor is spawned and will restart the source in case of failures (see <a href="projection-settings.html">Projection Settings</a>).</p>
<p>For graceful stop it is recommended to use <span class="group-scala"><code>ProjectionBehavior.Stop</code></span><span class="group-java"><code>ProjectionBehavior.stop()</code></span> message.</p>
<h2><a href="#running-with-local-actor" name="running-with-local-actor" class="anchor"><span class="anchor-link"></span></a>Running with local Actor</h2>
<p>You can spawn the <code>ProjectionBehavior</code> as any other <code>Behavior</code>. This can be useful for testing or when running a local <code>ActorSystem</code> without Akka Cluster.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/it/scala/docs/cassandra/CassandraProjectionDocExample.scala#L206-L222" target="_blank" title="Go to snippet source">source</a><code class="language-scala">def sourceProvider(tag: String) =
  EventSourcedProvider
    .eventsByTag[ShoppingCart.Event](
      system = system,
      readJournalPluginId = CassandraReadJournal.Identifier,
      tag = tag)

def projection(tag: String) =
  CassandraProjection
    .atLeastOnce(
      projectionId = ProjectionId(&quot;shopping-carts&quot;, tag),
      sourceProvider(tag),
      handler = () =&gt; new ShoppingCartHandler)

val projection1 = projection(&quot;carts-1&quot;)

context.spawn(ProjectionBehavior(projection1), projection1.projectionId.id)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/it/java/jdocs/cassandra/CassandraProjectionDocExample.java#L292-L304" target="_blank" title="Go to snippet source">source</a><code class="language-java">SourceProvider&lt;Offset, EventEnvelope&lt;ShoppingCart.Event&gt;&gt; sourceProvider(String tag) {
  return EventSourcedProvider.eventsByTag(system, CassandraReadJournal.Identifier(), tag);
}

Projection&lt;EventEnvelope&lt;ShoppingCart.Event&gt;&gt; projection(String tag) {
  return CassandraProjection.atLeastOnce(
      ProjectionId.of(&quot;shopping-carts&quot;, tag), sourceProvider(tag), ShoppingCartHandler::new);
}

Projection&lt;EventEnvelope&lt;ShoppingCart.Event&gt;&gt; projection1 = projection(&quot;carts-1&quot;);

ActorRef&lt;ProjectionBehavior.Command&gt; projection1Ref =
    context.spawn(ProjectionBehavior.create(projection1), projection1.projectionId().id());</code></pre></dd>
</dl>
<p>Be aware of that the projection and its offset storage is based on the <code>ProjectionId</code>. If more than one instance with the same <code>ProjectionId</code> are running concurrently they will overwrite each others offset storage with undefined and unpredictable results.</p>
<h2><a href="#running-in-cluster-singleton" name="running-in-cluster-singleton" class="anchor"><span class="anchor-link"></span></a>Running in Cluster Singleton</h2>
<p>If you know that you only need one or a few projection instances an alternative to <a href="running.html#running-with-sharded-daemon-process">Sharded Daemon Process</a> is to use <a href="https://doc.akka.io/docs/akka/current/typed/cluster-singleton.html">Akka Cluster Singleton</a> </p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/it/scala/docs/cassandra/CassandraProjectionDocExample.scala#L232-L253" target="_blank" title="Go to snippet source">source</a><code class="language-scala">import akka.cluster.typed.ClusterSingleton
import akka.cluster.typed.SingletonActor

def sourceProvider(tag: String) =
  EventSourcedProvider
    .eventsByTag[ShoppingCart.Event](
      system = system,
      readJournalPluginId = CassandraReadJournal.Identifier,
      tag = tag)

def projection(tag: String) =
  CassandraProjection
    .atLeastOnce(
      projectionId = ProjectionId(&quot;shopping-carts&quot;, tag),
      sourceProvider(tag),
      handler = () =&gt; new ShoppingCartHandler)

val projection1 = projection(&quot;carts-1&quot;)

ClusterSingleton(system).init(
  SingletonActor(ProjectionBehavior(projection1), projection1.projectionId.id)
    .withStopMessage(ProjectionBehavior.Stop))</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/it/java/jdocs/cassandra/CassandraProjectionDocExample.java#L26-L28" target="_blank" title="Go to snippet source">source</a><code class="language-java">import akka.cluster.typed.ClusterSingleton;
import akka.cluster.typed.SingletonActor;

SourceProvider&lt;Offset, EventEnvelope&lt;ShoppingCart.Event&gt;&gt; sourceProvider(String tag) {
  return EventSourcedProvider.eventsByTag(system, CassandraReadJournal.Identifier(), tag);
}

Projection&lt;EventEnvelope&lt;ShoppingCart.Event&gt;&gt; projection(String tag) {
  return CassandraProjection.atLeastOnce(
      ProjectionId.of(&quot;shopping-carts&quot;, tag), sourceProvider(tag), ShoppingCartHandler::new);
}

Projection&lt;EventEnvelope&lt;ShoppingCart.Event&gt;&gt; projection1 = projection(&quot;carts-1&quot;);

ActorRef&lt;ProjectionBehavior.Command&gt; projection1Ref =
    ClusterSingleton.get(system)
        .init(
            SingletonActor.of(
                ProjectionBehavior.create(projection1), projection1.projectionId().id())
                .withStopMessage(ProjectionBehavior.stopMessage()));</code></pre></dd>
</dl>
<p>Be aware of that all projection instances that are running with Cluster Singleton will be running on the same node in the Cluster.</p>
</div>
</article>
<div class="row">
<div class="small-12 column">
<section class="nav-prev-next row">
<div class="nav-prev small-6 column">
<a href="slick.html"><i class="icon-prev"></i> <span class="link-prev">Offset in a relational DB with Slick</span></a>
</div>
<div class="nav-next small-6 column clearfix">
<a class="float-right" href="actor.html">Processing with Actor <i class="icon-next"></i></a>
</div>
</section>
</div>
</div>
<div class="source-github row">
Found an error in this documentation? The source code for this page can be found <a href="https://github.com/akka/akka-projection/tree/master/docs/src/main/paradox/running.md">here</a>.
Please feel free to edit and contribute a pull request.
</div>

<footer class="page-footer row clearfix">
<img class="akka-icon float-left show-for-medium" src="images/akka-icon.svg" />
<section class="copyright">
<div>Akka Projections is available under the <a href="https://www.lightbend.com/akka/license" target="_blank">Business Source License 1.1</a>.</div>
<p class="legal">
&copy; 2011-2023 <a href="https://www.lightbend.com" target="_blank">Lightbend, Inc.</a> |
<a href="https://www.lightbend.com/legal/licenses" target="_blank">Licenses</a> |
<a href="https://www.lightbend.com/legal/terms" target="_blank">Terms</a> |
<a href="https://www.lightbend.com/legal/privacy" target="_blank">Privacy Policy</a> |
<a href="https://akka.io/cookie/" target="_blank">Cookie Listing</a> |
<a class="optanon-toggle-display">Cookie Settings</a>
</p>
</section>

</footer>
</section>
</main>
</div>

<script type="text/javascript" src="js/scrollsneak.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="js/groups.js"></script>
<script type="text/javascript" src="js/page.js"></script>
<script type="text/javascript" src="js/snippets.js"></script>
<script type="text/javascript" src="js/magellan.js"></script>
<script type="text/javascript" src="js/metadata-toggle.js"></script>
<script type="text/javascript" src="js/lbHeader.js"></script>

<style type="text/css">@import "lib/prettify/prettify.css";</style>
<script type="text/javascript" src="lib/prettify/prettify.js"></script>
<script type="text/javascript" src="lib/prettify/lang-scala.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(){window.prettyPrint && prettyPrint()});
//]]></script>
<script type="text/javascript" src="assets/js/warnOldVersion.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(jq){initOldVersionWarnings(jq, '1.4.1', 'https://doc.akka.io/docs/akka-projection/current/')});
//]]></script>


</body>
</html>
