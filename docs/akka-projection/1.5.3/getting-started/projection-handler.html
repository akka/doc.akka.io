<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Build a Projection handler &bull; Akka Projection</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="Akka Projection."/>
<link rel="canonical" href="https://doc.akka.io/docs/akka-projection/current/getting-started/projection-handler.html"/>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../lib/foundation/dist/js/foundation.min.js"></script>
<link rel="stylesheet" type="text/css" href="../lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="../lib/foundation/dist/css/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" type="text/css" href="../css/icons.css"/>
<link rel="stylesheet" type="text/css" href="../css/page-8.css"/>
<link rel="stylesheet" type="text/css" href="../css/banner-2.css"/>
<link rel="shortcut icon" href="../images/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="../images/apple-touch-icon.png"/>
<link rel="icon" type="image/png" sizes="32x32" href="../images/favicon-32x32.png"/>
<link rel="icon" type="image/png" sizes="16x16" href="../images/favicon-16x16.png"/>
<link rel="manifest" href="../images/manifest.json"/>
<meta name="msapplication-TileImage" content="../images/mstile-150x150.png"/>
<meta name="msapplication-TileColor" content="#15a9ce"/>
<meta name="theme-color" content="#15a9ce"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) start -->
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js"  type="text/javascript" charset="UTF-8" data-domain-script="28b912e7-09e9-43d5-91e4-3d1897044004" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) end -->
<!-- Google Tag Manager now loads Google Analytics and any other tracking scripts. GTM also performs respects a users cookie choices-->
<script type="text/javascript">
(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KBJGH35');
</script>

</head>

<body id="underlay" data-toggler="nav-open">
<div id="lightbend-banner" class="lightbend-banner akka full-width" data-category="OSS Lightbend Banner Impression" data-label="Akka Banner Impression">
<div class="oss-wrapper">
<div class="oss-brand">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lightbend Logo - Akka Banner" href="https://www.lightbend.com">
<img class="lightbend-logo" src="../images/banner-logos/lightbend-reverse.svg" alt="Lightbend" title="Lightbend">
</a>
</div>
<div class="oss-ad no-drop-down">
<nav id="lightbendRotator" class="lightbend-rotator">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Promo Rotator - Introducing Akka Cloud to Edge Continuum. Build once for the Cloud. Seamlessly deploy to the Edge. [Learn more] - Akka Banner" href="https://www.lightbend.com/blog/akka-edge-unifying-the-cloud-and-edge">
Introducing Akka Cloud to Edge Continuum. Build once for the Cloud. Seamlessly deploy to the Edge. <span class="akka-btn">Learn more</span>
</a>
</nav>
</div>
</div>
</div>

<header class="site-header hide-for-large">
<div class="sticky-header clearfix">
<a href="https://akka.io"><img class="logo" src="../images/akka-logo-reverse.svg"/></a>

<button class="menu-icon float-right" type="button" data-toggle="underlay overlay"></button>
</div>
<div id="overlay" class="overlay-nav" data-toggler="nav-open">
<header class="nav-header">
<div class="nav-header-title">
<h1><a href="../index.html">Akka Projection</a></h1>
</div>
<div class="nav-header-version">
Version 1.5.3
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="nav-toc">
<ul>
  <li><a href="../overview.html" class="page">Overview</a></li>
  <li><a href="../use-cases.html" class="page">Use Cases</a></li>
  <li><a href="../getting-started/index.html" class="page">Getting Started Guide</a>
  <ul>
    <li><a href="../getting-started/index.html#video-introduction" class="header">Video Introduction</a></li>
    <li><a href="../getting-started/setup-your-app.html" class="page">Setup your application</a></li>
    <li><a href="../getting-started/source-provider.html" class="page">Choosing a Source Provider</a></li>
    <li><a href="../getting-started/projection-handler.html#build-a-projection-handler" class="active page">Build a Projection handler</a></li>
    <li><a href="../getting-started/testing.html" class="page">Writing tests for a Projection</a></li>
    <li><a href="../getting-started/running.html" class="page">Running the Projection</a></li>
    <li><a href="../getting-started/running-cluster.html" class="page">Running the Projection in Akka Cluster</a></li>
  </ul></li>
  <li><a href="../eventsourced.html" class="page">Events from Akka Persistence</a></li>
  <li><a href="../durable-state.html" class="page">Changes from Durable State</a></li>
  <li><a href="../kafka.html" class="page">Messages from and to Kafka</a></li>
  <li><a href="../r2dbc.html" class="page">Offset in a relational DB with R2DBC</a></li>
  <li><a href="../cassandra.html" class="page">Offset in Cassandra</a></li>
  <li><a href="../jdbc.html" class="page">Offset in a relational DB with JDBC</a></li>
  <li><a href="../slick.html" class="page">Offset in a relational DB with Slick</a></li>
  <li><a href="../running.html" class="page">Running a Projection</a></li>
  <li><a href="../actor.html" class="page">Processing with Actor</a></li>
  <li><a href="../flow.html" class="page">Processing with Akka Streams</a></li>
  <li><a href="../error.html" class="page">Error handling</a></li>
  <li><a href="../projection-settings.html" class="page">Projection Settings</a></li>
  <li><a href="../grpc.html" class="page">Akka Projection gRPC</a></li>
  <li><a href="../grpc-producer-push.html" class="page">Akka Projection gRPC with producer push</a></li>
  <li><a href="../grpc-replicated-event-sourcing-transport.html" class="page">Akka Replicated Event Sourcing over gRPC</a></li>
  <li><a href="../management.html" class="page">Management of a Projection</a></li>
  <li><a href="../testing.html" class="page">Testing</a></li>
  <li><a href="../classic.html" class="page">Akka Classic</a></li>
  <li><a href="../snapshots.html" class="page">Snapshots</a></li>
</ul>
</nav>
</div>
</header>
<div class="site-content-wrapper">
<aside class="sticky-sidebar show-for-large">
<header class="nav-header sticky-sidebar-header">
<div class="nav-header-title">
<h1><a href="../index.html">Akka Projection</a></h1>
</div>
<div class="nav-header-version">
Version 1.5.3
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="site-nav sticky-sidebar-contents">
<div class="nav-toc">
<ul>
  <li><a href="../overview.html" class="page">Overview</a></li>
  <li><a href="../use-cases.html" class="page">Use Cases</a></li>
  <li><a href="../getting-started/index.html" class="page">Getting Started Guide</a>
  <ul>
    <li><a href="../getting-started/index.html#video-introduction" class="header">Video Introduction</a></li>
    <li><a href="../getting-started/setup-your-app.html" class="page">Setup your application</a></li>
    <li><a href="../getting-started/source-provider.html" class="page">Choosing a Source Provider</a></li>
    <li><a href="../getting-started/projection-handler.html#build-a-projection-handler" class="active page">Build a Projection handler</a></li>
    <li><a href="../getting-started/testing.html" class="page">Writing tests for a Projection</a></li>
    <li><a href="../getting-started/running.html" class="page">Running the Projection</a></li>
    <li><a href="../getting-started/running-cluster.html" class="page">Running the Projection in Akka Cluster</a></li>
  </ul></li>
  <li><a href="../eventsourced.html" class="page">Events from Akka Persistence</a></li>
  <li><a href="../durable-state.html" class="page">Changes from Durable State</a></li>
  <li><a href="../kafka.html" class="page">Messages from and to Kafka</a></li>
  <li><a href="../r2dbc.html" class="page">Offset in a relational DB with R2DBC</a></li>
  <li><a href="../cassandra.html" class="page">Offset in Cassandra</a></li>
  <li><a href="../jdbc.html" class="page">Offset in a relational DB with JDBC</a></li>
  <li><a href="../slick.html" class="page">Offset in a relational DB with Slick</a></li>
  <li><a href="../running.html" class="page">Running a Projection</a></li>
  <li><a href="../actor.html" class="page">Processing with Actor</a></li>
  <li><a href="../flow.html" class="page">Processing with Akka Streams</a></li>
  <li><a href="../error.html" class="page">Error handling</a></li>
  <li><a href="../projection-settings.html" class="page">Projection Settings</a></li>
  <li><a href="../grpc.html" class="page">Akka Projection gRPC</a></li>
  <li><a href="../grpc-producer-push.html" class="page">Akka Projection gRPC with producer push</a></li>
  <li><a href="../grpc-replicated-event-sourcing-transport.html" class="page">Akka Replicated Event Sourcing over gRPC</a></li>
  <li><a href="../management.html" class="page">Management of a Projection</a></li>
  <li><a href="../testing.html" class="page">Testing</a></li>
  <li><a href="../classic.html" class="page">Akka Classic</a></li>
  <li><a href="../snapshots.html" class="page">Snapshots</a></li>
</ul>
</div>
</nav>
<footer class="nav-footer sticky-sidebar-footer">
<a href="https://akka.io"><img class="logo" src="../images/akka-logo-reverse.svg"/></a>

</footer>
</aside>
<main class="fixed-shift-for-large expanded row">
<section class="site-content small-12 column">
<article class="page-content row">
<div class="small-12 column" id="docs">
<h1><a href="#build-a-projection-handler" name="build-a-projection-handler" class="anchor"><span class="anchor-link"></span></a>Build a Projection handler</h1>
<p>While building a projection there are several non-functional requirements to consider. <em>What technology to project into? What message delivery semantics are acceptable for the system? Is it compatible with the chosen Source Provider to enable exactly-once message delivery? Does runtime state need to be maintained in the projection while it&rsquo;s running?</em> It&rsquo;s up to the user to choose the right answers to these questions, but you must research if the answers to these questions are compatible with each other.</p>
<p>In this guide we will create a Projection that represents shopping cart item popularity. We will persist our Projection to Cassandra with at-least-once semantics. The Projection itself will be represented as a Cassandra table.</p>
<p>To proceed we must add the Cassandra Projection library to our project:</p><dl class="dependency"><dt>sbt</dt><dd><pre class="prettyprint"><code class="language-scala">libraryDependencies += "com.lightbend.akka" %% "akka-projection-cassandra" % "1.5.3"</code></pre></dd><dt>Maven</dt><dd><pre class="prettyprint"><code class="language-xml">&lt;properties&gt;
  &lt;scala.binary.version&gt;2.13&lt;/scala.binary.version&gt;
&lt;/properties&gt;
&lt;dependencies&gt
  &lt;dependency&gt;
    &lt;groupId&gt;com.lightbend.akka&lt;/groupId&gt;
    &lt;artifactId&gt;akka-projection-cassandra_${scala.binary.version}&lt;/artifactId&gt;
    &lt;version&gt;1.5.3&lt;/version&gt;
  &lt;/dependency&gt
&lt;/dependencies&gt;</code></pre></dd><dt>Gradle</dt><dd><pre class="prettyprint"><code class="language-gradle">def versions = [
  ScalaBinary: "2.13"
]
dependencies {
  implementation "com.lightbend.akka:akka-projection-cassandra_${versions.ScalaBinary}:1.5.3"
}</code></pre></dd></dl>
<p>It&rsquo;s the user&rsquo;s responsibility to implement the means to project into the target system, the Projection itself will only manage the persistence of the offset (though it is possible to enlist your projection into transactions when using projection implementations that support exactly-once like the <a href="../jdbc.html">JDBC</a>). This guide encapsulates its data access layer in a Repository called the <code>ItemPopularityProjectionRepository</code>. The repository will manage a Cassandra table called <code>item_popularity</code>. Each row in <code>item_popularity</code> contains a shopping cart item id and a count that represents how often that item was added or removed from all shopping carts.</p><div class="callout note "><div class="callout-title">Note</div>
<p>The example will persist the item popularity count with a <a href="https://docs.datastax.com/en/cql-oss/3.x/cql/cql_reference/counter_type.html">Cassandra counter</a> data type. It&rsquo;s not possible to guarantee that item count updates occur idempotently because we are using at-least-once semantics. However, since the count is only a rough metric to judge how popular an item is it&rsquo;s not critical to have a totally accurate figure. </p></div>
<p>Add the <code>ItemPopularityProjectionRepository</code> to your project:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/scala/docs/guide/ItemPopularityProjectionRepository.scala#L6-L41" target="_blank" title="Go to snippet source">source</a><code class="language-scala">package docs.guide

import scala.concurrent.ExecutionContext
import scala.concurrent.Future

import akka.Done
import akka.stream.alpakka.cassandra.scaladsl.CassandraSession

trait ItemPopularityProjectionRepository {

  def update(itemId: String, delta: Int): Future[Done]
  def getItem(itemId: String): Future[Option[Long]]
}

object ItemPopularityProjectionRepositoryImpl {
  val Keyspace = &quot;akka_projection&quot;
  val PopularityTable = &quot;item_popularity&quot;
}

class ItemPopularityProjectionRepositoryImpl(session: CassandraSession)(implicit val ec: ExecutionContext)
    extends ItemPopularityProjectionRepository {
  import ItemPopularityProjectionRepositoryImpl._

  override def update(itemId: String, delta: Int): Future[Done] = {
    session.executeWrite(
      s&quot;UPDATE $Keyspace.$PopularityTable SET count = count + ? WHERE item_id = ?&quot;,
      java.lang.Long.valueOf(delta),
      itemId)
  }

  override def getItem(itemId: String): Future[Option[Long]] = {
    session
      .selectOne(s&quot;SELECT item_id, count FROM $Keyspace.$PopularityTable WHERE item_id = ?&quot;, itemId)
      .map(opt =&gt; opt.map(row =&gt; row.getLong(&quot;count&quot;).longValue()))
  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/java/jdocs/guide/ItemPopularityProjectionRepository.java#L6-L49" target="_blank" title="Go to snippet source">source</a><code class="language-java">package jdocs.guide;

import akka.Done;
import akka.stream.alpakka.cassandra.javadsl.CassandraSession;

import java.util.Optional;
import java.util.concurrent.CompletionStage;

interface ItemPopularityProjectionRepository {
  CompletionStage&lt;Done&gt; update(String itemId, int delta);

  CompletionStage&lt;Optional&lt;Long&gt;&gt; getItem(String itemId);
}

class ItemPopularityProjectionRepositoryImpl implements ItemPopularityProjectionRepository {

  public static final String Keyspace = &quot;akka_projection&quot;;
  public static final String PopularityTable = &quot;item_popularity&quot;;

  CassandraSession session;

  public ItemPopularityProjectionRepositoryImpl(CassandraSession session) {
    this.session = session;
  }

  @Override
  public CompletionStage&lt;Done&gt; update(String itemId, int delta) {
    return session.executeWrite(
        String.format(
            &quot;UPDATE %s.%s SET count = count + ? WHERE item_id = ?&quot;, Keyspace, PopularityTable),
        (long) delta,
        itemId);
  }

  @Override
  public CompletionStage&lt;Optional&lt;Long&gt;&gt; getItem(String itemId) {
    return session
        .selectOne(
            String.format(
                &quot;SELECT item_id, count FROM %s.%s WHERE item_id = ?&quot;, Keyspace, PopularityTable),
            itemId)
        .thenApply(opt -&gt; opt.map(row -&gt; row.getLong(&quot;count&quot;)));
  }
}</code></pre></dd>
</dl>
<p>Now it&rsquo;s time to write the Projection handler itself. This example uses a <span class="group-java"><a href="/api/akka-projection/1.5.3/akka/projection/javadsl/Handler.html" title="akka.projection.javadsl.Handler"><code>Handler</code></a></span><span class="group-scala"><a href="/api/akka-projection/1.5.3/akka/projection/scaladsl/Handler.html" title="akka.projection.scaladsl.Handler"><code>Handler</code></a></span> that will process <code>ShoppingCartEvents.Event</code> events from the <span class="group-java"><a href="/api/akka-projection/1.5.3/akka/projection/javadsl/SourceProvider.html" title="akka.projection.javadsl.SourceProvider"><code>SourceProvider</code></a></span><span class="group-scala"><a href="/api/akka-projection/1.5.3/akka/projection/scaladsl/SourceProvider.html" title="akka.projection.scaladsl.SourceProvider"><code>SourceProvider</code></a></span> that we implemented earlier. Specifically, it will only process <code>ItemEvents</code> that modify the items added or removed from a shopping cart. It will ignore all shopping cart <code>Checkout</code> events by skipping them. The event envelopes are processed in the <code>process</code> method. </p>
<p>This example will also log the popularity count of every 10th item event that is processed. The logging counter is stored as a mutable variable within the handler. Since this is a simple log operation managing the state in this manner is fine, but to handle more advanced stateful operations you should evaluate using the <span class="group-java"><a href="/api/akka-projection/1.5.3/akka/projection/javadsl/StatefulHandler.html" title="akka.projection.javadsl.StatefulHandler"><code>StatefulHandler</code></a></span><span class="group-scala"><a href="/api/akka-projection/1.5.3/akka/projection/scaladsl/StatefulHandler.html" title="akka.projection.scaladsl.StatefulHandler"><code>StatefulHandler</code></a></span>.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/scala/docs/guide/ItemPopularityProjectionHandler.scala#L6-L67" target="_blank" title="Go to snippet source">source</a><code class="language-scala">package docs.guide

import scala.concurrent.ExecutionContext
import scala.concurrent.Future
import scala.util.Success

import akka.Done
import akka.actor.typed.ActorSystem
import akka.actor.typed.scaladsl.LoggerOps
import akka.projection.eventsourced.EventEnvelope
import akka.projection.scaladsl.Handler
import org.slf4j.LoggerFactory

object ItemPopularityProjectionHandler {
  val LogInterval = 10
}

class ItemPopularityProjectionHandler(tag: String, system: ActorSystem[_], repo: ItemPopularityProjectionRepository)
    extends Handler[EventEnvelope[ShoppingCartEvents.Event]]() {
  import ShoppingCartEvents._

  private var logCounter: Int = 0
  private val log = LoggerFactory.getLogger(getClass)
  private implicit val ec: ExecutionContext = system.executionContext

  /**
   * The Envelope handler to process events.
   */
  override def process(envelope: EventEnvelope[Event]): Future[Done] = {
    val processed = envelope.event match {
      case ItemAdded(_, itemId, quantity)                            =&gt; repo.update(itemId, quantity)
      case ItemQuantityAdjusted(_, itemId, newQuantity, oldQuantity) =&gt; repo.update(itemId, newQuantity - oldQuantity)
      case ItemRemoved(_, itemId, oldQuantity)                       =&gt; repo.update(itemId, 0 - oldQuantity)
      case _: CheckedOut                                             =&gt; Future.successful(Done) // skip
    }
    processed.onComplete {
      case Success(_) =&gt; logItemCount(envelope.event)
      case _          =&gt; ()
    }
    processed
  }

  /**
   * Log the popularity of the item in every `ItemEvent` every `LogInterval`.
   */
  private def logItemCount(event: Event): Unit = event match {
    case itemEvent: ItemEvent =&gt;
      logCounter += 1
      if (logCounter == ItemPopularityProjectionHandler.LogInterval) {
        logCounter = 0
        val itemId = itemEvent.itemId
        repo.getItem(itemId).foreach {
          case Some(count) =&gt;
            log.infoN(&quot;ItemPopularityProjectionHandler({}) item popularity for &#39;{}&#39;: [{}]&quot;, tag, itemId, count)
          case None =&gt;
            log.info2(&quot;ItemPopularityProjectionHandler({}) item popularity for &#39;{}&#39;: [0]&quot;, tag, itemId)
        }
      }
    case _ =&gt; ()
  }

}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/java/jdocs/guide/ItemPopularityProjectionHandler.java#L6-L84" target="_blank" title="Go to snippet source">source</a><code class="language-java">package jdocs.guide;

import akka.Done;
import akka.actor.typed.ActorSystem;
import akka.projection.eventsourced.EventEnvelope;
import akka.projection.javadsl.Handler;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.concurrent.CompletableFuture;
import java.util.concurrent.CompletionStage;

public class ItemPopularityProjectionHandler
    extends Handler&lt;EventEnvelope&lt;ShoppingCartEvents.Event&gt;&gt; {
  public final int LogInterval = 10;

  private Logger log = LoggerFactory.getLogger(this.getClass());

  private int logCounter = 0;
  private String tag;
  private ActorSystem&lt;?&gt; system;
  private ItemPopularityProjectionRepository repo;

  public ItemPopularityProjectionHandler(
      String tag, ActorSystem&lt;?&gt; system, ItemPopularityProjectionRepository repo) {
    this.tag = tag;
    this.system = system;
    this.repo = repo;
  }

  /** The Envelope handler to process events. */
  @Override
  public CompletionStage&lt;Done&gt; process(EventEnvelope&lt;ShoppingCartEvents.Event&gt; envelope)
      throws Exception {
    ShoppingCartEvents.Event event = envelope.event();

    CompletionStage&lt;Done&gt; dbEffect = null;
    if (event instanceof ShoppingCartEvents.ItemAdded) {
      ShoppingCartEvents.ItemAdded added = (ShoppingCartEvents.ItemAdded) event;
      dbEffect = this.repo.update(added.itemId, added.quantity);
    } else if (event instanceof ShoppingCartEvents.ItemQuantityAdjusted) {
      ShoppingCartEvents.ItemQuantityAdjusted adjusted =
          (ShoppingCartEvents.ItemQuantityAdjusted) event;
      dbEffect = this.repo.update(adjusted.itemId, adjusted.newQuantity - adjusted.oldQuantity);
    } else if (event instanceof ShoppingCartEvents.ItemRemoved) {
      ShoppingCartEvents.ItemRemoved removed = (ShoppingCartEvents.ItemRemoved) event;
      dbEffect = this.repo.update(removed.itemId, 0 - removed.oldQuantity);
    } else {
      // skip all other events, such as `CheckedOut`
      dbEffect = CompletableFuture.completedFuture(Done.getInstance());
    }

    dbEffect.thenAccept(done -&gt; logItemCount(event));

    return dbEffect;
  }

  /** Log the popularity of the item in every `ItemEvent` every `LogInterval`. */
  private void logItemCount(ShoppingCartEvents.Event event) {
    if (event instanceof ShoppingCartEvents.ItemEvent) {
      ShoppingCartEvents.ItemEvent itemEvent = (ShoppingCartEvents.ItemEvent) event;
      logCounter += 1;
      if (logCounter == LogInterval) {
        logCounter = 0;
        String itemId = itemEvent.getItemId();
        repo.getItem(itemId)
            .thenAccept(
                opt -&gt; {
                  long count = opt.orElse(0L);
                  this.log.info(
                      &quot;ItemPopularityProjectionHandler({}) item popularity for &#39;{}&#39;: [{}]&quot;,
                      this.tag,
                      itemId,
                      count);
                });
      }
    }
  }
}</code></pre></dd>
</dl>
<p>The projection is run by wrapping it in a <span class="group-scala"><a href="/api/akka-projection/1.5.3/akka/projection/ProjectionBehavior$.html" title="akka.projection.ProjectionBehavior"><code>ProjectionBehavior</code></a></span><span class="group-java"><a href="/api/akka-projection/1.5.3/akka/projection/ProjectionBehavior$.html" title="akka.projection.ProjectionBehavior"><code>ProjectionBehavior</code></a></span> and spawning it as an Actor in the <span class="group-scala"><a href="https://doc.akka.io/api/akka/2.9/akka/actor/typed/ActorSystem.html" title="akka.actor.typed.ActorSystem"><code>ActorSystem</code></a></span><span class="group-java"><a href="https://doc.akka.io/japi/akka/2.9/akka/actor/typed/ActorSystem.html" title="akka.actor.typed.ActorSystem"><code>ActorSystem</code></a></span>.</p>
<p>Add the following imports to <code>ShoppingCartApp</code>:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/scala/docs/guide/ShoppingCartApp.scala#L23-L25" target="_blank" title="Go to snippet source">source</a><code class="language-scala">import akka.projection.ProjectionId
import akka.projection.cassandra.scaladsl.CassandraProjection
import akka.stream.alpakka.cassandra.scaladsl.CassandraSessionRegistry</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/java/jdocs/guide/ShoppingCartApp.java#L24-L28" target="_blank" title="Go to snippet source">source</a><code class="language-java">import akka.projection.ProjectionId;
import akka.projection.cassandra.javadsl.CassandraProjection;
import akka.projection.javadsl.AtLeastOnceProjection;
import akka.stream.alpakka.cassandra.javadsl.CassandraSession;
import akka.stream.alpakka.cassandra.javadsl.CassandraSessionRegistry;</code></pre></dd>
</dl>
<p>Setup the Projection in the Guardian <code>Behavior</code> defined in <code>ShoppingCartApp</code>:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/scala/docs/guide/ShoppingCartApp.scala#L50-L58" target="_blank" title="Go to snippet source">source</a><code class="language-scala">implicit val ec = system.executionContext
val session = CassandraSessionRegistry(system).sessionFor(&quot;akka.projection.cassandra.session-config&quot;)
val repo = new ItemPopularityProjectionRepositoryImpl(session)
val projection = CassandraProjection.atLeastOnce(
  projectionId = ProjectionId(&quot;shopping-carts&quot;, ShoppingCartTags.Single),
  sourceProvider,
  handler = () =&gt; new ItemPopularityProjectionHandler(ShoppingCartTags.Single, system, repo))

context.spawn(ProjectionBehavior(projection), projection.projectionId.id)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/examples/src/test/java/jdocs/guide/ShoppingCartApp.java#L52-L65" target="_blank" title="Go to snippet source">source</a><code class="language-java">CassandraSession session =
    CassandraSessionRegistry.get(system)
        .sessionFor(&quot;akka.projection.cassandra.session-config&quot;);
ItemPopularityProjectionRepositoryImpl repo =
    new ItemPopularityProjectionRepositoryImpl(session);
AtLeastOnceProjection&lt;Offset, EventEnvelope&lt;ShoppingCartEvents.Event&gt;&gt; projection =
    CassandraProjection.atLeastOnce(
        ProjectionId.of(&quot;shopping-carts&quot;, ShoppingCartTags.SINGLE),
        sourceProvider,
        () -&gt;
            new ItemPopularityProjectionHandler(
                ShoppingCartTags.SINGLE, system, repo));

context.spawn(ProjectionBehavior.create(projection), projection.projectionId().id());</code></pre></dd>
</dl>
</div>
</article>
<div class="row">
<div class="small-12 column">
<section class="nav-prev-next row">
<div class="nav-prev small-6 column">
<a href="../getting-started/source-provider.html"><i class="icon-prev"></i> <span class="link-prev">Choosing a Source Provider</span></a>
</div>
<div class="nav-next small-6 column clearfix">
<a class="float-right" href="../getting-started/testing.html">Writing tests for a Projection <i class="icon-next"></i></a>
</div>
</section>
</div>
</div>
<div class="source-github row">
Found an error in this documentation? The source code for this page can be found <a href="https://github.com/akka/akka-projection/tree/master/docs/src/main/paradox/getting-started/projection-handler.md">here</a>.
Please feel free to edit and contribute a pull request.
</div>

<footer class="page-footer row clearfix">
<img class="akka-icon float-left show-for-medium" src="../images/akka-icon.svg" />
<section class="copyright">
<div>Akka Projections is available under the <a href="https://www.lightbend.com/akka/license" target="_blank">Business Source License 1.1</a>.</div>
<p class="legal">
&copy; 2011-2024 <a href="https://www.lightbend.com" target="_blank">Lightbend, Inc.</a> |
<a href="https://www.lightbend.com/legal/licenses" target="_blank">Licenses</a> |
<a href="https://www.lightbend.com/legal/terms" target="_blank">Terms</a> |
<a href="https://www.lightbend.com/legal/privacy" target="_blank">Privacy Policy</a> |
<a href="https://akka.io/cookie/" target="_blank">Cookie Listing</a> |
<a class="optanon-toggle-display">Cookie Settings</a>
</p>
</section>

</footer>
</section>
</main>
</div>

<script type="text/javascript" src="../js/scrollsneak.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../js/groups.js"></script>
<script type="text/javascript" src="../js/page.js"></script>
<script type="text/javascript" src="../js/snippets.js"></script>
<script type="text/javascript" src="../js/magellan.js"></script>
<script type="text/javascript" src="../js/metadata-toggle.js"></script>
<script type="text/javascript" src="../js/lbHeader.js"></script>

<style type="text/css">@import "../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(){window.prettyPrint && prettyPrint()});
//]]></script>
<script type="text/javascript" src="../assets/js/warnOldVersion.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(jq){initOldVersionWarnings(jq, '1.5.3', 'https://doc.akka.io/docs/akka-projection/current/')});
//]]></script>


</body>
</html>
