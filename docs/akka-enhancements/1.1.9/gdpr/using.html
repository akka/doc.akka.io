<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Using akka-gdpr &bull; Akka Enhancements</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="Akka Enhancements is a suite of useful components that complement Akka."/>
<link rel="canonical" href="https://doc.akka.io/docs/akka-enhancements/current/gdpr/using.html"/>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../lib/foundation/dist/js/foundation.min.js"></script>
<link rel="stylesheet" type="text/css" href="../lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="../lib/foundation/dist/css/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" type="text/css" href="../css/icons.css"/>
<link rel="stylesheet" type="text/css" href="../css/page.css"/>
<link rel="shortcut icon" href="../images/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="../images/apple-touch-icon.png"/>
<link rel="icon" type="image/png" sizes="32x32" href="../images/favicon-32x32.png"/>
<link rel="icon" type="image/png" sizes="16x16" href="../images/favicon-16x16.png"/>
<link rel="manifest" href="../images/manifest.json"/>
<meta name="msapplication-TileImage" content="../images/mstile-150x150.png"/>
<meta name="msapplication-TileColor" content="#15a9ce"/>
<meta name="theme-color" content="#15a9ce"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) start -->
<script src="https://optanon.blob.core.windows.net/consent/159bb13d-6748-4399-806e-ac28db879785.js" type="text/javascript" charset="UTF-8"></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) end -->
<!--Google Analytics-->
<script type="text/plain" class="optanon-category-2">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', '']);
_gaq.push(['_setDomainName', '']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})()
</script>
<script type="text/plain" class="optanon-category-2">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-23127719-1', 'lightbend.com', {'allowLinker': true, 'name': 'tsTracker'});
ga('tsTracker.require', 'linker');
ga('tsTracker.linker:autoLink', ['lightbend.com','playframework.com','scala-lang.org','scaladays.org','spray.io','akka.io','scala-sbt.org','scala-ide.org']);
ga('tsTracker.send', 'pageview');
</script>
<!--Marketo-->
<script type="text/plain" class="optanon-category-3">
(function() {
var didInit = false;
function initMunchkin() {
if(didInit === false) {
didInit = true;
Munchkin.init('558-NCX-702', { 'asyncOnly': true, 'disableClickDelay': true });
}
}
var s = document.createElement('script');
s.type = 'text/javascript';
s.async = true;
s.src = '//munchkin.marketo.net/munchkin.js';
s.onreadystatechange = function() {
if (this.readyState == 'complete' || this.readyState == 'loaded') {
initMunchkin();
}
};
s.onload = initMunchkin;
document.getElementsByTagName('head')[0].appendChild(s);
})();
</script>
</head>

<body id="underlay" data-toggler="nav-open">

<header class="site-header hide-for-large">
<div class="sticky-header clearfix">
<a href="https://akka.io"><img class="logo" src="../images/akka-logo-reverse.svg"/></a>

<button class="menu-icon float-right" type="button" data-toggle="underlay overlay"></button>
</div>
<div id="overlay" class="overlay-nav" data-toggler="nav-open">
<header class="nav-header">
<div class="nav-header-title">
<h1><a href="../index.html">Akka Enhancements</a></h1>
</div>
<div class="nav-header-version">
Version 1.1.9
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Languages"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="nav-toc">
<ul>
  <li><a href="../akka-resilience-enhancements.html" class="page">Akka Resilience Enhancements</a></li>
  <li><a href="../akka-persistence-enhancements.html" class="page">Akka Persistence Enhancements</a>
  <ul>
    <li><a href="../persistence-dc/index.html" class="page">Akka Multi-DC Persistence</a></li>
    <li><a href="../gdpr/index.html" class="page">GDPR for Akka Persistence</a>
    <ul>
      <li><a href="../gdpr/index.html#introduction" class="header">Introduction</a></li>
      <li><a href="../gdpr/data-subject-id.html" class="page">Subject identifiers</a></li>
      <li><a href="../gdpr/shredding.html" class="page">Shred or delete?</a></li>
      <li><a href="../gdpr/using.html#using-akka-gdpr" class="active page">Using akka-gdpr</a>
      <ul>
        <li><a href="../gdpr/using.html#dependency" class="header">Dependency</a></li>
        <li><a href="../gdpr/using.html#how-the-module-works" class="header">How the module works</a></li>
        <li><a href="../gdpr/using.html#general-steps" class="header">General steps</a></li>
        <li><a href="../gdpr/using.html#wrapping-data-in-withdatasubjectid" class="header">Wrapping data in WithDataSubjectId</a></li>
        <li><a href="../gdpr/using.html#events-with-multiple-subjects" class="header">Events with multiple subjects</a></li>
      </ul></li>
      <li><a href="../gdpr/encryption.html" class="page">Encrypting data</a></li>
      <li><a href="../gdpr/migration.html" class="page">Migrating existing data</a></li>
      <li><a href="../gdpr/lagom.html" class="page">Lagom specifics</a></li>
      <li><a href="../gdpr/other-storage.html" class="page">Other data storage</a></li>
    </ul></li>
    <li><a href="../akka-persistence-enhancements-release-notes.html" class="page">Akka Persistence Enhancements Release Notes</a></li>
  </ul></li>
</ul>
</nav>
</div>
</header>

<aside class="show-for-large">
<header class="nav-header fixed-sidebar-header">
<div class="nav-header-title">
<h1><a href="../index.html">Akka Enhancements</a></h1>
</div>
<div class="nav-header-version">
Version 1.1.9
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Languages"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="site-nav fixed-sidebar-contents">
<div class="nav-toc">
<ul>
  <li><a href="../akka-resilience-enhancements.html" class="page">Akka Resilience Enhancements</a></li>
  <li><a href="../akka-persistence-enhancements.html" class="page">Akka Persistence Enhancements</a>
  <ul>
    <li><a href="../persistence-dc/index.html" class="page">Akka Multi-DC Persistence</a></li>
    <li><a href="../gdpr/index.html" class="page">GDPR for Akka Persistence</a>
    <ul>
      <li><a href="../gdpr/index.html#introduction" class="header">Introduction</a></li>
      <li><a href="../gdpr/data-subject-id.html" class="page">Subject identifiers</a></li>
      <li><a href="../gdpr/shredding.html" class="page">Shred or delete?</a></li>
      <li><a href="../gdpr/using.html#using-akka-gdpr" class="active page">Using akka-gdpr</a>
      <ul>
        <li><a href="../gdpr/using.html#dependency" class="header">Dependency</a></li>
        <li><a href="../gdpr/using.html#how-the-module-works" class="header">How the module works</a></li>
        <li><a href="../gdpr/using.html#general-steps" class="header">General steps</a></li>
        <li><a href="../gdpr/using.html#wrapping-data-in-withdatasubjectid" class="header">Wrapping data in WithDataSubjectId</a></li>
        <li><a href="../gdpr/using.html#events-with-multiple-subjects" class="header">Events with multiple subjects</a></li>
      </ul></li>
      <li><a href="../gdpr/encryption.html" class="page">Encrypting data</a></li>
      <li><a href="../gdpr/migration.html" class="page">Migrating existing data</a></li>
      <li><a href="../gdpr/lagom.html" class="page">Lagom specifics</a></li>
      <li><a href="../gdpr/other-storage.html" class="page">Other data storage</a></li>
    </ul></li>
    <li><a href="../akka-persistence-enhancements-release-notes.html" class="page">Akka Persistence Enhancements Release Notes</a></li>
  </ul></li>
</ul>
</div>
</nav>
<footer class="nav-footer fixed-sidebar-footer">
<a href="https://akka.io"><img class="logo" src="../images/akka-logo-reverse.svg"/></a>

</footer>
</aside>

<main class="fixed-shift-for-large expanded row">
<section class="site-content small-12 column">

<article class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h1><a href="#using-akka-gdpr" name="using-akka-gdpr" class="anchor"><span class="anchor-link"></span></a>Using akka-gdpr</h1>
<p>The <code>akka-gdpr</code> module contains utilities to help you manage data shredding, including:</p>
<ul>
  <li>A <code>GdprEncryption</code> extension point that you can use to plug your own encryption. Alternatively, you can use the <code>AbstractGdprEncryption</code> class that provides encryption but requires you to implement key management.</li>
  <li>A serializer that encrypts events and adds a data subject id, when you wrap events with <code>WithDataSubjectId</code>. You must provide your own serializer for events that reference multiple data subjects. If you are using Jackson or Play JSON for serialization, the <code>akka-gdpr</code> module allows you to use them for encryption.</li>
</ul>
<h2><a href="#dependency" name="dependency" class="anchor"><span class="anchor-link"></span></a>Dependency</h2>
<p>To use the GDPR for Akka Persistence feature, add a dependency for the <em>akka-gdpr</em> artifact:</p>
<dl>
  <dt>sbt</dt>
  <dd>
  <pre><code>// Add Reactive Platform to your build as documented at https://developer.lightbend.com/docs/reactive-platform/2.0/setup/setup-sbt.html
&quot;com.lightbend.akka&quot; %% &quot;akka-gdpr&quot; % &quot;1.1.9&quot;
</code></pre></dd>
  <dt>Gradle</dt>
  <dd>
  <pre><code>// Add Reactive Platform to your build as documented at https://developer.lightbend.com/docs/reactive-platform/2.0/setup/setup-gradle.html
dependencies {
  compile group: &#39;com.lightbend.akka&#39;, name: &#39;akka-gdpr_2.12&#39;, version: &#39;1.1.9&#39;
}
</code></pre></dd>
  <dt>Maven</dt>
  <dd>
  <pre><code>&lt;!-- Add Reactive Platform to your build as documented at https://developer.lightbend.com/docs/reactive-platform/2.0/setup/setup-maven.html --&gt;
&lt;dependency&gt;
  &lt;groupId&gt;com.lightbend.akka&lt;/groupId&gt;
  &lt;artifactId&gt;akka-gdpr_2.12&lt;/artifactId&gt;
  &lt;version&gt;1.1.9&lt;/version&gt;
&lt;/dependency&gt;
</code></pre></dd>
</dl>
<p>You can obtain your credentials at <a href="https://www.lightbend.com/product/lightbend-reactive-platform/credentials">https://www.lightbend.com/product/lightbend-reactive-platform/credentials</a> including links to information on how to add the credentials to your build.</p>
<h2><a href="#how-the-module-works" name="how-the-module-works" class="anchor"><span class="anchor-link"></span></a>How the module works</h2>
<p>Once you have implemented the <code>GdprEncryption</code> extension, for example, by extending <code>AbstractGdprEncryption</code> and implementing the <code>KeyManagement</code>, the <code>GdprSerializer</code> class in <code>akka-gdpr</code> handles the encryption for you. The <code>GdprSerializer</code> is automatically bound for serialization of <code>WithDataSubjectId</code> classes:</p>
<pre class="prettyprint"><code class="language-conf">akka.actor {
  serializers {
    gdpr-serializer = &quot;akka.persistence.gdpr.GdprSerializer&quot;
  }

  serialization-bindings {
    &quot;akka.persistence.gdpr.WithDataSubjectId&quot; = gdpr-serializer
  }
}</code></pre>
<p>The <code>GdprSerializer</code> will do the following:</p>
<ol>
  <li>
  <p>Each of your events is first serialized via Akka&rsquo;s serialization extension.</p></li>
  <li>
  <p>Then the payload is encrypted with AES in GCM mode with no padding. Initialization vectors are created for each new payload using a <code>SecureRandom</code> and are the same length as the chosen key. </p></li>
  <li>
  <p>The Initialization vector is then stored at the start of the encrypted payload.</p></li>
  <li>
  <p>The payload is then added to a protobuf message:</p></li>
</ol>
<pre class="prettyprint"><code class="language-proto">option java_package = &quot;akka.persistence.gdpr.serialization&quot;;
option optimize_for = SPEED;

message WithDataSubjectId {
  required string dataSubjectId = 1;
  optional bytes payload = 2;
  optional int32 serializerId = 3;
  optional string manifest = 4;
}</code></pre>
<p>We provide these details so that you can read the events and validate the cryptographic approach.</p>
<h2><a href="#general-steps" name="general-steps" class="anchor"><span class="anchor-link"></span></a>General steps</h2>
<p>General steps to use the <code>akka-gdpr</code> module include:</p>
<ol>
  <li>
  <p>Add a dependency to your build as described in <a href="using.html#dependency">Adding the akka-gdpr module dependency</a>.</p></li>
  <li>
    <p>For encryption, choose from the following: </p>
    <ul>
      <li>The <code>GdprEncryption</code> extension, which allows you to have full control over encryption algorithms by defining three methods that you can implement. See <a href="encryption.html#gdprencryption">GdprEncryption</a> for more details.</li>
      <li>Extend the <code>AbstractGdprEncryption</code> class, which implements encryption and decryption for you, but requires you to use the <code>KeyManagement</code> interface to plug in the logic for creating and retrieving keys. See <a href="encryption.html#abstractgdprencryption">AbstractGdprEncryption</a> for more details.</li>
      <li>The <code>JavaKeyStoreGdprEncryption</code>class implements <code>GdprEncryption</code> with support for PKCS12 and JCEKS keystores. See <a href="encryption.html#javakeystoregdprencryption">JavaKeyStoreGdprEncryption</a> (This is only appropriate for single node applications.)</li>
    </ul>
  </li>
  <li>
  <p>Define the <code>akka.persistence.gdpr.encryption-provider</code> setting to point to a configuration block for your encryption implementation, as described in <a href="encryption.html#pointing-to-your-encryption-implementation">Pointing to your encryption implementation</a>.</p></li>
  <li>
  <p>Use the <code>WithDataSubjectId</code> class by <a href="using.html#wrapping-data-in-withdatasubjectid">wrapping events</a>, or inside of events. For events that contain multiple data subjects, you will need to implement your own serializer, as described in <a href="using.html#events-with-multiple-subjects">Events with multiple subjects</a>.</p></li>
  <li>
  <p>When there is a request to forget a data subject you should call the <code>shred</code> method of the <code>GdprEncryption</code> extension:</p></li>
</ol>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><code class="language-scala">import akka.persistence.gdpr.scaladsl.GdprEncryption

GdprEncryption(system).shred(dataSubjectId)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><code class="language-java">akka.persistence.gdpr.javadsl.GdprEncryption.get(system).shred(dataSubjectId);</code></pre></dd>
</dl>
<p>For unit testing during development, you can use <code>TestGdprEncryption</code>, which holds generated keys in memory and can be enabled with configuration. See <a href="encryption.html#testgdprencryption">TestGdprEncryption</a> for more details.</p>
<p>See also:</p>
<ul>
  <li><a href="lagom.html">Using akka-gdpr with Lagom PersistentEntity</a></li>
  <li><a href="other-storage.html">Using akka-gdpr with other data storage</a></li>
</ul>
<h2><a href="#wrapping-data-in-withdatasubjectid" name="wrapping-data-in-withdatasubjectid" class="anchor"><span class="anchor-link"></span></a>Wrapping data in WithDataSubjectId</h2>
<p>The GDPR for Akka Persistence module provides a <code>WithDataSubjectId</code> class. Wrap events that require encryption in this class. When <code>WithDataSubjectId</code> is serialized, the <code>payload</code> (the actual event) is encrypted with the key that is identified by the <code>dataSubjectId</code> in the <code>WithDataSubjectId</code>. To shred the data, as described in <a href="shredding.html">The right to be forgotten</a>, remove the encryption key to make the encrypted payload unreadable.</p>
<p>When the encrypted payload of <code>WithDataSubjectId</code> is deserialized and the encryption key doesn&rsquo;t exist any more, the <span class="group-scala"><code>payload</code> is represented as <code>None</code></span><span class="group-java"><code>getPayload()</code> is represented as <code>Optional.empty()</code></span>. You need to take this value into account when replaying or processing the events.</p>
<p>If you&rsquo;re using <code>Tagged</code> events then the <code>Tagged</code> class should remain on the outside e.g.</p>
<pre class="prettyprint"><code class="language-scala">Tagged(WithDataSubjectId(dataSubjectId, payload), tags)</code></pre>
<h2><a href="#events-with-multiple-subjects" name="events-with-multiple-subjects" class="anchor"><span class="anchor-link"></span></a>Events with multiple subjects</h2>
<p>As described above, events wrapped in <code>WithDataSubjectId</code> are automatically serialized with encryption. When parts of the data in an event &mdash; or more typically in snapshots &mdash; belong to different subjects you have to implement that in <em>your</em> serializer. Each <code>WithDataSubjectId</code> part must be represented as bytes in the stored representation and you should use the <code>WithDataSubjectIdSerialization</code> utility to serialize each <code>WithDataSubjectId</code> to/from the bytes.</p>
<p>Here is an example of a serializer for a snapshot that contains two separate <code>WithDataSubjectId</code> parts.</p>
<p>The protobuf definition of the snapshot:</p>
<pre class="prettyprint"><code class="language-proto">message Snapshot {
  required bytes part1 = 1;
  required bytes part2 = 2;
  required int32 other = 3;
}</code></pre>
<p>The snapshot class:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><code class="language-scala">final case class Snapshot(
  part1: WithDataSubjectId[String],
  part2: WithDataSubjectId[String],
  other: Int)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><code class="language-java">public static class Snapshot {
  public final WithDataSubjectId&lt;String&gt; part1;
  public final WithDataSubjectId&lt;String&gt; part2;
  public final int other;

  public Snapshot(WithDataSubjectId&lt;String&gt; part1, WithDataSubjectId&lt;String&gt; part2, int other) {
    this.part1 = part1;
    this.part2 = part2;
    this.other = other;
  }

}</code></pre></dd>
</dl>
<p>The serializer of the <code>Snapshot</code>:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><code class="language-scala">import akka.persistence.gdpr.WithDataSubjectId
import akka.serialization.AsyncSerializerWithStringManifest
import akka.actor.ExtendedActorSystem
import akka.persistence.gdpr.serialization.TestMessages // generated from proto
import java.io.NotSerializableException
import com.google.protobuf.ByteString

class SnapshotSerializer(val system: ExtendedActorSystem) extends AsyncSerializerWithStringManifest(system) {

  import system.dispatcher
  private val withDataSubjectIdSerialization = new WithDataSubjectIdSerialization(system)

  private val SnapshotManifest = &quot;S&quot;

  override def identifier: Int = 999

  override def manifest(obj: AnyRef): String = obj match {
    case _: Snapshot =&gt; SnapshotManifest
    case _ â‡’
      throw new IllegalArgumentException(s&quot;Can&#39;t serialize object of type ${obj.getClass} in [${getClass.getName}]&quot;)
  }

  override def toBinaryAsync(obj: AnyRef): Future[Array[Byte]] = {
    obj match {
      case snap: Snapshot =&gt;
        for {
          part1Bytes &lt;- withDataSubjectIdSerialization.toBinaryAsync(snap.part1)
          part2Bytes &lt;- withDataSubjectIdSerialization.toBinaryAsync(snap.part2)
        } yield {
          TestMessages.Snapshot.newBuilder()
            .setPart1(ByteString.copyFrom(part1Bytes))
            .setPart2(ByteString.copyFrom(part2Bytes))
            .setOther(17)
            .build().toByteArray
        }

      case _ =&gt;
        Future.failed(new IllegalArgumentException(s&quot;Can&#39;t serialize object of type ${obj.getClass} in [${getClass.getName}]&quot;))
    }
  }

  override def fromBinaryAsync(bytes: Array[Byte], manifest: String): Future[AnyRef] = {
    manifest match {
      case SnapshotManifest =&gt;
        val snap = TestMessages.Snapshot.parseFrom(bytes)
        for {
          part1 &lt;- withDataSubjectIdSerialization.fromBinaryAsync[String](snap.getPart1.toByteArray)
          part2 &lt;- withDataSubjectIdSerialization.fromBinaryAsync[String](snap.getPart2.toByteArray)
        } yield {
          Snapshot(part1, part2, snap.getOther)
        }

      case _ =&gt;
        Future.failed(new NotSerializableException(
          s&quot;Unimplemented deserialization of message with manifest [$manifest] in [${getClass.getName}]&quot;))
    }
  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><code class="language-java">import akka.persistence.gdpr.WithDataSubjectId;
import akka.serialization.AsyncSerializerWithStringManifestCS;
import akka.actor.ExtendedActorSystem;
import akka.persistence.gdpr.serialization.TestMessages; // generated from proto
import java.io.NotSerializableException;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.CompletionStage;
import com.google.protobuf.ByteString
import com.google.protobuf.InvalidProtocolBufferException;

public static class SnapshotSerializer extends AsyncSerializerWithStringManifestCS {
  private static final String SNAPSHOT_MANIFEST = &quot;S&quot;;

  private final ExtendedActorSystem system;
  private final WithDataSubjectIdSerialization withDataSubjectIdSerialization;

  public SnapshotSerializer(ExtendedActorSystem system) {
    super(system);
    this.system = system;
    this.withDataSubjectIdSerialization = new WithDataSubjectIdSerialization(system);
  }

  @Override
  public int identifier() {
    return 999;
  }

  @Override
  public String manifest(Object obj) {
    if (obj instanceof Snapshot)
      return SNAPSHOT_MANIFEST;
    else
      throw new IllegalArgumentException(&quot;Can&#39;t serialize object of type &quot; + obj.getClass() +
          &quot; in [&quot; + getClass().getName() + &quot;]&quot;);
  }

  @Override
  public CompletionStage&lt;byte[]&gt; toBinaryAsyncCS(Object obj) {
    if (obj instanceof Snapshot) {
      Snapshot snap = (Snapshot) obj;
      return withDataSubjectIdSerialization.toBinaryAsync(snap.part1).thenCompose(part1Bytes -&gt; {
        return withDataSubjectIdSerialization.toBinaryAsync(snap.part2).thenApply(part2Bytes -&gt; {
          return TestMessages.Snapshot.newBuilder()
              .setPart1(ByteString.copyFrom(part1Bytes))
              .setPart2(ByteString.copyFrom(part2Bytes))
              .setOther(17)
              .build().toByteArray();
        });
      });

    } else {
      CompletableFuture&lt;byte[]&gt; result = new CompletableFuture&lt;&gt;();
      result.completeExceptionally(new IllegalArgumentException(
          &quot;Can&#39;t serialize object of type &quot; + obj.getClass() + &quot; in [&quot; + getClass().getName() + &quot;]&quot;));
      return result;
    }
  }

  @Override
  public CompletionStage&lt;Object&gt; fromBinaryAsyncCS(byte[] bytes, String manifest) {
    if (SNAPSHOT_MANIFEST.equals(manifest)) {
      try {
        TestMessages.Snapshot snap = TestMessages.Snapshot.parseFrom(bytes);
        return withDataSubjectIdSerialization.fromBinaryAsync(String.class, snap.getPart1().toByteArray())
            .thenCompose(part1 -&gt; {
              return withDataSubjectIdSerialization.fromBinaryAsync(String.class, snap.getPart2().toByteArray())
                  .thenApply(part2 -&gt; {
                    return new Snapshot(part1, part2, snap.getOther());
                  });
            });
      } catch (InvalidProtocolBufferException e) {
        CompletableFuture&lt;Object&gt; result = new CompletableFuture&lt;&gt;();
        result.completeExceptionally(e);
        return result;
      }
    } else {
      CompletableFuture&lt;Object&gt; result = new CompletableFuture&lt;&gt;();
      result.completeExceptionally(new NotSerializableException(
          &quot;Unimplemented deserialization of message with manifest [&quot; + manifest + &quot;] in [&quot; +
              getClass().getName() + &quot;]&quot;));
      return result;
    }
  }
}</code></pre></dd>
</dl>
<p>Note that the serializer should extend <span class="group-java"><code>AsyncSerializerWithStringManifestCS</code></span><span class="group-scala"><code>AsyncSerializerWithStringManifest</code></span> and implement methods <code>toBinaryAsync</code> and <code>fromBinaryAsync</code> that return <span class="group-java"><code>CompletionStage</code></span><span class="group-scala"><code>Future</code></span>. The reason for using the asynchronous API instead of the ordinary <code>SerializerWithStringManifest</code> is that encryption typically involves file or network IO; blocking the serialization thread while waiting for such things to complete should be avoided. The encryption calls are managed by GDPR for Akka Persistence and are running on a separate dispatcher dedicated for blocking tasks to avoid starvation of other parts of the system. To compose those asyncronous encryption tasks the serializer must also be asynchronous and chain the calls using <span class="group-java"><code>thenApply</code></span><span class="group-scala"><code>map</code></span> and <span class="group-java"><code>thenCompose</code></span><span class="group-scala"><code>flatMap</code></span> operations of the <span class="group-java"><code>CompletionStage</code></span><span class="group-scala"><code>Future</code>. In the above example <code>for</code> comprehension is used for doing that.</span></p>
</div>
</article>

<div class="row">
<div class="small-12 large-9 column">
<section class="nav-prev-next row">
<div class="nav-prev small-6 column">
<a href="../gdpr/shredding.html"><i class="icon-prev"></i> <span class="link-prev">Shred or delete?</span></a>
</div>
<div class="nav-next small-6 column clearfix">
<a class="float-right" href="../gdpr/encryption.html">Encrypting data <i class="icon-next"></i></a>
</div>
</section>
</div>
</div>

<!-- no source links for private github repository -->


<footer class="page-footer row clearfix">
<img class="akka-icon float-left show-for-medium" src="../images/akka-icon.svg"/>
<section class="copyright">
<div>Akka Enhancements is Open Source and available under the Apache 2 License.</div>
<p class="legal">
&copy; 2011-2019 <a href="https://www.lightbend.com" target="_blank">Lightbend, Inc.</a> | 
<a href="https://www.lightbend.com/legal/licenses" target="_blank">Licenses</a> | 
<a href="https://www.lightbend.com/legal/terms" target="_blank">Terms</a> | 
<a href="https://www.lightbend.com/legal/privacy" target="_blank">Privacy Policy</a> | 
<a href="https://akka.io/cookie/" target="_blank">Cookie Listing</a> | 
<a class="optanon-toggle-display">Cookie Settings</a>
</p>
</section>
</footer>

</section>
</main>

<script type="text/javascript" src="../js/scrollsneak.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../js/groups.js"></script>
<script type="text/javascript" src="../js/page.js"></script>
<script type="text/javascript" src="../js/magellan.js"></script>

<style type="text/css">@import "../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(){window.prettyPrint && prettyPrint()});
//]]></script>
<!-- hook for including project specific javascript into the generated docs -->

</body>
</html>
