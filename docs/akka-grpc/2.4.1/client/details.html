<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Details &bull; Akka gRPC</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="Akka gRPC - Support for building streaming gRPC servers and clients on top of Akka Streams."/>
<link rel="canonical" href="https://doc.akka.io/docs/akka-grpc/current/client/details.html"/>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../lib/foundation/dist/js/foundation.min.js"></script>
<link rel="stylesheet" type="text/css" href="../lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="../lib/foundation/dist/css/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" type="text/css" href="../css/icons.css"/>
<link rel="stylesheet" type="text/css" href="../css/page-8.css"/>
<link rel="stylesheet" type="text/css" href="../css/banner-2.css"/>
<link rel="shortcut icon" href="../images/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="../images/apple-touch-icon.png"/>
<link rel="icon" type="image/png" sizes="32x32" href="../images/favicon-32x32.png"/>
<link rel="icon" type="image/png" sizes="16x16" href="../images/favicon-16x16.png"/>
<link rel="manifest" href="../images/manifest.json"/>
<meta name="msapplication-TileImage" content="../images/mstile-150x150.png"/>
<meta name="msapplication-TileColor" content="#15a9ce"/>
<meta name="theme-color" content="#15a9ce"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) start -->
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js"  type="text/javascript" charset="UTF-8" data-domain-script="28b912e7-09e9-43d5-91e4-3d1897044004" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) end -->
<!-- Google Tag Manager now loads Google Analytics and any other tracking scripts. GTM also performs respects a users cookie choices-->
<script type="text/javascript">
(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KBJGH35');
</script>

</head>

<body id="underlay" data-toggler="nav-open">
<div id="lightbend-banner" class="lightbend-banner akka full-width" data-category="OSS Lightbend Banner Impression" data-label="Akka Banner Impression">
<div class="oss-wrapper">
<div class="oss-brand">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lightbend Logo - Akka Banner" href="https://www.lightbend.com">
<img class="lightbend-logo" src="../images/banner-logos/lightbend-reverse.svg" alt="Lightbend" title="Lightbend">
</a>
</div>
<div class="oss-ad no-drop-down">
<nav id="lightbendRotator" class="lightbend-rotator">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Promo Rotator - Introducing Akka Cloud to Edge Continuum. Build once for the Cloud. Seamlessly deploy to the Edge. [Learn more] - Akka Banner" href="https://www.lightbend.com/blog/akka-edge-unifying-the-cloud-and-edge">
Introducing Akka Cloud to Edge Continuum. Build once for the Cloud. Seamlessly deploy to the Edge. <span class="akka-btn">Learn more</span>
</a>
</nav>
</div>
</div>
</div>

<header class="site-header hide-for-large">
<div class="sticky-header clearfix">
<a href="https://akka.io"><img class="logo" src="../images/akka-logo-reverse.svg"/></a>

<button class="menu-icon float-right" type="button" data-toggle="underlay overlay"></button>
</div>
<div id="overlay" class="overlay-nav" data-toggler="nav-open">
<header class="nav-header">
<div class="nav-header-title">
<h1><a href="../index.html">Akka gRPC</a></h1>
</div>
<div class="nav-header-version">
Version 2.4.1
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
<select class="supergroup" name="Buildtool"><option class="group" value="group-sbt">sbt</option><option class="group" value="group-gradle">Gradle</option><option class="group" value="group-maven">Maven</option></select>
</div>
</header>
<nav class="nav-toc">
<ul>
  <li><a href="../overview.html" class="page">Overview</a></li>
  <li><a href="../whygrpc.html" class="page">Why gRPC?</a></li>
  <li><a href="../getting-started.html" class="page">Getting started</a></li>
  <li><a href="../proto.html" class="page">Protobuf Service Descriptors</a></li>
  <li><a href="../server/index.html" class="page">Providing Services (Server)</a></li>
  <li><a href="../client/index.html" class="page">Consuming Services (Client)</a>
  <ul>
    <li><a href="../client/walkthrough.html" class="page">Walkthrough</a></li>
    <li><a href="../client/configuration.html" class="page">Configuration</a></li>
    <li><a href="../client/details.html#details" class="active page">Details</a>
    <ul>
      <li><a href="../client/details.html#client-lifecycle" class="header">Client Lifecycle</a></li>
      <li><a href="../client/details.html#shared-channels" class="header">Shared Channels</a></li>
      <li><a href="../client/details.html#load-balancing" class="header">Load balancing</a></li>
      <li><a href="../client/details.html#request-metadata" class="header">Request Metadata</a></li>
      <li><a href="../client/details.html#rich-error-model" class="header">Rich error model</a></li>
    </ul></li>
  </ul></li>
  <li><a href="../buildtools/index.html" class="page">Build Tool Support</a></li>
  <li><a href="../binary-compatibility.html" class="page">Binary compatibility</a></li>
  <li><a href="../apidesign.html" class="page">API Design</a></li>
  <li><a href="../deploy.html" class="page">Deployment</a></li>
  <li><a href="../mtls.html" class="page">Mutual authentication with TLS</a></li>
  <li><a href="../troubleshooting.html" class="page">Troubleshooting</a></li>
</ul>
</nav>
</div>
</header>
<div class="site-content-wrapper">
<aside class="sticky-sidebar show-for-large">
<header class="nav-header sticky-sidebar-header">
<div class="nav-header-title">
<h1><a href="../index.html">Akka gRPC</a></h1>
</div>
<div class="nav-header-version">
Version 2.4.1
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
<select class="supergroup" name="Buildtool"><option class="group" value="group-sbt">sbt</option><option class="group" value="group-gradle">Gradle</option><option class="group" value="group-maven">Maven</option></select>
</div>
</header>
<nav class="site-nav sticky-sidebar-contents">
<div class="nav-toc">
<ul>
  <li><a href="../overview.html" class="page">Overview</a></li>
  <li><a href="../whygrpc.html" class="page">Why gRPC?</a></li>
  <li><a href="../getting-started.html" class="page">Getting started</a></li>
  <li><a href="../proto.html" class="page">Protobuf Service Descriptors</a></li>
  <li><a href="../server/index.html" class="page">Providing Services (Server)</a></li>
  <li><a href="../client/index.html" class="page">Consuming Services (Client)</a>
  <ul>
    <li><a href="../client/walkthrough.html" class="page">Walkthrough</a></li>
    <li><a href="../client/configuration.html" class="page">Configuration</a></li>
    <li><a href="../client/details.html#details" class="active page">Details</a>
    <ul>
      <li><a href="../client/details.html#client-lifecycle" class="header">Client Lifecycle</a></li>
      <li><a href="../client/details.html#shared-channels" class="header">Shared Channels</a></li>
      <li><a href="../client/details.html#load-balancing" class="header">Load balancing</a></li>
      <li><a href="../client/details.html#request-metadata" class="header">Request Metadata</a></li>
      <li><a href="../client/details.html#rich-error-model" class="header">Rich error model</a></li>
    </ul></li>
  </ul></li>
  <li><a href="../buildtools/index.html" class="page">Build Tool Support</a></li>
  <li><a href="../binary-compatibility.html" class="page">Binary compatibility</a></li>
  <li><a href="../apidesign.html" class="page">API Design</a></li>
  <li><a href="../deploy.html" class="page">Deployment</a></li>
  <li><a href="../mtls.html" class="page">Mutual authentication with TLS</a></li>
  <li><a href="../troubleshooting.html" class="page">Troubleshooting</a></li>
</ul>
</div>
</nav>
<footer class="nav-footer sticky-sidebar-footer">
<a href="https://akka.io"><img class="logo" src="../images/akka-logo-reverse.svg"/></a>

</footer>
</aside>
<main class="fixed-shift-for-large expanded row">
<section class="site-content small-12 column">
<article class="page-content row">
<div class="small-12 column" id="docs">
<h1><a href="#details" name="details" class="anchor"><span class="anchor-link"></span></a>Details</h1>
<h2><a href="#client-lifecycle" name="client-lifecycle" class="anchor"><span class="anchor-link"></span></a>Client Lifecycle</h2>
<p>Instances of the generated client may be long-lived and can be used concurrently. You can keep the client running until your system terminates, or close it earlier. To avoid leaking in the latter case, you should call <code>.close()</code> on the client.</p>
<p>When the connection breaks, the client will try reconnecting to the server automatically. On each reconnection attempt, If a connection the <code>ServiceDiscovery</code> will be used and a new host may be found.</p>
<p>When using client-side <a href="details.html#load-balancing">load balancing</a> the reconnection loop will run indefinitely.</p>
<p>When using a direct client (not load balanced) when the connection breaks you can set up a maximum number of reconnection attempts. If that limit is reached, the client will shutdown. The default number of attempts to reconnect is infinite and configurable via <code>GrpcClientSettings</code>&rsquo;s <code>connectionAttempts</code>.</p>
<p>The client offers a method <code>closed()</code> that returns a <span class="group-scala"><code>Future</code></span><span class="group-java"><code>CompletionStage</code></span> that will complete once the client is explicitly closed after invoking <code>close()</code>. The returned <span class="group-scala"><code>Future</code></span><span class="group-java"><code>CompletionStage</code></span> will complete with a failure when the maximum number of <code>connectionAttempts</code> (which causes a shutdown).</p>
<h2><a href="#shared-channels" name="shared-channels" class="anchor"><span class="anchor-link"></span></a>Shared Channels</h2>
<p>By default, each instance of a generated client creates a separate HTTP connection to the server. If the server supports multiple services, you may want to allow multiple generated clients to share a single connection.</p>
<p>To do this, create a <span class="group-scala"><a href="/api/akka-grpc/2.4.1/akka/grpc/GrpcChannel.html" title="akka.grpc.GrpcChannel"><code>GrpcChannel</code></a></span><span class="group-java"><a href="/api/akka-grpc/2.4.1/akka/grpc/GrpcChannel.html" title="akka.grpc.GrpcChannel"><code>GrpcChannel</code></a></span> by passing <span class="group-scala"><a href="/api/akka-grpc/2.4.1/akka/grpc/GrpcClientSettings.html" title="akka.grpc.GrpcClientSettings"><code>GrpcClientSettings</code></a></span><span class="group-java"><a href="/api/akka-grpc/2.4.1/akka/grpc/GrpcClientSettings.html" title="akka.grpc.GrpcClientSettings"><code>GrpcClientSettings</code></a></span> to the apply method. You can then use the GrpcChannel instance to create multiple generated clients; each client will use the provided channel to communicate with the server.</p>
<p>When using a shared channel, the client lifecycle changes slightly. Like the generated client, <code>GrpcChannel</code> offers <code>close</code> and <code>closed</code> methods; these can be used to explicitly close the connection to the server and detect when the connection has been closed or shutdown due to errors, respectively. When you are done communicating with the server, you should call <code>close</code> on the channel, rather than the individual clients. Calling <code>close</code> on a generated client that was created with a shared channel will throw a <span class="group-scala"><a href="/api/akka-grpc/2.4.1/akka/grpc/GrpcClientCloseException.html" title="akka.grpc.GrpcClientCloseException"><code>GrpcClientCloseException</code></a></span><span class="group-java"><a href="/api/akka-grpc/2.4.1/akka/grpc/GrpcClientCloseException.html" title="akka.grpc.GrpcClientCloseException"><code>GrpcClientCloseException</code></a></span>.</p>
<h2><a href="#load-balancing" name="load-balancing" class="anchor"><span class="anchor-link"></span></a>Load balancing</h2>
<p>When multiple endpoints are discovered for a gRPC client, currently one is selected and used for all outgoing calls.</p>
<p>This approach, while naïve, in fact works well in many cases: when there are multiple nodes available to handle requests, a server-side load balancer is better-positioned to make decisions than any single client, as it can take into account information from multiple clients, and sometimes even lifecycle information (e.g. not forward requests to nodes that are scheduled to shut down).</p>
<p>Client-side load balancing is desirable when you are using the default <code>static</code> or the <code>grpc-dns</code> discovery mechanism. You can set the <code>load-balancing-policy</code> client configuration option to <code>round_robin</code> to enable the round_robin client-side load balancing strategy provided by grpc-java.</p>
<p>Note that load balancing is marked as <a href="https://github.com/grpc/grpc-java/issues/1771">experimental</a> in grpc-java.</p>
<p>Client-side load balancing for other discovery mechanisms is <a href="https://github.com/akka/akka-grpc/issues/809">not yet supported</a>.</p>
<h2><a href="#request-metadata" name="request-metadata" class="anchor"><span class="anchor-link"></span></a>Request Metadata</h2>
<p>Default request metadata, for example for authentication, can be provided through the <span class="group-scala"><a href="/api/akka-grpc/2.4.1/akka/grpc/GrpcClientSettings.html" title="akka.grpc.GrpcClientSettings"><code>GrpcClientSettings</code></a></span><span class="group-java"><a href="/api/akka-grpc/2.4.1/akka/grpc/GrpcClientSettings.html" title="akka.grpc.GrpcClientSettings"><code>GrpcClientSettings</code></a></span> passed to the client when it is created, it will be the base metadata used for each request.</p>
<p>In some cases you will want to provide specific metadata to a single request, this can be done through the &ldquo;lifted&rdquo; client API, each method of the service has an empty parameter list version (<code>.sayHello()</code>) on the client returning a <span class="group-java"><a href="/api/akka-grpc/2.4.1/akka/grpc/javadsl/SingleResponseRequestBuilder.html" title="akka.grpc.javadsl.SingleResponseRequestBuilder"><code>SingleResponseRequestBuilder</code></a></span><span class="group-scala"><a href="/api/akka-grpc/2.4.1/akka/grpc/scaladsl/SingleResponseRequestBuilder.html" title="akka.grpc.scaladsl.SingleResponseRequestBuilder"><code>SingleResponseRequestBuilder</code></a></span> or <span class="group-java"><a href="/api/akka-grpc/2.4.1/akka/grpc/javadsl/StreamResponseRequestBuilder.html" title="akka.grpc.javadsl.StreamResponseRequestBuilder"><code>StreamResponseRequestBuilder</code></a></span><span class="group-scala"><a href="/api/akka-grpc/2.4.1/akka/grpc/scaladsl/StreamResponseRequestBuilder.html" title="akka.grpc.scaladsl.StreamResponseRequestBuilder"><code>StreamResponseRequestBuilder</code></a></span>.</p>
<p>After adding the required metadata the request is done by calling <code>invoke</code> with the request parameters.</p>
<p>Notice: method <code>addHeader</code> return a new object, you should use it like <code>String</code> or use it in the chain structure.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-grpc/tree/v2.4.1/plugin-tester-scala/src/main/scala/example/myapp/helloworld/LiftedGreeterClient.scala#L36-L40" target="_blank" title="Go to snippet source">source</a><code class="language-scala">def singleRequestReply(): Unit = {
  sys.log.info(&quot;Performing request&quot;)
  val reply = client.sayHello().addHeader(&quot;key&quot;, &quot;value&quot;).invoke(HelloRequest(&quot;Alice&quot;))
  println(s&quot;got single reply: ${Await.result(reply, 5.seconds).message}&quot;)
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-grpc/tree/v2.4.1/plugin-tester-java/src/main/java/example/myapp/helloworld/LiftedGreeterClient.java#L58-L64" target="_blank" title="Go to snippet source">source</a><code class="language-java">private static void singleRequestReply(GreeterServiceClient client) throws Exception {
  HelloRequest request = HelloRequest.newBuilder().setName(&quot;Alice&quot;).build();
  CompletionStage&lt;HelloReply&gt; reply = client.sayHello()
      .addHeader(&quot;key&quot;, &quot;value&quot;)
      .invoke(request);
  System.out.println(&quot;got single reply: &quot; + reply.toCompletableFuture().get(5, TimeUnit.SECONDS));
}</code></pre></dd>
</dl>
<h2><a href="#rich-error-model" name="rich-error-model" class="anchor"><span class="anchor-link"></span></a>Rich error model</h2>
<p>Beyond status codes you can also use the <a href="https://www.grpc.io/docs/guides/error/#richer-error-model">Rich error model</a>.</p>
<p>Extract the <code>GrpcServiceException</code> to access <code>code</code>, <code>message</code> and <code>details</code>.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-grpc/tree/v2.4.1/interop-tests/src/test/scala/akka/grpc/scaladsl/RichErrorModelNativeSpec.scala#L85-L105" target="_blank" title="Go to snippet source">source</a><code class="language-scala">val richErrorResponse = client.sayHello(HelloRequest(&quot;Bob&quot;)).failed.futureValue

richErrorResponse match {
  case status: GrpcServiceException =&gt;
    status.metadata match {
      case richMetadata: MetadataStatus =&gt;
        richMetadata.details(0).typeUrl should be(&quot;type.googleapis.com/google.rpc.LocalizedMessage&quot;)

        import LocalizedMessage.messageCompanion
        val localizedMessage = richMetadata.getParsedDetails[LocalizedMessage].head
        localizedMessage.message should be(&quot;The password!&quot;)
        localizedMessage.locale should be(&quot;EN&quot;)

        richMetadata.code should be(3)
        richMetadata.message should be(&quot;What is wrong?&quot;)

      case other =&gt; fail(s&quot;This should be a RichGrpcMetadataImpl but it is ${other.getClass}&quot;)
    }

  case ex =&gt; fail(s&quot;This should be a GrpcServiceException but it is ${ex.getClass}&quot;)
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-grpc/tree/v2.4.1/interop-tests/src/test/java/example/myapp/helloworld/grpc/RichErrorModelNativeTest.java#L61-L76" target="_blank" title="Go to snippet source">source</a><code class="language-java">HelloRequest request = HelloRequest.newBuilder().setName(&quot;Alice&quot;).build();
CompletionStage&lt;HelloReply&gt; response = client.sayHello(request);
StatusRuntimeException statusRuntimeException = response.toCompletableFuture().handle((res, ex) -&gt; {
    return (StatusRuntimeException) ex;
}).get();

GrpcServiceException ex = GrpcServiceException.apply(statusRuntimeException);
MetadataStatus meta = (MetadataStatus) ex.getMetadata();
assertEquals(&quot;type.googleapis.com/google.rpc.LocalizedMessage&quot;, meta.getDetails().get(0).typeUrl());

assertEquals(Status.INVALID_ARGUMENT.getCode().value(), meta.getCode());
assertEquals(&quot;What is wrong?&quot;, meta.getMessage());

LocalizedMessage details = meta.getParsedDetails(LocalizedMessage.messageCompanion()).get(0);
assertEquals(&quot;The password!&quot;, details.message());
assertEquals(&quot;EN&quot;, details.locale());</code></pre></dd>
</dl>
<p>Please look <a href="../server/details.html">here</a> how to create errors with such details on the server side.</p>
</div>
</article>
<div class="row">
<div class="small-12 column">
<section class="nav-prev-next row">
<div class="nav-prev small-6 column">
<a href="../client/configuration.html"><i class="icon-prev"></i> <span class="link-prev">Configuration</span></a>
</div>
<div class="nav-next small-6 column clearfix">
<a class="float-right" href="../buildtools/index.html">Build Tool Support <i class="icon-next"></i></a>
</div>
</section>
</div>
</div>
<div class="source-github row">
Found an error in this documentation? The source code for this page can be found <a href="https://github.com/akka/akka-grpc/tree/v2.4.1/docs/src/main/paradox/client/details.md">here</a>.
Please feel free to edit and contribute a pull request.
</div>

<footer class="page-footer row clearfix">
<img class="akka-icon float-left show-for-medium" src="../images/akka-icon.svg" />
<section class="copyright">
<div>Akka gRPC is available under the <a href="https://www.lightbend.com/akka/license" target="_blank">Business Source License 1.1</a>.</div>
<p class="legal">
&copy; 2011-2024 <a href="https://www.lightbend.com" target="_blank">Lightbend, Inc.</a> |
<a href="https://www.lightbend.com/legal/licenses" target="_blank">Licenses</a> |
<a href="https://www.lightbend.com/legal/terms" target="_blank">Terms</a> |
<a href="https://www.lightbend.com/legal/privacy" target="_blank">Privacy Policy</a> |
<a href="https://akka.io/cookie/" target="_blank">Cookie Listing</a> |
<a class="optanon-toggle-display">Cookie Settings</a>
</p>
</section>

</footer>
</section>
</main>
</div>

<script type="text/javascript" src="../js/scrollsneak.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../js/groups.js"></script>
<script type="text/javascript" src="../js/page.js"></script>
<script type="text/javascript" src="../js/snippets.js"></script>
<script type="text/javascript" src="../js/magellan.js"></script>
<script type="text/javascript" src="../js/metadata-toggle.js"></script>
<script type="text/javascript" src="../js/lbHeader.js"></script>

<style type="text/css">@import "../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(){window.prettyPrint && prettyPrint()});
//]]></script>
<script type="text/javascript" src="../assets/js/warnOldVersion.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(jq){initOldVersionWarnings(jq, '2.4.1', 'https://doc.akka.io/docs/akka-grpc/current/')});
//]]></script>


</body>
</html>
