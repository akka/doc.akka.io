<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Error handling &bull; Alpakka Kafka Documentation</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="Handle errors from the Kafka API in Alpakka Kafka."/>
<link rel="canonical" href="https://doc.akka.io/docs/alpakka-kafka/current/errorhandling.html"/>
<script type="text/javascript" src="lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="lib/foundation/dist/js/foundation.min.js"></script>
<link rel="stylesheet" type="text/css" href="lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="lib/foundation/dist/css/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" type="text/css" href="css/icons.css"/>
<link rel="stylesheet" type="text/css" href="css/page-8.css"/>
<link rel="stylesheet" type="text/css" href="css/banner-2.css"/>
<link rel="shortcut icon" href="images/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png"/>
<link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png"/>
<link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png"/>
<link rel="manifest" href="images/manifest.json"/>
<meta name="msapplication-TileImage" content="images/mstile-150x150.png"/>
<meta name="msapplication-TileColor" content="#15a9ce"/>
<meta name="theme-color" content="#15a9ce"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) start -->
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js"  type="text/javascript" charset="UTF-8" data-domain-script="28b912e7-09e9-43d5-91e4-3d1897044004" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) end -->
<!--Google Analytics NOTE this will stop processing data July 1st 2023. At which point this embed code can be removed-->
<script type="text/plain" class="optanon-category-2">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', '']);
_gaq.push(['_setDomainName', '']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})()
</script>

<!-- Google Tag Manager: Updated May 17th 2023 - Cookie Compliance checks have been moved into Google Tag Manager -->
<script type="text/javascript">
(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KBJGH35');
</script>

</head>

<body id="underlay" data-toggler="nav-open">
<div id="lightbend-banner" class="lightbend-banner akka full-width" data-category="OSS Lightbend Banner Impression" data-label="Akka Banner Impression">
<div class="oss-wrapper">
<div class="oss-brand">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lightbend Logo - Akka Banner" href="https://www.lightbend.com">
<img class="lightbend-logo" src="images/banner-logos/lightbend-reverse.svg" alt="Lightbend" title="Lightbend">
</a>
</div>
<div class="oss-ad no-drop-down">
<nav id="lightbendRotator" class="lightbend-rotator">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Promo Rotator - Lightbend Changed its Software Licensing Model for Akka Technology. [License FAQ] - Akka Banner" href="https://www.lightbend.com/akka/license-faq">
<strong>Lightbend</strong> Changed its Software Licensing Model for Akka Technology. <span class="akka-btn">License FAQ</span>
</a>
</nav>
</div>
</div>
</div>

<header class="site-header hide-for-large">
<div class="sticky-header clearfix">
<a href="https://akka.io"><img class="logo" src="images/akka-alpakka-reverse.svg"></a>

<button class="menu-icon float-right" type="button" data-toggle="underlay overlay"></button>
</div>
<div id="overlay" class="overlay-nav" data-toggler="nav-open">
<header class="nav-header">
<div class="nav-header-title">
<h1><a href="index.html">Alpakka Kafka Documentation</a></h1>
</div>
<div class="nav-header-version">
Version 5.0.0-M1
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="nav-toc">
<ul>
  <li><a href="home.html" class="page">Overview</a></li>
  <li><a href="producer.html" class="page">Producer</a></li>
  <li><a href="consumer.html" class="page">Consumer</a></li>
  <li><a href="discovery.html" class="page">Service discovery</a></li>
  <li><a href="cluster-sharding.html" class="page">Akka Cluster Sharding</a></li>
  <li><a href="errorhandling.html#error-handling" class="active page">Error handling</a>
  <ul>
    <li><a href="errorhandling.html#failing-consumer" class="header">Failing consumer</a></li>
    <li><a href="errorhandling.html#failing-producer" class="header">Failing producer</a></li>
    <li><a href="errorhandling.html#restarting-the-stream-with-a-backoff-stage" class="header">Restarting the stream with a backoff stage</a></li>
    <li><a href="errorhandling.html#unexpected-consumer-offset-reset" class="header">Unexpected consumer offset reset</a></li>
  </ul></li>
  <li><a href="atleastonce.html" class="page">At-Least-Once Delivery</a></li>
  <li><a href="transactions.html" class="page">Transactions</a></li>
  <li><a href="serialization.html" class="page">Serialization</a></li>
  <li><a href="debugging.html" class="page">Debugging</a></li>
  <li><a href="testing.html" class="page">Testing</a></li>
  <li><a href="production.html" class="page">Production considerations</a></li>
  <li><a href="snapshots.html" class="page">Snapshots</a></li>
</ul>
</nav>
</div>
</header>
<div class="site-content-wrapper">
<aside class="sticky-sidebar show-for-large">
<header class="nav-header sticky-sidebar-header">
<div class="nav-header-title">
<h1><a href="index.html">Alpakka Kafka Documentation</a></h1>
</div>
<div class="nav-header-version">
Version 5.0.0-M1
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="site-nav sticky-sidebar-contents">
<div class="nav-toc">
<ul>
  <li><a href="home.html" class="page">Overview</a></li>
  <li><a href="producer.html" class="page">Producer</a></li>
  <li><a href="consumer.html" class="page">Consumer</a></li>
  <li><a href="discovery.html" class="page">Service discovery</a></li>
  <li><a href="cluster-sharding.html" class="page">Akka Cluster Sharding</a></li>
  <li><a href="errorhandling.html#error-handling" class="active page">Error handling</a>
  <ul>
    <li><a href="errorhandling.html#failing-consumer" class="header">Failing consumer</a></li>
    <li><a href="errorhandling.html#failing-producer" class="header">Failing producer</a></li>
    <li><a href="errorhandling.html#restarting-the-stream-with-a-backoff-stage" class="header">Restarting the stream with a backoff stage</a></li>
    <li><a href="errorhandling.html#unexpected-consumer-offset-reset" class="header">Unexpected consumer offset reset</a></li>
  </ul></li>
  <li><a href="atleastonce.html" class="page">At-Least-Once Delivery</a></li>
  <li><a href="transactions.html" class="page">Transactions</a></li>
  <li><a href="serialization.html" class="page">Serialization</a></li>
  <li><a href="debugging.html" class="page">Debugging</a></li>
  <li><a href="testing.html" class="page">Testing</a></li>
  <li><a href="production.html" class="page">Production considerations</a></li>
  <li><a href="snapshots.html" class="page">Snapshots</a></li>
</ul>
</div>
</nav>
<footer class="nav-footer sticky-sidebar-footer">
<a href="https://akka.io"><img class="logo" src="images/akka-alpakka-reverse.svg"></a>

</footer>
</aside>
<main class="fixed-shift-for-large expanded row">
<section class="site-content small-12 column">
<article class="page-content row">
<div class="small-12 column" id="docs">
<h1><a href="#error-handling" name="error-handling" class="anchor"><span class="anchor-link"></span></a>Error handling</h1>
<h2><a href="#failing-consumer" name="failing-consumer" class="anchor"><span class="anchor-link"></span></a>Failing consumer</h2>
<p>Errors from the Kafka consumer will be forwarded to the Alpakka sources that use it, the sources will fail their streams.</p>
<h3><a href="#lost-connection-to-the-kafka-broker" name="lost-connection-to-the-kafka-broker" class="anchor"><span class="anchor-link"></span></a>Lost connection to the Kafka broker</h3>
<p>To fail a Alpakka Kafka consumer in case the Kafka broker is not available, configure a <strong>Connection Checker</strong> via <span class="group-scala"><a href="/api/alpakka-kafka/5.0.0-M1/akka/kafka/ConsumerSettings.html" title="akka.kafka.ConsumerSettings"><code>ConsumerSettings</code></a></span><span class="group-java"><a href="/api/alpakka-kafka/5.0.0-M1/akka/kafka/ConsumerSettings.html" title="akka.kafka.ConsumerSettings"><code>ConsumerSettings</code></a></span>. If not <strong>Connection Checker</strong> is configured, Alpakka will continue to poll the broker indefinitely.</p>
<h2><a href="#failing-producer" name="failing-producer" class="anchor"><span class="anchor-link"></span></a>Failing producer</h2>
<p>Retry handling for producers is built-in into Kafka. In case of failure when sending a message, an exception will be thrown, which should fail the stream. </p>
<h2><a href="#restarting-the-stream-with-a-backoff-stage" name="restarting-the-stream-with-a-backoff-stage" class="anchor"><span class="anchor-link"></span></a>Restarting the stream with a backoff stage</h2>
<p>Akka streams <a href="https://doc.akka.io/docs/akka/2.9/stream/stream-error.html#delayed-restarts-with-a-backoff-stage">provides graph stages</a> to gracefully restart a stream on failure, with a configurable backoff. This can be taken advantage of to restart a failing stream and its consumer with an exponential backoff, by wrapping it in a <code>RestartSource</code>.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/alpakka-kafka/tree/v5.0.0-M1/tests/src/test/scala/docs/scaladsl/ConsumerExample.scala#L541-L558" target="_blank" title="Go to snippet source">source</a><code class="language-scala">val control = new AtomicReference[Consumer.Control](Consumer.NoopControl)

val restartSettings = RestartSettings(minBackoff = 3.seconds, maxBackoff = 30.seconds, randomFactor = 0.2)
val streamCompletion = RestartSource
  .onFailuresWithBackoff(restartSettings) { () =&gt;
    Consumer
      .plainSource(consumerSettings, Subscriptions.topics(topic))
      // this is a hack to get access to the Consumer.Control
      // instances of the latest Kafka Consumer source
      .mapMaterializedValue(c =&gt; control.set(c))
      .via(businessFlow)
  }
  .runWith(Sink.seq)

control.get().drainAndShutdown(streamCompletion)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/alpakka-kafka/tree/v5.0.0-M1/tests/src/test/java/docs/javadsl/ConsumerExampleTest.java#L429-L451" target="_blank" title="Go to snippet source">source</a><code class="language-java">AtomicReference&lt;Consumer.Control&gt; control = new AtomicReference&lt;&gt;(Consumer.createNoopControl());

RestartSettings restartSettings =
    RestartSettings.create(Duration.ofSeconds(3), Duration.ofSeconds(30), 0.2);
CompletionStage&lt;Done&gt; streamCompletion =
    RestartSource.onFailuresWithBackoff(
            restartSettings,
            () -&gt;
                Consumer.plainSource(consumerSettings, Subscriptions.topics(topic))
                    .mapMaterializedValue(
                        c -&gt; {
                          // this is a hack to get access to the Consumer.Control
                          // instances of the latest Kafka Consumer source
                          control.set(c);
                          return c;
                        })
                    .via(business()))
        .runWith(Sink.ignore(), system);

control.get().drainAndShutdown(streamCompletion, system.getDispatcher());</code></pre></dd>
</dl>
<p>When a stream fails, library internals will handle all underlying resources.</p><div class="callout note "><div class="callout-title">(de)serialization</div>
<p>If reading from Kafka failure is caused by other reasons, like <strong>deserialization problems</strong>, then the stage will fail immediately. If you expect such cases, consider consuming raw byte arrays and deserializing in a subsequent <code>map</code> stage where you can use supervision to skip failed elements. See also <a href="serialization.html">Serialization</a> and <a href="atleastonce.html">&ldquo;At least once&rdquo;</a> pages for more suggestions.</p></div>
<h2><a href="#unexpected-consumer-offset-reset" name="unexpected-consumer-offset-reset" class="anchor"><span class="anchor-link"></span></a>Unexpected consumer offset reset</h2>
<p>Sometimes, due to various Kafka server bugs (see below) the consumer will fail to fetch on offset that  exists. In this case, the consumer has three approaches to handling the missing offset:</p>
<ul>
  <li>No action: consumer fails and stops attempting to make progress.</li>
  <li>Latest: consumer skips to the end of the partition and starts reading from there.
    <ul>
      <li><strong>NOTE</strong>: consumer can skip processing some data in the topic by going to the latest data</li>
    </ul>
  </li>
  <li>Earliest: consumer restarts from the beginning of the partition.
    <ul>
      <li><strong>NOTE</strong>: consumer will never skip data, but may reprocess many days of data, up to the topic&rsquo;s configured  retention</li>
    </ul>
  </li>
</ul>
<p>Alpakka Kafka cannot do anything for the first two approaches. However, the <code>offset-reset-protection</code> configuration in  the <code>ConsumerSettings</code> can help detect the inadvertent loss of offsets and subsequent reset. You can configure <code>akka.kafka.consumer.offset-reset-protection.offset-threshold</code> to a number of offsets back from the <em>latest requested  offset</em> that would indicate one of these reset bugs has occurred. Similarly, setting <code>akka.kafka.consumer.offset-reset-protection.time-threshold</code> will reset the consumer back to the latest committed offset  when a record is older than <code>now - time-threshold</code>; that is, <code>time-threshold</code> older than the last received offset.</p>
<p>When the client notices that the offset from the next fetched batch is outside the threshold for a given partition, the consumer will be re-seeked back the latest committed offset; the last known &lsquo;safe&rsquo; point in the data. The consumer will then start consuming from that offset forward. This can avoid a significant amount of wasted data processing and keep  your consumers&rsquo; progress moving forward (and avoid being paged for high consumer lag).</p>
<p>For example, lets assume there is a consumer that has committed offset 1000 on partition 1. The consumer is doing work in batches, so it doesn&rsquo;t commit and fetch every record, so now it attempts to fetch offset 1100. However, due to a server-side bug, Kafka returns offset 1 for partition 1. Without consumer reset protection, the consumer  would then need to reprocess all the offsets from 1 to 1000 (this can often look like a consumer &ldquo;rewinding&rdquo;). With consumer reset protection enabled with a threshold of, for example, 200 the consumer would notice the reset and then fetch again from the latest offset. That means, the consumer would only need to process 100 messages to catch up, a 10x improvement from the 1000 messages it would have had to process with offset-reset-protection enabled.</p>
<p>By default, consumer reset protection is <strong>off</strong>. You must set <code>akka.kafka.consumer.offset-reset-protection.enable = true</code>, and set one of the thresholds, to enable it.</p>
<p>Internally, the consumer attempts to avoid too much overhead in checking each batch, so it verifies only that the first and the last offset in each received batch for each partition are within the threshold. This should have a minimal impact on consumer performance, but as always, be sure to benchmark for your use case before enabling. </p>
<h3><a href="#setting-offset-threshold-appropriately" name="setting-offset-threshold-appropriately" class="anchor"><span class="anchor-link"></span></a>Setting offset threshold appropriately</h3>
<p>Generally speaking offsets should only be used to define reset thresholds when consuming records whose timestamps are  <code>-1</code> (often only seen with old, 0.11 consumers); instead prefer to use <code>time-threshold</code>consumer reset protection  configuration. </p>
<p>If you set the offset threshold to less than the frequency at which you commit, any reset protection that takes place will likely cause you reprocess more data than necessary. For example, assume you commit every 1000 records, but have <code>offset-reset-protection.offset-threshold</code> set to 500 records then a reset could then cause you to-reprocess up to 999 records in the worst case. </p>
<p>You should set the consumer reset protection to the number of offsets near the topic&rsquo;s configured retention. Alternatively, you can (a) increase the frequency with which you commit or (b) increase the offset protection window.</p>
<h3><a href="#kafka-broker-offset-reset-issues" name="kafka-broker-offset-reset-issues" class="anchor"><span class="anchor-link"></span></a>Kafka broker offset reset issues</h3>
<ul>
  <li><a href="https://issues.apache.org/jira/browse/KAFKA-7414">KAFKA-7414</a></li>
  <li><a href="https://issues.apache.org/jira/browse/KAFKA-7447">KAFKA-7447</a></li>
  <li><a href="https://issues.apache.org/jira/browse/KAFKA-8896">KAFKA-8896</a></li>
  <li><a href="https://issues.apache.org/jira/browse/KAFKA-9543">KAFKA-9543</a></li>
  <li><a href="https://issues.apache.org/jira/browse/KAFKA-9807">KAFKA-9807</a></li>
  <li><a href="https://issues.apache.org/jira/browse/KAFKA-9824">KAFKA-9824</a></li>
  <li><a href="https://issues.apache.org/jira/browse/KAFKA-9835">KAFKA-9835</a></li>
  <li><a href="https://issues.apache.org/jira/browse/KAFKA-10313">KAFKA-10313</a></li>
</ul>
</div>
</article>
<div class="row">
<div class="small-12 column">
<section class="nav-prev-next row">
<div class="nav-prev small-6 column">
<a href="cluster-sharding.html"><i class="icon-prev"></i> <span class="link-prev">Akka Cluster Sharding</span></a>
</div>
<div class="nav-next small-6 column clearfix">
<a class="float-right" href="atleastonce.html">At-Least-Once Delivery <i class="icon-next"></i></a>
</div>
</section>
</div>
</div>
<div class="source-github row">
Found an error in this documentation? The source code for this page can be found <a href="https://github.com/akka/alpakka-kafka/tree/v5.0.0-M1/docs/src/main/paradox/errorhandling.md">here</a>.
Please feel free to edit and contribute a pull request.
</div>

<footer class="page-footer row clearfix">
<img class="akka-icon float-left show-for-medium" src="images/akka-icon.svg" />
<section class="copyright">
<div>Alpakka Kafka is available under the <a href="https://www.lightbend.com/akka/license" target="_blank">Business Source License 1.1</a>.</div>
<p class="legal">
&copy; 2011-2023 <a href="https://www.lightbend.com" target="_blank">Lightbend, Inc.</a> |
<a href="https://www.lightbend.com/legal/licenses" target="_blank">Licenses</a> |
<a href="https://www.lightbend.com/legal/terms" target="_blank">Terms</a> |
<a href="https://www.lightbend.com/legal/privacy" target="_blank">Privacy Policy</a> |
<a href="https://akka.io/cookie/" target="_blank">Cookie Listing</a> |
<a class="optanon-toggle-display">Cookie Settings</a>
</p>
</section>

</footer>
</section>
</main>
</div>

<script type="text/javascript" src="js/scrollsneak.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="js/groups.js"></script>
<script type="text/javascript" src="js/page.js"></script>
<script type="text/javascript" src="js/snippets.js"></script>
<script type="text/javascript" src="js/magellan.js"></script>
<script type="text/javascript" src="js/metadata-toggle.js"></script>
<script type="text/javascript" src="js/lbHeader.js"></script>

<style type="text/css">@import "lib/prettify/prettify.css";</style>
<script type="text/javascript" src="lib/prettify/prettify.js"></script>
<script type="text/javascript" src="lib/prettify/lang-scala.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(){window.prettyPrint && prettyPrint()});
//]]></script>
<script type="text/javascript" src="assets/js/warnOldVersion.js"></script>
<script type="text/javascript">jQuery(function(jq){initOldVersionWarnings(jq, '5.0.0-M1', 'https://doc.akka.io/docs/alpakka-kafka/current')});</script>


</body>
</html>
