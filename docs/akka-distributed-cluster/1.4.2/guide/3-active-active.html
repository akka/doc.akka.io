<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Part 3: Active-active &bull; Akka Distributed Cluster</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="Akka Projection."/>
<link rel="canonical" href="https://doc.akka.io/docs/akka-distributed-cluster/current/guide/3-active-active.html"/>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../lib/foundation/dist/js/foundation.min.js"></script>
<link rel="stylesheet" type="text/css" href="../lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="../lib/foundation/dist/css/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" type="text/css" href="../css/icons.css"/>
<link rel="stylesheet" type="text/css" href="../css/page-8.css"/>
<link rel="stylesheet" type="text/css" href="../css/banner-2.css"/>
<link rel="shortcut icon" href="../images/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="../images/apple-touch-icon.png"/>
<link rel="icon" type="image/png" sizes="32x32" href="../images/favicon-32x32.png"/>
<link rel="icon" type="image/png" sizes="16x16" href="../images/favicon-16x16.png"/>
<link rel="manifest" href="../images/manifest.json"/>
<meta name="msapplication-TileImage" content="../images/mstile-150x150.png"/>
<meta name="msapplication-TileColor" content="#15a9ce"/>
<meta name="theme-color" content="#15a9ce"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) start -->
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js"  type="text/javascript" charset="UTF-8" data-domain-script="28b912e7-09e9-43d5-91e4-3d1897044004" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) end -->
<!--Google Analytics-->
<script type="text/plain" class="optanon-category-2">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', '']);
_gaq.push(['_setDomainName', '']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})()
</script>
<!-- Google Tag Manager -->
<script type="text/plain" class="optanon-category-2">
(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KBJGH35');
</script>
<!--Marketo-->
<script type="text/plain" class="optanon-category-3">
(function() {
var didInit = false;
function initMunchkin() {
if(didInit === false) {
didInit = true;
Munchkin.init('558-NCX-702', { 'asyncOnly': true, 'disableClickDelay': true });
}
}
var s = document.createElement('script');
s.type = 'text/javascript';
s.async = true;
s.src = '//munchkin.marketo.net/munchkin.js';
s.onreadystatechange = function() {
if (this.readyState == 'complete' || this.readyState == 'loaded') {
initMunchkin();
}
};
s.onload = initMunchkin;
document.getElementsByTagName('head')[0].appendChild(s);
})();
</script>
</head>

<body id="underlay" data-toggler="nav-open">
<div id="lightbend-banner" class="lightbend-banner akka full-width" data-category="OSS Lightbend Banner Impression" data-label="Akka Banner Impression">
<div class="oss-wrapper">
<div class="oss-brand">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lightbend Logo - Akka Banner" href="https://www.lightbend.com">
<img class="lightbend-logo" src="../images/banner-logos/lightbend-reverse.svg" alt="Lightbend" title="Lightbend">
</a>
</div>
<div class="oss-ad no-drop-down">
<nav id="lightbendRotator" class="lightbend-rotator">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Promo Rotator - Lightbend Changed its Software Licensing Model for Akka Technology. [License FAQ] - Akka Banner" href="https://www.lightbend.com/akka/license-faq">
<strong>Lightbend</strong> Changed its Software Licensing Model for Akka Technology. <span class="akka-btn">License FAQ</span>
</a>
</nav>
</div>
</div>
</div>

<header class="site-header hide-for-large">
<div class="sticky-header clearfix">
<a href="https://akka.io"><img class="logo" src="../images/akka-logo-reverse.svg"/></a>

<button class="menu-icon float-right" type="button" data-toggle="underlay overlay"></button>
</div>
<div id="overlay" class="overlay-nav" data-toggler="nav-open">
<header class="nav-header">
<div class="nav-header-title">
<h1><a href="../index.html">Akka Distributed Cluster</a></h1>
</div>
<div class="nav-header-version">
Version 1.4.2
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="nav-toc">
<ul>
  <li><a href="../overview.html" class="page">Architectural Overview</a></li>
  <li><a href="../use-cases.html" class="page">Example Use Cases</a></li>
  <li><a href="../feature-summary.html" class="page">Feature Summary</a></li>
  <li><a href="../guide.html" class="page">Guide</a>
  <ul>
    <li><a href="../guide/1-event-sourced-shopping-cart.html" class="page">Part 1: Event Sourced Shopping Cart</a></li>
    <li><a href="../guide/2-service-to-service.html" class="page">Part 2: Service to Service eventing</a></li>
    <li><a href="../guide/3-active-active.html#part-3-active-active" class="active page">Part 3: Active-active</a>
    <ul>
      <li><a href="../guide/3-active-active.html#turning-the-shopping-cart-into-a-replicated-entity" class="header">Turning the shopping cart into a Replicated Entity</a></li>
      <li><a href="../guide/3-active-active.html#filters" class="header">Filters</a></li>
      <li><a href="../guide/3-active-active.html#complete-sample-projects" class="header">Complete Sample Projects</a></li>
      <li><a href="../guide/3-active-active.html#running-the-sample-code-locally" class="header">Running the sample code locally</a></li>
      <li><a href="../guide/3-active-active.html#whats-next-" class="header">What&rsquo;s next?</a></li>
    </ul></li>
    <li><a href="../guide/4-deploying.html" class="page">Part 4: Deploying with Kubernetes</a></li>
  </ul></li>
</ul>
</nav>
</div>
</header>
<div class="site-content-wrapper">
<aside class="sticky-sidebar show-for-large">
<header class="nav-header sticky-sidebar-header">
<div class="nav-header-title">
<h1><a href="../index.html">Akka Distributed Cluster</a></h1>
</div>
<div class="nav-header-version">
Version 1.4.2
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="site-nav sticky-sidebar-contents">
<div class="nav-toc">
<ul>
  <li><a href="../overview.html" class="page">Architectural Overview</a></li>
  <li><a href="../use-cases.html" class="page">Example Use Cases</a></li>
  <li><a href="../feature-summary.html" class="page">Feature Summary</a></li>
  <li><a href="../guide.html" class="page">Guide</a>
  <ul>
    <li><a href="../guide/1-event-sourced-shopping-cart.html" class="page">Part 1: Event Sourced Shopping Cart</a></li>
    <li><a href="../guide/2-service-to-service.html" class="page">Part 2: Service to Service eventing</a></li>
    <li><a href="../guide/3-active-active.html#part-3-active-active" class="active page">Part 3: Active-active</a>
    <ul>
      <li><a href="../guide/3-active-active.html#turning-the-shopping-cart-into-a-replicated-entity" class="header">Turning the shopping cart into a Replicated Entity</a></li>
      <li><a href="../guide/3-active-active.html#filters" class="header">Filters</a></li>
      <li><a href="../guide/3-active-active.html#complete-sample-projects" class="header">Complete Sample Projects</a></li>
      <li><a href="../guide/3-active-active.html#running-the-sample-code-locally" class="header">Running the sample code locally</a></li>
      <li><a href="../guide/3-active-active.html#whats-next-" class="header">What&rsquo;s next?</a></li>
    </ul></li>
    <li><a href="../guide/4-deploying.html" class="page">Part 4: Deploying with Kubernetes</a></li>
  </ul></li>
</ul>
</div>
</nav>
<footer class="nav-footer sticky-sidebar-footer">
<a href="https://akka.io"><img class="logo" src="../images/akka-logo-reverse.svg"/></a>

</footer>
</aside>
<main class="fixed-shift-for-large expanded row">
<section class="site-content small-12 column">
<article class="page-content row">
<div class="small-12 column" id="docs">
<h1><a href="#part-3-active-active" name="part-3-active-active" class="anchor"><span class="anchor-link"></span></a>Part 3: Active-active</h1>
<p>Active-active means that the same shopping cart is in memory in multiple locations, replicas, and can accept updates in all of those locations, so that a cloud region outage does not block users from continuing to use the service. </p>
<p><img src="../images/res-over-grpc.svg" alt="Diagram showing Replicated Ecent Sourcing over gRPC between three services" /></p>
<p><a href="https://doc.akka.io/docs/akka/2.8/typed/replicated-eventsourcing.html">Akka Replicated Event Sourcing</a> stores persisted events in a local database, without any need for replication capabilities in the database itself, the events are then replicated using the <a href="https://doc.akka.io/docs/akka-projection/1.4.0/grpc-replicated-event-sourcing-transport.html">Akka Replicated Event Sourcing gRPC transport</a>.</p>
<p>The shopping cart will be eventually consistent, meaning that an update to the cart in one replica will not immediately be visible in the other replicas, but eventually all replicas will reach the same state. </p>
<h2><a href="#turning-the-shopping-cart-into-a-replicated-entity" name="turning-the-shopping-cart-into-a-replicated-entity" class="anchor"><span class="anchor-link"></span></a>Turning the shopping cart into a Replicated Entity</h2>
<p>The API for writing a Replicated Event Sourced entity is mostly the exact same as the Event Sourced Behavior we already implemented our entity with. </p>
<p>The events from other replicas will be replicated and are passed to the event handler of the entity just like events that was written by the shopping cart instance itself, however there is no global ordering of the events, so events may be seen in a different order than the wall clock order they happened, and in a different order in each replica, especially in circumstances where there are outages or connectivity problems between the replicas.</p>
<h3><a href="#updating-the-cart-contents" name="updating-the-cart-contents" class="anchor"><span class="anchor-link"></span></a>Updating the cart contents</h3>
<p>Because of the possibility of observing the events out of order when they have been written to different replicas, we must make sure the state ends up the same even in the face of re-ordered events. </p>
<p>This can be handled by keeping track of the quantity of an item both when it is positive and negative, so that seeing a remove of 1 item before an add 1 of the same item ends up as the item removed with a zero quantity. We have already represented add and remove as a negative or positive number in the <code>ItemUpdatedEvent</code></p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/replicated/shopping-cart-service-scala/src/main/scala/shopping/cart/ShoppingCart.scala#L162" target="_blank" title="Go to snippet source">source</a><code class="language-scala">final case class ItemUpdated(itemId: String, quantity: Int) extends Event</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/replicated/shopping-cart-service-java/src/main/java/shopping/cart/ShoppingCart.java#L224-L231" target="_blank" title="Go to snippet source">source</a><code class="language-java">static final class ItemUpdated extends Event {
  public final String itemId;
  public final int quantity;

  public ItemUpdated(String itemId, int quantity) {
    this.itemId = itemId;
    this.quantity = quantity;
  }</code></pre></dd>
</dl>
<p>In the state, we keep a map from <code>itemId</code> to the current quantity for each product. For each update we see, we add the positive or negative number to the quantity, getting the same number regardless of what order the changes arrived:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/replicated/shopping-cart-service-scala/src/main/scala/shopping/cart/ShoppingCart.scala#L52-L67" target="_blank" title="Go to snippet source">source</a><code class="language-scala">final case class State(
    items: Map[String, Int],
    closed: Set[ReplicaId],
    checkedOut: Option[Instant],
    vipCustomer: Boolean)
    extends CborSerializable {
  def updateItem(itemId: String, quantity: Int): State =
    copy(items = items + (itemId -&gt; (items.getOrElse(itemId, 0) + quantity)))</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/replicated/shopping-cart-service-java/src/main/java/shopping/cart/ShoppingCart.java#L59-L88" target="_blank" title="Go to snippet source">source</a><code class="language-java">static final class State implements CborSerializable {
  final Map&lt;String, Integer&gt; items;
  final Set&lt;ReplicaId&gt; closed;
  private Optional&lt;Instant&gt; checkedOut;
  private boolean vipCustomer = false;

  public State updateItem(String itemId, int quantity) {
    items.put(itemId, items.getOrDefault(itemId, 0) + quantity);
    return this;
  }</code></pre></dd>
</dl>
<h3><a href="#checking-the-cart-out" name="checking-the-cart-out" class="anchor"><span class="anchor-link"></span></a>Checking the cart out</h3>
<p>Another, more complex thing to deal with is checking out. When we had only one instance of the cart, it was safe to say that after a checkout event, no more updates could happen to the shopping cart. With a replicated cart this is no longer the case as an update could be sent to one replica, and the checkout to another, so that the update arrives to the checked out replica after it was checked out, even though at the time of the update, the cart was not yet checked out.</p>
<p>We can solve this by turning checkout into a two-step process, where the initial checkout triggers storing a checkout event per replica, and letting one of the replicas get a designation as leader, completing the checkout once it has seen checkout events from all replicas.</p>
<p>When we receive a checkout command, we store a <code>Closed</code> event which also contains the id of the replica. We can get the &ldquo;self&rdquo; replica id from the <span class="group-java"><a href="https://doc.akka.io/japi/akka/2.8/akka/persistence/typed/javadsl/ReplicationContext.html" title="akka.persistence.typed.javadsl.ReplicationContext"><code>ReplicationContext</code></a></span><span class="group-scala"><a href="https://doc.akka.io/api/akka/2.8/akka/persistence/typed/scaladsl/ReplicationContext.html" title="akka.persistence.typed.scaladsl.ReplicationContext"><code>ReplicationContext</code></a></span>:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/replicated/shopping-cart-service-scala/src/main/scala/shopping/cart/ShoppingCart.scala#L272-L277" target="_blank" title="Go to snippet source">source</a><code class="language-scala">case Checkout(replyTo) =&gt;
  Effect
    .persist(Closed(replicationContext.replicaId))
    .thenReply(replyTo) { updatedCart =&gt;
      StatusReply.Success(updatedCart.toSummary)
    }</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/replicated/shopping-cart-service-java/src/main/java/shopping/cart/ShoppingCart.java#L434-L438" target="_blank" title="Go to snippet source">source</a><code class="language-java">private ReplyEffect&lt;Event, State&gt; openOnCheckout(State state, Checkout cmd) {
  return Effect()
      .persist(new Closed(replicationContext.replicaId()))
      .thenReply(cmd.replyTo, updatedCart -&gt; StatusReply.success(updatedCart.toSummary()));
}</code></pre></dd>
</dl>
<p>In the state we keep a set of all replicas where the cart was closed:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/replicated/shopping-cart-service-scala/src/main/scala/shopping/cart/ShoppingCart.scala#L52-L76" target="_blank" title="Go to snippet source">source</a><code class="language-scala">final case class State(
    items: Map[String, Int],
    closed: Set[ReplicaId],
    checkedOut: Option[Instant],
    vipCustomer: Boolean)
    extends CborSerializable {
  def close(replica: ReplicaId): State =
    copy(closed = closed + replica)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/replicated/shopping-cart-service-java/src/main/java/shopping/cart/ShoppingCart.java#L59-L100" target="_blank" title="Go to snippet source">source</a><code class="language-java">static final class State implements CborSerializable {
  final Map&lt;String, Integer&gt; items;
  final Set&lt;ReplicaId&gt; closed;
  private Optional&lt;Instant&gt; checkedOut;
  private boolean vipCustomer = false;

  public State close(ReplicaId replica) {
    closed.add(replica);
    return this;
  }</code></pre></dd>
</dl>
<p>After applying the event to the state, we check if one of the other replicas was closed, and in that case we trigger a command to the shopping cart itself to close also in this replica using the <code>CloseForCheckout</code> command. </p>
<p>If all replicas are closed and this is the designated leader we trigger a <code>CompleteCheckout</code> command. Note that this logic is only triggered if the entity got the event replicated, and not if it is &ldquo;recovering&rdquo; - starting after it was stopped and is replaying all events stored in the journal: </p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/replicated/shopping-cart-service-scala/src/main/scala/shopping/cart/ShoppingCart.scala#L328-L361" target="_blank" title="Go to snippet source">source</a><code class="language-scala">private def handleEvent(state: State, event: Event): State = {
  val newState = event match {
    case ItemUpdated(itemId, quantity) =&gt;
      state.updateItem(itemId, quantity)
    case CustomerMarkedVip(_) =&gt;
      state.markCustomerVip()
    case Closed(replica) =&gt;
      state.close(replica)
    case CheckedOut(eventTime) =&gt;
      state.checkout(eventTime)
  }
  eventTriggers(newState, event)
  newState
}

private def eventTriggers(state: State, event: Event): Unit = {
  if (!replicationContext.recoveryRunning) {
    if (onlyReplicateVip &amp;&amp; !state.vipCustomer) {
      // not replicated, no need to coordinate, we can close it right away
      context.self ! CompleteCheckout
    } else {
      event match {
        case _: Closed =&gt;
          if (!state.closed(replicationContext.replicaId)) {
            context.self ! CloseForCheckout
          } else if (isLeader) {
            val allClosed = replicationContext.allReplicas.diff(state.closed).isEmpty
            if (allClosed) context.self ! CompleteCheckout
          }
        case _ =&gt;
      }
    }
  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/replicated/shopping-cart-service-java/src/main/java/shopping/cart/ShoppingCart.java#L494-L525" target="_blank" title="Go to snippet source">source</a><code class="language-java">@Override
public EventHandler&lt;State, Event&gt; eventHandler() {
  return newEventHandlerBuilder()
      .forAnyState()
      .onEvent(
          ItemUpdated.class, (state, event) -&gt; state.updateItem(event.itemId, event.quantity))
      .onEvent(
          Closed.class,
          (state, event) -&gt; {
            State newState = state.close(event.replica);
            eventTriggers(newState);
            return newState;
          })
      .onEvent(CheckedOut.class, (state, event) -&gt; state.checkout(event.eventTime))
      .build();
}

private void eventTriggers(State state) {
  if (!replicationContext.recoveryRunning()) {
    if (onlyReplicateVip &amp;&amp; !state.vipCustomer) {
      // not replicated, no need to coordinate, we can close it right away
      context.getSelf().tell(CompleteCheckout.INSTANCE);
    } else {
      if (!state.closed.contains(replicationContext.replicaId())) {
        context.getSelf().tell(CloseForCheckout.INSTANCE);
      } else if (isLeader) {
        boolean allClosed = replicationContext.getAllReplicas().equals(state.closed);
        if (allClosed) context.getSelf().tell(CompleteCheckout.INSTANCE);
      }
    }
  }
}</code></pre></dd>
</dl>
<p>The logic for leader makes sure to not tie all carts to the same replica as leader, but instead spreading it across the replicas, by basing it of a hash of the id of the cart. This again uses the <span class="group-java"><a href="https://doc.akka.io/japi/akka/2.8/akka/persistence/typed/javadsl/ReplicationContext.html" title="akka.persistence.typed.javadsl.ReplicationContext"><code>ReplicationContext</code></a></span><span class="group-scala"><a href="https://doc.akka.io/api/akka/2.8/akka/persistence/typed/scaladsl/ReplicationContext.html" title="akka.persistence.typed.scaladsl.ReplicationContext"><code>ReplicationContext</code></a></span> to access the list of all replicas:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/replicated/shopping-cart-service-scala/src/main/scala/shopping/cart/ShoppingCart.scala#L225-L229" target="_blank" title="Go to snippet source">source</a><code class="language-scala">private val isLeader: Boolean = {
  val orderedReplicas = replicationContext.allReplicas.toSeq.sortBy(_.id)
  val leaderIndex = math.abs(replicationContext.entityId.hashCode % orderedReplicas.size)
  orderedReplicas(leaderIndex) == replicationContext.replicaId
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/replicated/shopping-cart-service-java/src/main/java/shopping/cart/ShoppingCart.java#L378-L385" target="_blank" title="Go to snippet source">source</a><code class="language-java">private static boolean isShoppingCartLeader(ReplicationContext replicationContext) {
  List&lt;ReplicaId&gt; orderedReplicas =
      replicationContext.getAllReplicas().stream()
          .sorted(Comparator.comparing(ReplicaId::id))
          .collect(Collectors.toList());
  int leaderIndex = Math.abs(replicationContext.entityId().hashCode() % orderedReplicas.size());
  return orderedReplicas.get(leaderIndex) == replicationContext.replicaId();
}</code></pre></dd>
</dl>
<p>Note that this still means that while adding and removing can be done in the face of an outage, all replicas must be online for any shopping cart to be able to close, so it does not give us complete high-availability for the shopping cart, but it illustrates how we can coordinate when needed.</p>
<h2><a href="#filters" name="filters" class="anchor"><span class="anchor-link"></span></a>Filters</h2>
<p>By default, events from all Replicated Event Sourced entities are replicated.</p>
<p>The same kind of filters as described for <a href="2-service-to-service.html#filters">Service to Service</a> can be used for Replicated Event Sourcing. Replicated Event Sourcing is bidirectional replication, and therefore you would typically have to define the same filters on both sides. That is not handled automatically. </p>
<p>One way to make sure filtering is reflective is using a property of the state to tag events, an event applied to the state triggering the tag will be replicated to other nodes and lead to the same property change there, eventually causing the same filter on all replicas.</p>
<p>To add such filtering to the shopping cart we have added a <code>vipCustomer</code> flag on the state, which when true will lead to adding the tag <code>vip</code> to any event emitted for the cart:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/replicated/shopping-cart-service-scala/src/main/scala/shopping/cart/ShoppingCart.scala#L52-L103" target="_blank" title="Go to snippet source">source</a><code class="language-scala">final case class State(
    items: Map[String, Int],
    closed: Set[ReplicaId],
    checkedOut: Option[Instant],
    vipCustomer: Boolean)
    extends CborSerializable {

  def tags: Set[String] = {
    val total = totalQuantity
    val quantityTags =
      if (total == 0) Set.empty
      else if (total &gt;= 100) Set(LargeQuantityTag)
      else if (total &gt;= 10) Set(MediumQuantityTag)
      else Set(SmallQuantityTag)

    quantityTags ++ (if (vipCustomer) Set(VipCustomerTag) else Set.empty)
  }</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/replicated/shopping-cart-service-java/src/main/java/shopping/cart/ShoppingCart.java#L59-L131" target="_blank" title="Go to snippet source">source</a><code class="language-java">static final class State implements CborSerializable {
  final Map&lt;String, Integer&gt; items;
  final Set&lt;ReplicaId&gt; closed;
  private Optional&lt;Instant&gt; checkedOut;
  private boolean vipCustomer = false;

  public Set&lt;String&gt; tags() {
    int total = totalQuantity();
    Set&lt;String&gt; tags = new HashSet&lt;&gt;();
    if (vipCustomer) {
      tags.add(VIP_CUSTOMER_TAG);
    }
    if (total &gt;= 100) {
      tags.add(LARGE_QUANTITY_TAG);
    } else if (total &gt;= 10) {
      tags.add(MEDIUM_QUANTITY_TAG);
    } else {
      tags.add(SMALL_QUANTITY_TAG);
    }
    return tags;
  }</code></pre></dd>
</dl>
<p>An alternative initialization method adds a filter looking for the <code>vip</code> tag: </p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/replicated/shopping-cart-service-scala/src/main/scala/shopping/cart/ShoppingCart.scala#L197-L212" target="_blank" title="Go to snippet source">source</a><code class="language-scala">def initWithProducerFilter(implicit system: ActorSystem[_]): Replication[Command] = {
  val replicationSettings = ReplicationSettings[Command](EntityType, R2dbcReplication())
  val producerFilter: EventEnvelope[Event] =&gt; Boolean = { envelope =&gt;
    envelope.tags.contains(VipCustomerTag)
  }

  Replication.grpcReplication(replicationSettings, producerFilter)(ShoppingCart.apply)
}

def applyWithProducerFilter(replicatedBehaviors: ReplicatedBehaviors[Command, Event, State]): Behavior[Command] = {
  Behaviors.setup[Command] { context =&gt;
    replicatedBehaviors.setup { replicationContext =&gt;
      new ShoppingCart(context, replicationContext, onlyReplicateVip = true).behavior()
    }
  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/replicated/shopping-cart-service-java/src/main/java/shopping/cart/ShoppingCart.java#L328-L353" target="_blank" title="Go to snippet source">source</a><code class="language-java">public static Replication&lt;Command&gt; initWithProducerFilter(ActorSystem&lt;?&gt; system) {
  ReplicationSettings&lt;Command&gt; replicationSettings =
      ReplicationSettings.create(
          Command.class,
          &quot;replicated-shopping-cart&quot;,
          R2dbcReplication.create(system),
          system);

  Predicate&lt;EventEnvelope&lt;Event&gt;&gt; producerFilter = envelope -&gt; {
    return envelope.getTags().contains(VIP_CUSTOMER_TAG);
  };

  return Replication.grpcReplication(replicationSettings, producerFilter,  ShoppingCart::create, system);
}

public static Behavior&lt;Command&gt; createWithProducerFilter(
    ReplicatedBehaviors&lt;Command, Event, State&gt; replicatedBehaviors) {
  return Behaviors.setup(
      context -&gt;
          replicatedBehaviors.setup(
              replicationContext -&gt; new ShoppingCart(
                  context,
                  replicationContext,
                  true // onlyReplicateVip flag
                  )));
}</code></pre></dd>
</dl>
<p>For carts not replicated the replica commit round triggered by check out would never complete, as the other replicas can not see events from the non-replicated carts. </p>
<p>An additional check immediately completes checkout for such carts:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/replicated/shopping-cart-service-scala/src/main/scala/shopping/cart/ShoppingCart.scala#L328-L361" target="_blank" title="Go to snippet source">source</a><code class="language-scala">private def handleEvent(state: State, event: Event): State = {
  val newState = event match {
    case ItemUpdated(itemId, quantity) =&gt;
      state.updateItem(itemId, quantity)
    case CustomerMarkedVip(_) =&gt;
      state.markCustomerVip()
    case Closed(replica) =&gt;
      state.close(replica)
    case CheckedOut(eventTime) =&gt;
      state.checkout(eventTime)
  }
  eventTriggers(newState, event)
  newState
}

private def eventTriggers(state: State, event: Event): Unit = {
  if (!replicationContext.recoveryRunning) {
    if (onlyReplicateVip &amp;&amp; !state.vipCustomer) {
      // not replicated, no need to coordinate, we can close it right away
      context.self ! CompleteCheckout
    } else {
      event match {
        case _: Closed =&gt;
          if (!state.closed(replicationContext.replicaId)) {
            context.self ! CloseForCheckout
          } else if (isLeader) {
            val allClosed = replicationContext.allReplicas.diff(state.closed).isEmpty
            if (allClosed) context.self ! CompleteCheckout
          }
        case _ =&gt;
      }
    }
  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-projection/tree/master/samples/replicated/shopping-cart-service-java/src/main/java/shopping/cart/ShoppingCart.java#L494-L525" target="_blank" title="Go to snippet source">source</a><code class="language-java">@Override
public EventHandler&lt;State, Event&gt; eventHandler() {
  return newEventHandlerBuilder()
      .forAnyState()
      .onEvent(
          ItemUpdated.class, (state, event) -&gt; state.updateItem(event.itemId, event.quantity))
      .onEvent(
          Closed.class,
          (state, event) -&gt; {
            State newState = state.close(event.replica);
            eventTriggers(newState);
            return newState;
          })
      .onEvent(CheckedOut.class, (state, event) -&gt; state.checkout(event.eventTime))
      .build();
}

private void eventTriggers(State state) {
  if (!replicationContext.recoveryRunning()) {
    if (onlyReplicateVip &amp;&amp; !state.vipCustomer) {
      // not replicated, no need to coordinate, we can close it right away
      context.getSelf().tell(CompleteCheckout.INSTANCE);
    } else {
      if (!state.closed.contains(replicationContext.replicaId())) {
        context.getSelf().tell(CloseForCheckout.INSTANCE);
      } else if (isLeader) {
        boolean allClosed = replicationContext.getAllReplicas().equals(state.closed);
        if (allClosed) context.getSelf().tell(CompleteCheckout.INSTANCE);
      }
    }
  }
}</code></pre></dd>
</dl>
<h2><a href="#complete-sample-projects" name="complete-sample-projects" class="anchor"><span class="anchor-link"></span></a>Complete Sample Projects</h2>
<p>The complete sample can be downloaded from github, the replicated shopping cart:</p>
<ul>
  <li>Java: <a href="https://github.com/akka/akka-projection/tree/main/samples/replicated/shopping-cart-service-java">https://github.com/akka/akka-projection/tree/main/samples/replicated/shopping-cart-service-java</a></li>
  <li>Scala: <a href="https://github.com/akka/akka-projection/tree/main/samples/replicated/shopping-cart-service-scala">https://github.com/akka/akka-projection/tree/main/samples/replicated/shopping-cart-service-scala</a></li>
</ul>
<h2><a href="#running-the-sample-code-locally" name="running-the-sample-code-locally" class="anchor"><span class="anchor-link"></span></a>Running the sample code locally</h2><div class="group-scala">
<ol>
  <li>
    <p>Start two local PostgresSQL servers, on ports 5101 and 5201. The included <code>docker-compose.yml</code> starts everything required for running locally.</p>
    <pre class="prettyprint"><code class="language-shell">docker-compose up -d

# creates the tables needed for Akka Persistence
# as well as the offset store table for Akka Projection
docker exec -i postgres_db_1 psql -U postgres -t &lt; ddl-scripts/create_tables.sql
docker exec -i postgres_db_2 psql -U postgres -t &lt; ddl-scripts/create_tables.sql
</code></pre>
  </li>
  <li>
    <p>Start a first node for each replica:</p>
    <pre class="prettyprint"><code class="language-shell">sbt -Dconfig.resource=replica1-local1.conf run
</code></pre>
    <pre class="prettyprint"><code class="language-shell">sbt -Dconfig.resource=replica2-local1.conf run
</code></pre>
  </li>
  <li>
    <p>(Optional) Start another node with different ports:</p>
    <pre class="prettyprint"><code class="language-shell">sbt -Dconfig.resource=replica1-local2.conf run
</code></pre>
    <pre class="prettyprint"><code class="language-shell">sbt -Dconfig.resource=replica2-local2.conf run
</code></pre>
  </li>
  <li>
    <p>(Optional) More can be started:</p>
    <pre class="prettyprint"><code class="language-shell">sbt -Dconfig.resource=replica1-local3.conf run
</code></pre>
    <pre class="prettyprint"><code class="language-shell">sbt -Dconfig.resource=replica2-local3.conf run
</code></pre>
  </li>
  <li>
    <p>Check for service readiness</p>
    <pre class="prettyprint"><code class="language-shell">curl http://localhost:9101/ready
</code></pre>
    <pre class="prettyprint"><code class="language-shell">curl http://localhost:9201/ready
</code></pre>
  </li>
  <li>
    <p>Try it with <a href="https://github.com/fullstorydev/grpcurl">grpcurl</a>:</p>
    <pre class="prettyprint"><code class="language-shell"># add item to cart on the first replica
grpcurl -d &#39;{&quot;cartId&quot;:&quot;cart1&quot;, &quot;itemId&quot;:&quot;socks&quot;, &quot;quantity&quot;:7}&#39; -plaintext 127.0.0.1:8101 shoppingcart.ShoppingCartService.AddItem

# get cart from first replica
grpcurl -d &#39;{&quot;cartId&quot;:&quot;cart1&quot;}&#39; -plaintext 127.0.0.1:8101 shoppingcart.ShoppingCartService.GetCart

# get cart from second replica
grpcurl -d &#39;{&quot;cartId&quot;:&quot;cart1&quot;}&#39; -plaintext 127.0.0.1:8201 shoppingcart.ShoppingCartService.GetCart

# update quantity of item on the second replica
grpcurl -d &#39;{&quot;cartId&quot;:&quot;cart1&quot;, &quot;itemId&quot;:&quot;socks&quot;, &quot;quantity&quot;:2}&#39; -plaintext 127.0.0.1:8201 shoppingcart.ShoppingCartService.RemoveItem

# check out cart
grpcurl -d &#39;{&quot;cartId&quot;:&quot;cart1&quot;}&#39; -plaintext 127.0.0.1:8101 shoppingcart.ShoppingCartService.Checkout

or same `grpcurl` commands to port 8102/8202 to reach node 2.
</code></pre>
  </li>
</ol></div><div class="group-java">
<ol>
  <li>
    <p>Start two local PostgresSQL servers, on ports 5101 and 5201. The included <code>docker-compose.yml</code> starts everything required for running locally.</p>
    <pre class="prettyprint"><code class="language-shell">docker-compose up -d

# creates the tables needed for Akka Persistence
# as well as the offset store table for Akka Projection
docker exec -i postgres_db_1 psql -U postgres -t &lt; ddl-scripts/create_tables.sql
docker exec -i postgres_db_2 psql -U postgres -t &lt; ddl-scripts/create_tables.sql
</code></pre>
  </li>
  <li>
    <p>Make sure you have compiled the project</p>
    <pre class="prettyprint"><code class="language-shell">mvn compile 
</code></pre>
  </li>
  <li>
    <p>Start a first node for each replica:</p>
    <pre class="prettyprint"><code class="language-shell">mvn compile exec:exec -DAPP_CONFIG=replica1-local1.conf
</code></pre>
    <pre class="prettyprint"><code class="language-shell">mvn compile exec:exec -DAPP_CONFIG=replica2-local1.conf
</code></pre>
  </li>
  <li>
    <p>(Optional) Start another node with different ports:</p>
    <pre class="prettyprint"><code class="language-shell">mvn compile exec:exec -DAPP_CONFIG=replica1-local2.conf
</code></pre>
    <pre class="prettyprint"><code class="language-shell">mvn compile exec:exec -DAPP_CONFIG=replica2-local2.conf
</code></pre>
  </li>
  <li>
    <p>(Optional) More can be started:</p>
    <pre class="prettyprint"><code class="language-shell">mvn compile exec:exec -DAPP_CONFIG=replica1-local3.conf
</code></pre>
    <pre class="prettyprint"><code class="language-shell">mvn compile exec:exec -DAPP_CONFIG=replica2-local3.conf
</code></pre>
  </li>
  <li>
    <p>Check for service readiness</p>
    <pre class="prettyprint"><code class="language-shell">curl http://localhost:9101/ready
</code></pre>
    <pre class="prettyprint"><code class="language-shell">curl http://localhost:9201/ready
</code></pre>
  </li>
  <li>
    <p>Try it with <a href="https://github.com/fullstorydev/grpcurl">grpcurl</a>:</p>
    <pre class="prettyprint"><code class="language-shell"># add item to cart on the first replica
grpcurl -d &#39;{&quot;cartId&quot;:&quot;cart1&quot;, &quot;itemId&quot;:&quot;socks&quot;, &quot;quantity&quot;:7}&#39; -plaintext 127.0.0.1:8101 shoppingcart.ShoppingCartService.AddItem

# get cart from first replica
grpcurl -d &#39;{&quot;cartId&quot;:&quot;cart1&quot;}&#39; -plaintext 127.0.0.1:8101 shoppingcart.ShoppingCartService.GetCart

# get cart from second replica
grpcurl -d &#39;{&quot;cartId&quot;:&quot;cart1&quot;}&#39; -plaintext 127.0.0.1:8201 shoppingcart.ShoppingCartService.GetCart

# update quantity of item on the second replica
grpcurl -d &#39;{&quot;cartId&quot;:&quot;cart1&quot;, &quot;itemId&quot;:&quot;socks&quot;, &quot;quantity&quot;:2}&#39; -plaintext 127.0.0.1:8201 shoppingcart.ShoppingCartService.RemoveItem

# check out cart
grpcurl -d &#39;{&quot;cartId&quot;:&quot;cart1&quot;}&#39; -plaintext 127.0.0.1:8101 shoppingcart.ShoppingCartService.Checkout
</code></pre>
  </li>
</ol>
<p>or same <code>grpcurl</code> commands to port 8102/8202 to reach node 2.</p></div>
<h2><a href="#whats-next-" name="whats-next-" class="anchor"><span class="anchor-link"></span></a>What&rsquo;s next?</h2>
<ul>
  <li>Configuring and deploying the service with Kubernetes</li>
</ul>
</div>
</article>
<div class="row">
<div class="small-12 column">
<section class="nav-prev-next row">
<div class="nav-prev small-6 column">
<a href="../guide/2-service-to-service.html"><i class="icon-prev"></i> <span class="link-prev">Part 2: Service to Service eventing</span></a>
</div>
<div class="nav-next small-6 column clearfix">
<a class="float-right" href="../guide/4-deploying.html">Part 4: Deploying with Kubernetes <i class="icon-next"></i></a>
</div>
</section>
</div>
</div>
<div class="source-github row">
Found an error in this documentation? The source code for this page can be found <a href="https://github.com/akka/akka-projection/tree/master/akka-distributed-cluster-docs/src/main/paradox/guide/3-active-active.md">here</a>.
Please feel free to edit and contribute a pull request.
</div>

<footer class="page-footer row clearfix">
<img class="akka-icon float-left show-for-medium" src="../images/akka-icon.svg" />
<section class="copyright">
<div>Akka Distributed Cluster is available under the <a href="https://www.lightbend.com/akka/license" target="_blank">Business Source License 1.1</a>.</div>
<p class="legal">
&copy; 2011-2023 <a href="https://www.lightbend.com" target="_blank">Lightbend, Inc.</a> |
<a href="https://www.lightbend.com/legal/licenses" target="_blank">Licenses</a> |
<a href="https://www.lightbend.com/legal/terms" target="_blank">Terms</a> |
<a href="https://www.lightbend.com/legal/privacy" target="_blank">Privacy Policy</a> |
<a href="https://akka.io/cookie/" target="_blank">Cookie Listing</a> |
<a class="optanon-toggle-display">Cookie Settings</a>
</p>
</section>

</footer>
</section>
</main>
</div>

<script type="text/javascript" src="../js/scrollsneak.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../js/groups.js"></script>
<script type="text/javascript" src="../js/page.js"></script>
<script type="text/javascript" src="../js/snippets.js"></script>
<script type="text/javascript" src="../js/magellan.js"></script>
<script type="text/javascript" src="../js/metadata-toggle.js"></script>
<script type="text/javascript" src="../js/lbHeader.js"></script>

<style type="text/css">@import "../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(){window.prettyPrint && prettyPrint()});
//]]></script>
<!-- hook for including project specific javascript into the generated docs -->

</body>
</html>
