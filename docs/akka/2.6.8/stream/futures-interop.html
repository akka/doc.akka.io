<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Futures interop &bull; Akka Documentation</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="Akka is a toolkit for building highly concurrent, distributed, and resilient message-driven applications for Java and Scala."/>
<link rel="canonical" href="https://doc.akka.io/docs/akka/current/stream/futures-interop.html"/>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../lib/foundation/dist/js/foundation.min.js"></script>
<link rel="stylesheet" type="text/css" href="../lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="../lib/foundation/dist/css/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" type="text/css" href="../css/icons.css"/>
<link rel="stylesheet" type="text/css" href="../css/page-7.css"/>
<link rel="stylesheet" type="text/css" href="../css/banner-1.css"/>
<link rel="shortcut icon" href="../images/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="../images/apple-touch-icon.png"/>
<link rel="icon" type="image/png" sizes="32x32" href="../images/favicon-32x32.png"/>
<link rel="icon" type="image/png" sizes="16x16" href="../images/favicon-16x16.png"/>
<link rel="manifest" href="../images/manifest.json"/>
<meta name="msapplication-TileImage" content="../images/mstile-150x150.png"/>
<meta name="msapplication-TileColor" content="#15a9ce"/>
<meta name="theme-color" content="#15a9ce"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) start -->
<script src="https://optanon.blob.core.windows.net/consent/159bb13d-6748-4399-806e-ac28db879785.js" type="text/javascript" charset="UTF-8"></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) end -->
<!--Google Analytics-->
<script type="text/plain" class="optanon-category-2">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-21117439-1']);
_gaq.push(['_setDomainName', 'akka.io']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})()
</script>
<!-- Google Tag Manager -->
<script type="text/plain" class="optanon-category-2">
(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KBJGH35');
</script>
<!--Marketo-->
<script type="text/plain" class="optanon-category-3">
(function() {
var didInit = false;
function initMunchkin() {
if(didInit === false) {
didInit = true;
Munchkin.init('558-NCX-702', { 'asyncOnly': true, 'disableClickDelay': true });
}
}
var s = document.createElement('script');
s.type = 'text/javascript';
s.async = true;
s.src = '//munchkin.marketo.net/munchkin.js';
s.onreadystatechange = function() {
if (this.readyState == 'complete' || this.readyState == 'loaded') {
initMunchkin();
}
};
s.onload = initMunchkin;
document.getElementsByTagName('head')[0].appendChild(s);
})();
</script>
</head>

<body id="underlay" data-toggler="nav-open">
<div id="lightbend-banner" class="lightbend-banner akka full-width" data-category="OSS Lightbend Banner Impression" data-label="Akka Banner Impression">
<div class="wrapper">
<div class="brand">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lightbend Logo - Akka Banner" href="https://www.lightbend.com?r=oss-banner-akka" target="_blank">
<img class="lightbend-logo" src="../images/banner-logos/lightbend-reverse.svg" alt="Lightbend" title="Lightbend">
</a>
</div>
<div class="nav">
<a class="banner-btn oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Enhance your Akka systems with Akka Platform [Button] - Akka Banner" href="https://www.lightbend.com/akka-core-of-lightbend?r=oss-banner-akka" target="_blank">
<span>Enhance your Akka systems with</span>
<img class="akka-platform-reverse-logo" src="../images/banner-logos/akka-platform-reverse.svg" alt="Akka Platform" title="Akka Platform">
</a>
<div class="drop-down">
<svg class="svg-chevon-circle-down" version="1.1" id="Chevron_circled_down" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve">
<path fill="#ffffff" d="M12.505,8.698L10,11L7.494,8.698c-0.198-0.196-0.518-0.196-0.718,0c-0.197,0.196-0.197,0.515,0,0.71l2.864,2.807
c0.199,0.196,0.52,0.196,0.717,0l2.864-2.807c0.199-0.195,0.198-0.514,0-0.71C13.024,8.502,12.704,8.502,12.505,8.698z M10,0.4
c-5.302,0-9.6,4.298-9.6,9.6c0,5.303,4.298,9.6,9.6,9.6s9.6-4.297,9.6-9.6C19.6,4.698,15.302,0.4,10,0.4z M10,18.354
c-4.615,0-8.354-3.74-8.354-8.354c0-4.614,3.739-8.354,8.354-8.354c4.613,0,8.354,3.74,8.354,8.354
C18.354,14.614,14.613,18.354,10,18.354z" />
</svg>
<div class="drop-down-content">
<div class="lightbend-family">
<a href="https://cloudflow.io" class="cloudflow oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Cloudflow - Logo Tag Line - Akka Banner">
<img class="cloudflow-full-color-logo" src="../images/banner-logos/cloudflow-full-color.svg" alt="Cloudflow by Lightbend" title="Cloudflow by Lightbend">
</a>
<a href="https://cloudstate.io" class="cloudstate oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Cloudstate - Logo Tag Line - Akka Banner">
<img class="cloudstate-full-color-logo" src="../images/banner-logos/cloudstate-full-color.svg" alt="Cloudstate by Lightbend" title="Cloudstate by Lightbend">
</a>
<a href="https://www.lagomframework.com" class="lagom oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lagom - Logo Tag Line - Akka Banner">
<img class="lagom-full-color-logo" src="../images/banner-logos/lagom-full-color.svg" alt="Lagom Framework by Lightbend" title="Lagom Framework by Lightbend">
</a>
<a href="https://www.playframework.com" class="play oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Play - Logo Tag Line - Akka Banner">
<img class="play-full-color-logo" src="../images/banner-logos/play-full-color.svg" alt="Play Framework by Lightbend" title="Play Framework by Lightbend">
</a>
<a href="https://www.scala-lang.org" class="scala oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Scala - Logo Tag Line - Akka Banner">
<img class="scala-full-color-logo" src="../images/banner-logos/scala-full-color.svg" alt="Scala by Lightbend" title="Scala by Lightbend">
</a>
<div class="akka current">
<img class="akka-full-color-logo" src="../images/banner-logos/akka-full-color.svg" alt="Akka by Lightbend" title="Akka by Lightbend">
<span>From the creators of <strong>Akka</strong>, get technology enhancements, monitoring, and expert support with Akka Platform from Lightbend.</span>
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Learn More [Button] - Akka Banner" href="https://www.lightbend.com/akka-core-of-lightbend?r=oss-banner-akka" target="_blank">Learn More</a>
</div>
</div>
<div class="title">The Lightbend Family</div>
</div>      
</div>
</div>
</div>
</div>
<header class="site-header hide-for-large">
<div class="sticky-header clearfix">
<a href="https://akka.io"><img class="logo" src="../images/akka-logo-reverse.svg"/></a>

<button class="menu-icon float-right" type="button" data-toggle="underlay overlay"></button>
</div>
<div id="overlay" class="overlay-nav" data-toggler="nav-open">
<header class="nav-header">
<div class="nav-header-title">
<h1><a href="../index.html">Akka Documentation</a></h1>
</div>
<div class="nav-header-version">
Version 2.6.8
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-scala">Scala</option><option class="group" value="group-java">Java</option></select>
</div>
<div id="overlay-search-container" class="nav-header-search">
<input id="overlay-search" type="search" class="search" placeholder="Search" />
</div>
</header>
<nav class="nav-toc">
<ul>
  <li><a href="../security/index.html" class="page">Security Announcements</a></li>
  <li><a href="../typed/guide/index.html" class="page">Getting Started Guide</a></li>
  <li><a href="../general/index.html" class="page">General Concepts</a></li>
  <li><a href="../typed/index.html" class="page">Actors</a></li>
  <li><a href="../typed/index-cluster.html" class="page">Cluster</a></li>
  <li><a href="../typed/index-persistence.html" class="page">Persistence</a></li>
  <li><a href="../stream/index.html" class="page">Streams</a>
  <ul>
    <li><a href="../stream/index.html#module-info" class="header">Module info</a></li>
    <li><a href="../stream/stream-introduction.html" class="page">Introduction</a></li>
    <li><a href="../stream/stream-quickstart.html" class="page">Streams Quickstart Guide</a></li>
    <li><a href="../general/stream/stream-design.html" class="page">Design Principles behind Akka Streams</a></li>
    <li><a href="../stream/stream-flows-and-basics.html" class="page">Basics and working with Flows</a></li>
    <li><a href="../stream/stream-graphs.html" class="page">Working with Graphs</a></li>
    <li><a href="../stream/stream-composition.html" class="page">Modularity, Composition and Hierarchy</a></li>
    <li><a href="../stream/stream-rate.html" class="page">Buffers and working with rate</a></li>
    <li><a href="../stream/stream-context.html" class="page">Context Propagation</a></li>
    <li><a href="../stream/stream-dynamic.html" class="page">Dynamic stream handling</a></li>
    <li><a href="../stream/stream-customize.html" class="page">Custom stream processing</a></li>
    <li><a href="../stream/futures-interop.html#futures-interop" class="active page">Futures interop</a>
    <ul>
      <li><a href="../stream/futures-interop.html#dependency" class="header">Dependency</a></li>
      <li><a href="../stream/futures-interop.html#overview" class="header">Overview</a></li>
    </ul></li>
    <li><a href="../stream/actor-interop.html" class="page">Actors interop</a></li>
    <li><a href="../stream/reactive-streams-interop.html" class="page">Reactive Streams Interop</a></li>
    <li><a href="../stream/stream-error.html" class="page">Error Handling in Streams</a></li>
    <li><a href="../stream/stream-io.html" class="page">Working with streaming IO</a></li>
    <li><a href="../stream/stream-refs.html" class="page">StreamRefs - Reactive Streams over the network</a></li>
    <li><a href="../stream/stream-parallelism.html" class="page">Pipelining and Parallelism</a></li>
    <li><a href="../stream/stream-testkit.html" class="page">Testing streams</a></li>
    <li><a href="../stream/stream-substream.html" class="page">Substreams</a></li>
    <li><a href="../stream/stream-cookbook.html" class="page">Streams Cookbook</a></li>
    <li><a href="../general/stream/stream-configuration.html" class="page">Configuration</a></li>
    <li><a href="../stream/operators/index.html" class="page">Operators</a></li>
  </ul></li>
  <li><a href="../discovery/index.html" class="page">Discovery</a></li>
  <li><a href="../index-utilities.html" class="page">Utilities</a></li>
  <li><a href="../common/other-modules.html" class="page">Other Akka modules</a></li>
  <li><a href="../additional/deploy.html" class="page">Package, Deploy and Run</a></li>
  <li><a href="../project/index.html" class="page">Project Information</a></li>
  <li><a href="../index-classic.html" class="page">Akka Classic</a></li>
</ul>
</nav>
</div>
</header>
<div class="site-content-wrapper">
<aside class="sticky-sidebar show-for-large">
<header class="nav-header sticky-sidebar-header">
<div class="nav-header-title">
<h1><a href="../index.html">Akka Documentation</a></h1>
</div>
<div class="nav-header-version">
Version 2.6.8
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-scala">Scala</option><option class="group" value="group-java">Java</option></select>
</div>
<div class="nav-header-search">
<input id="search" type="search" class="search" placeholder="Search" />
</div>
</header>
<nav class="site-nav sticky-sidebar-contents">
<div class="nav-toc">
<ul>
  <li><a href="../security/index.html" class="page">Security Announcements</a></li>
  <li><a href="../typed/guide/index.html" class="page">Getting Started Guide</a></li>
  <li><a href="../general/index.html" class="page">General Concepts</a></li>
  <li><a href="../typed/index.html" class="page">Actors</a></li>
  <li><a href="../typed/index-cluster.html" class="page">Cluster</a></li>
  <li><a href="../typed/index-persistence.html" class="page">Persistence</a></li>
  <li><a href="../stream/index.html" class="page">Streams</a>
  <ul>
    <li><a href="../stream/index.html#module-info" class="header">Module info</a></li>
    <li><a href="../stream/stream-introduction.html" class="page">Introduction</a></li>
    <li><a href="../stream/stream-quickstart.html" class="page">Streams Quickstart Guide</a></li>
    <li><a href="../general/stream/stream-design.html" class="page">Design Principles behind Akka Streams</a></li>
    <li><a href="../stream/stream-flows-and-basics.html" class="page">Basics and working with Flows</a></li>
    <li><a href="../stream/stream-graphs.html" class="page">Working with Graphs</a></li>
    <li><a href="../stream/stream-composition.html" class="page">Modularity, Composition and Hierarchy</a></li>
    <li><a href="../stream/stream-rate.html" class="page">Buffers and working with rate</a></li>
    <li><a href="../stream/stream-context.html" class="page">Context Propagation</a></li>
    <li><a href="../stream/stream-dynamic.html" class="page">Dynamic stream handling</a></li>
    <li><a href="../stream/stream-customize.html" class="page">Custom stream processing</a></li>
    <li><a href="../stream/futures-interop.html#futures-interop" class="active page">Futures interop</a>
    <ul>
      <li><a href="../stream/futures-interop.html#dependency" class="header">Dependency</a></li>
      <li><a href="../stream/futures-interop.html#overview" class="header">Overview</a></li>
    </ul></li>
    <li><a href="../stream/actor-interop.html" class="page">Actors interop</a></li>
    <li><a href="../stream/reactive-streams-interop.html" class="page">Reactive Streams Interop</a></li>
    <li><a href="../stream/stream-error.html" class="page">Error Handling in Streams</a></li>
    <li><a href="../stream/stream-io.html" class="page">Working with streaming IO</a></li>
    <li><a href="../stream/stream-refs.html" class="page">StreamRefs - Reactive Streams over the network</a></li>
    <li><a href="../stream/stream-parallelism.html" class="page">Pipelining and Parallelism</a></li>
    <li><a href="../stream/stream-testkit.html" class="page">Testing streams</a></li>
    <li><a href="../stream/stream-substream.html" class="page">Substreams</a></li>
    <li><a href="../stream/stream-cookbook.html" class="page">Streams Cookbook</a></li>
    <li><a href="../general/stream/stream-configuration.html" class="page">Configuration</a></li>
    <li><a href="../stream/operators/index.html" class="page">Operators</a></li>
  </ul></li>
  <li><a href="../discovery/index.html" class="page">Discovery</a></li>
  <li><a href="../index-utilities.html" class="page">Utilities</a></li>
  <li><a href="../common/other-modules.html" class="page">Other Akka modules</a></li>
  <li><a href="../additional/deploy.html" class="page">Package, Deploy and Run</a></li>
  <li><a href="../project/index.html" class="page">Project Information</a></li>
  <li><a href="../index-classic.html" class="page">Akka Classic</a></li>
</ul>
</div>
</nav>
<footer class="nav-footer sticky-sidebar-footer">
<a href="https://akka.io"><img class="logo" src="../images/akka-logo-reverse.svg"/></a>

</footer>
</aside>
<main class="fixed-shift-for-large expanded row">
<section class="site-content small-12 column">
<article class="page-content row">
<div class="small-12 column" id="docs">
<h1><a href="#futures-interop" name="futures-interop" class="anchor"><span class="anchor-link"></span></a>Futures interop</h1>
<h2><a href="#dependency" name="dependency" class="anchor"><span class="anchor-link"></span></a>Dependency</h2>
<p>To use Akka Streams, add the module to your project:</p><dl class="dependency"><dt>sbt</dt><dd><pre class="prettyprint"><code class="language-scala">val AkkaVersion = "2.6.8"
libraryDependencies += "com.typesafe.akka" %% "akka-stream" % AkkaVersion</code></pre></dd><dt>Maven</dt><dd><pre class="prettyprint"><code class="language-xml">&lt;properties&gt;
  &lt;akka.version&gt;2.6.8&lt;/akka.version&gt;
  &lt;scala.binary.version&gt;2.13&lt;/scala.binary.version&gt;
&lt;/properties&gt;
&lt;dependency&gt;
  &lt;groupId&gt;com.typesafe.akka&lt;/groupId&gt;
  &lt;artifactId&gt;akka-stream_${scala.binary.version}&lt;/artifactId&gt;
  &lt;version&gt;${akka.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre></dd><dt>Gradle</dt><dd><pre class="prettyprint"><code class="language-gradle">versions += [
  AkkaVersion: "2.6.8",
  ScalaBinary: "2.13"
]
dependencies {
  compile group: 'com.typesafe.akka', name: "akka-stream_${versions.ScalaBinary}", version: versions.AkkaVersion
}</code></pre></dd></dl>
<h2><a href="#overview" name="overview" class="anchor"><span class="anchor-link"></span></a>Overview</h2>
<p>Stream transformations and side effects involving external non-stream based services can be performed with <code>mapAsync</code> or <code>mapAsyncUnordered</code>.</p>
<p>For example, sending emails to the authors of selected tweets using an external email service:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka/tree/v2.6.8/akka-docs/src/test/scala/docs/stream/IntegrationDocSpec.scala#L66-L72" target="_blank" title="Go to snippet source"></a><code class="language-scala">def send(email: Email): Future[Unit] = {
  // ...
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka/tree/v2.6.8/akka-docs/src/test/java/jdocs/stream/IntegrationDocTest.java#L188-L194" target="_blank" title="Go to snippet source"></a><code class="language-java">public CompletionStage&lt;Email&gt; send(Email email) {
  // ...
}</code></pre></dd>
</dl>
<p>We start with the tweet stream of authors:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka/tree/v2.6.8/akka-docs/src/test/scala/docs/stream/IntegrationDocSpec.scala#L159-L160" target="_blank" title="Go to snippet source"></a><code class="language-scala">val authors: Source[Author, NotUsed] =
  tweets.filter(_.hashtags.contains(akkaTag)).map(_.author)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka/tree/v2.6.8/akka-docs/src/test/java/jdocs/stream/IntegrationDocTest.java#L436-L438" target="_blank" title="Go to snippet source"></a><code class="language-java">final Source&lt;Author, NotUsed&gt; authors =
    tweets.filter(t -&gt; t.hashtags().contains(AKKA)).map(t -&gt; t.author);
</code></pre></dd>
</dl>
<p>Assume that we can lookup their email address using:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka/tree/v2.6.8/akka-docs/src/test/scala/docs/stream/IntegrationDocSpec.scala#L44" target="_blank" title="Go to snippet source"></a><code class="language-scala">def lookupEmail(handle: String): Future[Option[String]] =</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka/tree/v2.6.8/akka-docs/src/test/java/jdocs/stream/IntegrationDocTest.java#L75" target="_blank" title="Go to snippet source"></a><code class="language-java">public CompletionStage&lt;Optional&lt;String&gt;&gt; lookupEmail(String handle)</code></pre></dd>
</dl>
<p>Transforming the stream of authors to a stream of email addresses by using the <code>lookupEmail</code> service can be done with <code>mapAsync</code>:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka/tree/v2.6.8/akka-docs/src/test/scala/docs/stream/IntegrationDocSpec.scala#L164-L167" target="_blank" title="Go to snippet source"></a><code class="language-scala">val emailAddresses: Source[String, NotUsed] =
  authors.mapAsync(4)(author =&gt; addressSystem.lookupEmail(author.handle)).collect {
    case Some(emailAddress) =&gt; emailAddress
  }</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka/tree/v2.6.8/akka-docs/src/test/java/jdocs/stream/IntegrationDocTest.java#L442-L447" target="_blank" title="Go to snippet source"></a><code class="language-java">final Source&lt;String, NotUsed&gt; emailAddresses =
    authors
        .mapAsync(4, author -&gt; addressSystem.lookupEmail(author.handle))
        .filter(o -&gt; o.isPresent())
        .map(o -&gt; o.get());
</code></pre></dd>
</dl>
<p>Finally, sending the emails:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka/tree/v2.6.8/akka-docs/src/test/scala/docs/stream/IntegrationDocSpec.scala#L171-L178" target="_blank" title="Go to snippet source"></a><code class="language-scala">val sendEmails: RunnableGraph[NotUsed] =
  emailAddresses
    .mapAsync(4)(address =&gt; {
      emailServer.send(Email(to = address, title = &quot;Akka&quot;, body = &quot;I like your tweet&quot;))
    })
    .to(Sink.ignore)

sendEmails.run()</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka/tree/v2.6.8/akka-docs/src/test/java/jdocs/stream/IntegrationDocTest.java#L451-L457" target="_blank" title="Go to snippet source"></a><code class="language-java">final RunnableGraph&lt;NotUsed&gt; sendEmails =
    emailAddresses
        .mapAsync(
            4, address -&gt; emailServer.send(new Email(address, &quot;Akka&quot;, &quot;I like your tweet&quot;)))
        .to(Sink.ignore());

sendEmails.run(system);</code></pre></dd>
</dl>
<p><code>mapAsync</code> is applying the given function that is calling out to the external service to each of the elements as they pass through this processing step. The function returns a <span class="group-scala"><code>Future</code></span><span class="group-java"><code>CompletionStage</code></span> and the value of that future will be emitted downstreams. The number of Futures that shall run in parallel is given as the first argument to <code>mapAsync</code>. These Futures may complete in any order, but the elements that are emitted downstream are in the same order as received from upstream.</p>
<p>That means that back-pressure works as expected. For example if the <code>emailServer.send</code> is the bottleneck it will limit the rate at which incoming tweets are retrieved and email addresses looked up.</p>
<p>The final piece of this pipeline is to generate the demand that pulls the tweet authors information through the emailing pipeline: we attach a <code>Sink.ignore</code> which makes it all run. If our email process would return some interesting data for further transformation then we would not ignore it but send that result stream onwards for further processing or storage.</p>
<p>Note that <code>mapAsync</code> preserves the order of the stream elements. In this example the order is not important and then we can use the more efficient <code>mapAsyncUnordered</code>:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka/tree/v2.6.8/akka-docs/src/test/scala/docs/stream/IntegrationDocSpec.scala#L276-L291" target="_blank" title="Go to snippet source"></a><code class="language-scala">val authors: Source[Author, NotUsed] =
  tweets.filter(_.hashtags.contains(akkaTag)).map(_.author)

val emailAddresses: Source[String, NotUsed] =
  authors.mapAsyncUnordered(4)(author =&gt; addressSystem.lookupEmail(author.handle)).collect {
    case Some(emailAddress) =&gt; emailAddress
  }

val sendEmails: RunnableGraph[NotUsed] =
  emailAddresses
    .mapAsyncUnordered(4)(address =&gt; {
      emailServer.send(Email(to = address, title = &quot;Akka&quot;, body = &quot;I like your tweet&quot;))
    })
    .to(Sink.ignore)

sendEmails.run()</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka/tree/v2.6.8/akka-docs/src/test/java/jdocs/stream/IntegrationDocTest.java#L504-L519" target="_blank" title="Go to snippet source"></a><code class="language-java">final Source&lt;Author, NotUsed&gt; authors =
    tweets.filter(t -&gt; t.hashtags().contains(AKKA)).map(t -&gt; t.author);

final Source&lt;String, NotUsed&gt; emailAddresses =
    authors
        .mapAsyncUnordered(4, author -&gt; addressSystem.lookupEmail(author.handle))
        .filter(o -&gt; o.isPresent())
        .map(o -&gt; o.get());

final RunnableGraph&lt;NotUsed&gt; sendEmails =
    emailAddresses
        .mapAsyncUnordered(
            4, address -&gt; emailServer.send(new Email(address, &quot;Akka&quot;, &quot;I like your tweet&quot;)))
        .to(Sink.ignore());

sendEmails.run(system);</code></pre></dd>
</dl>
<p>In the above example the services conveniently returned a <span class="group-scala"><code>Future</code></span><span class="group-java"><code>CompletionStage</code></span> of the result. If that is not the case you need to wrap the call in a <span class="group-scala"><code>Future</code></span><span class="group-java"><code>CompletionStage</code></span>. If the service call involves blocking you must also make sure that you run it on a dedicated execution context, to avoid starvation and disturbance of other tasks in the system.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka/tree/v2.6.8/akka-docs/src/test/scala/docs/stream/IntegrationDocSpec.scala#L318-L329" target="_blank" title="Go to snippet source"></a><code class="language-scala">val blockingExecutionContext = system.dispatchers.lookup(&quot;blocking-dispatcher&quot;)

val sendTextMessages: RunnableGraph[NotUsed] =
  phoneNumbers
    .mapAsync(4)(phoneNo =&gt; {
      Future {
        smsServer.send(TextMessage(to = phoneNo, body = &quot;I like your tweet&quot;))
      }(blockingExecutionContext)
    })
    .to(Sink.ignore)

sendTextMessages.run()</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka/tree/v2.6.8/akka-docs/src/test/java/jdocs/stream/IntegrationDocTest.java#L543-L555" target="_blank" title="Go to snippet source"></a><code class="language-java">final Executor blockingEc = system.dispatchers().lookup(&quot;blocking-dispatcher&quot;);

final RunnableGraph&lt;NotUsed&gt; sendTextMessages =
    phoneNumbers
        .mapAsync(
            4,
            phoneNo -&gt;
                CompletableFuture.supplyAsync(
                    () -&gt; smsServer.send(new TextMessage(phoneNo, &quot;I like your tweet&quot;)),
                    blockingEc))
        .to(Sink.ignore());

sendTextMessages.run(system);</code></pre></dd>
</dl>
<p>The configuration of the <code>&quot;blocking-dispatcher&quot;</code> may look something like:</p>
<pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka/tree/v2.6.8/akka-docs/src/test/scala/docs/stream/IntegrationDocSpec.scala#L30-L36" target="_blank" title="Go to snippet source"></a><code class="language-scala">blocking-dispatcher {
  executor = &quot;thread-pool-executor&quot;
  thread-pool-executor {
    core-pool-size-min    = 10
    core-pool-size-max    = 10
  }
}</code></pre>
<p>An alternative for blocking calls is to perform them in a <code>map</code> operation, still using a dedicated dispatcher for that operation.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka/tree/v2.6.8/akka-docs/src/test/scala/docs/stream/IntegrationDocSpec.scala#L356-L364" target="_blank" title="Go to snippet source"></a><code class="language-scala">val send = Flow[String]
  .map { phoneNo =&gt;
    smsServer.send(TextMessage(to = phoneNo, body = &quot;I like your tweet&quot;))
  }
  .withAttributes(ActorAttributes.dispatcher(&quot;blocking-dispatcher&quot;))
val sendTextMessages: RunnableGraph[NotUsed] =
  phoneNumbers.via(send).to(Sink.ignore)

sendTextMessages.run()</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka/tree/v2.6.8/akka-docs/src/test/java/jdocs/stream/IntegrationDocTest.java#L591-L597" target="_blank" title="Go to snippet source"></a><code class="language-java">final Flow&lt;String, Boolean, NotUsed&gt; send =
    Flow.of(String.class)
        .map(phoneNo -&gt; smsServer.send(new TextMessage(phoneNo, &quot;I like your tweet&quot;)))
        .withAttributes(ActorAttributes.dispatcher(&quot;blocking-dispatcher&quot;));
final RunnableGraph&lt;?&gt; sendTextMessages = phoneNumbers.via(send).to(Sink.ignore());

sendTextMessages.run(system);</code></pre></dd>
</dl>
<p>However, that is not exactly the same as <code>mapAsync</code>, since the <code>mapAsync</code> may run several calls concurrently, but <code>map</code> performs them one at a time.</p>
<p>For a service that is exposed as an actor, or if an actor is used as a gateway in front of an external service, you can use <code>ask</code>:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka/tree/v2.6.8/akka-docs/src/test/scala/docs/stream/IntegrationDocSpec.scala#L381-L387" target="_blank" title="Go to snippet source"></a><code class="language-scala">import akka.pattern.ask

val akkaTweets: Source[Tweet, NotUsed] = tweets.filter(_.hashtags.contains(akkaTag))

implicit val timeout = Timeout(3.seconds)
val saveTweets: RunnableGraph[NotUsed] =
  akkaTweets.mapAsync(4)(tweet =&gt; database ? Save(tweet)).to(Sink.ignore)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka/tree/v2.6.8/akka-docs/src/test/java/jdocs/stream/IntegrationDocTest.java#L622-L627" target="_blank" title="Go to snippet source"></a><code class="language-java">final Source&lt;Tweet, NotUsed&gt; akkaTweets = tweets.filter(t -&gt; t.hashtags().contains(AKKA));

final RunnableGraph&lt;NotUsed&gt; saveTweets =
    akkaTweets
        .mapAsync(4, tweet -&gt; ask(database, new Save(tweet), Duration.ofMillis(300L)))
        .to(Sink.ignore());</code></pre></dd>
</dl>
<p>Note that if the <code>ask</code> is not completed within the given timeout the stream is completed with failure. If that is not desired outcome you can use <code>recover</code> on the <code>ask</code> <span class="group-scala"><code>Future</code></span><span class="group-java"><code>CompletionStage</code></span>.</p>
<h3><a href="#illustrating-ordering-and-parallelism" name="illustrating-ordering-and-parallelism" class="anchor"><span class="anchor-link"></span></a>Illustrating ordering and parallelism</h3>
<p>Let us look at another example to get a better understanding of the ordering and parallelism characteristics of <code>mapAsync</code> and <code>mapAsyncUnordered</code>.</p>
<p>Several <code>mapAsync</code> and <code>mapAsyncUnordered</code> futures may run concurrently. The number of concurrent futures are limited by the downstream demand. For example, if 5 elements have been requested by downstream there will be at most 5 futures in progress.</p>
<p><code>mapAsync</code> emits the future results in the same order as the input elements were received. That means that completed results are only emitted downstream when earlier results have been completed and emitted. One slow call will thereby delay the results of all successive calls, even though they are completed before the slow call.</p>
<p><code>mapAsyncUnordered</code> emits the future results as soon as they are completed, i.e. it is possible that the elements are not emitted downstream in the same order as received from upstream. One slow call will thereby not delay the results of faster successive calls as long as there is downstream demand of several elements.</p>
<p>Here is a fictive service that we can use to illustrate these aspects.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka/tree/v2.6.8/akka-docs/src/test/scala/docs/stream/IntegrationDocSpec.scala#L99-L117" target="_blank" title="Go to snippet source"></a><code class="language-scala">class SometimesSlowService(implicit ec: ExecutionContext) {

  private val runningCount = new AtomicInteger

  def convert(s: String): Future[String] = {
    println(s&quot;running: $s (${runningCount.incrementAndGet()})&quot;)
    Future {
      if (s.nonEmpty &amp;&amp; s.head.isLower)
        Thread.sleep(500)
      else
        Thread.sleep(20)
      println(s&quot;completed: $s (${runningCount.decrementAndGet()})&quot;)
      s.toUpperCase
    }
  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka/tree/v2.6.8/akka-docs/src/test/java/jdocs/stream/IntegrationDocTest.java#L274-L302" target="_blank" title="Go to snippet source"></a><code class="language-java">static class SometimesSlowService {
  private final Executor ec;

  public SometimesSlowService(Executor ec) {
    this.ec = ec;
  }

  private final AtomicInteger runningCount = new AtomicInteger();

  public CompletionStage&lt;String&gt; convert(String s) {
    System.out.println(&quot;running: &quot; + s + &quot;(&quot; + runningCount.incrementAndGet() + &quot;)&quot;);
    return CompletableFuture.supplyAsync(
        () -&gt; {
          if (!s.isEmpty() &amp;&amp; Character.isLowerCase(s.charAt(0)))
            try {
              Thread.sleep(500);
            } catch (InterruptedException e) {
            }
          else
            try {
              Thread.sleep(20);
            } catch (InterruptedException e) {
            }
          System.out.println(&quot;completed: &quot; + s + &quot;(&quot; + runningCount.decrementAndGet() + &quot;)&quot;);
          return s.toUpperCase();
        },
        ec);
  }
}</code></pre></dd>
</dl>
<p>Elements starting with a lower case character are simulated to take longer time to process.</p>
<p>Here is how we can use it with <code>mapAsync</code>:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka/tree/v2.6.8/akka-docs/src/test/scala/docs/stream/IntegrationDocSpec.scala#L409-L417" target="_blank" title="Go to snippet source"></a><code class="language-scala">implicit val blockingExecutionContext = system.dispatchers.lookup(&quot;blocking-dispatcher&quot;)
val service = new SometimesSlowService

Source(List(&quot;a&quot;, &quot;B&quot;, &quot;C&quot;, &quot;D&quot;, &quot;e&quot;, &quot;F&quot;, &quot;g&quot;, &quot;H&quot;, &quot;i&quot;, &quot;J&quot;))
  .map(elem =&gt; { println(s&quot;before: $elem&quot;); elem })
  .mapAsync(4)(service.convert)
  .to(Sink.foreach(elem =&gt; println(s&quot;after: $elem&quot;)))
  .withAttributes(Attributes.inputBuffer(initial = 4, max = 4))
  .run()</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka/tree/v2.6.8/akka-docs/src/test/java/jdocs/stream/IntegrationDocTest.java#L663-L675" target="_blank" title="Go to snippet source"></a><code class="language-java">final Executor blockingEc = system.dispatchers().lookup(&quot;blocking-dispatcher&quot;);
final SometimesSlowService service = new SometimesSlowService(blockingEc);

Source.from(Arrays.asList(&quot;a&quot;, &quot;B&quot;, &quot;C&quot;, &quot;D&quot;, &quot;e&quot;, &quot;F&quot;, &quot;g&quot;, &quot;H&quot;, &quot;i&quot;, &quot;J&quot;))
    .map(
        elem -&gt; {
          System.out.println(&quot;before: &quot; + elem);
          return elem;
        })
    .mapAsync(4, service::convert)
    .to(Sink.foreach(elem -&gt; System.out.println(&quot;after: &quot; + elem)))
    .withAttributes(Attributes.inputBuffer(4, 4))
    .run(system);</code></pre></dd>
</dl>
<p>The output may look like this:</p>
<pre><code>before: a
before: B
before: C
before: D
running: a (1)
running: B (2)
before: e
running: C (3)
before: F
running: D (4)
before: g
before: H
completed: C (3)
completed: B (2)
completed: D (1)
completed: a (0)
after: A
after: B
running: e (1)
after: C
after: D
running: F (2)
before: i
before: J
running: g (3)
running: H (4)
completed: H (2)
completed: F (3)
completed: e (1)
completed: g (0)
after: E
after: F
running: i (1)
after: G
after: H
running: J (2)
completed: J (1)
completed: i (0)
after: I
after: J
</code></pre>
<p>Note that <code>after</code> lines are in the same order as the <code>before</code> lines even though elements are <code>completed</code> in a different order. For example <code>H</code> is <code>completed</code> before <code>g</code>, but still emitted afterwards.</p>
<p>The numbers in parenthesis illustrates how many calls that are in progress at the same time. Here the downstream demand and thereby the number of concurrent calls are limited by the buffer size (4) set with an attribute.</p>
<p>Here is how we can use the same service with <code>mapAsyncUnordered</code>:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka/tree/v2.6.8/akka-docs/src/test/scala/docs/stream/IntegrationDocSpec.scala#L440-L448" target="_blank" title="Go to snippet source"></a><code class="language-scala">implicit val blockingExecutionContext = system.dispatchers.lookup(&quot;blocking-dispatcher&quot;)
val service = new SometimesSlowService

Source(List(&quot;a&quot;, &quot;B&quot;, &quot;C&quot;, &quot;D&quot;, &quot;e&quot;, &quot;F&quot;, &quot;g&quot;, &quot;H&quot;, &quot;i&quot;, &quot;J&quot;))
  .map(elem =&gt; { println(s&quot;before: $elem&quot;); elem })
  .mapAsyncUnordered(4)(service.convert)
  .to(Sink.foreach(elem =&gt; println(s&quot;after: $elem&quot;)))
  .withAttributes(Attributes.inputBuffer(initial = 4, max = 4))
  .run()</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka/tree/v2.6.8/akka-docs/src/test/java/jdocs/stream/IntegrationDocTest.java#L711-L723" target="_blank" title="Go to snippet source"></a><code class="language-java">final Executor blockingEc = system.dispatchers().lookup(&quot;blocking-dispatcher&quot;);
final SometimesSlowService service = new SometimesSlowService(blockingEc);

Source.from(Arrays.asList(&quot;a&quot;, &quot;B&quot;, &quot;C&quot;, &quot;D&quot;, &quot;e&quot;, &quot;F&quot;, &quot;g&quot;, &quot;H&quot;, &quot;i&quot;, &quot;J&quot;))
    .map(
        elem -&gt; {
          System.out.println(&quot;before: &quot; + elem);
          return elem;
        })
    .mapAsyncUnordered(4, service::convert)
    .to(Sink.foreach(elem -&gt; System.out.println(&quot;after: &quot; + elem)))
    .withAttributes(Attributes.inputBuffer(4, 4))
    .run(system);</code></pre></dd>
</dl>
<p>The output may look like this:</p>
<pre><code>before: a
before: B
before: C
before: D
running: a (1)
running: B (2)
before: e
running: C (3)
before: F
running: D (4)
before: g
before: H
completed: B (3)
completed: C (1)
completed: D (2)
after: B
after: D
running: e (2)
after: C
running: F (3)
before: i
before: J
completed: F (2)
after: F
running: g (3)
running: H (4)
completed: H (3)
after: H
completed: a (2)
after: A
running: i (3)
running: J (4)
completed: J (3)
after: J
completed: e (2)
after: E
completed: g (1)
after: G
completed: i (0)
after: I
</code></pre>
<p>Note that <code>after</code> lines are not in the same order as the <code>before</code> lines. For example <code>H</code> overtakes the slow <code>G</code>.</p>
<p>The numbers in parenthesis illustrates how many calls that are in progress at the same time. Here the downstream demand and thereby the number of concurrent calls are limited by the buffer size (4) set with an attribute.</p>
</div>
</article>
<div class="row">
<div class="small-12 column">
<section class="nav-prev-next row">
<div class="nav-prev small-6 column">
<a href="../stream/stream-customize.html"><i class="icon-prev"></i> <span class="link-prev">Custom stream processing</span></a>
</div>
<div class="nav-next small-6 column clearfix">
<a class="float-right" href="../stream/actor-interop.html">Actors interop <i class="icon-next"></i></a>
</div>
</section>
</div>
</div>
<div class="source-github row">
Found an error in this documentation? The source code for this page can be found <a href="https://github.com/akka/akka/tree/v2.6.8/akka-docs/src/main/paradox/stream/futures-interop.md">here</a>.
Please feel free to edit and contribute a pull request.
</div>

<footer class="page-footer row clearfix">
<img class="akka-icon float-left show-for-medium" src="../images/akka-icon.svg" />
<section class="copyright">
<div>Akka is Open Source and available under the Apache 2 License.</div>
<p class="legal">
&copy; 2011-2020 <a href="https://www.lightbend.com" target="_blank">Lightbend, Inc.</a> |
<a href="https://www.lightbend.com/legal/licenses" target="_blank">Licenses</a> |
<a href="https://www.lightbend.com/legal/terms" target="_blank">Terms</a> |
<a href="https://www.lightbend.com/legal/privacy" target="_blank">Privacy Policy</a> |
<a href="https://akka.io/cookie/" target="_blank">Cookie Listing</a> |
<a class="optanon-toggle-display">Cookie Settings</a>
</p>
</section>

</footer>
</section>
</main>
</div>

<script type="text/javascript" src="../js/scrollsneak.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../js/groups.js"></script>
<script type="text/javascript" src="../js/page.js"></script>
<script type="text/javascript" src="../js/magellan.js"></script>
<script type="text/javascript" src="../js/metadata-toggle.js"></script>

<style type="text/css">@import "../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(){window.prettyPrint && prettyPrint()});
//]]></script>
<!-- Algolia docs search -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.js"></script>
<style>.algolia-autocomplete { display: block !important }</style>
<script type="text/javascript">
docsearch({
apiKey: '543bad5ad786495d9ccd445ed34ed082',
indexName: 'akka_io',
inputSelector: '#search',
algoliaOptions: {
hitsPerPage: 5
}
});

docsearch({
apiKey: '543bad5ad786495d9ccd445ed34ed082',
indexName: 'akka_io',
inputSelector: '#overlay-search',
algoliaOptions: {
hitsPerPage: 5
}
});

// set up "/" as global shortcut for focusing on search
jQuery(document).keypress(function (event) {
if (event.keyCode == 47) {
jQuery("#search").focus();
return false; // swallow key event, otherwise the / char would be input into the search box
}
});
</script>

<script type="text/javascript" src="../assets/js/warnOldDocs.js"></script>
<script type="text/javascript" src="../assets/js/scalafiddle.js"></script>


</body>
</html>
