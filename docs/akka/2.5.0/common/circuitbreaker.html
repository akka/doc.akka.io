

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Circuit Breaker &#8212; Akka Documentation</title>
    
    <link rel="stylesheet" href="../_static/style.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/prettify.css" type="text/css" />
    <link rel="stylesheet" href="../_static/base.css" type="text/css" />
    <link rel="stylesheet" href="../_static/docs.css" type="text/css" />
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.5.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/toc.js"></script>
    <script type="text/javascript" src="../_static/prettify.js"></script>
    <script type="text/javascript" src="../_static/highlightCode.js"></script>
    <script type="text/javascript" src="../_static/effects.core.js"></script>
    <script type="text/javascript" src="../_static/effects.highlight.js"></script>
    <script type="text/javascript" src="../_static/scrollTo.js"></script>
    <script type="text/javascript" src="../_static/contentsFix.js"></script>
    <script type="text/javascript" src="../_static/ga.js"></script>
    <script type="text/javascript" src="../_static/warnOldDocs.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Akka Extensions" href="../java/extending-akka.html" />
    <link rel="prev" title="Duration" href="duration.html" />
    <!-- Hint to search engines that the "canonical" page is under "current", which will boost it appearing in search results -->
    
      <link rel="canonical" href="https://doc.akka.io/docs/akka/current/common/circuitbreaker.html" />
    

    <!--Google Analytics-->
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-21117439-1']);
      _gaq.push(['_setDomainName', 'akka.io']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })()
    </script>
    <!--Google Analytics & Marketo-->
    <script type="text/javascript">
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-23127719-1', 'lightbend.com', {'allowLinker': true, 'name': 'tsTracker'});
      ga('tsTracker.require', 'linker');
      ga('tsTracker.linker:autoLink', ['lightbend.com','playframework.com','scala-lang.org','scaladays.org','spray.io','akka.io','scala-sbt.org','scala-ide.org']);
      ga('tsTracker.send', 'pageview');

      (function() {
          var didInit = false;
          function initMunchkin() {
          if(didInit === false) {
            didInit = true;
            Munchkin.init('558-NCX-702');
          }
          }
          var s = document.createElement('script');
          s.type = 'text/javascript';
          s.async = true;
          s.src = '//munchkin.marketo.net/munchkin.js';
          s.onreadystatechange = function() {
          if (this.readyState == 'complete' || this.readyState == 'loaded') {
            initMunchkin();
          }
          };
          s.onload = initMunchkin;
          document.getElementsByTagName('head')[0].appendChild(s);
        })();
    </script>


  </head>
  <body role="document">
  <div class="navbar">
    <div class="navbar-inner">
      <div class="container">
        <div class="navbar-logo">
          <a href="https://akka.io"><img class="svg-logo" src="../_static/akka_full_color.svg" /></a>
        </div>
        <ul class="nav">
          <li><a href="https://akka.io/docs">Documentation</a></li>
          <li><a href="https://doc.akka.io/docs/akka/current/additional/faq.html">FAQ</a></li>
          <li><a href="https://akka.io/downloads">Download</a></li>
          <li><a href="http://groups.google.com/group/akka-user">Mailing List</a></li>
          <li><a href="http://github.com/akka/akka">Code</a></li>
          <li><a href="http://www.lightbend.com/how/subscription">Commercial Support</a></li>
        </ul>
      </div>
    </div>
  </div>
  <div class="main">
    <div class="container">
      <div class="page-title">Circuit Breaker - Version 2.5.0</div>
      <div class="pdf-link"><a href="../AkkaScala.pdf" title="Akka Scala Documentation"><img src="../_static/pdf-scala-icon.png" style="height: 40px;" /></a></div>
      <div class="pdf-link"><a href="../AkkaJava.pdf" title="Akka Java Documentation"><img src="../_static/pdf-java-icon.png" style="height: 40px;" /></a></div>
    </div>
    <div class="main-container">
      <div class="container">
        <div class="row">
          <div class="span12">
            <div class="breadcrumb">
              <div style="position: relative">
                <input type="search" id="search" class="form-control" style="position: relative" placeholder="Search in the doc" />
              </div>
              <div>
                <div>
                  <span class="divider">«</span> <a href="duration.html">Duration</a> <span class="divider">|</span>
                </div>
                <div>
                  <a href="../java.html">Java Contents</a> <span class="divider">|</span> <a href="../scala.html">Scala Contents</a>
                </div>
                <div>
                  <span class="divider">|</span> <a href="../java/extending-akka.html">Akka Extensions</a> <span class="divider">»</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="span9">
          </div><div class="span9">
            
  <div class="section" id="circuit-breaker">
<span id="id1"></span><h1>Circuit Breaker</h1>
<div class="section" id="why-are-they-used">
<h2>Why are they used?</h2>
<p>A circuit breaker is used to provide stability and prevent cascading failures in distributed
systems.  These should be used in conjunction with judicious timeouts at the interfaces between
remote systems to prevent the failure of a single component from bringing down all components.</p>
<p>As an example, we have a web application interacting with a remote third party web service.
Let's say the third party has oversold their capacity and their database melts down under load.
Assume that the database fails in such a way that it takes a very long time to hand back an
error to the third party web service.  This in turn makes calls fail after a long period of
time.  Back to our web application, the users have noticed that their form submissions take
much longer seeming to hang.  Well the users do what they know to do which is use the refresh
button, adding more requests to their already running requests.  This eventually causes the
failure of the web application due to resource exhaustion.  This will affect all users, even
those who are not using functionality dependent on this third party web service.</p>
<p>Introducing circuit breakers on the web service call would cause the requests to begin to
fail-fast, letting the user know that something is wrong and that they need not refresh
their request.  This also confines the failure behavior to only those users that are using
functionality dependent on the third party, other users are no longer affected as there is no
resource exhaustion.  Circuit breakers can also allow savvy developers to mark portions of
the site that use the functionality unavailable, or perhaps show some cached content as
appropriate while the breaker is open.</p>
<p>The Akka library provides an implementation of a circuit breaker called
<code class="xref py py-class docutils literal"><span class="pre">akka.pattern.CircuitBreaker</span></code> which has the behavior described below.</p>
</div>
<div class="section" id="what-do-they-do">
<h2>What do they do?</h2>
<ul class="simple">
<li><dl class="first docutils">
<dt>During normal operation, a circuit breaker is in the <cite>Closed</cite> state:</dt>
<dd><ul class="first last">
<li>Exceptions or calls exceeding the configured <cite>callTimeout</cite> increment a failure counter</li>
<li>Successes reset the failure count to zero</li>
<li>When the failure counter reaches a <cite>maxFailures</cite> count, the breaker is tripped into <cite>Open</cite> state</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>While in <cite>Open</cite> state:</dt>
<dd><ul class="first last">
<li>All calls fail-fast with a <code class="xref py py-class docutils literal"><span class="pre">CircuitBreakerOpenException</span></code></li>
<li>After the configured <cite>resetTimeout</cite>, the circuit breaker enters a <cite>Half-Open</cite> state</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>In <cite>Half-Open</cite> state:</dt>
<dd><ul class="first last">
<li>The first call attempted is allowed through without failing fast</li>
<li>All other calls fail-fast with an exception just as in <cite>Open</cite> state</li>
<li>If the first call succeeds, the breaker is reset back to <cite>Closed</cite> state and the <cite>resetTimeout</cite> is reset</li>
<li>If the first call fails, the breaker is tripped again into the <cite>Open</cite> state (as for exponential backoff circuit breaker, the <cite>resetTimeout</cite> is multiplied by the exponential backoff factor)</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>State transition listeners:</dt>
<dd><ul class="first last">
<li>Callbacks can be provided for every state entry via <cite>onOpen</cite>, <cite>onClose</cite>, and <cite>onHalfOpen</cite></li>
<li>These are executed in the <code class="xref py py-class docutils literal"><span class="pre">ExecutionContext</span></code> provided.</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Calls result listeners:</dt>
<dd><ul class="first last">
<li>Callbacks can be used eg. to collect statistics about all invocations or to react on specific call results like success, failures or timeouts.</li>
<li>Supported callbacks are: <cite>onCallSuccess</cite>, <cite>onCallFailure</cite>, <cite>onCallTimeout</cite>, <cite>onCallBreakerOpen</cite>.</li>
<li>These are executed in the <code class="xref py py-class docutils literal"><span class="pre">ExecutionContext</span></code> provided.</li>
</ul>
</dd>
</dl>
</li>
</ul>
<img alt="../_images/circuit-breaker-states.png" src="../_images/circuit-breaker-states.png" />
</div>
<div class="section" id="examples">
<h2>Examples</h2>
<div class="section" id="initialization">
<h3>Initialization</h3>
<dl class="docutils">
<dt>Here's how a <code class="xref py py-class docutils literal"><span class="pre">CircuitBreaker</span></code> would be configured for:</dt>
<dd><ul class="first last simple">
<li>5 maximum failures</li>
<li>a call timeout of 10 seconds</li>
<li>a reset timeout of 1 minute</li>
</ul>
</dd>
</dl>
<div class="section" id="scala">
<h4>Scala</h4>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">scala.concurrent.duration._</span>
<span class="k">import</span> <span class="nn">akka.pattern.CircuitBreaker</span>
<span class="k">import</span> <span class="nn">akka.pattern.pipe</span>
<span class="k">import</span> <span class="nn">akka.actor.</span><span class="o">{</span> <span class="nc">Actor</span><span class="o">,</span> <span class="nc">ActorLogging</span><span class="o">,</span> <span class="nc">ActorRef</span> <span class="o">}</span>

<span class="k">import</span> <span class="nn">scala.concurrent.Future</span>
<span class="k">import</span> <span class="nn">scala.util.</span><span class="o">{</span> <span class="nc">Failure</span><span class="o">,</span> <span class="nc">Success</span><span class="o">,</span> <span class="nc">Try</span> <span class="o">}</span>

<span class="k">class</span> <span class="nc">DangerousActor</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="k">with</span> <span class="nc">ActorLogging</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">context.dispatcher</span>

  <span class="k">val</span> <span class="n">breaker</span> <span class="k">=</span>
    <span class="k">new</span> <span class="nc">CircuitBreaker</span><span class="o">(</span>
      <span class="n">context</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">scheduler</span><span class="o">,</span>
      <span class="n">maxFailures</span> <span class="k">=</span> <span class="mi">5</span><span class="o">,</span>
      <span class="n">callTimeout</span> <span class="k">=</span> <span class="mf">10.</span><span class="n">seconds</span><span class="o">,</span>
      <span class="n">resetTimeout</span> <span class="k">=</span> <span class="mf">1.</span><span class="n">minute</span><span class="o">).</span><span class="n">onOpen</span><span class="o">(</span><span class="n">notifyMeOnOpen</span><span class="o">())</span>

  <span class="k">def</span> <span class="n">notifyMeOnOpen</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span>
    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="o">(</span><span class="s">&quot;My CircuitBreaker is now open, and will not close for one minute&quot;</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="section" id="java">
<h4>Java</h4>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">akka.actor.AbstractActor</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.event.LoggingAdapter</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">scala.concurrent.duration.Duration</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.pattern.CircuitBreaker</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.event.Logging</span><span class="o">;</span>

<span class="k">import</span> <span class="nn">static</span> <span class="n">akka</span><span class="o">.</span><span class="n">pattern</span><span class="o">.</span><span class="nc">PatternsCS</span><span class="o">.</span><span class="n">pipe</span><span class="o">;</span>

<span class="k">import</span> <span class="nn">java.util.concurrent.CompletableFuture</span><span class="o">;</span>

<span class="n">public</span> <span class="k">class</span> <span class="nc">DangerousJavaActor</span> <span class="k">extends</span> <span class="nc">AbstractActor</span> <span class="o">{</span>

  <span class="k">private</span> <span class="k">final</span> <span class="nc">CircuitBreaker</span> <span class="n">breaker</span><span class="o">;</span>
  <span class="k">private</span> <span class="k">final</span> <span class="nc">LoggingAdapter</span> <span class="n">log</span> <span class="k">=</span> <span class="nc">Logging</span><span class="o">.</span><span class="n">getLogger</span><span class="o">(</span><span class="n">getContext</span><span class="o">().</span><span class="n">system</span><span class="o">(),</span> <span class="k">this</span><span class="o">);</span>

  <span class="n">public</span> <span class="nc">DangerousJavaActor</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="n">breaker</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">CircuitBreaker</span><span class="o">(</span>
      <span class="n">getContext</span><span class="o">().</span><span class="n">dispatcher</span><span class="o">(),</span> <span class="n">getContext</span><span class="o">().</span><span class="n">system</span><span class="o">().</span><span class="n">scheduler</span><span class="o">(),</span>
      <span class="mi">5</span><span class="o">,</span> <span class="nc">Duration</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="s">&quot;s&quot;</span><span class="o">),</span> <span class="nc">Duration</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="s">&quot;m&quot;</span><span class="o">))</span>
      <span class="o">.</span><span class="n">onOpen</span><span class="o">(</span><span class="k">this</span><span class="o">::</span><span class="n">notifyMeOnOpen</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="n">public</span> <span class="n">void</span> <span class="n">notifyMeOnOpen</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="o">(</span><span class="s">&quot;My CircuitBreaker is now open, and will not close for one minute&quot;</span><span class="o">);</span>
  <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="future-synchronous-based-api">
<h3>Future &amp; Synchronous based API</h3>
<p>Once a circuit breaker actor has been intialized, interacting with that actor is done by either using the Future based API or the synchronous API. Both of these APIs are considered <code class="docutils literal"><span class="pre">Call</span> <span class="pre">Protection</span></code> because whether synchronously or asynchronously, the purpose of the circuit breaker is to protect your system from cascading failures while making a call to another service. In the future based API, we use the <code class="xref py py-meth docutils literal"><span class="pre">withCircuitBreaker</span></code> which takes an asynchronous method (some method wrapped in a <code class="xref py py-class docutils literal"><span class="pre">Future</span></code>), for instance a call to retrieve data from a database, and we pipe the result back to the sender. If for some reason the database in this example isn't responding, or there is another issue, the circuit breaker will open and stop trying to hit the database again and again until the timeout is over.</p>
<p>The Synchronous API would also wrap your call with the circuit breaker logic, however, it uses the <code class="xref py py-meth docutils literal"><span class="pre">withSyncCircuitBreaker</span></code> and receives a method that is not wrapped in a <code class="xref py py-class docutils literal"><span class="pre">Future</span></code>.</p>
<div class="section" id="id2">
<h4>Scala</h4>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="n">dangerousCall</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">&quot;This really isn&#39;t that dangerous of a call after all&quot;</span>

<span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">case</span> <span class="s">&quot;is my middle name&quot;</span> <span class="k">=&gt;</span>
    <span class="n">breaker</span><span class="o">.</span><span class="n">withCircuitBreaker</span><span class="o">(</span><span class="nc">Future</span><span class="o">(</span><span class="n">dangerousCall</span><span class="o">))</span> <span class="n">pipeTo</span> <span class="n">sender</span><span class="o">()</span>
  <span class="k">case</span> <span class="s">&quot;block for me&quot;</span> <span class="k">=&gt;</span>
    <span class="n">sender</span><span class="o">()</span> <span class="o">!</span> <span class="n">breaker</span><span class="o">.</span><span class="n">withSyncCircuitBreaker</span><span class="o">(</span><span class="n">dangerousCall</span><span class="o">)</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h4>Java</h4>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="n">public</span> <span class="nc">String</span> <span class="n">dangerousCall</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">return</span> <span class="s">&quot;This really isn&#39;t that dangerous of a call after all&quot;</span><span class="o">;</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="n">public</span> <span class="nc">Receive</span> <span class="n">createReceive</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">receiveBuilder</span><span class="o">().</span>
    <span class="k">match</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="n">class</span><span class="o">,</span> <span class="s">&quot;is my middle name&quot;</span><span class="o">::</span><span class="n">equals</span><span class="o">,</span> <span class="n">m</span> <span class="o">-&gt;</span> <span class="n">pipe</span><span class="o">(</span>
      <span class="n">breaker</span><span class="o">.</span><span class="n">callWithCircuitBreakerCS</span><span class="o">(()</span> <span class="o">-&gt;</span>
        <span class="nc">CompletableFuture</span><span class="o">.</span><span class="n">supplyAsync</span><span class="o">(</span><span class="k">this</span><span class="o">::</span><span class="n">dangerousCall</span><span class="o">)</span>
      <span class="o">),</span> <span class="n">getContext</span><span class="o">().</span><span class="n">dispatcher</span><span class="o">()</span>
    <span class="o">).</span><span class="n">to</span><span class="o">(</span><span class="n">sender</span><span class="o">()))</span>
    <span class="o">.</span><span class="k">match</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="n">class</span><span class="o">,</span> <span class="s">&quot;block for me&quot;</span><span class="o">::</span><span class="n">equals</span><span class="o">,</span> <span class="n">m</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="n">sender</span><span class="o">().</span><span class="n">tell</span><span class="o">(</span><span class="n">breaker</span>
        <span class="o">.</span><span class="n">callWithSyncCircuitBreaker</span><span class="o">(</span><span class="k">this</span><span class="o">::</span><span class="n">dangerousCall</span><span class="o">),</span> <span class="n">self</span><span class="o">());</span>
    <span class="o">})</span>
    <span class="o">.</span><span class="n">build</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Using the <code class="xref py py-class docutils literal"><span class="pre">CircuitBreaker</span></code> companion object's <cite>apply</cite> or <cite>create</cite> methods
will return a <code class="xref py py-class docutils literal"><span class="pre">CircuitBreaker</span></code> where callbacks are executed in the caller's thread.
This can be useful if the asynchronous <code class="xref py py-class docutils literal"><span class="pre">Future</span></code> behavior is unnecessary, for
example invoking a synchronous-only API.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There is also a <code class="xref py py-class docutils literal"><span class="pre">CircuitBreakerProxy</span></code> actor that you can use, which is an alternative implementation of the pattern.
The main difference is that it is intended to be used only for request-reply interactions with another actor. See <a class="reference internal" href="../contrib/circuitbreaker.html#circuit-breaker-proxy"><span class="std std-ref">Circuit Breaker Actor</span></a></p>
</div>
</div>
</div>
<div class="section" id="control-failure-count-explicitly">
<h3>Control failure count explicitly</h3>
<p>By default, the circuit breaker treat <code class="xref py py-class docutils literal"><span class="pre">Exception</span></code> as failure in synchronized API, or failed <code class="xref py py-class docutils literal"><span class="pre">Future</span></code> as failure in future based API.
Failure will increment failure count, when failure count reach the <cite>maxFailures</cite>, circuit breaker will be opened.
However, some applications might requires certain exception to not increase failure count, or vice versa,
sometime we want to increase the failure count even if the call succeeded.
Akka circuit breaker provides a way to achieve such use case:</p>
<blockquote>
<div><ul class="simple">
<li><cite>withCircuitBreaker</cite></li>
<li><cite>withSyncCircuitBreaker</cite></li>
<li><cite>callWithCircuitBreaker</cite></li>
<li><cite>callWithCircuitBreakerCS</cite></li>
<li><cite>callWithSyncCircuitBreaker</cite></li>
</ul>
</div></blockquote>
<p>All methods above accepts an argument <code class="docutils literal"><span class="pre">defineFailureFn</span></code></p>
<div class="section" id="id4">
<h4>Scala</h4>
<p>Type of <code class="docutils literal"><span class="pre">defineFailureFn</span></code>: <code class="docutils literal"><span class="pre">Try[T]</span> <span class="pre">⇒</span> <span class="pre">Boolean</span></code></p>
<p>This is a function which takes in a <code class="xref py py-class docutils literal"><span class="pre">Try[T]</span></code> and return a <code class="xref py py-class docutils literal"><span class="pre">Boolean</span></code>. The <code class="xref py py-class docutils literal"><span class="pre">Try[T]</span></code> correspond to the <code class="xref py py-class docutils literal"><span class="pre">Future[T]</span></code> of the protected call. This function should return <code class="docutils literal"><span class="pre">true</span></code> if the call should increase failure count, else false.</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="n">luckyNumber</span><span class="o">()</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">evenNumberAsFailure</span><span class="k">:</span> <span class="kt">Try</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=&gt;</span> <span class="nc">Boolean</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Success</span><span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">case</span> <span class="nc">Failure</span><span class="o">(</span><span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="kc">true</span>
  <span class="o">}</span>

  <span class="k">val</span> <span class="n">breaker</span> <span class="k">=</span>
    <span class="k">new</span> <span class="nc">CircuitBreaker</span><span class="o">(</span>
      <span class="n">context</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">scheduler</span><span class="o">,</span>
      <span class="n">maxFailures</span> <span class="k">=</span> <span class="mi">5</span><span class="o">,</span>
      <span class="n">callTimeout</span> <span class="k">=</span> <span class="mf">10.</span><span class="n">seconds</span><span class="o">,</span>
      <span class="n">resetTimeout</span> <span class="k">=</span> <span class="mf">1.</span><span class="n">minute</span><span class="o">)</span>

  <span class="c1">// this call will return 8888 and increase failure count at the same time</span>
  <span class="n">breaker</span><span class="o">.</span><span class="n">withCircuitBreaker</span><span class="o">(</span><span class="nc">Future</span><span class="o">(</span><span class="mi">8888</span><span class="o">),</span> <span class="n">evenNumberAsFailure</span><span class="o">)</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h4>Java</h4>
<p>Type of <code class="docutils literal"><span class="pre">defineFailureFn</span></code>:  <code class="xref py py-class docutils literal"><span class="pre">BiFunction[Optional[T],</span> <span class="pre">Optional[Throwable],</span> <span class="pre">java.lang.Boolean]</span></code></p>
<p>For Java Api, the signature is a bit different as there's no <code class="xref py py-class docutils literal"><span class="pre">Try</span></code> in Java, so the response of protected call is modelled using <code class="xref py py-class docutils literal"><span class="pre">Optional[T]</span></code> for succeeded return value and <code class="xref py py-class docutils literal"><span class="pre">Optional[Throwable]</span></code> for exception, and the rules of return type is the same.
Ie. this function should return <code class="docutils literal"><span class="pre">true</span></code> if the call should increase failure count, else false.</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="k">private</span> <span class="k">final</span> <span class="nc">CircuitBreaker</span> <span class="n">breaker</span><span class="o">;</span>

<span class="n">public</span> <span class="nc">EvenNoFailureJavaExample</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="n">breaker</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">CircuitBreaker</span><span class="o">(</span>
            <span class="n">getContext</span><span class="o">().</span><span class="n">dispatcher</span><span class="o">(),</span> <span class="n">getContext</span><span class="o">().</span><span class="n">system</span><span class="o">().</span><span class="n">scheduler</span><span class="o">(),</span>
            <span class="mi">5</span><span class="o">,</span> <span class="nc">Duration</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="s">&quot;s&quot;</span><span class="o">),</span> <span class="nc">Duration</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="s">&quot;m&quot;</span><span class="o">));</span>
<span class="o">}</span>

<span class="n">public</span> <span class="n">int</span> <span class="n">luckyNumber</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">BiFunction</span><span class="o">&lt;</span><span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;,</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Throwable</span><span class="o">&gt;,</span> <span class="nc">Boolean</span><span class="o">&gt;</span> <span class="n">evenNoAsFailure</span> <span class="k">=</span>
            <span class="o">(</span><span class="n">result</span><span class="o">,</span> <span class="n">err</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="n">isPresent</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="o">()</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="o">);</span>

    <span class="c1">// this will return 8888 and increase failure count at the same time</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="n">breaker</span><span class="o">.</span><span class="n">callWithSyncCircuitBreaker</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="mi">8888</span><span class="o">,</span> <span class="n">evenNoAsFailure</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="low-level-api">
<h3>Low level API</h3>
<p>The low-level API allows you to describe the behaviour of the CircuitBreaker in detail, including deciding what to return to the calling <code class="docutils literal"><span class="pre">Actor</span></code> in case of success or failure. This is especially useful when expecting the remote call to send a reply. CircuitBreaker doesn't support <code class="docutils literal"><span class="pre">Tell</span> <span class="pre">Protection</span></code> (protecting against calls that expect a reply) natively at the moment, so you need to use the low-level power-user APIs, <code class="docutils literal"><span class="pre">succeed</span></code>  and  <code class="docutils literal"><span class="pre">fail</span></code> methods, as well as <code class="docutils literal"><span class="pre">isClose</span></code>, <code class="docutils literal"><span class="pre">isOpen</span></code>, <code class="docutils literal"><span class="pre">isHalfOpen</span></code> to implement it.</p>
<p>As can be seen in the examples below, a <code class="docutils literal"><span class="pre">Tell</span> <span class="pre">Protection</span></code> pattern could be implemented by using the <code class="docutils literal"><span class="pre">succeed</span></code> and <code class="docutils literal"><span class="pre">fail</span></code> methods, which would count towards the <code class="xref py py-class docutils literal"><span class="pre">CircuitBreaker</span></code> counts. In the example, a call is made to the remote service if the <code class="docutils literal"><span class="pre">breaker.isClosed</span></code>, and once a response is received, the <code class="docutils literal"><span class="pre">succeed</span></code> method is invoked, which tells the <code class="xref py py-class docutils literal"><span class="pre">CircuitBreaker</span></code> to keep the breaker closed. If on the other hand an error or timeout is received, we trigger a <code class="docutils literal"><span class="pre">fail</span></code> and the breaker accrues this failure towards its count for opening the breaker.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The below examples doesn't make a remote call when the state is <cite>HalfOpen</cite>. Using the power-user APIs, it is your responsibility to judge when to make remote calls in <cite>HalfOpen</cite>.</p>
</div>
<div class="section" id="id6">
<h4>Scala</h4>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">akka.actor.ReceiveTimeout</span>

<span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">case</span> <span class="s">&quot;call&quot;</span> <span class="k">if</span> <span class="n">breaker</span><span class="o">.</span><span class="n">isClosed</span> <span class="k">=&gt;</span> <span class="o">{</span>
    <span class="n">recipient</span> <span class="o">!</span> <span class="s">&quot;message&quot;</span>
  <span class="o">}</span>
  <span class="k">case</span> <span class="s">&quot;response&quot;</span> <span class="k">=&gt;</span> <span class="o">{</span>
    <span class="n">breaker</span><span class="o">.</span><span class="n">succeed</span><span class="o">()</span>
  <span class="o">}</span>
  <span class="k">case</span> <span class="n">err</span><span class="k">:</span> <span class="kt">Throwable</span> <span class="o">=&gt;</span> <span class="o">{</span>
    <span class="n">breaker</span><span class="o">.</span><span class="n">fail</span><span class="o">()</span>
  <span class="o">}</span>
  <span class="k">case</span> <span class="nc">ReceiveTimeout</span> <span class="k">=&gt;</span> <span class="o">{</span>
    <span class="n">breaker</span><span class="o">.</span><span class="n">fail</span><span class="o">()</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h4>Java</h4>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="nd">@Override</span>
<span class="n">public</span> <span class="nc">Receive</span> <span class="n">createReceive</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">receiveBuilder</span><span class="o">()</span>
    <span class="o">.</span><span class="k">match</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="n">class</span><span class="o">,</span> <span class="n">payload</span> <span class="o">-&gt;</span> <span class="s">&quot;call&quot;</span><span class="o">.</span><span class="n">equals</span><span class="o">(</span><span class="n">payload</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">breaker</span><span class="o">.</span><span class="n">isClosed</span><span class="o">(),</span> <span class="n">payload</span> <span class="o">-&gt;</span> 
      <span class="n">target</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="s">&quot;message&quot;</span><span class="o">,</span> <span class="n">self</span><span class="o">())</span>
    <span class="o">)</span>
    <span class="o">.</span><span class="n">matchEquals</span><span class="o">(</span><span class="s">&quot;response&quot;</span><span class="o">,</span> <span class="n">payload</span> <span class="o">-&gt;</span> 
      <span class="n">breaker</span><span class="o">.</span><span class="n">succeed</span><span class="o">()</span>
    <span class="o">)</span>
    <span class="o">.</span><span class="k">match</span><span class="o">(</span><span class="nc">Throwable</span><span class="o">.</span><span class="n">class</span><span class="o">,</span> <span class="n">t</span> <span class="o">-&gt;</span>
      <span class="n">breaker</span><span class="o">.</span><span class="n">fail</span><span class="o">()</span>
    <span class="o">)</span>
    <span class="o">.</span><span class="k">match</span><span class="o">(</span><span class="nc">ReceiveTimeout</span><span class="o">.</span><span class="n">class</span><span class="o">,</span> <span class="n">t</span> <span class="o">-&gt;</span>    
      <span class="n">breaker</span><span class="o">.</span><span class="n">fail</span><span class="o">()</span>
    <span class="o">)</span>
    <span class="o">.</span><span class="n">build</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>


          </div>
          <div class="span3"><p class="contents-title">Contents</p>
              <div id="scroller-anchor">
                <div id="scroller">
                  <div id="toc"></div>
                </div>
              </div></div>
        </div>
      </div>
    </div>
  </div>
  <div class="footer">
  <div class="container">
    <ul>
      <li><h5>Akka</h5></li>
      <li><a href="https://akka.io/docs">Documentation</a></li>
      <li><a href="https://doc.akka.io/docs/akka/current/additional/faq.html">FAQ</a></li>
      <li><a href="https://akka.io/downloads">Downloads</a></li>
      <li><a href="https://akka.io/news">News</a></li>
      <li><a href="http://letitcrash.com">Blog</a></li>
    </ul>
    <ul>
      <li><h5>Contribute</h5></li>
      <li><a href="https://akka.io/community">Community Projects</a></li>
      <li><a href="http://github.com/akka/akka">Source Code</a></li>
      <li><a href="http://groups.google.com/group/akka-user">Mailing List</a></li>
      <li><a href="https://doc.akka.io/docs/akka/current/project/issue-tracking.html">Report a Bug</a></li>
    </ul>
    <ul>
      <li><h5>Company</h5></li>
      <li><a href="http://www.lightbend.com/how/subscription">Commercial Support</a></li>
      <li><a href="https://akka.io/team">Team</a></li>
      <li><a href="mailto:info@lightbend.com">Contact</a></li>
    </ul>
    <ul>
      <li><img src="../_static/akka_icon_reverse.svg" align="center"/></li>
    </ul>
  </div>
  <div class="container copyright">
    <p style="float: left;">
      © 2015 <a href="http://www.lightbend.com/">Lightbend Inc.</a> <span class="license">Akka is Open Source and available under the Apache 2 License.</span>
    </p>
    <p style="float: right; font-size: 12px;">
      Last updated: Apr 12, 2017
    </p>
  </div>
</div>
<script type="text/javascript">
  var $toc = $('#toc');
  $toc.toc();

  // show clickable section sign when section header hovered:
  $('.section h2,.section h3,.section h4,.section h5').each(function(i, el) {
      var $el = $(el);
      $el.prepend($("<a class='section-marker' href='#" + $el.attr("id") + "'>&sect;</a>"))
  });
</script>

<!-- Algolia docs search -->
<script type="text/javascript">
  var version = DOCUMENTATION_OPTIONS.VERSION;

  var lang = "scala";
  var path = window.location.pathname;
  if (path.includes("/java/") || path.includes("java.html")) lang = "java";

  console.log("Search configured for:", lang, "@", version);

  docsearch({
    apiKey: '543bad5ad786495d9ccd445ed34ed082',
    indexName: 'akka_io',
    inputSelector: '#search',
    algoliaOptions: {
      hitsPerPage: 5,
      facetFilters: '[' + '["language:' + lang + '","language:general"]' + ',"version:' + version + '"]'
    }
  });

  // set up "/" as global shortcut for focusing on search
  $(document).keypress(function (event) {
    if (event.keyCode == 47) {
      $("#q").focus();
      return false; // swallow key event, otherwise the / char would be input into the search box
    }
  });
</script>

  

  </body>
</html>