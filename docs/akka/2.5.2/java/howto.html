<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>HowTo: Common Patterns &bull; Akka Documentation</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="Akka is a toolkit for building highly concurrent, distributed, and resilient message-driven applications for Java and Scala."/>
<link rel="canonical" href="https://doc.akka.io/docs/akka/current/howto.html"/>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../lib/foundation/dist/js/foundation.min.js"></script>
<link rel="stylesheet" type="text/css" href="../lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="../lib/foundation/dist/css/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" type="text/css" href="../css/icons.css"/>
<link rel="stylesheet" type="text/css" href="../css/page.css"/>
<link rel="shortcut icon" href="../images/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="../images/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="../images/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../images/favicon-16x16.png">
<link rel="manifest" href="../images/manifest.json">
<meta name="msapplication-TileImage" content="../images/mstile-150x150.png">
<meta name="msapplication-TileColor" content="#15a9ce">
<meta name="theme-color" content="#15a9ce">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!--Google Analytics-->
<script type="text/javascript">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-21117439-1']);
_gaq.push(['_setDomainName', 'akka.io']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})()
</script>
<!--Google Analytics & Marketo-->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-23127719-1', 'lightbend.com', {'allowLinker': true, 'name': 'tsTracker'});
ga('tsTracker.require', 'linker');
ga('tsTracker.linker:autoLink', ['lightbend.com','playframework.com','scala-lang.org','scaladays.org','spray.io','akka.io','scala-sbt.org','scala-ide.org']);
ga('tsTracker.send', 'pageview');
(function() {
var didInit = false;
function initMunchkin() {
if(didInit === false) {
didInit = true;
Munchkin.init('558-NCX-702');
}
}
var s = document.createElement('script');
s.type = 'text/javascript';
s.async = true;
s.src = '//munchkin.marketo.net/munchkin.js';
s.onreadystatechange = function() {
if (this.readyState == 'complete' || this.readyState == 'loaded') {
initMunchkin();
}
};
s.onload = initMunchkin;
document.getElementsByTagName('head')[0].appendChild(s);
})();
</script>

</head>

<body id="underlay" data-toggler="nav-open">

<header class="site-header hide-for-large">
<div class="sticky-header clearfix">
<a href="https://akka.io"><img class="logo" src="../images/akka-logo-reverse.svg"></a>

<button class="menu-icon float-right" type="button" data-toggle="underlay overlay"></button>
</div>
<div id="overlay" class="overlay-nav" data-toggler="nav-open">
<header class="nav-header">
<div class="nav-header-title">
<h1><a href="../java/index.html">Akka Documentation</a></h1>
</div>
<div class="nav-header-version">
Version 2.5.2
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Languages"><option class="group" value="group-scala">Scala</option><option class="group" value="group-java">Java</option></select>
</div>
<div id="overlay-search-container" class="nav-header-search">
<input id="overlay-search" type="search" class="search" placeholder="Search"/>
</div>
</header>
<nav class="nav-toc">
<ul>
  <li><a href="../java/security/index.html" class="page">Security Announcements</a></li>
  <li><a href="../java/guide/index.html" class="page">Getting Started Guide</a></li>
  <li><a href="../java/general/index.html" class="page">General Concepts</a></li>
  <li><a href="../java/index-actors.html" class="page">Actors</a></li>
  <li><a href="../java/index-network.html" class="page">Networking</a></li>
  <li><a href="../java/stream/index.html" class="page">Streams</a></li>
  <li><a href="../java/index-futures.html" class="page">Futures and Agents</a></li>
  <li><a href="../java/index-utilities.html" class="page">Utilities</a></li>
  <li><a href="../java/common/other-modules.html" class="page">Other Akka modules</a></li>
  <li><a href="../java/howto.html#howto-common-patterns" class="active page">HowTo: Common Patterns</a>
  <ul>
    <li><a href="../java/howto.html#scheduling-periodic-messages" class="header">Scheduling Periodic Messages</a></li>
    <li><a href="../java/howto.html#single-use-actor-trees-with-high-level-error-reporting" class="header">Single-Use Actor Trees with High-Level Error Reporting</a></li>
  </ul></li>
  <li><a href="../java/scala-compat.html" class="page">Java 8 and Scala Compatibility</a></li>
  <li><a href="../java/project/index.html" class="page">Project Information</a></li>
  <li><a href="../java/additional/index.html" class="page">Additional Information</a></li>
</ul>
</nav>
</div>
</header>

<aside class="show-for-large">
<header class="nav-header fixed-sidebar-header">
<div class="nav-header-title">
<h1><a href="../java/index.html">Akka Documentation</a></h1>
</div>
<div class="nav-header-version">
Version 2.5.2
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Languages"><option class="group" value="group-scala">Scala</option><option class="group" value="group-java">Java</option></select>
</div>
<div class="nav-header-search">
<input id="search" type="search" class="search" placeholder="Search"/>
</div>
</header>
<nav class="site-nav fixed-sidebar-contents">
<div class="nav-toc">
<ul>
  <li><a href="../java/security/index.html" class="page">Security Announcements</a></li>
  <li><a href="../java/guide/index.html" class="page">Getting Started Guide</a></li>
  <li><a href="../java/general/index.html" class="page">General Concepts</a></li>
  <li><a href="../java/index-actors.html" class="page">Actors</a></li>
  <li><a href="../java/index-network.html" class="page">Networking</a></li>
  <li><a href="../java/stream/index.html" class="page">Streams</a></li>
  <li><a href="../java/index-futures.html" class="page">Futures and Agents</a></li>
  <li><a href="../java/index-utilities.html" class="page">Utilities</a></li>
  <li><a href="../java/common/other-modules.html" class="page">Other Akka modules</a></li>
  <li><a href="../java/howto.html#howto-common-patterns" class="active page">HowTo: Common Patterns</a>
  <ul>
    <li><a href="../java/howto.html#scheduling-periodic-messages" class="header">Scheduling Periodic Messages</a></li>
    <li><a href="../java/howto.html#single-use-actor-trees-with-high-level-error-reporting" class="header">Single-Use Actor Trees with High-Level Error Reporting</a></li>
  </ul></li>
  <li><a href="../java/scala-compat.html" class="page">Java 8 and Scala Compatibility</a></li>
  <li><a href="../java/project/index.html" class="page">Project Information</a></li>
  <li><a href="../java/additional/index.html" class="page">Additional Information</a></li>
</ul>
</div>
</nav>
<footer class="nav-footer fixed-sidebar-footer">
<a href="https://akka.io"><img class="logo" src="../images/akka-logo-reverse.svg"></a>

</footer>
</aside>

<main class="fixed-shift-for-large expanded row">
<section class="site-content small-12 column">

<article class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h1><a href="#howto-common-patterns" name="howto-common-patterns" class="anchor"><span class="anchor-link"></span></a>HowTo: Common Patterns</h1>
<p>This section lists common actor patterns which have been found to be useful, elegant or instructive. Anything is welcome, example topics being message routing strategies, supervision patterns, restart handling, etc. As a special bonus, additions to this section are marked with the contributorâ€™s name, and it would be nice if every Akka user who finds a recurring pattern in his or her code could share it for the profit of all. Where applicable it might also make sense to add to the <code>akka.pattern</code> package for creating an <a href="http://www.erlang.org/doc/man_index.html">OTP-like library</a>.</p>
<p>You might find some of the patterns described in the Scala chapter of <a href="howto.html">HowTo: Common Patterns</a> useful even though the example code is written in Scala.</p>
<h2><a href="#scheduling-periodic-messages" name="scheduling-periodic-messages" class="anchor"><span class="anchor-link"></span></a>Scheduling Periodic Messages</h2>
<p>This pattern describes how to schedule periodic messages to yourself in two different ways.</p>
<p>The first way is to set up periodic message scheduling in the constructor of the actor, and cancel that scheduled sending in <code>postStop</code> or else we might have multiple registered message sends to the same actor.</p><div class="callout note "><div class="callout-title">Note</div>
<p>With this approach the scheduled periodic message send will be restarted with the actor on restarts. This also means that the time period that elapses between two tick messages during a restart may drift off based on when you restart the scheduled message sends relative to the time that the last message was sent, and how long the initial delay is. Worst case scenario is <code>interval</code> plus <code>initialDelay</code>.</p></div>
<pre class="prettyprint"><code class="language-java">public class ScheduleInConstructor extends AbstractActor {

  private final Cancellable tick = getContext().getSystem().scheduler().schedule(
    Duration.create(500, TimeUnit.MILLISECONDS),
    Duration.create(1, TimeUnit.SECONDS),
    getSelf(), &quot;tick&quot;, getContext().dispatcher(), null);

  @Override
  public void postStop() {
    tick.cancel();
  }

  @Override
  public Receive createReceive() {
    return receiveBuilder()
      .matchEquals(&quot;tick&quot;, message -&gt; {
        // do something useful here
      })
      .matchEquals(&quot;restart&quot;, message -&gt; {
        throw new ArithmeticException();
      })
      .build();
  }
}</code></pre>
<p>The second variant sets up an initial one shot message send in the <code>preStart</code> method of the actor, and the then the actor when it receives this message sets up a new one shot message send. You also have to override <code>postRestart</code> so we don&rsquo;t call <code>preStart</code> and schedule the initial message send again.</p><div class="callout note "><div class="callout-title">Note</div>
<p>With this approach we won&rsquo;t fill up the mailbox with tick messages if the actor is under pressure, but only schedule a new tick message when we have seen the previous one.</p></div>
<pre class="prettyprint"><code class="language-java">public class ScheduleInReceive extends AbstractActor {

  @Override
  public void preStart() {
    getContext().getSystem().scheduler().scheduleOnce(
      Duration.create(500, TimeUnit.MILLISECONDS),
      getSelf(), &quot;tick&quot;, getContext().dispatcher(), null);
  }

  // override postRestart so we don&#39;t call preStart and schedule a new message
  @Override
  public void postRestart(Throwable reason) {
  }

  @Override
  public Receive createReceive() {
    return receiveBuilder()
      .matchEquals(&quot;tick&quot;, message -&gt; {
        // send another periodic tick after the specified delay
        getContext().getSystem().scheduler().scheduleOnce(
          Duration.create(1, TimeUnit.SECONDS),
          getSelf(), &quot;tick&quot;, getContext().dispatcher(), null);
        // do something useful here
      })
      .matchEquals(&quot;restart&quot;, message -&gt; {
        throw new ArithmeticException();
      })
      .build();
  }
}</code></pre>
<h2><a href="#single-use-actor-trees-with-high-level-error-reporting" name="single-use-actor-trees-with-high-level-error-reporting" class="anchor"><span class="anchor-link"></span></a>Single-Use Actor Trees with High-Level Error Reporting</h2>
<p><em>Contributed by: Rick Latrine</em></p>
<p>A nice way to enter the actor world from java is the use of Patterns.ask(). This method starts a temporary actor to forward the message and collect the result from the actor to be &ldquo;asked&rdquo;. In case of errors within the asked actor the default supervision handling will take over. The caller of Patterns.ask() will <em>not</em> be notified.</p>
<p>If that caller is interested in such an exception, they must make sure that the asked actor replies with Status.Failure(Throwable). Behind the asked actor a complex actor hierarchy might be spawned to accomplish asynchronous work. Then supervision is the established way to control error handling.</p>
<p>Unfortunately the asked actor must know about supervision and must catch the exceptions. Such an actor is unlikely to be reused in a different actor hierarchy and contains crippled try/catch blocks.</p>
<p>This pattern provides a way to encapsulate supervision and error propagation to the temporary actor. Finally the promise returned by Patterns.ask() is fulfilled as a failure, including the exception (see also <a href="scala-compat.html">Java 8 and Scala Compatibility</a> for Java compatibility).</p>
<p>Let&rsquo;s have a look at the example code:</p>
<pre class="prettyprint"><code class="language-java">package jdocs.pattern;

import java.util.concurrent.CompletionStage;
import java.util.concurrent.TimeoutException;

import scala.concurrent.duration.Duration;

import akka.actor.ActorKilledException;
import akka.actor.ActorRef;
import akka.actor.ActorRefFactory;
import akka.actor.Cancellable;
import akka.actor.OneForOneStrategy;
import akka.actor.Props;
import akka.actor.Scheduler;
import akka.actor.Status;
import akka.actor.SupervisorStrategy;
import akka.actor.Terminated;
import akka.actor.AbstractActor;
import akka.pattern.PatternsCS;
import akka.util.Timeout;

public class SupervisedAsk {

  private static class AskParam {
    Props props;
    Object message;
    Timeout timeout;

    AskParam(Props props, Object message, Timeout timeout) {
      this.props = props;
      this.message = message;
      this.timeout = timeout;
    }
  }

  private static class AskTimeout {
  }

  public static class AskSupervisorCreator extends AbstractActor {

    @Override
    public Receive createReceive() {
      return receiveBuilder()
        .match(AskParam.class, message -&gt; {
          ActorRef supervisor = getContext().actorOf(
            Props.create(AskSupervisor.class));
          supervisor.forward(message, getContext());
        })
        .build();
    }
  }

  public static class AskSupervisor extends AbstractActor {
    private ActorRef targetActor;
    private ActorRef caller;
    private AskParam askParam;
    private Cancellable timeoutMessage;

    @Override
    public SupervisorStrategy supervisorStrategy() {
      return new OneForOneStrategy(0, Duration.Zero(), cause -&gt; {
          caller.tell(new Status.Failure(cause), getSelf());
          return SupervisorStrategy.stop();
        });
    }

    @Override
    public Receive createReceive() {
      return receiveBuilder()
        .match(AskParam.class, message -&gt; {
          askParam = message;
          caller = getSender();
          targetActor = getContext().actorOf(askParam.props);
          getContext().watch(targetActor);
          targetActor.forward(askParam.message, getContext());
          Scheduler scheduler = getContext().getSystem().scheduler();
          timeoutMessage = scheduler.scheduleOnce(askParam.timeout.duration(),
            getSelf(), new AskTimeout(), getContext().dispatcher(), null);
        })
        .match(Terminated.class, message -&gt; {
          Throwable ex = new ActorKilledException(&quot;Target actor terminated.&quot;);
          caller.tell(new Status.Failure(ex), getSelf());
          timeoutMessage.cancel();
          getContext().stop(getSelf());
        })
        .match(AskTimeout.class, message -&gt; {
          Throwable ex = new TimeoutException(&quot;Target actor timed out after &quot;
            + askParam.timeout.toString());
          caller.tell(new Status.Failure(ex), getSelf());
          getContext().stop(getSelf());
        })
        .build();
    }
  }

  public static CompletionStage&lt;Object&gt; askOf(ActorRef supervisorCreator, Props props,
                                              Object message, Timeout timeout) {
    AskParam param = new AskParam(props, message, timeout);
    return PatternsCS.ask(supervisorCreator, param, timeout);
  }

  synchronized public static ActorRef createSupervisorCreator(
      ActorRefFactory factory) {
    return factory.actorOf(Props.create(AskSupervisorCreator.class));
  }
}</code></pre>
<p>In the askOf method the SupervisorCreator is sent the user message. The SupervisorCreator creates a SupervisorActor and forwards the message. This prevents the actor system from overloading due to actor creations. The SupervisorActor is responsible to create the user actor, forwards the message, handles actor termination and supervision. Additionally the SupervisorActor stops the user actor if execution time expired.</p>
<p>In case of an exception the supervisor tells the temporary actor which exception was thrown. Afterwards the actor hierarchy is stopped.</p>
<p>Finally we are able to execute an actor and receive the results or exceptions.</p>
<pre class="prettyprint"><code class="language-java">package jdocs.pattern;

import akka.actor.ActorRef;
import akka.actor.ActorRefFactory;
import akka.actor.Props;
import akka.actor.AbstractActor;
import akka.util.Timeout;
import scala.concurrent.duration.FiniteDuration;

import java.util.concurrent.CompletionStage;

public class SupervisedAskSpec {

  public Object execute(Class&lt;? extends AbstractActor&gt; someActor,
      Object message, Timeout timeout, ActorRefFactory actorSystem)
      throws Exception {
    // example usage
    try {
      ActorRef supervisorCreator = SupervisedAsk
          .createSupervisorCreator(actorSystem);
      CompletionStage&lt;Object&gt; finished = SupervisedAsk.askOf(supervisorCreator,
          Props.create(someActor), message, timeout);
      FiniteDuration d = timeout.duration();
      return finished.toCompletableFuture().get(d.length(), d.unit());
    } catch (Exception e) {
      // exception propagated by supervision
      throw e;
    }
  }
}</code></pre>
</div>
</article>

<div class="row">
<div class="small-12 large-9 column">
<section class="nav-prev-next row">
<div class="nav-prev small-6 column">
<a href="../java/common/other-modules.html"><i class="icon-prev"></i> <span class="link-prev">Other Akka modules</span></a>
</div>
<div class="nav-next small-6 column clearfix">
<a class="float-right" href="../java/scala-compat.html">Java 8 and Scala Compatibility <i class="icon-next"></i></a>
</div>
</section>
</div>
</div>

<div class="source-github row">
The source code for this page can be found <a href="http://github.com/akka/akka/tree/master/akka-docs/src/main/paradox/java/howto.md">here</a>.
</div>


<footer class="page-footer row clearfix">
<img class="akka-icon float-left show-for-medium" src="../images/akka-icon.svg">
<section class="copyright">
<div>&copy; 2011-2017 <a href="https://www.lightbend.com">Lightbend</a></div>
<div>Akka is Open Source and available under the Apache 2 License.</div>
</section>
</footer>

</section>
</main>

<script type="text/javascript" src="../js/scrollsneak.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../js/groups.js"></script>
<script type="text/javascript" src="../js/page.js"></script>
<script type="text/javascript" src="../js/magellan.js"></script>

<style type="text/css">@import "../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">jQuery(function(){window.prettyPrint && prettyPrint()});</script>

<!-- Algolia docs search -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.js"></script>
<style>.algolia-autocomplete { display: block !important }</style>
<script type="text/javascript">
var lang = "scala";
var path = window.location.pathname;
if (path.includes("/java/") || path.includes("java.html")) {
lang = "java";
}

docsearch({
apiKey: '543bad5ad786495d9ccd445ed34ed082',
indexName: 'akka_io',
inputSelector: '#search',
algoliaOptions: {
hitsPerPage: 5,
facetFilters: ["language:" + lang]
}
});

docsearch({
apiKey: '543bad5ad786495d9ccd445ed34ed082',
indexName: 'akka_io',
inputSelector: '#overlay-search',
algoliaOptions: {
hitsPerPage: 5,
facetFilters: ["language:" + lang]
}
});

// set up "/" as global shortcut for focusing on search
jQuery(document).keypress(function (event) {
if (event.keyCode == 47) {
jQuery("#search").focus();
return false; // swallow key event, otherwise the / char would be input into the search box
}
});
</script>


</body>
</html>
