<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Cluster Sharding concepts &bull; Akka Documentation</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="Akka is a toolkit for building highly concurrent, distributed, and resilient message-driven applications for Java and Scala."/>
<link rel="canonical" href="https://doc.akka.io/docs/akka/current/typed/cluster-sharding-concepts.html"/>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../lib/foundation/dist/js/foundation.min.js"></script>
<link rel="stylesheet" type="text/css" href="../lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="../lib/foundation/dist/css/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" type="text/css" href="../css/icons.css"/>
<link rel="stylesheet" type="text/css" href="../css/page-7.css"/>
<link rel="stylesheet" type="text/css" href="../css/banner-1.css"/>
<link rel="shortcut icon" href="../images/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="../images/apple-touch-icon.png"/>
<link rel="icon" type="image/png" sizes="32x32" href="../images/favicon-32x32.png"/>
<link rel="icon" type="image/png" sizes="16x16" href="../images/favicon-16x16.png"/>
<link rel="manifest" href="../images/manifest.json"/>
<meta name="msapplication-TileImage" content="../images/mstile-150x150.png"/>
<meta name="msapplication-TileColor" content="#15a9ce"/>
<meta name="theme-color" content="#15a9ce"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) start -->
<script src="https://optanon.blob.core.windows.net/consent/159bb13d-6748-4399-806e-ac28db879785.js" type="text/javascript" charset="UTF-8"></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) end -->
<!--Google Analytics-->
<script type="text/plain" class="optanon-category-2">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-21117439-1']);
_gaq.push(['_setDomainName', 'akka.io']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})()
</script>
<!-- Google Tag Manager -->
<script type="text/plain" class="optanon-category-2">
(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KBJGH35');
</script>
<!--Marketo-->
<script type="text/plain" class="optanon-category-3">
(function() {
var didInit = false;
function initMunchkin() {
if(didInit === false) {
didInit = true;
Munchkin.init('558-NCX-702', { 'asyncOnly': true, 'disableClickDelay': true });
}
}
var s = document.createElement('script');
s.type = 'text/javascript';
s.async = true;
s.src = '//munchkin.marketo.net/munchkin.js';
s.onreadystatechange = function() {
if (this.readyState == 'complete' || this.readyState == 'loaded') {
initMunchkin();
}
};
s.onload = initMunchkin;
document.getElementsByTagName('head')[0].appendChild(s);
})();
</script>
</head>

<body id="underlay" data-toggler="nav-open">
<div id="lightbend-banner" class="lightbend-banner akka full-width" data-category="OSS Lightbend Banner Impression" data-label="Akka Banner Impression">
<div class="wrapper">
<div class="brand">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lightbend Logo - Akka Banner" href="https://www.lightbend.com?r=oss-banner-akka" target="_blank">
<img class="lightbend-logo" src="../images/banner-logos/lightbend-reverse.svg" alt="Lightbend" title="Lightbend">
</a>
</div>
<div class="nav">
<a class="banner-btn oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Enhance your Akka systems with Akka Platform [Button] - Akka Banner" href="https://www.lightbend.com/akka-core-of-lightbend?r=oss-banner-akka" target="_blank">
<span>Enhance your Akka systems with</span>
<img class="akka-platform-reverse-logo" src="../images/banner-logos/akka-platform-reverse.svg" alt="Akka Platform" title="Akka Platform">
</a>
<div class="drop-down">
<svg class="svg-chevon-circle-down" version="1.1" id="Chevron_circled_down" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve">
<path fill="#ffffff" d="M12.505,8.698L10,11L7.494,8.698c-0.198-0.196-0.518-0.196-0.718,0c-0.197,0.196-0.197,0.515,0,0.71l2.864,2.807
c0.199,0.196,0.52,0.196,0.717,0l2.864-2.807c0.199-0.195,0.198-0.514,0-0.71C13.024,8.502,12.704,8.502,12.505,8.698z M10,0.4
c-5.302,0-9.6,4.298-9.6,9.6c0,5.303,4.298,9.6,9.6,9.6s9.6-4.297,9.6-9.6C19.6,4.698,15.302,0.4,10,0.4z M10,18.354
c-4.615,0-8.354-3.74-8.354-8.354c0-4.614,3.739-8.354,8.354-8.354c4.613,0,8.354,3.74,8.354,8.354
C18.354,14.614,14.613,18.354,10,18.354z" />
</svg>
<div class="drop-down-content">
<div class="lightbend-family">
<a href="https://cloudflow.io" class="cloudflow oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Cloudflow - Logo Tag Line - Akka Banner">
<img class="cloudflow-full-color-logo" src="../images/banner-logos/cloudflow-full-color.svg" alt="Cloudflow by Lightbend" title="Cloudflow by Lightbend">
</a>
<a href="https://cloudstate.io" class="cloudstate oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Cloudstate - Logo Tag Line - Akka Banner">
<img class="cloudstate-full-color-logo" src="../images/banner-logos/cloudstate-full-color.svg" alt="Cloudstate by Lightbend" title="Cloudstate by Lightbend">
</a>
<a href="https://www.lagomframework.com" class="lagom oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lagom - Logo Tag Line - Akka Banner">
<img class="lagom-full-color-logo" src="../images/banner-logos/lagom-full-color.svg" alt="Lagom Framework by Lightbend" title="Lagom Framework by Lightbend">
</a>
<a href="https://www.playframework.com" class="play oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Play - Logo Tag Line - Akka Banner">
<img class="play-full-color-logo" src="../images/banner-logos/play-full-color.svg" alt="Play Framework by Lightbend" title="Play Framework by Lightbend">
</a>
<a href="https://www.scala-lang.org" class="scala oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Scala - Logo Tag Line - Akka Banner">
<img class="scala-full-color-logo" src="../images/banner-logos/scala-full-color.svg" alt="Scala by Lightbend" title="Scala by Lightbend">
</a>
<div class="akka current">
<img class="akka-full-color-logo" src="../images/banner-logos/akka-full-color.svg" alt="Akka by Lightbend" title="Akka by Lightbend">
<span>From the creators of <strong>Akka</strong>, get technology enhancements, monitoring, and expert support with Akka Platform from Lightbend.</span>
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Learn More [Button] - Akka Banner" href="https://www.lightbend.com/akka-core-of-lightbend?r=oss-banner-akka" target="_blank">Learn More</a>
</div>
</div>
<div class="title">The Lightbend Family</div>
</div>      
</div>
</div>
</div>
</div>
<header class="site-header hide-for-large">
<div class="sticky-header clearfix">
<a href="https://akka.io"><img class="logo" src="../images/akka-logo-reverse.svg"/></a>

<button class="menu-icon float-right" type="button" data-toggle="underlay overlay"></button>
</div>
<div id="overlay" class="overlay-nav" data-toggler="nav-open">
<header class="nav-header">
<div class="nav-header-title">
<h1><a href="../index.html">Akka Documentation</a></h1>
</div>
<div class="nav-header-version">
Version 2.6.5
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-scala">Scala</option><option class="group" value="group-java">Java</option></select>
</div>
<div id="overlay-search-container" class="nav-header-search">
<input id="overlay-search" type="search" class="search" placeholder="Search" />
</div>
</header>
<nav class="nav-toc">
<ul>
  <li><a href="../security/index.html" class="page">Security Announcements</a></li>
  <li><a href="../typed/guide/index.html" class="page">Getting Started Guide</a></li>
  <li><a href="../general/index.html" class="page">General Concepts</a></li>
  <li><a href="../typed/index.html" class="page">Actors</a></li>
  <li><a href="../typed/index-cluster.html" class="page">Cluster</a>
  <ul>
    <li><a href="../typed/cluster.html" class="page">Cluster Usage</a></li>
    <li><a href="../typed/cluster-concepts.html" class="page">Cluster Specification</a></li>
    <li><a href="../typed/cluster-membership.html" class="page">Cluster Membership Service</a></li>
    <li><a href="../typed/failure-detector.html" class="page">Phi Accrual Failure Detector</a></li>
    <li><a href="../typed/distributed-data.html" class="page">Distributed Data</a></li>
    <li><a href="../typed/cluster-singleton.html" class="page">Cluster Singleton</a></li>
    <li><a href="../typed/cluster-sharding.html" class="page">Cluster Sharding</a></li>
    <li><a href="../typed/cluster-sharding-concepts.html#cluster-sharding-concepts" class="active page">Cluster Sharding concepts</a>
    <ul>
      <li><a href="../typed/cluster-sharding-concepts.html#scenarios" class="header">Scenarios</a></li>
      <li><a href="../typed/cluster-sharding-concepts.html#shard-location" class="header">Shard location</a></li>
      <li><a href="../typed/cluster-sharding-concepts.html#shard-rebalancing" class="header">Shard rebalancing</a></li>
      <li><a href="../typed/cluster-sharding-concepts.html#shardcoordinator-state" class="header">ShardCoordinator state</a></li>
      <li><a href="../typed/cluster-sharding-concepts.html#message-ordering" class="header">Message ordering</a></li>
      <li><a href="../typed/cluster-sharding-concepts.html#reliable-delivery" class="header">Reliable delivery</a></li>
      <li><a href="../typed/cluster-sharding-concepts.html#overhead" class="header">Overhead</a></li>
    </ul></li>
    <li><a href="../typed/cluster-sharded-daemon-process.html" class="page">Sharded Daemon Process</a></li>
    <li><a href="../typed/cluster-dc.html" class="page">Multi-DC Cluster</a></li>
    <li><a href="../typed/distributed-pub-sub.html" class="page">Distributed Publish Subscribe in Cluster</a></li>
    <li><a href="../typed/reliable-delivery.html" class="page">Reliable delivery</a></li>
    <li><a href="../serialization.html" class="page">Serialization</a></li>
    <li><a href="../serialization-jackson.html" class="page">Serialization with Jackson</a></li>
    <li><a href="../multi-jvm-testing.html" class="page">Multi JVM Testing</a></li>
    <li><a href="../multi-node-testing.html" class="page">Multi Node Testing</a></li>
    <li><a href="../remoting-artery.html" class="page">Artery Remoting</a></li>
    <li><a href="../remoting.html" class="page">Classic Remoting (Deprecated)</a></li>
    <li><a href="../coordination.html" class="page">Coordination</a></li>
    <li><a href="../typed/choosing-cluster.html" class="page">Choosing Akka Cluster</a></li>
  </ul></li>
  <li><a href="../typed/index-persistence.html" class="page">Persistence</a></li>
  <li><a href="../stream/index.html" class="page">Streams</a></li>
  <li><a href="../discovery/index.html" class="page">Discovery</a></li>
  <li><a href="../index-utilities.html" class="page">Utilities</a></li>
  <li><a href="../common/other-modules.html" class="page">Other Akka modules</a></li>
  <li><a href="../additional/deploy.html" class="page">Package, Deploy and Run</a></li>
  <li><a href="../project/index.html" class="page">Project Information</a></li>
  <li><a href="../index-classic.html" class="page">Akka Classic</a></li>
</ul>
</nav>
</div>
</header>
<div class="site-content-wrapper">
<aside class="sticky-sidebar show-for-large">
<header class="nav-header sticky-sidebar-header">
<div class="nav-header-title">
<h1><a href="../index.html">Akka Documentation</a></h1>
</div>
<div class="nav-header-version">
Version 2.6.5
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-scala">Scala</option><option class="group" value="group-java">Java</option></select>
</div>
<div class="nav-header-search">
<input id="search" type="search" class="search" placeholder="Search" />
</div>
</header>
<nav class="site-nav sticky-sidebar-contents">
<div class="nav-toc">
<ul>
  <li><a href="../security/index.html" class="page">Security Announcements</a></li>
  <li><a href="../typed/guide/index.html" class="page">Getting Started Guide</a></li>
  <li><a href="../general/index.html" class="page">General Concepts</a></li>
  <li><a href="../typed/index.html" class="page">Actors</a></li>
  <li><a href="../typed/index-cluster.html" class="page">Cluster</a>
  <ul>
    <li><a href="../typed/cluster.html" class="page">Cluster Usage</a></li>
    <li><a href="../typed/cluster-concepts.html" class="page">Cluster Specification</a></li>
    <li><a href="../typed/cluster-membership.html" class="page">Cluster Membership Service</a></li>
    <li><a href="../typed/failure-detector.html" class="page">Phi Accrual Failure Detector</a></li>
    <li><a href="../typed/distributed-data.html" class="page">Distributed Data</a></li>
    <li><a href="../typed/cluster-singleton.html" class="page">Cluster Singleton</a></li>
    <li><a href="../typed/cluster-sharding.html" class="page">Cluster Sharding</a></li>
    <li><a href="../typed/cluster-sharding-concepts.html#cluster-sharding-concepts" class="active page">Cluster Sharding concepts</a>
    <ul>
      <li><a href="../typed/cluster-sharding-concepts.html#scenarios" class="header">Scenarios</a></li>
      <li><a href="../typed/cluster-sharding-concepts.html#shard-location" class="header">Shard location</a></li>
      <li><a href="../typed/cluster-sharding-concepts.html#shard-rebalancing" class="header">Shard rebalancing</a></li>
      <li><a href="../typed/cluster-sharding-concepts.html#shardcoordinator-state" class="header">ShardCoordinator state</a></li>
      <li><a href="../typed/cluster-sharding-concepts.html#message-ordering" class="header">Message ordering</a></li>
      <li><a href="../typed/cluster-sharding-concepts.html#reliable-delivery" class="header">Reliable delivery</a></li>
      <li><a href="../typed/cluster-sharding-concepts.html#overhead" class="header">Overhead</a></li>
    </ul></li>
    <li><a href="../typed/cluster-sharded-daemon-process.html" class="page">Sharded Daemon Process</a></li>
    <li><a href="../typed/cluster-dc.html" class="page">Multi-DC Cluster</a></li>
    <li><a href="../typed/distributed-pub-sub.html" class="page">Distributed Publish Subscribe in Cluster</a></li>
    <li><a href="../typed/reliable-delivery.html" class="page">Reliable delivery</a></li>
    <li><a href="../serialization.html" class="page">Serialization</a></li>
    <li><a href="../serialization-jackson.html" class="page">Serialization with Jackson</a></li>
    <li><a href="../multi-jvm-testing.html" class="page">Multi JVM Testing</a></li>
    <li><a href="../multi-node-testing.html" class="page">Multi Node Testing</a></li>
    <li><a href="../remoting-artery.html" class="page">Artery Remoting</a></li>
    <li><a href="../remoting.html" class="page">Classic Remoting (Deprecated)</a></li>
    <li><a href="../coordination.html" class="page">Coordination</a></li>
    <li><a href="../typed/choosing-cluster.html" class="page">Choosing Akka Cluster</a></li>
  </ul></li>
  <li><a href="../typed/index-persistence.html" class="page">Persistence</a></li>
  <li><a href="../stream/index.html" class="page">Streams</a></li>
  <li><a href="../discovery/index.html" class="page">Discovery</a></li>
  <li><a href="../index-utilities.html" class="page">Utilities</a></li>
  <li><a href="../common/other-modules.html" class="page">Other Akka modules</a></li>
  <li><a href="../additional/deploy.html" class="page">Package, Deploy and Run</a></li>
  <li><a href="../project/index.html" class="page">Project Information</a></li>
  <li><a href="../index-classic.html" class="page">Akka Classic</a></li>
</ul>
</div>
</nav>
<footer class="nav-footer sticky-sidebar-footer">
<a href="https://akka.io"><img class="logo" src="../images/akka-logo-reverse.svg"/></a>

</footer>
</aside>
<main class="fixed-shift-for-large expanded row">
<section class="site-content small-12 column">
<article class="page-content row">
<div class="small-12 column" id="docs">
<h1><a href="#cluster-sharding-concepts" name="cluster-sharding-concepts" class="anchor"><span class="anchor-link"></span></a>Cluster Sharding concepts</h1>
<p>The <code>ShardRegion</code> actor is started on each node in the cluster, or group of nodes tagged with a specific role. The <code>ShardRegion</code> is created with two application specific functions to extract the entity identifier and the shard identifier from incoming messages. A <code>Shard</code> is a group of entities that will be managed together. For the first message in a specific shard the <code>ShardRegion</code> requests the location of the shard from a central coordinator, the <code>ShardCoordinator</code>.</p>
<p>The <code>ShardCoordinator</code> decides which <code>ShardRegion</code> shall own the <code>Shard</code> and informs that <code>ShardRegion</code>. The region will confirm this request and create the <code>Shard</code> supervisor as a child actor. The individual <code>Entities</code> will then be created when needed by the <code>Shard</code> actor. Incoming messages thus travel via the <code>ShardRegion</code> and the <code>Shard</code> to the target <code>Entity</code>.</p>
<p>If the shard home is another <code>ShardRegion</code> instance messages will be forwarded to that <code>ShardRegion</code> instance instead. While resolving the location of a shard incoming messages for that shard are buffered and later delivered when the shard home is known. Subsequent messages to the resolved shard can be delivered to the target destination immediately without involving the <code>ShardCoordinator</code>.</p>
<h3><a href="#scenarios" name="scenarios" class="anchor"><span class="anchor-link"></span></a>Scenarios</h3>
<p>Once a <code>Shard</code> location is known <code>ShardRegion</code>s send messages directly. Here are the scenarios for getting to this state. In the scenarios the following notation is used:</p>
<ul>
  <li><code>SC</code> - ShardCoordinator</li>
  <li><code>M#</code> - Message 1, 2, 3, etc</li>
  <li><code>SR#</code> - ShardRegion 1, 2 3, etc</li>
  <li><code>S#</code> - Shard 1 2 3, etc</li>
  <li><code>E#</code> - Entity 1 2 3, etc. An entity refers to an Actor managed by Cluster Sharding.</li>
</ul>
<p>Where <code>#</code> is a number to distinguish between instances as there are multiple in the Cluster.</p>
<h4><a href="#scenario-1-message-to-an-unknown-shard-that-belongs-to-the-local-shardregion" name="scenario-1-message-to-an-unknown-shard-that-belongs-to-the-local-shardregion" class="anchor"><span class="anchor-link"></span></a>Scenario 1: Message to an unknown shard that belongs to the local ShardRegion</h4>
<ol>
  <li>Incoming message <code>M1</code> to <code>ShardRegion</code> instance <code>SR1</code>.</li>
  <li><code>M1</code> is mapped to shard <code>S1</code>. <code>SR1</code> doesn&rsquo;t know about <code>S1</code>, so it asks the <code>SC</code> for the location of <code>S1</code>.</li>
  <li><code>SC</code> answers that the home of <code>S1</code> is <code>SR1</code>.</li>
  <li><code>SR1</code> creates child actor shard <code>S1</code> and forwards the message to it.</li>
  <li><code>S1</code> creates child actor for <code>E1</code> and forwards the message to it.</li>
  <li>All incoming messages for <code>S1</code> which arrive at <code>SR1</code> can be handled by <code>SR1</code> without <code>SC</code>.</li>
</ol>
<h4><a href="#scenario-2-message-to-an-unknown-shard-that-belongs-to-a-remote-shardregion" name="scenario-2-message-to-an-unknown-shard-that-belongs-to-a-remote-shardregion" class="anchor"><span class="anchor-link"></span></a>Scenario 2: Message to an unknown shard that belongs to a remote ShardRegion</h4>
<ol>
  <li>Incoming message <code>M2</code> to <code>ShardRegion</code> instance <code>SR1</code>.</li>
  <li><code>M2</code> is mapped to <code>S2</code>. <code>SR1</code> doesn&rsquo;t know about <code>S2</code>, so it asks <code>SC</code> for the location of <code>S2</code>.</li>
  <li><code>SC</code> answers that the home of <code>S2</code> is <code>SR2</code>.</li>
  <li><code>SR1</code> sends buffered messages for <code>S2</code> to <code>SR2</code>.</li>
  <li>All incoming messages for <code>S2</code> which arrive at <code>SR1</code> can be handled by <code>SR1</code> without <code>SC</code>. It forwards messages to <code>SR2</code>.</li>
  <li><code>SR2</code> receives message for <code>S2</code>, ask <code>SC</code>, which answers that the home of <code>S2</code> is <code>SR2</code>, and we are in Scenario 1 (but for <code>SR2</code>).</li>
</ol>
<h3><a href="#shard-location" name="shard-location" class="anchor"><span class="anchor-link"></span></a>Shard location</h3>
<p>To make sure that at most one instance of a specific entity actor is running somewhere in the cluster it is important that all nodes have the same view of where the shards are located. Therefore the shard allocation decisions are taken by the central <code>ShardCoordinator</code>, which is running as a cluster singleton, i.e. one instance on the oldest member among all cluster nodes or a group of nodes tagged with a specific role.</p>
<p>The logic that decides where a shard is to be located is defined in a pluggable <a href="cluster-sharding.html#shard-allocation">shard allocation strategy</a>.</p>
<h3><a href="#shard-rebalancing" name="shard-rebalancing" class="anchor"><span class="anchor-link"></span></a>Shard rebalancing</h3>
<p>To be able to use newly added members in the cluster the coordinator facilitates rebalancing of shards, i.e. migrate entities from one node to another. In the rebalance process the coordinator first notifies all <code>ShardRegion</code> actors that a handoff for a shard has started. That means they will start buffering incoming messages for that shard, in the same way as if the shard location is unknown. During the rebalance process the coordinator will not answer any requests for the location of shards that are being rebalanced, i.e. local buffering will continue until the handoff is completed. The <code>ShardRegion</code> responsible for the rebalanced shard will stop all entities in that shard by sending the specified <code>stopMessage</code> (default <code>PoisonPill</code>) to them. When all entities have been terminated the <code>ShardRegion</code> owning the entities will acknowledge the handoff as completed to the coordinator. Thereafter the coordinator will reply to requests for the location of the shard, thereby allocating a new home for the shard, and then buffered messages in the <code>ShardRegion</code> actors are delivered to the new location. This means that the state of the entities are not transferred or migrated. If the state of the entities are of importance it should be persistent (durable), e.g. with <a href="persistence.html">Persistence</a> (or see <a href="../persistence.html">Classic Persistence</a>), so that it can be recovered at the new location.</p>
<p>The logic that decides which shards to rebalance is defined in a pluggable shard allocation strategy. The default implementation <code>ShardCoordinator.LeastShardAllocationStrategy</code> picks shards for handoff from the <code>ShardRegion</code> with most number of previously allocated shards. They will then be allocated to the <code>ShardRegion</code> with least number of previously allocated shards, i.e. new members in the cluster.</p>
<p>For the <code>LeastShardAllocationStrategy</code> there is a configurable threshold (<code>rebalance-threshold</code>) of how large the difference must be to begin the rebalancing. The difference between number of shards in the region with most shards and the region with least shards must be greater than the <code>rebalance-threshold</code> for the rebalance to occur.</p>
<p>A <code>rebalance-threshold</code> of 1 gives the best distribution and therefore typically the best choice. A higher threshold means that more shards can be rebalanced at the same time instead of one-by-one. That has the advantage that the rebalance process can be quicker but has the drawback that the the number of shards (and therefore load) between different nodes may be significantly different.</p>
<h3><a href="#shardcoordinator-state" name="shardcoordinator-state" class="anchor"><span class="anchor-link"></span></a>ShardCoordinator state</h3>
<p>The state of shard locations in the <code>ShardCoordinator</code> is persistent (durable) with <a href="distributed-data.html">Distributed Data</a> (or see <a href="../distributed-data.html">Classic Distributed Data</a>) to survive failures. </p>
<p>When a crashed or unreachable coordinator node has been removed (via down) from the cluster a new <code>ShardCoordinator</code> singleton actor will take over and the state is recovered. During such a failure period shards with a known location are still available, while messages for new (unknown) shards are buffered until the new <code>ShardCoordinator</code> becomes available.</p>
<h3><a href="#message-ordering" name="message-ordering" class="anchor"><span class="anchor-link"></span></a>Message ordering</h3>
<p>As long as a sender uses the same <code>ShardRegion</code> actor to deliver messages to an entity actor the order of the messages is preserved. As long as the buffer limit is not reached messages are delivered on a best effort basis, with at-most once delivery semantics, in the same way as ordinary message sending.</p>
<h3><a href="#reliable-delivery" name="reliable-delivery" class="anchor"><span class="anchor-link"></span></a>Reliable delivery</h3>
<p>Reliable end-to-end messaging, with at-least-once semantics can be added by using the <a href="reliable-delivery.html#sharding">Reliable Delivery</a> feature.</p>
<h3><a href="#overhead" name="overhead" class="anchor"><span class="anchor-link"></span></a>Overhead</h3>
<p>Some additional latency is introduced for messages targeted to new or previously unused shards due to the round-trip to the coordinator. Rebalancing of shards may also add latency. This should be considered when designing the application specific shard resolution, e.g. to avoid too fine grained shards. Once a shard&rsquo;s location is known the only overhead is sending a message via the <code>ShardRegion</code> rather than directly.</p>
</div>
</article>
<div class="row">
<div class="small-12 column">
<section class="nav-prev-next row">
<div class="nav-prev small-6 column">
<a href="../typed/cluster-sharding.html"><i class="icon-prev"></i> <span class="link-prev">Cluster Sharding</span></a>
</div>
<div class="nav-next small-6 column clearfix">
<a class="float-right" href="../typed/cluster-sharded-daemon-process.html">Sharded Daemon Process <i class="icon-next"></i></a>
</div>
</section>
</div>
</div>
<div class="source-github row">
Found an error in this documentation? The source code for this page can be found <a href="https://github.com/akka/akka/tree/v2.6.5/akka-docs/src/main/paradox/typed/cluster-sharding-concepts.md">here</a>.
Please feel free to edit and contribute a pull request.
</div>

<footer class="page-footer row clearfix">
<img class="akka-icon float-left show-for-medium" src="../images/akka-icon.svg" />
<section class="copyright">
<div>Akka is Open Source and available under the Apache 2 License.</div>
<p class="legal">
&copy; 2011-2020 <a href="https://www.lightbend.com" target="_blank">Lightbend, Inc.</a> |
<a href="https://www.lightbend.com/legal/licenses" target="_blank">Licenses</a> |
<a href="https://www.lightbend.com/legal/terms" target="_blank">Terms</a> |
<a href="https://www.lightbend.com/legal/privacy" target="_blank">Privacy Policy</a> |
<a href="https://akka.io/cookie/" target="_blank">Cookie Listing</a> |
<a class="optanon-toggle-display">Cookie Settings</a>
</p>
</section>

</footer>
</section>
</main>
</div>

<script type="text/javascript" src="../js/scrollsneak.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../js/groups.js"></script>
<script type="text/javascript" src="../js/page.js"></script>
<script type="text/javascript" src="../js/magellan.js"></script>
<script type="text/javascript" src="../js/metadata-toggle.js"></script>

<style type="text/css">@import "../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(){window.prettyPrint && prettyPrint()});
//]]></script>
<!-- Algolia docs search -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.js"></script>
<style>.algolia-autocomplete { display: block !important }</style>
<script type="text/javascript">
docsearch({
apiKey: '543bad5ad786495d9ccd445ed34ed082',
indexName: 'akka_io',
inputSelector: '#search',
algoliaOptions: {
hitsPerPage: 5
}
});

docsearch({
apiKey: '543bad5ad786495d9ccd445ed34ed082',
indexName: 'akka_io',
inputSelector: '#overlay-search',
algoliaOptions: {
hitsPerPage: 5
}
});

// set up "/" as global shortcut for focusing on search
jQuery(document).keypress(function (event) {
if (event.keyCode == 47) {
jQuery("#search").focus();
return false; // swallow key event, otherwise the / char would be input into the search box
}
});
</script>

<script type="text/javascript" src="../assets/js/warnOldDocs.js"></script>
<script type="text/javascript" src="../assets/js/scalafiddle.js"></script>


</body>
</html>
