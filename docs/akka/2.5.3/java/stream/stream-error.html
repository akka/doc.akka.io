<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Error Handling &bull; Akka Documentation</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="Akka is a toolkit for building highly concurrent, distributed, and resilient message-driven applications for Java and Scala."/>
<link rel="canonical" href="https://doc.akka.io/docs/akka/current/stream/stream-error.html"/>
<script type="text/javascript" src="../../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../../lib/foundation/dist/js/foundation.min.js"></script>
<link rel="stylesheet" type="text/css" href="../../lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="../../lib/foundation/dist/css/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" type="text/css" href="../../css/icons.css"/>
<link rel="stylesheet" type="text/css" href="../../css/page.css"/>
<link rel="shortcut icon" href="../../images/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="../../images/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../images/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../../images/favicon-16x16.png">
<link rel="manifest" href="../../images/manifest.json">
<meta name="msapplication-TileImage" content="../../images/mstile-150x150.png">
<meta name="msapplication-TileColor" content="#15a9ce">
<meta name="theme-color" content="#15a9ce">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!--Google Analytics-->
<script type="text/javascript">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-21117439-1']);
_gaq.push(['_setDomainName', 'akka.io']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})()
</script>
<!--Google Analytics & Marketo-->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-23127719-1', 'lightbend.com', {'allowLinker': true, 'name': 'tsTracker'});
ga('tsTracker.require', 'linker');
ga('tsTracker.linker:autoLink', ['lightbend.com','playframework.com','scala-lang.org','scaladays.org','spray.io','akka.io','scala-sbt.org','scala-ide.org']);
ga('tsTracker.send', 'pageview');
(function() {
var didInit = false;
function initMunchkin() {
if(didInit === false) {
didInit = true;
Munchkin.init('558-NCX-702');
}
}
var s = document.createElement('script');
s.type = 'text/javascript';
s.async = true;
s.src = '//munchkin.marketo.net/munchkin.js';
s.onreadystatechange = function() {
if (this.readyState == 'complete' || this.readyState == 'loaded') {
initMunchkin();
}
};
s.onload = initMunchkin;
document.getElementsByTagName('head')[0].appendChild(s);
})();
</script>

</head>

<body id="underlay" data-toggler="nav-open">

<header class="site-header hide-for-large">
<div class="sticky-header clearfix">
<a href="https://akka.io"><img class="logo" src="../../images/akka-logo-reverse.svg"></a>

<button class="menu-icon float-right" type="button" data-toggle="underlay overlay"></button>
</div>
<div id="overlay" class="overlay-nav" data-toggler="nav-open">
<header class="nav-header">
<div class="nav-header-title">
<h1><a href="../../java/index.html">Akka Documentation</a></h1>
</div>
<div class="nav-header-version">
Version 2.5.3
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Languages"><option class="group" value="group-scala">Scala</option><option class="group" value="group-java">Java</option></select>
</div>
<div id="overlay-search-container" class="nav-header-search">
<input id="overlay-search" type="search" class="search" placeholder="Search"/>
</div>
</header>
<nav class="nav-toc">
<ul>
  <li><a href="../../java/security/index.html" class="page">Security Announcements</a></li>
  <li><a href="../../java/guide/index.html" class="page">Getting Started Guide</a></li>
  <li><a href="../../java/general/index.html" class="page">General Concepts</a></li>
  <li><a href="../../java/index-actors.html" class="page">Actors</a></li>
  <li><a href="../../java/index-network.html" class="page">Networking</a></li>
  <li><a href="../../java/stream/index.html" class="page">Streams</a>
  <ul>
    <li><a href="../../java/stream/stream-introduction.html" class="page">Introduction</a></li>
    <li><a href="../../java/stream/stream-quickstart.html" class="page">Quick Start Guide</a></li>
    <li><a href="../../java/general/stream/stream-design.html" class="page">Design Principles behind Akka Streams</a></li>
    <li><a href="../../java/stream/stream-flows-and-basics.html" class="page">Basics and working with Flows</a></li>
    <li><a href="../../java/stream/stream-graphs.html" class="page">Working with Graphs</a></li>
    <li><a href="../../java/stream/stream-composition.html" class="page">Modularity, Composition and Hierarchy</a></li>
    <li><a href="../../java/stream/stream-rate.html" class="page">Buffers and working with rate</a></li>
    <li><a href="../../java/stream/stream-dynamic.html" class="page">Dynamic stream handling</a></li>
    <li><a href="../../java/stream/stream-customize.html" class="page">Custom stream processing</a></li>
    <li><a href="../../java/stream/stream-integrations.html" class="page">Integration</a></li>
    <li><a href="../../java/stream/stream-error.html#error-handling" class="active page">Error Handling</a>
    <ul>
      <li><a href="../../java/stream/stream-error.html#supervision-strategies" class="header">Supervision Strategies</a></li>
      <li><a href="../../java/stream/stream-error.html#errors-from-mapasync" class="header">Errors from mapAsync</a></li>
    </ul></li>
    <li><a href="../../java/stream/stream-io.html" class="page">Working with streaming IO</a></li>
    <li><a href="../../java/stream/stream-parallelism.html" class="page">Pipelining and Parallelism</a></li>
    <li><a href="../../java/stream/stream-testkit.html" class="page">Testing streams</a></li>
    <li><a href="../../java/stream/stages-overview.html" class="page">Overview of built-in stages and their semantics</a></li>
    <li><a href="../../java/stream/stream-cookbook.html" class="page">Streams Cookbook</a></li>
    <li><a href="../../java/general/stream/stream-configuration.html" class="page">Configuration</a></li>
  </ul></li>
  <li><a href="../../java/index-futures.html" class="page">Futures and Agents</a></li>
  <li><a href="../../java/index-utilities.html" class="page">Utilities</a></li>
  <li><a href="../../java/common/other-modules.html" class="page">Other Akka modules</a></li>
  <li><a href="../../java/howto.html" class="page">HowTo: Common Patterns</a></li>
  <li><a href="../../java/scala-compat.html" class="page">Java 8 and Scala Compatibility</a></li>
  <li><a href="../../java/project/index.html" class="page">Project Information</a></li>
  <li><a href="../../java/additional/index.html" class="page">Additional Information</a></li>
</ul>
</nav>
</div>
</header>

<aside class="show-for-large">
<header class="nav-header fixed-sidebar-header">
<div class="nav-header-title">
<h1><a href="../../java/index.html">Akka Documentation</a></h1>
</div>
<div class="nav-header-version">
Version 2.5.3
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Languages"><option class="group" value="group-scala">Scala</option><option class="group" value="group-java">Java</option></select>
</div>
<div class="nav-header-search">
<input id="search" type="search" class="search" placeholder="Search"/>
</div>
</header>
<nav class="site-nav fixed-sidebar-contents">
<div class="nav-toc">
<ul>
  <li><a href="../../java/security/index.html" class="page">Security Announcements</a></li>
  <li><a href="../../java/guide/index.html" class="page">Getting Started Guide</a></li>
  <li><a href="../../java/general/index.html" class="page">General Concepts</a></li>
  <li><a href="../../java/index-actors.html" class="page">Actors</a></li>
  <li><a href="../../java/index-network.html" class="page">Networking</a></li>
  <li><a href="../../java/stream/index.html" class="page">Streams</a>
  <ul>
    <li><a href="../../java/stream/stream-introduction.html" class="page">Introduction</a></li>
    <li><a href="../../java/stream/stream-quickstart.html" class="page">Quick Start Guide</a></li>
    <li><a href="../../java/general/stream/stream-design.html" class="page">Design Principles behind Akka Streams</a></li>
    <li><a href="../../java/stream/stream-flows-and-basics.html" class="page">Basics and working with Flows</a></li>
    <li><a href="../../java/stream/stream-graphs.html" class="page">Working with Graphs</a></li>
    <li><a href="../../java/stream/stream-composition.html" class="page">Modularity, Composition and Hierarchy</a></li>
    <li><a href="../../java/stream/stream-rate.html" class="page">Buffers and working with rate</a></li>
    <li><a href="../../java/stream/stream-dynamic.html" class="page">Dynamic stream handling</a></li>
    <li><a href="../../java/stream/stream-customize.html" class="page">Custom stream processing</a></li>
    <li><a href="../../java/stream/stream-integrations.html" class="page">Integration</a></li>
    <li><a href="../../java/stream/stream-error.html#error-handling" class="active page">Error Handling</a>
    <ul>
      <li><a href="../../java/stream/stream-error.html#supervision-strategies" class="header">Supervision Strategies</a></li>
      <li><a href="../../java/stream/stream-error.html#errors-from-mapasync" class="header">Errors from mapAsync</a></li>
    </ul></li>
    <li><a href="../../java/stream/stream-io.html" class="page">Working with streaming IO</a></li>
    <li><a href="../../java/stream/stream-parallelism.html" class="page">Pipelining and Parallelism</a></li>
    <li><a href="../../java/stream/stream-testkit.html" class="page">Testing streams</a></li>
    <li><a href="../../java/stream/stages-overview.html" class="page">Overview of built-in stages and their semantics</a></li>
    <li><a href="../../java/stream/stream-cookbook.html" class="page">Streams Cookbook</a></li>
    <li><a href="../../java/general/stream/stream-configuration.html" class="page">Configuration</a></li>
  </ul></li>
  <li><a href="../../java/index-futures.html" class="page">Futures and Agents</a></li>
  <li><a href="../../java/index-utilities.html" class="page">Utilities</a></li>
  <li><a href="../../java/common/other-modules.html" class="page">Other Akka modules</a></li>
  <li><a href="../../java/howto.html" class="page">HowTo: Common Patterns</a></li>
  <li><a href="../../java/scala-compat.html" class="page">Java 8 and Scala Compatibility</a></li>
  <li><a href="../../java/project/index.html" class="page">Project Information</a></li>
  <li><a href="../../java/additional/index.html" class="page">Additional Information</a></li>
</ul>
</div>
</nav>
<footer class="nav-footer fixed-sidebar-footer">
<a href="https://akka.io"><img class="logo" src="../../images/akka-logo-reverse.svg"></a>

</footer>
</aside>

<main class="fixed-shift-for-large expanded row">
<section class="site-content small-12 column">

<article class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h1><a href="#error-handling" name="error-handling" class="anchor"><span class="anchor-link"></span></a>Error Handling</h1>
<p>Strategies for how to handle exceptions from processing stream elements can be defined when materializing the stream. The error handling strategies are inspired by actor supervision strategies, but the semantics have been adapted to the domain of stream processing.</p><div class="callout warning "><div class="callout-title">Warning</div>
<p><em>ZipWith</em>, <em>GraphStage</em> junction, <em>ActorPublisher</em> source and <em>ActorSubscriber</em> sink components do not honour the supervision strategy attribute yet.</p></div>
<h2><a href="#supervision-strategies" name="supervision-strategies" class="anchor"><span class="anchor-link"></span></a>Supervision Strategies</h2>
<p>There are three ways to handle exceptions from application code:</p>
<ul>
  <li><code>Stop</code> - The stream is completed with failure.</li>
  <li><code>Resume</code> - The element is dropped and the stream continues.</li>
  <li><code>Restart</code> - The element is dropped and the stream continues after restarting the stage. Restarting a stage means that any accumulated state is cleared. This is typically performed by creating a new instance of the stage.</li>
</ul>
<p>By default the stopping strategy is used for all exceptions, i.e. the stream will be completed with failure when an exception is thrown.</p>
<pre class="prettyprint"><code class="language-java">final Materializer mat = ActorMaterializer.create(system);
final Source&lt;Integer, NotUsed&gt; source = Source.from(Arrays.asList(0, 1, 2, 3, 4, 5))
  .map(elem -&gt; 100 / elem);
final Sink&lt;Integer, CompletionStage&lt;Integer&gt;&gt; fold =
  Sink.&lt;Integer, Integer&gt; fold(0, (acc, elem) -&gt; acc + elem);
final CompletionStage&lt;Integer&gt; result = source.runWith(fold, mat);
// division by zero will fail the stream and the
// result here will be a Future completed with Failure(ArithmeticException)</code></pre>
<p>The default supervision strategy for a stream can be defined on the settings of the materializer.</p>
<pre class="prettyprint"><code class="language-java">final Function&lt;Throwable, Supervision.Directive&gt; decider = exc -&gt; {
  if (exc instanceof ArithmeticException)
    return Supervision.resume();
  else
    return Supervision.stop();
};
final Materializer mat = ActorMaterializer.create(
  ActorMaterializerSettings.create(system).withSupervisionStrategy(decider),
  system);
final Source&lt;Integer, NotUsed&gt; source = Source.from(Arrays.asList(0, 1, 2, 3, 4, 5))
  .map(elem -&gt; 100 / elem);
final Sink&lt;Integer, CompletionStage&lt;Integer&gt;&gt; fold =
  Sink.fold(0, (acc, elem) -&gt; acc + elem);
final CompletionStage&lt;Integer&gt; result = source.runWith(fold, mat);
// the element causing division by zero will be dropped
// result here will be a Future completed with Success(228)</code></pre>
<p>Here you can see that all <code>ArithmeticException</code> will resume the processing, i.e. the elements that cause the division by zero are effectively dropped.</p><div class="callout note "><div class="callout-title">Note</div>
<p>Be aware that dropping elements may result in deadlocks in graphs with cycles, as explained in <a href="stream-graphs.html#graph-cycles">Graph cycles, liveness and deadlocks</a>.</p></div>
<p>The supervision strategy can also be defined for all operators of a flow.</p>
<pre class="prettyprint"><code class="language-java">final Materializer mat = ActorMaterializer.create(system);
final Function&lt;Throwable, Supervision.Directive&gt; decider = exc -&gt; {
  if (exc instanceof ArithmeticException)
    return Supervision.resume();
  else
    return Supervision.stop();
};
final Flow&lt;Integer, Integer, NotUsed&gt; flow =
    Flow.of(Integer.class).filter(elem -&gt; 100 / elem &lt; 50).map(elem -&gt; 100 / (5 - elem))
    .withAttributes(ActorAttributes.withSupervisionStrategy(decider));
final Source&lt;Integer, NotUsed&gt; source = Source.from(Arrays.asList(0, 1, 2, 3, 4, 5))
  .via(flow); 
final Sink&lt;Integer, CompletionStage&lt;Integer&gt;&gt; fold =
  Sink.&lt;Integer, Integer&gt; fold(0, (acc, elem) -&gt; acc + elem);
final CompletionStage&lt;Integer&gt; result = source.runWith(fold, mat);
// the elements causing division by zero will be dropped
// result here will be a Future completed with Success(150)</code></pre>
<p><code>Restart</code> works in a similar way as <code>Resume</code> with the addition that accumulated state, if any, of the failing processing stage will be reset.</p>
<pre class="prettyprint"><code class="language-java">final Materializer mat = ActorMaterializer.create(system);
final Function&lt;Throwable, Supervision.Directive&gt; decider = exc -&gt; {
  if (exc instanceof IllegalArgumentException)
    return Supervision.restart();
  else
    return Supervision.stop();
};
final Flow&lt;Integer, Integer, NotUsed&gt; flow =
  Flow.of(Integer.class).scan(0, (acc, elem) -&gt; {
    if (elem &lt; 0) throw new IllegalArgumentException(&quot;negative not allowed&quot;);
    else return acc + elem;
  })
  .withAttributes(ActorAttributes.withSupervisionStrategy(decider));
final Source&lt;Integer, NotUsed&gt; source = Source.from(Arrays.asList(1, 3, -1, 5, 7))
  .via(flow);
final CompletionStage&lt;List&lt;Integer&gt;&gt; result = source.grouped(1000)
  .runWith(Sink.&lt;List&lt;Integer&gt;&gt;head(), mat);
// the negative element cause the scan stage to be restarted,
// i.e. start from 0 again
// result here will be a Future completed with Success(List(0, 1, 4, 0, 5, 12))</code></pre>
<h2><a href="#errors-from-mapasync" name="errors-from-mapasync" class="anchor"><span class="anchor-link"></span></a>Errors from mapAsync</h2>
<p>Stream supervision can also be applied to the futures of <code>mapAsync</code>.</p>
<p>Let&rsquo;s say that we use an external service to lookup email addresses and we would like to discard those that cannot be found.</p>
<p>We start with the tweet stream of authors:</p>
<pre class="prettyprint"><code class="language-java">final Source&lt;Author, NotUsed&gt; authors = tweets
  .filter(t -&gt; t.hashtags().contains(AKKA))
  .map(t -&gt; t.author);
</code></pre>
<p>Assume that we can lookup their email address using:</p>
<pre class="prettyprint"><code class="language-java">public CompletionStage&lt;String&gt; lookupEmail(String handle)</code></pre>
<p>The <code>CompletionStage</code> is completed normally if the email is not found.</p>
<p>Transforming the stream of authors to a stream of email addresses by using the <code>lookupEmail</code> service can be done with <code>mapAsync</code> and we use <code>Supervision.getResumingDecider</code> to drop unknown email addresses:</p>
<pre class="prettyprint"><code class="language-java">final Attributes resumeAttrib =
  ActorAttributes.withSupervisionStrategy(Supervision.getResumingDecider());
final Flow&lt;Author, String, NotUsed&gt; lookupEmail =
    Flow.of(Author.class)
    .mapAsync(4, author -&gt; addressSystem.lookupEmail(author.handle))
    .withAttributes(resumeAttrib);
final Source&lt;String, NotUsed&gt; emailAddresses = authors.via(lookupEmail);
</code></pre>
<p>If we would not use <code>Resume</code> the default stopping strategy would complete the stream with failure on the first <code>CompletionStage</code> that was completed exceptionally.</p>
</div>
</article>

<div class="row">
<div class="small-12 large-9 column">
<section class="nav-prev-next row">
<div class="nav-prev small-6 column">
<a href="../../java/stream/stream-integrations.html"><i class="icon-prev"></i> <span class="link-prev">Integration</span></a>
</div>
<div class="nav-next small-6 column clearfix">
<a class="float-right" href="../../java/stream/stream-io.html">Working with streaming IO <i class="icon-next"></i></a>
</div>
</section>
</div>
</div>

<div class="source-github row">
The source code for this page can be found <a href="https://github.com/akka/akka/tree/master/akka-docs/src/main/paradox/java/stream/stream-error.md">here</a>.
</div>


<footer class="page-footer row clearfix">
<img class="akka-icon float-left show-for-medium" src="../../images/akka-icon.svg">
<section class="copyright">
<div>&copy; 2011-2017 <a href="https://www.lightbend.com">Lightbend</a></div>
<div>Akka is Open Source and available under the Apache 2 License.</div>
</section>
</footer>

</section>
</main>

<script type="text/javascript" src="../../js/scrollsneak.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../../js/groups.js"></script>
<script type="text/javascript" src="../../js/page.js"></script>
<script type="text/javascript" src="../../js/magellan.js"></script>

<style type="text/css">@import "../../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">jQuery(function(){window.prettyPrint && prettyPrint()});</script>

<!-- Algolia docs search -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.js"></script>
<style>.algolia-autocomplete { display: block !important }</style>
<script type="text/javascript">
var lang = "scala";
var path = window.location.pathname;
if (path.includes("/java/") || path.includes("java.html")) {
lang = "java";
}

docsearch({
apiKey: '543bad5ad786495d9ccd445ed34ed082',
indexName: 'akka_io',
inputSelector: '#search',
algoliaOptions: {
hitsPerPage: 5,
facetFilters: ["language:" + lang]
}
});

docsearch({
apiKey: '543bad5ad786495d9ccd445ed34ed082',
indexName: 'akka_io',
inputSelector: '#overlay-search',
algoliaOptions: {
hitsPerPage: 5,
facetFilters: ["language:" + lang]
}
});

// set up "/" as global shortcut for focusing on search
jQuery(document).keypress(function (event) {
if (event.keyCode == 47) {
jQuery("#search").focus();
return false; // swallow key event, otherwise the / char would be input into the search box
}
});
</script>


</body>
</html>
