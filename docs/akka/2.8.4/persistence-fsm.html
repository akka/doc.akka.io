<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Classic Persistent FSM &bull; Akka Documentation</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="Akka is a toolkit for building highly concurrent, distributed, and resilient message-driven applications for Java and Scala."/>
<link rel="canonical" href="https://doc.akka.io/docs/akka/current/persistence-fsm.html"/>
<script type="text/javascript" src="lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="lib/foundation/dist/js/foundation.min.js"></script>
<link rel="stylesheet" type="text/css" href="lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="lib/foundation/dist/css/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" type="text/css" href="css/icons.css"/>
<link rel="stylesheet" type="text/css" href="css/page-8.css"/>
<link rel="stylesheet" type="text/css" href="css/banner-2.css"/>
<link rel="shortcut icon" href="images/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png"/>
<link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png"/>
<link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png"/>
<link rel="manifest" href="images/manifest.json"/>
<meta name="msapplication-TileImage" content="images/mstile-150x150.png"/>
<meta name="msapplication-TileColor" content="#15a9ce"/>
<meta name="theme-color" content="#15a9ce"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) start -->
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js"  type="text/javascript" charset="UTF-8" data-domain-script="28b912e7-09e9-43d5-91e4-3d1897044004" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) end -->
<!--Google Analytics NOTE this will stop processing data July 1st 2023. At which point this embed code can be removed-->
<script type="text/plain" class="optanon-category-2">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-21117439-1']);
_gaq.push(['_setDomainName', 'akka.io']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})()
</script>

<!-- Google Tag Manager: Updated May 17th 2023 - Cookie Compliance checks have been moved into Google Tag Manager -->
<script type="text/javascript">
(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KBJGH35');
</script>

</head>

<body id="underlay" data-toggler="nav-open">
<div id="lightbend-banner" class="lightbend-banner akka full-width" data-category="OSS Lightbend Banner Impression" data-label="Akka Banner Impression">
<div class="oss-wrapper">
<div class="oss-brand">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lightbend Logo - Akka Banner" href="https://www.lightbend.com">
<img class="lightbend-logo" src="images/banner-logos/lightbend-reverse.svg" alt="Lightbend" title="Lightbend">
</a>
</div>
<div class="oss-ad no-drop-down">
<nav id="lightbendRotator" class="lightbend-rotator">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Promo Rotator - Lightbend Changed its Software Licensing Model for Akka Technology. [License FAQ] - Akka Banner" href="https://www.lightbend.com/akka/license-faq">
<strong>Lightbend</strong> Changed its Software Licensing Model for Akka Technology. <span class="akka-btn">License FAQ</span>
</a>
</nav>
</div>
</div>
</div>

<header class="site-header hide-for-large">
<div class="sticky-header clearfix">
<a href="https://akka.io"><img class="logo" src="images/akka-logo-reverse.svg"/></a>

<button class="menu-icon float-right" type="button" data-toggle="underlay overlay"></button>
</div>
<div id="overlay" class="overlay-nav" data-toggler="nav-open">
<header class="nav-header">
<div class="nav-header-title">
<h1><a href="index.html">Akka Documentation</a></h1>
</div>
<div class="nav-header-version">
Version 2.8.4
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-scala">Scala</option><option class="group" value="group-java">Java</option></select>
</div>
<div id="overlay-search-container" class="nav-header-search">
<input id="overlay-search" type="search" class="search" placeholder="Search" />
</div>
</header>
<nav class="nav-toc">
<ul>
  <li><a href="security/index.html" class="page">Security Announcements</a></li>
  <li><a href="typed/guide/index.html" class="page">Getting Started Guide</a></li>
  <li><a href="general/index.html" class="page">General Concepts</a></li>
  <li><a href="typed/index.html" class="page">Actors</a></li>
  <li><a href="typed/index-cluster.html" class="page">Cluster</a></li>
  <li><a href="typed/index-persistence.html" class="page">Persistence (Event Sourcing)</a></li>
  <li><a href="typed/index-persistence-durable-state.html" class="page">Persistence (Durable State)</a></li>
  <li><a href="stream/index.html" class="page">Streams</a></li>
  <li><a href="discovery/index.html" class="page">Discovery</a></li>
  <li><a href="index-utilities.html" class="page">Utilities</a></li>
  <li><a href="common/other-modules.html" class="page">Other Akka modules</a></li>
  <li><a href="additional/deploy.html" class="page">Package, Deploy and Run</a></li>
  <li><a href="project/index.html" class="page">Project Information</a></li>
  <li><a href="index-classic.html" class="page">Akka Classic</a>
  <ul>
    <li><a href="index-actors.html" class="page">Classic Actors</a>
    <ul>
      <li><a href="index-actors.html#dependency" class="header">Dependency</a></li>
      <li><a href="actors.html" class="page">Classic Actors</a></li>
      <li><a href="supervision-classic.html" class="page">Classic Supervision</a></li>
      <li><a href="fault-tolerance.html" class="page">Classic Fault Tolerance</a></li>
      <li><a href="dispatchers.html" class="page">Classic Dispatchers</a></li>
      <li><a href="mailboxes.html" class="page">Classic Mailboxes</a></li>
      <li><a href="routing.html" class="page">Classic Routing</a></li>
      <li><a href="fsm.html" class="page">Classic FSM</a></li>
      <li><a href="persistence.html" class="page">Classic Persistence</a></li>
      <li><a href="persistence-fsm.html#classic-persistent-fsm" class="active page">Classic Persistent FSM</a>
      <ul>
        <li><a href="persistence-fsm.html#dependency" class="header">Dependency</a></li>
        <li><a href="persistence-fsm.html#migration-to-eventsourcedbehavior" class="header">Migration to EventSourcedBehavior</a></li>
      </ul></li>
      <li><a href="testing.html" class="page">Testing Classic Actors</a></li>
    </ul></li>
    <li><a href="index-cluster.html" class="page">Classic Clustering</a></li>
    <li><a href="index-network.html" class="page">Classic Networking</a></li>
    <li><a href="index-utilities-classic.html" class="page">Classic Utilities</a></li>
  </ul></li>
</ul>
</nav>
</div>
</header>
<div class="site-content-wrapper">
<aside class="sticky-sidebar show-for-large">
<header class="nav-header sticky-sidebar-header">
<div class="nav-header-title">
<h1><a href="index.html">Akka Documentation</a></h1>
</div>
<div class="nav-header-version">
Version 2.8.4
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-scala">Scala</option><option class="group" value="group-java">Java</option></select>
</div>
<div class="nav-header-search">
<input id="search" type="search" class="search" placeholder="Search" />
</div>
</header>
<nav class="site-nav sticky-sidebar-contents">
<div class="nav-toc">
<ul>
  <li><a href="security/index.html" class="page">Security Announcements</a></li>
  <li><a href="typed/guide/index.html" class="page">Getting Started Guide</a></li>
  <li><a href="general/index.html" class="page">General Concepts</a></li>
  <li><a href="typed/index.html" class="page">Actors</a></li>
  <li><a href="typed/index-cluster.html" class="page">Cluster</a></li>
  <li><a href="typed/index-persistence.html" class="page">Persistence (Event Sourcing)</a></li>
  <li><a href="typed/index-persistence-durable-state.html" class="page">Persistence (Durable State)</a></li>
  <li><a href="stream/index.html" class="page">Streams</a></li>
  <li><a href="discovery/index.html" class="page">Discovery</a></li>
  <li><a href="index-utilities.html" class="page">Utilities</a></li>
  <li><a href="common/other-modules.html" class="page">Other Akka modules</a></li>
  <li><a href="additional/deploy.html" class="page">Package, Deploy and Run</a></li>
  <li><a href="project/index.html" class="page">Project Information</a></li>
  <li><a href="index-classic.html" class="page">Akka Classic</a>
  <ul>
    <li><a href="index-actors.html" class="page">Classic Actors</a>
    <ul>
      <li><a href="index-actors.html#dependency" class="header">Dependency</a></li>
      <li><a href="actors.html" class="page">Classic Actors</a></li>
      <li><a href="supervision-classic.html" class="page">Classic Supervision</a></li>
      <li><a href="fault-tolerance.html" class="page">Classic Fault Tolerance</a></li>
      <li><a href="dispatchers.html" class="page">Classic Dispatchers</a></li>
      <li><a href="mailboxes.html" class="page">Classic Mailboxes</a></li>
      <li><a href="routing.html" class="page">Classic Routing</a></li>
      <li><a href="fsm.html" class="page">Classic FSM</a></li>
      <li><a href="persistence.html" class="page">Classic Persistence</a></li>
      <li><a href="persistence-fsm.html#classic-persistent-fsm" class="active page">Classic Persistent FSM</a>
      <ul>
        <li><a href="persistence-fsm.html#dependency" class="header">Dependency</a></li>
        <li><a href="persistence-fsm.html#migration-to-eventsourcedbehavior" class="header">Migration to EventSourcedBehavior</a></li>
      </ul></li>
      <li><a href="testing.html" class="page">Testing Classic Actors</a></li>
    </ul></li>
    <li><a href="index-cluster.html" class="page">Classic Clustering</a></li>
    <li><a href="index-network.html" class="page">Classic Networking</a></li>
    <li><a href="index-utilities-classic.html" class="page">Classic Utilities</a></li>
  </ul></li>
</ul>
</div>
</nav>
<footer class="nav-footer sticky-sidebar-footer">
<a href="https://akka.io"><img class="logo" src="images/akka-logo-reverse.svg"/></a>

</footer>
</aside>
<main class="fixed-shift-for-large expanded row">
<section class="site-content small-12 column">
<article class="page-content row">
<div class="small-12 column" id="docs">
<h1><a href="#classic-persistent-fsm" name="classic-persistent-fsm" class="anchor"><span class="anchor-link"></span></a>Classic Persistent FSM</h1><div class="callout note "><div class="callout-title">Note</div>
<p>Akka Classic pertains to the original Actor APIs, which have been improved by more type safe and guided Actor APIs. Akka Classic is still fully supported and existing applications can continue to use the classic APIs. It is also possible to use the new Actor APIs together with classic actors in the same ActorSystem, see <a href="typed/coexisting.html">coexistence</a>. For new projects we recommend using <a href="typed/actors.html">the new Actor API</a>.</p></div>
<h2><a href="#dependency" name="dependency" class="anchor"><span class="anchor-link"></span></a>Dependency</h2>
<p>The Akka dependencies are available from Akka&rsquo;s library repository. To access them there, you need to configure the URL for this repository.</p><dl class="repository"><dt>sbt</dt><dd><pre class="prettyprint"><code class="language-scala">resolvers += "Akka library repository".at("https://repo.akka.io/maven")
</code></pre></dd><dt>Maven</dt><dd><pre class="prettyprint"><code class="language-xml">&lt;project&gt
  ...
  &lt;repositories&gt;
    &lt;repository&gt;
      &lt;id&gt;akka-repository&lt;/id&gt;
      &lt;name>Akka library repository&lt;/name&gt;
      &lt;url>https://repo.akka.io/maven&lt;/url&gt;
    &lt;/repository&gt;
  &lt;/repositories&gt
&lt;/project&gt;
</code></pre></dd><dt>Gradle</dt><dd><pre class="prettyprint"><code class="language-gradle">repositories {
    mavenCentral()
    maven {
        url "https://repo.akka.io/maven"
    }
}
</code></pre></dd></dl>
<p>Persistent FSMs are part of Akka persistence, you must add the following dependency in your project:</p><dl class="dependency"><dt>sbt</dt><dd><pre class="prettyprint"><code class="language-scala">val AkkaVersion = "2.8.4"
libraryDependencies += "com.typesafe.akka" %% "akka-persistence" % AkkaVersion</code></pre></dd><dt>Maven</dt><dd><pre class="prettyprint"><code class="language-xml">&lt;properties&gt;
  &lt;scala.binary.version&gt;2.13&lt;/scala.binary.version&gt;
&lt;/properties&gt;
&lt;dependencyManagement&gt;
  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;com.typesafe.akka&lt;/groupId&gt;
      &lt;artifactId&gt;akka-bom_${scala.binary.version}&lt;/artifactId&gt;
      &lt;version&gt;2.8.4&lt;/version&gt;
      &lt;type&gt;pom&lt;/type&gt;
      &lt;scope&gt;import&lt;/scope&gt;
    &lt;/dependency&gt
  &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;
&lt;dependencies&gt
  &lt;dependency&gt;
    &lt;groupId&gt;com.typesafe.akka&lt;/groupId&gt;
    &lt;artifactId&gt;akka-persistence_${scala.binary.version}&lt;/artifactId&gt;
  &lt;/dependency&gt
&lt;/dependencies&gt;</code></pre></dd><dt>Gradle</dt><dd><pre class="prettyprint"><code class="language-gradle">def versions = [
  ScalaBinary: "2.13"
]
dependencies {
  implementation platform("com.typesafe.akka:akka-bom_${versions.ScalaBinary}:2.8.4")

  implementation "com.typesafe.akka:akka-persistence_${versions.ScalaBinary}"
}</code></pre></dd></dl><div class="callout warning "><div class="callout-title">Warning</div>
<p>Persistent FSM is no longer actively developed and will be replaced by <a href="typed/persistence.html">Akka Persistence Typed</a>. It is not advised to build new applications with Persistent FSM. Existing users of Persistent FSM <a href="persistence-fsm.html#migration-to-eventsourcedbehavior">should migrate</a>. </p></div>
<p><span class="group-scala"><code>PersistentFSM</code></span><span class="group-java"><code>AbstractPersistentFSM</code></span> handles the incoming messages in an FSM like fashion. Its internal state is persisted as a sequence of changes, later referred to as domain events. Relationship between incoming messages, FSM&rsquo;s states and transitions, persistence of domain events is defined by a DSL.</p>
<h3><a href="#a-simple-example" name="a-simple-example" class="anchor"><span class="anchor-link"></span></a>A Simple Example</h3>
<p>To demonstrate the features of the <span class="group-scala"><code>PersistentFSM</code> trait</span><span class="group-java"><code>AbstractPersistentFSM</code></span>, consider an actor which represents a Web store customer. The contract of our &ldquo;WebStoreCustomerFSMActor&rdquo; is that it accepts the following commands:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.8.4/akka-persistence/src/test/scala/akka/persistence/fsm/PersistentFSMSpec.scala#L437-L441" target="_blank" title="Go to snippet source">source</a><code class="language-scala">sealed trait Command
case class AddItem(item: Item) extends Command
case object Buy extends Command
case object Leave extends Command
case object GetCurrentCart extends Command</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.8.4/akka-persistence/src/test/java/akka/persistence/fsm/AbstractPersistentFSMTest.java#L113-L135" target="_blank" title="Go to snippet source">source</a><code class="language-java">public static final class AddItem implements Command {
  private final Item item;

  public AddItem(Item item) {
    this.item = item;
  }

  public Item getItem() {
    return item;
  }
}

public enum Buy implements Command {
  INSTANCE
}

public enum Leave implements Command {
  INSTANCE
}

public enum GetCurrentCart implements Command {
  INSTANCE
}</code></pre></dd>
</dl>
<p><code>AddItem</code> sent when the customer adds an item to a shopping cart <code>Buy</code> - when the customer finishes the purchase <code>Leave</code> - when the customer leaves the store without purchasing anything <code>GetCurrentCart</code> allows to query the current state of customer&rsquo;s shopping cart</p>
<p>The customer can be in one of the following states:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.8.4/akka-persistence/src/test/scala/akka/persistence/fsm/PersistentFSMSpec.scala#L404-L416" target="_blank" title="Go to snippet source">source</a><code class="language-scala">sealed trait UserState extends FSMState
case object LookingAround extends UserState {
  override def identifier: String = &quot;Looking Around&quot;
}
case object Shopping extends UserState {
  override def identifier: String = &quot;Shopping&quot;
}
case object Inactive extends UserState {
  override def identifier: String = &quot;Inactive&quot;
}
case object Paid extends UserState {
  override def identifier: String = &quot;Paid&quot;
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.8.4/akka-persistence/src/test/java/akka/persistence/fsm/AbstractPersistentFSMTest.java#L27-L43" target="_blank" title="Go to snippet source">source</a><code class="language-java">enum UserState implements PersistentFSM.FSMState {
  LOOKING_AROUND(&quot;Looking Around&quot;),
  SHOPPING(&quot;Shopping&quot;),
  INACTIVE(&quot;Inactive&quot;),
  PAID(&quot;Paid&quot;);

  private final String stateIdentifier;

  UserState(String stateIdentifier) {
    this.stateIdentifier = stateIdentifier;
  }

  @Override
  public String identifier() {
    return stateIdentifier;
  }
}</code></pre></dd>
</dl>
<p><code>LookingAround</code> customer is browsing the site, but hasn&rsquo;t added anything to the shopping cart <code>Shopping</code> customer has recently added items to the shopping cart <code>Inactive</code> customer has items in the shopping cart, but hasn&rsquo;t added anything recently <code>Paid</code> customer has purchased the items</p><div class="callout note "><div class="callout-title">Note</div>
<p><span class="group-scala"><code>PersistentFSM</code></span><span class="group-java"><code>AbstractPersistentFSM</code></span> states must <span class="group-scala">inherit from trait</span><span class="group-java">implement interface</span> <code>PersistentFSM.FSMState</code> and implement the <span class="group-scala"><code>def identifier: String</code></span><span class="group-java"><code>String identifier()</code></span> method. This is required in order to simplify the serialization of FSM states. String identifiers should be unique!</p></div>
<p>Customer&rsquo;s actions are &ldquo;recorded&rdquo; as a sequence of &ldquo;domain events&rdquo; which are persisted. Those events are replayed on an actor&rsquo;s start in order to restore the latest customer&rsquo;s state:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.8.4/akka-persistence/src/test/scala/akka/persistence/fsm/PersistentFSMSpec.scala#L445-L449" target="_blank" title="Go to snippet source">source</a><code class="language-scala">sealed trait DomainEvent
case class ItemAdded(item: Item) extends DomainEvent
case object OrderExecuted extends DomainEvent
case object OrderDiscarded extends DomainEvent
case object CustomerInactive extends DomainEvent</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.8.4/akka-persistence/src/test/java/akka/persistence/fsm/AbstractPersistentFSMTest.java#L141-L159" target="_blank" title="Go to snippet source">source</a><code class="language-java">public static final class ItemAdded implements DomainEvent {
  private final Item item;

  public ItemAdded(Item item) {
    this.item = item;
  }

  public Item getItem() {
    return item;
  }
}

public enum OrderExecuted implements DomainEvent {
  INSTANCE
}

public enum OrderDiscarded implements DomainEvent {
  INSTANCE
}</code></pre></dd>
</dl>
<p>Customer state data represents the items in a customer&rsquo;s shopping cart:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.8.4/akka-persistence/src/test/scala/akka/persistence/fsm/PersistentFSMSpec.scala#L420-L433" target="_blank" title="Go to snippet source">source</a><code class="language-scala">case class Item(id: String, name: String, price: Float)

sealed trait ShoppingCart {
  def addItem(item: Item): ShoppingCart
  def empty(): ShoppingCart
}
case object EmptyShoppingCart extends ShoppingCart {
  def addItem(item: Item) = NonEmptyShoppingCart(item :: Nil)
  def empty() = this
}
case class NonEmptyShoppingCart(items: Seq[Item]) extends ShoppingCart {
  def addItem(item: Item) = NonEmptyShoppingCart(items :+ item)
  def empty() = EmptyShoppingCart
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.8.4/akka-persistence/src/test/java/akka/persistence/fsm/AbstractPersistentFSMTest.java#L47-L107" target="_blank" title="Go to snippet source">source</a><code class="language-java">public static class ShoppingCart {
  private final List&lt;Item&gt; items = new ArrayList&lt;&gt;();

  public ShoppingCart(Item initialItem) {
    items.add(initialItem);
  }

  public ShoppingCart() {}

  public List&lt;Item&gt; getItems() {
    return Collections.unmodifiableList(items);
  }

  public ShoppingCart addItem(Item item) {
    items.add(item);
    return this;
  }

  public void empty() {
    items.clear();
  }
}

public static class Item implements Serializable {
  private final String id;
  private final String name;
  private final float price;

  Item(String id, String name, float price) {
    this.id = id;
    this.name = name;
    this.price = price;
  }

  public String getId() {
    return id;
  }

  public float getPrice() {
    return price;
  }

  public String getName() {
    return name;
  }

  @Override
  public String toString() {
    return String.format(&quot;Item{id=%s, name=%s, price=%s}&quot;, id, price, name);
  }

  @Override
  public boolean equals(Object o) {
    if (this == o) return true;
    if (o == null || getClass() != o.getClass()) return false;

    Item item = (Item) o;

    return item.price == price &amp;&amp; id.equals(item.id) &amp;&amp; name.equals(item.name);
  }
}</code></pre></dd>
</dl>
<p>Here is how everything is wired together:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.8.4/akka-persistence/src/test/scala/akka/persistence/fsm/PersistentFSMSpec.scala#L488-L538" target="_blank" title="Go to snippet source">source</a><code class="language-scala">startWith(LookingAround, EmptyShoppingCart)

when(LookingAround) {
  case Event(AddItem(item), _) =&gt;
    goto(Shopping).applying(ItemAdded(item)).forMax(1 seconds)
  case Event(GetCurrentCart, data) =&gt;
    stay().replying(data)
}

when(Shopping) {
  case Event(AddItem(item), _) =&gt;
    stay().applying(ItemAdded(item)).forMax(1 seconds)
  case Event(Buy, _) =&gt;
    goto(Paid).applying(OrderExecuted).andThen {
      case NonEmptyShoppingCart(items) =&gt;
        reportActor ! PurchaseWasMade(items)
        saveStateSnapshot()
      case EmptyShoppingCart =&gt; saveStateSnapshot()
    }
  case Event(Leave, _) =&gt;
    stop().applying(OrderDiscarded).andThen {
      case _ =&gt;
        reportActor ! ShoppingCardDiscarded
        saveStateSnapshot()
    }
  case Event(GetCurrentCart, data) =&gt;
    stay().replying(data)
  case Event(StateTimeout, _) =&gt;
    goto(Inactive).forMax(2 seconds)
}

when(Inactive) {
  case Event(AddItem(item), _) =&gt;
    goto(Shopping).applying(ItemAdded(item)).forMax(1 seconds)
  case Event(StateTimeout, _) =&gt;
    stop().applying(OrderDiscarded).andThen {
      case _ =&gt; reportActor ! ShoppingCardDiscarded
    }
}

when(Paid) {
  case Event(Leave, _) =&gt; stop()
  case Event(GetCurrentCart, data) =&gt;
    stay().replying(data)
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.8.4/akka-persistence/src/test/java/akka/persistence/fsm/AbstractPersistentFSMTest.java#L205-L278" target="_blank" title="Go to snippet source">source</a><code class="language-java">startWith(UserState.LOOKING_AROUND, new ShoppingCart());

when(
    UserState.LOOKING_AROUND,
    matchEvent(
            AddItem.class,
            (event, data) -&gt;
                goTo(UserState.SHOPPING)
                    .applying(new ItemAdded(event.getItem()))
                    .forMax(Duration.ofSeconds(1)))
        .event(GetCurrentCart.class, (event, data) -&gt; stay().replying(data)));

when(
    UserState.SHOPPING,
    matchEvent(
            AddItem.class,
            (event, data) -&gt;
                stay().applying(new ItemAdded(event.getItem())).forMax(Duration.ofSeconds(1)))
        .event(
            Buy.class,
            (event, data) -&gt;
                goTo(UserState.PAID)
                    .applying(OrderExecuted.INSTANCE)
                    .andThen(
                        exec(
                            cart -&gt; {
                              reportActor.tell(new PurchaseWasMade(cart.getItems()), self());
                              saveStateSnapshot();
                            })))
        .event(
            Leave.class,
            (event, data) -&gt;
                stop()
                    .applying(OrderDiscarded.INSTANCE)
                    .andThen(
                        exec(
                            cart -&gt; {
                              reportActor.tell(ShoppingCardDiscarded.INSTANCE, self());
                              saveStateSnapshot();
                            })))
        .event(GetCurrentCart.class, (event, data) -&gt; stay().replying(data))
        .event(
            StateTimeout$.class,
            (event, data) -&gt; goTo(UserState.INACTIVE).forMax(Duration.ofSeconds(2))));

when(
    UserState.INACTIVE,
    matchEvent(
            AddItem.class,
            (event, data) -&gt;
                goTo(UserState.SHOPPING)
                    .applying(new ItemAdded(event.getItem()))
                    .forMax(Duration.ofSeconds(1)))
        .event(GetCurrentCart.class, (event, data) -&gt; stay().replying(data))
        .event(
            StateTimeout$.class,
            (event, data) -&gt;
                stop()
                    .applying(OrderDiscarded.INSTANCE)
                    .andThen(
                        exec(
                            cart -&gt;
                                reportActor.tell(ShoppingCardDiscarded.INSTANCE, self())))));

when(
    UserState.PAID,
    matchEvent(Leave.class, (event, data) -&gt; stop())
        .event(GetCurrentCart.class, (event, data) -&gt; stay().replying(data)));</code></pre></dd>
</dl><div class="callout note "><div class="callout-title">Note</div>
<p>State data can only be modified directly on initialization. Later it&rsquo;s modified only as a result of applying domain events. Override the <code>applyEvent</code> method to define how state data is affected by domain events, see the example below</p></div>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.8.4/akka-persistence/src/test/scala/akka/persistence/fsm/PersistentFSMSpec.scala#L548-L555" target="_blank" title="Go to snippet source">source</a><code class="language-scala">override def applyEvent(event: DomainEvent, cartBeforeEvent: ShoppingCart): ShoppingCart = {
  event match {
    case ItemAdded(item)  =&gt; cartBeforeEvent.addItem(item)
    case OrderExecuted    =&gt; cartBeforeEvent
    case OrderDiscarded   =&gt; cartBeforeEvent.empty()
    case CustomerInactive =&gt; cartBeforeEvent
  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.8.4/akka-persistence/src/test/java/akka/persistence/fsm/AbstractPersistentFSMTest.java#L289-L301" target="_blank" title="Go to snippet source">source</a><code class="language-java">@Override
public ShoppingCart applyEvent(DomainEvent event, ShoppingCart currentData) {
  if (event instanceof ItemAdded) {
    currentData.addItem(((ItemAdded) event).getItem());
    return currentData;
  } else if (event instanceof OrderExecuted) {
    return currentData;
  } else if (event instanceof OrderDiscarded) {
    currentData.empty();
    return currentData;
  }
  throw new RuntimeException(&quot;Unhandled&quot;);
}</code></pre></dd>
</dl>
<p><code>andThen</code> can be used to define actions which will be executed following event&rsquo;s persistence - convenient for &ldquo;side effects&rdquo; like sending a message or logging. Notice that actions defined in <code>andThen</code> block are not executed on recovery:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.8.4/akka-persistence/src/test/scala/akka/persistence/fsm/PersistentFSMSpec.scala#L502-L509" target="_blank" title="Go to snippet source">source</a><code class="language-scala">goto(Paid).applying(OrderExecuted).andThen {
  case NonEmptyShoppingCart(items) =&gt;
    reportActor ! PurchaseWasMade(items)
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.8.4/akka-persistence/src/test/java/akka/persistence/fsm/AbstractPersistentFSMTest.java#L226-L236" target="_blank" title="Go to snippet source">source</a><code class="language-java">(event, data) -&gt;
    goTo(UserState.PAID)
        .applying(OrderExecuted.INSTANCE)
        .andThen(
            exec(
                cart -&gt; {
                  reportActor.tell(new PurchaseWasMade(cart.getItems()), self());
                })))</code></pre></dd>
</dl>
<p>A snapshot of state data can be persisted by calling the <code>saveStateSnapshot()</code> method:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.8.4/akka-persistence/src/test/scala/akka/persistence/fsm/PersistentFSMSpec.scala#L513-L517" target="_blank" title="Go to snippet source">source</a><code class="language-scala">stop().applying(OrderDiscarded).andThen {
  case _ =&gt;
    reportActor ! ShoppingCardDiscarded
    saveStateSnapshot()
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.8.4/akka-persistence/src/test/java/akka/persistence/fsm/AbstractPersistentFSMTest.java#L241-L249" target="_blank" title="Go to snippet source">source</a><code class="language-java">(event, data) -&gt;
    stop()
        .applying(OrderDiscarded.INSTANCE)
        .andThen(
            exec(
                cart -&gt; {
                  reportActor.tell(ShoppingCardDiscarded.INSTANCE, self());
                  saveStateSnapshot();
                })))</code></pre></dd>
</dl>
<p>On recovery state data is initialized according to the latest available snapshot, then the remaining domain events are replayed, triggering the <code>applyEvent</code> method.</p>
<h2><a href="#migration-to-eventsourcedbehavior" name="migration-to-eventsourcedbehavior" class="anchor"><span class="anchor-link"></span></a>Migration to EventSourcedBehavior</h2>
<p>Persistent FSMs can be represented using <a href="typed/persistence.html">Persistence Typed</a>. The data stored by Persistence FSM can be read by an <span class="group-java"><a href="https://doc.akka.io/japi/akka/2.8/akka/persistence/typed/javadsl/EventSourcedBehavior.html" title="akka.persistence.typed.javadsl.EventSourcedBehavior"><code>EventSourcedBehavior</code></a></span><span class="group-scala"><a href="https://doc.akka.io/api/akka/2.8/akka/persistence/typed/scaladsl/EventSourcedBehavior.html" title="akka.persistence.typed.scaladsl.EventSourcedBehavior"><code>EventSourcedBehavior</code></a></span> using a snapshot adapter and an event adapter. The adapters are required as Persistent FSM doesn&rsquo;t store snapshots and user data directly, it wraps them in internal types that include state transition information.</p>
<p>Before reading the migration guide it is advised to understand <a href="typed/persistence.html">Persistence Typed</a>. </p>
<h3><a href="#migration-steps" name="migration-steps" class="anchor"><span class="anchor-link"></span></a>Migration steps</h3>
<ol>
  <li>Modify or create new commands to include <code>replyTo</code> <span class="group-scala"><a href="https://doc.akka.io/api/akka/2.8/akka/actor/typed/ActorRef.html" title="akka.actor.typed.ActorRef"><code>ActorRef</code></a></span><span class="group-java"><a href="https://doc.akka.io/japi/akka/2.8/akka/actor/typed/ActorRef.html" title="akka.actor.typed.ActorRef"><code>ActorRef</code></a></span></li>
  <li>Typically persisted events will remain the same</li>
  <li>Create an <code>EventSourcedBehavior</code> that mimics the old <code>PersistentFSM</code></li>
  <li>Replace any state timeouts with <code>Behaviors.withTimers</code> either hard coded or stored in the state</li>
  <li>Add an <span class="group-scala"><a href="https://doc.akka.io/api/akka/2.8/akka/persistence/typed/EventAdapter.html" title="akka.persistence.typed.EventAdapter"><code>EventAdapter</code></a></span><span class="group-java"><a href="https://doc.akka.io/japi/akka/2.8/akka/persistence/typed/EventAdapter.html" title="akka.persistence.typed.EventAdapter"><code>EventAdapter</code></a></span> to convert state transition events added by <code>PersistentFSM</code> into private events or filter them</li>
  <li>If snapshots are used add a <span class="group-scala"><a href="https://doc.akka.io/api/akka/2.8/akka/persistence/typed/SnapshotAdapter.html" title="akka.persistence.typed.SnapshotAdapter"><code>SnapshotAdapter</code></a></span><span class="group-java"><a href="https://doc.akka.io/japi/akka/2.8/akka/persistence/typed/SnapshotAdapter.html" title="akka.persistence.typed.SnapshotAdapter"><code>SnapshotAdapter</code></a></span> to convert PersistentFSM snapshots into the <code>EventSourcedBehavior</code>s <code>State</code></li>
</ol>
<p>The following is the shopping cart example above converted to an <code>EventSourcedBehavior</code>. </p>
<p>The new commands, note the replyTo field for getting the current cart.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.8.4/akka-persistence-typed/src/test/scala/docs/akka/persistence/typed/PersistentFsmToTypedMigrationSpec.scala#L57-L62" target="_blank" title="Go to snippet source">source</a><code class="language-scala">sealed trait Command
case class AddItem(item: Item) extends Command
case object Buy extends Command
case object Leave extends Command
case class GetCurrentCart(replyTo: ActorRef[ShoppingCart]) extends Command
private case object Timeout extends Command</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.8.4/akka-persistence-typed/src/test/java/jdocs/akka/persistence/typed/PersistentFsmToTypedMigrationCompileOnlyTest.java#L19-L47" target="_blank" title="Go to snippet source">source</a><code class="language-java">interface Command {}

public static class AddItem implements Command {
  public final Item item;

  public AddItem(Item item) {
    this.item = item;
  }
}

public static class GetCurrentCart implements Command {
  public final ActorRef&lt;ShoppingCart&gt; replyTo;

  public GetCurrentCart(ActorRef&lt;ShoppingCart&gt; replyTo) {
    this.replyTo = replyTo;
  }
}

public enum Buy implements Command {
  INSTANCE
}

public enum Leave implements Command {
  INSTANCE
}

private enum Timeout implements Command {
  INSTANCE
}</code></pre></dd>
</dl>
<p>The states of the FSM are represented using the <code>EventSourcedBehavior</code>&rsquo;s state parameter along with the event and command handlers. Here are the states:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.8.4/akka-persistence-typed/src/test/scala/docs/akka/persistence/typed/PersistentFsmToTypedMigrationSpec.scala#L66-L70" target="_blank" title="Go to snippet source">source</a><code class="language-scala">sealed trait State
case class LookingAround(cart: ShoppingCart) extends State
case class Shopping(cart: ShoppingCart) extends State
case class Inactive(cart: ShoppingCart) extends State
case class Paid(cart: ShoppingCart) extends State</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.8.4/akka-persistence-typed/src/test/java/jdocs/akka/persistence/typed/PersistentFsmToTypedMigrationCompileOnlyTest.java#L51-L81" target="_blank" title="Go to snippet source">source</a><code class="language-java">abstract static class State {
  public final ShoppingCart cart;

  protected State(ShoppingCart cart) {
    this.cart = cart;
  }
}

public static class LookingAround extends State {
  public LookingAround(ShoppingCart cart) {
    super(cart);
  }
}

public static class Shopping extends State {
  public Shopping(ShoppingCart cart) {
    super(cart);
  }
}

public static class Inactive extends State {
  public Inactive(ShoppingCart cart) {
    super(cart);
  }
}

public static class Paid extends State {
  public Paid(ShoppingCart cart) {
    super(cart);
  }
}</code></pre></dd>
</dl>
<p>The command handler has a separate section for each of the PersistentFSM&rsquo;s states: </p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.8.4/akka-persistence-typed/src/test/scala/docs/akka/persistence/typed/PersistentFsmToTypedMigrationSpec.scala#L112-L157" target="_blank" title="Go to snippet source">source</a><code class="language-scala">def commandHandler(timers: TimerScheduler[Command])(state: State, command: Command): Effect[DomainEvent, State] =
  state match {
    case LookingAround(cart) =&gt;
      command match {
        case AddItem(item) =&gt;
          Effect.persist(ItemAdded(item)).thenRun(_ =&gt; timers.startSingleTimer(StateTimeout, Timeout, 1.second))
        case GetCurrentCart(replyTo) =&gt;
          replyTo ! cart
          Effect.none
        case _ =&gt;
          Effect.none
      }
    case Shopping(cart) =&gt;
      command match {
        case AddItem(item) =&gt;
          Effect.persist(ItemAdded(item)).thenRun(_ =&gt; timers.startSingleTimer(StateTimeout, Timeout, 1.second))
        case Buy =&gt;
          Effect.persist(OrderExecuted).thenRun(_ =&gt; timers.cancel(StateTimeout))
        case Leave =&gt;
          Effect.persist(OrderDiscarded).thenStop()
        case GetCurrentCart(replyTo) =&gt;
          replyTo ! cart
          Effect.none
        case Timeout =&gt;
          Effect.persist(CustomerInactive)
      }
    case Inactive(_) =&gt;
      command match {
        case AddItem(item) =&gt;
          Effect.persist(ItemAdded(item)).thenRun(_ =&gt; timers.startSingleTimer(StateTimeout, Timeout, 1.second))
        case Timeout =&gt;
          Effect.persist(OrderDiscarded)
        case _ =&gt;
          Effect.none
      }
    case Paid(cart) =&gt;
      command match {
        case Leave =&gt;
          Effect.stop()
        case GetCurrentCart(replyTo) =&gt;
          replyTo ! cart
          Effect.none
        case _ =&gt;
          Effect.none
      }
  }</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.8.4/akka-persistence-typed/src/test/java/jdocs/akka/persistence/typed/PersistentFsmToTypedMigrationCompileOnlyTest.java#L134-L154" target="_blank" title="Go to snippet source">source</a><code class="language-java">  CommandHandlerBuilder&lt;Command, DomainEvent, State&gt; builder = newCommandHandlerBuilder();

  builder.forStateType(LookingAround.class).onCommand(AddItem.class, this::addItem);

  builder
      .forStateType(Shopping.class)
      .onCommand(AddItem.class, this::addItem)
      .onCommand(Buy.class, this::buy)
      .onCommand(Leave.class, this::discardShoppingCart)
      .onCommand(Timeout.class, this::timeoutShopping);

  builder
      .forStateType(Inactive.class)
      .onCommand(AddItem.class, this::addItem)
      .onCommand(Timeout.class, () -&gt; Effect().persist(OrderDiscarded.INSTANCE).thenStop());

  builder.forStateType(Paid.class).onCommand(Leave.class, () -&gt; Effect().stop());

  builder.forAnyState().onCommand(GetCurrentCart.class, this::getCurrentCart);
  return builder.build();
}</code></pre></dd>
</dl>
<p>Note that there is no explicit support for state timeout as with PersistentFSM but the same behavior can be achieved using <code>Behaviors.withTimers</code>. If the timer is the same for all events then it can be hard coded, otherwise the old PersistentFSM timeout can be taken from the <code>StateChangeEvent</code> in the event adapter and is also available when constructing a <code>SnapshotAdapter</code>. This can be added to an internal event and then stored in the <code>State</code>. Care must also be taken to restart timers on recovery in the signal handler:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.8.4/akka-persistence-typed/src/test/scala/docs/akka/persistence/typed/PersistentFsmToTypedMigrationSpec.scala#L196-L203" target="_blank" title="Go to snippet source">source</a><code class="language-scala">.receiveSignal {
  case (state, RecoveryCompleted) =&gt;
    state match {
      case _: Shopping | _: Inactive =&gt;
        timers.startSingleTimer(StateTimeout, Timeout, 1.second)
      case _ =&gt;
    }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.8.4/akka-persistence-typed/src/test/java/jdocs/akka/persistence/typed/PersistentFsmToTypedMigrationCompileOnlyTest.java#L217-L228" target="_blank" title="Go to snippet source">source</a><code class="language-java">@Override
public SignalHandler&lt;State&gt; signalHandler() {
  return newSignalHandlerBuilder()
      .onSignal(
          RecoveryCompleted.class,
          (state, signal) -&gt; {
            if (state instanceof Shopping || state instanceof Inactive) {
              timers.startSingleTimer(TIMEOUT_KEY, Timeout.INSTANCE, Duration.ofSeconds(1));
            }
          })
      .build();
}</code></pre></dd>
</dl>
<p>Then the event handler:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.8.4/akka-persistence-typed/src/test/scala/docs/akka/persistence/typed/PersistentFsmToTypedMigrationSpec.scala#L161-L183" target="_blank" title="Go to snippet source">source</a><code class="language-scala">def eventHandler(state: State, event: DomainEvent): State = {
  state match {
    case la @ LookingAround(cart) =&gt;
      event match {
        case ItemAdded(item) =&gt; Shopping(cart.addItem(item))
        case _               =&gt; la
      }
    case Shopping(cart) =&gt;
      event match {
        case ItemAdded(item)  =&gt; Shopping(cart.addItem(item))
        case OrderExecuted    =&gt; Paid(cart)
        case OrderDiscarded   =&gt; state // will be stopped
        case CustomerInactive =&gt; Inactive(cart)
      }
    case i @ Inactive(cart) =&gt;
      event match {
        case ItemAdded(item) =&gt; Shopping(cart.addItem(item))
        case OrderDiscarded  =&gt; i // will be stopped
        case _               =&gt; i
      }
    case Paid(_) =&gt; state // no events after paid
  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.8.4/akka-persistence-typed/src/test/java/jdocs/akka/persistence/typed/PersistentFsmToTypedMigrationCompileOnlyTest.java#L185-L208" target="_blank" title="Go to snippet source">source</a><code class="language-java">@Override
public EventHandler&lt;State, DomainEvent&gt; eventHandler() {
  EventHandlerBuilder&lt;State, DomainEvent&gt; eventHandlerBuilder = newEventHandlerBuilder();

  eventHandlerBuilder
      .forStateType(LookingAround.class)
      .onEvent(ItemAdded.class, item -&gt; new Shopping(new ShoppingCart(item.getItem())));

  eventHandlerBuilder
      .forStateType(Shopping.class)
      .onEvent(
          ItemAdded.class, (state, item) -&gt; new Shopping(state.cart.addItem(item.getItem())))
      .onEvent(OrderExecuted.class, (state, item) -&gt; new Paid(state.cart))
      .onEvent(OrderDiscarded.class, (state, item) -&gt; state) // will be stopped
      .onEvent(CustomerInactive.class, (state, event) -&gt; new Inactive(state.cart));

  eventHandlerBuilder
      .forStateType(Inactive.class)
      .onEvent(
          ItemAdded.class, (state, item) -&gt; new Shopping(state.cart.addItem(item.getItem())))
      .onEvent(OrderDiscarded.class, (state, item) -&gt; state); // will be stopped

  return eventHandlerBuilder.build();
}</code></pre></dd>
</dl>
<p>The last step is the adapters that will allow the new <span class="group-java"><a href="https://doc.akka.io/japi/akka/2.8/akka/persistence/typed/javadsl/EventSourcedBehavior.html" title="akka.persistence.typed.javadsl.EventSourcedBehavior"><code>EventSourcedBehavior</code></a></span><span class="group-scala"><a href="https://doc.akka.io/api/akka/2.8/akka/persistence/typed/scaladsl/EventSourcedBehavior.html" title="akka.persistence.typed.scaladsl.EventSourcedBehavior"><code>EventSourcedBehavior</code></a></span> to read the old data:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.8.4/akka-persistence-typed/src/test/scala/docs/akka/persistence/typed/PersistentFsmToTypedMigrationSpec.scala#L88-L106" target="_blank" title="Go to snippet source">source</a><code class="language-scala">class PersistentFsmEventAdapter extends EventAdapter[DomainEvent, Any] {
  override def toJournal(e: DomainEvent): Any = e
  override def manifest(event: DomainEvent): String = &quot;&quot;
  @nowarn(&quot;msg=deprecated&quot;)
  override def fromJournal(journalEvent: Any, manifest: String): EventSeq[DomainEvent] = {
    journalEvent match {
      case _: StateChangeEvent =&gt;
        // In this example the state transitions can be inferred from the events
        // Alternatively the StateChangeEvent can be converted to a private event if either the StateChangeEvent.stateIdentifier
        // or StateChangeEvent.timeout is required
        // Many use cases have the same timeout so it can be hard coded, otherwise it cane be stored in the state
        EventSeq.empty
      case other =&gt;
        // If using a new domain event model the conversion would happen here
        EventSeq.single(other.asInstanceOf[DomainEvent])
    }

  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.8.4/akka-persistence-typed/src/test/java/jdocs/akka/persistence/typed/PersistentFsmToTypedMigrationCompileOnlyTest.java#L85-L112" target="_blank" title="Go to snippet source">source</a><code class="language-java">public static class PersistentFSMEventAdapter extends EventAdapter&lt;DomainEvent, Object&gt; {

  @Override
  public Object toJournal(DomainEvent domainEvent) {
    // leave events as is, can&#39;t roll back to PersistentFSM
    return domainEvent;
  }

  @Override
  public String manifest(DomainEvent event) {
    return &quot;&quot;;
  }

  @Override
  public EventSeq&lt;DomainEvent&gt; fromJournal(Object event, String manifest) {
    if (event instanceof akka.persistence.fsm.PersistentFSM.StateChangeEvent) {
      // In this example the state transitions can be inferred from the events
      // Alternatively the StateChangeEvent can be converted to a private event if either the
      // StateChangeEvent.stateIdentifier
      // or StateChangeEvent.timeout is required
      // Many use cases have the same timeout so it can be hard coded, otherwise it cane be stored
      // in the state
      return EventSeq.empty();
    } else {
      // If using a new domain event model the conversion would happen here
      return EventSeq.single((DomainEvent) event);
    }
  }</code></pre></dd>
</dl>
<p>The snapshot adapter needs to adapt an internal type of PersistentFSM so a helper function is provided to build the <span class="group-scala"><a href="https://doc.akka.io/api/akka/2.8/akka/persistence/typed/SnapshotAdapter.html" title="akka.persistence.typed.SnapshotAdapter"><code>SnapshotAdapter</code></a></span><span class="group-java"><a href="https://doc.akka.io/japi/akka/2.8/akka/persistence/typed/SnapshotAdapter.html" title="akka.persistence.typed.SnapshotAdapter"><code>SnapshotAdapter</code></a></span>:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.8.4/akka-persistence-typed/src/test/scala/docs/akka/persistence/typed/PersistentFsmToTypedMigrationSpec.scala#L74-L84" target="_blank" title="Go to snippet source">source</a><code class="language-scala">val persistentFSMSnapshotAdapter: SnapshotAdapter[State] = PersistentFSMMigration.snapshotAdapter[State] {
  case (stateIdentifier, data, _) =&gt;
    val cart = data.asInstanceOf[ShoppingCart]
    stateIdentifier match {
      case &quot;Looking Around&quot; =&gt; LookingAround(cart)
      case &quot;Shopping&quot;       =&gt; Shopping(cart)
      case &quot;Inactive&quot;       =&gt; Inactive(cart)
      case &quot;Paid&quot;           =&gt; Paid(cart)
      case id               =&gt; throw new IllegalStateException(s&quot;Unexpected state identifier $id&quot;)
    }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.8.4/akka-persistence-typed/src/test/java/jdocs/akka/persistence/typed/PersistentFsmToTypedMigrationCompileOnlyTest.java#L232-L250" target="_blank" title="Go to snippet source">source</a><code class="language-java">@Override
public SnapshotAdapter&lt;State&gt; snapshotAdapter() {
  return PersistentFSMMigration.snapshotAdapter(
      (stateIdentifier, snapshot, timeout) -&gt; {
        ShoppingCart cart = (ShoppingCart) snapshot;
        switch (stateIdentifier) {
          case &quot;Looking Around&quot;:
            return new LookingAround(cart);
          case &quot;Shopping&quot;:
            return new Shopping(cart);
          case &quot;Inactive&quot;:
            return new Inactive(cart);
          case &quot;Paid&quot;:
            return new Paid(cart);
          default:
            throw new IllegalStateException(&quot;Unexpected state identifier &quot; + stateIdentifier);
        }
      });
}</code></pre></dd>
</dl>
<p>That concludes all the steps to allow an <span class="group-java"><a href="https://doc.akka.io/japi/akka/2.8/akka/persistence/typed/javadsl/EventSourcedBehavior.html" title="akka.persistence.typed.javadsl.EventSourcedBehavior"><code>EventSourcedBehavior</code></a></span><span class="group-scala"><a href="https://doc.akka.io/api/akka/2.8/akka/persistence/typed/scaladsl/EventSourcedBehavior.html" title="akka.persistence.typed.scaladsl.EventSourcedBehavior"><code>EventSourcedBehavior</code></a></span> to read a <code>PersistentFSM</code>&rsquo;s data. Once the new code has been running you can not roll back as the PersistentFSM will not be able to read data written by Persistence Typed. </p><div class="callout note "><div class="callout-title">Note</div>
<p>There is one case where <a href="additional/rolling-updates.html#migrating-from-persistentfsm-to-eventsourcedbehavior">a full shutdown and startup is required</a>.</p></div>
</div>
</article>
<div class="row">
<div class="small-12 column">
<section class="nav-prev-next row">
<div class="nav-prev small-6 column">
<a href="persistence.html"><i class="icon-prev"></i> <span class="link-prev">Classic Persistence</span></a>
</div>
<div class="nav-next small-6 column clearfix">
<a class="float-right" href="testing.html">Testing Classic Actors <i class="icon-next"></i></a>
</div>
</section>
</div>
</div>
<div class="source-github row">
Found an error in this documentation? The source code for this page can be found <a href="https://github.com/akka/akka/tree/v2.8.4/akka-docs/src/main/paradox/persistence-fsm.md">here</a>.
Please feel free to edit and contribute a pull request.
</div>

<footer class="page-footer row clearfix">
<img class="akka-icon float-left show-for-medium" src="images/akka-icon.svg" />
<section class="copyright">
<div>Akka is available under the <a href="https://www.lightbend.com/akka/license" target="_blank">Business Source License 1.1</a>.</div>
<p class="legal">
&copy; 2011-2023 <a href="https://www.lightbend.com" target="_blank">Lightbend, Inc.</a> |
<a href="https://www.lightbend.com/legal/licenses" target="_blank">Licenses</a> |
<a href="https://www.lightbend.com/legal/terms" target="_blank">Terms</a> |
<a href="https://www.lightbend.com/legal/privacy" target="_blank">Privacy Policy</a> |
<a href="https://akka.io/cookie/" target="_blank">Cookie Listing</a> |
<a class="optanon-toggle-display">Cookie Settings</a>
</p>
</section>

</footer>
</section>
</main>
</div>

<script type="text/javascript" src="js/scrollsneak.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="js/groups.js"></script>
<script type="text/javascript" src="js/page.js"></script>
<script type="text/javascript" src="js/snippets.js"></script>
<script type="text/javascript" src="js/magellan.js"></script>
<script type="text/javascript" src="js/metadata-toggle.js"></script>
<script type="text/javascript" src="js/lbHeader.js"></script>

<style type="text/css">@import "lib/prettify/prettify.css";</style>
<script type="text/javascript" src="lib/prettify/prettify.js"></script>
<script type="text/javascript" src="lib/prettify/lang-scala.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(){window.prettyPrint && prettyPrint()});
//]]></script>
<!-- Algolia docs search -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.js"></script>
<style>.algolia-autocomplete { display: block !important }</style>
<script type="text/javascript">
docsearch({
appId: 'XUXZ6LW9B1',
apiKey: '5b6260148e92f7c5e38338fcf7eaa3e0',
indexName: 'akka_docs',
inputSelector: '#search',
algoliaOptions: {
hitsPerPage: 5
}
});

docsearch({
appId: 'XUXZ6LW9B1',
apiKey: '5b6260148e92f7c5e38338fcf7eaa3e0',
indexName: 'akka_docs',
inputSelector: '#overlay-search',
algoliaOptions: {
hitsPerPage: 5
}
});

// set up "/" as global shortcut for focusing on search
jQuery(document).keypress(function (event) {
if (event.keyCode == 47) {
jQuery("#search").focus();
return false; // swallow key event, otherwise the / char would be input into the search box
}
});
</script>

<script type="text/javascript" src="assets/js/warnOldDocs.js"></script>
<script type="text/javascript" src="assets/js/scalafiddle.js"></script>


</body>
</html>
