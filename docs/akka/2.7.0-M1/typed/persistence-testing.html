<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Testing &bull; Akka Documentation</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="Akka is a toolkit for building highly concurrent, distributed, and resilient message-driven applications for Java and Scala."/>
<link rel="canonical" href="https://doc.akka.io/docs/akka/current/typed/persistence-testing.html"/>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../lib/foundation/dist/js/foundation.min.js"></script>
<link rel="stylesheet" type="text/css" href="../lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="../lib/foundation/dist/css/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" type="text/css" href="../css/icons.css"/>
<link rel="stylesheet" type="text/css" href="../css/page-8.css"/>
<link rel="stylesheet" type="text/css" href="../css/banner-2.css"/>
<link rel="shortcut icon" href="../images/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="../images/apple-touch-icon.png"/>
<link rel="icon" type="image/png" sizes="32x32" href="../images/favicon-32x32.png"/>
<link rel="icon" type="image/png" sizes="16x16" href="../images/favicon-16x16.png"/>
<link rel="manifest" href="../images/manifest.json"/>
<meta name="msapplication-TileImage" content="../images/mstile-150x150.png"/>
<meta name="msapplication-TileColor" content="#15a9ce"/>
<meta name="theme-color" content="#15a9ce"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) start -->
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js"  type="text/javascript" charset="UTF-8" data-domain-script="28b912e7-09e9-43d5-91e4-3d1897044004" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) end -->
<!--Google Analytics-->
<script type="text/plain" class="optanon-category-2">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-21117439-1']);
_gaq.push(['_setDomainName', 'akka.io']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})()
</script>
<!-- Google Tag Manager -->
<script type="text/plain" class="optanon-category-2">
(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KBJGH35');
</script>
<!--Marketo-->
<script type="text/plain" class="optanon-category-3">
(function() {
var didInit = false;
function initMunchkin() {
if(didInit === false) {
didInit = true;
Munchkin.init('558-NCX-702', { 'asyncOnly': true, 'disableClickDelay': true });
}
}
var s = document.createElement('script');
s.type = 'text/javascript';
s.async = true;
s.src = '//munchkin.marketo.net/munchkin.js';
s.onreadystatechange = function() {
if (this.readyState == 'complete' || this.readyState == 'loaded') {
initMunchkin();
}
};
s.onload = initMunchkin;
document.getElementsByTagName('head')[0].appendChild(s);
})();
</script>
</head>

<body id="underlay" data-toggler="nav-open">
<div id="lightbend-banner" class="lightbend-banner akka full-width" data-category="OSS Lightbend Banner Impression" data-label="Akka Banner Impression">
<div class="oss-wrapper">
<div class="oss-brand">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lightbend Logo - Akka Banner" href="https://www.lightbend.com">
<img class="lightbend-logo" src="../images/banner-logos/lightbend-reverse.svg" alt="Lightbend" title="Lightbend">
</a>
</div>
<div class="oss-ad no-drop-down">
<nav id="lightbendRotator" class="lightbend-rotator">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Promo Rotator - Kalix - High-performance microservices and APIs with no operations required. - Akka Banner" href="https://www.kalix.io/">
<strong>Kalix</strong> - High-performance microservices and APIs with no operations required. <span class="akka-btn">Learn More</span>
</a>
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Promo Rotator - Meet Akka Insights! A stand alone telemetry & observability offering. [Learn More] - Akka Banner" href="https://www.lightbend.com/akka-insights">
<strong>Meet Akka Insights!</strong>&nbsp;&nbsp;A stand alone telemetry & observability offering. <span class="akka-btn">Learn More</span>
</a>
</nav>
</div>
</div>
</div>

<header class="site-header hide-for-large">
<div class="sticky-header clearfix">
<a href="https://akka.io"><img class="logo" src="../images/akka-logo-reverse.svg"/></a>

<button class="menu-icon float-right" type="button" data-toggle="underlay overlay"></button>
</div>
<div id="overlay" class="overlay-nav" data-toggler="nav-open">
<header class="nav-header">
<div class="nav-header-title">
<h1><a href="../index.html">Akka Documentation</a></h1>
</div>
<div class="nav-header-version">
Version 2.7.0-M1
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-scala">Scala</option><option class="group" value="group-java">Java</option></select>
</div>
<div id="overlay-search-container" class="nav-header-search">
<input id="overlay-search" type="search" class="search" placeholder="Search" />
</div>
</header>
<nav class="nav-toc">
<ul>
  <li><a href="../security/index.html" class="page">Security Announcements</a></li>
  <li><a href="../typed/guide/index.html" class="page">Getting Started Guide</a></li>
  <li><a href="../general/index.html" class="page">General Concepts</a></li>
  <li><a href="../typed/index.html" class="page">Actors</a></li>
  <li><a href="../typed/index-cluster.html" class="page">Cluster</a></li>
  <li><a href="../typed/index-persistence.html" class="page">Persistence (Event Sourcing)</a>
  <ul>
    <li><a href="../typed/persistence.html" class="page">Event Sourcing</a></li>
    <li><a href="../typed/replicated-eventsourcing.html" class="page">Replicated Event Sourcing</a></li>
    <li><a href="../typed/cqrs.html" class="page">CQRS</a></li>
    <li><a href="../typed/persistence-style.html" class="page">Style Guide</a></li>
    <li><a href="../typed/persistence-snapshot.html" class="page">Snapshotting</a></li>
    <li><a href="../typed/persistence-testing.html#testing" class="active page">Testing</a>
    <ul>
      <li><a href="../typed/persistence-testing.html#module-info" class="header">Module info</a></li>
      <li><a href="../typed/persistence-testing.html#unit-testing" class="header">Unit testing</a></li>
      <li><a href="../typed/persistence-testing.html#persistence-testkit" class="header">Persistence TestKit</a></li>
      <li><a href="../typed/persistence-testing.html#integration-testing" class="header">Integration testing</a></li>
    </ul></li>
    <li><a href="../typed/persistence-fsm.html" class="page">EventSourced behaviors as finite state machines</a></li>
    <li><a href="../persistence-schema-evolution.html" class="page">Schema Evolution for Event Sourced Actors</a></li>
    <li><a href="../persistence-query.html" class="page">Persistence Query</a></li>
    <li><a href="../persistence-query-leveldb.html" class="page">Persistence Query for LevelDB</a></li>
    <li><a href="../persistence-plugins.html" class="page">Persistence Plugins</a></li>
    <li><a href="../persistence-journals.html" class="page">Persistence - Building a storage backend</a></li>
    <li><a href="../typed/replicated-eventsourcing-examples.html" class="page">Replicated Event Sourcing Examples</a></li>
  </ul></li>
  <li><a href="../typed/index-persistence-durable-state.html" class="page">Persistence (Durable State)</a></li>
  <li><a href="../stream/index.html" class="page">Streams</a></li>
  <li><a href="../discovery/index.html" class="page">Discovery</a></li>
  <li><a href="../index-utilities.html" class="page">Utilities</a></li>
  <li><a href="../common/other-modules.html" class="page">Other Akka modules</a></li>
  <li><a href="../additional/deploy.html" class="page">Package, Deploy and Run</a></li>
  <li><a href="../project/index.html" class="page">Project Information</a></li>
  <li><a href="../index-classic.html" class="page">Akka Classic</a></li>
</ul>
</nav>
</div>
</header>
<div class="site-content-wrapper">
<aside class="sticky-sidebar show-for-large">
<header class="nav-header sticky-sidebar-header">
<div class="nav-header-title">
<h1><a href="../index.html">Akka Documentation</a></h1>
</div>
<div class="nav-header-version">
Version 2.7.0-M1
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-scala">Scala</option><option class="group" value="group-java">Java</option></select>
</div>
<div class="nav-header-search">
<input id="search" type="search" class="search" placeholder="Search" />
</div>
</header>
<nav class="site-nav sticky-sidebar-contents">
<div class="nav-toc">
<ul>
  <li><a href="../security/index.html" class="page">Security Announcements</a></li>
  <li><a href="../typed/guide/index.html" class="page">Getting Started Guide</a></li>
  <li><a href="../general/index.html" class="page">General Concepts</a></li>
  <li><a href="../typed/index.html" class="page">Actors</a></li>
  <li><a href="../typed/index-cluster.html" class="page">Cluster</a></li>
  <li><a href="../typed/index-persistence.html" class="page">Persistence (Event Sourcing)</a>
  <ul>
    <li><a href="../typed/persistence.html" class="page">Event Sourcing</a></li>
    <li><a href="../typed/replicated-eventsourcing.html" class="page">Replicated Event Sourcing</a></li>
    <li><a href="../typed/cqrs.html" class="page">CQRS</a></li>
    <li><a href="../typed/persistence-style.html" class="page">Style Guide</a></li>
    <li><a href="../typed/persistence-snapshot.html" class="page">Snapshotting</a></li>
    <li><a href="../typed/persistence-testing.html#testing" class="active page">Testing</a>
    <ul>
      <li><a href="../typed/persistence-testing.html#module-info" class="header">Module info</a></li>
      <li><a href="../typed/persistence-testing.html#unit-testing" class="header">Unit testing</a></li>
      <li><a href="../typed/persistence-testing.html#persistence-testkit" class="header">Persistence TestKit</a></li>
      <li><a href="../typed/persistence-testing.html#integration-testing" class="header">Integration testing</a></li>
    </ul></li>
    <li><a href="../typed/persistence-fsm.html" class="page">EventSourced behaviors as finite state machines</a></li>
    <li><a href="../persistence-schema-evolution.html" class="page">Schema Evolution for Event Sourced Actors</a></li>
    <li><a href="../persistence-query.html" class="page">Persistence Query</a></li>
    <li><a href="../persistence-query-leveldb.html" class="page">Persistence Query for LevelDB</a></li>
    <li><a href="../persistence-plugins.html" class="page">Persistence Plugins</a></li>
    <li><a href="../persistence-journals.html" class="page">Persistence - Building a storage backend</a></li>
    <li><a href="../typed/replicated-eventsourcing-examples.html" class="page">Replicated Event Sourcing Examples</a></li>
  </ul></li>
  <li><a href="../typed/index-persistence-durable-state.html" class="page">Persistence (Durable State)</a></li>
  <li><a href="../stream/index.html" class="page">Streams</a></li>
  <li><a href="../discovery/index.html" class="page">Discovery</a></li>
  <li><a href="../index-utilities.html" class="page">Utilities</a></li>
  <li><a href="../common/other-modules.html" class="page">Other Akka modules</a></li>
  <li><a href="../additional/deploy.html" class="page">Package, Deploy and Run</a></li>
  <li><a href="../project/index.html" class="page">Project Information</a></li>
  <li><a href="../index-classic.html" class="page">Akka Classic</a></li>
</ul>
</div>
</nav>
<footer class="nav-footer sticky-sidebar-footer">
<a href="https://akka.io"><img class="logo" src="../images/akka-logo-reverse.svg"/></a>

</footer>
</aside>
<main class="fixed-shift-for-large expanded row">
<section class="site-content small-12 column">
<article class="page-content row">
<div class="small-12 column" id="docs">
<h1><a href="#testing" name="testing" class="anchor"><span class="anchor-link"></span></a>Testing</h1>
<h2><a href="#module-info" name="module-info" class="anchor"><span class="anchor-link"></span></a>Module info</h2>
<p>To use Akka Persistence TestKit, add the module to your project:</p><dl class="dependency"><dt>sbt</dt><dd><pre class="prettyprint"><code class="language-scala">val AkkaVersion = "2.7.0-M1"
libraryDependencies ++= Seq(
  "com.typesafe.akka" %% "akka-persistence-typed" % AkkaVersion,
  "com.typesafe.akka" %% "akka-persistence-testkit" % AkkaVersion % Test
)</code></pre></dd><dt>Maven</dt><dd><pre class="prettyprint"><code class="language-xml">&lt;properties&gt;
  &lt;scala.binary.version&gt;2.13&lt;/scala.binary.version&gt;
&lt;/properties&gt;
&lt;dependencyManagement&gt;
  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;com.typesafe.akka&lt;/groupId&gt;
      &lt;artifactId&gt;akka-bom_${scala.binary.version}&lt;/artifactId&gt;
      &lt;version&gt;2.7.0-M1&lt;/version&gt;
      &lt;type&gt;pom&lt;/type&gt;
      &lt;scope&gt;import&lt;/scope&gt;
    &lt;/dependency&gt
  &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;
&lt;dependencies&gt
  &lt;dependency&gt;
    &lt;groupId&gt;com.typesafe.akka&lt;/groupId&gt;
    &lt;artifactId&gt;akka-persistence-typed_${scala.binary.version}&lt;/artifactId&gt;
  &lt;/dependency&gt
  &lt;dependency&gt;
    &lt;groupId&gt;com.typesafe.akka&lt;/groupId&gt;
    &lt;artifactId&gt;akka-persistence-testkit_${scala.binary.version}&lt;/artifactId&gt;
    &lt;scope&gt;test&lt;/scope&gt;
  &lt;/dependency&gt
&lt;/dependencies&gt;</code></pre></dd><dt>Gradle</dt><dd><pre class="prettyprint"><code class="language-gradle">def versions = [
  ScalaBinary: "2.13"
]
dependencies {
  implementation platform("com.typesafe.akka:akka-bom_${versions.ScalaBinary}:2.7.0-M1")

  implementation "com.typesafe.akka:akka-persistence-typed_${versions.ScalaBinary}"
  testImplementation "com.typesafe.akka:akka-persistence-testkit_${versions.ScalaBinary}"
}</code></pre></dd></dl>
<table class="project-info">
<tr><th colspan="2">Project Info: Akka Persistence Testkit</th></tr>
  <tr><th>Artifact</th><td><div>com.typesafe.akka</div>
  <div>akka-persistence-testkit</div>
  <div>2.7.0-M1</div>
  <div><a href="project/links.html#snapshots-repository">Snapshots are available</a></div>
  </td></tr>
  <tr><th>JDK versions</th><td><div>Adopt OpenJDK 8</div><div>Adopt OpenJDK 11</div></td></tr>
  <tr><th>Scala versions</th><td>2.13.8, 2.12.16, 3.1.2</td></tr>
  <tr><th>JPMS module name</th><td>akka.persistence.testkit</td></tr>
  <tr><th>License</th><td><div><a href="https://raw.githubusercontent.com/akka/akka/main/LICENSE" target="_blank" rel="noopener noreferrer">BUSL-1.1</a></div>
  </td></tr>
  <tr><th>Readiness level</th><td><div class="readiness-level"><a href="https://developer.lightbend.com/docs/introduction/getting-help/support-terminology.html#incubating" target="_blank" rel="noopener">Incubating</a></div>
  <div>Since 2.6.5, 2020-04-30</div>
  </td></tr>
  <tr><th>Home page</th><td><a href="https://akka.io/">https://akka.io/</a></td></tr>
  <tr><th>API documentation</th><td>
  <div><a href="https://doc.akka.io/api/akka/2.7.0-M1/akka/persistence/testkit/scaladsl/index.html" target="_blank" rel="noopener noreferrer">API (Scaladoc)</a></div>
  <div><a href="https://doc.akka.io/japi/akka/2.7.0-M1/akka/persistence/testkit/javadsl/package-summary.html" target="_blank" rel="noopener noreferrer">API (Javadoc)</a></div>
  </td></tr>
  <tr><th>Forums</th><td>
  <div><a href="https://discuss.akka.io" target="_blank" rel="noopener noreferrer">Lightbend Discuss</a></div>
  <div><a href="https://gitter.im/akka/akka" target="_blank" rel="noopener noreferrer">akka/akka Gitter channel</a></div>
  </td></tr>
  <tr><th>Release notes</th><td><a href="https://akka.io/blog/news-archive.html">akka.io blog</a></td></tr>
  <tr><th>Issues</th><td><a href="https://github.com/akka/akka/issues" target="_blank" rel="noopener noreferrer">Github issues</a></td></tr>
  <tr><th>Sources</th><td><a href="https://github.com/akka/akka" target="_blank" rel="noopener noreferrer">https://github.com/akka/akka</a></td></tr>
</table>

<h2><a href="#unit-testing" name="unit-testing" class="anchor"><span class="anchor-link"></span></a>Unit testing</h2>

<p><strong>Note!</strong> The <code>EventSourcedBehaviorTestKit</code> is a new feature, api may have changes breaking source compatibility in future versions.</p>

<p>Unit testing of <code>EventSourcedBehavior</code> can be done with the <span class="group-java"><a href="https://doc.akka.io/japi/akka/2.7/akka/persistence/testkit/javadsl/EventSourcedBehaviorTestKit.html" title="akka.persistence.testkit.javadsl.EventSourcedBehaviorTestKit"><code>EventSourcedBehaviorTestKit</code></a></span><span class="group-scala"><a href="https://doc.akka.io/api/akka/2.7/akka/persistence/testkit/scaladsl/EventSourcedBehaviorTestKit.html" title="akka.persistence.testkit.scaladsl.EventSourcedBehaviorTestKit"><code>EventSourcedBehaviorTestKit</code></a></span>. It supports running one command at a time and you can assert that the synchronously returned result is as expected. The result contains the events emitted by the command and the new state after applying the events. It also has support for verifying the reply to a command.</p>

<p>You need to configure the <code>ActorSystem</code> with the <code>EventSourcedBehaviorTestKit.config</code>. The configuration enables the in-memory journal and snapshot storage.</p>

<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.7.0-M1/akka-cluster-sharding-typed/src/test/scala/docs/akka/cluster/sharding/typed/AccountExampleDocSpec.scala#L23-L24" target="_blank" title="Go to snippet source">source</a><code class="language-scala">class AccountExampleDocSpec
    extends ScalaTestWithActorTestKit(EventSourcedBehaviorTestKit.config)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.7.0-M1/akka-cluster-sharding-typed/src/test/java/jdocs/akka/cluster/sharding/typed/AccountExampleDocTest.java#L38-L46" target="_blank" title="Go to snippet source">source</a><code class="language-java">@ClassRule
public static final TestKitJunitResource testKit =
    new TestKitJunitResource(EventSourcedBehaviorTestKit.config());

private EventSourcedBehaviorTestKit&lt;
        AccountEntity.Command, AccountEntity.Event, AccountEntity.Account&gt;
    eventSourcedTestKit =
        EventSourcedBehaviorTestKit.create(
            testKit.system(), AccountEntity.create(&quot;1&quot;, PersistenceId.of(&quot;Account&quot;, &quot;1&quot;)));</code></pre></dd>
</dl>
<p>A full test for the <code>AccountEntity</code>, which is shown in the <a href="persistence-style.html">Persistence Style Guide</a>, may look like this:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.7.0-M1/akka-cluster-sharding-typed/src/test/scala/docs/akka/cluster/sharding/typed/AccountExampleDocSpec.scala#L8-L81" target="_blank" title="Go to snippet source">source</a><code class="language-scala">import akka.Done
import akka.persistence.testkit.scaladsl.EventSourcedBehaviorTestKit
import akka.persistence.typed.PersistenceId
import akka.actor.testkit.typed.scaladsl.LogCapturing
import akka.actor.testkit.typed.scaladsl.ScalaTestWithActorTestKit
import akka.pattern.StatusReply
import org.scalatest.BeforeAndAfterEach
import org.scalatest.wordspec.AnyWordSpecLike

class AccountExampleDocSpec
    extends ScalaTestWithActorTestKit(EventSourcedBehaviorTestKit.config)
    with AnyWordSpecLike
    with BeforeAndAfterEach
    with LogCapturing {

  private val eventSourcedTestKit =
    EventSourcedBehaviorTestKit[AccountEntity.Command, AccountEntity.Event, AccountEntity.Account](
      system,
      AccountEntity(&quot;1&quot;, PersistenceId(&quot;Account&quot;, &quot;1&quot;)))

  override protected def beforeEach(): Unit = {
    super.beforeEach()
    eventSourcedTestKit.clear()
  }

  &quot;Account&quot; must {

    &quot;be created with zero balance&quot; in {
      val result = eventSourcedTestKit.runCommand[StatusReply[Done]](AccountEntity.CreateAccount(_))
      result.reply shouldBe StatusReply.Ack
      result.event shouldBe AccountEntity.AccountCreated
      result.stateOfType[AccountEntity.OpenedAccount].balance shouldBe 0
    }

    &quot;handle Withdraw&quot; in {
      eventSourcedTestKit.runCommand[StatusReply[Done]](AccountEntity.CreateAccount(_))

      val result1 = eventSourcedTestKit.runCommand[StatusReply[Done]](AccountEntity.Deposit(100, _))
      result1.reply shouldBe StatusReply.Ack
      result1.event shouldBe AccountEntity.Deposited(100)
      result1.stateOfType[AccountEntity.OpenedAccount].balance shouldBe 100

      val result2 = eventSourcedTestKit.runCommand[StatusReply[Done]](AccountEntity.Withdraw(10, _))
      result2.reply shouldBe StatusReply.Ack
      result2.event shouldBe AccountEntity.Withdrawn(10)
      result2.stateOfType[AccountEntity.OpenedAccount].balance shouldBe 90
    }

    &quot;reject Withdraw overdraft&quot; in {
      eventSourcedTestKit.runCommand[StatusReply[Done]](AccountEntity.CreateAccount(_))
      eventSourcedTestKit.runCommand[StatusReply[Done]](AccountEntity.Deposit(100, _))

      val result = eventSourcedTestKit.runCommand[StatusReply[Done]](AccountEntity.Withdraw(110, _))
      result.reply.isError shouldBe true
      result.hasNoEvents shouldBe true
    }

    &quot;handle GetBalance&quot; in {
      eventSourcedTestKit.runCommand[StatusReply[Done]](AccountEntity.CreateAccount(_))
      eventSourcedTestKit.runCommand[StatusReply[Done]](AccountEntity.Deposit(100, _))

      val result = eventSourcedTestKit.runCommand[AccountEntity.CurrentBalance](AccountEntity.GetBalance(_))
      result.reply.balance shouldBe 100
      result.hasNoEvents shouldBe true
    }
  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.7.0-M1/akka-cluster-sharding-typed/src/test/java/jdocs/akka/cluster/sharding/typed/AccountExampleDocTest.java#L15-L131" target="_blank" title="Go to snippet source">source</a><code class="language-java">import java.math.BigDecimal;
import akka.actor.testkit.typed.javadsl.LogCapturing;
import akka.actor.testkit.typed.javadsl.TestKitJunitResource;
import akka.actor.typed.ActorRef;
import akka.persistence.testkit.javadsl.EventSourcedBehaviorTestKit;
import akka.persistence.testkit.javadsl.EventSourcedBehaviorTestKit.CommandResultWithReply;
import akka.persistence.typed.PersistenceId;

import org.junit.Before;
import org.junit.ClassRule;
import org.junit.Rule;
import org.junit.Test;

public class AccountExampleDocTest
{

  @ClassRule
  public static final TestKitJunitResource testKit =
      new TestKitJunitResource(EventSourcedBehaviorTestKit.config());

  private EventSourcedBehaviorTestKit&lt;
          AccountEntity.Command, AccountEntity.Event, AccountEntity.Account&gt;
      eventSourcedTestKit =
          EventSourcedBehaviorTestKit.create(
              testKit.system(), AccountEntity.create(&quot;1&quot;, PersistenceId.of(&quot;Account&quot;, &quot;1&quot;)));

  @Rule public final LogCapturing logCapturing = new LogCapturing();

  @Before
  public void beforeEach() {
    eventSourcedTestKit.clear();
  }

  @Test
  public void createWithEmptyBalance() {
    CommandResultWithReply&lt;
            AccountEntity.Command, AccountEntity.Event, AccountEntity.Account, StatusReply&lt;Done&gt;&gt;
        result = eventSourcedTestKit.runCommand(AccountEntity.CreateAccount::new);
    assertEquals(StatusReply.ack(), result.reply());
    assertEquals(AccountEntity.AccountCreated.INSTANCE, result.event());
    assertEquals(BigDecimal.ZERO, result.stateOfType(AccountEntity.OpenedAccount.class).balance);
  }

  @Test
  public void createWithUnHandle() {
    CommandResultWithReply&lt;
            AccountEntity.Command, AccountEntity.Event, AccountEntity.Account, StatusReply&lt;Done&gt;&gt;
        result = eventSourcedTestKit.runCommand(AccountEntity.CreateAccount::new);
    assertFalse(result.hasNoReply());
  }

  @Test
  public void handleWithdraw() {
    eventSourcedTestKit.runCommand(AccountEntity.CreateAccount::new);

    CommandResultWithReply&lt;
            AccountEntity.Command, AccountEntity.Event, AccountEntity.Account, StatusReply&lt;Done&gt;&gt;
        result1 =
            eventSourcedTestKit.runCommand(
                replyTo -&gt; new AccountEntity.Deposit(BigDecimal.valueOf(100), replyTo));
    assertEquals(StatusReply.ack(), result1.reply());
    assertEquals(
        BigDecimal.valueOf(100), result1.eventOfType(AccountEntity.Deposited.class).amount);
    assertEquals(
        BigDecimal.valueOf(100), result1.stateOfType(AccountEntity.OpenedAccount.class).balance);

    CommandResultWithReply&lt;
            AccountEntity.Command, AccountEntity.Event, AccountEntity.Account, StatusReply&lt;Done&gt;&gt;
        result2 =
            eventSourcedTestKit.runCommand(
                replyTo -&gt; new AccountEntity.Withdraw(BigDecimal.valueOf(10), replyTo));
    assertEquals(StatusReply.ack(), result2.reply());
    assertEquals(BigDecimal.valueOf(10), result2.eventOfType(AccountEntity.Withdrawn.class).amount);
    assertEquals(
        BigDecimal.valueOf(90), result2.stateOfType(AccountEntity.OpenedAccount.class).balance);
  }

  @Test
  public void rejectWithdrawOverdraft() {
    eventSourcedTestKit.runCommand(AccountEntity.CreateAccount::new);
    eventSourcedTestKit.runCommand(
        (ActorRef&lt;StatusReply&lt;Done&gt;&gt; replyTo) -&gt;
            new AccountEntity.Deposit(BigDecimal.valueOf(100), replyTo));

    CommandResultWithReply&lt;
            AccountEntity.Command, AccountEntity.Event, AccountEntity.Account, StatusReply&lt;Done&gt;&gt;
        result =
            eventSourcedTestKit.runCommand(
                replyTo -&gt; new AccountEntity.Withdraw(BigDecimal.valueOf(110), replyTo));
    assertTrue(result.reply().isError());
    assertTrue(result.hasNoEvents());
  }

  @Test
  public void handleGetBalance() {
    eventSourcedTestKit.runCommand(AccountEntity.CreateAccount::new);
    eventSourcedTestKit.runCommand(
        (ActorRef&lt;StatusReply&lt;Done&gt;&gt; replyTo) -&gt;
            new AccountEntity.Deposit(BigDecimal.valueOf(100), replyTo));

    CommandResultWithReply&lt;
            AccountEntity.Command,
            AccountEntity.Event,
            AccountEntity.Account,
            AccountEntity.CurrentBalance&gt;
        result = eventSourcedTestKit.runCommand(AccountEntity.GetBalance::new);
    assertEquals(BigDecimal.valueOf(100), result.reply().balance);
  }
}</code></pre></dd>
</dl>
<p>Serialization of commands, events and state are verified automatically. The serialization checks can be customized with the <code>SerializationSettings</code> when creating the <code>EventSourcedBehaviorTestKit</code>. By default, the serialization roundtrip is checked but the equality of the result of the serialization is not checked. <code>equals</code> must be implemented <span class="group-scala">(or using <code>case class</code>)</span> in the commands, events and state if <code>verifyEquality</code> is enabled.</p>
<p>To test recovery the <code>restart</code> method of the <code>EventSourcedBehaviorTestKit</code> can be used. It will restart the behavior, which will then recover from stored snapshot and events from previous commands. It&rsquo;s also possible to populate the storage with events or simulate failures by using the underlying <span class="group-java"><a href="https://doc.akka.io/japi/akka/2.7/akka/persistence/testkit/javadsl/PersistenceTestKit.html" title="akka.persistence.testkit.javadsl.PersistenceTestKit"><code>PersistenceTestKit</code></a></span><span class="group-scala"><a href="https://doc.akka.io/api/akka/2.7/akka/persistence/testkit/scaladsl/PersistenceTestKit.html" title="akka.persistence.testkit.scaladsl.PersistenceTestKit"><code>PersistenceTestKit</code></a></span>.</p>
<h2><a href="#persistence-testkit" name="persistence-testkit" class="anchor"><span class="anchor-link"></span></a>Persistence TestKit</h2>
<p><strong>Note!</strong> The <code>PersistenceTestKit</code> is a new feature, api may have changes breaking source compatibility in future versions.</p>
<p>Persistence testkit allows to check events saved in a storage, emulate storage operations and exceptions. To use the testkit you need to add the following dependency in your project:</p><dl class="dependency"><dt>sbt</dt><dd><pre class="prettyprint"><code class="language-scala">val AkkaVersion = "2.7.0-M1"
libraryDependencies += "com.typesafe.akka" %% "akka-persistence-testkit" % AkkaVersion</code></pre></dd><dt>Maven</dt><dd><pre class="prettyprint"><code class="language-xml">&lt;properties&gt;
  &lt;scala.binary.version&gt;2.13&lt;/scala.binary.version&gt;
&lt;/properties&gt;
&lt;dependencyManagement&gt;
  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;com.typesafe.akka&lt;/groupId&gt;
      &lt;artifactId&gt;akka-bom_${scala.binary.version}&lt;/artifactId&gt;
      &lt;version&gt;2.7.0-M1&lt;/version&gt;
      &lt;type&gt;pom&lt;/type&gt;
      &lt;scope&gt;import&lt;/scope&gt;
    &lt;/dependency&gt
  &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;
&lt;dependencies&gt
  &lt;dependency&gt;
    &lt;groupId&gt;com.typesafe.akka&lt;/groupId&gt;
    &lt;artifactId&gt;akka-persistence-testkit_${scala.binary.version}&lt;/artifactId&gt;
  &lt;/dependency&gt
&lt;/dependencies&gt;</code></pre></dd><dt>Gradle</dt><dd><pre class="prettyprint"><code class="language-gradle">def versions = [
  ScalaBinary: "2.13"
]
dependencies {
  implementation platform("com.typesafe.akka:akka-bom_${versions.ScalaBinary}:2.7.0-M1")

  implementation "com.typesafe.akka:akka-persistence-testkit_${versions.ScalaBinary}"
}</code></pre></dd></dl>
<p>There are two testkit classes which have similar api:</p>
<ul>
  <li><span class="group-java"><a href="https://doc.akka.io/japi/akka/2.7/akka/persistence/testkit/javadsl/PersistenceTestKit.html" title="akka.persistence.testkit.javadsl.PersistenceTestKit"><code>PersistenceTestKit</code></a></span><span class="group-scala"><a href="https://doc.akka.io/api/akka/2.7/akka/persistence/testkit/scaladsl/PersistenceTestKit.html" title="akka.persistence.testkit.scaladsl.PersistenceTestKit"><code>PersistenceTestKit</code></a></span> class is for events</li>
  <li><span class="group-java"><a href="https://doc.akka.io/japi/akka/2.7/akka/persistence/testkit/javadsl/SnapshotTestKit.html" title="akka.persistence.testkit.javadsl.SnapshotTestKit"><code>SnapshotTestKit</code></a></span><span class="group-scala"><a href="https://doc.akka.io/api/akka/2.7/akka/persistence/testkit/scaladsl/SnapshotTestKit.html" title="akka.persistence.testkit.scaladsl.SnapshotTestKit"><code>SnapshotTestKit</code></a></span> class is for snapshots</li>
</ul>
<p>The testkit classes have two corresponding plugins which emulate the behavior of the storages: </p>
<ul>
  <li><span class="group-scala"><a href="https://doc.akka.io/api/akka/2.7/akka/persistence/testkit/PersistenceTestKitPlugin.html" title="akka.persistence.testkit.PersistenceTestKitPlugin"><code>PersistenceTestKitPlugin</code></a></span><span class="group-java"><a href="https://doc.akka.io/japi/akka/2.7/akka/persistence/testkit/PersistenceTestKitPlugin.html" title="akka.persistence.testkit.PersistenceTestKitPlugin"><code>PersistenceTestKitPlugin</code></a></span> class emulates a events storage</li>
  <li><span class="group-scala"><a href="https://doc.akka.io/api/akka/2.7/akka/persistence/testkit/PersistenceTestKitSnapshotPlugin.html" title="akka.persistence.testkit.PersistenceTestKitSnapshotPlugin"><code>PersistenceTestKitSnapshotPlugin</code></a></span><span class="group-java"><a href="https://doc.akka.io/japi/akka/2.7/akka/persistence/testkit/PersistenceTestKitSnapshotPlugin.html" title="akka.persistence.testkit.PersistenceTestKitSnapshotPlugin"><code>PersistenceTestKitSnapshotPlugin</code></a></span> class emulates a snapshots storage</li>
</ul>
<p><strong>Note!</strong> The corresponding plugins <strong>must</strong> be configured in the actor system which is used to initialize the particular testkit class:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.7.0-M1/akka-docs/src/test/scala/docs/persistence/testkit/Configuration.scala#L15-L22" target="_blank" title="Go to snippet source">source</a><code class="language-scala"><br/>val yourConfiguration = ConfigFactory.defaultApplication()

val system =
  ActorSystem(??? /*some behavior*/, &quot;test-system&quot;, PersistenceTestKitPlugin.config.withFallback(yourConfiguration))

val testKit = PersistenceTestKit(system)
</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.7.0-M1/akka-docs/src/test/java/jdocs/persistence/testkit/Configuration.java#L19-L29" target="_blank" title="Go to snippet source">source</a><code class="language-java">public class PersistenceTestKitConfig {

  Config conf =
      PersistenceTestKitPlugin.getInstance()
          .config()
          .withFallback(ConfigFactory.defaultApplication());

  ActorSystem&lt;Command&gt; system = ActorSystem.create(new SomeBehavior(), &quot;example&quot;, conf);

  PersistenceTestKit testKit = PersistenceTestKit.create(system);
}</code></pre></dd>
</dl>
<p>and</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.7.0-M1/akka-docs/src/test/scala/docs/persistence/testkit/Configuration.scala#L30-L39" target="_blank" title="Go to snippet source">source</a><code class="language-scala"><br/>val yourConfiguration = ConfigFactory.defaultApplication()

val system = ActorSystem(
  ??? /*some behavior*/,
  &quot;test-system&quot;,
  PersistenceTestKitSnapshotPlugin.config.withFallback(yourConfiguration))

val testKit = SnapshotTestKit(system)
</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.7.0-M1/akka-docs/src/test/java/jdocs/persistence/testkit/Configuration.java#L33-L43" target="_blank" title="Go to snippet source">source</a><code class="language-java">public class SnapshotTestKitConfig {

  Config conf =
      PersistenceTestKitSnapshotPlugin.getInstance()
          .config()
          .withFallback(ConfigFactory.defaultApplication());

  ActorSystem&lt;Command&gt; system = ActorSystem.create(new SomeBehavior(), &quot;example&quot;, conf);

  SnapshotTestKit testKit = SnapshotTestKit.create(system);
}</code></pre></dd>
</dl>
<p>A typical scenario is to create a persistent actor, send commands to it and check that it persists events as it is expected:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.7.0-M1/akka-docs/src/test/scala/docs/persistence/testkit/TestKitExamples.scala#L28-L63" target="_blank" title="Go to snippet source">source</a><code class="language-scala">import akka.actor.testkit.typed.scaladsl.ScalaTestWithActorTestKit
import akka.persistence.testkit.PersistenceTestKitPlugin
import akka.persistence.testkit.scaladsl.PersistenceTestKit

class PersistenceTestKitSampleSpec
    extends ScalaTestWithActorTestKit(PersistenceTestKitPlugin.config.withFallback(ConfigFactory.defaultApplication()))
    with AnyWordSpecLike
    with BeforeAndAfterEach {

  val persistenceTestKit = PersistenceTestKit(system)

  override def beforeEach(): Unit = {
    persistenceTestKit.clearAll()
  }

  &quot;Persistent actor&quot; should {

    &quot;persist all events&quot; in {

      val persistenceId = PersistenceId.ofUniqueId(&quot;your-persistence-id&quot;)
      val persistentActor = spawn(
        EventSourcedBehavior[Cmd, Evt, State](
          persistenceId,
          emptyState = State.empty,
          commandHandler = (_, cmd) =&gt; Effect.persist(Evt(cmd.data)),
          eventHandler = (state, evt) =&gt; state.updated(evt)))
      val cmd = Cmd(&quot;data&quot;)

      persistentActor ! cmd

      val expectedPersistedEvent = Evt(cmd.data)
      persistenceTestKit.expectNextPersisted(persistenceId.id, expectedPersistedEvent)
    }

  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.7.0-M1/akka-docs/src/test/java/jdocs/persistence/testkit/PersistenceTestKitSampleTest.java#L26-L124" target="_blank" title="Go to snippet source">source</a><code class="language-java">public class PersistenceTestKitSampleTest extends AbstractJavaTest {

  @ClassRule
  public static final TestKitJunitResource testKit =
      new TestKitJunitResource(
          PersistenceTestKitPlugin.getInstance()
              .config()
              .withFallback(ConfigFactory.defaultApplication()));

  PersistenceTestKit persistenceTestKit = PersistenceTestKit.create(testKit.system());

  @Before
  public void beforeEach() {
    persistenceTestKit.clearAll();
  }

  @Test
  public void test() {
    PersistenceId persistenceId = PersistenceId.ofUniqueId(&quot;some-id&quot;);
    ActorRef&lt;YourPersistentBehavior.Cmd&gt; ref =
        testKit.spawn(YourPersistentBehavior.create(persistenceId));

    YourPersistentBehavior.Cmd cmd = new YourPersistentBehavior.Cmd(&quot;data&quot;);
    ref.tell(cmd);
    YourPersistentBehavior.Evt expectedEventPersisted = new YourPersistentBehavior.Evt(cmd.data);

    persistenceTestKit.expectNextPersisted(persistenceId.id(), expectedEventPersisted);
  }
}

class YourPersistentBehavior
    extends EventSourcedBehavior&lt;
        YourPersistentBehavior.Cmd, YourPersistentBehavior.Evt, YourPersistentBehavior.State&gt; {

  static final class Cmd implements CborSerializable {

    public final String data;

    @JsonCreator
    public Cmd(String data) {
      this.data = data;
    }
  }

  static final class Evt implements CborSerializable {

    public final String data;

    @JsonCreator
    public Evt(String data) {
      this.data = data;
    }

    @Override
    public boolean equals(Object o) {
      if (this == o) return true;
      if (o == null || getClass() != o.getClass()) return false;

      Evt evt = (Evt) o;

      return data.equals(evt.data);
    }

    @Override
    public int hashCode() {
      return data.hashCode();
    }
  }

  static final class State implements CborSerializable {}

  static Behavior&lt;Cmd&gt; create(PersistenceId persistenceId) {
    return Behaviors.setup(context -&gt; new YourPersistentBehavior(persistenceId));
  }

  private YourPersistentBehavior(PersistenceId persistenceId) {
    super(persistenceId);
  }

  @Override
  public State emptyState() {
    // some state
    return new State();
  }

  @Override
  public CommandHandler&lt;Cmd, Evt, State&gt; commandHandler() {
    return newCommandHandlerBuilder()
        .forAnyState()
        .onCommand(Cmd.class, command -&gt; Effect().persist(new Evt(command.data)))
        .build();
  }

  @Override
  public EventHandler&lt;State, Evt&gt; eventHandler() {
    // TODO handle events
    return newEventHandlerBuilder().forAnyState().onEvent(Evt.class, (state, evt) -&gt; state).build();
  }
}</code></pre></dd>
</dl>
<p>You can safely use persistence testkit in combination with main akka testkit.</p>
<p>The main methods of the api allow to (see <span class="group-java"><a href="https://doc.akka.io/japi/akka/2.7/akka/persistence/testkit/javadsl/PersistenceTestKit.html" title="akka.persistence.testkit.javadsl.PersistenceTestKit"><code>PersistenceTestKit</code></a></span><span class="group-scala"><a href="https://doc.akka.io/api/akka/2.7/akka/persistence/testkit/scaladsl/PersistenceTestKit.html" title="akka.persistence.testkit.scaladsl.PersistenceTestKit"><code>PersistenceTestKit</code></a></span> and <span class="group-java"><a href="https://doc.akka.io/japi/akka/2.7/akka/persistence/testkit/javadsl/SnapshotTestKit.html" title="akka.persistence.testkit.javadsl.SnapshotTestKit"><code>SnapshotTestKit</code></a></span><span class="group-scala"><a href="https://doc.akka.io/api/akka/2.7/akka/persistence/testkit/scaladsl/SnapshotTestKit.html" title="akka.persistence.testkit.scaladsl.SnapshotTestKit"><code>SnapshotTestKit</code></a></span> for more details):</p>
<ul>
  <li>check if the given event/snapshot object is the next persisted in the storage.</li>
  <li>read a sequence of persisted events/snapshots.</li>
  <li>check that no events/snapshots have been persisted in the storage.</li>
  <li>throw the default exception from the storage on attempt to persist, read or delete the following event/snapshot.</li>
  <li>clear the events/snapshots persisted in the storage.</li>
  <li>reject the events, but not snapshots (rejections are not supported for snapshots in the original api).</li>
  <li>set your own <a href="#setting-your-own-policy-for-the-storage">policy</a> which emulates the work of the storage. Policy determines what to do when persistence needs to execute some operation on the storage (i.e. read, delete, etc.).</li>
  <li>get all the events/snapshots persisted in the storage</li>
  <li>put the events/snapshots in the storage to test recovery</li>
</ul>
<h4><a href="#setting-your-own-policy-for-the-storage" name="setting-your-own-policy-for-the-storage" class="anchor"><span class="anchor-link"></span></a>Setting your own policy for the storage</h4>
<p>You can implement and set your own policy for the storage to control its actions on particular operations, for example you can fail or reject events on your own conditions. Implement the <span class="group-scala"><a href="https://doc.akka.io/api/akka/2.7/akka/persistence/testkit/ProcessingPolicy.html" title="akka.persistence.testkit.ProcessingPolicy"><code>ProcessingPolicy[EventStorage.JournalOperation]</code></a></span><span class="group-java"><a href="https://doc.akka.io/japi/akka/2.7/akka/persistence/testkit/ProcessingPolicy.html" title="akka.persistence.testkit.ProcessingPolicy"><code>ProcessingPolicy&lt;EventStorage.JournalOperation&gt;</code></a></span> <span class="group-scala">trait</span><span class="group-java">interface</span> for event storage or <span class="group-scala"><a href="https://doc.akka.io/api/akka/2.7/akka/persistence/testkit/ProcessingPolicy.html" title="akka.persistence.testkit.ProcessingPolicy"><code>ProcessingPolicy[SnapshotStorage.SnapshotOperation]</code></a></span><span class="group-java"><a href="https://doc.akka.io/japi/akka/2.7/akka/persistence/testkit/ProcessingPolicy.html" title="akka.persistence.testkit.ProcessingPolicy"><code>ProcessingPolicy&lt;SnapshotStorage.SnapshotOperation&gt;</code></a></span> <span class="group-scala">trait</span><span class="group-java">interface</span> for snapshot storage, and set it with <code>withPolicy()</code> method.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.7.0-M1/akka-docs/src/test/scala/docs/persistence/testkit/TestKitExamples.scala#L122-L162" target="_blank" title="Go to snippet source">source</a><code class="language-scala">class PersistenceTestKitSampleSpecWithPolicy
    extends ScalaTestWithActorTestKit(PersistenceTestKitPlugin.config.withFallback(ConfigFactory.defaultApplication()))
    with AnyWordSpecLike
    with BeforeAndAfterEach {

  val persistenceTestKit = PersistenceTestKit(system)

  override def beforeEach(): Unit = {
    persistenceTestKit.clearAll()
    persistenceTestKit.resetPolicy()
  }

  &quot;Testkit policy&quot; should {

    &quot;fail all operations with custom exception&quot; in {
      val policy = new EventStorage.JournalPolicies.PolicyType {

        class CustomFailure extends RuntimeException

        override def tryProcess(persistenceId: String, processingUnit: JournalOperation): ProcessingResult =
          processingUnit match {
            case WriteEvents(_) =&gt; StorageFailure(new CustomFailure)
            case _              =&gt; ProcessingSuccess
          }
      }
      persistenceTestKit.withPolicy(policy)

      val persistenceId = PersistenceId.ofUniqueId(&quot;your-persistence-id&quot;)
      val persistentActor = spawn(
        EventSourcedBehavior[Cmd, Evt, State](
          persistenceId,
          emptyState = State.empty,
          commandHandler = (_, cmd) =&gt; Effect.persist(Evt(cmd.data)),
          eventHandler = (state, evt) =&gt; state.updated(evt)))

      persistentActor ! Cmd(&quot;data&quot;)
      persistenceTestKit.expectNothingPersisted(persistenceId.id)

    }
  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.7.0-M1/akka-docs/src/test/java/jdocs/persistence/testkit/PersistenceTestKitPolicySampleTest.java#L25-L67" target="_blank" title="Go to snippet source">source</a><code class="language-java">public class PersistenceTestKitPolicySampleTest extends AbstractJavaTest {

  @ClassRule
  public static final TestKitJunitResource testKit =
      new TestKitJunitResource(
          PersistenceTestKitPlugin.getInstance()
              .config()
              .withFallback(ConfigFactory.defaultApplication()));

  PersistenceTestKit persistenceTestKit = PersistenceTestKit.create(testKit.system());

  @Before
  public void beforeEach() {
    persistenceTestKit.clearAll();
    persistenceTestKit.resetPolicy();
  }

  @Test
  public void test() {
    SampleEventStoragePolicy policy = new SampleEventStoragePolicy();
    persistenceTestKit.withPolicy(policy);

    PersistenceId persistenceId = PersistenceId.ofUniqueId(&quot;some-id&quot;);
    ActorRef&lt;YourPersistentBehavior.Cmd&gt; ref =
        testKit.spawn(YourPersistentBehavior.create(persistenceId));

    YourPersistentBehavior.Cmd cmd = new YourPersistentBehavior.Cmd(&quot;data&quot;);
    ref.tell(cmd);

    persistenceTestKit.expectNothingPersisted(persistenceId.id());
  }

  static class SampleEventStoragePolicy implements ProcessingPolicy&lt;JournalOperation&gt; {
    @Override
    public ProcessingResult tryProcess(String processId, JournalOperation processingUnit) {
      if (processingUnit instanceof WriteEvents) {
        return StorageFailure.create();
      } else {
        return ProcessingSuccess.getInstance();
      }
    }
  }
}</code></pre></dd>
</dl>
<p><code>tryProcess()</code> method of the <span class="group-scala"><a href="https://doc.akka.io/api/akka/2.7/akka/persistence/testkit/ProcessingPolicy.html" title="akka.persistence.testkit.ProcessingPolicy"><code>ProcessingPolicy</code></a></span><span class="group-java"><a href="https://doc.akka.io/japi/akka/2.7/akka/persistence/testkit/ProcessingPolicy.html" title="akka.persistence.testkit.ProcessingPolicy"><code>ProcessingPolicy</code></a></span> has two arguments: persistence id and the storage operation. </p>
<p>Event storage has the following operations:</p>
<ul>
  <li><span class="group-scala"><a href="https://doc.akka.io/api/akka/2.7/akka/persistence/testkit/ReadEvents.html" title="akka.persistence.testkit.ReadEvents"><code>ReadEvents</code></a></span><span class="group-java"><a href="https://doc.akka.io/japi/akka/2.7/akka/persistence/testkit/ReadEvents.html" title="akka.persistence.testkit.ReadEvents"><code>ReadEvents</code></a></span> Read the events from the storage.</li>
  <li><span class="group-scala"><a href="https://doc.akka.io/api/akka/2.7/akka/persistence/testkit/WriteEvents.html" title="akka.persistence.testkit.WriteEvents"><code>WriteEvents</code></a></span><span class="group-java"><a href="https://doc.akka.io/japi/akka/2.7/akka/persistence/testkit/WriteEvents.html" title="akka.persistence.testkit.WriteEvents"><code>WriteEvents</code></a></span> Write the events to the storage.</li>
  <li><span class="group-scala"><a href="https://doc.akka.io/api/akka/2.7/akka/persistence/testkit/DeleteEvents.html" title="akka.persistence.testkit.DeleteEvents"><code>DeleteEvents</code></a></span><span class="group-java"><a href="https://doc.akka.io/japi/akka/2.7/akka/persistence/testkit/DeleteEvents.html" title="akka.persistence.testkit.DeleteEvents"><code>DeleteEvents</code></a></span> Delete the events from the storage.</li>
  <li><span class="group-scala"><a href="https://doc.akka.io/api/akka/2.7/akka/persistence/testkit/ReadSeqNum$.html" title="akka.persistence.testkit.ReadSeqNum"><code>ReadSeqNum</code></a></span><span class="group-java"><a href="https://doc.akka.io/japi/akka/2.7/akka/persistence/testkit/ReadSeqNum.html" title="akka.persistence.testkit.ReadSeqNum"><code>ReadSeqNum</code></a></span> Read the highest sequence number for particular persistence id.</li>
</ul>
<p>Snapshot storage has the following operations:</p>
<ul>
  <li><span class="group-scala"><a href="https://doc.akka.io/api/akka/2.7/akka/persistence/testkit/ReadSnapshot.html" title="akka.persistence.testkit.ReadSnapshot"><code>ReadSnapshot</code></a></span><span class="group-java"><a href="https://doc.akka.io/japi/akka/2.7/akka/persistence/testkit/ReadSnapshot.html" title="akka.persistence.testkit.ReadSnapshot"><code>ReadSnapshot</code></a></span> Read the snapshot from the storage.</li>
  <li><span class="group-scala"><a href="https://doc.akka.io/api/akka/2.7/akka/persistence/testkit/WriteSnapshot.html" title="akka.persistence.testkit.WriteSnapshot"><code>WriteSnapshot</code></a></span><span class="group-java"><a href="https://doc.akka.io/japi/akka/2.7/akka/persistence/testkit/WriteSnapshot.html" title="akka.persistence.testkit.WriteSnapshot"><code>WriteSnapshot</code></a></span> Writhe the snapshot to the storage.</li>
  <li><span class="group-scala"><a href="https://doc.akka.io/api/akka/2.7/akka/persistence/testkit/DeleteSnapshotsByCriteria.html" title="akka.persistence.testkit.DeleteSnapshotsByCriteria"><code>DeleteSnapshotsByCriteria</code></a></span><span class="group-java"><a href="https://doc.akka.io/japi/akka/2.7/akka/persistence/testkit/DeleteSnapshotsByCriteria.html" title="akka.persistence.testkit.DeleteSnapshotsByCriteria"><code>DeleteSnapshotsByCriteria</code></a></span> Delete snapshots in the storage by criteria.</li>
  <li><span class="group-scala"><a href="https://doc.akka.io/api/akka/2.7/akka/persistence/testkit/DeleteSnapshotByMeta.html" title="akka.persistence.testkit.DeleteSnapshotByMeta"><code>DeleteSnapshotByMeta</code></a></span><span class="group-java"><a href="https://doc.akka.io/japi/akka/2.7/akka/persistence/testkit/DeleteSnapshotByMeta.html" title="akka.persistence.testkit.DeleteSnapshotByMeta"><code>DeleteSnapshotByMeta</code></a></span> Delete particular snapshot from the storage by its metadata.</li>
</ul>
<p>The <code>tryProcess()</code> method must return one of the processing results:</p>
<ul>
  <li><span class="group-scala"><a href="https://doc.akka.io/api/akka/2.7/akka/persistence/testkit/ProcessingSuccess.html" title="akka.persistence.testkit.ProcessingSuccess"><code>ProcessingSuccess</code></a></span><span class="group-java"><a href="https://doc.akka.io/japi/akka/2.7/akka/persistence/testkit/ProcessingSuccess.html" title="akka.persistence.testkit.ProcessingSuccess"><code>ProcessingSuccess</code></a></span> Successful completion of the operation. All the events will be saved/read/deleted.</li>
  <li><span class="group-scala"><a href="https://doc.akka.io/api/akka/2.7/akka/persistence/testkit/StorageFailure.html" title="akka.persistence.testkit.StorageFailure"><code>StorageFailure</code></a></span><span class="group-java"><a href="https://doc.akka.io/japi/akka/2.7/akka/persistence/testkit/StorageFailure.html" title="akka.persistence.testkit.StorageFailure"><code>StorageFailure</code></a></span> Emulates exception from the storage.</li>
  <li><span class="group-scala"><a href="https://doc.akka.io/api/akka/2.7/akka/persistence/testkit/Reject.html" title="akka.persistence.testkit.Reject"><code>Reject</code></a></span><span class="group-java"><a href="https://doc.akka.io/japi/akka/2.7/akka/persistence/testkit/Reject.html" title="akka.persistence.testkit.Reject"><code>Reject</code></a></span> Emulates rejection from the storage.</li>
</ul>
<p><strong>Note</strong> that snapshot storage does not have rejections. If you return <code>Reject</code> in the <code>tryProcess()</code> of the snapshot storage policy, it will have the same effect as the <code>StorageFailure</code>.</p>
<p>Here is an example of the policy for an event storage:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.7.0-M1/akka-docs/src/test/scala/docs/persistence/testkit/TestKitExamples.scala#L67-L91" target="_blank" title="Go to snippet source">source</a><code class="language-scala">import akka.persistence.testkit._

class SampleEventStoragePolicy extends EventStorage.JournalPolicies.PolicyType {

  //you can use internal state, it does not need to be thread safe
  var count = 1

  override def tryProcess(persistenceId: String, processingUnit: JournalOperation): ProcessingResult =
    if (count &lt; 10) {
      count += 1
      //check the type of operation and react with success or with reject or with failure.
      //if you return ProcessingSuccess the operation will be performed, otherwise not.
      processingUnit match {
        case ReadEvents(batch) if batch.nonEmpty =&gt; ProcessingSuccess
        case WriteEvents(batch) if batch.size &gt; 1 =&gt;
          ProcessingSuccess
        case ReadSeqNum      =&gt; StorageFailure()
        case DeleteEvents(_) =&gt; Reject()
        case _               =&gt; StorageFailure()
      }
    } else {
      ProcessingSuccess
    }

}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.7.0-M1/akka-docs/src/test/java/jdocs/persistence/testkit/TestKitExamples.java#L26-L57" target="_blank" title="Go to snippet source">source</a><code class="language-java">class SampleEventStoragePolicy implements ProcessingPolicy&lt;JournalOperation&gt; {

  // you can use internal state, it does not need to be thread safe
  int count = 1;

  @Override
  public ProcessingResult tryProcess(String processId, JournalOperation processingUnit) {
    // check the type of operation and react with success or with reject or with failure.
    // if you return ProcessingSuccess the operation will be performed, otherwise not.
    if (count &lt; 10) {
      count += 1;
      if (processingUnit instanceof ReadEvents) {
        ReadEvents read = (ReadEvents) processingUnit;
        if (read.batch().nonEmpty()) {
          ProcessingSuccess.getInstance();
        } else {
          return StorageFailure.create();
        }
      } else if (processingUnit instanceof WriteEvents) {
        return ProcessingSuccess.getInstance();
      } else if (processingUnit instanceof DeleteEvents) {
        return ProcessingSuccess.getInstance();
      } else if (processingUnit.equals(ReadSeqNum.getInstance())) {
        return Reject.create();
      }
      // you can set your own exception
      return StorageFailure.create(new RuntimeException(&quot;your exception&quot;));
    } else {
      return ProcessingSuccess.getInstance();
    }
  }
}</code></pre></dd>
</dl>
<p>Here is an example of the policy for a snapshot storage:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.7.0-M1/akka-docs/src/test/scala/docs/persistence/testkit/TestKitExamples.scala#L95-L118" target="_blank" title="Go to snippet source">source</a><code class="language-scala">class SampleSnapshotStoragePolicy extends SnapshotStorage.SnapshotPolicies.PolicyType {

  //you can use internal state, it does not need to be thread safe
  var count = 1

  override def tryProcess(persistenceId: String, processingUnit: SnapshotOperation): ProcessingResult =
    if (count &lt; 10) {
      count += 1
      //check the type of operation and react with success or with reject or with failure.
      //if you return ProcessingSuccess the operation will be performed, otherwise not.
      processingUnit match {
        case ReadSnapshot(_, payload) if payload.nonEmpty =&gt;
          ProcessingSuccess
        case WriteSnapshot(meta, payload) if meta.sequenceNr &gt; 10 =&gt;
          ProcessingSuccess
        case DeleteSnapshotsByCriteria(_) =&gt; StorageFailure()
        case DeleteSnapshotByMeta(meta) if meta.sequenceNr &lt; 10 =&gt;
          ProcessingSuccess
        case _ =&gt; StorageFailure()
      }
    } else {
      ProcessingSuccess
    }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.7.0-M1/akka-docs/src/test/java/jdocs/persistence/testkit/TestKitExamples.java#L61-L92" target="_blank" title="Go to snippet source">source</a><code class="language-java">class SnapshotStoragePolicy implements ProcessingPolicy&lt;SnapshotOperation&gt; {

  // you can use internal state, it doesn&#39;t need to be thread safe
  int count = 1;

  @Override
  public ProcessingResult tryProcess(String processId, SnapshotOperation processingUnit) {
    // check the type of operation and react with success or with failure.
    // if you return ProcessingSuccess the operation will be performed, otherwise not.
    if (count &lt; 10) {
      count += 1;
      if (processingUnit instanceof ReadSnapshot) {
        ReadSnapshot read = (ReadSnapshot) processingUnit;
        if (read.getSnapshot().isPresent()) {
          ProcessingSuccess.getInstance();
        } else {
          return StorageFailure.create();
        }
      } else if (processingUnit instanceof WriteSnapshot) {
        return ProcessingSuccess.getInstance();
      } else if (processingUnit instanceof DeleteSnapshotsByCriteria) {
        return ProcessingSuccess.getInstance();
      } else if (processingUnit instanceof DeleteSnapshotByMeta) {
        return ProcessingSuccess.getInstance();
      }
      // you can set your own exception
      return StorageFailure.create(new RuntimeException(&quot;your exception&quot;));
    } else {
      return ProcessingSuccess.getInstance();
    }
  }
}</code></pre></dd>
</dl>
<h3><a href="#configuration-of-persistence-testkit" name="configuration-of-persistence-testkit" class="anchor"><span class="anchor-link"></span></a>Configuration of Persistence TestKit</h3>
<p>There are several configuration properties for persistence testkit, please refer to the <a href="../general/configuration-reference.html#config-akka-persistence-testkit">reference configuration</a></p>
<h2><a href="#integration-testing" name="integration-testing" class="anchor"><span class="anchor-link"></span></a>Integration testing</h2>
<p><code>EventSourcedBehavior</code> actors can be tested with the <a href="testing-async.html">ActorTestKit</a> together with other actors. The in-memory journal and snapshot storage from the <a href="persistence-testing.html#persistence-testkit">Persistence TestKit</a> can be used also for integration style testing of a single <code>ActorSystem</code>, for example when using Cluster Sharding with a single Cluster node.</p>
<p>For tests that involve more than one Cluster node you have to use another journal and snapshot store. While it&rsquo;s possible to use the <a href="../persistence-plugins.html#persistence-plugin-proxy">Persistence Plugin Proxy</a> it&rsquo;s often better and more realistic to use a real database.</p>
<p>The <a href="../project/examples.html#cqrs">CQRS example</a> includes tests that are using Akka Persistence Cassandra.</p>
<h3><a href="#plugin-initialization" name="plugin-initialization" class="anchor"><span class="anchor-link"></span></a>Plugin initialization</h3>
<p>Some Persistence plugins create tables automatically, but has the limitation that it can&rsquo;t be done concurrently from several ActorSystems. That can be a problem if the test creates a Cluster and all nodes tries to initialize the plugins at the same time. To coordinate initialization you can use the <code>PersistenceInit</code> utility.</p>
<p><code>PersistenceInit</code> is part of <code>akka-persistence-testkit</code> and you need to add the dependency to your project:</p><dl class="dependency"><dt>sbt</dt><dd><pre class="prettyprint"><code class="language-scala">val AkkaVersion = "2.7.0-M1"
libraryDependencies += "com.typesafe.akka" %% "akka-persistence-testkit" % AkkaVersion</code></pre></dd><dt>Maven</dt><dd><pre class="prettyprint"><code class="language-xml">&lt;properties&gt;
  &lt;scala.binary.version&gt;2.13&lt;/scala.binary.version&gt;
&lt;/properties&gt;
&lt;dependencyManagement&gt;
  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;com.typesafe.akka&lt;/groupId&gt;
      &lt;artifactId&gt;akka-bom_${scala.binary.version}&lt;/artifactId&gt;
      &lt;version&gt;2.7.0-M1&lt;/version&gt;
      &lt;type&gt;pom&lt;/type&gt;
      &lt;scope&gt;import&lt;/scope&gt;
    &lt;/dependency&gt
  &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;
&lt;dependencies&gt
  &lt;dependency&gt;
    &lt;groupId&gt;com.typesafe.akka&lt;/groupId&gt;
    &lt;artifactId&gt;akka-persistence-testkit_${scala.binary.version}&lt;/artifactId&gt;
  &lt;/dependency&gt
&lt;/dependencies&gt;</code></pre></dd><dt>Gradle</dt><dd><pre class="prettyprint"><code class="language-gradle">def versions = [
  ScalaBinary: "2.13"
]
dependencies {
  implementation platform("com.typesafe.akka:akka-bom_${versions.ScalaBinary}:2.7.0-M1")

  implementation "com.typesafe.akka:akka-persistence-testkit_${versions.ScalaBinary}"
}</code></pre></dd></dl>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.7.0-M1/akka-docs/src/test/scala/docs/persistence/testkit/PersistenceInitSpec.scala#L14-L19" target="_blank" title="Go to snippet source">source</a><code class="language-scala">import akka.persistence.testkit.scaladsl.PersistenceInit

import scala.concurrent.Await
import scala.concurrent.Future
import scala.concurrent.duration._

val timeout = 5.seconds
val done: Future[Done] = PersistenceInit.initializeDefaultPlugins(system, timeout)
Await.result(done, timeout)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka/tree/v2.7.0-M1/akka-docs/src/test/java/jdocs/persistence/testkit/PersistenceInitTest.java#L17-L23" target="_blank" title="Go to snippet source">source</a><code class="language-java">import akka.persistence.testkit.javadsl.PersistenceInit;
import akka.Done;

import java.time.Duration;
import java.util.concurrent.CompletionStage;
import java.util.concurrent.TimeUnit;

Duration timeout = Duration.ofSeconds(5);
CompletionStage&lt;Done&gt; done =
    PersistenceInit.initializeDefaultPlugins(testKit.system(), timeout);
done.toCompletableFuture().get(timeout.getSeconds(), TimeUnit.SECONDS);</code></pre></dd>
</dl>
</div>
</article>
<div class="row">
<div class="small-12 column">
<section class="nav-prev-next row">
<div class="nav-prev small-6 column">
<a href="../typed/persistence-snapshot.html"><i class="icon-prev"></i> <span class="link-prev">Snapshotting</span></a>
</div>
<div class="nav-next small-6 column clearfix">
<a class="float-right" href="../typed/persistence-fsm.html">EventSourced behaviors as finite state machines <i class="icon-next"></i></a>
</div>
</section>
</div>
</div>
<div class="source-github row">
Found an error in this documentation? The source code for this page can be found <a href="https://github.com/akka/akka/tree/v2.7.0-M1/akka-docs/src/main/paradox/typed/persistence-testing.md">here</a>.
Please feel free to edit and contribute a pull request.
</div>

<footer class="page-footer row clearfix">
<img class="akka-icon float-left show-for-medium" src="../images/akka-icon.svg" />
<section class="copyright">
<p class="legal">
&copy; 2011-2022 <a href="https://www.lightbend.com" target="_blank">Lightbend, Inc.</a> |
<a href="https://www.lightbend.com/legal/licenses" target="_blank">Licenses</a> |
<a href="https://www.lightbend.com/legal/terms" target="_blank">Terms</a> |
<a href="https://www.lightbend.com/legal/privacy" target="_blank">Privacy Policy</a> |
<a href="https://akka.io/cookie/" target="_blank">Cookie Listing</a> |
<a class="optanon-toggle-display">Cookie Settings</a>
</p>
</section>

</footer>
</section>
</main>
</div>

<script type="text/javascript" src="../js/scrollsneak.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../js/groups.js"></script>
<script type="text/javascript" src="../js/page.js"></script>
<script type="text/javascript" src="../js/snippets.js"></script>
<script type="text/javascript" src="../js/magellan.js"></script>
<script type="text/javascript" src="../js/metadata-toggle.js"></script>
<script type="text/javascript" src="../js/lbHeader.js"></script>

<style type="text/css">@import "../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(){window.prettyPrint && prettyPrint()});
//]]></script>
<!-- Algolia docs search -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.js"></script>
<style>.algolia-autocomplete { display: block !important }</style>
<script type="text/javascript">
docsearch({
apiKey: '543bad5ad786495d9ccd445ed34ed082',
indexName: 'akka_io',
inputSelector: '#search',
algoliaOptions: {
hitsPerPage: 5
}
});

docsearch({
apiKey: '543bad5ad786495d9ccd445ed34ed082',
indexName: 'akka_io',
inputSelector: '#overlay-search',
algoliaOptions: {
hitsPerPage: 5
}
});

// set up "/" as global shortcut for focusing on search
jQuery(document).keypress(function (event) {
if (event.keyCode == 47) {
jQuery("#search").focus();
return false; // swallow key event, otherwise the / char would be input into the search box
}
});
</script>

<script type="text/javascript" src="../assets/js/warnOldDocs.js"></script>
<script type="text/javascript" src="../assets/js/scalafiddle.js"></script>


</body>
</html>
