<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Journal plugin &bull; Akka Persistence Couchbase Documentation</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="Akka Persistence Couchbase"/>
<script type="text/javascript" src="lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="lib/foundation/dist/js/foundation.min.js"></script>
<link rel="stylesheet" type="text/css" href="lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="lib/foundation/dist/css/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" type="text/css" href="css/icons.css"/>
<link rel="stylesheet" type="text/css" href="css/page.css"/>
<link rel="shortcut icon" href="images/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
<link rel="manifest" href="images/manifest.json">
<meta name="msapplication-TileImage" content="images/mstile-150x150.png">
<meta name="msapplication-TileColor" content="#15a9ce">
<meta name="theme-color" content="#15a9ce">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) start -->
<script src="https://optanon.blob.core.windows.net/consent/159bb13d-6748-4399-806e-ac28db879785.js" type="text/javascript" charset="UTF-8"></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) end -->
<!--Google Analytics-->
<script type="text/plain" class="optanon-category-2">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', '']);
_gaq.push(['_setDomainName', '']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})()
</script>
<script type="text/plain" class="optanon-category-2">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-23127719-1', 'lightbend.com', {'allowLinker': true, 'name': 'tsTracker'});
ga('tsTracker.require', 'linker');
ga('tsTracker.linker:autoLink', ['lightbend.com','playframework.com','scala-lang.org','scaladays.org','spray.io','akka.io','scala-sbt.org','scala-ide.org']);
ga('tsTracker.send', 'pageview');
</script>
<!--Marketo-->
<script type="text/plain" class="optanon-category-3">
(function() {
var didInit = false;
function initMunchkin() {
if(didInit === false) {
didInit = true;
Munchkin.init('558-NCX-702', { 'asyncOnly': true, 'disableClickDelay': true });
}
}
var s = document.createElement('script');
s.type = 'text/javascript';
s.async = true;
s.src = '//munchkin.marketo.net/munchkin.js';
s.onreadystatechange = function() {
if (this.readyState == 'complete' || this.readyState == 'loaded') {
initMunchkin();
}
};
s.onload = initMunchkin;
document.getElementsByTagName('head')[0].appendChild(s);
})();
</script>
</head>

<body id="underlay" data-toggler="nav-open">

<header class="site-header hide-for-large">
<div class="sticky-header clearfix">
<a href="https://akka.io"><img class="logo" src="images/akka-logo-reverse.svg"></a>

<button class="menu-icon float-right" type="button" data-toggle="underlay overlay"></button>
</div>
<div id="overlay" class="overlay-nav" data-toggler="nav-open">
<header class="nav-header">
<div class="nav-header-title">
<h1><a href="index.html">Akka Persistence Couchbase Documentation</a></h1>
</div>
<div class="nav-header-version">
Version 1.0-RC2
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="nav-toc">
<ul>
  <li><a href="overview.html" class="page">Overview</a></li>
  <li><a href="getting-started.html" class="page">Getting Started</a></li>
  <li><a href="journal.html#journal-plugin" class="active page">Journal plugin</a>
  <ul>
    <li><a href="journal.html#features" class="header">Features</a></li>
    <li><a href="journal.html#configuration" class="header">Configuration</a></li>
    <li><a href="journal.html#schema" class="header">Schema</a></li>
    <li><a href="journal.html#caveats" class="header">Caveats</a></li>
  </ul></li>
  <li><a href="read-journal.html" class="page">Query Plugin</a></li>
  <li><a href="snapshots.html" class="page">Snapshot plugin</a></li>
  <li><a href="serialization.html" class="page">Serialization</a></li>
  <li><a href="lagom-persistent-entity.html" class="page">Lagom: Persistent Entities</a></li>
  <li><a href="lagom-read-side.html" class="page">Lagom: Read-Side support</a></li>
  <li><a href="developing.html" class="page">Developing the plugins</a></li>
</ul>
</nav>
</div>
</header>

<aside class="show-for-large">
<header class="nav-header fixed-sidebar-header">
<div class="nav-header-title">
<h1><a href="index.html">Akka Persistence Couchbase Documentation</a></h1>
</div>
<div class="nav-header-version">
Version 1.0-RC2
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="site-nav fixed-sidebar-contents">
<div class="nav-toc">
<ul>
  <li><a href="overview.html" class="page">Overview</a></li>
  <li><a href="getting-started.html" class="page">Getting Started</a></li>
  <li><a href="journal.html#journal-plugin" class="active page">Journal plugin</a>
  <ul>
    <li><a href="journal.html#features" class="header">Features</a></li>
    <li><a href="journal.html#configuration" class="header">Configuration</a></li>
    <li><a href="journal.html#schema" class="header">Schema</a></li>
    <li><a href="journal.html#caveats" class="header">Caveats</a></li>
  </ul></li>
  <li><a href="read-journal.html" class="page">Query Plugin</a></li>
  <li><a href="snapshots.html" class="page">Snapshot plugin</a></li>
  <li><a href="serialization.html" class="page">Serialization</a></li>
  <li><a href="lagom-persistent-entity.html" class="page">Lagom: Persistent Entities</a></li>
  <li><a href="lagom-read-side.html" class="page">Lagom: Read-Side support</a></li>
  <li><a href="developing.html" class="page">Developing the plugins</a></li>
</ul>
</div>
</nav>
<footer class="nav-footer fixed-sidebar-footer">
<a href="https://akka.io"><img class="logo" src="images/akka-logo-reverse.svg"></a>

</footer>
</aside>

<main class="fixed-shift-for-large expanded row">
<section class="site-content small-12 column">

<article class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h1><a href="#journal-plugin" name="journal-plugin" class="anchor"><span class="anchor-link"></span></a>Journal plugin</h1>
<h2><a href="#features" name="features" class="anchor"><span class="anchor-link"></span></a>Features</h2>
<ul>
  <li>All operations required by the <a href="https://doc.akka.io/docs/akka/current/persistence-journals.html#journal-plugin-api">Akka Persistence journal plugin API</a> are fully supported.</li>
  <li>The plugin uses Couchbase in a mostly log-oriented way i.e. data are only ever inserted but never updated  (deletions are made on user request only). The exception is event metadata on deletion.</li>
  <li>Writes of messages are batched to optimize throughput for persistAsync. See  <a href="https://doc.akka.io/docs/akka/current/persistence.html#batch-writes">batch writes</a> for details how to configure batch sizes.</li>
</ul>
<h2><a href="#configuration" name="configuration" class="anchor"><span class="anchor-link"></span></a>Configuration</h2>
<p>For setting up the project to use the plugin, and preparing the couchbase bucket, see <a href="getting-started.html">Getting Started</a></p>
<p>Enable one or more of the plugins in <code>application.conf</code> and configure the cluster connection details:</p>
<pre class="prettyprint"><code class="language-hocon">akka.persistence.journal.plugin = &quot;couchbase-journal.write&quot;

couchbase-journal {
  connection {
    nodes = [&quot;192.168.0.2&quot;, &quot;192.168.0.3&quot;, &quot;192.168.0.4&quot;] # if left empty defaults to [ &quot;localhost&quot; ]
    username = &quot;scott&quot;
    password = &quot;tiger&quot;
  }
}
</code></pre>
<p>See <a href="https://github.com/akka/akka-persistence-couchbase/blob/master/core/src/main/resources/reference.conf">reference.conf</a> for complete configuration option docs and defaults. </p>
<h2><a href="#schema" name="schema" class="anchor"><span class="anchor-link"></span></a>Schema</h2>
<p>The events are stored in documents containing one or more atomically written events for the same persistence id with a document id consisting of the persistence id and the lowest sequence number from the messages list.</p>
<p>The structure of the document is like this:</p>
<pre class="prettyprint"><code class="language-js"> {
   &quot;type&quot;: &quot;journal_message&quot;,
   &quot;persistence_id&quot;: &quot;p2&quot;, 
   // these are unique per actor instance making it possible to detect if there are concurrent
   // writers because of a network partition for example
   &quot;writer_uuid&quot;: &quot;d61a4212-518a-4f75-8f27-2150f56ae60f&quot;, 
   // one or more events, more than one in the case of an atomic batched write
   &quot;messages&quot;: [
     {
       &quot;sequence_nr&quot;: 1,    // the sequence number of the event 
       &quot;ser_id&quot;: 1,         // id of the serializer that was used for the payload
       &quot;ser_manifest&quot;: &quot;&quot;,  // potentially a manifest for the object from the serializer
       // either of these two next fields depending on if the serializer is a regular binary one - base64 encoded string
       // containing the raw serialized bytes
       &quot;payload_bin&quot;: &quot;rO0ABXQACHAyLWV2dC0x&quot;,
       // or native json if using a `akka.persistence.couchbase.JsonSerializer` (see serialization section of docs)
       &quot;payload&quot;: { json-for-event },
       // these next three fields are only present if the event was tagged
       &quot;tags&quot;: [ &quot;tag1&quot;, &quot;tag2&quot; ],
       &quot;tag-seq-nrs&quot;: {
         &quot;tag1&quot;: 5,
         &quot;tag2&quot;: 1
       },
       // the format of the data is the time based UUID represented as (time in utc)
       // [YYYY]-[MM]-[DD]T[HH]:[mm]:[ss]:[nanoOfSecond]_[lsb-unsigned-long-as-space-padded-string]
       // see akka.persistence.couchbase.internal.TimeBasedUUIDSerialization
       // which makes it possible to sort as a string field and get the same order as sorting the actual time based UUIDs
       &quot;ordering&quot;: &quot;1582-10-16T18:52:02.434002368_ 7093823767347982046&quot;
     }
   ]
 }
</code></pre>
<p>Additionally if event deletion is performed this results in a metadata document identified by <code>[persistenceId]-metadata</code></p>
<pre class="prettyprint"><code class="language-js"> {
   &quot;type&quot;: &quot;journal_metadata&quot;,
   &quot;deleted_to&quot;: 123 // events deleted up to this sequence number
 }
</code></pre>
<h2><a href="#caveats" name="caveats" class="anchor"><span class="anchor-link"></span></a>Caveats</h2>
<ul>
  <li>Deletion does not actually remove elements from the database, just mark them deleted with metadata since events by tag  is expected to return deleted events. To actually reclaim storage space additional event deletion has to be  done.</li>
</ul>
</div>
</article>

<div class="row">
<div class="small-12 large-9 column">
<section class="nav-prev-next row">
<div class="nav-prev small-6 column">
<a href="getting-started.html"><i class="icon-prev"></i> <span class="link-prev">Getting Started</span></a>
</div>
<div class="nav-next small-6 column clearfix">
<a class="float-right" href="read-journal.html">Query Plugin <i class="icon-next"></i></a>
</div>
</section>
</div>
</div>

<div class="source-github row">
Found an error in this documentation? The source code for this page can be found <a href="https://github.com/akka/akka-persistence-couchbase/tree/v1.0-RC2/docs/src/main/paradox/journal.md">here</a>.
Please feel free to edit and contribute a pull request.
</div>


<footer class="page-footer row clearfix">
<img class="akka-icon float-left show-for-medium" src="images/akka-icon.svg">
<section class="copyright">
<div>Akka Persistence Couchbase is Open Source and available under the Apache 2 License.</div>
<p class="legal">
&copy; 2011-2019 <a href="https://www.lightbend.com" target="_blank">Lightbend, Inc.</a> | 
<a href="https://www.lightbend.com/legal/licenses" target="_blank">Licenses</a> | 
<a href="https://www.lightbend.com/legal/terms" target="_blank">Terms</a> | 
<a href="https://www.lightbend.com/legal/privacy" target="_blank">Privacy Policy</a> | 
<a href="https://akka.io/cookie/" target="_blank">Cookie Listing</a> | 
<a class="optanon-toggle-display">Cookie Settings</a>
</p>
</section>
</footer>

</section>
</main>

<script type="text/javascript" src="js/scrollsneak.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="js/groups.js"></script>
<script type="text/javascript" src="js/page.js"></script>
<script type="text/javascript" src="js/magellan.js"></script>

<style type="text/css">@import "lib/prettify/prettify.css";</style>
<script type="text/javascript" src="lib/prettify/prettify.js"></script>
<script type="text/javascript" src="lib/prettify/lang-scala.js"></script>
<script type="text/javascript">jQuery(function(){window.prettyPrint && prettyPrint()});</script>

<!-- hook for including project specific javascript into the generated docs -->

</body>
</html>
