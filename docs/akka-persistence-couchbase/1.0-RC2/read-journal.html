<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Query Plugin &bull; Akka Persistence Couchbase Documentation</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="Akka Persistence Couchbase"/>
<script type="text/javascript" src="lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="lib/foundation/dist/js/foundation.min.js"></script>
<link rel="stylesheet" type="text/css" href="lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="lib/foundation/dist/css/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" type="text/css" href="css/icons.css"/>
<link rel="stylesheet" type="text/css" href="css/page.css"/>
<link rel="shortcut icon" href="images/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
<link rel="manifest" href="images/manifest.json">
<meta name="msapplication-TileImage" content="images/mstile-150x150.png">
<meta name="msapplication-TileColor" content="#15a9ce">
<meta name="theme-color" content="#15a9ce">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) start -->
<script src="https://optanon.blob.core.windows.net/consent/159bb13d-6748-4399-806e-ac28db879785.js" type="text/javascript" charset="UTF-8"></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) end -->
<!--Google Analytics-->
<script type="text/plain" class="optanon-category-2">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', '']);
_gaq.push(['_setDomainName', '']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})()
</script>
<script type="text/plain" class="optanon-category-2">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-23127719-1', 'lightbend.com', {'allowLinker': true, 'name': 'tsTracker'});
ga('tsTracker.require', 'linker');
ga('tsTracker.linker:autoLink', ['lightbend.com','playframework.com','scala-lang.org','scaladays.org','spray.io','akka.io','scala-sbt.org','scala-ide.org']);
ga('tsTracker.send', 'pageview');
</script>
<!--Marketo-->
<script type="text/plain" class="optanon-category-3">
(function() {
var didInit = false;
function initMunchkin() {
if(didInit === false) {
didInit = true;
Munchkin.init('558-NCX-702', { 'asyncOnly': true, 'disableClickDelay': true });
}
}
var s = document.createElement('script');
s.type = 'text/javascript';
s.async = true;
s.src = '//munchkin.marketo.net/munchkin.js';
s.onreadystatechange = function() {
if (this.readyState == 'complete' || this.readyState == 'loaded') {
initMunchkin();
}
};
s.onload = initMunchkin;
document.getElementsByTagName('head')[0].appendChild(s);
})();
</script>
</head>

<body id="underlay" data-toggler="nav-open">

<header class="site-header hide-for-large">
<div class="sticky-header clearfix">
<a href="https://akka.io"><img class="logo" src="images/akka-logo-reverse.svg"></a>

<button class="menu-icon float-right" type="button" data-toggle="underlay overlay"></button>
</div>
<div id="overlay" class="overlay-nav" data-toggler="nav-open">
<header class="nav-header">
<div class="nav-header-title">
<h1><a href="index.html">Akka Persistence Couchbase Documentation</a></h1>
</div>
<div class="nav-header-version">
Version 1.0-RC2
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="nav-toc">
<ul>
  <li><a href="overview.html" class="page">Overview</a></li>
  <li><a href="getting-started.html" class="page">Getting Started</a></li>
  <li><a href="journal.html" class="page">Journal plugin</a></li>
  <li><a href="read-journal.html#query-plugin" class="active page">Query Plugin</a>
  <ul>
    <li><a href="read-journal.html#features" class="header">Features</a></li>
    <li><a href="read-journal.html#configuration" class="header">Configuration</a></li>
    <li><a href="read-journal.html#persistence-ids" class="header">Persistence IDs</a></li>
    <li><a href="read-journal.html#events-by-persistence-id" class="header">Events by Persistence ID</a></li>
    <li><a href="read-journal.html#events-by-tag" class="header">Events by Tag</a></li>
    <li><a href="read-journal.html#caveats" class="header">Caveats</a></li>
  </ul></li>
  <li><a href="snapshots.html" class="page">Snapshot plugin</a></li>
  <li><a href="serialization.html" class="page">Serialization</a></li>
  <li><a href="lagom-persistent-entity.html" class="page">Lagom: Persistent Entities</a></li>
  <li><a href="lagom-read-side.html" class="page">Lagom: Read-Side support</a></li>
  <li><a href="developing.html" class="page">Developing the plugins</a></li>
</ul>
</nav>
</div>
</header>

<aside class="show-for-large">
<header class="nav-header fixed-sidebar-header">
<div class="nav-header-title">
<h1><a href="index.html">Akka Persistence Couchbase Documentation</a></h1>
</div>
<div class="nav-header-version">
Version 1.0-RC2
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="site-nav fixed-sidebar-contents">
<div class="nav-toc">
<ul>
  <li><a href="overview.html" class="page">Overview</a></li>
  <li><a href="getting-started.html" class="page">Getting Started</a></li>
  <li><a href="journal.html" class="page">Journal plugin</a></li>
  <li><a href="read-journal.html#query-plugin" class="active page">Query Plugin</a>
  <ul>
    <li><a href="read-journal.html#features" class="header">Features</a></li>
    <li><a href="read-journal.html#configuration" class="header">Configuration</a></li>
    <li><a href="read-journal.html#persistence-ids" class="header">Persistence IDs</a></li>
    <li><a href="read-journal.html#events-by-persistence-id" class="header">Events by Persistence ID</a></li>
    <li><a href="read-journal.html#events-by-tag" class="header">Events by Tag</a></li>
    <li><a href="read-journal.html#caveats" class="header">Caveats</a></li>
  </ul></li>
  <li><a href="snapshots.html" class="page">Snapshot plugin</a></li>
  <li><a href="serialization.html" class="page">Serialization</a></li>
  <li><a href="lagom-persistent-entity.html" class="page">Lagom: Persistent Entities</a></li>
  <li><a href="lagom-read-side.html" class="page">Lagom: Read-Side support</a></li>
  <li><a href="developing.html" class="page">Developing the plugins</a></li>
</ul>
</div>
</nav>
<footer class="nav-footer fixed-sidebar-footer">
<a href="https://akka.io"><img class="logo" src="images/akka-logo-reverse.svg"></a>

</footer>
</aside>

<main class="fixed-shift-for-large expanded row">
<section class="site-content small-12 column">

<article class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h1><a href="#query-plugin" name="query-plugin" class="anchor"><span class="anchor-link"></span></a>Query Plugin</h1>
<h2><a href="#features" name="features" class="anchor"><span class="anchor-link"></span></a>Features</h2>
<p>The query plugin provides all the Akka Persistence Query <a href="https://doc.akka.io/docs/akka/current/persistence-query.html#readjournal-plugin-api">Read Journal plugin APIs</a>:</p>
<ul>
  <li><code>PersistenceIdsQuery</code> and <code>CurrentPersistenceIdsQuery</code> for querying and following what persistence ids exist in the journal</li>
  <li><code>CurrentEventsByPersistenceIdQuery</code> and <code>EventsByPersistenceIdQuery</code> for querying and following events from a specific persistent actor</li>
  <li><code>CurrentEventsByTagQuery</code> and <code>EventsByTagQuery</code> for querying and following tagged events</li>
</ul>
<h2><a href="#configuration" name="configuration" class="anchor"><span class="anchor-link"></span></a>Configuration</h2>
<p>For setting up the project to use the plugin, and preparing the couchbase bucket, see <a href="getting-started.html">Getting Started</a> and especially the tag-related queries if you intend to use the tagging queries.</p>
<p>Accessing the (default) read journal can be done through an extension</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka-persistence-couchbase/tree/v1.0-RC2/core/src/test/scala/akka/persistence/couchbase/scaladsl/AbstractCouchbaseSpec.scala#L79-L80" target="_blank" title="Go to snippet source"></a><code class="language-scala">val queries: CouchbaseReadJournal =
  PersistenceQuery(system).readJournalFor[CouchbaseReadJournal](CouchbaseReadJournal.Identifier)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka-persistence-couchbase/tree/v1.0-RC2/core/src/test/java/akka/persistence/couchbase/javadsl/CouchbaseReadJournalTest.java#L75-L76" target="_blank" title="Go to snippet source"></a><code class="language-java">queries = PersistenceQuery.get(system)
    .getReadJournalFor(CouchbaseReadJournal.class, CouchbaseReadJournal.Identifier());</code></pre></dd>
</dl>
<p>The connection settings are shared with the journal plugin, see <a href="journal.html">Journal</a>. </p>
<p>See <a href="https://github.com/akka/akka-persistence-couchbase/blob/master/core/src/main/resources/reference.conf">reference.conf</a> for complete configuration option docs and defaults.</p>
<h2><a href="#persistence-ids" name="persistence-ids" class="anchor"><span class="anchor-link"></span></a>Persistence IDs</h2>
<p>The persistence ids are delivered in no specific order, there is no guarantee that two calls will result in the same order of persistence ids. A single persistence id will only ever be in the result stream once. Newly written ids may not immediately be visible (see caveat about eventual consistency below). </p>
<h2><a href="#events-by-persistence-id" name="events-by-persistence-id" class="anchor"><span class="anchor-link"></span></a>Events by Persistence ID</h2>
<p>The events by persistence id query streams all events for a given persistence id in the order they were written (guaranteed by the sequence numbering of events per persistent actor). Newly written events may not be immediately visible in Couchbase (see caveat about eventual consistency below)</p>
<h2><a href="#events-by-tag" name="events-by-tag" class="anchor"><span class="anchor-link"></span></a>Events by Tag</h2>
<p>The event by tag stream is globally sorted using a time based UUID, this means it is very important that the Akka nodes are kept in tight clock sync. </p>
<h3><a href="#eventual-consistency" name="eventual-consistency" class="anchor"><span class="anchor-link"></span></a>Eventual Consistency</h3>
<p>Even with clocks in sync, writing to different nodes of the couchbase cluster could mean that the change reaches the query index out of order, to protect against missing events because of this or small clock skew the queries will never read the latest events but only up to a point in time a little while ago giving better chance that the index is consistent with the written data.</p>
<p>The offset back in time is configured through the setting <code>couchbase-journal.read.events-by-tag.eventual-consistency-delay</code>. By default it is set to 5 seconds, this means that at any time a query is performed it will only see events up until 5 seconds ago. For the live query it will keep catching up to 5 seconds ago as time passes by. </p>
<p>If the <code>eventual-consistency-delay</code> is tuned too low or clock skew larger than it happens it could mean that tagged events are seen out of order, to detect this the tagged events have a gap free sequence number per persistence id, when streaming events and an out of order event is detected the stream is failed with an <code>akka.persistence.couchbase.OutOfOrderEventException</code>.</p>
<p>In a scenario where a projection is created from the streamed events this could mean the projection needs to be discarded and recreated.</p>
<h3><a href="#events-by-tag-offsets" name="events-by-tag-offsets" class="anchor"><span class="anchor-link"></span></a>Events by tag offsets</h3>
<p>The event by tag stream supports using <code>akka.persistence.query.TimeBasedUUID</code>s to offset into stream of tagged events, for example to follow a stream and update a projection. Sequence numbers for offsets are not supported.</p>
<p>Offsets can be created from unix timestamps using <code>akka.persistence.couchbase.UUIDs.timeBasedUUIDFrom(unixTimestampMs)</code>.</p>
<h2><a href="#caveats" name="caveats" class="anchor"><span class="anchor-link"></span></a>Caveats</h2>
<ul>
  <li>As the indexes used to perform the queries are eventually consistent (even for a single writer node) there  is no guarantee that an immediate query will see the latest writes.</li>
</ul>
</div>
</article>

<div class="row">
<div class="small-12 large-9 column">
<section class="nav-prev-next row">
<div class="nav-prev small-6 column">
<a href="journal.html"><i class="icon-prev"></i> <span class="link-prev">Journal plugin</span></a>
</div>
<div class="nav-next small-6 column clearfix">
<a class="float-right" href="snapshots.html">Snapshot plugin <i class="icon-next"></i></a>
</div>
</section>
</div>
</div>

<div class="source-github row">
Found an error in this documentation? The source code for this page can be found <a href="https://github.com/akka/akka-persistence-couchbase/tree/v1.0-RC2/docs/src/main/paradox/read-journal.md">here</a>.
Please feel free to edit and contribute a pull request.
</div>


<footer class="page-footer row clearfix">
<img class="akka-icon float-left show-for-medium" src="images/akka-icon.svg">
<section class="copyright">
<div>Akka Persistence Couchbase is Open Source and available under the Apache 2 License.</div>
<p class="legal">
&copy; 2011-2019 <a href="https://www.lightbend.com" target="_blank">Lightbend, Inc.</a> | 
<a href="https://www.lightbend.com/legal/licenses" target="_blank">Licenses</a> | 
<a href="https://www.lightbend.com/legal/terms" target="_blank">Terms</a> | 
<a href="https://www.lightbend.com/legal/privacy" target="_blank">Privacy Policy</a> | 
<a href="https://akka.io/cookie/" target="_blank">Cookie Listing</a> | 
<a class="optanon-toggle-display">Cookie Settings</a>
</p>
</section>
</footer>

</section>
</main>

<script type="text/javascript" src="js/scrollsneak.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="js/groups.js"></script>
<script type="text/javascript" src="js/page.js"></script>
<script type="text/javascript" src="js/magellan.js"></script>

<style type="text/css">@import "lib/prettify/prettify.css";</style>
<script type="text/javascript" src="lib/prettify/prettify.js"></script>
<script type="text/javascript" src="lib/prettify/lang-scala.js"></script>
<script type="text/javascript">jQuery(function(){window.prettyPrint && prettyPrint()});</script>

<!-- hook for including project specific javascript into the generated docs -->

</body>
</html>
