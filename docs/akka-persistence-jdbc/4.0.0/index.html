<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Akka Persistence JDBC</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="A plugin for storing events in an event journal akka-persistence-jdbc"/>
<link rel="canonical" href="https://doc.akka.io/docs/akka-persistence-jdbc/current/index.html"/>
<script type="text/javascript" src="lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="lib/foundation/dist/js/foundation.min.js"></script>
<link rel="stylesheet" type="text/css" href="lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="lib/foundation/dist/css/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" type="text/css" href="css/icons.css"/>
<link rel="stylesheet" type="text/css" href="css/page-7.css"/>
<link rel="stylesheet" type="text/css" href="css/banner-1.css"/>
<link rel="shortcut icon" href="images/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png"/>
<link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png"/>
<link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png"/>
<link rel="manifest" href="images/manifest.json"/>
<meta name="msapplication-TileImage" content="images/mstile-150x150.png"/>
<meta name="msapplication-TileColor" content="#15a9ce"/>
<meta name="theme-color" content="#15a9ce"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) start -->
<script src="https://optanon.blob.core.windows.net/consent/159bb13d-6748-4399-806e-ac28db879785.js" type="text/javascript" charset="UTF-8"></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) end -->
<!--Google Analytics-->
<script type="text/plain" class="optanon-category-2">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', '']);
_gaq.push(['_setDomainName', '']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})()
</script>
<!-- Google Tag Manager -->
<script type="text/plain" class="optanon-category-2">
(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KBJGH35');
</script>
<!--Marketo-->
<script type="text/plain" class="optanon-category-3">
(function() {
var didInit = false;
function initMunchkin() {
if(didInit === false) {
didInit = true;
Munchkin.init('558-NCX-702', { 'asyncOnly': true, 'disableClickDelay': true });
}
}
var s = document.createElement('script');
s.type = 'text/javascript';
s.async = true;
s.src = '//munchkin.marketo.net/munchkin.js';
s.onreadystatechange = function() {
if (this.readyState == 'complete' || this.readyState == 'loaded') {
initMunchkin();
}
};
s.onload = initMunchkin;
document.getElementsByTagName('head')[0].appendChild(s);
})();
</script>
</head>

<body id="underlay" data-toggler="nav-open">
<div id="lightbend-banner" class="lightbend-banner akka full-width" data-category="OSS Lightbend Banner Impression" data-label="Akka Banner Impression">
<div class="wrapper">
<div class="brand">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lightbend Logo - Akka Banner" href="https://www.lightbend.com?r=oss-banner-akka" target="_blank">
<img class="lightbend-logo" src="images/banner-logos/lightbend-reverse.svg" alt="Lightbend" title="Lightbend">
</a>
</div>
<div class="nav">
<a class="banner-btn oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Enhance your Akka systems with Akka Platform [Button] - Akka Banner" href="https://www.lightbend.com/akka-core-of-lightbend?r=oss-banner-akka" target="_blank">
<span>Enhance your Akka systems with</span>
<img class="akka-platform-reverse-logo" src="images/banner-logos/akka-platform-reverse.svg" alt="Akka Platform" title="Akka Platform">
</a>
<div class="drop-down">
<svg class="svg-chevon-circle-down" version="1.1" id="Chevron_circled_down" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve">
<path fill="#ffffff" d="M12.505,8.698L10,11L7.494,8.698c-0.198-0.196-0.518-0.196-0.718,0c-0.197,0.196-0.197,0.515,0,0.71l2.864,2.807
c0.199,0.196,0.52,0.196,0.717,0l2.864-2.807c0.199-0.195,0.198-0.514,0-0.71C13.024,8.502,12.704,8.502,12.505,8.698z M10,0.4
c-5.302,0-9.6,4.298-9.6,9.6c0,5.303,4.298,9.6,9.6,9.6s9.6-4.297,9.6-9.6C19.6,4.698,15.302,0.4,10,0.4z M10,18.354
c-4.615,0-8.354-3.74-8.354-8.354c0-4.614,3.739-8.354,8.354-8.354c4.613,0,8.354,3.74,8.354,8.354
C18.354,14.614,14.613,18.354,10,18.354z" />
</svg>
<div class="drop-down-content">
<div class="lightbend-family">
<a href="https://cloudflow.io" class="cloudflow oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Cloudflow - Logo Tag Line - Akka Banner">
<img class="cloudflow-full-color-logo" src="images/banner-logos/cloudflow-full-color.svg" alt="Cloudflow by Lightbend" title="Cloudflow by Lightbend">
</a>
<a href="https://cloudstate.io" class="cloudstate oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Cloudstate - Logo Tag Line - Akka Banner">
<img class="cloudstate-full-color-logo" src="images/banner-logos/cloudstate-full-color.svg" alt="Cloudstate by Lightbend" title="Cloudstate by Lightbend">
</a>
<a href="https://www.lagomframework.com" class="lagom oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lagom - Logo Tag Line - Akka Banner">
<img class="lagom-full-color-logo" src="images/banner-logos/lagom-full-color.svg" alt="Lagom Framework by Lightbend" title="Lagom Framework by Lightbend">
</a>
<a href="https://www.playframework.com" class="play oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Play - Logo Tag Line - Akka Banner">
<img class="play-full-color-logo" src="images/banner-logos/play-full-color.svg" alt="Play Framework by Lightbend" title="Play Framework by Lightbend">
</a>
<a href="https://www.scala-lang.org" class="scala oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Scala - Logo Tag Line - Akka Banner">
<img class="scala-full-color-logo" src="images/banner-logos/scala-full-color.svg" alt="Scala by Lightbend" title="Scala by Lightbend">
</a>
<div class="akka current">
<img class="akka-full-color-logo" src="images/banner-logos/akka-full-color.svg" alt="Akka by Lightbend" title="Akka by Lightbend">
<span>From the creators of <strong>Akka</strong>, get technology enhancements, monitoring, and expert support with Akka Platform from Lightbend.</span>
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Learn More [Button] - Akka Banner" href="https://www.lightbend.com/akka-core-of-lightbend?r=oss-banner-akka" target="_blank">Learn More</a>
</div>
</div>
<div class="title">The Lightbend Family</div>
</div>      
</div>
</div>
</div>
</div>
<header class="site-header hide-for-large">
<div class="sticky-header clearfix">
<a href="https://akka.io"><img class="logo" src="images/akka-logo-reverse.svg"/></a>

<button class="menu-icon float-right" type="button" data-toggle="underlay overlay"></button>
</div>
<div id="overlay" class="overlay-nav" data-toggler="nav-open">
<header class="nav-header">
<div class="nav-header-title">
<h1><a href="index.html">Akka Persistence JDBC</a></h1>
</div>
<div class="nav-header-version">
Version 4.0.0
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="nav-toc">
<ul>
  <li><a href="index.html#module-info" class="header">Module info</a></li>
  <li><a href="index.html#contribution-policy" class="header">Contribution policy</a></li>
  <li><a href="index.html#code-of-conduct" class="header">Code of Conduct</a></li>
  <li><a href="index.html#license" class="header">License</a></li>
  <li><a href="index.html#configuration" class="header">Configuration</a></li>
  <li><a href="index.html#database-schema" class="header">Database Schema</a></li>
  <li><a href="index.html#reference-configuration" class="header">Reference Configuration</a></li>
  <li><a href="index.html#how-to-get-the-readjournal-using-scala" class="header">How to get the ReadJournal using Scala</a></li>
  <li><a href="index.html#how-to-get-the-readjournal-using-java" class="header">How to get the ReadJournal using Java</a></li>
  <li><a href="index.html#persistence-query" class="header">Persistence Query</a></li>
  <li><a href="index.html#allpersistenceidsquery-and-currentpersistenceidsquery" class="header">AllPersistenceIdsQuery and CurrentPersistenceIdsQuery</a></li>
  <li><a href="index.html#eventsbypersistenceidquery-and-currenteventsbypersistenceidquery" class="header">EventsByPersistenceIdQuery and CurrentEventsByPersistenceIdQuery</a></li>
  <li><a href="index.html#eventsbytag-and-currenteventsbytag" class="header">EventsByTag and CurrentEventsByTag</a></li>
  <li><a href="index.html#tagging-events" class="header">Tagging events</a></li>
  <li><a href="index.html#custom-dao-implementation" class="header">Custom DAO Implementation</a></li>
  <li><a href="index.html#explicitly-shutting-down-the-database-connections" class="header">Explicitly shutting down the database connections</a></li>
</ul>
</nav>
</div>
</header>
<div class="site-content-wrapper">
<aside class="sticky-sidebar show-for-large">
<header class="nav-header sticky-sidebar-header">
<div class="nav-header-title">
<h1><a href="index.html">Akka Persistence JDBC</a></h1>
</div>
<div class="nav-header-version">
Version 4.0.0
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="site-nav sticky-sidebar-contents">
<div class="nav-toc">
<ul>
  <li><a href="index.html#module-info" class="header">Module info</a></li>
  <li><a href="index.html#contribution-policy" class="header">Contribution policy</a></li>
  <li><a href="index.html#code-of-conduct" class="header">Code of Conduct</a></li>
  <li><a href="index.html#license" class="header">License</a></li>
  <li><a href="index.html#configuration" class="header">Configuration</a></li>
  <li><a href="index.html#database-schema" class="header">Database Schema</a></li>
  <li><a href="index.html#reference-configuration" class="header">Reference Configuration</a></li>
  <li><a href="index.html#how-to-get-the-readjournal-using-scala" class="header">How to get the ReadJournal using Scala</a></li>
  <li><a href="index.html#how-to-get-the-readjournal-using-java" class="header">How to get the ReadJournal using Java</a></li>
  <li><a href="index.html#persistence-query" class="header">Persistence Query</a></li>
  <li><a href="index.html#allpersistenceidsquery-and-currentpersistenceidsquery" class="header">AllPersistenceIdsQuery and CurrentPersistenceIdsQuery</a></li>
  <li><a href="index.html#eventsbypersistenceidquery-and-currenteventsbypersistenceidquery" class="header">EventsByPersistenceIdQuery and CurrentEventsByPersistenceIdQuery</a></li>
  <li><a href="index.html#eventsbytag-and-currenteventsbytag" class="header">EventsByTag and CurrentEventsByTag</a></li>
  <li><a href="index.html#tagging-events" class="header">Tagging events</a></li>
  <li><a href="index.html#custom-dao-implementation" class="header">Custom DAO Implementation</a></li>
  <li><a href="index.html#explicitly-shutting-down-the-database-connections" class="header">Explicitly shutting down the database connections</a></li>
</ul>
</div>
</nav>
<footer class="nav-footer sticky-sidebar-footer">
<a href="https://akka.io"><img class="logo" src="images/akka-logo-reverse.svg"/></a>

</footer>
</aside>
<main class="fixed-shift-for-large expanded row">
<section class="site-content small-12 column">
<article class="page-content row">
<div class="small-12 column" id="docs">
<h1><a href="#akka-persistence-jdbc" name="akka-persistence-jdbc" class="anchor"><span class="anchor-link"></span></a>Akka Persistence JDBC</h1>
<p>The Akka Persistence JDBC plugin allows for using JDBC-compliant databases as backend for <a href="https://doc.akka.io/docs/akka/2.6/persistence.html">Akka Persistence</a> and <a href="https://doc.akka.io/docs/akka/2.6/persistence-query.html">Akka Persistence Query</a>.</p>
<p>akka-persistence-jdbc writes journal and snapshot entries to a configured JDBC store. It implements the full akka-persistence-query API and is therefore very useful for implementing DDD-style application models using Akka and Scala for creating reactive applications.</p>
<h2><a href="#module-info" name="module-info" class="anchor"><span class="anchor-link"></span></a>Module info</h2><dl class="dependency"><dt>sbt</dt><dd><pre class="prettyprint"><code class="language-scala">val AkkaVersion = "2.6.5"
val SlickVersion = "3.3.2"
libraryDependencies ++= Seq(
  "com.lightbend.akka" %% "akka-persistence-jdbc" % "4.0.0",
  "com.typesafe.akka" %% "akka-persistence-query" % AkkaVersion,
  "com.typesafe.slick" %% "slick" % SlickVersion,
  "com.typesafe.slick" %% "slick-hikaricp" % SlickVersion
)</code></pre></dd><dt>Maven</dt><dd><pre class="prettyprint"><code class="language-xml">&lt;properties&gt;
  &lt;akka.version&gt;2.6.5&lt;/akka.version&gt;
  &lt;slick.version&gt;3.3.2&lt;/slick.version&gt;
  &lt;scala.binary.version&gt;2.12&lt;/scala.binary.version&gt;
&lt;/properties&gt;
&lt;dependency&gt;
  &lt;groupId&gt;com.lightbend.akka&lt;/groupId&gt;
  &lt;artifactId&gt;akka-persistence-jdbc_${scala.binary.version}&lt;/artifactId&gt;
  &lt;version&gt;4.0.0&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;com.typesafe.akka&lt;/groupId&gt;
  &lt;artifactId&gt;akka-persistence-query_${scala.binary.version}&lt;/artifactId&gt;
  &lt;version&gt;${akka.version}&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;com.typesafe.slick&lt;/groupId&gt;
  &lt;artifactId&gt;slick_${scala.binary.version}&lt;/artifactId&gt;
  &lt;version&gt;${slick.version}&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;com.typesafe.slick&lt;/groupId&gt;
  &lt;artifactId&gt;slick-hikaricp_${scala.binary.version}&lt;/artifactId&gt;
  &lt;version&gt;${slick.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre></dd><dt>Gradle</dt><dd><pre class="prettyprint"><code class="language-gradle">versions += [
  AkkaVersion: "2.6.5",
  SlickVersion: "3.3.2",
  ScalaBinary: "2.12"
]
dependencies {
  compile group: 'com.lightbend.akka', name: "akka-persistence-jdbc_${versions.ScalaBinary}", version: '4.0.0',
  compile group: 'com.typesafe.akka', name: "akka-persistence-query_${versions.ScalaBinary}", version: versions.AkkaVersion,
  compile group: 'com.typesafe.slick', name: "slick_${versions.ScalaBinary}", version: versions.SlickVersion,
  compile group: 'com.typesafe.slick', name: "slick-hikaricp_${versions.ScalaBinary}", version: versions.SlickVersion
}</code></pre></dd></dl>
<table class="project-info">
<tr><th colspan="2">Project Info: Akka Persistence JDBC</th></tr>
  <tr><th>Artifact</th><td><div>com.lightbend.akka</div>
  <div>akka-persistence-jdbc</div>
  <div>4.0.0</div></td></tr>
  <tr><th>JDK versions</th><td><div>Adopt OpenJDK 8</div><div>Adopt OpenJDK 11</div></td></tr>
  <tr><th>Scala versions</th><td>2.12.11, 2.13.1</td></tr>
  <tr><th>JPMS module name</th><td>akka.persistence.jdbc</td></tr>
  <tr><th>License</th><td><div><a href="https://opensource.org/licenses/Apache-2.0" target="_blank" rel="noopener noreferrer">Apache-2.0</a></div>
  </td></tr>
  <tr><th>Readiness level</th><td><div class="readiness-level"><a href="https://developer.lightbend.com/docs/introduction/getting-help/support-terminology.html#community-driven" target="_blank" rel="noopener">Community-driven</a></div>
  <div>Since 1.0.0, 2014-07-04</div>
  </td></tr>
  <tr><th>Home page</th><td><a href="https://github.com/akka/akka-persistence-jdbc">https://github.com/akka/akka-persistence-jdbc</a></td></tr>
  <tr><th>Forums</th><td>
  <div><a href="https://discuss.lightbend.com/c/akka/" target="_blank" rel="noopener noreferrer">Lightbend Discuss</a></div>
  <div><a href="https://gitter.im/akka/akka" target="_blank" rel="noopener noreferrer">akka/akka Gitter channel</a></div>
  </td></tr>
  <tr><th>Release notes</th><td><a href="https://github.com/akka/akka-persistence-jdbc/releases" target="_blank" rel="noopener noreferrer">GitHub releases</a></td></tr>
  <tr><th>Issues</th><td><a href="https://github.com/akka/akka-persistence-jdbc/issues" target="_blank" rel="noopener noreferrer">GitHub issues</a></td></tr>
  <tr><th>Sources</th><td><a href="https://github.com/akka/akka-persistence-jdbc" target="_blank" rel="noopener noreferrer">https://github.com/akka/akka-persistence-jdbc</a></td></tr>
</table>

<h2><a href="#contribution-policy" name="contribution-policy" class="anchor"><span class="anchor-link"></span></a>Contribution policy</h2>

<p>Contributions via GitHub pull requests are gladly accepted from their original author. Along with any pull requests, please state that the contribution is your original work and that you license the work to the project under the project&rsquo;s open source license. Whether or not you state this explicitly, by submitting any copyrighted material via pull request, email, or other means you agree to license the material under the project&rsquo;s open source license and warrant that you have the legal authority to do so.</p>

<h2><a href="#code-of-conduct" name="code-of-conduct" class="anchor"><span class="anchor-link"></span></a>Code of Conduct</h2>

<p>Contributors all agree to follow the <a href="https://www.lightbend.com/conduct">Lightbend Community Code of Conduct</a>.</p>

<h2><a href="#license" name="license" class="anchor"><span class="anchor-link"></span></a>License</h2>

<p>This source code is made available under the <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache 2.0 License</a>.</p>

<h2><a href="#configuration" name="configuration" class="anchor"><span class="anchor-link"></span></a>Configuration</h2>

<p>The plugin relies on <a href="https://scala-slick.org/doc/3.3.2/">Slick</a> to do create the SQL dialect for the database in use, therefore the following must be configured in <code>application.conf</code></p>

<p>Configure <code>akka-persistence</code>:</p>

<ul>
  <li>instruct akka persistence to use the <code>jdbc-journal</code> plugin,</li>
  <li>instruct akka persistence to use the <code>jdbc-snapshot-store</code> plugin,</li>
</ul>
<p>Configure <code>slick</code>:</p>
<ul>
  <li>The following slick profiles are supported:</li>
  <li><code>slick.jdbc.PostgresProfile$</code></li>
  <li><code>slick.jdbc.MySQLProfile$</code></li>
  <li><code>slick.jdbc.H2Profile$</code></li>
  <li><code>slick.jdbc.OracleProfile$</code></li>
  <li><code>slick.jdbc.SQLServerProfile$</code></li>
</ul>
<h2><a href="#database-schema" name="database-schema" class="anchor"><span class="anchor-link"></span></a>Database Schema</h2>
<ul>
  <li><a href="https://github.com/akka/akka-persistence-jdbc/blob/v4.0.0/core/src/test/resources/schema/postgres/postgres-schema.sql">Postgres Schema</a></li>
  <li><a href="https://github.com/akka/akka-persistence-jdbc/blob/v4.0.0/core/src/test/resources/schema/mysql/mysql-schema.sql">MySQL Schema</a></li>
  <li><a href="https://github.com/akka/akka-persistence-jdbc/blob/v4.0.0/core/src/test/resources/schema/h2/h2-schema.sql">H2 Schema</a></li>
  <li><a href="https://github.com/akka/akka-persistence-jdbc/blob/v4.0.0/core/src/test/resources/schema/oracle/oracle-schema.sql">Oracle Schema</a></li>
  <li><a href="https://github.com/akka/akka-persistence-jdbc/blob/v4.0.0/core/src/test/resources/schema/sqlserver/sqlserver-schema.sql">SQL Server Schema</a></li>
</ul>
<h2><a href="#reference-configuration" name="reference-configuration" class="anchor"><span class="anchor-link"></span></a>Reference Configuration</h2>
<p>akka-persistence-jdbc provides the defaults as part of the <a href="https://github.com/akka/akka-persistence-jdbc/blob/v4.0.0/core/src/main/resources/reference.conf">reference.conf</a>. This file documents all the values which can be configured.</p>
<p>There are several possible ways to configure loading your database connections. Options will be explained below.</p>
<h3><a href="#one-database-connection-pool-per-journal-type" name="one-database-connection-pool-per-journal-type" class="anchor"><span class="anchor-link"></span></a>One database connection pool per journal type</h3>
<p>There is the possibility to create a separate database connection pool per journal-type (one pool for the write-journal, one pool for the snapshot-journal, and one pool for the read-journal). This is the default and the following example configuration shows how this is configured:</p>
<ul>
  <li><a href="https://github.com/akka/akka-persistence-jdbc/blob/v4.0.0/core/src/test/resources/postgres-application.conf">Postgres</a></li>
  <li><a href="https://github.com/akka/akka-persistence-jdbc/blob/v4.0.0/core/src/test/resources/mysql-application.conf">MySQL</a></li>
  <li><a href="https://github.com/akka/akka-persistence-jdbc/blob/v4.0.0/core/src/test/resources/h2-application.conf">H2</a></li>
  <li><a href="https://github.com/akka/akka-persistence-jdbc/blob/v4.0.0/core/src/test/resources/oracle-application.conf">Oracle</a></li>
  <li><a href="https://github.com/akka/akka-persistence-jdbc/blob/v4.0.0/core/src/test/resources/sqlserver-application.conf">SQL Server</a></li>
</ul>
<h3><a href="#sharing-the-database-connection-pool-between-the-journals" name="sharing-the-database-connection-pool-between-the-journals" class="anchor"><span class="anchor-link"></span></a>Sharing the database connection pool between the journals</h3>
<p>In order to create only one connection pool which is shared between all journals the following configuration can be used:</p>
<ul>
  <li><a href="https://github.com/akka/akka-persistence-jdbc/blob/v4.0.0/core/src/test/resources/postgres-shared-db-application.conf">Postgres</a></li>
  <li><a href="https://github.com/akka/akka-persistence-jdbc/blob/v4.0.0/core/src/test/resources/mysql-shared-db-application.conf">MySQL</a></li>
  <li><a href="https://github.com/akka/akka-persistence-jdbc/blob/v4.0.0/core/src/test/resources/h2-shared-db-application.conf">H2</a></li>
  <li><a href="https://github.com/akka/akka-persistence-jdbc/blob/v4.0.0/core/src/test/resources/oracle-shared-db-application.conf">Oracle</a></li>
  <li><a href="https://github.com/akka/akka-persistence-jdbc/blob/v4.0.0/core/src/test/resources/sqlserver-shared-db-application.conf">SQL Server</a></li>
</ul>
<h3><a href="#customized-loading-of-the-db-connection" name="customized-loading-of-the-db-connection" class="anchor"><span class="anchor-link"></span></a>Customized loading of the db connection</h3>
<p>It is also possible to load a custom database connection. In order to do so a custom implementation of <a href="https://github.com/akka/akka-persistence-jdbc/blob/v4.0.0/src/main/scala/akka/persistence/jdbc/util/SlickExtension.scala">SlickDatabaseProvider</a> needs to be created. The methods that need to be implemented supply the Slick <code>Database</code> and <code>Profile</code> to the journals.</p>
<p>To enable your custom <code>SlickDatabaseProvider</code>, the fully qualified class name of the <code>SlickDatabaseProvider</code> needs to be configured in the application.conf. In addition, you might want to consider whether you want the database to be closed automatically:</p>
<pre class="prettyprint"><code class="language-hocon">akka-persistence-jdbc {
  database-provider-fqcn = &quot;com.mypackage.CustomSlickDatabaseProvider&quot;
}
jdbc-journal {
  use-shared-db = &quot;enabled&quot; // setting this to any non-empty string prevents the journal from closing the database on shutdown
}
jdbc-snapshot-store {
  use-shared-db = &quot;enabled&quot; // setting this to any non-empty string prevents the snapshot-journal from closing the database on shutdown
}
</code></pre>
<h3><a href="#datasource-lookup-by-jndi-name" name="datasource-lookup-by-jndi-name" class="anchor"><span class="anchor-link"></span></a>DataSource lookup by JNDI name</h3>
<p>The plugin uses <code>Slick</code> as the database access library. Slick <a href="https://scala-slick.org/doc/3.3.2/database.html#using-a-jndi-name">supports jndi</a> for looking up <a href="https://docs.oracle.com/javase/8/docs/api/?javax/sql/DataSource.html" title="javax.sql.DataSource"><code>DataSource</code></a>s.</p>
<p>To enable the JNDI lookup, you must add the following to your application.conf:</p>
<pre class="prettyprint"><code class="language-hocon">jdbc-journal {
  slick {
    profile = &quot;slick.jdbc.PostgresProfile$&quot;
    jndiName = &quot;java:jboss/datasources/PostgresDS&quot;
  }
}
</code></pre>
<p>When using the <code>use-shared-db = slick</code> setting, the follow configuration can serve as an example:</p>
<pre class="prettyprint"><code class="language-hocon">akka-persistence-jdbc {
  shared-databases {
    slick {
      profile = &quot;slick.jdbc.PostgresProfile$&quot;
      jndiName = &quot;java:/jboss/datasources/bla&quot;
    }
  }
}
</code></pre>
<h2><a href="#how-to-get-the-readjournal-using-scala" name="how-to-get-the-readjournal-using-scala" class="anchor"><span class="anchor-link"></span></a>How to get the ReadJournal using Scala</h2>
<p>The <code>ReadJournal</code> is retrieved via the <code>akka.persistence.query.PersistenceQuery</code> extension:</p>
<pre class="prettyprint"><code class="language-scala">import akka.persistence.query.PersistenceQuery
import akka.persistence.jdbc.query.scaladsl.JdbcReadJournal

val readJournal: JdbcReadJournal = PersistenceQuery(system).readJournalFor[JdbcReadJournal](JdbcReadJournal.Identifier)
</code></pre>
<h2><a href="#how-to-get-the-readjournal-using-java" name="how-to-get-the-readjournal-using-java" class="anchor"><span class="anchor-link"></span></a>How to get the ReadJournal using Java</h2>
<p>The <code>ReadJournal</code> is retrieved via the <code>akka.persistence.query.PersistenceQuery</code> extension:</p>
<pre class="prettyprint"><code class="language-java">import akka.persistence.query.PersistenceQuery
import akka.persistence.jdbc.query.javadsl.JdbcReadJournal

final JdbcReadJournal readJournal = PersistenceQuery.get(system).getReadJournalFor(JdbcReadJournal.class, JdbcReadJournal.Identifier());
</code></pre>
<h2><a href="#persistence-query" name="persistence-query" class="anchor"><span class="anchor-link"></span></a>Persistence Query</h2>
<p>The plugin supports the following queries:</p>
<h2><a href="#allpersistenceidsquery-and-currentpersistenceidsquery" name="allpersistenceidsquery-and-currentpersistenceidsquery" class="anchor"><span class="anchor-link"></span></a>AllPersistenceIdsQuery and CurrentPersistenceIdsQuery</h2>
<p><code>allPersistenceIds</code> and <code>currentPersistenceIds</code> are used for retrieving all persistenceIds of all persistent actors.</p>
<pre class="prettyprint"><code class="language-scala">import akka.actor.ActorSystem
import akka.stream.{Materializer, ActorMaterializer}
import akka.stream.scaladsl.Source
import akka.persistence.query.PersistenceQuery
import akka.persistence.jdbc.query.scaladsl.JdbcReadJournal

implicit val system: ActorSystem = ActorSystem()
implicit val mat: Materializer = ActorMaterializer()(system)
val readJournal: JdbcReadJournal = PersistenceQuery(system).readJournalFor[JdbcReadJournal](JdbcReadJournal.Identifier)

val willNotCompleteTheStream: Source[String, NotUsed] = readJournal.allPersistenceIds()

val willCompleteTheStream: Source[String, NotUsed] = readJournal.currentPersistenceIds()
</code></pre>
<p>The returned event stream is unordered and you can expect different order for multiple executions of the query.</p>
<p>When using the <code>allPersistenceIds</code> query, the stream is not completed when it reaches the end of the currently used persistenceIds, but it continues to push new persistenceIds when new persistent actors are created.</p>
<p>When using the <code>currentPersistenceIds</code> query, the stream is completed when the end of the current list of persistenceIds is reached, thus it is not a <code>live</code> query.</p>
<p>The stream is completed with failure if there is a failure in executing the query in the backend journal.</p>
<h2><a href="#eventsbypersistenceidquery-and-currenteventsbypersistenceidquery" name="eventsbypersistenceidquery-and-currenteventsbypersistenceidquery" class="anchor"><span class="anchor-link"></span></a>EventsByPersistenceIdQuery and CurrentEventsByPersistenceIdQuery</h2>
<p><code>eventsByPersistenceId</code> and <code>currentEventsByPersistenceId</code> is used for retrieving events for a specific PersistentActor identified by persistenceId.</p>
<pre class="prettyprint"><code class="language-scala">import akka.actor.ActorSystem
import akka.stream.{Materializer, ActorMaterializer}
import akka.stream.scaladsl.Source
import akka.persistence.query.{ PersistenceQuery, EventEnvelope }
import akka.persistence.jdbc.query.scaladsl.JdbcReadJournal

implicit val system: ActorSystem = ActorSystem()
implicit val mat: Materializer = ActorMaterializer()(system)
val readJournal: JdbcReadJournal = PersistenceQuery(system).readJournalFor[JdbcReadJournal](JdbcReadJournal.Identifier)

val willNotCompleteTheStream: Source[EventEnvelope, NotUsed] = readJournal.eventsByPersistenceId(&quot;some-persistence-id&quot;, 0L, Long.MaxValue)

val willCompleteTheStream: Source[EventEnvelope, NotUsed] = readJournal.currentEventsByPersistenceId(&quot;some-persistence-id&quot;, 0L, Long.MaxValue)
</code></pre>
<p>You can retrieve a subset of all events by specifying <code>fromSequenceNr</code> and <code>toSequenceNr</code> or use <code>0L</code> and <code>Long.MaxValue</code> respectively to retrieve all events. Note that the corresponding sequence number of each event is provided in the <code>EventEnvelope</code>, which makes it possible to resume the stream at a later point from a given sequence number.</p>
<p>The returned event stream is ordered by sequence number, i.e. the same order as the PersistentActor persisted the events. The same prefix of stream elements (in same order) are returned for multiple executions of the query, except for when events have been deleted.</p>
<p>The stream is completed with failure if there is a failure in executing the query in the backend journal.</p>
<h2><a href="#eventsbytag-and-currenteventsbytag" name="eventsbytag-and-currenteventsbytag" class="anchor"><span class="anchor-link"></span></a>EventsByTag and CurrentEventsByTag</h2>
<p><code>eventsByTag</code> and <code>currentEventsByTag</code> are used for retrieving events that were marked with a given <code>tag</code>, e.g. all domain events of an Aggregate Root type.</p>
<pre class="prettyprint"><code class="language-scala">import akka.actor.ActorSystem
import akka.stream.{Materializer, ActorMaterializer}
import akka.stream.scaladsl.Source
import akka.persistence.query.{ PersistenceQuery, EventEnvelope }
import akka.persistence.jdbc.query.scaladsl.JdbcReadJournal

implicit val system: ActorSystem = ActorSystem()
implicit val mat: Materializer = ActorMaterializer()(system)
val readJournal: JdbcReadJournal = PersistenceQuery(system).readJournalFor[JdbcReadJournal](JdbcReadJournal.Identifier)

val willNotCompleteTheStream: Source[EventEnvelope, NotUsed] = readJournal.eventsByTag(&quot;apple&quot;, 0L)

val willCompleteTheStream: Source[EventEnvelope, NotUsed] = readJournal.currentEventsByTag(&quot;apple&quot;, 0L)
</code></pre>
<h2><a href="#tagging-events" name="tagging-events" class="anchor"><span class="anchor-link"></span></a>Tagging events</h2>
<p>To tag events you&rsquo;ll need to create an <a href="https://doc.akka.io/docs/akka/2.6/persistence.html#event-adapters-scala">Event Adapter</a> that will wrap the event in a <span class="group-scala"><a href="https://doc.akka.io/api/akka/2.6/akka/persistence/journal/Tagged.html" title="akka.persistence.journal.Tagged"><code>Tagged</code></a></span><span class="group-java"><a href="https://doc.akka.io/japi/akka/2.6/akka/persistence/journal/Tagged.html" title="akka.persistence.journal.Tagged"><code>Tagged</code></a></span> class with the given tags. The <code>Tagged</code> class will instruct <code>akka-persistence-jdbc</code> to tag the event with the given set of tags.</p>
<p>The persistence plugin will <strong>not</strong> store the <code>Tagged</code> class in the journal. It will strip the <code>tags</code> and <code>payload</code> from the <code>Tagged</code> class, and use the class only as an instruction to tag the event with the given tags and store the <code>payload</code> in the <code>message</code> field of the journal table.</p>
<pre class="prettyprint"><code class="language-scala">import akka.persistence.journal.{ Tagged, WriteEventAdapter }
import com.github.dnvriend.Person.{ LastNameChanged, FirstNameChanged, PersonCreated }

class TaggingEventAdapter extends WriteEventAdapter {
  override def manifest(event: Any): String = &quot;&quot;

  def withTag(event: Any, tag: String) = Tagged(event, Set(tag))

  override def toJournal(event: Any): Any = event match {
    case _: PersonCreated =&gt;
      withTag(event, &quot;person-created&quot;)
    case _: FirstNameChanged =&gt;
      withTag(event, &quot;first-name-changed&quot;)
    case _: LastNameChanged =&gt;
      withTag(event, &quot;last-name-changed&quot;)
    case _ =&gt; event
  }
}
</code></pre>
<p>The <code>EventAdapter</code> must be registered by adding the following to the root of <code>application.conf</code> Please see the <a href="https://github.com/dnvriend/demo-akka-persistence-jdbc">demo-akka-persistence-jdbc</a> project for more information.</p>
<pre class="prettyprint"><code class="language-bash">jdbc-journal {
  event-adapters {
    tagging = &quot;com.github.dnvriend.TaggingEventAdapter&quot;
  }
  event-adapter-bindings {
    &quot;com.github.dnvriend.Person$PersonCreated&quot; = tagging
    &quot;com.github.dnvriend.Person$FirstNameChanged&quot; = tagging
    &quot;com.github.dnvriend.Person$LastNameChanged&quot; = tagging
  }
}
</code></pre>
<p>You can retrieve a subset of all events by specifying offset, or use 0L to retrieve all events with a given tag. The offset corresponds to an ordered sequence number for the specific tag. Note that the corresponding offset of each event is provided in the EventEnvelope, which makes it possible to resume the stream at a later point from a given offset.</p>
<p>In addition to the offset the EventEnvelope also provides persistenceId and sequenceNr for each event. The sequenceNr is the sequence number for the persistent actor with the persistenceId that persisted the event. The persistenceId + sequenceNr is an unique identifier for the event.</p>
<p>The returned event stream contains only events that correspond to the given tag, and is ordered by the creation time of the events. The same stream elements (in same order) are returned for multiple executions of the same query. Deleted events are not deleted from the tagged event stream.</p>
<h2><a href="#custom-dao-implementation" name="custom-dao-implementation" class="anchor"><span class="anchor-link"></span></a>Custom DAO Implementation</h2>
<p>The plugin supports loading a custom DAO for the journal and snapshot. You should implement a custom Data Access Object (DAO) if you wish to alter the default persistency strategy in any way, but wish to reuse all the logic that the plugin already has in place, eg. the Akka Persistence Query API. For example, the default persistency strategy that the plugin supports serializes journal and snapshot messages using a serializer of your choice and stores them as byte arrays in the database.</p>
<p>By means of configuration in <code>application.conf</code> a DAO can be configured, below the default DAOs are shown:</p>
<pre class="prettyprint"><code class="language-hocon">jdbc-journal {
  dao = &quot;akka.persistence.jdbc.journal.dao.ByteArrayJournalDao&quot;
}

jdbc-snapshot-store {
  dao = &quot;akka.persistence.jdbc.snapshot.dao.ByteArraySnapshotDao&quot;
}

jdbc-read-journal {
  dao = &quot;akka.persistence.jdbc.query.dao.ByteArrayReadJournalDao&quot;
}
</code></pre>
<p>Storing messages as byte arrays in blobs is not the only way to store information in a database. For example, you could store messages with full type information as a normal database rows, each event type having its own table. For example, implementing a Journal Log table that stores all persistenceId, sequenceNumber and event type discriminator field, and storing the event data in another table with full typing</p>
<p>You only have to implement two interfaces <code>akka.persistence.jdbc.journal.dao.JournalDao</code> and/or <code>akka.persistence.jdbc.snapshot.dao.SnapshotDao</code>. </p>
<p>For example, take a look at the following two custom DAOs:</p>
<pre class="prettyprint"><code class="language-scala">class MyCustomJournalDao(db: Database, val profile: JdbcProfile, journalConfig: JournalConfig, serialization: Serialization)(implicit ec: ExecutionContext, mat: Materializer) extends JournalDao {
    // snip
}

class MyCustomSnapshotDao(db: JdbcBackend#Database, val profile: JdbcProfile, snapshotConfig: SnapshotConfig, serialization: Serialization)(implicit ec: ExecutionContext, val mat: Materializer) extends SnapshotDao {
    // snip
}
</code></pre>
<p>As you can see, the custom DAOs get a <em>Slick database</em>, a <em>Slick profile</em>, the journal or snapshot <em>configuration</em>, an <em>akka.serialization.Serialization</em>, an <em>ExecutionContext</em> and <em>Materializer</em> injected after constructed. You should register the Fully Qualified Class Name in <code>application.conf</code> so that the custom DAOs will be used.</p>
<p>For more information please review the two default implementations <code>akka.persistence.jdbc.dao.bytea.journal.ByteArrayJournalDao</code> and <code>akka.persistence.jdbc.dao.bytea.snapshot.ByteArraySnapshotDao</code> or the demo custom DAO example from the <a href="https://github.com/dnvriend/demo-akka-persistence-jdbc">demo-akka-persistence</a> site.</p><div class="callout warning "><div class="callout-title">Binary compatibility</div>
<p>The APIs for custom DAOs are not guaranteed to be binary backwards compatible between major versions of the plugin. For example 4.0.0 is not binary backwards compatible with 3.5.x. There may also be source incompatible changes of the APIs for customer DAOs if new capabilities must be added to to the traits.</p></div>
<h2><a href="#explicitly-shutting-down-the-database-connections" name="explicitly-shutting-down-the-database-connections" class="anchor"><span class="anchor-link"></span></a>Explicitly shutting down the database connections</h2>
<p>The plugin automatically shuts down the HikariCP connection pool when the ActorSystem is terminated. This is done using <span class="group-scala"><a href="https://doc.akka.io/api/akka/2.6/akka/actor/ActorSystem.html" title="akka.actor.ActorSystem"><code>ActorSystem.registerOnTermination</code></a></span><span class="group-java"><a href="https://doc.akka.io/japi/akka/2.6/akka/actor/ActorSystem.html" title="akka.actor.ActorSystem"><code>ActorSystem.registerOnTermination</code></a></span>.</p>
</div>
</article>
<div class="row">
<div class="small-12 column">
<section class="nav-prev-next row">
<div class="nav-prev small-6 column">
</div>
<div class="nav-next small-6 column clearfix">
</div>
</section>
</div>
</div>
<div class="source-github row">
Found an error in this documentation? The source code for this page can be found <a href="https://github.com/akka/akka-persistence-jdbc/tree/v4.0.0/docs/src/main/paradox/index.md">here</a>.
Please feel free to edit and contribute a pull request.
</div>

<footer class="page-footer row clearfix">
<img class="akka-icon float-left show-for-medium" src="images/akka-icon.svg" />
<section class="copyright">
<div>Akka Persistence JDBC is Open Source and available under the Apache 2 License.</div>
<p class="legal">
&copy; 2011-2020 <a href="https://www.lightbend.com" target="_blank">Lightbend, Inc.</a> |
<a href="https://www.lightbend.com/legal/licenses" target="_blank">Licenses</a> |
<a href="https://www.lightbend.com/legal/terms" target="_blank">Terms</a> |
<a href="https://www.lightbend.com/legal/privacy" target="_blank">Privacy Policy</a> |
<a href="https://akka.io/cookie/" target="_blank">Cookie Listing</a> |
<a class="optanon-toggle-display">Cookie Settings</a>
</p>
</section>

</footer>
</section>
</main>
</div>

<script type="text/javascript" src="js/scrollsneak.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="js/groups.js"></script>
<script type="text/javascript" src="js/page.js"></script>
<script type="text/javascript" src="js/magellan.js"></script>
<script type="text/javascript" src="js/metadata-toggle.js"></script>

<style type="text/css">@import "lib/prettify/prettify.css";</style>
<script type="text/javascript" src="lib/prettify/prettify.js"></script>
<script type="text/javascript" src="lib/prettify/lang-scala.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(){window.prettyPrint && prettyPrint()});
//]]></script>
<script type="text/javascript" src="assets/js/warnOldVersion.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(jq){initOldVersionWarnings(jq, '4.0.0', 'https://doc.akka.io/docs/akka-persistence-jdbc/current/')});
//]]></script>


</body>
</html>
