<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>AMQP Connector · Alpakka</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="Alpakka is a Reactive Enterprise Integration library for Java and Scala, based on Reactive Streams and Akka."/><link rel="canonical" href="https://doc.akka.io/docs/alpakka/current/amqp.html"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:100normal,100italic,300normal,300italic,400normal,400italic,500normal,500italic,700normal,700italic,900normal,900italicc" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="js/page.js"></script>
<script type="text/javascript" src="js/groups.js"></script>
<link rel="stylesheet" type="text/css" href="lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="lib/foundation/dist/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="css/page.css"/>

<!--
<link rel="shortcut icon" href="images/favicon.ico" />
-->
</head>

<body>
<div class="off-canvas-wrapper">
<div class="off-canvas-wrapper-inner" data-off-canvas-wrapper>

<div class="off-canvas position-left" id="off-canvas-menu" data-off-canvas>
<nav class="off-canvas-nav">
<div class="nav-home">
<a href="index.html" >
<span class="home-icon">⌂</span>Alpakka
</a>
<div class="version-number">
0.18
</div>
</div>
<select class="supergroup" name="Language"><option class="group" value="group-scala">Scala</option><option class="group" value="group-java">Java</option></select>
<div class="nav-toc">
<ul>
  <li><a href="connectors.html" class="page">Connectors</a>
  <ul>
    <li><a href="amqp.html" class="active page">AMQP Connector</a></li>
    <li><a href="geode.html" class="page">Apache Geode connector</a></li>
    <li><a href="solr.html" class="page">Apache Solr Connector</a></li>
    <li><a href="dynamodb.html" class="page">AWS DynamoDB Connector</a></li>
    <li><a href="kinesis.html" class="page">AWS Kinesis Connector</a></li>
    <li><a href="awslambda.html" class="page">AWS Lambda Connector</a></li>
    <li><a href="s3.html" class="page">AWS S3 Connector</a></li>
    <li><a href="sns.html" class="page">AWS SNS Connector</a></li>
    <li><a href="sqs.html" class="page">AWS SQS Connector</a></li>
    <li><a href="azure-storage-queue.html" class="page">Azure Storage Queue Connector</a></li>
    <li><a href="cassandra.html" class="page">Cassandra Connector</a></li>
    <li><a href="elasticsearch.html" class="page">Elasticsearch Connector</a></li>
    <li><a href="file.html" class="page">File Connectors</a></li>
    <li><a href="ftp.html" class="page">FTP Connector</a></li>
    <li><a href="google-cloud-pub-sub.html" class="page">Google Cloud Pub/Sub</a></li>
    <li><a href="google-fcm.html" class="page">Google Firebase Cloud Messaging</a></li>
    <li><a href="hbase.html" class="page">HBase connector</a></li>
    <li><a href="ironmq.html" class="page">IronMq Connector</a></li>
    <li><a href="jms.html" class="page">JMS Connector</a></li>
    <li><a href="mongodb.html" class="page">MongoDB Connector</a></li>
    <li><a href="mqtt.html" class="page">MQTT Connector</a></li>
    <li><a href="orientdb.html" class="page">OrientDB Connector</a></li>
    <li><a href="sse.html" class="page">Server-sent Events (SSE) Connector</a></li>
    <li><a href="slick.html" class="page">Slick (JDBC) Connector</a></li>
    <li><a href="spring-web.html" class="page">Spring Web</a></li>
    <li><a href="unix-domain-socket.html" class="page">Unix Domain Socket Connector</a></li>
  </ul></li>
  <li><a href="external-connectors.html" class="page">External Connectors</a></li>
  <li><a href="external-components.html" class="page">External Components</a></li>
  <li><a href="examples/index.html" class="page">Self-contained examples</a>
  <ul>
    <li><a href="examples/jms-samples.html" class="page">JMS examples</a></li>
    <li><a href="examples/ftp-samples.html" class="page">FTP examples</a></li>
    <li><a href="examples/csv-samples.html" class="page">CSV examples</a></li>
    <li><a href="examples/elasticsearch-samples.html" class="page">Elasticsearch examples</a></li>
  </ul></li>
  <li><a href="other-docs.html" class="page">Other documentation</a></li>
  <li><a href="patterns.html" class="page">Integration Patterns</a></li>
  <li><a href="data-transformations/index.html" class="page">Data Transformations</a>
  <ul>
    <li><a href="data-transformations/parsing-lines.html" class="page">Parsing Lines</a></li>
    <li><a href="data-transformations/json.html" class="page">JSON</a></li>
    <li><a href="data-transformations/compression.html" class="page">Compressing/decompressing</a></li>
    <li><a href="data-transformations/csv.html" class="page">Comma-Separated Values - CSV</a></li>
    <li><a href="data-transformations/recordio.html" class="page">RecordIO Framing</a></li>
    <li><a href="data-transformations/xml.html" class="page">Extensible Markup Language - XML</a></li>
  </ul></li>
</ul>
</div>

</nav>
</div>

<div class="off-canvas-content" data-off-canvas-content>

<header class="site-header expanded row">
<div class="small-12 column">
<a href="#" class="off-canvas-toggle hide-for-medium" data-toggle="off-canvas-menu"><svg class="svg-icon svg-icon-menu" version="1.1" id="Menu" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"> <path class="svg-icon-menu-path" fill="#53CDEC" d="M16.4,9H3.6C3.048,9,3,9.447,3,10c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,9.447,16.952,9,16.4,9z M16.4,13
H3.6C3.048,13,3,13.447,3,14c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,13.447,16.952,13,16.4,13z M3.6,7H16.4
C16.952,7,17,6.553,17,6c0-0.553-0.048-1-0.6-1H3.6C3.048,5,3,5.447,3,6C3,6.553,3.048,7,3.6,7z"/></svg>
</a>
<div class="title"><a href="index.html" class="logo" style="margin-top: 15px;"><svg class="svg-icon svg-icon-logo" style="height: 45px; width: 184px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1070 262"><title>akka-stream-alpakka</title><g id="akka-stream-alpakka" class="svg-icon-logo-text" fill="#fff"><path d="M349.6 105.5v-12.2h19.9v58.4c0 7.1 1.7 9.8 6.1 9.8 1.2 0 2.7-.2 4.1-.3v16.1c-2.2.8-5.5 1.3-9.8 1.3-4.8 0-8.6-.8-11.6-2.7-3.7-2.5-6-5.8-6.8-10.1-5.8 8.8-15.4 13.1-28.7 13.1-11.8 0-21.7-4.1-29.9-12.6-8-8.5-12-18.8-12-31.2s4-22.7 12-31c8.1-8.5 18.1-12.6 29.9-12.6 13.6 0 23.7 6 26.8 14zm-5.9 47.9c5-4.8 7.5-11 7.5-18.3s-2.5-13.4-7.5-18.3c-4.8-4.8-11-7.3-18.1-7.3-7.1 0-12.9 2.5-17.8 7.3-4.6 4.8-7 11-7 18.3s2.3 13.4 7 18.3c4.8 4.8 10.6 7.3 17.8 7.3 7.1 0 13.3-2.5 18.1-7.3zM388.5 177v-115.7h19.8v67.6l30.9-35.5h22.8l-32.7 37.4 36.2 46.3h-22.6l-26.4-33.7-8.3 9.3v24.3h-19.7zM470.8 177v-115.7h19.8v67.6l30.9-35.5h22.9l-32.7 37.4 36.2 46.3h-22.6l-26.4-33.7-8.3 9.3v24.3h-19.8zM607.9 105.5v-12.2h19.9v58.4c0 7.1 1.7 9.8 6.1 9.8 1.2 0 2.7-.2 4.1-.3v16.1c-2.2.8-5.5 1.3-9.8 1.3-4.8 0-8.6-.8-11.6-2.7-3.7-2.5-6-5.8-6.8-10.1-5.8 8.8-15.4 13.1-28.7 13.1-11.8 0-21.7-4.1-29.9-12.6-8-8.5-12-18.8-12-31.2s4-22.7 12-31c8.1-8.5 18.1-12.6 29.9-12.6 13.5 0 23.6 6 26.8 14zm-6 47.9c5-4.8 7.5-11 7.5-18.3s-2.5-13.4-7.5-18.3c-4.8-4.8-11-7.3-18.1-7.3-7.1 0-12.9 2.5-17.8 7.3-4.6 4.8-7 11-7 18.3s2.3 13.4 7 18.3c4.8 4.8 10.6 7.3 17.8 7.3 7.1 0 13.3-2.5 18.1-7.3z"/></g><path fill="#0B5567" d="M230.3 212.8c35.9 28.7 58.9-57 1.7-72.8-48-13.3-96.3 9.5-144.7 62.7 0 0 89.4-32.7 143 10.1z"/><path fill="#15A9CE" d="M88.1 202c34.4-35.7 91.6-75.5 144.9-60.8 12.4 3.5 21.2 10.7 26.9 19.3l-50.4-101.7c-7.2-11.5-25.6-9.1-36-.3l-133.2 111.6c-12.1 10.4-12.8 28.9-1.6 40.1 9.9 9.9 25.6 10.8 36.5 2l12.9-10.2z"/></g></svg>
</a></div>

<!--
<a href="https://www.example.com" class="logo show-for-medium">logo</a>
-->
</div>
</header>

<div class="expanded row">

<div class="medium-3 large-2 show-for-medium column">
<nav class="site-nav">
<div class="nav-home">
<a href="index.html" >
<span class="home-icon">⌂</span>Alpakka
</a>
<div class="version-number">
0.18
</div>
</div>
<select class="supergroup" name="Language"><option class="group" value="group-scala">Scala</option><option class="group" value="group-java">Java</option></select>
<div class="nav-toc">
<ul>
  <li><a href="connectors.html" class="page">Connectors</a>
  <ul>
    <li><a href="amqp.html" class="active page">AMQP Connector</a></li>
    <li><a href="geode.html" class="page">Apache Geode connector</a></li>
    <li><a href="solr.html" class="page">Apache Solr Connector</a></li>
    <li><a href="dynamodb.html" class="page">AWS DynamoDB Connector</a></li>
    <li><a href="kinesis.html" class="page">AWS Kinesis Connector</a></li>
    <li><a href="awslambda.html" class="page">AWS Lambda Connector</a></li>
    <li><a href="s3.html" class="page">AWS S3 Connector</a></li>
    <li><a href="sns.html" class="page">AWS SNS Connector</a></li>
    <li><a href="sqs.html" class="page">AWS SQS Connector</a></li>
    <li><a href="azure-storage-queue.html" class="page">Azure Storage Queue Connector</a></li>
    <li><a href="cassandra.html" class="page">Cassandra Connector</a></li>
    <li><a href="elasticsearch.html" class="page">Elasticsearch Connector</a></li>
    <li><a href="file.html" class="page">File Connectors</a></li>
    <li><a href="ftp.html" class="page">FTP Connector</a></li>
    <li><a href="google-cloud-pub-sub.html" class="page">Google Cloud Pub/Sub</a></li>
    <li><a href="google-fcm.html" class="page">Google Firebase Cloud Messaging</a></li>
    <li><a href="hbase.html" class="page">HBase connector</a></li>
    <li><a href="ironmq.html" class="page">IronMq Connector</a></li>
    <li><a href="jms.html" class="page">JMS Connector</a></li>
    <li><a href="mongodb.html" class="page">MongoDB Connector</a></li>
    <li><a href="mqtt.html" class="page">MQTT Connector</a></li>
    <li><a href="orientdb.html" class="page">OrientDB Connector</a></li>
    <li><a href="sse.html" class="page">Server-sent Events (SSE) Connector</a></li>
    <li><a href="slick.html" class="page">Slick (JDBC) Connector</a></li>
    <li><a href="spring-web.html" class="page">Spring Web</a></li>
    <li><a href="unix-domain-socket.html" class="page">Unix Domain Socket Connector</a></li>
  </ul></li>
  <li><a href="external-connectors.html" class="page">External Connectors</a></li>
  <li><a href="external-components.html" class="page">External Components</a></li>
  <li><a href="examples/index.html" class="page">Self-contained examples</a>
  <ul>
    <li><a href="examples/jms-samples.html" class="page">JMS examples</a></li>
    <li><a href="examples/ftp-samples.html" class="page">FTP examples</a></li>
    <li><a href="examples/csv-samples.html" class="page">CSV examples</a></li>
    <li><a href="examples/elasticsearch-samples.html" class="page">Elasticsearch examples</a></li>
  </ul></li>
  <li><a href="other-docs.html" class="page">Other documentation</a></li>
  <li><a href="patterns.html" class="page">Integration Patterns</a></li>
  <li><a href="data-transformations/index.html" class="page">Data Transformations</a>
  <ul>
    <li><a href="data-transformations/parsing-lines.html" class="page">Parsing Lines</a></li>
    <li><a href="data-transformations/json.html" class="page">JSON</a></li>
    <li><a href="data-transformations/compression.html" class="page">Compressing/decompressing</a></li>
    <li><a href="data-transformations/csv.html" class="page">Comma-Separated Values - CSV</a></li>
    <li><a href="data-transformations/recordio.html" class="page">RecordIO Framing</a></li>
    <li><a href="data-transformations/xml.html" class="page">Extensible Markup Language - XML</a></li>
  </ul></li>
</ul>
</div>

</nav>
</div>

<div class="small-12 medium-9 large-10 column">
<section class="site-content">

<div class="page-header row">
<div class="medium-12 show-for-medium column">
<div class="nav-breadcrumbs">
<ul>
  <li><a href="index.html">Alpakka</a></li>
  <li><a href="connectors.html">Connectors</a></li>
  <li>AMQP Connector</li>
</ul>
</div>
</div>
</div>

<div class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h1><a href="#amqp-connector" name="amqp-connector" class="anchor"><span class="anchor-link"></span></a>AMQP Connector</h1>
<p>The AMQP connector provides Akka Stream sources and sinks to connect to AMQP servers.</p>
<h2><a href="#reported-issues" name="reported-issues" class="anchor"><span class="anchor-link"></span></a>Reported issues</h2>
<p><a href="https://github.com/akka/alpakka/labels/p%3Aamqp">Tagged issues at Github</a></p>
<h2><a href="#artifacts" name="artifacts" class="anchor"><span class="anchor-link"></span></a>Artifacts</h2><dl class="dependency"><dt>sbt</dt><dd><pre class="prettyprint"><code class="language-scala">libraryDependencies += "com.lightbend.akka" %% "akka-stream-alpakka-amqp" % "0.18"</code></pre></dd><dt>Maven</dt><dd><pre class="prettyprint"><code class="language-xml">&lt;dependency&gt;
  &lt;groupId&gt;com.lightbend.akka&lt;/groupId&gt;
  &lt;artifactId&gt;akka-stream-alpakka-amqp_2.12&lt;/artifactId&gt;
  &lt;version&gt;0.18&lt;/version&gt;
&lt;/dependency&gt;</code></pre></dd><dt>Gradle</dt><dd><pre class="prettyprint"><code class="language-gradle">dependencies {
  compile group: 'com.lightbend.akka', name: 'akka-stream-alpakka-amqp_2.12', version: '0.18'
}</code></pre></dd></dl>
<h2><a href="#usage" name="usage" class="anchor"><span class="anchor-link"></span></a>Usage</h2>
<h3><a href="#connecting-to-amqp-server" name="connecting-to-amqp-server" class="anchor"><span class="anchor-link"></span></a>Connecting to AMQP server</h3>
<p>All the AMQP connectors are configured using a <a href="http://developer.lightbend.com/docs/api/alpakka/0.18/akka/stream/alpakka/amqp/AmqpConnectionProvider.html">AmqpConnectionProvider</a> and a list of <a href="http://developer.lightbend.com/docs/api/alpakka/0.18/akka/stream/alpakka/amqp/Declaration.html">Declaration</a></p>
<p>There are several types of <a href="http://developer.lightbend.com/docs/api/alpakka/0.18/akka/stream/alpakka/amqp/AmqpConnectionProvider.html">AmqpConnectionProvider</a>:</p>
<ul>
  <li><a href="http://developer.lightbend.com/docs/api/alpakka/0.18/akka/stream/alpakka/amqp/AmqpLocalConnectionProvider.html">AmqpLocalConnectionProvider</a> which connects to the default localhost. It creates a new connection for each stage.</li>
  <li><a href="http://developer.lightbend.com/docs/api/alpakka/0.18/akka/stream/alpakka/amqp/AmqpUriConnectionProvider.html">AmqpUriConnectionProvider</a> which connects to the given AMQP URI. It creates a new connection for each stage.</li>
  <li><a href="http://developer.lightbend.com/docs/api/alpakka/0.18/akka/stream/alpakka/amqp/AmqpDetailsConnectionProvider.html">AmqpDetailsConnectionProvider</a> which supports more fine-grained configuration. It creates a new connection for each stage.</li>
  <li><a href="http://developer.lightbend.com/docs/api/alpakka/0.18/akka/stream/alpakka/amqp/AmqpConnectionFactoryConnectionProvider.html">AmqpConnectionFactoryConnectionProvider</a> which takes a raw <a href="https://www.rabbitmq.com/releases/rabbitmq-java-client/current-javadoc/com/rabbitmq/client/ConnectionFactory.html">ConnectionFactory</a>. It creates a new connection for each stage.</li>
  <li><a href="http://developer.lightbend.com/docs/api/alpakka/0.18/akka/stream/alpakka/amqp/AmqpCachedConnectionProvider.html">AmqpCachedConnectionProvider</a> which receive any other provider as parameter and caches the connection it provides to be used in all stages. By default it closes the connection whenever the last stage using the provider stops. Optionally, it takes <code>automaticRelease</code> boolean parameter so the connection is not automatically release and the user have to release it explicitly.</li>
</ul>
<h3><a href="#sending-messages-to-amqp-server" name="sending-messages-to-amqp-server" class="anchor"><span class="anchor-link"></span></a>Sending messages to AMQP server</h3>
<p>First define a queue name and the declaration of the queue that the messages will be sent to.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><code class="language-scala">val queueName = &quot;amqp-conn-it-spec-simple-queue-&quot; + System.currentTimeMillis()
val queueDeclaration = QueueDeclaration(queueName)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><code class="language-java">final String queueName = &quot;amqp-conn-it-spec-simple-queue-&quot; + System.currentTimeMillis();
final QueueDeclaration queueDeclaration = QueueDeclaration.create(queueName);</code></pre></dd>
</dl>
<p>Here we used <a href="http://developer.lightbend.com/docs/api/alpakka/0.18/akka/stream/alpakka/amqp/QueueDeclaration.html">QueueDeclaration</a> configuration class to create a queue declaration.</p>
<p>Create a sink, that accepts and forwards <a href="https://doc.akka.io/api/akka/2.5.11/akka/util/ByteString.html">ByteString</a>s to the AMQP server.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><code class="language-scala">val amqpSink = AmqpSink.simple(
  AmqpSinkSettings(connectionProvider)
    .withRoutingKey(queueName)
    .withDeclarations(queueDeclaration)
)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><code class="language-java">final Sink&lt;ByteString, CompletionStage&lt;Done&gt;&gt; amqpSink = AmqpSink.createSimple(
    AmqpSinkSettings.create(connectionProvider)
        .withRoutingKey(queueName)
        .withDeclarations(queueDeclaration)
);</code></pre></dd>
</dl>
<p><a href="http://developer.lightbend.com/docs/api/alpakka/0.18/akka/stream/alpakka/amqp/AmqpSink$.html">AmqpSink</a> is a collection of factory methods that facilitates creation of sinks. Here we created a <em>simple</em> sink, which means that we are able to pass <code>ByteString</code>s to the sink instead of wrapping data into <a href="http://developer.lightbend.com/docs/api/alpakka/0.18/akka/stream/alpakka/amqp/OutgoingMessage.html">OutgoingMessage</a>s.</p>
<p>Last step is to <a href="https://doc.akka.io/docs/akka/2.5.11/scala/stream/stream-flows-and-basics">materialize</a> and run the sink we have created.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><code class="language-scala">val input = Vector(&quot;one&quot;, &quot;two&quot;, &quot;three&quot;, &quot;four&quot;, &quot;five&quot;)
Source(input).map(s =&gt; ByteString(s)).runWith(amqpSink).futureValue shouldEqual Done</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><code class="language-java">final List&lt;String&gt; input = Arrays.asList(&quot;one&quot;, &quot;two&quot;, &quot;three&quot;, &quot;four&quot;, &quot;five&quot;);
Source.from(input).map(ByteString::fromString).runWith(amqpSink, materializer);</code></pre></dd>
</dl>
<h3><a href="#receiving-messages-from-amqp-server" name="receiving-messages-from-amqp-server" class="anchor"><span class="anchor-link"></span></a>Receiving messages from AMQP server</h3>
<p>Create a source using the same queue declaration as before.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><code class="language-scala">val amqpSource = AmqpSource.atMostOnceSource(
  NamedQueueSourceSettings(connectionProvider, queueName).withDeclarations(queueDeclaration),
  bufferSize = 10
)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><code class="language-java">final Integer bufferSize = 10;
final Source&lt;IncomingMessage, NotUsed&gt; amqpSource = AmqpSource.atMostOnceSource(
    NamedQueueSourceSettings.create(
        connectionProvider,
        queueName
    ).withDeclarations(queueDeclaration),
    bufferSize
);</code></pre></dd>
</dl>
<p>The <code>bufferSize</code> parameter controls the maximum number of messages to prefetch from the AMQP server.</p>
<p>Run the source and take the same amount of messages as we previously sent to it.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><code class="language-scala">val result = amqpSource.take(input.size).runWith(Sink.seq)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><code class="language-java">final CompletionStage&lt;List&lt;IncomingMessage&gt;&gt; result = amqpSource.take(input.size()).runWith(Sink.seq(), materializer);</code></pre></dd>
</dl>
<p>This is how you send and receive message from AMQP server using this connector.</p>
<h3><a href="#using-pub-sub-with-an-amqp-server" name="using-pub-sub-with-an-amqp-server" class="anchor"><span class="anchor-link"></span></a>Using Pub/Sub with an AMQP server</h3>
<p>Instead of sending messages directly to queues, it is possible to send messages to an exchange and then provide instructions to AMQP server what to do with incoming messages to the exchange. We are going to use the <em>fanout</em> type of the exchange, which enables message broadcasting to multiple consumers. We are going to do that by using an exchange declaration for the sink and all of the sources.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><code class="language-scala">val exchangeName = &quot;amqp-conn-it-spec-pub-sub-&quot; + System.currentTimeMillis()
val exchangeDeclaration = ExchangeDeclaration(exchangeName, &quot;fanout&quot;)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><code class="language-java">final String exchangeName = &quot;amqp-conn-it-spec-pub-sub&quot; + System.currentTimeMillis();
final ExchangeDeclaration exchangeDeclaration = ExchangeDeclaration.create(exchangeName, &quot;fanout&quot;);</code></pre></dd>
</dl>
<p>The sink for the exchange is created in a very similar way.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><code class="language-scala">val amqpSink = AmqpSink.simple(
  AmqpSinkSettings(connectionProvider)
    .withExchange(exchangeName)
    .withDeclarations(exchangeDeclaration)
)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><code class="language-java">final Sink&lt;ByteString, CompletionStage&lt;Done&gt;&gt; amqpSink = AmqpSink.createSimple(
  AmqpSinkSettings.create(connectionProvider)
        .withExchange(exchangeName)
        .withDeclarations(exchangeDeclaration)
);</code></pre></dd>
</dl>
<p>For the source, we are going to create multiple sources and merge them using <a href="https://doc.akka.io/docs/akka/2.5.11/scala/stream/stages-overview">Akka Streams API</a>.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><code class="language-scala">val fanoutSize = 4

val mergedSources = (0 until fanoutSize).foldLeft(Source.empty[(Int, String)]) {
  case (source, fanoutBranch) =&gt;
    source.merge(
      AmqpSource
        .atMostOnceSource(
          TemporaryQueueSourceSettings(
            connectionProvider,
            exchangeName
          ).withDeclarations(exchangeDeclaration),
          bufferSize = 1
        )
        .map(msg =&gt; (fanoutBranch, msg.bytes.utf8String))
    )
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><code class="language-java">final Integer fanoutSize = 4;
final Integer bufferSize = 1;

Source&lt;Pair&lt;Integer, String&gt;, NotUsed&gt; mergedSources = Source.empty();
for (Integer i = 0; i &lt; fanoutSize; i++) {
  final Integer fanoutBranch = i;
  mergedSources = mergedSources.merge(
      AmqpSource.atMostOnceSource(
          TemporaryQueueSourceSettings.create(
              connectionProvider,
              exchangeName
          ).withDeclarations(exchangeDeclaration),
          bufferSize
      )
          .map(msg -&gt; Pair.create(fanoutBranch, msg.bytes().utf8String()))
  );
}</code></pre></dd>
</dl>
<p>We merge all sources into one and add the index of the source to all incoming messages, so we can distinguish which source the incoming message came from.</p>
<p>Such sink and source can be started the same way as in the previous example.</p>
<h3><a href="#using-rabbitmq-as-an-rpc-mechanism" name="using-rabbitmq-as-an-rpc-mechanism" class="anchor"><span class="anchor-link"></span></a>Using rabbitmq as an RPC mechanism</h3>
<p>If you have remote workers that you want to incorporate into a stream, you can do it using rabbit RPC workflow <a href="https://www.rabbitmq.com/tutorials/tutorial-six-java.html">RabbitMQ RPC</a></p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><code class="language-scala">val amqpRpcFlow = AmqpRpcFlow.simple(
  AmqpSinkSettings(connectionProvider).withRoutingKey(queueName).withDeclarations(queueDeclaration)
)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><code class="language-java">final Flow&lt;ByteString,ByteString, CompletionStage&lt;String&gt;&gt; ampqRpcFlow = AmqpRpcFlow.createSimple(
    AmqpSinkSettings.create(connectionProvider).withRoutingKey(queueName).withDeclarations(queueDeclaration), 1);</code></pre></dd>
</dl>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><code class="language-scala">val (rpcQueueF, probe) = Source(input)
  .map(s =&gt; ByteString(s))
  .viaMat(amqpRpcFlow)(Keep.right)
  .toMat(TestSink.probe)(Keep.both)
  .run</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><code class="language-java">Pair&lt;CompletionStage&lt;String&gt;, TestSubscriber.Probe&lt;ByteString&gt;&gt; result = Source.from(input)
    .map(ByteString::fromString)
    .viaMat(ampqRpcFlow, Keep.right())
    .toMat(TestSink.probe(system), Keep.both())
    .run(materializer);</code></pre></dd>
</dl>
<h3><a href="#acknowledging-messages-downstream" name="acknowledging-messages-downstream" class="anchor"><span class="anchor-link"></span></a>Acknowledging messages downstream</h3>
<p>Create a committable sink which returns </p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><code class="language-scala">val amqpSource = AmqpSource.committableSource(
  NamedQueueSourceSettings(connectionProvider, queueName).withDeclarations(queueDeclaration),
  bufferSize = 10
)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><code class="language-java">final Integer bufferSize = 10;
final Source&lt;CommittableIncomingMessage, NotUsed&gt; amqpSource = AmqpSource.committableSource(
  NamedQueueSourceSettings.create(
    connectionProvider,
    queueName
  ).withDeclarations(queueDeclaration),
  bufferSize
);</code></pre></dd>
</dl>
<p>Committable sources return <a href="http://developer.lightbend.com/docs/api/alpakka/0.18/akka/stream/alpakka/amqp/CommittableIncomingMessage.html">CommittableIncomingMessage</a> which wraps the <a href="http://developer.lightbend.com/docs/api/alpakka/0.18/akka/stream/alpakka/amqp/IncomingMessage.html">IncomingMessage</a> and exposes the methods ack and nack.</p>
<p>Use ack to acknowledge the message back to RabbitMQ. Ack takes an optional boolean parameter <code>multiple</code> indicating whether you are acknowledging the individual message or all the messages up to it.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><code class="language-scala">val result = amqpSource
  .mapAsync(1)(cm =&gt; cm.ack().map(_ =&gt; cm))
  .take(input.size)
  .runWith(Sink.seq)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><code class="language-java">final CompletionStage&lt;List&lt;IncomingMessage&gt;&gt; result =
    amqpSource
        .mapAsync(1, cm -&gt; cm.ack(false).thenApply(unused -&gt; cm.message()))
        .take(input.size())
        .runWith(Sink.seq(), materializer);</code></pre></dd>
</dl>
<p>Use nack to reject a message. Apart from the <code>multiple</code> argument, nack takes another optional boolean parameter indicating whether the item should be requeued or not.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><code class="language-scala">val result1 = amqpSource
  .take(input.size)
  .mapAsync(1)(cm =&gt; cm.nack().map(_ =&gt; cm))
  .runWith(Sink.seq)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><code class="language-java">final CompletionStage&lt;List&lt;CommittableIncomingMessage&gt;&gt; result1 = amqpSource
    .take(input.size())
    .mapAsync(1, cm -&gt; cm.nack(false, true).thenApply(unused -&gt; cm))
    .runWith(Sink.seq(), materializer);</code></pre></dd>
</dl>
<h3><a href="#running-the-example-code" name="running-the-example-code" class="anchor"><span class="anchor-link"></span></a>Running the example code</h3>
<p>The code in this guide is part of runnable tests of this project. You are welcome to edit the code and run it in sbt.</p>
<blockquote>
  <p>Test code requires AMQP server running in the background. You can start one quickly using docker:</p>
  <p><code>docker-compose up amqp</code></p>
</blockquote>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre><code>sbt
&gt; amqp/testOnly *.AmqpConnectorsSpec
</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre><code>sbt
&gt; amqp/testOnly *.AmqpConnectorsTest
</code></pre></dd>
</dl>
<div class="source-github">
The source code for this page can be found <a href="https://github.com/akka/alpakka/tree/master/docs/src/main/paradox/amqp.md">here</a>.
</div>

<div class="nav-next">
<p><strong>Next:</strong> <a href="geode.html">Apache Geode connector</a></p>
</div>
</div>
<div class="large-3 show-for-large column" data-sticky-container>
<nav class="sidebar sticky" data-sticky data-anchor="docs" data-sticky-on="large">
<div class="page-nav">
<div class="nav-title">On this page:</div>
<div class="nav-toc">
<ul>
  <li><a href="amqp.html#amqp-connector" class="header">AMQP Connector</a>
  <ul>
    <li><a href="amqp.html#reported-issues" class="header">Reported issues</a></li>
    <li><a href="amqp.html#artifacts" class="header">Artifacts</a></li>
    <li><a href="amqp.html#usage" class="header">Usage</a></li>
  </ul></li>
</ul>
</div>
</div>
</nav>
</div>
</div>

</section>
</div>

</div>

<footer class="site-footer">

<section class="site-footer-nav">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 medium-4 large-3 text-center column">
<div class="nav-links">
<ul>
<!-- <li><a href="https://www.example.com/products/">Products</a> -->
</ul>
</div>
</div>

</div>
</div>
</div>
</section>

<section class="site-footer-base">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 text-center large-9 column">

<!--
<div class="copyright">
<span class="text">&copy; 2019</span>
<a href="https://www.example.com" class="logo">logo</a>
</div>
-->
</div>

</div>
</div>
</div>
</section>
</footer>

</div>
</div>
</div>
</body>

<script type="text/javascript" src="lib/foundation/dist/foundation.min.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="js/magellan.js"></script>

<style type="text/css">@import "lib/prettify/prettify.css";</style>
<script type="text/javascript" src="lib/prettify/prettify.js"></script>
<script type="text/javascript" src="lib/prettify/lang-scala.js"></script>
<script type="text/javascript">jQuery(function(){window.prettyPrint && prettyPrint()});</script>

</html>
