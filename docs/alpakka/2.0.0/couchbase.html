<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Couchbase &bull; Alpakka Documentation</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="Alpakka is a Reactive Enterprise Integration library for Java and Scala, based on Reactive Streams and Akka."/>
<link rel="canonical" href="https://doc.akka.io/docs/alpakka/current/couchbase.html"/>
<script type="text/javascript" src="lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="lib/foundation/dist/js/foundation.min.js"></script>
<link rel="stylesheet" type="text/css" href="lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="lib/foundation/dist/css/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" type="text/css" href="css/icons.css"/>
<link rel="stylesheet" type="text/css" href="css/page-7.css"/>
<link rel="stylesheet" type="text/css" href="css/banner-1.css"/>
<link rel="shortcut icon" href="images/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png"/>
<link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png"/>
<link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png"/>
<link rel="manifest" href="images/manifest.json"/>
<meta name="msapplication-TileImage" content="images/mstile-150x150.png"/>
<meta name="msapplication-TileColor" content="#15a9ce"/>
<meta name="theme-color" content="#15a9ce"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) start -->
<script src="https://optanon.blob.core.windows.net/consent/159bb13d-6748-4399-806e-ac28db879785.js" type="text/javascript" charset="UTF-8"></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) end -->
<!--Google Analytics-->
<script type="text/plain" class="optanon-category-2">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', '']);
_gaq.push(['_setDomainName', '']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})()
</script>
<!-- Google Tag Manager -->
<script type="text/plain" class="optanon-category-2">
(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KBJGH35');
</script>
<!--Marketo-->
<script type="text/plain" class="optanon-category-3">
(function() {
var didInit = false;
function initMunchkin() {
if(didInit === false) {
didInit = true;
Munchkin.init('558-NCX-702', { 'asyncOnly': true, 'disableClickDelay': true });
}
}
var s = document.createElement('script');
s.type = 'text/javascript';
s.async = true;
s.src = '//munchkin.marketo.net/munchkin.js';
s.onreadystatechange = function() {
if (this.readyState == 'complete' || this.readyState == 'loaded') {
initMunchkin();
}
};
s.onload = initMunchkin;
document.getElementsByTagName('head')[0].appendChild(s);
})();
</script>
</head>

<body id="underlay" data-toggler="nav-open">
<div id="lightbend-banner" class="lightbend-banner akka full-width" data-category="OSS Lightbend Banner Impression" data-label="Akka Banner Impression">
<div class="wrapper">
<div class="brand">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lightbend Logo - Akka Banner" href="https://www.lightbend.com?r=oss-banner-akka" target="_blank">
<img class="lightbend-logo" src="images/banner-logos/lightbend-reverse.svg" alt="Lightbend" title="Lightbend">
</a>
</div>
<div class="nav">
<a class="banner-btn oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Enhance your Akka systems with Akka Platform [Button] - Akka Banner" href="https://www.lightbend.com/akka-core-of-lightbend?r=oss-banner-akka" target="_blank">
<span>Enhance your Akka systems with</span>
<img class="akka-platform-reverse-logo" src="images/banner-logos/akka-platform-reverse.svg" alt="Akka Platform" title="Akka Platform">
</a>
<div class="drop-down">
<svg class="svg-chevon-circle-down" version="1.1" id="Chevron_circled_down" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve">
<path fill="#ffffff" d="M12.505,8.698L10,11L7.494,8.698c-0.198-0.196-0.518-0.196-0.718,0c-0.197,0.196-0.197,0.515,0,0.71l2.864,2.807
c0.199,0.196,0.52,0.196,0.717,0l2.864-2.807c0.199-0.195,0.198-0.514,0-0.71C13.024,8.502,12.704,8.502,12.505,8.698z M10,0.4
c-5.302,0-9.6,4.298-9.6,9.6c0,5.303,4.298,9.6,9.6,9.6s9.6-4.297,9.6-9.6C19.6,4.698,15.302,0.4,10,0.4z M10,18.354
c-4.615,0-8.354-3.74-8.354-8.354c0-4.614,3.739-8.354,8.354-8.354c4.613,0,8.354,3.74,8.354,8.354
C18.354,14.614,14.613,18.354,10,18.354z" />
</svg>
<div class="drop-down-content">
<div class="lightbend-family">
<a href="https://cloudflow.io" class="cloudflow oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Cloudflow - Logo Tag Line - Akka Banner">
<img class="cloudflow-full-color-logo" src="images/banner-logos/cloudflow-full-color.svg" alt="Cloudflow by Lightbend" title="Cloudflow by Lightbend">
</a>
<a href="https://cloudstate.io" class="cloudstate oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Cloudstate - Logo Tag Line - Akka Banner">
<img class="cloudstate-full-color-logo" src="images/banner-logos/cloudstate-full-color.svg" alt="Cloudstate by Lightbend" title="Cloudstate by Lightbend">
</a>
<a href="https://www.lagomframework.com" class="lagom oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lagom - Logo Tag Line - Akka Banner">
<img class="lagom-full-color-logo" src="images/banner-logos/lagom-full-color.svg" alt="Lagom Framework by Lightbend" title="Lagom Framework by Lightbend">
</a>
<a href="https://www.playframework.com" class="play oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Play - Logo Tag Line - Akka Banner">
<img class="play-full-color-logo" src="images/banner-logos/play-full-color.svg" alt="Play Framework by Lightbend" title="Play Framework by Lightbend">
</a>
<a href="https://www.scala-lang.org" class="scala oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Scala - Logo Tag Line - Akka Banner">
<img class="scala-full-color-logo" src="images/banner-logos/scala-full-color.svg" alt="Scala by Lightbend" title="Scala by Lightbend">
</a>
<div class="akka current">
<img class="akka-full-color-logo" src="images/banner-logos/akka-full-color.svg" alt="Akka by Lightbend" title="Akka by Lightbend">
<span>From the creators of <strong>Akka</strong>, get technology enhancements, monitoring, and expert support with Akka Platform from Lightbend.</span>
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Learn More [Button] - Akka Banner" href="https://www.lightbend.com/akka-core-of-lightbend?r=oss-banner-akka" target="_blank">Learn More</a>
</div>
</div>
<div class="title">The Lightbend Family</div>
</div>      
</div>
</div>
</div>
</div>
<header class="site-header hide-for-large">
<div class="sticky-header clearfix">
<a href="https://akka.io"><img class="logo" src="images/akka-alpakka-reverse.svg"/></a>

<button class="menu-icon float-right" type="button" data-toggle="underlay overlay"></button>
</div>
<div id="overlay" class="overlay-nav" data-toggler="nav-open">
<header class="nav-header">
<div class="nav-header-title">
<h1><a href="index.html">Alpakka Documentation</a></h1>
</div>
<div class="nav-header-version">
Version 2.0.0
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="nav-toc">
<ul>
  <li><a href="overview.html" class="page">Overview</a></li>
  <li><a href="data-transformations/index.html" class="page">Data Transformations</a></li>
  <li><a href="amqp.html" class="page">AMQP</a></li>
  <li><a href="external/apache-camel.html" class="page">Apache Camel</a></li>
  <li><a href="cassandra.html" class="page">Apache Cassandra</a></li>
  <li><a href="geode.html" class="page">Apache Geode</a></li>
  <li><a href="kafka.html" class="page">Apache Kafka</a></li>
  <li><a href="kudu.html" class="page">Apache Kudu</a></li>
  <li><a href="solr.html" class="page">Apache Solr</a></li>
  <li><a href="avroparquet.html" class="page">Avro Parquet</a></li>
  <li><a href="dynamodb.html" class="page">AWS DynamoDB</a></li>
  <li><a href="kinesis.html" class="page">AWS Kinesis and Firehose</a></li>
  <li><a href="awslambda.html" class="page">AWS Lambda</a></li>
  <li><a href="s3.html" class="page">AWS S3</a></li>
  <li><a href="sns.html" class="page">AWS SNS</a></li>
  <li><a href="sqs.html" class="page">AWS SQS</a></li>
  <li><a href="external/azure-event-hubs.html" class="page">Azure Event Hubs</a></li>
  <li><a href="external/azure-iot-hub.html" class="page">Azure IoT Hub</a></li>
  <li><a href="azure-storage-queue.html" class="page">Azure Storage Queue</a></li>
  <li><a href="couchbase.html#couchbase" class="active page">Couchbase</a>
  <ul>
    <li><a href="couchbase.html#artifacts" class="header">Artifacts</a></li>
    <li><a href="couchbase.html#overview" class="header">Overview</a></li>
    <li><a href="couchbase.html#reading-from-couchbase-in-akka-streams" class="header">Reading from Couchbase in Akka Streams</a></li>
    <li><a href="couchbase.html#writing-to-couchbase-in-akka-streams" class="header">Writing to Couchbase in Akka Streams</a></li>
    <li><a href="couchbase.html#using-couchbasesession-directly" class="header">Using <code>CouchbaseSession</code> directly</a></li>
  </ul></li>
  <li><a href="elasticsearch.html" class="page">Elasticsearch</a></li>
  <li><a href="external/eventuate.html" class="page">Eventuate</a></li>
  <li><a href="file.html" class="page">File</a></li>
  <li><a href="external/fs2.html" class="page">FS2</a></li>
  <li><a href="ftp.html" class="page">FTP</a></li>
  <li><a href="google-cloud-pub-sub.html" class="page">Google Cloud Pub/Sub</a></li>
  <li><a href="google-cloud-pub-sub-grpc.html" class="page">Google Cloud Pub/Sub gRPC</a></li>
  <li><a href="google-cloud-storage.html" class="page">Google Cloud Storage</a></li>
  <li><a href="google-fcm.html" class="page">Google FCM</a></li>
  <li><a href="external/grpc.html" class="page">gRPC</a></li>
  <li><a href="hdfs.html" class="page">Hadoop Distributed File System - HDFS</a></li>
  <li><a href="hbase.html" class="page">HBase</a></li>
  <li><a href="external/http.html" class="page">HTTP</a></li>
  <li><a href="bluemix-cos.html" class="page">IBM Bluemix Cloud Object Storage</a></li>
  <li><a href="external/db2-event-store.html" class="page">IBM Db2 Event Store</a></li>
  <li><a href="influxdb.html" class="page">InfluxDB</a></li>
  <li><a href="ironmq.html" class="page">IronMQ</a></li>
  <li><a href="jms/index.html" class="page">JMS</a></li>
  <li><a href="external/mapr.html" class="page">MapR Database</a></li>
  <li><a href="mongodb.html" class="page">MongoDB</a></li>
  <li><a href="mqtt.html" class="page">MQTT</a></li>
  <li><a href="mqtt-streaming.html" class="page">MQTT Streaming</a></li>
  <li><a href="orientdb.html" class="page">OrientDB</a></li>
  <li><a href="external/pulsar.html" class="page">Pulsar</a></li>
  <li><a href="pravega.html" class="page">Pravega</a></li>
  <li><a href="sse.html" class="page">Server-sent Events (SSE)</a></li>
  <li><a href="slick.html" class="page">Slick (JDBC)</a></li>
  <li><a href="spring-web.html" class="page">Spring Web</a></li>
  <li><a href="external/tcp.html" class="page">TCP</a></li>
  <li><a href="udp.html" class="page">UDP</a></li>
  <li><a href="unix-domain-socket.html" class="page">Unix Domain Socket</a></li>
</ul>
</nav>
</div>
</header>
<div class="site-content-wrapper">
<aside class="sticky-sidebar show-for-large">
<header class="nav-header sticky-sidebar-header">
<div class="nav-header-title">
<h1><a href="index.html">Alpakka Documentation</a></h1>
</div>
<div class="nav-header-version">
Version 2.0.0
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="site-nav sticky-sidebar-contents">
<div class="nav-toc">
<ul>
  <li><a href="overview.html" class="page">Overview</a></li>
  <li><a href="data-transformations/index.html" class="page">Data Transformations</a></li>
  <li><a href="amqp.html" class="page">AMQP</a></li>
  <li><a href="external/apache-camel.html" class="page">Apache Camel</a></li>
  <li><a href="cassandra.html" class="page">Apache Cassandra</a></li>
  <li><a href="geode.html" class="page">Apache Geode</a></li>
  <li><a href="kafka.html" class="page">Apache Kafka</a></li>
  <li><a href="kudu.html" class="page">Apache Kudu</a></li>
  <li><a href="solr.html" class="page">Apache Solr</a></li>
  <li><a href="avroparquet.html" class="page">Avro Parquet</a></li>
  <li><a href="dynamodb.html" class="page">AWS DynamoDB</a></li>
  <li><a href="kinesis.html" class="page">AWS Kinesis and Firehose</a></li>
  <li><a href="awslambda.html" class="page">AWS Lambda</a></li>
  <li><a href="s3.html" class="page">AWS S3</a></li>
  <li><a href="sns.html" class="page">AWS SNS</a></li>
  <li><a href="sqs.html" class="page">AWS SQS</a></li>
  <li><a href="external/azure-event-hubs.html" class="page">Azure Event Hubs</a></li>
  <li><a href="external/azure-iot-hub.html" class="page">Azure IoT Hub</a></li>
  <li><a href="azure-storage-queue.html" class="page">Azure Storage Queue</a></li>
  <li><a href="couchbase.html#couchbase" class="active page">Couchbase</a>
  <ul>
    <li><a href="couchbase.html#artifacts" class="header">Artifacts</a></li>
    <li><a href="couchbase.html#overview" class="header">Overview</a></li>
    <li><a href="couchbase.html#reading-from-couchbase-in-akka-streams" class="header">Reading from Couchbase in Akka Streams</a></li>
    <li><a href="couchbase.html#writing-to-couchbase-in-akka-streams" class="header">Writing to Couchbase in Akka Streams</a></li>
    <li><a href="couchbase.html#using-couchbasesession-directly" class="header">Using <code>CouchbaseSession</code> directly</a></li>
  </ul></li>
  <li><a href="elasticsearch.html" class="page">Elasticsearch</a></li>
  <li><a href="external/eventuate.html" class="page">Eventuate</a></li>
  <li><a href="file.html" class="page">File</a></li>
  <li><a href="external/fs2.html" class="page">FS2</a></li>
  <li><a href="ftp.html" class="page">FTP</a></li>
  <li><a href="google-cloud-pub-sub.html" class="page">Google Cloud Pub/Sub</a></li>
  <li><a href="google-cloud-pub-sub-grpc.html" class="page">Google Cloud Pub/Sub gRPC</a></li>
  <li><a href="google-cloud-storage.html" class="page">Google Cloud Storage</a></li>
  <li><a href="google-fcm.html" class="page">Google FCM</a></li>
  <li><a href="external/grpc.html" class="page">gRPC</a></li>
  <li><a href="hdfs.html" class="page">Hadoop Distributed File System - HDFS</a></li>
  <li><a href="hbase.html" class="page">HBase</a></li>
  <li><a href="external/http.html" class="page">HTTP</a></li>
  <li><a href="bluemix-cos.html" class="page">IBM Bluemix Cloud Object Storage</a></li>
  <li><a href="external/db2-event-store.html" class="page">IBM Db2 Event Store</a></li>
  <li><a href="influxdb.html" class="page">InfluxDB</a></li>
  <li><a href="ironmq.html" class="page">IronMQ</a></li>
  <li><a href="jms/index.html" class="page">JMS</a></li>
  <li><a href="external/mapr.html" class="page">MapR Database</a></li>
  <li><a href="mongodb.html" class="page">MongoDB</a></li>
  <li><a href="mqtt.html" class="page">MQTT</a></li>
  <li><a href="mqtt-streaming.html" class="page">MQTT Streaming</a></li>
  <li><a href="orientdb.html" class="page">OrientDB</a></li>
  <li><a href="external/pulsar.html" class="page">Pulsar</a></li>
  <li><a href="pravega.html" class="page">Pravega</a></li>
  <li><a href="sse.html" class="page">Server-sent Events (SSE)</a></li>
  <li><a href="slick.html" class="page">Slick (JDBC)</a></li>
  <li><a href="spring-web.html" class="page">Spring Web</a></li>
  <li><a href="external/tcp.html" class="page">TCP</a></li>
  <li><a href="udp.html" class="page">UDP</a></li>
  <li><a href="unix-domain-socket.html" class="page">Unix Domain Socket</a></li>
</ul>
</div>
</nav>
<footer class="nav-footer sticky-sidebar-footer">
<a href="https://akka.io"><img class="logo" src="images/akka-alpakka-reverse.svg"/></a>

</footer>
</aside>
<main class="fixed-shift-for-large expanded row">
<section class="site-content small-12 column">
<article class="page-content row">
<div class="small-12 column" id="docs">
<h1><a href="#couchbase" name="couchbase" class="anchor"><span class="anchor-link"></span></a>Couchbase</h1><div class="callout note "><div class="callout-title">Couchbase</div>
<p>Couchbase is an open-source, distributed (shared-nothing architecture) multi-model NoSQL document-oriented database software package that is optimized for interactive applications. These applications may serve many concurrent users by creating, storing, retrieving, aggregating, manipulating and presenting data. In support of these kinds of application needs, Couchbase Server is designed to provide easy-to-scale key-value or JSON document access with low latency and high sustained throughput. It is designed to be clustered from a single machine to very large-scale deployments spanning many machines. </p>
<p>Couchbase provides client protocol compatibility with memcached, but adds disk persistence, data replication, live cluster reconfiguration, rebalancing and multitenancy with data partitioning. </p>
<p>&ndash; <a href="https://en.wikipedia.org/wiki/Couchbase_Server">Wikipedia</a></p></div>
<p>Alpakka Couchbase allows you to read and write to Couchbase. You can query a bucket from CouchbaseSource using N1QL queries or reading by document ID. Couchbase connector uses <a href="https://docs.couchbase.com/java-sdk/2.7/start-using-sdk.html">Couchbase Java SDK</a> version 2.7.13 behind the scenes.</p>
<p>The Couchbase connector supports all document formats which are supported by the SDK. All those formats use the <span class="group-java"><code>Document&lt;T&gt;</code></span><span class="group-scala"><code>Document[T]</code></span> interface and this is the level of abstraction that this connector is using.</p>
<table class="project-info">
<tr><th colspan="2">Project Info: Alpakka Couchbase</th></tr>
  <tr><th>Artifact</th><td><div>com.lightbend.akka</div>
  <div>akka-stream-alpakka-couchbase</div>
  <div>2.0.0</div>
  <div><a href="other-docs/snapshots.html">Snapshots are available</a></div>
  </td></tr>
  <tr><th>JDK versions</th><td><div>Adopt OpenJDK 8</div><div>Adopt OpenJDK 11</div></td></tr>
  <tr><th>Scala versions</th><td>2.12.10, 2.11.12, 2.13.1</td></tr>
  <tr><th>JPMS module name</th><td>akka.stream.alpakka.couchbase</td></tr>
  <tr><th>License</th><td><div><a href="https://www.apache.org/licenses/LICENSE-2.0" target="_blank" rel="noopener noreferrer">Apache-2.0</a></div>
  </td></tr>
  <tr><th>Readiness level</th><td><div class="readiness-level"><a href="https://developer.lightbend.com/docs/introduction/getting-help/support-terminology.html#supported" target="_blank" rel="noopener">Supported</a>, <a href="https://www.lightbend.com/lightbend-subscription" target="_blank" rel="noopener">Lightbend Subscription</a> provides support</div>
  <div>Since 1.0.0, 2019-04-04</div>
  </td></tr>
  <tr><th>Home page</th><td><a href="https://doc.akka.io/docs/alpakka/current">https://doc.akka.io/docs/alpakka/current</a></td></tr>
  <tr><th>API documentation</th><td>
  <div><a href="https://doc.akka.io/api/alpakka/2.0.0/akka/stream/alpakka/couchbase/index.html" target="_blank" rel="noopener noreferrer">API (Scaladoc)</a></div>
  </td></tr>
  <tr><th>Forums</th><td>
  <div><a href="https://discuss.lightbend.com/c/akka/" target="_blank" rel="noopener noreferrer">Lightbend Discuss</a></div>
  <div><a href="https://gitter.im/akka/akka" target="_blank" rel="noopener noreferrer">akka/akka Gitter channel</a></div>
  </td></tr>
  <tr><th>Release notes</th><td><a href="https://doc.akka.io/docs/alpakka/current/release-notes/index.html">In the documentation</a></td></tr>
  <tr><th>Issues</th><td><a href="https://github.com/akka/alpakka/labels/p%3Acouchbase" target="_blank" rel="noopener noreferrer">Github issues</a></td></tr>
  <tr><th>Sources</th><td><a href="https://github.com/akka/alpakka" target="_blank" rel="noopener noreferrer">https://github.com/akka/alpakka</a></td></tr>
</table>

<h2><a href="#artifacts" name="artifacts" class="anchor"><span class="anchor-link"></span></a>Artifacts</h2>
<dl class="dependency"><dt>sbt</dt><dd><pre class="prettyprint"><code class="language-scala">val AkkaVersion = "2.5.31"
libraryDependencies ++= Seq(
  "com.lightbend.akka" %% "akka-stream-alpakka-couchbase" % "2.0.0",
  "com.typesafe.akka" %% "akka-stream" % AkkaVersion
)</code></pre></dd><dt>Maven</dt><dd><pre class="prettyprint"><code class="language-xml">&lt;properties&gt;
  &lt;akka.version&gt;2.5.31&lt;/akka.version&gt;
  &lt;scala.binary.version&gt;2.12&lt;/scala.binary.version&gt;
&lt;/properties&gt;
&lt;dependency&gt;
  &lt;groupId&gt;com.lightbend.akka&lt;/groupId&gt;
  &lt;artifactId&gt;akka-stream-alpakka-couchbase_${scala.binary.version}&lt;/artifactId&gt;
  &lt;version&gt;2.0.0&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;com.typesafe.akka&lt;/groupId&gt;
  &lt;artifactId&gt;akka-stream_${scala.binary.version}&lt;/artifactId&gt;
  &lt;version&gt;${akka.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre></dd><dt>Gradle</dt><dd><pre class="prettyprint"><code class="language-gradle">versions += [
  AkkaVersion: "2.5.31",
  ScalaBinary: "2.12"
]
dependencies {
  compile group: 'com.lightbend.akka', name: "akka-stream-alpakka-couchbase_${versions.ScalaBinary}", version: '2.0.0',
  compile group: 'com.typesafe.akka', name: "akka-stream_${versions.ScalaBinary}", version: versions.AkkaVersion
}</code></pre></dd></dl>
<p>The table below shows direct dependencies of this module and the second tab shows all libraries it depends on transitively.</p>
<dl class="dependencies"><dt>Direct dependencies</dt><dd><table>
  <thead><tr><th>Organization</th><th>Artifact</th><th>Version</th></thead>
  <tbody>
    <tr><td>com.couchbase.client</td><td>java-client</td><td><a href="https://mvnrepository.com/artifact/com.couchbase.client/java-client/2.7.13" target="_blank">2.7.13</a></td></tr>
    <tr><td>com.typesafe.akka</td><td>akka-stream_2.12</td><td><a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-stream_2.12/2.5.31" target="_blank">2.5.31</a></td></tr>
    <tr><td>io.reactivex</td><td>rxjava-reactive-streams</td><td><a href="https://mvnrepository.com/artifact/io.reactivex/rxjava-reactive-streams/1.2.1" target="_blank">1.2.1</a></td></tr>
    <tr><td>org.scala-lang</td><td>scala-library</td><td><a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.12.10" target="_blank">2.12.10</a></td></tr>
  </tbody>
</table></dd>
<dt>Dependency tree</dt><dd><pre>
com.couchbase.client    java-client    <a href="https://mvnrepository.com/artifact/com.couchbase.client/java-client/2.7.13" target="_blank">2.7.13</a>
    com.couchbase.client    core-io    <a href="https://mvnrepository.com/artifact/com.couchbase.client/core-io/1.7.13" target="_blank">1.7.13</a>
        io.opentracing    opentracing-api    <a href="https://mvnrepository.com/artifact/io.opentracing/opentracing-api/0.31.0" target="_blank">0.31.0</a>
        io.reactivex    rxjava    <a href="https://mvnrepository.com/artifact/io.reactivex/rxjava/1.3.8" target="_blank">1.3.8</a>
com.typesafe.akka    akka-stream_2.12    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-stream_2.12/2.5.31" target="_blank">2.5.31</a>
    com.typesafe.akka    akka-actor_2.12    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-actor_2.12/2.5.31" target="_blank">2.5.31</a>
        com.typesafe    config    <a href="https://mvnrepository.com/artifact/com.typesafe/config/1.3.3" target="_blank">1.3.3</a>
        org.scala-lang.modules    scala-java8-compat_2.12    <a href="https://mvnrepository.com/artifact/org.scala-lang.modules/scala-java8-compat_2.12/0.8.0" target="_blank">0.8.0</a>
    com.typesafe.akka    akka-protobuf_2.12    <a href="https://mvnrepository.com/artifact/com.typesafe.akka/akka-protobuf_2.12/2.5.31" target="_blank">2.5.31</a>
    com.typesafe    ssl-config-core_2.12    <a href="https://mvnrepository.com/artifact/com.typesafe/ssl-config-core_2.12/0.3.8" target="_blank">0.3.8</a>
        com.typesafe    config    <a href="https://mvnrepository.com/artifact/com.typesafe/config/1.3.3" target="_blank">1.3.3</a>
        org.scala-lang.modules    scala-parser-combinators_2.12    <a href="https://mvnrepository.com/artifact/org.scala-lang.modules/scala-parser-combinators_2.12/1.1.2" target="_blank">1.1.2</a>
    org.reactivestreams    reactive-streams    <a href="https://mvnrepository.com/artifact/org.reactivestreams/reactive-streams/1.0.2" target="_blank">1.0.2</a>
io.reactivex    rxjava-reactive-streams    <a href="https://mvnrepository.com/artifact/io.reactivex/rxjava-reactive-streams/1.2.1" target="_blank">1.2.1</a>
    io.reactivex    rxjava    <a href="https://mvnrepository.com/artifact/io.reactivex/rxjava/1.3.8" target="_blank">1.3.8</a>
    org.reactivestreams    reactive-streams    <a href="https://mvnrepository.com/artifact/org.reactivestreams/reactive-streams/1.0.2" target="_blank">1.0.2</a>
org.scala-lang    scala-library    <a href="https://mvnrepository.com/artifact/org.scala-lang/scala-library/2.12.10" target="_blank">2.12.10</a></pre></dd>
</dl>

<h1><a href="#overview" name="overview" class="anchor"><span class="anchor-link"></span></a>Overview</h1>

<p>Alpakka Couchbase offers both <a href="couchbase.html#reading-from-couchbase-in-akka-streams">Akka Streams APIs</a> and a more <a href="couchbase.html#using-couchbasesession-directly">direct API</a> to access Couchbase:</p>

<ul>
  <li><span class="group-java"><a href="/api/alpakka/2.0.0/akka/stream/alpakka/couchbase/javadsl/CouchbaseSession.html" title="akka.stream.alpakka.couchbase.javadsl.CouchbaseSession"><code>CouchbaseSession</code></a></span><span class="group-scala"><a href="/api/alpakka/2.0.0/akka/stream/alpakka/couchbase/scaladsl/CouchbaseSession.html" title="akka.stream.alpakka.couchbase.scaladsl.CouchbaseSession"><code>CouchbaseSession</code></a></span> offers a direct API for one-off operations</li>
  <li><span class="group-scala"><a href="/api/alpakka/2.0.0/akka/stream/alpakka/couchbase/CouchbaseSessionRegistry$.html" title="akka.stream.alpakka.couchbase.CouchbaseSessionRegistry"><code>CouchbaseSessionRegistry</code></a></span><span class="group-java"><a href="/api/alpakka/2.0.0/akka/stream/alpakka/couchbase/CouchbaseSessionRegistry$.html" title="akka.stream.alpakka.couchbase.CouchbaseSessionRegistry"><code>CouchbaseSessionRegistry</code></a></span> is an Akka extension to keep track and share <code>CouchbaseSession</code>s within an <code>ActorSystem</code></li>
  <li><span class="group-java"><a href="/api/alpakka/2.0.0/akka/stream/alpakka/couchbase/javadsl/CouchbaseSource$.html" title="akka.stream.alpakka.couchbase.javadsl.CouchbaseSource"><code>CouchbaseSource</code></a></span><span class="group-scala"><a href="/api/alpakka/2.0.0/akka/stream/alpakka/couchbase/scaladsl/CouchbaseSource$.html" title="akka.stream.alpakka.couchbase.scaladsl.CouchbaseSource"><code>CouchbaseSource</code></a></span>, <span class="group-java"><a href="/api/alpakka/2.0.0/akka/stream/alpakka/couchbase/javadsl/CouchbaseFlow$.html" title="akka.stream.alpakka.couchbase.javadsl.CouchbaseFlow"><code>CouchbaseFlow</code></a></span><span class="group-scala"><a href="/api/alpakka/2.0.0/akka/stream/alpakka/couchbase/scaladsl/CouchbaseFlow$.html" title="akka.stream.alpakka.couchbase.scaladsl.CouchbaseFlow"><code>CouchbaseFlow</code></a></span>, and <span class="group-java"><a href="/api/alpakka/2.0.0/akka/stream/alpakka/couchbase/javadsl/CouchbaseSink$.html" title="akka.stream.alpakka.couchbase.javadsl.CouchbaseSink"><code>CouchbaseSink</code></a></span><span class="group-scala"><a href="/api/alpakka/2.0.0/akka/stream/alpakka/couchbase/scaladsl/CouchbaseSink$.html" title="akka.stream.alpakka.couchbase.scaladsl.CouchbaseSink"><code>CouchbaseSink</code></a></span> offer factory methods to create Akka Stream operators</li>
</ul>
<h2><a href="#configuration" name="configuration" class="anchor"><span class="anchor-link"></span></a>Configuration</h2>
<p>All operations use the <code>CouchbaseSession</code> internally. A session is configured with <span class="group-scala"><a href="/api/alpakka/2.0.0/akka/stream/alpakka/couchbase/CouchbaseSessionSettings$.html" title="akka.stream.alpakka.couchbase.CouchbaseSessionSettings"><code>CouchbaseSessionSettings</code></a></span><span class="group-java"><a href="/api/alpakka/2.0.0/akka/stream/alpakka/couchbase/CouchbaseSessionSettings$.html" title="akka.stream.alpakka.couchbase.CouchbaseSessionSettings"><code>CouchbaseSessionSettings</code></a></span> and a Couchbase bucket name. The Akka Stream factory methods create and access the corresponding session instance behind the scenes.</p>
<p>By default the <code>CouchbaseSessionSettings</code> are read from the <code>alpakka.couchbase.session</code> section from the configuration eg. in your <code>application.conf</code>.</p>
<dl>
  <dt>Settings</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/alpakka/tree/v2.0.0/couchbase/src/test/resources/application.conf#L8-L14" target="_blank" title="Go to snippet source"></a><code class="language-conf">alpakka.couchbase {
  session {
    nodes = [&quot;localhost&quot;]
    username = &quot;Administrator&quot;
    password = &quot;password&quot;
  }
}</code></pre></dd>
</dl>
<h2><a href="#using-akka-discovery" name="using-akka-discovery" class="anchor"><span class="anchor-link"></span></a>Using Akka Discovery</h2>
<p>To delegate the configuration of Couchbase nodes to any of <a href="https://doc.akka.io/docs/akka/2.5/discovery/index.html">Akka Discovery&rsquo;s lookup mechanisms</a>, specify a service name and lookup timeout in the Couchbase section, and pass in <span class="group-java"><a href="/api/alpakka/2.0.0/akka/stream/alpakka/couchbase/javadsl/DiscoverySupport$.html" title="akka.stream.alpakka.couchbase.javadsl.DiscoverySupport"><code>DiscoverySupport</code></a></span><span class="group-scala"><a href="/api/alpakka/2.0.0/akka/stream/alpakka/couchbase/scaladsl/DiscoverySupport$.html" title="akka.stream.alpakka.couchbase.scaladsl.DiscoverySupport"><code>DiscoverySupport</code></a></span> nodes lookup to <code>enrichAsync</code> and configure Akka Discovery accordingly.</p>
<p><strong>The Akka Discovery dependency has to be added explicitly</strong>.</p>
<dl>
  <dt>Discovery settings (Config discovery)
  </dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/alpakka/tree/v2.0.0/couchbase/src/test/resources/discovery.conf#L8-L26" target="_blank" title="Go to snippet source"></a><code class="language-conf">alpakka.couchbase {
  session {
    service {
      name = couchbase-service
      lookup-timeout = 1 s
    }
    username = &quot;anotherUser&quot;
    password = &quot;differentPassword&quot;
  }
}

akka.discovery.method = config
akka.discovery.config.services = {
  couchbase-service = {
    endpoints = [
      { host = &quot;akka.io&quot; }
    ]
  }
}</code></pre></dd>
</dl>
<p>To enable Akka Discovery on the <code>CouchbaseSessionSettings</code>, use <code>DiscoverySupport.nodes()</code> as enrichment function.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/alpakka/tree/v2.0.0/couchbase/src/test/scala/docs/scaladsl/DiscoverySpec.scala#L37-L44" target="_blank" title="Go to snippet source"></a><code class="language-scala">import akka.stream.alpakka.couchbase.scaladsl.{CouchbaseSession, DiscoverySupport}
import akka.stream.alpakka.couchbase.{CouchbaseSessionRegistry, CouchbaseSessionSettings}

val registry = CouchbaseSessionRegistry(actorSystem)

val sessionSettings = CouchbaseSessionSettings(actorSystem)
  .withEnrichAsync(DiscoverySupport.nodes())
val sessionFuture: Future[CouchbaseSession] = registry.sessionFor(sessionSettings, bucketName)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/alpakka/tree/v2.0.0/couchbase/src/test/java/docs/javadsl/DiscoveryTest.java#L11-L61" target="_blank" title="Go to snippet source"></a><code class="language-java">import akka.stream.alpakka.couchbase.CouchbaseSessionRegistry;
import akka.stream.alpakka.couchbase.CouchbaseSessionSettings;
import akka.stream.alpakka.couchbase.javadsl.DiscoverySupport;
import akka.stream.alpakka.couchbase.javadsl.CouchbaseSession;

CouchbaseSessionRegistry registry = CouchbaseSessionRegistry.get(actorSystem);

CouchbaseSessionSettings sessionSettings =
    CouchbaseSessionSettings.create(actorSystem)
        .withEnrichAsyncCs(DiscoverySupport.getNodes(actorSystem));
CompletionStage&lt;CouchbaseSession&gt; session = registry.getSessionFor(sessionSettings, bucketName);</code></pre></dd>
</dl>
<h1><a href="#reading-from-couchbase-in-akka-streams" name="reading-from-couchbase-in-akka-streams" class="anchor"><span class="anchor-link"></span></a>Reading from Couchbase in Akka Streams</h1>
<h2><a href="#using-statements" name="using-statements" class="anchor"><span class="anchor-link"></span></a>Using statements</h2>
<p>To query Couchbase using the statement DSL use <code>CouchbaseSource.fromStatement</code>. </p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/alpakka/tree/v2.0.0/couchbase/src/test/scala/docs/scaladsl/CouchbaseSourceSpec.scala#L38-L44" target="_blank" title="Go to snippet source"></a><code class="language-scala">import com.couchbase.client.java.query.Select.select
import com.couchbase.client.java.query.dsl.Expression._

val resultAsFuture: Future[Seq[JsonObject]] =
  CouchbaseSource
    .fromStatement(sessionSettings, select(&quot;*&quot;).from(i(queryBucketName)).limit(10), bucketName)
    .runWith(Sink.seq)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/alpakka/tree/v2.0.0/couchbase/src/test/java/docs/javadsl/CouchbaseExamplesTest.java#L65-L188" target="_blank" title="Go to snippet source"></a><code class="language-java">import static com.couchbase.client.java.query.Select.select;
import static com.couchbase.client.java.query.dsl.Expression.*;

CompletionStage&lt;List&lt;JsonObject&gt;&gt; resultCompletionStage =
    CouchbaseSource.fromStatement(
            sessionSettings, select(&quot;*&quot;).from(i(queryBucketName)).limit(10), bucketName)
        .runWith(Sink.seq(), materializer);</code></pre></dd>
</dl>
<h2><a href="#using-n1ql-queries" name="using-n1ql-queries" class="anchor"><span class="anchor-link"></span></a>Using N1QL queries</h2>
<p>To query Couchbase using the <a href="https://docs.couchbase.com/java-sdk/2.7/n1ql-query.html">&ldquo;N1QL&rdquo; queries</a> use <code>CouchbaseSource.fromN1qlQuery</code>. </p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/alpakka/tree/v2.0.0/couchbase/src/test/scala/docs/scaladsl/CouchbaseSourceSpec.scala#L74-L82" target="_blank" title="Go to snippet source"></a><code class="language-scala">import com.couchbase.client.java.query.{N1qlParams, N1qlQuery}

val params = N1qlParams.build.adhoc(false)
val query = N1qlQuery.simple(s&quot;select count(*) from $queryBucketName&quot;, params)

val resultAsFuture: Future[Seq[JsonObject]] =
  CouchbaseSource
    .fromN1qlQuery(sessionSettings, query, bucketName)
    .runWith(Sink.seq)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/alpakka/tree/v2.0.0/couchbase/src/test/java/docs/javadsl/CouchbaseExamplesTest.java#L39-L205" target="_blank" title="Go to snippet source"></a><code class="language-java">import com.couchbase.client.java.query.N1qlParams;
import com.couchbase.client.java.query.N1qlQuery;

N1qlParams params = N1qlParams.build().adhoc(false);
SimpleN1qlQuery query = N1qlQuery.simple(&quot;select count(*) from &quot; + queryBucketName, params);

CompletionStage&lt;JsonObject&gt; resultCompletionStage =
    CouchbaseSource.fromN1qlQuery(sessionSettings, query, bucketName)
        .runWith(Sink.head(), materializer);</code></pre></dd>
</dl>
<h2><a href="#get-by-id" name="get-by-id" class="anchor"><span class="anchor-link"></span></a>Get by ID</h2>
<p><code>CouchbaseFlow.fromId</code> methods allow to read documents specified by the document ID in the Akka Stream.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/alpakka/tree/v2.0.0/couchbase/src/test/scala/docs/scaladsl/CouchbaseFlowSpec.scala#L192-L202" target="_blank" title="Go to snippet source"></a><code class="language-scala">val ids = immutable.Seq(&quot;First&quot;, &quot;Second&quot;, &quot;Third&quot;, &quot;Fourth&quot;)

val futureResult: Future[immutable.Seq[JsonDocument]] =
  Source(ids)
    .via(
      CouchbaseFlow.fromId(
        sessionSettings,
        bucketName
      )
    )
    .runWith(Sink.seq)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/alpakka/tree/v2.0.0/couchbase/src/test/java/docs/javadsl/CouchbaseExamplesTest.java#L229-L234" target="_blank" title="Go to snippet source"></a><code class="language-java">List&lt;String&gt; ids = Arrays.asList(&quot;First&quot;, &quot;Second&quot;, &quot;Third&quot;, &quot;Fourth&quot;);

CompletionStage&lt;List&lt;JsonDocument&gt;&gt; result =
    Source.from(ids)
        .via(CouchbaseFlow.fromId(sessionSettings, queryBucketName))
        .runWith(Sink.seq(), materializer);</code></pre></dd>
</dl>
<h1><a href="#writing-to-couchbase-in-akka-streams" name="writing-to-couchbase-in-akka-streams" class="anchor"><span class="anchor-link"></span></a>Writing to Couchbase in Akka Streams</h1>
<p>For each mutation operation we need to create <span class="group-scala"><a href="/api/alpakka/2.0.0/akka/stream/alpakka/couchbase/CouchbaseWriteSettings.html" title="akka.stream.alpakka.couchbase.CouchbaseWriteSettings"><code>CouchbaseWriteSettings</code></a></span><span class="group-java"><a href="/api/alpakka/2.0.0/akka/stream/alpakka/couchbase/CouchbaseWriteSettings.html" title="akka.stream.alpakka.couchbase.CouchbaseWriteSettings"><code>CouchbaseWriteSettings</code></a></span> instance which consists of the following parameters</p>
<ul>
  <li>Parallelism in access to Couchbase (default 1)</li>
  <li>Couchbase Replication Factor (default <code>ReplicateTo.NONE</code>)</li>
  <li>Couchbase Persistence Level for Write Operation (default <code>PersistTo.NONE</code>)</li>
  <li>2 seconds operation timeout</li>
</ul>
<p>These default values are not recommended for production use, as they do not persist to disk for any node. </p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/alpakka/tree/v2.0.0/couchbase/src/test/scala/docs/scaladsl/CouchbaseFlowSpec.scala#L18-L68" target="_blank" title="Go to snippet source"></a><code class="language-scala">import akka.stream.alpakka.couchbase.CouchbaseWriteSettings
import com.couchbase.client.java.{PersistTo, ReplicateTo}
val writeSettings = CouchbaseWriteSettings()
  .withParallelism(3)
  .withPersistTo(PersistTo.FOUR)
  .withReplicateTo(ReplicateTo.THREE)
  .withTimeout(5.seconds)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/alpakka/tree/v2.0.0/couchbase/src/test/java/docs/javadsl/CouchbaseExamplesTest.java#L214-L219" target="_blank" title="Go to snippet source"></a><code class="language-java">CouchbaseWriteSettings writeSettings =
    CouchbaseWriteSettings.create()
        .withParallelism(3)
        .withPersistTo(PersistTo.FOUR)
        .withReplicateTo(ReplicateTo.THREE)
        .withTimeout(Duration.ofSeconds(5));</code></pre></dd>
</dl>
<p>Read more about durability settings in the <a href="https://docs.couchbase.com/java-sdk/2.7/durability.html#configuring-durability">Couchbase documentation</a>. </p>
<h2><a href="#upsert" name="upsert" class="anchor"><span class="anchor-link"></span></a>Upsert</h2>
<p>The <code>CouchbaseFlow</code> and <code>CouchbaseSink</code> offer factories for upserting documents (insert or update) in Couchbase. <code>upsert</code> is used for the most commonly used <code>JsonDocument</code>, and <code>upsertDoc</code> has as type parameter to support any variants of <span class="group-scala"><code>Document[T]</code></span><span class="group-java"><code>Document&lt;T&gt;</code></span> which may be <code>RawJsonDocument</code>, <code>StringDocument</code> or <code>BinaryDocument</code>.</p>
<p>The <code>upsert</code> and <code>upsertDoc</code> operators fail the stream on any error when writing to Couchbase. To handle failures in-stream use <code>upsertDocWithResult</code> shown below. </p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/alpakka/tree/v2.0.0/couchbase/src/test/scala/docs/scaladsl/CouchbaseFlowSpec.scala#L101-L138" target="_blank" title="Go to snippet source"></a><code class="language-scala">val obj = TestObject(id = &quot;First&quot;, &quot;First&quot;)

val writeSettings = CouchbaseWriteSettings()

val jsonDocumentUpsert: Future[Done] =
  Source
    .single(obj)
    .map(toJsonDocument)
    .via(
      CouchbaseFlow.upsert(
        sessionSettings,
        writeSettings,
        bucketName
      )
    )
    .runWith(Sink.ignore)

val stringDocumentUpsert: Future[Done] =
  Source
    .single(sampleData)
    .map(toStringDocument)
    .via(
      CouchbaseFlow.upsertDoc(
        sessionSettings,
        writeSettings,
        bucketName
      )
    )
    .runWith(Sink.ignore)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/alpakka/tree/v2.0.0/couchbase/src/test/java/docs/javadsl/CouchbaseExamplesTest.java#L249-L253" target="_blank" title="Go to snippet source"></a><code class="language-java">CompletionStage&lt;JsonDocument&gt; jsonDocumentUpsert =
    Source.single(obj)
        .map(support::toJsonDocument)
        .via(CouchbaseFlow.upsert(sessionSettings, writeSettings, bucketName))
        .runWith(Sink.head(), materializer);</code></pre></dd>
</dl><div class="callout note "><div class="callout-title">Note</div>
<p>For single document modifications you may consider using the <code>CouchbaseSession</code> methods directly, they offer a <span class="group-scala">future-based</span><span class="group-java">CompletionStage-based</span> API which in many cases might be simpler than using Akka Streams with just one element (see <a href="#using-couchbasesession-directly">below</a>)</p></div>
<p>Couchbase writes may fail temporarily for a particular node. If you want to handle such failures without restarting the whole stream, the <code>upsertDocWithResult</code> operator captures failures from Couchbase and emits <code>CouchbaseWriteResult</code> sub-classes <code>CouchbaseWriteSuccess</code> and <code>CouchbaseWriteFailure</code> downstream.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/alpakka/tree/v2.0.0/couchbase/src/test/scala/docs/scaladsl/CouchbaseFlowSpec.scala#L511-L527" target="_blank" title="Go to snippet source"></a><code class="language-scala">import akka.stream.alpakka.couchbase.{CouchbaseWriteFailure, CouchbaseWriteResult}

val result: Future[immutable.Seq[CouchbaseWriteResult[RawJsonDocument]]] =
  Source(sampleSequence)
    .map(toRawJsonDocument)
    .via(
      CouchbaseFlow.upsertDocWithResult(
        sessionSettings,
        writeSettings,
        bucketName
      )
    )
    .runWith(Sink.seq)

val failedDocs: immutable.Seq[CouchbaseWriteFailure[RawJsonDocument]] = result.futureValue.collect {
  case res: CouchbaseWriteFailure[RawJsonDocument] =&gt; res
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/alpakka/tree/v2.0.0/couchbase/src/test/java/docs/javadsl/CouchbaseExamplesTest.java#L14-L295" target="_blank" title="Go to snippet source"></a><code class="language-java">import akka.stream.alpakka.couchbase.CouchbaseWriteFailure;
import akka.stream.alpakka.couchbase.CouchbaseWriteResult;
CompletionStage&lt;List&lt;CouchbaseWriteResult&lt;StringDocument&gt;&gt;&gt; upsertResults =
    Source.from(sampleSequence)
        .map(support::toStringDocument)
        .via(CouchbaseFlow.upsertDocWithResult(sessionSettings, writeSettings, bucketName))
        .runWith(Sink.seq(), materializer);

List&lt;CouchbaseWriteResult&lt;StringDocument&gt;&gt; writeResults =
    upsertResults.toCompletableFuture().get(3, TimeUnit.SECONDS);
List&lt;CouchbaseWriteFailure&lt;StringDocument&gt;&gt; failedDocs =
    writeResults.stream()
        .filter(CouchbaseWriteResult::isFailure)
        .map(res -&gt; (CouchbaseWriteFailure&lt;StringDocument&gt;) res)
        .collect(Collectors.toList());</code></pre></dd>
</dl>
<h2><a href="#replace" name="replace" class="anchor"><span class="anchor-link"></span></a>Replace</h2>
<p>The <code>CouchbaseFlow</code> and <code>CouchbaseSink</code> offer factories for replacing documents in Couchbase. <code>replace</code> is used for the most commonly used <code>JsonDocument</code>, and <code>replaceDoc</code> has as type parameter to support any variants of <span class="group-scala"><code>Document[T]</code></span><span class="group-java"><code>Document&lt;T&gt;</code></span> which may be <code>RawJsonDocument</code>, <code>StringDocument</code> or <code>BinaryDocument</code>.</p>
<p>The <code>replace</code> and <code>replaceDoc</code> operators fail the stream on any error when writing to Couchbase. To handle failures in-stream use <code>replaceDocWithResult</code> shown below. </p>
<p>A <code>replace</code> action will fail if the original Document can&rsquo;t be found in Couchbase with a <code>DocumentDoesNotExistException</code>.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/alpakka/tree/v2.0.0/couchbase/src/test/scala/docs/scaladsl/CouchbaseFlowSpec.scala#L411-L422" target="_blank" title="Go to snippet source"></a><code class="language-scala">val replaceFuture: Future[Done] =
  Source
    .single(obj)
    .map(toJsonDocument)
    .via(
      CouchbaseFlow.replace(
        sessionSettings,
        writeSettings,
        bucketName
      )
    )
    .runWith(Sink.ignore)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/alpakka/tree/v2.0.0/couchbase/src/test/java/docs/javadsl/CouchbaseExamplesTest.java#L36-L338" target="_blank" title="Go to snippet source"></a><code class="language-java">import com.couchbase.client.java.error.DocumentDoesNotExistException;
CompletionStage&lt;JsonDocument&gt; jsonDocumentReplace =
    Source.single(obj)
        .map(support::toJsonDocument)
        .via(CouchbaseFlow.replace(sessionSettings, writeSettings, bucketName))
        .runWith(Sink.head(), materializer);
CompletionStage&lt;JsonDocument&gt; jsonDocumentReplace =
    Source.single(obj)
        .map(support::toJsonDocument)
        .via(CouchbaseFlow.replace(sessionSettings, writeSettings, bucketName))
        .runWith(Sink.head(), materializer);</code></pre></dd>
</dl><div class="callout note "><div class="callout-title">Note</div>
<p>For single document modifications you may consider using the <code>CouchbaseSession</code> methods directly, they offer a <span class="group-scala">future-based</span><span class="group-java">CompletionStage-based</span> API which in many cases might be simpler than using Akka Streams with just one element (see <a href="#using-couchbasesession-directly">below</a>)</p></div>
<p>Couchbase writes may fail temporarily for a particular node. If you want to handle such failures without restarting the whole stream, the <code>replaceDocWithResult</code> operator captures failures from Couchbase and emits <code>CouchbaseWriteResult</code> sub-classes <code>CouchbaseWriteSuccess</code> and <code>CouchbaseWriteFailure</code> downstream.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/alpakka/tree/v2.0.0/couchbase/src/test/scala/docs/scaladsl/CouchbaseFlowSpec.scala#L511-L527" target="_blank" title="Go to snippet source"></a><code class="language-scala">import akka.stream.alpakka.couchbase.{CouchbaseWriteFailure, CouchbaseWriteResult}

val result: Future[immutable.Seq[CouchbaseWriteResult[RawJsonDocument]]] =
  Source(sampleSequence)
    .map(toRawJsonDocument)
    .via(
      CouchbaseFlow.upsertDocWithResult(
        sessionSettings,
        writeSettings,
        bucketName
      )
    )
    .runWith(Sink.seq)

val failedDocs: immutable.Seq[CouchbaseWriteFailure[RawJsonDocument]] = result.futureValue.collect {
  case res: CouchbaseWriteFailure[RawJsonDocument] =&gt; res
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/alpakka/tree/v2.0.0/couchbase/src/test/java/docs/javadsl/CouchbaseExamplesTest.java#L14-L295" target="_blank" title="Go to snippet source"></a><code class="language-java">import akka.stream.alpakka.couchbase.CouchbaseWriteFailure;
import akka.stream.alpakka.couchbase.CouchbaseWriteResult;
CompletionStage&lt;List&lt;CouchbaseWriteResult&lt;StringDocument&gt;&gt;&gt; upsertResults =
    Source.from(sampleSequence)
        .map(support::toStringDocument)
        .via(CouchbaseFlow.upsertDocWithResult(sessionSettings, writeSettings, bucketName))
        .runWith(Sink.seq(), materializer);

List&lt;CouchbaseWriteResult&lt;StringDocument&gt;&gt; writeResults =
    upsertResults.toCompletableFuture().get(3, TimeUnit.SECONDS);
List&lt;CouchbaseWriteFailure&lt;StringDocument&gt;&gt; failedDocs =
    writeResults.stream()
        .filter(CouchbaseWriteResult::isFailure)
        .map(res -&gt; (CouchbaseWriteFailure&lt;StringDocument&gt;) res)
        .collect(Collectors.toList());</code></pre></dd>
</dl>
<h2><a href="#delete" name="delete" class="anchor"><span class="anchor-link"></span></a>Delete</h2>
<p>The <code>CouchbaseFlow</code> and <code>CouchbaseSink</code> offer factories to delete documents in Couchbase by ID.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/alpakka/tree/v2.0.0/couchbase/src/test/scala/docs/scaladsl/CouchbaseFlowSpec.scala#L297-L307" target="_blank" title="Go to snippet source"></a><code class="language-scala">val deleteFuture: Future[Done] =
  Source
    .single(sampleData.id)
    .via(
      CouchbaseFlow.delete(
        sessionSettings,
        writeSettings,
        bucketName
      )
    )
    .runWith(Sink.ignore)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/alpakka/tree/v2.0.0/couchbase/src/test/java/docs/javadsl/CouchbaseExamplesTest.java#L408-L411" target="_blank" title="Go to snippet source"></a><code class="language-java">CompletionStage&lt;String&gt; result =
    Source.single(sampleData.id())
        .via(CouchbaseFlow.delete(sessionSettings, writeSettings, bucketName))
        .runWith(Sink.head(), materializer);</code></pre></dd>
</dl>
<p>To handle any delete failures such as non-existent documents in-stream, use the the <code>deleteWithResult</code> operator. It captures failures from Couchbase and emits <code>CouchbaseDeleteResult</code>s.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/alpakka/tree/v2.0.0/couchbase/src/test/scala/docs/scaladsl/CouchbaseFlowSpec.scala#L577-L587" target="_blank" title="Go to snippet source"></a><code class="language-scala">val deleteResult: Future[CouchbaseDeleteResult] =
  Source
    .single(&quot;non-existent&quot;)
    .via(
      CouchbaseFlow.deleteWithResult(
        sessionSettings,
        writeSettings,
        bucketName
      )
    )
    .runWith(Sink.head)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/alpakka/tree/v2.0.0/couchbase/src/test/java/docs/javadsl/CouchbaseExamplesTest.java#L11-L426" target="_blank" title="Go to snippet source"></a><code class="language-java">import akka.stream.alpakka.couchbase.CouchbaseDeleteResult;
CompletionStage&lt;CouchbaseDeleteResult&gt; result =
    Source.single(&quot;non-existent&quot;)
        .via(CouchbaseFlow.deleteWithResult(sessionSettings, writeSettings, bucketName))
        .runWith(Sink.head(), materializer);</code></pre></dd>
</dl>
<h1><a href="#using-couchbasesession-directly" name="using-couchbasesession-directly" class="anchor"><span class="anchor-link"></span></a>Using <code>CouchbaseSession</code> directly</h1>
<h2><a href="#access-via-registry" name="access-via-registry" class="anchor"><span class="anchor-link"></span></a>Access via registry</h2>
<p>The <code>CouchbaseSesionRegistry</code> is an Akka extension to manage the life-cycle of Couchbase sessions. All underlying instances are closed upon actor system termination.</p>
<p>When accessing more than one Couchbase cluster, the <code>CouchbaseEnvironment</code> should be shared by setting a single instance for the different <code>CouchbaseSessionSettings</code>.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/alpakka/tree/v2.0.0/couchbase/src/test/scala/docs/scaladsl/CouchbaseSessionExamplesSpec.scala#L35-L51" target="_blank" title="Go to snippet source"></a><code class="language-scala">import akka.stream.alpakka.couchbase.CouchbaseSessionRegistry
import akka.stream.alpakka.couchbase.CouchbaseSessionSettings
import akka.stream.alpakka.couchbase.scaladsl.CouchbaseSession
import com.couchbase.client.java.env.{CouchbaseEnvironment, DefaultCouchbaseEnvironment}

// Akka extension (singleton per actor system)
val registry = CouchbaseSessionRegistry(actorSystem)

// If connecting to more than one Couchbase cluster, the environment should be shared
val environment: CouchbaseEnvironment = DefaultCouchbaseEnvironment.create()
actorSystem.registerOnTermination {
  environment.shutdown()
}

val sessionSettings = CouchbaseSessionSettings(actorSystem)
  .withEnvironment(environment)
val sessionFuture: Future[CouchbaseSession] = registry.sessionFor(sessionSettings, bucketName)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/alpakka/tree/v2.0.0/couchbase/src/test/java/docs/javadsl/CouchbaseExamplesTest.java#L32-L119" target="_blank" title="Go to snippet source"></a><code class="language-java">import com.couchbase.client.java.env.CouchbaseEnvironment;
import com.couchbase.client.java.env.DefaultCouchbaseEnvironment;
import akka.stream.alpakka.couchbase.CouchbaseSessionRegistry;
import akka.stream.alpakka.couchbase.CouchbaseSessionSettings;
import akka.stream.alpakka.couchbase.javadsl.CouchbaseSession;

CouchbaseSessionRegistry registry = CouchbaseSessionRegistry.get(actorSystem);

// If connecting to more than one Couchbase cluster, the environment should be shared
CouchbaseEnvironment environment = DefaultCouchbaseEnvironment.create();
actorSystem.registerOnTermination(() -&gt; environment.shutdown());

CouchbaseSessionSettings sessionSettings =
    CouchbaseSessionSettings.create(actorSystem).withEnvironment(environment);
CompletionStage&lt;CouchbaseSession&gt; sessionCompletionStage =
    registry.getSessionFor(sessionSettings, bucketName);</code></pre></dd>
</dl>
<h2><a href="#manage-session-life-cycle" name="manage-session-life-cycle" class="anchor"><span class="anchor-link"></span></a>Manage session life-cycle</h2>
<p>Use <code>CouchbaseSessionSettings</code> to get an instance of <code>CouchbaseSession</code>. These settings may be specified in <code>application.conf</code> and complemented in code. Furthermore a session requires the bucket name and needs an <code>ExecutionContext</code> as the creation is asynchronous.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/alpakka/tree/v2.0.0/couchbase/src/test/scala/docs/scaladsl/CouchbaseSessionExamplesSpec.scala#L58-L75" target="_blank" title="Go to snippet source"></a><code class="language-scala">import akka.stream.alpakka.couchbase.CouchbaseSessionSettings
import akka.stream.alpakka.couchbase.scaladsl.CouchbaseSession

implicit val ec: ExecutionContext = actorSystem.dispatcher
val sessionSettings = CouchbaseSessionSettings(actorSystem)
val sessionFuture: Future[CouchbaseSession] = CouchbaseSession(sessionSettings, bucketName)
actorSystem.registerOnTermination(sessionFuture.flatMap(_.close()))

val documentFuture = sessionFuture.flatMap { session =&gt;
  val id = &quot;myId&quot;
  val documentFuture: Future[Option[JsonDocument]] = session.get(id)
  documentFuture.flatMap {
    case Some(jsonDocument) =&gt;
      Future.successful(jsonDocument)
    case None =&gt;
      Future.failed(new RuntimeException(s&quot;document $id wasn&#39;t found&quot;))
  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/alpakka/tree/v2.0.0/couchbase/src/test/java/docs/javadsl/CouchbaseExamplesTest.java#L55-L149" target="_blank" title="Go to snippet source"></a><code class="language-java">import akka.stream.alpakka.couchbase.CouchbaseSessionSettings;
import akka.stream.alpakka.couchbase.javadsl.CouchbaseSession;

Executor executor = Executors.newSingleThreadExecutor();
CouchbaseSessionSettings sessionSettings = CouchbaseSessionSettings.create(actorSystem);
CompletionStage&lt;CouchbaseSession&gt; sessionCompletionStage =
    CouchbaseSession.create(sessionSettings, bucketName, executor);
actorSystem.registerOnTermination(
    () -&gt; sessionCompletionStage.thenAccept(CouchbaseSession::close));

sessionCompletionStage.thenAccept(
    session -&gt; {
      String id = &quot;myId&quot;;
      CompletionStage&lt;Optional&lt;JsonDocument&gt;&gt; documentCompletionStage = session.get(id);
      documentCompletionStage.thenAccept(
          opt -&gt; {
            if (opt.isPresent()) {
              System.out.println(opt.get());
            } else {
              System.out.println(&quot;Document &quot; + id + &quot; wasn&#39;t found&quot;);
            }
          });
    });</code></pre></dd>
</dl>
<h2><a href="#manage-bucket-life-cycle" name="manage-bucket-life-cycle" class="anchor"><span class="anchor-link"></span></a>Manage bucket life-cycle</h2>
<p>For full control a <code>CouchbaseSession</code> may be created from a Couchbase <code>Bucket</code>. See <a href="https://docs.couchbase.com/java-sdk/2.7/managing-connections.html#concurrency">Scalability and Concurrency</a> in the Couchbase documentation for details.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/alpakka/tree/v2.0.0/couchbase/src/test/scala/docs/scaladsl/CouchbaseSessionExamplesSpec.scala#L83-L100" target="_blank" title="Go to snippet source"></a><code class="language-scala">import com.couchbase.client.java.auth.PasswordAuthenticator
import com.couchbase.client.java.{Bucket, CouchbaseCluster}

val cluster: CouchbaseCluster = CouchbaseCluster.create(&quot;localhost&quot;)
cluster.authenticate(new PasswordAuthenticator(&quot;Administrator&quot;, &quot;password&quot;))
val bucket: Bucket = cluster.openBucket(&quot;akka&quot;)
val session: CouchbaseSession = CouchbaseSession(bucket)
actorSystem.registerOnTermination {
  session.close()
}

val id = &quot;myId&quot;
val documentFuture = session.get(id).flatMap {
  case Some(jsonDocument) =&gt;
    Future.successful(jsonDocument)
  case None =&gt;
    Future.failed(new RuntimeException(s&quot;document $id wasn&#39;t found&quot;))
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/alpakka/tree/v2.0.0/couchbase/src/test/java/docs/javadsl/CouchbaseExamplesTest.java#L60-L176" target="_blank" title="Go to snippet source"></a><code class="language-java">import com.couchbase.client.java.Bucket;
import com.couchbase.client.java.CouchbaseCluster;
import com.couchbase.client.java.auth.PasswordAuthenticator;

CouchbaseCluster cluster = CouchbaseCluster.create(&quot;localhost&quot;);
cluster.authenticate(new PasswordAuthenticator(&quot;Administrator&quot;, &quot;password&quot;));
Bucket bucket = cluster.openBucket(&quot;akka&quot;);
CouchbaseSession session = CouchbaseSession.create(bucket);
actorSystem.registerOnTermination(
    () -&gt; {
      session.close();
      bucket.close();
    });

String id = &quot;First&quot;;
CompletionStage&lt;Optional&lt;JsonDocument&gt;&gt; documentCompletionStage = session.get(id);
documentCompletionStage.thenAccept(
    opt -&gt; {
      if (opt.isPresent()) {
        System.out.println(opt.get());
      } else {
        System.out.println(&quot;Document &quot; + id + &quot; wasn&#39;t found&quot;);
      }
    });</code></pre></dd>
</dl>
<p>To learn about the full range of operations on <code>CouchbaseSession</code>, read the <span class="group-java"><a href="/api/alpakka/2.0.0/akka/stream/alpakka/couchbase/javadsl/CouchbaseSession.html" title="akka.stream.alpakka.couchbase.javadsl.CouchbaseSession"><code>CouchbaseSession</code></a></span><span class="group-scala"><a href="/api/alpakka/2.0.0/akka/stream/alpakka/couchbase/scaladsl/CouchbaseSession.html" title="akka.stream.alpakka.couchbase.scaladsl.CouchbaseSession"><code>CouchbaseSession</code></a></span> API documentation.</p>
</div>
</article>
<div class="row">
<div class="small-12 column">
<section class="nav-prev-next row">
<div class="nav-prev small-6 column">
<a href="azure-storage-queue.html"><i class="icon-prev"></i> <span class="link-prev">Azure Storage Queue</span></a>
</div>
<div class="nav-next small-6 column clearfix">
<a class="float-right" href="elasticsearch.html">Elasticsearch <i class="icon-next"></i></a>
</div>
</section>
</div>
</div>
<div class="source-github row">
Found an error in this documentation? The source code for this page can be found <a href="https://github.com/akka/alpakka/tree/v2.0.0/docs/src/main/paradox/couchbase.md">here</a>.
Please feel free to edit and contribute a pull request.
</div>

<footer class="page-footer row clearfix">
<img class="akka-icon float-left show-for-medium" src="images/akka-icon.svg" />
<section class="copyright">
<div>Alpakka is Open Source and available under the Apache 2 License.</div>
<p class="legal">
&copy; 2011-2020 <a href="https://www.lightbend.com" target="_blank">Lightbend, Inc.</a> |
<a href="https://www.lightbend.com/legal/licenses" target="_blank">Licenses</a> |
<a href="https://www.lightbend.com/legal/terms" target="_blank">Terms</a> |
<a href="https://www.lightbend.com/legal/privacy" target="_blank">Privacy Policy</a> |
<a href="https://akka.io/cookie/" target="_blank">Cookie Listing</a> |
<a class="optanon-toggle-display">Cookie Settings</a>
</p>
</section>

</footer>
</section>
</main>
</div>

<script type="text/javascript" src="js/scrollsneak.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="js/groups.js"></script>
<script type="text/javascript" src="js/page.js"></script>
<script type="text/javascript" src="js/magellan.js"></script>
<script type="text/javascript" src="js/metadata-toggle.js"></script>

<style type="text/css">@import "lib/prettify/prettify.css";</style>
<script type="text/javascript" src="lib/prettify/prettify.js"></script>
<script type="text/javascript" src="lib/prettify/lang-scala.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(){window.prettyPrint && prettyPrint()});
//]]></script>
<script type="text/javascript" src="assets/js/warnOldVersion.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(jq){initOldVersionWarnings(jq, '2.0.0', 'https://doc.akka.io/docs/alpakka/current')});
//]]></script>


</body>
</html>
