<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Migration Guide &bull; Akka Persistence R2DBC Documentation</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="An Akka Persistence backed by SQL database with R2DBC"/>
<link rel="canonical" href="https://doc.akka.io/docs/akka-persistence-r2dbc/current/migration-guide.html"/>
<script type="text/javascript" src="lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="lib/foundation/dist/js/foundation.min.js"></script>
<link rel="stylesheet" type="text/css" href="lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="lib/foundation/dist/css/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" type="text/css" href="css/icons.css"/>
<link rel="stylesheet" type="text/css" href="css/page-8.css"/>
<link rel="stylesheet" type="text/css" href="css/banner-2.css"/>
<link rel="shortcut icon" href="images/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png"/>
<link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png"/>
<link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png"/>
<link rel="manifest" href="images/manifest.json"/>
<meta name="msapplication-TileImage" content="images/mstile-150x150.png"/>
<meta name="msapplication-TileColor" content="#15a9ce"/>
<meta name="theme-color" content="#15a9ce"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) start -->
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js"  type="text/javascript" charset="UTF-8" data-domain-script="28b912e7-09e9-43d5-91e4-3d1897044004" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) end -->
<!--Google Analytics NOTE this will stop processing data July 1st 2023. At which point this embed code can be removed-->
<script type="text/plain" class="optanon-category-2">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', '']);
_gaq.push(['_setDomainName', '']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})()
</script>

<!-- Google Tag Manager: Updated May 17th 2023 - Cookie Compliance checks have been moved into Google Tag Manager -->
<script type="text/javascript">
(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KBJGH35');
</script>

</head>

<body id="underlay" data-toggler="nav-open">
<div id="lightbend-banner" class="lightbend-banner akka full-width" data-category="OSS Lightbend Banner Impression" data-label="Akka Banner Impression">
<div class="oss-wrapper">
<div class="oss-brand">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lightbend Logo - Akka Banner" href="https://www.lightbend.com">
<img class="lightbend-logo" src="images/banner-logos/lightbend-reverse.svg" alt="Lightbend" title="Lightbend">
</a>
</div>
<div class="oss-ad no-drop-down">
<nav id="lightbendRotator" class="lightbend-rotator">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Promo Rotator - Lightbend Changed its Software Licensing Model for Akka Technology. [License FAQ] - Akka Banner" href="https://www.lightbend.com/akka/license-faq">
<strong>Lightbend</strong> Changed its Software Licensing Model for Akka Technology. <span class="akka-btn">License FAQ</span>
</a>
</nav>
</div>
</div>
</div>

<header class="site-header hide-for-large">
<div class="sticky-header clearfix">
<a href="https://akka.io"><img class="logo" src="images/akka-logo-reverse.svg"/></a>

<button class="menu-icon float-right" type="button" data-toggle="underlay overlay"></button>
</div>
<div id="overlay" class="overlay-nav" data-toggler="nav-open">
<header class="nav-header">
<div class="nav-header-title">
<h1><a href="index.html">Akka Persistence R2DBC Documentation</a></h1>
</div>
<div class="nav-header-version">
Version 1.2.0-M7
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
<select class="supergroup" name="Dialect"><option class="group" value="group-postgres">Postgres</option><option class="group" value="group-yugabyte">Yugabyte</option><option class="group" value="group-h2">H2</option></select>
</div>
</header>
<nav class="nav-toc">
<ul>
  <li><a href="overview.html" class="page">Overview</a></li>
  <li><a href="getting-started.html" class="page">Getting Started</a></li>
  <li><a href="journal.html" class="page">Journal plugin</a></li>
  <li><a href="snapshots.html" class="page">Snapshot store plugin</a></li>
  <li><a href="durable-state-store.html" class="page">Durable state store plugin</a></li>
  <li><a href="query.html" class="page">Query Plugin</a></li>
  <li><a href="postgres_json.html" class="page">PostgreSQL JSON</a></li>
  <li><a href="projection.html" class="page">Projection</a></li>
  <li><a href="config.html" class="page">Configuration</a></li>
  <li><a href="cleanup.html" class="page">Database Cleanup</a></li>
  <li><a href="migration.html" class="page">Migration tool</a></li>
  <li><a href="migration-guide.html#migration-guide" class="active page">Migration Guide</a>
  <ul>
    <li><a href="migration-guide.html#1-1-x-to-1-2-0" class="header">1.1.x to 1.2.0</a></li>
  </ul></li>
  <li><a href="contributing.html" class="page">Contributing</a></li>
</ul>
</nav>
</div>
</header>
<div class="site-content-wrapper">
<aside class="sticky-sidebar show-for-large">
<header class="nav-header sticky-sidebar-header">
<div class="nav-header-title">
<h1><a href="index.html">Akka Persistence R2DBC Documentation</a></h1>
</div>
<div class="nav-header-version">
Version 1.2.0-M7
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
<select class="supergroup" name="Dialect"><option class="group" value="group-postgres">Postgres</option><option class="group" value="group-yugabyte">Yugabyte</option><option class="group" value="group-h2">H2</option></select>
</div>
</header>
<nav class="site-nav sticky-sidebar-contents">
<div class="nav-toc">
<ul>
  <li><a href="overview.html" class="page">Overview</a></li>
  <li><a href="getting-started.html" class="page">Getting Started</a></li>
  <li><a href="journal.html" class="page">Journal plugin</a></li>
  <li><a href="snapshots.html" class="page">Snapshot store plugin</a></li>
  <li><a href="durable-state-store.html" class="page">Durable state store plugin</a></li>
  <li><a href="query.html" class="page">Query Plugin</a></li>
  <li><a href="postgres_json.html" class="page">PostgreSQL JSON</a></li>
  <li><a href="projection.html" class="page">Projection</a></li>
  <li><a href="config.html" class="page">Configuration</a></li>
  <li><a href="cleanup.html" class="page">Database Cleanup</a></li>
  <li><a href="migration.html" class="page">Migration tool</a></li>
  <li><a href="migration-guide.html#migration-guide" class="active page">Migration Guide</a>
  <ul>
    <li><a href="migration-guide.html#1-1-x-to-1-2-0" class="header">1.1.x to 1.2.0</a></li>
  </ul></li>
  <li><a href="contributing.html" class="page">Contributing</a></li>
</ul>
</div>
</nav>
<footer class="nav-footer sticky-sidebar-footer">
<a href="https://akka.io"><img class="logo" src="images/akka-logo-reverse.svg"/></a>

</footer>
</aside>
<main class="fixed-shift-for-large expanded row">
<section class="site-content small-12 column">
<article class="page-content row">
<div class="small-12 column" id="docs">
<h1><a href="#migration-guide" name="migration-guide" class="anchor"><span class="anchor-link"></span></a>Migration Guide</h1>
<h2><a href="#1-1-x-to-1-2-0" name="1-1-x-to-1-2-0" class="anchor"><span class="anchor-link"></span></a>1.1.x to 1.2.0</h2>
<h3><a href="#configuration-file-changes" name="configuration-file-changes" class="anchor"><span class="anchor-link"></span></a>Configuration file changes</h3>
<p>The configuration file structure has changed in an incompatible way (to make room for the H2 dialect), an existing project using Postgres or Yugabyte will need the following changes to its config:</p>
<p>Remove <code>akka.persistence.r2dbc.dialect</code> from the config if present</p>
<p>Choose dialect by configuring the <code>connection-factory</code> block:</p>
<dl>
  <dt>Postgres</dt>
  <dd>
  <pre class="prettyprint"><code class="language-hocon">akka.persistence.r2dbc.connection-factory = ${akka.persistence.r2dbc.postgres}
akka.persistence.r2dbc.connection-factory {
  # only overrides from the default values needs to be defined
  database = &quot;my-postgres-database&quot;
  database = ${?DB_NAME}
}
</code></pre></dd>
  <dt>Yugabyte</dt>
  <dd>
  <pre class="prettyprint"><code class="language-hocon">akka.persistence.r2dbc.connection-factory = ${akka.persistence.r2dbc.yugabyte}
akka.persistence.r2dbc.connection-factory {
  # only overrides from the default values needs to be defined
  database = &quot;my-yugabyte-database&quot;
  database = ${?DB_NAME}
}
</code></pre></dd>
</dl>
<h3><a href="#api-changes" name="api-changes" class="anchor"><span class="anchor-link"></span></a>API changes</h3>
<p>Some accessors on the <span class="group-scala"><a href="/api/akka-persistence-r2dbc/1.2.0-M7/akka/persistence/r2dbc/R2dbcSettings.html" title="akka.persistence.r2dbc.R2dbcSettings"><code>R2dbcSettings</code></a></span><span class="group-java"><a href="/api/akka-persistence-r2dbc/1.2.0-M7/akka/persistence/r2dbc/R2dbcSettings.html" title="akka.persistence.r2dbc.R2dbcSettings"><code>R2dbcSettings</code></a></span> class has been removed, the <code>ConnectionFactorySettings</code> and <code>Dialect</code> classes has been removed. A public API for looking at what dialect is used is now provided through <code>R2dbcSettings.dialectName</code>.</p>
<a id="eventsBySlicesStartingFromSnapshots"></a>
<h3><a href="#optional-changes-for-eventsbyslicesstartingfromsnapshots" name="optional-changes-for-eventsbyslicesstartingfromsnapshots" class="anchor"><span class="anchor-link"></span></a>Optional changes for eventsBySlicesStartingFromSnapshots</h3>
<p>These changes are only needed if you use the <a href="query.html#eventsbyslicesstartingfromsnapshots">new feature of using snapshots as starting points</a> for <code>eventsBySlices</code> queries.</p>
<p>The <code>snapshot</code> table must be altered to add two new columns:</p>
<dl>
  <dt>Postgres</dt>
  <dd>
  <pre class="prettyprint"><code class="language-sql">ALTER TABLE snapshot ADD COLUMN IF NOT EXISTS db_timestamp timestamp with time zone;
ALTER TABLE snapshot ADD COLUMN IF NOT EXISTS tags TEXT ARRAY;
</code></pre></dd>
  <dt>Yugabyte</dt>
  <dd>
  <pre class="prettyprint"><code class="language-sql">ALTER TABLE snapshot ADD COLUMN IF NOT EXISTS db_timestamp timestamp with time zone;
ALTER TABLE snapshot ADD COLUMN IF NOT EXISTS tags TEXT ARRAY;
</code></pre></dd>
</dl>
<p>Populate the two new columns in the <code>snapshot</code> table from corresponding events in the <code>event_journal</code> table.</p>
<dl>
  <dt>Postgres</dt>
  <dd>
  <pre class="prettyprint"><code class="language-sql">UPDATE snapshot s SET db_timestamp = e.db_timestamp, tags = e.tags FROM event_journal e WHERE s.persistence_id = e.persistence_id and s.seq_nr = e.seq_nr;
</code></pre></dd>
  <dt>Yugabyte</dt>
  <dd>
  <pre class="prettyprint"><code class="language-sql">UPDATE snapshot s SET db_timestamp = e.db_timestamp, tags = e.tags FROM event_journal e WHERE s.persistence_id = e.persistence_id and s.seq_nr = e.seq_nr;
</code></pre></dd>
</dl>
<p>A new index must be added to the <code>snapshot</code> table:</p>
<dl>
  <dt>Postgres</dt>
  <dd>
  <pre class="prettyprint"><code class="language-sql">CREATE INDEX IF NOT EXISTS snapshot_slice_idx ON snapshot(slice, entity_type, db_timestamp);
</code></pre></dd>
  <dt>Yugabyte</dt>
  <dd>
  <pre class="prettyprint"><code class="language-sql">CREATE INDEX IF NOT EXISTS snapshot_slice_idx ON snapshot(slice ASC, entity_type ASC, db_timestamp ASC, persistence_id)
  SPLIT AT VALUES ((127), (255), (383), (511), (639), (767), (895));
</code></pre></dd>
</dl>
<p>The feature must be enabled with configuration:</p>
<pre class="prettyprint"><code class="language-hocon">akka.persistence.r2dbc.query.start-from-snapshot.enabled = true
</code></pre>
<p>These changes can be made in a rolling update process.</p>
<ol>
  <li>While running the old version, alter tables to add the two columns.</li>
  <li>Enable configuration and roll out new version. Don&rsquo;t use <code>eventsBySlicesStartingFromSnapshots</code> yet.</li>
  <li>Populate the columns with the update statement. Create the index.</li>
  <li>Roll out another version where you can use <code>eventsBySlicesStartingFromSnapshots</code>.</li>
</ol>
</div>
</article>
<div class="row">
<div class="small-12 column">
<section class="nav-prev-next row">
<div class="nav-prev small-6 column">
<a href="migration.html"><i class="icon-prev"></i> <span class="link-prev">Migration tool</span></a>
</div>
<div class="nav-next small-6 column clearfix">
<a class="float-right" href="contributing.html">Contributing <i class="icon-next"></i></a>
</div>
</section>
</div>
</div>
<div class="source-github row">
Found an error in this documentation? The source code for this page can be found <a href="https://github.com/akka/akka-persistence-r2dbc/tree/v1.2.0-M7/docs/src/main/paradox/migration-guide.md">here</a>.
Please feel free to edit and contribute a pull request.
</div>

<footer class="page-footer row clearfix">
<img class="akka-icon float-left show-for-medium" src="images/akka-icon.svg" />
<section class="copyright">
<div>Akka Persistence R2DBC is available under the <a href="https://www.lightbend.com/akka/license" target="_blank">Business Source License 1.1</a>.</div>
<p class="legal">
&copy; 2011-2023 <a href="https://www.lightbend.com" target="_blank">Lightbend, Inc.</a> |
<a href="https://www.lightbend.com/legal/licenses" target="_blank">Licenses</a> |
<a href="https://www.lightbend.com/legal/terms" target="_blank">Terms</a> |
<a href="https://www.lightbend.com/legal/privacy" target="_blank">Privacy Policy</a> |
<a href="https://akka.io/cookie/" target="_blank">Cookie Listing</a> |
<a class="optanon-toggle-display">Cookie Settings</a>
</p>
</section>

</footer>
</section>
</main>
</div>

<script type="text/javascript" src="js/scrollsneak.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="js/groups.js"></script>
<script type="text/javascript" src="js/page.js"></script>
<script type="text/javascript" src="js/snippets.js"></script>
<script type="text/javascript" src="js/magellan.js"></script>
<script type="text/javascript" src="js/metadata-toggle.js"></script>
<script type="text/javascript" src="js/lbHeader.js"></script>

<style type="text/css">@import "lib/prettify/prettify.css";</style>
<script type="text/javascript" src="lib/prettify/prettify.js"></script>
<script type="text/javascript" src="lib/prettify/lang-scala.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(){window.prettyPrint && prettyPrint()});
//]]></script>
<script type="text/javascript" src="assets/js/warnOldVersion.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(jq){initOldVersionWarnings(jq, '1.2.0-M7', 'https://doc.akka.io/docs/akka-persistence-r2dbc/current/')});
//]]></script>


</body>
</html>
