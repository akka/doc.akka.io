<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Getting Started &bull; Akka Persistence R2DBC Documentation</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="An Akka Persistence backed by SQL database with R2DBC"/>
<link rel="canonical" href="https://doc.akka.io/docs/akka-persistence-r2dbc/current/getting-started.html"/>
<script type="text/javascript" src="lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="lib/foundation/dist/js/foundation.min.js"></script>
<link rel="stylesheet" type="text/css" href="lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="lib/foundation/dist/css/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" type="text/css" href="css/icons.css"/>
<link rel="stylesheet" type="text/css" href="css/page-8.css"/>
<link rel="stylesheet" type="text/css" href="css/banner-2.css"/>
<link rel="shortcut icon" href="images/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png"/>
<link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png"/>
<link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png"/>
<link rel="manifest" href="images/manifest.json"/>
<meta name="msapplication-TileImage" content="images/mstile-150x150.png"/>
<meta name="msapplication-TileColor" content="#15a9ce"/>
<meta name="theme-color" content="#15a9ce"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) start -->
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js"  type="text/javascript" charset="UTF-8" data-domain-script="28b912e7-09e9-43d5-91e4-3d1897044004" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) end -->
<!--Google Analytics NOTE this will stop processing data July 1st 2023. At which point this embed code can be removed-->
<script type="text/plain" class="optanon-category-2">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', '']);
_gaq.push(['_setDomainName', '']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})()
</script>

<!-- Google Tag Manager: Updated May 17th 2023 - Cookie Compliance checks have been moved into Google Tag Manager -->
<script type="text/javascript">
(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KBJGH35');
</script>

</head>

<body id="underlay" data-toggler="nav-open">
<div id="lightbend-banner" class="lightbend-banner akka full-width" data-category="OSS Lightbend Banner Impression" data-label="Akka Banner Impression">
<div class="oss-wrapper">
<div class="oss-brand">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lightbend Logo - Akka Banner" href="https://www.lightbend.com">
<img class="lightbend-logo" src="images/banner-logos/lightbend-reverse.svg" alt="Lightbend" title="Lightbend">
</a>
</div>
<div class="oss-ad no-drop-down">
<nav id="lightbendRotator" class="lightbend-rotator">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Promo Rotator - Lightbend Changed its Software Licensing Model for Akka Technology. [License FAQ] - Akka Banner" href="https://www.lightbend.com/akka/license-faq">
<strong>Lightbend</strong> Changed its Software Licensing Model for Akka Technology. <span class="akka-btn">License FAQ</span>
</a>
</nav>
</div>
</div>
</div>

<header class="site-header hide-for-large">
<div class="sticky-header clearfix">
<a href="https://akka.io"><img class="logo" src="images/akka-logo-reverse.svg"/></a>

<button class="menu-icon float-right" type="button" data-toggle="underlay overlay"></button>
</div>
<div id="overlay" class="overlay-nav" data-toggler="nav-open">
<header class="nav-header">
<div class="nav-header-title">
<h1><a href="index.html">Akka Persistence R2DBC Documentation</a></h1>
</div>
<div class="nav-header-version">
Version 1.2.0-M6
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
<select class="supergroup" name="Dialect"><option class="group" value="group-postgres">Postgres</option><option class="group" value="group-yugabyte">Yugabyte</option><option class="group" value="group-h2">H2</option></select>
</div>
</header>
<nav class="nav-toc">
<ul>
  <li><a href="overview.html" class="page">Overview</a></li>
  <li><a href="getting-started.html#getting-started" class="active page">Getting Started</a>
  <ul>
    <li><a href="getting-started.html#dependencies" class="header">Dependencies</a></li>
    <li><a href="getting-started.html#enabling" class="header">Enabling</a></li>
    <li><a href="getting-started.html#local-testing-with-docker" class="header">Local testing with docker</a></li>
  </ul></li>
  <li><a href="journal.html" class="page">Journal plugin</a></li>
  <li><a href="snapshots.html" class="page">Snapshot store plugin</a></li>
  <li><a href="durable-state-store.html" class="page">Durable state store plugin</a></li>
  <li><a href="query.html" class="page">Query Plugin</a></li>
  <li><a href="postgres_json.html" class="page">PostgreSQL JSON</a></li>
  <li><a href="projection.html" class="page">Projection</a></li>
  <li><a href="config.html" class="page">Configuration</a></li>
  <li><a href="cleanup.html" class="page">Database Cleanup</a></li>
  <li><a href="migration.html" class="page">Migration tool</a></li>
  <li><a href="migration-guide.html" class="page">Migration Guide</a></li>
  <li><a href="contributing.html" class="page">Contributing</a></li>
</ul>
</nav>
</div>
</header>
<div class="site-content-wrapper">
<aside class="sticky-sidebar show-for-large">
<header class="nav-header sticky-sidebar-header">
<div class="nav-header-title">
<h1><a href="index.html">Akka Persistence R2DBC Documentation</a></h1>
</div>
<div class="nav-header-version">
Version 1.2.0-M6
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
<select class="supergroup" name="Dialect"><option class="group" value="group-postgres">Postgres</option><option class="group" value="group-yugabyte">Yugabyte</option><option class="group" value="group-h2">H2</option></select>
</div>
</header>
<nav class="site-nav sticky-sidebar-contents">
<div class="nav-toc">
<ul>
  <li><a href="overview.html" class="page">Overview</a></li>
  <li><a href="getting-started.html#getting-started" class="active page">Getting Started</a>
  <ul>
    <li><a href="getting-started.html#dependencies" class="header">Dependencies</a></li>
    <li><a href="getting-started.html#enabling" class="header">Enabling</a></li>
    <li><a href="getting-started.html#local-testing-with-docker" class="header">Local testing with docker</a></li>
  </ul></li>
  <li><a href="journal.html" class="page">Journal plugin</a></li>
  <li><a href="snapshots.html" class="page">Snapshot store plugin</a></li>
  <li><a href="durable-state-store.html" class="page">Durable state store plugin</a></li>
  <li><a href="query.html" class="page">Query Plugin</a></li>
  <li><a href="postgres_json.html" class="page">PostgreSQL JSON</a></li>
  <li><a href="projection.html" class="page">Projection</a></li>
  <li><a href="config.html" class="page">Configuration</a></li>
  <li><a href="cleanup.html" class="page">Database Cleanup</a></li>
  <li><a href="migration.html" class="page">Migration tool</a></li>
  <li><a href="migration-guide.html" class="page">Migration Guide</a></li>
  <li><a href="contributing.html" class="page">Contributing</a></li>
</ul>
</div>
</nav>
<footer class="nav-footer sticky-sidebar-footer">
<a href="https://akka.io"><img class="logo" src="images/akka-logo-reverse.svg"/></a>

</footer>
</aside>
<main class="fixed-shift-for-large expanded row">
<section class="site-content small-12 column">
<article class="page-content row">
<div class="small-12 column" id="docs">
<h1><a href="#getting-started" name="getting-started" class="anchor"><span class="anchor-link"></span></a>Getting Started</h1>
<h2><a href="#dependencies" name="dependencies" class="anchor"><span class="anchor-link"></span></a>Dependencies</h2>
<p>The Akka dependencies are available from Akka&rsquo;s library repository. To access them there, you need to configure the URL for this repository.</p><dl class="repository"><dt>Maven</dt><dd><pre class="prettyprint"><code class="language-xml">&lt;project&gt
  ...
  &lt;repositories&gt;
    &lt;repository&gt;
      &lt;id&gt;akka-repository&lt;/id&gt;
      &lt;name>Akka library repository&lt;/name&gt;
      &lt;url>https://repo.akka.io/maven&lt;/url&gt;
    &lt;/repository&gt;
  &lt;/repositories&gt
&lt;/project&gt;
</code></pre></dd><dt>sbt</dt><dd><pre class="prettyprint"><code class="language-scala">resolvers += "Akka library repository".at("https://repo.akka.io/maven")
</code></pre></dd><dt>Gradle</dt><dd><pre class="prettyprint"><code class="language-gradle">repositories {
    mavenCentral()
    maven {
        url "https://repo.akka.io/maven"
    }
}
</code></pre></dd></dl>
<p>Additionally, add the dependency as below.</p><dl class="dependency"><dt>Maven</dt><dd><pre class="prettyprint"><code class="language-xml">&lt;properties&gt;
  &lt;scala.binary.version&gt;2.13&lt;/scala.binary.version&gt;
&lt;/properties&gt;
&lt;dependencies&gt
  &lt;dependency&gt;
    &lt;groupId&gt;com.lightbend.akka&lt;/groupId&gt;
    &lt;artifactId&gt;akka-persistence-r2dbc_${scala.binary.version}&lt;/artifactId&gt;
    &lt;version&gt;1.2.0-M6&lt;/version&gt;
  &lt;/dependency&gt
&lt;/dependencies&gt;</code></pre></dd><dt>sbt</dt><dd><pre class="prettyprint"><code class="language-scala">libraryDependencies += "com.lightbend.akka" %% "akka-persistence-r2dbc" % "1.2.0-M6"</code></pre></dd><dt>Gradle</dt><dd><pre class="prettyprint"><code class="language-gradle">def versions = [
  ScalaBinary: "2.13"
]
dependencies {
  implementation "com.lightbend.akka:akka-persistence-r2dbc_${versions.ScalaBinary}:1.2.0-M6"
}</code></pre></dd></dl>
<p>This plugin depends on Akka 2.9.0-M3 or later, and note that it is important that all <code>akka-*</code> dependencies are in the same version, so it is recommended to depend on them explicitly to avoid problems with transient dependencies causing an unlucky mix of versions.</p>
<p>The plugin is published for Scala 2.13 and 2.12.</p>
<h2><a href="#enabling" name="enabling" class="anchor"><span class="anchor-link"></span></a>Enabling</h2>
<p>To enable the plugins to be used by default, add the following line to your Akka <code>application.conf</code>:</p>
<pre><code>akka.persistence.journal.plugin = &quot;akka.persistence.r2dbc.journal&quot;
akka.persistence.snapshot-store.plugin = &quot;akka.persistence.r2dbc.snapshot&quot;
akka.persistence.state.plugin = &quot;akka.persistence.r2dbc.state&quot;
</code></pre>
<p>More information about each individual plugin in:</p>
<ul>
  <li><a href="journal.html">journal</a></li>
  <li><a href="snapshots.html">snapshot store</a></li>
  <li><a href="durable-state-store.html">durable state store</a></li>
  <li><a href="query.html">queries</a></li>
</ul>
<h3><a href="#selecting-database-dialect" name="selecting-database-dialect" class="anchor"><span class="anchor-link"></span></a>Selecting database dialect</h3>
<p>You will also need to configure which database dialect to use:</p>
<h4><a href="#postgres" name="postgres" class="anchor"><span class="anchor-link"></span></a>Postgres</h4>
<p>A transitive dependency pulls in Postgres drivers by default. To use Postgres you only configure the connection factory to the default Postgres block:</p>
<pre class="prettyprint"><code class="language-hocon">akka.persistence.r2dbc.connection-factory = ${akka.persistence.r2dbc.postgres}
akka.persistence.r2dbc.connection-factory = {
  # overrides for default values from the &#39;akka.persistence.r2dbc.postgres&#39; config block
  user = &quot;myuser&quot;
}
</code></pre>
<p>See <a href="config.html">Configuration</a> for more configuration details.</p>
<h4><a href="#yugabyte" name="yugabyte" class="anchor"><span class="anchor-link"></span></a>Yugabyte</h4>
<p>A transitive dependency pulls in Postgres drivers that can be used to connect to Yugabyte by default. To use Yugabyte you only configure the connection factory to the default Yugabyte block:</p>
<pre class="prettyprint"><code class="language-hocon">akka.persistence.r2dbc.connection-factory = ${akka.persistence.r2dbc.yugabyte}
akka.persistence.r2dbc.connection-factory = {
  # overrides for default values from the &#39;akka.persistence.r2dbc.yugabyte&#39; config block
  user = &quot;myuser&quot;
}
</code></pre>
<p>See <a href="config.html">Configuration</a> for more configuration details.</p>
<h4><a href="#using-h2" name="using-h2" class="anchor"><span class="anchor-link"></span></a>Using H2</h4>
<p>The H2 dependencies are marked as <code>provided</code> dependencies of <code>akka-persistence-r2dbc</code> to not be pulled in for projects not using H2. They must be listed explicitly as dependencies in the build configuration for projects that use them. The two required artifacts are:</p><dl class="dependency"><dt>Maven</dt><dd><pre class="prettyprint"><code class="language-xml">&lt;dependencies&gt
  &lt;dependency&gt;
    &lt;groupId&gt;com.h2database&lt;/groupId&gt;
    &lt;artifactId&gt;h2&lt;/artifactId&gt;
    &lt;version&gt;2.2.222&lt;/version&gt;
  &lt;/dependency&gt
  &lt;dependency&gt;
    &lt;groupId&gt;io.r2dbc&lt;/groupId&gt;
    &lt;artifactId&gt;r2dbc-h2&lt;/artifactId&gt;
    &lt;version&gt;1.0.0.RELEASE&lt;/version&gt;
  &lt;/dependency&gt
&lt;/dependencies&gt;</code></pre></dd><dt>sbt</dt><dd><pre class="prettyprint"><code class="language-scala">libraryDependencies ++= Seq(
  "com.h2database" % "h2" % "2.2.222",
  "io.r2dbc" % "r2dbc-h2" % "1.0.0.RELEASE"
)</code></pre></dd><dt>Gradle</dt><dd><pre class="prettyprint"><code class="language-gradle">dependencies {
  implementation "com.h2database:h2:2.2.222"
  implementation "io.r2dbc:r2dbc-h2:1.0.0.RELEASE"
}</code></pre></dd></dl>
<p>With the dependencies added to your project, configure the connection factory to the default H2 block:</p>
<pre class="prettyprint"><code class="language-hocon">akka.persistence.r2dbc.connection-factory = ${akka.persistence.r2dbc.h2}
akka.persistence.r2dbc.connection-factory = {
  # overrides for default values from the &#39;akka.persistence.r2dbc.h2&#39; config block
  protocol = &quot;mem&quot;
  database = &quot;mydb&quot;
}
</code></pre>
<p>See <a href="config.html">Configuration</a> for more configuration details.</p>
<h2><a href="#local-testing-with-docker" name="local-testing-with-docker" class="anchor"><span class="anchor-link"></span></a>Local testing with docker</h2>
<p>The database can be run in Docker. Here&rsquo;s a sample docker compose file:</p>
<dl>
  <dt>Postgres</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-persistence-r2dbc/tree/v1.2.0-M6/docker/docker-compose-postgres.yml" target="_blank" title="Go to snippet source">source</a><code class="language-yml">version: &#39;2.2&#39;
services:
  postgres-db:
    image: postgres:latest
    container_name: postgres-db
    ports:
      - 5432:5432
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    healthcheck:
      test: [&#39;CMD&#39;, &#39;pg_isready&#39;, &quot;-q&quot;, &quot;-d&quot;, &quot;postgres&quot;, &quot;-U&quot;, &quot;postgres&quot;]
      interval: 5s
      retries: 5
      start_period: 5s
      timeout: 5s</code></pre></dd>
  <dt>Yugabyte</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-persistence-r2dbc/tree/v1.2.0-M6/docker/docker-compose-yugabyte.yml" target="_blank" title="Go to snippet source">source</a><code class="language-yml">version: &#39;2&#39;

# Local Yugabyte database, see https://docs.yugabyte.com/latest/deploy/docker/docker-compose/

volumes:
  yb-master-data-1:
  yb-tserver-data-1:

services:
  yb-master:
    image: yugabytedb/yugabyte:2.16.0.0-b90
    container_name: yb-master-n1
    volumes:
      - yb-master-data-1:/mnt/master
    command: [ &quot;/home/yugabyte/bin/yb-master&quot;,
               &quot;--fs_data_dirs=/mnt/master&quot;,
               &quot;--master_addresses=yb-master-n1:7100&quot;,
               &quot;--rpc_bind_addresses=yb-master-n1:7100&quot;,
               &quot;--replication_factor=1&quot; ]
    ports:
      - &quot;7000:7000&quot;
    environment:
      SERVICE_7000_NAME: yb-master

  yb-tserver:
    image: yugabytedb/yugabyte:2.16.0.0-b90
    container_name: yb-tserver-n1
    shm_size: &#39;512mb&#39;
    volumes:
      - yb-tserver-data-1:/mnt/tserver
    command: [ &quot;/home/yugabyte/bin/yb-tserver&quot;,
               &quot;--fs_data_dirs=/mnt/tserver&quot;,
               &quot;--start_pgsql_proxy&quot;,
               &quot;--rpc_bind_addresses=yb-tserver-n1:9100&quot;,
               &quot;--tserver_master_addrs=yb-master-n1:7100&quot;,
               &quot;--ysql_sequence_cache_minval=1&quot;,
               &quot;--yb_num_shards_per_tserver=1&quot; ]
    ports:
      - &quot;9042:9042&quot;
      - &quot;5433:5433&quot;
      - &quot;9000:9000&quot;
    environment:
      SERVICE_5433_NAME: ysql
      SERVICE_9042_NAME: ycql
      SERVICE_6379_NAME: yedis
      SERVICE_9000_NAME: yb-tserver
    depends_on:
      - yb-master</code></pre></dd>
</dl>
<p>Start with:</p>
<dl>
  <dt>Postgres</dt>
  <dd>
  <pre><code>docker-compose -f docker/docker-compose-postgres.yml up --wait
</code></pre></dd>
  <dt>Yugabyte</dt>
  <dd>
  <pre><code>docker-compose -f docker/docker-compose-yugabyte.yml up
</code></pre></dd>
</dl>
<a id="schema"></a>
<h3><a href="#creating-the-schema" name="creating-the-schema" class="anchor"><span class="anchor-link"></span></a>Creating the schema</h3>
<p>Tables and indexes:</p>
<dl>
  <dt>Postgres</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-persistence-r2dbc/tree/v1.2.0-M6/ddl-scripts/create_tables_postgres.sql" target="_blank" title="Go to snippet source">source</a><code class="language-sql">CREATE TABLE IF NOT EXISTS event_journal(
  slice INT NOT NULL,
  entity_type VARCHAR(255) NOT NULL,
  persistence_id VARCHAR(255) NOT NULL,
  seq_nr BIGINT NOT NULL,
  db_timestamp timestamp with time zone NOT NULL,

  event_ser_id INTEGER NOT NULL,
  event_ser_manifest VARCHAR(255) NOT NULL,
  event_payload BYTEA NOT NULL,

  deleted BOOLEAN DEFAULT FALSE NOT NULL,
  writer VARCHAR(255) NOT NULL,
  adapter_manifest VARCHAR(255),
  tags TEXT ARRAY,

  meta_ser_id INTEGER,
  meta_ser_manifest VARCHAR(255),
  meta_payload BYTEA,

  PRIMARY KEY(persistence_id, seq_nr)
);

-- `event_journal_slice_idx` is only needed if the slice based queries are used
CREATE INDEX IF NOT EXISTS event_journal_slice_idx ON event_journal(slice, entity_type, db_timestamp, seq_nr);

CREATE TABLE IF NOT EXISTS snapshot(
  slice INT NOT NULL,
  entity_type VARCHAR(255) NOT NULL,
  persistence_id VARCHAR(255) NOT NULL,
  seq_nr BIGINT NOT NULL,
  db_timestamp timestamp with time zone,
  write_timestamp BIGINT NOT NULL,
  ser_id INTEGER NOT NULL,
  ser_manifest VARCHAR(255) NOT NULL,
  snapshot BYTEA NOT NULL,
  tags TEXT ARRAY,
  meta_ser_id INTEGER,
  meta_ser_manifest VARCHAR(255),
  meta_payload BYTEA,

  PRIMARY KEY(persistence_id)
);

-- `snapshot_slice_idx` is only needed if the slice based queries are used together with snapshot as starting point
CREATE INDEX IF NOT EXISTS snapshot_slice_idx ON snapshot(slice, entity_type, db_timestamp);

CREATE TABLE IF NOT EXISTS durable_state (
  slice INT NOT NULL,
  entity_type VARCHAR(255) NOT NULL,
  persistence_id VARCHAR(255) NOT NULL,
  revision BIGINT NOT NULL,
  db_timestamp timestamp with time zone NOT NULL,

  state_ser_id INTEGER NOT NULL,
  state_ser_manifest VARCHAR(255),
  state_payload BYTEA NOT NULL,
  tags TEXT ARRAY,

  PRIMARY KEY(persistence_id, revision)
);

-- `durable_state_slice_idx` is only needed if the slice based queries are used
CREATE INDEX IF NOT EXISTS durable_state_slice_idx ON durable_state(slice, entity_type, db_timestamp, revision);</code></pre></dd>
  <dt>Postgres JSONB</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-persistence-r2dbc/tree/v1.2.0-M6/ddl-scripts/create_tables_postgres_jsonb.sql" target="_blank" title="Go to snippet source">source</a><code class="language-sql">CREATE TABLE IF NOT EXISTS event_journal(
  slice INT NOT NULL,
  entity_type VARCHAR(255) NOT NULL,
  persistence_id VARCHAR(255) NOT NULL,
  seq_nr BIGINT NOT NULL,
  db_timestamp timestamp with time zone NOT NULL,

  event_ser_id INTEGER NOT NULL,
  event_ser_manifest VARCHAR(255) NOT NULL,
  event_payload JSONB NOT NULL,

  deleted BOOLEAN DEFAULT FALSE NOT NULL,
  writer VARCHAR(255) NOT NULL,
  adapter_manifest VARCHAR(255),
  tags TEXT ARRAY,

  meta_ser_id INTEGER,
  meta_ser_manifest VARCHAR(255),
  meta_payload BYTEA,

  PRIMARY KEY(persistence_id, seq_nr)
);

-- `event_journal_slice_idx` is only needed if the slice based queries are used
CREATE INDEX IF NOT EXISTS event_journal_slice_idx ON event_journal(slice, entity_type, db_timestamp, seq_nr);

CREATE TABLE IF NOT EXISTS snapshot(
  slice INT NOT NULL,
  entity_type VARCHAR(255) NOT NULL,
  persistence_id VARCHAR(255) NOT NULL,
  seq_nr BIGINT NOT NULL,
  db_timestamp timestamp with time zone,
  write_timestamp BIGINT NOT NULL,
  ser_id INTEGER NOT NULL,
  ser_manifest VARCHAR(255) NOT NULL,
  snapshot JSONB NOT NULL,
  tags TEXT ARRAY,
  meta_ser_id INTEGER,
  meta_ser_manifest VARCHAR(255),
  meta_payload BYTEA,

  PRIMARY KEY(persistence_id)
);

-- `snapshot_slice_idx` is only needed if the slice based queries are used together with snapshot as starting point
CREATE INDEX IF NOT EXISTS snapshot_slice_idx ON snapshot(slice, entity_type, db_timestamp);

CREATE TABLE IF NOT EXISTS durable_state (
  slice INT NOT NULL,
  entity_type VARCHAR(255) NOT NULL,
  persistence_id VARCHAR(255) NOT NULL,
  revision BIGINT NOT NULL,
  db_timestamp timestamp with time zone NOT NULL,

  state_ser_id INTEGER NOT NULL,
  state_ser_manifest VARCHAR(255),
  state_payload JSONB NOT NULL,
  tags TEXT ARRAY,

  PRIMARY KEY(persistence_id, revision)
);

-- `durable_state_slice_idx` is only needed if the slice based queries are used
CREATE INDEX IF NOT EXISTS durable_state_slice_idx ON durable_state(slice, entity_type, db_timestamp, revision);</code></pre></dd>
  <dt>Yugabyte</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-persistence-r2dbc/tree/v1.2.0-M6/ddl-scripts/create_tables_yugabyte.sql" target="_blank" title="Go to snippet source">source</a><code class="language-sql">CREATE TABLE IF NOT EXISTS event_journal(
  slice INT NOT NULL,
  entity_type VARCHAR(255) NOT NULL,
  persistence_id VARCHAR(255) NOT NULL,
  seq_nr BIGINT NOT NULL,
  db_timestamp timestamp with time zone NOT NULL,

  event_ser_id INTEGER NOT NULL,
  event_ser_manifest VARCHAR(255) NOT NULL,
  event_payload BYTEA NOT NULL,

  deleted BOOLEAN DEFAULT FALSE NOT NULL,
  writer VARCHAR(255) NOT NULL,
  adapter_manifest VARCHAR(255),
  tags TEXT ARRAY,

  meta_ser_id INTEGER,
  meta_ser_manifest VARCHAR(255),
  meta_payload BYTEA,

  PRIMARY KEY(persistence_id HASH, seq_nr ASC)
);

-- `event_journal_slice_idx` is only needed if the slice based queries are used
CREATE INDEX IF NOT EXISTS event_journal_slice_idx ON event_journal(slice ASC, entity_type ASC, db_timestamp ASC, seq_nr ASC, persistence_id, deleted)
  SPLIT AT VALUES ((127), (255), (383), (511), (639), (767), (895));

CREATE TABLE IF NOT EXISTS snapshot(
  slice INT NOT NULL,
  entity_type VARCHAR(255) NOT NULL,
  persistence_id VARCHAR(255) NOT NULL,
  seq_nr BIGINT NOT NULL,
  db_timestamp timestamp with time zone,
  write_timestamp BIGINT NOT NULL,
  ser_id INTEGER NOT NULL,
  ser_manifest VARCHAR(255) NOT NULL,
  snapshot BYTEA NOT NULL,
  tags TEXT ARRAY,
  meta_ser_id INTEGER,
  meta_ser_manifest VARCHAR(255),
  meta_payload BYTEA,

  PRIMARY KEY(persistence_id HASH)
);

-- `snapshot_slice_idx` is only needed if the slice based queries are used together with snapshot as starting point
CREATE INDEX IF NOT EXISTS snapshot_slice_idx ON snapshot(slice ASC, entity_type ASC, db_timestamp ASC, persistence_id)
  SPLIT AT VALUES ((127), (255), (383), (511), (639), (767), (895));

CREATE TABLE IF NOT EXISTS durable_state (
  slice INT NOT NULL,
  entity_type VARCHAR(255) NOT NULL,
  persistence_id VARCHAR(255) NOT NULL,
  revision BIGINT NOT NULL,
  db_timestamp timestamp with time zone NOT NULL,

  state_ser_id INTEGER NOT NULL,
  state_ser_manifest VARCHAR(255),
  state_payload BYTEA NOT NULL,
  tags TEXT ARRAY,

  PRIMARY KEY(persistence_id HASH, revision ASC)
);

-- `durable_state_slice_idx` is only needed if the slice based queries are used
CREATE INDEX IF NOT EXISTS durable_state_slice_idx ON durable_state(slice ASC, entity_type ASC, db_timestamp ASC, revision ASC, persistence_id)
  SPLIT AT VALUES ((127), (255), (383), (511), (639), (767), (895));</code></pre></dd>
</dl>
<p>The ddl script can be run in Docker with:</p>
<dl>
  <dt>Postgres</dt>
  <dd>
  <pre><code>docker exec -i postgres-db psql -U postgres -t &lt; ddl-scripts/create_tables_postgres.sql
</code></pre></dd>
  <dt>Yugabyte</dt>
  <dd>
  <pre><code>docker exec -i yb-tserver-n1 /home/yugabyte/bin/ysqlsh -h yb-tserver-n1 -t &lt; ddl-scripts/create_tables_yugabyte.sql
</code></pre></dd>
</dl>
<h3><a href="#dropping-the-schema" name="dropping-the-schema" class="anchor"><span class="anchor-link"></span></a>Dropping the schema</h3>
<dl>
  <dt>Postgres</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-persistence-r2dbc/tree/v1.2.0-M6/ddl-scripts/drop_tables_postgres.sql" target="_blank" title="Go to snippet source">source</a><code class="language-sql">DROP INDEX event_journal_slice_idx;
DROP TABLE IF EXISTS event_journal;
DROP TABLE IF EXISTS snapshot;
DROP TABLE IF EXISTS durable_state;</code></pre></dd>
  <dt>Yugabyte</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-persistence-r2dbc/tree/v1.2.0-M6/ddl-scripts/drop_tables_postgres.sql" target="_blank" title="Go to snippet source">source</a><code class="language-sql">DROP INDEX event_journal_slice_idx;
DROP TABLE IF EXISTS event_journal;
DROP TABLE IF EXISTS snapshot;
DROP TABLE IF EXISTS durable_state;</code></pre></dd>
</dl>
<h3><a href="#local-testing-in-process-with-h2" name="local-testing-in-process-with-h2" class="anchor"><span class="anchor-link"></span></a>Local testing in process with H2</h3>
<p>H2 runs in the JVM process, either using a database directly in memory or in a local file. This means it requires no additional steps to start a database, it is started on first connection from the Akka Persistence R2DBC plugin.</p>
<p>The database for H2 is created on first connection. Additional database schema creation or changes can be applied using the setting <code>additional-init</code> setting.</p>
<p>Note that it is not possible to share the file based database storage between processes, usage in an Akka cluster is not possible. For other usages where several processes may run at the same time (for example a CI server) it is important to make sure each new process will use a separate file not shared with other processes.</p>
</div>
</article>
<div class="row">
<div class="small-12 column">
<section class="nav-prev-next row">
<div class="nav-prev small-6 column">
<a href="overview.html"><i class="icon-prev"></i> <span class="link-prev">Overview</span></a>
</div>
<div class="nav-next small-6 column clearfix">
<a class="float-right" href="journal.html">Journal plugin <i class="icon-next"></i></a>
</div>
</section>
</div>
</div>
<div class="source-github row">
Found an error in this documentation? The source code for this page can be found <a href="https://github.com/akka/akka-persistence-r2dbc/tree/v1.2.0-M6/docs/src/main/paradox/getting-started.md">here</a>.
Please feel free to edit and contribute a pull request.
</div>

<footer class="page-footer row clearfix">
<img class="akka-icon float-left show-for-medium" src="images/akka-icon.svg" />
<section class="copyright">
<div>Akka Persistence R2DBC is available under the <a href="https://www.lightbend.com/akka/license" target="_blank">Business Source License 1.1</a>.</div>
<p class="legal">
&copy; 2011-2023 <a href="https://www.lightbend.com" target="_blank">Lightbend, Inc.</a> |
<a href="https://www.lightbend.com/legal/licenses" target="_blank">Licenses</a> |
<a href="https://www.lightbend.com/legal/terms" target="_blank">Terms</a> |
<a href="https://www.lightbend.com/legal/privacy" target="_blank">Privacy Policy</a> |
<a href="https://akka.io/cookie/" target="_blank">Cookie Listing</a> |
<a class="optanon-toggle-display">Cookie Settings</a>
</p>
</section>

</footer>
</section>
</main>
</div>

<script type="text/javascript" src="js/scrollsneak.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="js/groups.js"></script>
<script type="text/javascript" src="js/page.js"></script>
<script type="text/javascript" src="js/snippets.js"></script>
<script type="text/javascript" src="js/magellan.js"></script>
<script type="text/javascript" src="js/metadata-toggle.js"></script>
<script type="text/javascript" src="js/lbHeader.js"></script>

<style type="text/css">@import "lib/prettify/prettify.css";</style>
<script type="text/javascript" src="lib/prettify/prettify.js"></script>
<script type="text/javascript" src="lib/prettify/lang-scala.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(){window.prettyPrint && prettyPrint()});
//]]></script>
<script type="text/javascript" src="assets/js/warnOldVersion.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(jq){initOldVersionWarnings(jq, '1.2.0-M6', 'https://doc.akka.io/docs/akka-persistence-r2dbc/current/')});
//]]></script>


</body>
</html>
