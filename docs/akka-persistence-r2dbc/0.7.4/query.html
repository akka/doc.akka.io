<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Query Plugin &bull; Akka Persistence R2DBC Documentation</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="An Akka Persistence backed by SQL database with R2DBC"/>
<link rel="canonical" href="https://doc.akka.io/docs/akka-persistence-r2dbc/current/query.html"/>
<script type="text/javascript" src="lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="lib/foundation/dist/js/foundation.min.js"></script>
<link rel="stylesheet" type="text/css" href="lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="lib/foundation/dist/css/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" type="text/css" href="css/icons.css"/>
<link rel="stylesheet" type="text/css" href="css/page-8.css"/>
<link rel="stylesheet" type="text/css" href="css/banner-2.css"/>
<link rel="shortcut icon" href="images/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png"/>
<link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png"/>
<link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png"/>
<link rel="manifest" href="images/manifest.json"/>
<meta name="msapplication-TileImage" content="images/mstile-150x150.png"/>
<meta name="msapplication-TileColor" content="#15a9ce"/>
<meta name="theme-color" content="#15a9ce"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) start -->
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js"  type="text/javascript" charset="UTF-8" data-domain-script="28b912e7-09e9-43d5-91e4-3d1897044004" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) end -->
<!--Google Analytics-->
<script type="text/plain" class="optanon-category-2">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', '']);
_gaq.push(['_setDomainName', '']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})()
</script>
<!-- Google Tag Manager -->
<script type="text/plain" class="optanon-category-2">
(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KBJGH35');
</script>
<!--Marketo-->
<script type="text/plain" class="optanon-category-3">
(function() {
var didInit = false;
function initMunchkin() {
if(didInit === false) {
didInit = true;
Munchkin.init('558-NCX-702', { 'asyncOnly': true, 'disableClickDelay': true });
}
}
var s = document.createElement('script');
s.type = 'text/javascript';
s.async = true;
s.src = '//munchkin.marketo.net/munchkin.js';
s.onreadystatechange = function() {
if (this.readyState == 'complete' || this.readyState == 'loaded') {
initMunchkin();
}
};
s.onload = initMunchkin;
document.getElementsByTagName('head')[0].appendChild(s);
})();
</script>
</head>

<body id="underlay" data-toggler="nav-open">
<div id="lightbend-banner" class="lightbend-banner akka full-width" data-category="OSS Lightbend Banner Impression" data-label="Akka Banner Impression">
<div class="oss-wrapper">
<div class="oss-brand">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lightbend Logo - Akka Banner" href="https://www.lightbend.com">
<img class="lightbend-logo" src="images/banner-logos/lightbend-reverse.svg" alt="Lightbend" title="Lightbend">
</a>
</div>
<div class="oss-ad no-drop-down">
<nav id="lightbendRotator" class="lightbend-rotator">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Promo Rotator - Akka Serverless - Keep the data. Lose the database. Try now for free. [Learn More] - Akka Banner" href="https://www.lightbend.com/akka-serverless">
<strong>Akka Serverless</strong> - Keep the data. Lose the database. Try now for free. <span class="akka-btn">Learn More</span>
</a>
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Promo Rotator - Meet Akka Insights! A stand alone telemetry & observability offering. [Learn More] - Akka Banner" href="https://www.lightbend.com/akka-insights">
<strong>Meet Akka Insights!</strong>&nbsp;&nbsp;A stand alone telemetry & observability offering. <span class="akka-btn">Learn More</span>
</a>
</nav>
</div>
</div>
</div>

<header class="site-header hide-for-large">
<div class="sticky-header clearfix">
<a href="https://akka.io"><img class="logo" src="images/akka-logo-reverse.svg"/></a>

<button class="menu-icon float-right" type="button" data-toggle="underlay overlay"></button>
</div>
<div id="overlay" class="overlay-nav" data-toggler="nav-open">
<header class="nav-header">
<div class="nav-header-title">
<h1><a href="index.html">Akka Persistence R2DBC Documentation</a></h1>
</div>
<div class="nav-header-version">
Version 0.7.4
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="nav-toc">
<ul>
  <li><a href="overview.html" class="page">Overview</a></li>
  <li><a href="getting-started.html" class="page">Getting Started</a></li>
  <li><a href="connection-config.html" class="page">Connection configuration</a></li>
  <li><a href="journal.html" class="page">Journal plugin</a></li>
  <li><a href="snapshots.html" class="page">Snapshot store plugin</a></li>
  <li><a href="durable-state-store.html" class="page">Durable state store plugin</a></li>
  <li><a href="query.html#query-plugin" class="active page">Query Plugin</a>
  <ul>
    <li><a href="query.html#event-sourced-queries" class="header">Event sourced queries</a></li>
    <li><a href="query.html#publish-events-for-lower-latency-of-eventsbyslices" class="header">Publish events for lower latency of eventsBySlices</a></li>
    <li><a href="query.html#durable-state-queries" class="header">Durable state queries</a></li>
    <li><a href="query.html#configuration" class="header">Configuration</a></li>
  </ul></li>
  <li><a href="projection.html" class="page">Projection</a></li>
  <li><a href="migration.html" class="page">Migration tool</a></li>
  <li><a href="contributing.html" class="page">Contributing</a></li>
</ul>
</nav>
</div>
</header>
<div class="site-content-wrapper">
<aside class="sticky-sidebar show-for-large">
<header class="nav-header sticky-sidebar-header">
<div class="nav-header-title">
<h1><a href="index.html">Akka Persistence R2DBC Documentation</a></h1>
</div>
<div class="nav-header-version">
Version 0.7.4
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="site-nav sticky-sidebar-contents">
<div class="nav-toc">
<ul>
  <li><a href="overview.html" class="page">Overview</a></li>
  <li><a href="getting-started.html" class="page">Getting Started</a></li>
  <li><a href="connection-config.html" class="page">Connection configuration</a></li>
  <li><a href="journal.html" class="page">Journal plugin</a></li>
  <li><a href="snapshots.html" class="page">Snapshot store plugin</a></li>
  <li><a href="durable-state-store.html" class="page">Durable state store plugin</a></li>
  <li><a href="query.html#query-plugin" class="active page">Query Plugin</a>
  <ul>
    <li><a href="query.html#event-sourced-queries" class="header">Event sourced queries</a></li>
    <li><a href="query.html#publish-events-for-lower-latency-of-eventsbyslices" class="header">Publish events for lower latency of eventsBySlices</a></li>
    <li><a href="query.html#durable-state-queries" class="header">Durable state queries</a></li>
    <li><a href="query.html#configuration" class="header">Configuration</a></li>
  </ul></li>
  <li><a href="projection.html" class="page">Projection</a></li>
  <li><a href="migration.html" class="page">Migration tool</a></li>
  <li><a href="contributing.html" class="page">Contributing</a></li>
</ul>
</div>
</nav>
<footer class="nav-footer sticky-sidebar-footer">
<a href="https://akka.io"><img class="logo" src="images/akka-logo-reverse.svg"/></a>

</footer>
</aside>
<main class="fixed-shift-for-large expanded row">
<section class="site-content small-12 column">
<article class="page-content row">
<div class="small-12 column" id="docs">
<h1><a href="#query-plugin" name="query-plugin" class="anchor"><span class="anchor-link"></span></a>Query Plugin</h1>
<h2><a href="#event-sourced-queries" name="event-sourced-queries" class="anchor"><span class="anchor-link"></span></a>Event sourced queries</h2>
<p><span class="group-java"><a href="https://doc.akka.io/api/akka/2.6.19/akka/persistence/r2dbc/query/javadsl/R2dbcReadJournal.html" title="akka.persistence.r2dbc.query.javadsl.R2dbcReadJournal"><code>R2dbcReadJournal</code></a></span><span class="group-scala"><a href="https://doc.akka.io/api/akka/2.6.19/akka/persistence/r2dbc/query/scaladsl/R2dbcReadJournal.html" title="akka.persistence.r2dbc.query.scaladsl.R2dbcReadJournal"><code>R2dbcReadJournal</code></a></span> implements the following <a href="https://doc.akka.io/docs/akka/2.6/persistence-query.html">Persistence Queries</a>:</p>
<ul>
  <li><code>eventsByPersistenceId</code>, <code>currentEventsByPersistenceId</code></li>
  <li><code>eventsBySlices</code>, <code>currentEventsBySlices</code></li>
  <li><code>currentPersistenceIds</code></li>
</ul>
<p>Accessing the <code>R2dbcReadJournal</code>:</p>
<dl>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-persistence-r2dbc/tree/v0.7.4/docs/src/test/java/jdocs/home/query/QueryDocCompileOnly.java#L13-L47" target="_blank" title="Go to snippet source">source</a><code class="language-java">import akka.persistence.query.PersistenceQuery;
import akka.persistence.r2dbc.query.javadsl.R2dbcReadJournal;

R2dbcReadJournal eventQueries =
    PersistenceQuery.get(system)
        .getReadJournalFor(R2dbcReadJournal.class, R2dbcReadJournal.Identifier());</code></pre></dd>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-persistence-r2dbc/tree/v0.7.4/docs/src/test/scala/docs/home/query/QueryDocCompileOnly.scala#L14-L18" target="_blank" title="Go to snippet source">source</a><code class="language-scala">import akka.persistence.query.PersistenceQuery
import akka.persistence.r2dbc.query.scaladsl.R2dbcReadJournal

val eventQueries = PersistenceQuery(system)
  .readJournalFor[R2dbcReadJournal](R2dbcReadJournal.Identifier)</code></pre></dd>
</dl>
<h3><a href="#eventsbypersistenceid" name="eventsbypersistenceid" class="anchor"><span class="anchor-link"></span></a>eventsByPersistenceId</h3>
<p>The <code>eventsByPersistenceId</code> and <code>currentEventsByPersistenceId</code> queries are useful for retrieving events for a single entity with a given persistence id.</p>
<p>Example of <code>currentEventsByPersistenceId</code>:</p>
<dl>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-persistence-r2dbc/tree/v0.7.4/docs/src/test/java/jdocs/home/query/QueryDocCompileOnly.java#L59-L63" target="_blank" title="Go to snippet source">source</a><code class="language-java">PersistenceId persistenceId = PersistenceId.of(&quot;MyEntity&quot;, &quot;id1&quot;);
eventQueries
    .currentEventsByPersistenceId(persistenceId.id(), 1, 101)
    .map(envelope -&gt; &quot;event with seqNr &quot; + envelope.sequenceNr() + &quot;: &quot; + envelope.event())
    .runWith(Sink.foreach(System.out::println), system);</code></pre></dd>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-persistence-r2dbc/tree/v0.7.4/docs/src/test/scala/docs/home/query/QueryDocCompileOnly.scala#L31-L35" target="_blank" title="Go to snippet source">source</a><code class="language-scala">val persistenceId = PersistenceId(&quot;MyEntity&quot;, &quot;id1&quot;)
eventQueries
  .currentEventsByPersistenceId(persistenceId.id, 1, 101)
  .map(envelope =&gt; s&quot;event with seqNr ${envelope.sequenceNr}: ${envelope.event}&quot;)
  .runWith(Sink.foreach(println))</code></pre></dd>
</dl>
<h3><a href="#eventsbyslices" name="eventsbyslices" class="anchor"><span class="anchor-link"></span></a>eventsBySlices</h3>
<p>The <code>eventsBySlices</code> and <code>currentEventsBySlices</code> queries are useful for retrieving all events for a given entity type. <code>eventsBySlices</code> should be used via Akka Projection.</p><div class="callout note "><div class="callout-title">Note</div>
<p>This has historically been done with <code>eventsByTag</code> but the R2DBC plugin is instead providing <code>eventsBySlices</code> as an improved solution.</p>
<p>The usage of <code>eventsByTag</code> for Projections has the drawback that the number of tags must be decided up-front and can&rsquo;t easily be changed afterwards. Starting with too many tags means much overhead since many projection instances would be running on each node in a small Akka Cluster. Each projection instance polling the database periodically. Starting with too few tags means that it can&rsquo;t be scaled later to more Akka nodes.</p>
<p>With <code>eventsBySlices</code> more Projection instances can be added when needed and still reuse the offsets for the previous slice distributions.</p></div>
<p>A slice is deterministically defined based on the persistence id. The purpose is to evenly distribute all persistence ids over the slices. The <code>eventsBySlices</code> query is for a range of the slices. For example if using 1024 slices and running 4 Projection instances the slice ranges would be 0-255, 256-511, 512-767, 768-1023. Changing to 8 slice ranges means that the ranges would be 0-127, 128-255, 256-383, &hellip;, 768-895, 896-1023.</p>
<p>Example of <code>currentEventsBySlices</code>:</p>
<dl>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-persistence-r2dbc/tree/v0.7.4/docs/src/test/java/jdocs/home/query/QueryDocCompileOnly.java#L25-L88" target="_blank" title="Go to snippet source">source</a><code class="language-java">import akka.stream.javadsl.Source;
import akka.persistence.query.typed.EventEnvelope;

// Split the slices into 4 ranges
int numberOfSliceRanges = 4;
List&lt;Pair&lt;Integer, Integer&gt;&gt; sliceRanges = eventQueries.sliceRanges(numberOfSliceRanges);

// Example of using the first slice range
int minSlice = sliceRanges.get(0).first();
int maxSlice = sliceRanges.get(0).second();
String entityType = &quot;MyEntity&quot;;
Source&lt;EventEnvelope&lt;MyEvent&gt;, NotUsed&gt; source =
    eventQueries.currentEventsBySlices(entityType, minSlice, maxSlice, NoOffset.getInstance());
source
    .map(
        envelope -&gt;
            &quot;event from persistenceId &quot;
                + envelope.persistenceId()
                + &quot; with seqNr &quot;
                + envelope.sequenceNr()
                + &quot;: &quot;
                + envelope.event())
    .runWith(Sink.foreach(System.out::println), system);</code></pre></dd>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-persistence-r2dbc/tree/v0.7.4/docs/src/test/scala/docs/home/query/QueryDocCompileOnly.scala#L41-L56" target="_blank" title="Go to snippet source">source</a><code class="language-scala">import akka.persistence.query.typed.EventEnvelope

// Slit the slices into 4 ranges
val numberOfSliceRanges: Int = 4
val sliceRanges = eventQueries.sliceRanges(numberOfSliceRanges)

// Example of using the first slice range
val minSlice: Int = sliceRanges.head.min
val maxSlice: Int = sliceRanges.head.max
val entityType: String = &quot;MyEntity&quot;
eventQueries
  .currentEventsBySlices[MyEvent](entityType, minSlice, maxSlice, NoOffset.getInstance)
  .map(envelope =&gt;
    s&quot;event from persistenceId ${envelope.persistenceId} with &quot; +
    s&quot;seqNr ${envelope.sequenceNr}: ${envelope.event}&quot;)
  .runWith(Sink.foreach(println))</code></pre></dd>
</dl>
<p><code>eventsBySlices</code> should be used via <a href="projection.html">R2dbcProjection</a>, which will automatically handle the following difficulties. When using <code>R2dbcProjection</code> the events will be delivered in sequence number order without duplicates.</p>
<p>The consumer can keep track of its current position in the event stream by storing the <code>offset</code> and restart the query from a given <code>offset</code> after a crash/restart.</p>
<p>The offset is a <code>TimestampOffset</code> and it is based on the database <code>transaction_timestamp()</code> when the event was stored. <code>transaction_timestamp()</code> is the time when the transaction started, not when it was committed. This means that a &ldquo;later&rdquo; event may be visible first and when retrieving events after the previously seen timestamp we may miss some events and emit event with a later sequence number for a persistence id without emitting all preceding events. In distributed SQL databases there can also be clock skews for the database timestamps. For that reason <code>eventsBySlices</code> will perform additional backtracking queries to catch missed events. Events from backtracking will typically be duplicates of previously emitted events. It&rsquo;s the responsibility of the consumer to filter duplicates and make sure that events are processed in exact sequence number order for each persistence id. Such deduplication is provided by the R2DBC Projection.</p>
<p>Events emitted by the backtracking don&rsquo;t contain the event payload (<code>EventBySliceEnvelope.event</code> is None) and the consumer can load the full <code>EventBySliceEnvelope</code> with <a href="./R2dbcReadJournal.loadEnvelope.html">R2dbcReadJournal.loadEnvelope</a>.</p>
<p>The events will be emitted in the timestamp order with the caveat of duplicate events as described above. Events with the same timestamp are ordered by sequence number.</p>
<p><code>currentEventsBySlices</code> doesn&rsquo;t perform these backtracking queries and will not emit duplicates and the event payload is always full loaded.</p>
<h2><a href="#publish-events-for-lower-latency-of-eventsbyslices" name="publish-events-for-lower-latency-of-eventsbyslices" class="anchor"><span class="anchor-link"></span></a>Publish events for lower latency of eventsBySlices</h2>
<p>The <code>eventsBySlices</code> query polls the database periodically to find new events. By default, this interval is a few seconds, see <code>akka.persistence.r2dbc.query.refresh-interval</code> in the <a href="query.html#configuration">Configuration</a>. This interval can be reduced for lower latency, with the drawback of querying the database more frequently.</p>
<p>If you need latency below a few 100 milliseconds you can enable a feature that will publish the events within the Akka Cluster instead of reducing <code>refresh-interval</code>. Running <code>eventsBySlices</code> will subscribe to the events and emit them directly without waiting for next query poll. The tradeoff is that more CPU and network resources are used. The events must still be retrieved from the database, but at a lower polling frequency, because delivery of published messages are not guaranteed.</p>
<p>Enable publishing of events with configuration:</p>
<pre><code>akka.persistence.r2dbc.journal.publish-events = on
</code></pre>
<h2><a href="#durable-state-queries" name="durable-state-queries" class="anchor"><span class="anchor-link"></span></a>Durable state queries</h2>
<p><span class="group-java"><a href="https://doc.akka.io/api/akka/2.6.19/akka/persistence/r2dbc/state/javadsl/R2dbcDurableStateStore.html" title="akka.persistence.r2dbc.state.javadsl.R2dbcDurableStateStore"><code>R2dbcDurableStateStore</code></a></span><span class="group-scala"><a href="https://doc.akka.io/api/akka/2.6.19/akka/persistence/r2dbc/state/scaladsl/R2dbcDurableStateStore.html" title="akka.persistence.r2dbc.state.scaladsl.R2dbcDurableStateStore"><code>R2dbcDurableStateStore</code></a></span> implements the following <a href="https://doc.akka.io/docs/akka/2.6/durable-state/persistence-query.html">Persistence Queries</a>:</p>
<ul>
  <li><code>getObject</code></li>
  <li><code>changesBySlices</code>, <code>currentChangesBySlices</code></li>
  <li><code>currentPersistenceIds</code></li>
</ul>
<p>Accessing the <code>R2dbcDurableStateStore</code>:</p>
<dl>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-persistence-r2dbc/tree/v0.7.4/docs/src/test/java/jdocs/home/query/QueryDocCompileOnly.java#L19-L54" target="_blank" title="Go to snippet source">source</a><code class="language-java">import akka.persistence.r2dbc.state.javadsl.R2dbcDurableStateStore;
import akka.persistence.state.DurableStateStoreRegistry;

R2dbcDurableStateStore&lt;MyState&gt; stateQueries =
    DurableStateStoreRegistry.get(system)
        .getDurableStateStoreFor(
            R2dbcDurableStateStore.class, R2dbcDurableStateStore.Identifier());</code></pre></dd>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-persistence-r2dbc/tree/v0.7.4/docs/src/test/scala/docs/home/query/QueryDocCompileOnly.scala#L22-L26" target="_blank" title="Go to snippet source">source</a><code class="language-scala">import akka.persistence.state.DurableStateStoreRegistry
import akka.persistence.r2dbc.state.scaladsl.R2dbcDurableStateStore

val stateQueries = DurableStateStoreRegistry(system)
  .durableStateStoreFor[R2dbcDurableStateStore[MyState]](R2dbcDurableStateStore.Identifier)</code></pre></dd>
</dl>
<h3><a href="#changesbyslices" name="changesbyslices" class="anchor"><span class="anchor-link"></span></a>changesBySlices</h3>
<p>The <code>changesBySlices</code> and <code>currentChangesBySlices</code> queries are useful for retrieving updates of the latest durable state for a given entity type.</p>
<p>Example of <code>currentChangesBySlices</code>:</p>
<dl>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-persistence-r2dbc/tree/v0.7.4/docs/src/test/java/jdocs/home/query/QueryDocCompileOnly.java#L31-L114" target="_blank" title="Go to snippet source">source</a><code class="language-java">import akka.persistence.query.DurableStateChange;
import akka.persistence.query.UpdatedDurableState;

// Split the slices into 4 ranges
int numberOfSliceRanges = 4;
List&lt;Pair&lt;Integer, Integer&gt;&gt; sliceRanges = stateQueries.sliceRanges(numberOfSliceRanges);

// Example of using the first slice range
int minSlice = sliceRanges.get(0).first();
int maxSlice = sliceRanges.get(0).second();
String entityType = &quot;MyEntity&quot;;
Source&lt;DurableStateChange&lt;MyState&gt;, NotUsed&gt; source =
    stateQueries.currentChangesBySlices(entityType, minSlice, maxSlice, NoOffset.getInstance());
source
    .collectType(UpdatedDurableState.class)
    .map(
        change -&gt;
            &quot;state change from persistenceId &quot;
                + change.persistenceId()
                + &quot; with revision &quot;
                + change.revision()
                + &quot;: &quot;
                + change.value())
    .runWith(Sink.foreach(System.out::println), system);</code></pre></dd>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-persistence-r2dbc/tree/v0.7.4/docs/src/test/scala/docs/home/query/QueryDocCompileOnly.scala#L62-L78" target="_blank" title="Go to snippet source">source</a><code class="language-scala">import akka.persistence.query.UpdatedDurableState

// Slit the slices into 4 ranges
val numberOfSliceRanges: Int = 4
val sliceRanges = stateQueries.sliceRanges(numberOfSliceRanges)

// Example of using the first slice range
val minSlice: Int = sliceRanges.head.min
val maxSlice: Int = sliceRanges.head.max
val entityType: String = &quot;MyEntity&quot;
stateQueries
  .currentChangesBySlices(entityType, minSlice, maxSlice, NoOffset.getInstance)
  .collect { case change: UpdatedDurableState[MyState] =&gt; change }
  .map(change =&gt;
    s&quot;state change from persistenceId ${change.persistenceId} with &quot; +
    s&quot;revision ${change.revision}: ${change.value}&quot;)
  .runWith(Sink.foreach(println))</code></pre></dd>
</dl>
<p>The emitted <code>DurableStateChange</code> can be a <code>UpdatedDurableState</code> or <code>DeletedDurableState</code>, but <code>DeletedDurableState</code> is not implemented yet.</p>
<p>It will emit an <code>UpdatedDurableState</code> when the durable state is updated. When the state is updated again another <code>UpdatedDurableState</code> is emitted. It will always emit an <code>UpdatedDurableState</code> for the latest revision of the state, but there is no guarantee that all intermediate changes are emitted if the state is updated several times. Note that <code>UpdatedDurableState</code> contains the full current state, and it is not a delta from previous revision of state.</p>
<p><code>changesBySlices</code> should be used via <a href="projection.html">R2dbcProjection</a>, which will automatically handle the similar difficulties with duplicates as described for <a href="query.html#eventsbyslices">eventsBySlices</a>. When using <code>R2dbcProjection</code> the changes will be delivered in revision number order without duplicates.</p>
<h2><a href="#configuration" name="configuration" class="anchor"><span class="anchor-link"></span></a>Configuration</h2>
<p>Query configuration is under <code>akka.persistence.r2dbc.query</code>. Here&rsquo;s the default configuration values for the query plugin:</p>
<pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-persistence-r2dbc/tree/v0.7.4/core/src/main/resources/reference.conf#L57-L89" target="_blank" title="Go to snippet source">source</a><code class="language-conf">akka.persistence.r2dbc {
  query {
    class = &quot;akka.persistence.r2dbc.query.R2dbcReadJournalProvider&quot;

    # When live queries return no results or &lt;= 10% of buffer-size, the next query
    # to db will be delayed for this duration.
    # When the number of rows from previous query is &gt;= 90% of buffer-size, the next
    # query will be emitted immediately.
    # Otherwise, between 10% - 90% of buffer-size, the next query will be delayed
    # for half of this duration.
    refresh-interval = 3s

    # Live queries read events up to this duration from the current database time.
    behind-current-time = 100 millis

    backtracking {
      enabled = on
      # Backtracking queries will look back for this amount of time. It should
      # not be larger than the akka.projection.r2dbc.offset-store.time-window.
      window = 2 minutes
      # Backtracking queries read events up to this duration from the current database time.
      behind-current-time = 10 seconds
    }

    # In-memory buffer holding events when reading from database.
    buffer-size = 1000

    persistence-ids {
      buffer-size = 1000
    }

  }
}</code></pre>
<p>The query plugin shares the connection pool as the rest of the plugin, see <a href="connection-config.html">Connection configuration</a>.</p>
</div>
</article>
<div class="row">
<div class="small-12 column">
<section class="nav-prev-next row">
<div class="nav-prev small-6 column">
<a href="durable-state-store.html"><i class="icon-prev"></i> <span class="link-prev">Durable state store plugin</span></a>
</div>
<div class="nav-next small-6 column clearfix">
<a class="float-right" href="projection.html">Projection <i class="icon-next"></i></a>
</div>
</section>
</div>
</div>
<div class="source-github row">
Found an error in this documentation? The source code for this page can be found <a href="https://github.com/akka/akka-persistence-r2dbc/tree/v0.7.4/docs/src/main/paradox/query.md">here</a>.
Please feel free to edit and contribute a pull request.
</div>

<footer class="page-footer row clearfix">
<img class="akka-icon float-left show-for-medium" src="images/akka-icon.svg" />
<section class="copyright">
<div>Akka Persistence R2DBC is Open Source and available under the Apache 2 License.</div>
<p class="legal">
&copy; 2011-2022 <a href="https://www.lightbend.com" target="_blank">Lightbend, Inc.</a> |
<a href="https://www.lightbend.com/legal/licenses" target="_blank">Licenses</a> |
<a href="https://www.lightbend.com/legal/terms" target="_blank">Terms</a> |
<a href="https://www.lightbend.com/legal/privacy" target="_blank">Privacy Policy</a> |
<a href="https://akka.io/cookie/" target="_blank">Cookie Listing</a> |
<a class="optanon-toggle-display">Cookie Settings</a>
</p>
</section>

</footer>
</section>
</main>
</div>

<script type="text/javascript" src="js/scrollsneak.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="js/groups.js"></script>
<script type="text/javascript" src="js/page.js"></script>
<script type="text/javascript" src="js/snippets.js"></script>
<script type="text/javascript" src="js/magellan.js"></script>
<script type="text/javascript" src="js/metadata-toggle.js"></script>
<script type="text/javascript" src="js/lbHeader.js"></script>

<style type="text/css">@import "lib/prettify/prettify.css";</style>
<script type="text/javascript" src="lib/prettify/prettify.js"></script>
<script type="text/javascript" src="lib/prettify/lang-scala.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(){window.prettyPrint && prettyPrint()});
//]]></script>
<script type="text/javascript" src="assets/js/warnOldVersion.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(jq){initOldVersionWarnings(jq, '0.7.4', 'https://doc.akka.io/docs/akka-persistence-r2dbc/current/')});
//]]></script>


</body>
</html>
