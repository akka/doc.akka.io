<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Database Cleanup &bull; Akka Persistence R2DBC Documentation</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="An Akka Persistence backed by SQL database with R2DBC"/>
<link rel="canonical" href="https://doc.akka.io/docs/akka-persistence-r2dbc/current/cleanup.html"/>
<script type="text/javascript" src="lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="lib/foundation/dist/js/foundation.min.js"></script>
<link rel="stylesheet" type="text/css" href="lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="lib/foundation/dist/css/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" type="text/css" href="css/icons.css"/>
<link rel="stylesheet" type="text/css" href="css/page-8.css"/>
<link rel="stylesheet" type="text/css" href="css/banner-2.css"/>
<link rel="shortcut icon" href="images/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png"/>
<link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png"/>
<link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png"/>
<link rel="manifest" href="images/manifest.json"/>
<meta name="msapplication-TileImage" content="images/mstile-150x150.png"/>
<meta name="msapplication-TileColor" content="#15a9ce"/>
<meta name="theme-color" content="#15a9ce"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) start -->
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js"  type="text/javascript" charset="UTF-8" data-domain-script="28b912e7-09e9-43d5-91e4-3d1897044004" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) end -->
<!--Google Analytics-->
<script type="text/plain" class="optanon-category-2">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', '']);
_gaq.push(['_setDomainName', '']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})()
</script>
<!-- Google Tag Manager -->
<script type="text/plain" class="optanon-category-2">
(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KBJGH35');
</script>
<!--Marketo-->
<script type="text/plain" class="optanon-category-3">
(function() {
var didInit = false;
function initMunchkin() {
if(didInit === false) {
didInit = true;
Munchkin.init('558-NCX-702', { 'asyncOnly': true, 'disableClickDelay': true });
}
}
var s = document.createElement('script');
s.type = 'text/javascript';
s.async = true;
s.src = '//munchkin.marketo.net/munchkin.js';
s.onreadystatechange = function() {
if (this.readyState == 'complete' || this.readyState == 'loaded') {
initMunchkin();
}
};
s.onload = initMunchkin;
document.getElementsByTagName('head')[0].appendChild(s);
})();
</script>
</head>

<body id="underlay" data-toggler="nav-open">
<div id="lightbend-banner" class="lightbend-banner akka full-width" data-category="OSS Lightbend Banner Impression" data-label="Akka Banner Impression">
<div class="oss-wrapper">
<div class="oss-brand">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lightbend Logo - Akka Banner" href="https://www.lightbend.com">
<img class="lightbend-logo" src="images/banner-logos/lightbend-reverse.svg" alt="Lightbend" title="Lightbend">
</a>
</div>
<div class="oss-ad no-drop-down">
<nav id="lightbendRotator" class="lightbend-rotator">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Promo Rotator - Lightbend is Changing its Software Licensing Model for Akka Technology. [License FAQ] - Akka Banner" href="https://www.lightbend.com/akka/license-faq">
<strong>Lightbend</strong> is Changing its Software Licensing Model for Akka Technology. <span class="akka-btn">License FAQ</span>
</a>
</nav>
</div>
</div>
</div>

<header class="site-header hide-for-large">
<div class="sticky-header clearfix">
<a href="https://akka.io"><img class="logo" src="images/akka-logo-reverse.svg"/></a>

<button class="menu-icon float-right" type="button" data-toggle="underlay overlay"></button>
</div>
<div id="overlay" class="overlay-nav" data-toggler="nav-open">
<header class="nav-header">
<div class="nav-header-title">
<h1><a href="index.html">Akka Persistence R2DBC Documentation</a></h1>
</div>
<div class="nav-header-version">
Version 1.1.0-M7
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="nav-toc">
<ul>
  <li><a href="overview.html" class="page">Overview</a></li>
  <li><a href="getting-started.html" class="page">Getting Started</a></li>
  <li><a href="journal.html" class="page">Journal plugin</a></li>
  <li><a href="snapshots.html" class="page">Snapshot store plugin</a></li>
  <li><a href="durable-state-store.html" class="page">Durable state store plugin</a></li>
  <li><a href="query.html" class="page">Query Plugin</a></li>
  <li><a href="projection.html" class="page">Projection</a></li>
  <li><a href="config.html" class="page">Configuration</a></li>
  <li><a href="cleanup.html#database-cleanup" class="active page">Database Cleanup</a>
  <ul>
    <li><a href="cleanup.html#event-sourced-cleanup-tool" class="header">Event Sourced cleanup tool</a></li>
    <li><a href="cleanup.html#durable-state-cleanup-tool" class="header">Durable State cleanup tool</a></li>
  </ul></li>
  <li><a href="migration.html" class="page">Migration tool</a></li>
  <li><a href="contributing.html" class="page">Contributing</a></li>
</ul>
</nav>
</div>
</header>
<div class="site-content-wrapper">
<aside class="sticky-sidebar show-for-large">
<header class="nav-header sticky-sidebar-header">
<div class="nav-header-title">
<h1><a href="index.html">Akka Persistence R2DBC Documentation</a></h1>
</div>
<div class="nav-header-version">
Version 1.1.0-M7
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="site-nav sticky-sidebar-contents">
<div class="nav-toc">
<ul>
  <li><a href="overview.html" class="page">Overview</a></li>
  <li><a href="getting-started.html" class="page">Getting Started</a></li>
  <li><a href="journal.html" class="page">Journal plugin</a></li>
  <li><a href="snapshots.html" class="page">Snapshot store plugin</a></li>
  <li><a href="durable-state-store.html" class="page">Durable state store plugin</a></li>
  <li><a href="query.html" class="page">Query Plugin</a></li>
  <li><a href="projection.html" class="page">Projection</a></li>
  <li><a href="config.html" class="page">Configuration</a></li>
  <li><a href="cleanup.html#database-cleanup" class="active page">Database Cleanup</a>
  <ul>
    <li><a href="cleanup.html#event-sourced-cleanup-tool" class="header">Event Sourced cleanup tool</a></li>
    <li><a href="cleanup.html#durable-state-cleanup-tool" class="header">Durable State cleanup tool</a></li>
  </ul></li>
  <li><a href="migration.html" class="page">Migration tool</a></li>
  <li><a href="contributing.html" class="page">Contributing</a></li>
</ul>
</div>
</nav>
<footer class="nav-footer sticky-sidebar-footer">
<a href="https://akka.io"><img class="logo" src="images/akka-logo-reverse.svg"/></a>

</footer>
</aside>
<main class="fixed-shift-for-large expanded row">
<section class="site-content small-12 column">
<article class="page-content row">
<div class="small-12 column" id="docs">
<h1><a href="#database-cleanup" name="database-cleanup" class="anchor"><span class="anchor-link"></span></a>Database Cleanup</h1>
<h2><a href="#event-sourced-cleanup-tool" name="event-sourced-cleanup-tool" class="anchor"><span class="anchor-link"></span></a>Event Sourced cleanup tool</h2><div class="callout warning "><div class="callout-title">Warning</div>
<p>When running any operation with <code>EventSourcedCleanup</code> for a persistence id, the actor with that persistence id must not be running!</p></div>
<p>If possible, it is best to keep all events in an event sourced system. That way new <a href="projection.html">Projections</a> can be re-built.</p>
<p>In some cases keeping all events is not possible or must be removed for regulatory reasons, such as compliance with GDPR. <code>EventSourcedBehavior</code>s can automatically snapshot state and delete events as described in the <a href="https://doc.akka.io/docs/akka/2.8/typed/persistence-snapshot.html#snapshot-deletion">Akka docs</a>. Snapshotting is useful even if events aren&rsquo;t deleted as it speeds up recovery.</p>
<p>Deleting all events immediately when an entity has reached its terminal deleted state would have the consequence that Projections might not have consumed all previous events yet and will not be notified of the deleted event. Instead, it&rsquo;s recommended to emit a final deleted event and store the fact that the entity is deleted separately via a Projection. Then a background task can clean up the events and snapshots for the deleted entities by using the <span class="group-java"><a href="/api/akka-persistence-r2dbc/1.1.0-M7/akka/persistence/r2dbc/cleanup/javadsl/EventSourcedCleanup.html" title="akka.persistence.r2dbc.cleanup.javadsl.EventSourcedCleanup"><code>EventSourcedCleanup</code></a></span><span class="group-scala"><a href="/api/akka-persistence-r2dbc/1.1.0-M7/akka/persistence/r2dbc/cleanup/scaladsl/EventSourcedCleanup.html" title="akka.persistence.r2dbc.cleanup.scaladsl.EventSourcedCleanup"><code>EventSourcedCleanup</code></a></span> tool. The entity itself knows about the terminal state from the deleted event and should not emit further events after that and typically stop itself if it receives more commands.</p>
<p><span class="group-java"><a href="/api/akka-persistence-r2dbc/1.1.0-M7/akka/persistence/r2dbc/cleanup/javadsl/EventSourcedCleanup.html" title="akka.persistence.r2dbc.cleanup.javadsl.EventSourcedCleanup"><code>EventSourcedCleanup</code></a></span><span class="group-scala"><a href="/api/akka-persistence-r2dbc/1.1.0-M7/akka/persistence/r2dbc/cleanup/scaladsl/EventSourcedCleanup.html" title="akka.persistence.r2dbc.cleanup.scaladsl.EventSourcedCleanup"><code>EventSourcedCleanup</code></a></span> operations include:</p>
<ul>
  <li>Delete all events and snapshots for one or many persistence ids</li>
  <li>Delete all events for one or many persistence ids</li>
  <li>Delete all snapshots for one or many persistence ids</li>
  <li>Delete events before snapshot for one or many persistence ids</li>
</ul>
<p>The cleanup tool can be combined with the <a href="query.html">query plugin</a> which has a query to get all persistence ids.</p>
<dl>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-persistence-r2dbc/tree/v1.1.0-M7/docs/src/test/java/jdocs/home/cleanup/CleanupDocExample.java#L18-L31" target="_blank" title="Go to snippet source">source</a><code class="language-java">CurrentPersistenceIdsQuery queries = PersistenceQuery.get(system)
    .getReadJournalFor(CurrentPersistenceIdsQuery.class, R2dbcReadJournal.Identifier());
EventSourcedCleanup cleanup = new EventSourcedCleanup(system);

int persistenceIdParallelism = 10;


// forall persistence ids, delete all events before the snapshot
queries
    .currentPersistenceIds()
    .mapAsync(persistenceIdParallelism, pid -&gt;
        FutureConverters.toJava(cleanup.cleanupBeforeSnapshot(pid)))
    .run(system);
</code></pre></dd>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-persistence-r2dbc/tree/v1.1.0-M7/docs/src/test/scala/docs/home/cleanup/CleanupDocExample.scala#L5-L28" target="_blank" title="Go to snippet source">source</a><code class="language-scala">import akka.persistence.query.PersistenceQuery
import akka.persistence.query.scaladsl.CurrentPersistenceIdsQuery
import akka.persistence.r2dbc.cleanup.scaladsl.EventSourcedCleanup
import akka.persistence.r2dbc.query.scaladsl.R2dbcReadJournal

val queries = PersistenceQuery(system).readJournalFor[CurrentPersistenceIdsQuery](R2dbcReadJournal.Identifier)
val cleanup = new EventSourcedCleanup(system)

//  how many persistence ids to operate on in parallel
val persistenceIdParallelism = 10

// forall persistence ids, delete all events before the snapshot
queries
  .currentPersistenceIds()
  .mapAsync(persistenceIdParallelism)(pid =&gt; cleanup.cleanupBeforeSnapshot(pid))
  .run()
</code></pre></dd>
</dl>
<h2><a href="#durable-state-cleanup-tool" name="durable-state-cleanup-tool" class="anchor"><span class="anchor-link"></span></a>Durable State cleanup tool</h2><div class="callout warning "><div class="callout-title">Warning</div>
<p>When running any operation with <code>DurableStateCleanup</code> for a persistence id, the actor with that persistence id must not be running!</p></div>
<p><span class="group-java"><a href="/api/akka-persistence-r2dbc/1.1.0-M7/akka/persistence/r2dbc/cleanup/javadsl/DurableStateCleanup.html" title="akka.persistence.r2dbc.cleanup.javadsl.DurableStateCleanup"><code>DurableStateCleanup</code></a></span><span class="group-scala"><a href="/api/akka-persistence-r2dbc/1.1.0-M7/akka/persistence/r2dbc/cleanup/scaladsl/DurableStateCleanup.html" title="akka.persistence.r2dbc.cleanup.scaladsl.DurableStateCleanup"><code>DurableStateCleanup</code></a></span> operations include:</p>
<ul>
  <li>Delete state for one or many persistence ids</li>
</ul>
<p>The cleanup tool can be combined with the <a href="query.html">query plugin</a> which has a query to get all persistence ids.</p>
</div>
</article>
<div class="row">
<div class="small-12 column">
<section class="nav-prev-next row">
<div class="nav-prev small-6 column">
<a href="config.html"><i class="icon-prev"></i> <span class="link-prev">Configuration</span></a>
</div>
<div class="nav-next small-6 column clearfix">
<a class="float-right" href="migration.html">Migration tool <i class="icon-next"></i></a>
</div>
</section>
</div>
</div>
<div class="source-github row">
Found an error in this documentation? The source code for this page can be found <a href="https://github.com/akka/akka-persistence-r2dbc/tree/v1.1.0-M7/docs/src/main/paradox/cleanup.md">here</a>.
Please feel free to edit and contribute a pull request.
</div>

<footer class="page-footer row clearfix">
<img class="akka-icon float-left show-for-medium" src="images/akka-icon.svg" />
<section class="copyright">
<div>Akka Persistence R2DBC is available under the <a href="https://www.lightbend.com/akka/license" target="_blank">Business Source License 1.1</a>.</div>
<p class="legal">
&copy; 2011-2023 <a href="https://www.lightbend.com" target="_blank">Lightbend, Inc.</a> |
<a href="https://www.lightbend.com/legal/licenses" target="_blank">Licenses</a> |
<a href="https://www.lightbend.com/legal/terms" target="_blank">Terms</a> |
<a href="https://www.lightbend.com/legal/privacy" target="_blank">Privacy Policy</a> |
<a href="https://akka.io/cookie/" target="_blank">Cookie Listing</a> |
<a class="optanon-toggle-display">Cookie Settings</a>
</p>
</section>

</footer>
</section>
</main>
</div>

<script type="text/javascript" src="js/scrollsneak.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="js/groups.js"></script>
<script type="text/javascript" src="js/page.js"></script>
<script type="text/javascript" src="js/snippets.js"></script>
<script type="text/javascript" src="js/magellan.js"></script>
<script type="text/javascript" src="js/metadata-toggle.js"></script>
<script type="text/javascript" src="js/lbHeader.js"></script>

<style type="text/css">@import "lib/prettify/prettify.css";</style>
<script type="text/javascript" src="lib/prettify/prettify.js"></script>
<script type="text/javascript" src="lib/prettify/lang-scala.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(){window.prettyPrint && prettyPrint()});
//]]></script>
<script type="text/javascript" src="assets/js/warnOldVersion.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(jq){initOldVersionWarnings(jq, '1.1.0-M7', 'https://doc.akka.io/docs/akka-persistence-r2dbc/current/')});
//]]></script>


</body>
</html>
