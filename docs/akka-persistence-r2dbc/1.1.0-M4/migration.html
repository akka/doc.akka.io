<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Migration tool &bull; Akka Persistence R2DBC Documentation</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="An Akka Persistence backed by SQL database with R2DBC"/>
<link rel="canonical" href="https://doc.akka.io/docs/akka-persistence-r2dbc/current/migration.html"/>
<script type="text/javascript" src="lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="lib/foundation/dist/js/foundation.min.js"></script>
<link rel="stylesheet" type="text/css" href="lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="lib/foundation/dist/css/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" type="text/css" href="css/icons.css"/>
<link rel="stylesheet" type="text/css" href="css/page-8.css"/>
<link rel="stylesheet" type="text/css" href="css/banner-2.css"/>
<link rel="shortcut icon" href="images/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png"/>
<link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png"/>
<link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png"/>
<link rel="manifest" href="images/manifest.json"/>
<meta name="msapplication-TileImage" content="images/mstile-150x150.png"/>
<meta name="msapplication-TileColor" content="#15a9ce"/>
<meta name="theme-color" content="#15a9ce"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) start -->
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js"  type="text/javascript" charset="UTF-8" data-domain-script="28b912e7-09e9-43d5-91e4-3d1897044004" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) end -->
<!--Google Analytics-->
<script type="text/plain" class="optanon-category-2">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', '']);
_gaq.push(['_setDomainName', '']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})()
</script>
<!-- Google Tag Manager -->
<script type="text/plain" class="optanon-category-2">
(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KBJGH35');
</script>
<!--Marketo-->
<script type="text/plain" class="optanon-category-3">
(function() {
var didInit = false;
function initMunchkin() {
if(didInit === false) {
didInit = true;
Munchkin.init('558-NCX-702', { 'asyncOnly': true, 'disableClickDelay': true });
}
}
var s = document.createElement('script');
s.type = 'text/javascript';
s.async = true;
s.src = '//munchkin.marketo.net/munchkin.js';
s.onreadystatechange = function() {
if (this.readyState == 'complete' || this.readyState == 'loaded') {
initMunchkin();
}
};
s.onload = initMunchkin;
document.getElementsByTagName('head')[0].appendChild(s);
})();
</script>
</head>

<body id="underlay" data-toggler="nav-open">
<div id="lightbend-banner" class="lightbend-banner akka full-width" data-category="OSS Lightbend Banner Impression" data-label="Akka Banner Impression">
<div class="oss-wrapper">
<div class="oss-brand">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lightbend Logo - Akka Banner" href="https://www.lightbend.com">
<img class="lightbend-logo" src="images/banner-logos/lightbend-reverse.svg" alt="Lightbend" title="Lightbend">
</a>
</div>
<div class="oss-ad no-drop-down">
<nav id="lightbendRotator" class="lightbend-rotator">
<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Promo Rotator - Lightbend is Changing its Software Licensing Model for Akka Technology. [License FAQ] - Akka Banner" href="https://www.lightbend.com/akka/license-faq">
<strong>Lightbend</strong> is Changing its Software Licensing Model for Akka Technology. <span class="akka-btn">License FAQ</span>
</a>
</nav>
</div>
</div>
</div>

<header class="site-header hide-for-large">
<div class="sticky-header clearfix">
<a href="https://akka.io"><img class="logo" src="images/akka-logo-reverse.svg"/></a>

<button class="menu-icon float-right" type="button" data-toggle="underlay overlay"></button>
</div>
<div id="overlay" class="overlay-nav" data-toggler="nav-open">
<header class="nav-header">
<div class="nav-header-title">
<h1><a href="index.html">Akka Persistence R2DBC Documentation</a></h1>
</div>
<div class="nav-header-version">
Version 1.1.0-M4
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="nav-toc">
<ul>
  <li><a href="overview.html" class="page">Overview</a></li>
  <li><a href="getting-started.html" class="page">Getting Started</a></li>
  <li><a href="journal.html" class="page">Journal plugin</a></li>
  <li><a href="snapshots.html" class="page">Snapshot store plugin</a></li>
  <li><a href="durable-state-store.html" class="page">Durable state store plugin</a></li>
  <li><a href="query.html" class="page">Query Plugin</a></li>
  <li><a href="projection.html" class="page">Projection</a></li>
  <li><a href="config.html" class="page">Configuration</a></li>
  <li><a href="cleanup.html" class="page">Database Cleanup</a></li>
  <li><a href="migration.html#migration-tool" class="active page">Migration tool</a>
  <ul>
    <li><a href="migration.html#dependencies" class="header">Dependencies</a></li>
    <li><a href="migration.html#progress-table" class="header">Progress table</a></li>
    <li><a href="migration.html#configuration" class="header">Configuration</a></li>
  </ul></li>
  <li><a href="contributing.html" class="page">Contributing</a></li>
</ul>
</nav>
</div>
</header>
<div class="site-content-wrapper">
<aside class="sticky-sidebar show-for-large">
<header class="nav-header sticky-sidebar-header">
<div class="nav-header-title">
<h1><a href="index.html">Akka Persistence R2DBC Documentation</a></h1>
</div>
<div class="nav-header-version">
Version 1.1.0-M4
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-scala">Scala</option></select>
</div>
</header>
<nav class="site-nav sticky-sidebar-contents">
<div class="nav-toc">
<ul>
  <li><a href="overview.html" class="page">Overview</a></li>
  <li><a href="getting-started.html" class="page">Getting Started</a></li>
  <li><a href="journal.html" class="page">Journal plugin</a></li>
  <li><a href="snapshots.html" class="page">Snapshot store plugin</a></li>
  <li><a href="durable-state-store.html" class="page">Durable state store plugin</a></li>
  <li><a href="query.html" class="page">Query Plugin</a></li>
  <li><a href="projection.html" class="page">Projection</a></li>
  <li><a href="config.html" class="page">Configuration</a></li>
  <li><a href="cleanup.html" class="page">Database Cleanup</a></li>
  <li><a href="migration.html#migration-tool" class="active page">Migration tool</a>
  <ul>
    <li><a href="migration.html#dependencies" class="header">Dependencies</a></li>
    <li><a href="migration.html#progress-table" class="header">Progress table</a></li>
    <li><a href="migration.html#configuration" class="header">Configuration</a></li>
  </ul></li>
  <li><a href="contributing.html" class="page">Contributing</a></li>
</ul>
</div>
</nav>
<footer class="nav-footer sticky-sidebar-footer">
<a href="https://akka.io"><img class="logo" src="images/akka-logo-reverse.svg"/></a>

</footer>
</aside>
<main class="fixed-shift-for-large expanded row">
<section class="site-content small-12 column">
<article class="page-content row">
<div class="small-12 column" id="docs">
<h1><a href="#migration-tool" name="migration-tool" class="anchor"><span class="anchor-link"></span></a>Migration tool</h1>
<p>There is a migration tool that is useful if you would like to migrate from another Akka Persistence plugin to the R2DBC plugin. It has been tested with Akka Persistence JDBC as source plugin, but it should work with any plugin that has support for <code>CurrentPersistenceIdsQuery</code> and <code>CurrentEventsByPersistenceIdQuery</code>.</p>
<p>The migration tool can be run while the source system is still active, and it can be run multiple times with idempotent result. Full rolling update when switching database or Persistence plugin is not supported, but you can migrate most of the data while the system is online and then have a short full shutdown while migrating the remaining data that was written after the previous online migration.</p>
<h2><a href="#dependencies" name="dependencies" class="anchor"><span class="anchor-link"></span></a>Dependencies</h2><dl class="dependency"><dt>Maven</dt><dd><pre class="prettyprint"><code class="language-xml">&lt;properties&gt;
  &lt;scala.binary.version&gt;2.13&lt;/scala.binary.version&gt;
&lt;/properties&gt;
&lt;dependencies&gt
  &lt;dependency&gt;
    &lt;groupId&gt;com.lightbend.akka&lt;/groupId&gt;
    &lt;artifactId&gt;akka-persistence-r2dbc-migration_${scala.binary.version}&lt;/artifactId&gt;
    &lt;version&gt;1.1.0-M4&lt;/version&gt;
  &lt;/dependency&gt
&lt;/dependencies&gt;</code></pre></dd><dt>sbt</dt><dd><pre class="prettyprint"><code class="language-scala">libraryDependencies += "com.lightbend.akka" %% "akka-persistence-r2dbc-migration" % "1.1.0-M4"</code></pre></dd><dt>Gradle</dt><dd><pre class="prettyprint"><code class="language-gradle">def versions = [
  ScalaBinary: "2.13"
]
dependencies {
  implementation "com.lightbend.akka:akka-persistence-r2dbc-migration_${versions.ScalaBinary}:1.1.0-M4"
}</code></pre></dd></dl>
<h2><a href="#progress-table" name="progress-table" class="anchor"><span class="anchor-link"></span></a>Progress table</h2>
<p>To speed up processing of subsequent runs it stores migrated persistence ids and sequence numbers in the table <code>migration_progress</code>. In a subsequent run it will only migrate new events and snapshots compared to what was stored in <code>migration_progress</code>. It will also find and migrate new persistence ids in a subsequent run. You can delete from <code>migration_progress</code> if you want to re-run the full migration.</p>
<p>It&rsquo;s recommended that you create the <code>migration_progress</code> table before running the migration tool, but if it doesn&rsquo;t exist the tool will try to create the table.</p>
<pre class="prettyprint"><code class="language-sql">CREATE TABLE IF NOT EXISTS migration_progress(
  persistence_id VARCHAR(255) NOT NULL,
  event_seq_nr BIGINT,
  snapshot_seq_nr BIGINT,
  PRIMARY KEY(persistence_id)
</code></pre>
<h2><a href="#configuration" name="configuration" class="anchor"><span class="anchor-link"></span></a>Configuration</h2>
<p>The migration tool can be run as main class <code>akka.persistence.r2dbc.migration.MigrationTool</code> provided by the above <code>akka-persistence-r2dbc-migration</code> dependency.</p>
<p>You need to provide configuration for the source persistence plugin and the target Rd2BC plugin in your <code>application.conf</code>. An example of such configuration for migration from Akka Persistence JDBC: </p>
<pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-persistence-r2dbc/tree/v1.1.0-M4/migration/src/test/resources/application.conf" target="_blank" title="Go to snippet source">source</a><code class="language-conf">akka.persistence.r2dbc.migration {
  source {
    query-plugin-id = &quot;jdbc-read-journal&quot;
    snapshot-plugin-id = &quot;jdbc-snapshot-store&quot;
  }
}

akka.persistence.r2dbc {
  # use different table names or schema
  journal.table = &quot;event_journal2&quot;
  snapshot.table = &quot;snapshot2&quot;
  state.table = &quot;durable_state2&quot;
}

akka.persistence.r2dbc.connection-factory {
  driver = &quot;postgres&quot;
  host = &quot;localhost&quot;
  port = 5432
  user = &quot;postgres&quot;
  password = &quot;postgres&quot;
  database = &quot;postgres&quot;
}

akka-persistence-jdbc {
  shared-databases {
    default {
      profile = &quot;slick.jdbc.PostgresProfile$&quot;
      db {
        host = &quot;localhost&quot;
        url = &quot;jdbc:postgresql://localhost:5432/postgres?reWriteBatchedInserts=true&quot;
        user = postgres
        password = postgres
        driver = &quot;org.postgresql.Driver&quot;
        numThreads = 20
        maxConnections = 20
        minConnections = 5
      }
    }
  }
}

jdbc-journal {
  use-shared-db = &quot;default&quot;
}
jdbc-snapshot-store {
  use-shared-db = &quot;default&quot;
}
jdbc-read-journal {
  use-shared-db = &quot;default&quot;
}

# application specific serializers for events and snapshots
# must also be configured and included in classpath</code></pre><div class="callout note "><div class="callout-title">Note</div>
<p>Application specific serializers for events and snapshots must also be configured and included in classpath.</p></div>
<h3><a href="#reference-configuration" name="reference-configuration" class="anchor"><span class="anchor-link"></span></a>Reference configuration</h3>
<p>The following can be overridden in your <code>application.conf</code> for the migration tool specific settings:</p>
<pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/akka/akka-persistence-r2dbc/tree/v1.1.0-M4/migration/src/main/resources/reference.conf" target="_blank" title="Go to snippet source">source</a><code class="language-conf">akka.persistence.r2dbc.migration {

  # Akka Persistence plugin to migrate from.
  # You must also define plugin specific configuration
  # and application specific serializers for events and snapshots.
  source {
    query-plugin-id = &quot;jdbc-read-journal&quot;
    snapshot-plugin-id = &quot;jdbc-snapshot-store&quot;
  }

  # R2DBC Akka Persistence plugin to migrate to.
  # You must also define akka-persistence-r2dbc specific configuration.
  target {
    # this must be a configuration path of akka-persistence-r2dbc
    persistence-plugin-id = &quot;akka.persistence.r2dbc&quot;

    # Events are stored in batches of this size.
    batch = 10
  }

  # How many persistence ids to migrate concurrently.
  parallelism = 10

}</code></pre>
</div>
</article>
<div class="row">
<div class="small-12 column">
<section class="nav-prev-next row">
<div class="nav-prev small-6 column">
<a href="cleanup.html"><i class="icon-prev"></i> <span class="link-prev">Database Cleanup</span></a>
</div>
<div class="nav-next small-6 column clearfix">
<a class="float-right" href="contributing.html">Contributing <i class="icon-next"></i></a>
</div>
</section>
</div>
</div>
<div class="source-github row">
Found an error in this documentation? The source code for this page can be found <a href="https://github.com/akka/akka-persistence-r2dbc/tree/v1.1.0-M4/docs/src/main/paradox/migration.md">here</a>.
Please feel free to edit and contribute a pull request.
</div>

<footer class="page-footer row clearfix">
<img class="akka-icon float-left show-for-medium" src="images/akka-icon.svg" />
<section class="copyright">
<div>Akka Persistence R2DBC is available under the <a href="https://www.lightbend.com/akka/license" target="_blank">Business Source License 1.1</a>.</div>
<p class="legal">
&copy; 2011-2023 <a href="https://www.lightbend.com" target="_blank">Lightbend, Inc.</a> |
<a href="https://www.lightbend.com/legal/licenses" target="_blank">Licenses</a> |
<a href="https://www.lightbend.com/legal/terms" target="_blank">Terms</a> |
<a href="https://www.lightbend.com/legal/privacy" target="_blank">Privacy Policy</a> |
<a href="https://akka.io/cookie/" target="_blank">Cookie Listing</a> |
<a class="optanon-toggle-display">Cookie Settings</a>
</p>
</section>

</footer>
</section>
</main>
</div>

<script type="text/javascript" src="js/scrollsneak.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="js/groups.js"></script>
<script type="text/javascript" src="js/page.js"></script>
<script type="text/javascript" src="js/snippets.js"></script>
<script type="text/javascript" src="js/magellan.js"></script>
<script type="text/javascript" src="js/metadata-toggle.js"></script>
<script type="text/javascript" src="js/lbHeader.js"></script>

<style type="text/css">@import "lib/prettify/prettify.css";</style>
<script type="text/javascript" src="lib/prettify/prettify.js"></script>
<script type="text/javascript" src="lib/prettify/lang-scala.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(){window.prettyPrint && prettyPrint()});
//]]></script>
<script type="text/javascript" src="assets/js/warnOldVersion.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(jq){initOldVersionWarnings(jq, '1.1.0-M4', 'https://doc.akka.io/docs/akka-persistence-r2dbc/current/')});
//]]></script>


</body>
</html>
